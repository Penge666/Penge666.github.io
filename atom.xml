<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Penge666</title>
  
  
  <link href="https://penge666.github.io/atom.xml" rel="self"/>
  
  <link href="https://penge666.github.io/"/>
  <updated>2024-05-14T12:29:22.688Z</updated>
  <id>https://penge666.github.io/</id>
  
  <author>
    <name>Penge666</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sanitizer</title>
    <link href="https://penge666.github.io/posts/f07e3ce0.html"/>
    <id>https://penge666.github.io/posts/f07e3ce0.html</id>
    <published>2024-05-14T11:48:21.000Z</published>
    <updated>2024-05-14T12:29:22.688Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Sanitizer">Sanitizer</h2><p>Sanitizeræ˜¯ç”±Googleå‘èµ·çš„å¼€æºå·¥å…·é›†ï¼Œç”¨äºæ£€æµ‹å†…å­˜æ³„éœ²ç­‰é—®é¢˜ã€‚å®ƒåŒ…æ‹¬äº†AddressSanitizerã€MemorySanitizerã€ThreadSanitizerã€LeakSanitizerç­‰å¤šç§å·¥å…·ã€‚è¿™äº›å·¥å…·æœ€åˆæ˜¯LLVMé¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œåæ¥ä¹Ÿè¢«GNUçš„GCCç¼–è¯‘å™¨æ”¯æŒã€‚ä»GCCçš„4.8ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å·²ç»æ”¯æŒAddressSanitizerå’ŒThreadSanitizerï¼Œè€Œ4.9ç‰ˆæœ¬åˆ™å¼€å§‹æ”¯æŒLeakSanitizerã€‚</p><ul><li><strong>AddressSanitizer</strong>ï¼Œæ£€æµ‹å†…å­˜è®¿é—®é—®é¢˜</li><li><strong>MemorySanitizer</strong>ï¼Œæ£€æµ‹æœªåˆå§‹åŒ–å†…å­˜é—®é¢˜</li><li><strong>ThreadSanitizer</strong>ï¼Œæ£€æµ‹çº¿ç¨‹ç«æ€å’Œæ­»é”é—®é¢˜</li><li><strong>LeakSanitizer</strong>ï¼Œæ£€æµ‹å†…å­˜æ³„éœ²é—®é¢˜</li></ul><p>ç¼–è¯‘å™¨è‡ªå¸¦ã€‚ç›¸æ¯”äºæ£€æµ‹å·¥å…·valgrindï¼Œå®ƒå¯¹ç¨‹åºæ€§èƒ½çš„å½±å“æ›´å°ï¼Œç”¨è¿‡valgrindçš„å°±çŸ¥é“ï¼Œä½¿ç”¨valgrindåç¨‹åºçš„æ€§èƒ½å¤§å¤§é™ä½ã€‚</p><p>å®˜æ–¹é“¾æ¥ï¼š<a href="https://link.zhihu.com/?target=https%3A//github.com/google/sanitizers/wiki/">https://link.zhihu.com/?target=https%3A//github.com/google/sanitizers/wiki/</a></p><h2 id="AddressSanitizer">AddressSanitizer</h2><p><strong>åŸç†ä»‹ç»</strong><br>AddressSanitizerï¼ˆç®€ç§°ASanï¼‰æ˜¯ä¸€ç§å†…å­˜é”™è¯¯æ£€æµ‹å™¨ï¼Œå®ƒå¯ä»¥æ£€æµ‹å‡ºå„ç§å†…å­˜ç›¸å…³çš„é”™è¯¯ï¼ŒåŒ…æ‹¬å†…å­˜æ³„æ¼ã€‚åœ¨Android NDKä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç¼–è¯‘é€‰é¡¹ä¸­æ·»åŠ -fsanitize=addressæ¥å¯ç”¨ASanã€‚ASanä¼šåœ¨ç¨‹åºè¿è¡Œæ—¶ç›‘æ§å†…å­˜æ“ä½œï¼Œå½“æ£€æµ‹åˆ°å†…å­˜æ³„æ¼æ—¶ï¼Œä¼šæ‰“å°å‡ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ³„æ¼çš„å¤§å°ã€ä½ç½®å’Œå †æ ˆä¿¡æ¯ã€‚</p><p><strong>AddressSanitizerçš„åŸç†</strong></p><ul><li><p>å†…å­˜å¸ƒå±€å˜æ¢ï¼šASanåœ¨ç¼–è¯‘æ—¶æ”¹å˜ç¨‹åºçš„å†…å­˜å¸ƒå±€ï¼Œä½¿å¾—ç¨‹åºä¸­çš„æ¯ä¸ªå¯¹è±¡ï¼ˆå˜é‡ã€æ•°ç»„ç­‰ï¼‰å‘¨å›´éƒ½æœ‰ä¸€äº›é¢å¤–çš„â€œçº¢è‰²åŒºåŸŸâ€ï¼ˆredzonesï¼‰ã€‚è¿™äº›çº¢è‰²åŒºåŸŸç”¨äºæ£€æµ‹å†…å­˜è®¿é—®è¶Šç•Œã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªæ•°ç»„çš„è®¿é—®è¶Šè¿‡äº†å®ƒçš„è¾¹ç•Œå¹¶è®¿é—®äº†çº¢è‰²åŒºåŸŸï¼ŒASanå°±ä¼šæŠ¥å‘Šä¸€ä¸ªç¼“å†²åŒºæº¢å‡ºé”™è¯¯ã€‚</p></li><li><p>å½±å­å†…å­˜ï¼šASanä½¿ç”¨å½±å­å†…å­˜ï¼ˆshadow memoryï¼‰æ¥è·Ÿè¸ªç¨‹åºä¸­çš„æ¯ä¸ªå†…å­˜å­—èŠ‚çš„çŠ¶æ€ã€‚å½±å­å†…å­˜æ˜¯ç¨‹åºå†…å­˜çš„ä¸€ä¸ªæ˜ å°„ï¼Œç”¨äºå­˜å‚¨æœ‰å…³å†…å­˜çŠ¶æ€çš„å…ƒæ•°æ®ï¼Œå¦‚å†…å­˜æ˜¯å¦å·²åˆ†é…ã€æ˜¯å¦å·²åˆå§‹åŒ–ç­‰ã€‚å½“ç¨‹åºè®¿é—®å†…å­˜æ—¶ï¼ŒASanä¼šæ£€æŸ¥å¯¹åº”çš„å½±å­å†…å­˜ï¼Œä»¥ç¡®å®šè®¿é—®æ˜¯å¦åˆæ³•ã€‚</p></li><li><p>ç¼–è¯‘å™¨æ’æ¡©ï¼šASané€šè¿‡ç¼–è¯‘å™¨æ’æ¡©ï¼ˆinstrumentationï¼‰åœ¨ç¨‹åºä¸­æ’å…¥æ£€æŸ¥ä»£ç ã€‚è¿™äº›æ£€æŸ¥ä»£ç åœ¨å†…å­˜è®¿é—®å‘ç”Ÿæ—¶æ‰§è¡Œï¼Œä»¥æ£€æµ‹æ½œåœ¨çš„å†…å­˜é”™è¯¯ã€‚ä¾‹å¦‚ï¼ŒASanä¼šåœ¨å †åˆ†é…å’Œé‡Šæ”¾å‡½æ•°ï¼ˆå¦‚mallocå’Œfreeï¼‰ä¸­æ’å…¥ä»£ç ï¼Œä»¥æ£€æµ‹å†…å­˜æ³„æ¼å’Œä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜ã€‚</p></li></ul><p><strong>å·¥å…·ä½¿ç”¨</strong></p><p>ASanæ˜¯ä¸€ä¸ªC/C++çš„å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·ï¼Œå®ƒèƒ½å¤Ÿæ£€æµ‹ï¼š</p><ul><li>Use after freeï¼Œæ‚¬ç©ºæŒ‡é’ˆå¼•ç”¨ï¼Œä¹Ÿå«é‡æŒ‡é’ˆå¼•ç”¨ï¼Œå³å¯¹freeåçš„å†…å­˜è¿›è¡Œå­˜å–æ“ä½œã€‚</li><li>Heap buffer overflowï¼Œå †æº¢å‡ºè®¿é—®ï¼Œå³å¯¹å †çš„æ“ä½œè¶Šç•Œäº†ã€‚</li><li>Stack buffer overflowï¼Œæ ˆæº¢å‡ºè®¿é—®ï¼Œå³å¯¹æ ˆçš„æ“ä½œè¶Šç•Œäº†ã€‚</li><li>Global buffer overflowï¼Œå…¨å±€ç¼“å†²åŒºæº¢å‡ºï¼Œä¾‹å¦‚å…¨å±€çš„æ•°ç»„è¿™äº›ï¼Œåæ­£éƒ½æ˜¯è¶Šç•Œè®¿é—®ï¼Œåªä¸è¿‡ä½äºç¨‹åºçš„ä¸åŒsegmentã€‚</li><li>Use after returnï¼Œå³æ ˆçš„é‡æŒ‡é’ˆï¼Œä¾‹å¦‚Aå‡½æ•°è°ƒç”¨Bå‡½æ•°ï¼ŒAå‡½æ•°æœ‰ä¸ªæŒ‡é’ˆä¼ å…¥åˆ°Bä¸­ï¼ŒBæŠŠå®ƒèµ‹å€¼æŒ‡å‘äº†Bçš„ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå³æ ˆå˜é‡ï¼ŒBè¿”å›åˆ°Aåï¼ŒAæ“ä½œè¯¥æŒ‡é’ˆçš„é”™è¯¯ã€‚</li><li>Use after scopeï¼Œå’ŒUse after returnæœ‰ç‚¹ç±»ä¼¼ï¼ŒC/C++çš„{}è¡¨ç¤ºä¸€ä¸ªscopeã€‚</li><li>Initialization order bugs</li><li>Memory leaksï¼Œå†…å­˜æ³„éœ²ï¼ŒAddressSanitizeré›†æˆäº†LeakSanitizerçš„åŠŸèƒ½ã€‚</li></ul><blockquote><p><strong>Use after free</strong></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> *p = <span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    p[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ g++ -g -fsanitize=address main.cpp -fpermissive</span><br><span class="line">main.cpp: In <span class="keyword">function</span> â€˜int main(int, char**)â€™:</span><br><span class="line">main.cpp:5:21: warning: invalid conversion from â€˜void*â€™ to â€˜char*â€™ [-fpermissive]</span><br><span class="line">    5 |     char *p = malloc(10);</span><br><span class="line">      |               ~~~~~~^~~~</span><br><span class="line">      |                     |</span><br><span class="line">      |                     void*</span><br></pre></td></tr></table></figure><p>Noteï¼š<code>-g</code>æ˜¯ä¸€ä¸ªé€‰é¡¹ï¼Œç”¨æ¥ä¸ºç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ è°ƒè¯•ä¿¡æ¯ã€‚</p><p>æŸ¥çœ‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ ./a.out</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">1336741</span>==ERROR: AddressSanitizer: heap-use-after-free on address <span class="number">0x602000000010</span> at pc <span class="number">0x55bced57822a</span> bp <span class="number">0x7ffc50d251d0</span> sp <span class="number">0x7ffc50d251c0</span></span><br><span class="line">WRITE of size <span class="number">1</span> at <span class="number">0x602000000010</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x55bced578229</span> in main /home/sv/æ¡Œé¢/main.cpp:<span class="number">7</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x7faf0d998082</span> in __libc_start_main ../csu/libc-start.c:<span class="number">308</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x55bced57810d</span> in _start (/home/sv/æ¡Œé¢/a.out+<span class="number">0x110d</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x602000000010</span> is located <span class="number">0</span> bytes inside of <span class="number">10</span>-byte region [<span class="number">0x602000000010</span>,<span class="number">0x60200000001a</span>)</span><br><span class="line">freed by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x7faf0dfbf40f</span> in __interceptor_free ../../../../src/libsanitizer/asan/asan_malloc_linux.cc:<span class="number">122</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x55bced5781f5</span> in main /home/sv/æ¡Œé¢/main.cpp:<span class="number">6</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x7faf0d998082</span> in __libc_start_main ../csu/libc-start.c:<span class="number">308</span></span><br><span class="line"></span><br><span class="line">previously allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x7faf0dfbf808</span> in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cc:<span class="number">144</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x55bced5781e5</span> in main /home/sv/æ¡Œé¢/main.cpp:<span class="number">5</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x7faf0d998082</span> in __libc_start_main ../csu/libc-start.c:<span class="number">308</span></span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-use-after-free /home/sv/æ¡Œé¢/main.cpp:<span class="number">7</span> in main</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c047fff7fb0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c047fff7fc0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c047fff7fd0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c047fff7fe0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c047fff7ff0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">=&gt;<span class="number">0x0c047fff8000</span>: fa fa[fd]fd fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8010</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8020</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8030</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8040</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8050</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow byte <span class="built_in">legend</span> (one shadow byte represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span></span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">1336741</span>==ABORTING</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œå­˜åœ¨ heap-use-after-freeã€‚</p><p>ä»”ç»†åˆ†æä¸‹ä¸Šè¿°ä¿¡æ¯ï¼š</p><p>1.è¿›ç¨‹å·ï¼Œé”™è¯¯ç±»å‹ï¼Œæ“ä½œæ˜¯è¯»ï¼Œè¿˜æ˜¯å†™ï¼Œæ“ä½œçš„åœ°å€ï¼Œçº¿ç¨‹å·ç­‰ï¼Œä»¥åŠæ ˆçš„å›æº¯ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">==1336741==ERROR: AddressSanitizer: heap-use-after-free on address 0x602000000010 at pc 0x55bced57822a bp 0x7ffc50d251d0 sp 0x7ffc50d251c0</span><br><span class="line">WRITE of size 1 at 0x602000000010 thread T0</span><br><span class="line">    <span class="comment">#0 0x55bced578229 in main /home/sv/æ¡Œé¢/main.cpp:7</span></span><br><span class="line">    <span class="comment">#1 0x7faf0d998082 in __libc_start_main ../csu/libc-start.c:308</span></span><br><span class="line">    <span class="comment">#2 0x55bced57810d in _start (/home/sv/æ¡Œé¢/a.out+0x110d)</span></span><br></pre></td></tr></table></figure><p>2.å¯¹æ­¤å—å†…å­˜çš„æ“ä½œçš„å…·ä½“ä½ç½®ï¼Œå¯¹10å­—èŠ‚çš„å†…å­˜åŒºåŸŸ[0x602000000010,0x60200000001a),çš„ç¬¬0ä¸ªå­—èŠ‚æ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x602000000010 is located 0 bytes inside of 10-byte region [0x602000000010,0x60200000001a)</span><br><span class="line">freed by thread T0 here:</span><br><span class="line">    <span class="comment">#0 0x7faf0dfbf40f in __interceptor_free ../../../../src/libsanitizer/asan/asan_malloc_linux.cc:122</span></span><br><span class="line">    <span class="comment">#1 0x55bced5781f5 in main /home/sv/æ¡Œé¢/main.cpp:6</span></span><br><span class="line">    <span class="comment">#2 0x7faf0d998082 in __libc_start_main ../csu/libc-start.c:308</span></span><br></pre></td></tr></table></figure><p>3.æ­¤å—å†…å­˜åŒºåŸŸåœ¨é‚£ä¸ªçº¿ç¨‹ï¼Œå“ªä¸ªåœ°æ–¹åˆ†é…çš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">previously allocated by thread T0 here:</span><br><span class="line">    <span class="comment">#0 0x7faf0dfbf808 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cc:144</span></span><br><span class="line">    <span class="comment">#1 0x55bced5781e5 in main /home/sv/æ¡Œé¢/main.cpp:5</span></span><br><span class="line">    <span class="comment">#2 0x7faf0d998082 in __libc_start_main ../csu/libc-start.c:308</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>Heap buffer overflow</strong></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> *p = <span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line">    p[<span class="number">10</span>] =  <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ g++ -g -fsanitize=address main.cpp -fpermissive</span><br><span class="line">main.cpp: In <span class="keyword">function</span> â€˜int main(int, char**)â€™:</span><br><span class="line">main.cpp:5:21: warning: invalid conversion from â€˜void*â€™ to â€˜char*â€™ [-fpermissive]</span><br><span class="line">    5 |     char *p = malloc(10);</span><br><span class="line">      |               ~~~~~~^~~~</span><br><span class="line">      |                     |</span><br><span class="line">      |                     void*</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ ./a.out</span><br><span class="line">=================================================================</span><br><span class="line">==1336960==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60200000001a at pc 0x5563af190226 bp 0x7fff4fbb4d30 sp 0x7fff4fbb4d20</span><br><span class="line">WRITE of size 1 at 0x60200000001a thread T0</span><br><span class="line">    <span class="comment">#0 0x5563af190225 in main /home/sv/æ¡Œé¢/main.cpp:6</span></span><br><span class="line">    <span class="comment">#1 0x7f88cfff5082 in __libc_start_main ../csu/libc-start.c:308</span></span><br><span class="line">    <span class="comment">#2 0x5563af19010d in _start (/home/sv/æ¡Œé¢/a.out+0x110d)</span></span><br><span class="line"></span><br><span class="line">0x60200000001a is located 0 bytes to the right of 10-byte region [0x602000000010,0x60200000001a)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    <span class="comment">#0 0x7f88d061c808 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cc:144</span></span><br><span class="line">    <span class="comment">#1 0x5563af1901e5 in main /home/sv/æ¡Œé¢/main.cpp:5</span></span><br><span class="line">    <span class="comment">#2 0x7f88cfff5082 in __libc_start_main ../csu/libc-start.c:308</span></span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /home/sv/æ¡Œé¢/main.cpp:6 <span class="keyword">in</span> main</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  0x0c047fff7fb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c047fff7fc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c047fff7fd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c047fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c047fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">=&gt;0x0c047fff8000: fa fa 00[02]fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c047fff8010: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c047fff8020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c047fff8030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c047fff8040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c047fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow byte legend (one shadow byte represents 8 application bytes):</span><br><span class="line">  Addressable:           00</span><br><span class="line">  Partially addressable: 01 02 03 04 05 06 07</span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="built_in">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      <span class="built_in">fc</span></span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==1336960==ABORTING</span><br></pre></td></tr></table></figure><blockquote><p><strong>Stack buffer overflow</strong></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> p[<span class="number">10</span>];</span><br><span class="line">    p[<span class="number">10</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">=================================================================</span><br><span class="line">==26927==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7fffe0389d7a at pc 0x5577fcfd7289 bp 0x7fffe0389d30 sp 0x7fffe0389d20</span><br><span class="line">WRITE of size 1 at 0x7fffe0389d7a thread T0</span><br><span class="line">    <span class="comment">#0 0x5577fcfd7288 in main /home/thomas/test/ctest/main.c:5</span></span><br><span class="line">    <span class="comment">#1 0x7f97e9d0d082 in __libc_start_main ../csu/libc-start.c:308</span></span><br><span class="line">    <span class="comment">#2 0x5577fcfd710d in _start (/home/thomas/test/ctest/a.out+0x110d)</span></span><br><span class="line"> </span><br><span class="line">Address 0x7fffe0389d7a is located <span class="keyword">in</span> stack of thread T0 at offset 42 <span class="keyword">in</span> frame</span><br><span class="line">    <span class="comment">#0 0x5577fcfd71d8 in main /home/thomas/test/ctest/main.c:3</span></span><br><span class="line"> </span><br><span class="line">  This frame has 1 object(s):</span><br><span class="line">    [32, 42) <span class="string">&#x27;p&#x27;</span> (line 4) &lt;== Memory access at offset 42 overflows this variable</span><br><span class="line">HINT: this may be a <span class="literal">false</span> positive <span class="keyword">if</span> your program uses some custom stack unwind mechanism, swapcontext or vfork</span><br><span class="line">      (longjmp and C++ exceptions *are* supported)</span><br><span class="line">SUMMARY: AddressSanitizer: stack-buffer-overflow /home/thomas/test/ctest/main.c:5 <span class="keyword">in</span> main</span><br><span class="line">...</span><br></pre></td></tr></table></figure><blockquote><p><strong>Global buffer overflow</strong></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> p[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    p[<span class="number">10</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ï¼Œè¿è¡Œè¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">=================================================================</span><br><span class="line">==27271==ERROR: AddressSanitizer: global-buffer-overflow on address 0x5632b22930aa at pc 0x5632b2290213 bp 0x7ffeba0b5140 sp 0x7ffeba0b5130</span><br><span class="line">WRITE of size 1 at 0x5632b22930aa thread T0</span><br><span class="line">    <span class="comment">#0 0x5632b2290212 in main /home/thomas/test/ctest/main.c:5</span></span><br><span class="line">    <span class="comment">#1 0x7f90fd627082 in __libc_start_main ../csu/libc-start.c:308</span></span><br><span class="line">    <span class="comment">#2 0x5632b229010d in _start (/home/thomas/test/ctest/a.out+0x110d)</span></span><br><span class="line"> </span><br><span class="line">0x5632b22930aa is located 0 bytes to the right of global variable <span class="string">&#x27;p&#x27;</span> defined <span class="keyword">in</span> <span class="string">&#x27;main.c:2:6&#x27;</span> (0x5632b22930a0) of size 10</span><br><span class="line">SUMMARY: AddressSanitizer: global-buffer-overflow /home/thomas/test/ctest/main.c:5 <span class="keyword">in</span> main</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ã€‚ã€‚ã€‚</p><h2 id="LeakSanitizer">LeakSanitizer</h2><p>LeakSanitizeræ˜¯ä¸€ä¸ªå¼ºå¤§çš„å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·ï¼Œä¸»è¦ç”¨äºC/C++ç¨‹åºçš„å†…å­˜æ³„æ¼é—®é¢˜è¯Šæ–­ã€‚å®ƒé€šè¿‡åœ¨ç¨‹åºè¿è¡Œæ—¶ç›‘æ§åŠ¨æ€å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„è¡Œä¸ºï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½å’Œè§£å†³å†…å­˜æ³„æ¼é—®é¢˜ã€‚LeakSanitizeræ˜¯Clang/LLVMç¼–è¯‘å™¨å¥—ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œä¸GCCç¼–è¯‘å™¨çš„å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·Valgrindäº’ä¸ºè¡¥å……ã€‚</p><p>ç¤ºä¾‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span>* ptr = (<span class="type">int</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">int</span>)); <span class="comment">// åˆ†é…å†…å­˜</span></span><br><span class="line">    <span class="comment">// ptræ²¡æœ‰è¢«é‡Šæ”¾</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">foo</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ clang -g -fsanitize=leak main.cpp -fpermissive</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ã€Note:g++ç¼–è¯‘å¯èƒ½ä¼šå‡ºé”™~ã€‘</p><p>æ¨èé˜…è¯»ï¼š</p><ol><li><a href="https://zhuanlan.zhihu.com/p/357803433">è¯¦è§£ä¸‰å¤§ç¼–è¯‘å™¨ï¼šgccã€llvm å’Œ clang - çŸ¥ä¹ä¸“æ </a></li><li><a href="https://zhuanlan.zhihu.com/p/682607611">GCC vs Clang: ä¸¤å¤§ç¼–è¯‘å™¨å·¨å¤´çš„é¾™äº‰è™æ–— - çŸ¥ä¹ä¸“æ </a></li><li><a href="https://www.cnblogs.com/findumars/p/14213309.html">GCCä¸Clang / LLVMï¼šC / C ++ç¼–è¯‘å™¨çš„æ·±åº¦æ¯”è¾ƒ - findumars - åšå®¢å›­</a></li><li><a href="https://zhuanlan.zhihu.com/p/545695166">clang ä¸ GCC çš„åŒºåˆ« - çŸ¥ä¹ - çŸ¥ä¹ä¸“æ </a></li><li><a href="https://zh.wikipedia.org/wiki/Clang">Clang - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦</a></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ ./a.out</span><br><span class="line"></span><br><span class="line">=================================================================</span><br><span class="line">==1338908==ERROR: LeakSanitizer: detected memory leaks</span><br><span class="line"></span><br><span class="line">Direct leak of 4 byte(s) <span class="keyword">in</span> 1 object(s) allocated from:</span><br><span class="line">    <span class="comment">#0 0x407925 in malloc (/home/sv/æ¡Œé¢/a.out+0x407925)</span></span><br><span class="line">    <span class="comment">#1 0x426dc1 in foo() /home/sv/æ¡Œé¢/main.cpp:4:23</span></span><br><span class="line">    <span class="comment">#2 0x426de3 in main /home/sv/æ¡Œé¢/main.cpp:9:5</span></span><br><span class="line">    <span class="comment">#3 0x7f0251d2e082 in __libc_start_main /build/glibc-e2p3jK/glibc-2.31/csu/../csu/libc-start.c:308:16</span></span><br><span class="line"></span><br><span class="line">SUMMARY: LeakSanitizer: 4 byte(s) leaked <span class="keyword">in</span> 1 allocation(s).</span><br></pre></td></tr></table></figure><p>æ³¨æ„äº‹é¡¹</p><ol><li>LeakSanitizerä¸»è¦é’ˆå¯¹åŠ¨æ€å†…å­˜åˆ†é…çš„æ£€æµ‹ï¼Œå¯¹äºé™æ€åˆ†é…æˆ–å…¨å±€åˆ†é…çš„å†…å­˜æ³„æ¼æ— èƒ½ä¸ºåŠ›ã€‚</li><li>å¯ç”¨LeakSanitizerå¯èƒ½ä¼šå¯¹ç¨‹åºæ€§èƒ½äº§ç”Ÿä¸€å®šå½±å“ï¼Œå› æ­¤é€šå¸¸åœ¨å¼€å‘å’Œæµ‹è¯•é˜¶æ®µä½¿ç”¨ï¼Œè€Œä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æŒç»­å¯ç”¨ã€‚</li><li>åœ¨ä½¿ç”¨LeakSanitizeræ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°å„ç§é—®é¢˜ï¼Œå¦‚åˆå§‹åŒ–å¤±è´¥ã€ç¼ºå°‘ä¾èµ–åº“ç­‰ã€‚è¿™äº›é—®é¢˜é€šå¸¸éœ€è¦æ ¹æ®å…·ä½“çš„é”™è¯¯ä¿¡æ¯è¿›è¡Œæ’æŸ¥å’Œè§£å†³ã€‚</li></ol><p><strong>AddressSanitizerå’ŒLeakSanitizerçš„åŒºåˆ«</strong></p><p>AddressSanitizerï¼ˆASanï¼‰å’ŒLeakSanitizerï¼ˆLSanï¼‰éƒ½æ˜¯ç”¨äºå†…å­˜é”™è¯¯æ£€æµ‹çš„å·¥å…·ï¼Œå®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºæ£€æµ‹çš„é—®é¢˜ç±»å‹å’Œåº”ç”¨åœºæ™¯ã€‚</p><ol><li>AddressSanitizerï¼ˆASanï¼‰:<ul><li>ASanæ˜¯ä¸€ç§ç”¨äºæ£€æµ‹å†…å­˜é”™è¯¯çš„å·¥å…·ï¼ŒåŒ…æ‹¬å†…å­˜è®¿é—®è¶Šç•Œã€ä½¿ç”¨é‡Šæ”¾çš„å†…å­˜ã€å †æ ˆæº¢å‡ºç­‰é—®é¢˜ã€‚</li><li>ASanèƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶æ’é¢å¤–çš„è¿è¡Œæ—¶æ£€æŸ¥ä»£ç ï¼Œå¯¹è¿›è¡ŒåŠ¨æ€åˆ†æï¼Œæä¾›è¯¦ç»†çš„ä¿¡æ¯å’Œé”™è¯¯çš„ä½ç½®ã€‚</li><li>ASanè¦ç”¨äºå‘ç°å’Œè°ƒè¯•å†…å­˜ç›¸å…³çš„é—®é¢˜ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…æ—©å‘ç°å’Œä¿®å†…å­˜é”™è¯¯ã€‚</li></ul></li><li>LeakSanitizerï¼ˆLSï¼‰:<ul><li>LSanæ˜¯ä¸€ç§ç”¨äºæ£€æµ‹å†…å­˜æ³„æ¼çš„å·¥å…·ï¼Œä¸»è¦ç”¨äºæ£€æµ‹ç¨‹åºä¸­çš„åŠ¨æ€å†…å­˜åˆ†é…å’Œæ²¡æœ‰é‡Šæ”¾çš„å†…å­˜ã€‚</li><li>LSané€šè¿‡è¿½è¸ªå†…å­˜åˆ†é…å’Œé‡Šæ”¾æ“ä½œï¼Œæ£€æµ‹å‡ºæœªé‡Šæ”¾çš„å†…å­˜å¹¶æŠ¥å‘Šæ³„æ¼çš„ä½ç½®å’Œç±»å‹ã€‚</li><li>LSanä¸»è¦ç”¨äºå‘ç°å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå¸®åŠ©å¼€å‘è€…æŸ¥æ‰¾æœªé‡Šæ”¾çš„å†…å­˜èµ„æºï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨æ•ˆç‡ã€‚</li></ul></li></ol><p>ASanä¸»è¦ç”¨äºæ£€æµ‹å†…å­˜é”™è¯¯ï¼Œå¦‚è¶Šç•Œè®¿é—®å’Œé‡Šæ”¾åï¼Œè€ŒLSanä¸»ç”¨äºæ£€æµ‹å†…å­˜æ³„æ¼é—®é¢˜ã€‚å®ƒä»¬éƒ½èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶æ’å…¥é¢å¤–çš„è¿è¡Œæ—¶æ£€æŸ¥ä»£ç ï¼Œå¸®åŠ©å¼€å‘è€…å‘ç°ä¿®å¤å†…å­˜ç›¸å…³é—®é¢˜ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://www.cnblogs.com/thammer/p/17117286.html">Sanitizersä½¿ç”¨ä»‹ç»</a></li><li><a href="https://blog.csdn.net/zjtimef/article/details/138415276">LeakSanitizeræ¦‚è¿°ä¸ä½¿ç”¨æŒ‡å—</a></li><li><a href="https://zhuanlan.zhihu.com/p/508470880">[C++]ğŸ¤“Macä¸‹C++å†…å­˜æ£€æŸ¥æŒ‡åŒ—(Valgrind VS Asan)</a></li><li><a href="https://zhuanlan.zhihu.com/p/37515148">å†…å­˜æ£€æµ‹å·¥å…·AddressSanitizer</a></li><li><a href="https://zhuanlan.zhihu.com/p/28117513">AddressSanitizerç®—æ³•åŠæºç åˆ†æ</a></li></ul>]]></content>
    
    
    <summary type="html">å†…å­˜æ£€æµ‹-Sanitizer</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>Valgrind</title>
    <link href="https://penge666.github.io/posts/41691f83.html"/>
    <id>https://penge666.github.io/posts/41691f83.html</id>
    <published>2024-05-14T02:30:16.000Z</published>
    <updated>2024-05-15T01:40:43.262Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Valgrindçš„ä»‹ç»">Valgrindçš„ä»‹ç»</h2><blockquote><p><strong>ä»‹ç»</strong></p></blockquote><p>Valgrindæ˜¯ä¸€å¥—Linuxä¸‹ï¼Œå¼€æ”¾æºä»£ç ï¼ˆGPL V2ï¼‰çš„ä»¿çœŸè°ƒè¯•å·¥å…·çš„é›†åˆã€‚Valgrindç”±å†…æ ¸ï¼ˆcoreï¼‰ä»¥åŠåŸºäºå†…æ ¸çš„å…¶ä»–è°ƒè¯•å·¥å…·ç»„æˆã€‚å†…æ ¸ç±»ä¼¼äºä¸€ä¸ªæ¡†æ¶ï¼ˆframeworkï¼‰ï¼Œå®ƒæ¨¡æ‹Ÿäº†ä¸€ä¸ªCPUç¯å¢ƒï¼Œå¹¶æä¾›æœåŠ¡ç»™å…¶ä»–å·¥å…·ï¼›è€Œå…¶ä»–å·¥å…·åˆ™ç±»ä¼¼äºæ’ä»¶ (plug-in)ï¼Œåˆ©ç”¨å†…æ ¸æä¾›çš„æœåŠ¡å®Œæˆå„ç§ç‰¹å®šçš„å†…å­˜è°ƒè¯•ä»»åŠ¡ã€‚Valgrindçš„ä½“ç³»ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240514111938295.png" alt="image-20240514111938295"></p><p>é€šä¿—çš„è¯´ï¼š</p><p>Valgrindæ˜¯ä¸€ä¸ªç”±å¤šä¸ªç»„ä»¶æ„æˆçš„å†…å­˜è°ƒè¯•å·¥å…·å¥—ä»¶ã€‚è¿™äº›ç»„ä»¶å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šå†…æ ¸å’ŒåŸºäºå†…æ ¸çš„å…¶ä»–å·¥å…·ã€‚</p><ol><li><strong>å†…æ ¸</strong>ï¼šå†…æ ¸åœ¨è¿™é‡Œå¯ä»¥è¢«ç†è§£ä¸ºValgrindçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªè™šæ‹Ÿçš„CPUç¯å¢ƒï¼Œå¹¶ä¸”æä¾›ä¸€äº›åŸºæœ¬çš„æœåŠ¡ï¼Œæ¯”å¦‚å†…å­˜ç®¡ç†ã€é”™è¯¯æ£€æµ‹ç­‰ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªå·¥å‚çš„éª¨æ¶æˆ–è€…æ¡†æ¶ï¼Œæä¾›äº†åŸºç¡€è®¾æ–½å’Œä¸€äº›å¸¸ç”¨çš„åŠŸèƒ½ã€‚</li><li><strong>å…¶ä»–å·¥å…·</strong>ï¼šè¿™äº›å·¥å…·åˆ™ç±»ä¼¼äºæ’ä»¶ï¼Œå®ƒä»¬åˆ©ç”¨å†…æ ¸æä¾›çš„æœåŠ¡ï¼Œå®Œæˆå„ç§ç‰¹å®šçš„å†…å­˜è°ƒè¯•ä»»åŠ¡ã€‚æ¯”å¦‚Memcheckå°±æ˜¯å…¶ä¸­ä¸€ä¸ªå·¥å…·ï¼Œå®ƒå¯ä»¥æ£€æµ‹å†…å­˜æ³„æ¼ã€æ•°ç»„è¶Šç•Œç­‰é—®é¢˜ã€‚ä½ å¯ä»¥æŠŠè¿™äº›å·¥å…·æƒ³è±¡æˆå·¥å‚çš„æµæ°´çº¿ï¼Œæ¯ä¸ªæµæ°´çº¿éƒ½è´Ÿè´£å®Œæˆç‰¹å®šçš„ä»»åŠ¡ã€‚</li></ol><p><strong>Valgrindæ£€æµ‹ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºæ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼çš„å·¥ä½œåŸç†</strong></p><p>å®ƒçš„å·¥ä½œåŸç†ä¸»è¦æ˜¯é€šè¿‡æ’æ¡©æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åœ°æ’å…¥ä¸€äº›æ£€æŸ¥ä»£ç æ¥ç›‘è§†å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚</p><p>å½“æˆ‘ä»¬ä½¿ç”¨Valgrindè¿è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼ŒValgrindä¼šé¦–å…ˆåŠ è½½è‡ªå·±çš„å†…æ ¸ï¼Œç„¶åæŠŠæˆ‘ä»¬çš„ç¨‹åºåŠ è½½åˆ°è‡ªå·±çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­ã€‚åœ¨è¿™ä¸ªè™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­ï¼ŒValgrindå¯ä»¥å®Œå…¨æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼Œå¹¶ä¸”å¯ä»¥æ£€æµ‹åˆ°æ‰€æœ‰çš„å†…å­˜è®¿é—®ã€‚</p><p>Valgrindä½¿ç”¨ä¸€ç§ç§°ä¸ºå½±å­å†…å­˜çš„æŠ€æœ¯æ¥è·Ÿè¸ªæ¯ä¸ªå­—èŠ‚çš„å†…å­˜çŠ¶æ€ï¼ŒåŒ…æ‹¬è¯¥å­—èŠ‚æ˜¯å¦å·²è¢«åˆ†é…ã€æ˜¯å¦å·²è¢«é‡Šæ”¾ã€æ˜¯å¦å·²è¢«åˆå§‹åŒ–ç­‰ã€‚æ¯å½“ç¨‹åºè¿›è¡Œä¸€æ¬¡å†…å­˜æ“ä½œï¼ˆå¦‚mallocã€freeã€readã€writeç­‰ï¼‰æ—¶ï¼ŒValgrindéƒ½ä¼šæ›´æ–°å½±å­å†…å­˜çš„çŠ¶æ€ï¼Œå¹¶æ£€æŸ¥è¿™æ¬¡æ“ä½œæ˜¯å¦åˆæ³•ã€‚</p><p>å¦‚æœValgrindæ£€æµ‹åˆ°ä¸€æ¬¡éæ³•çš„å†…å­˜æ“ä½œï¼Œæ¯”å¦‚è®¿é—®äº†æœªè¢«åˆå§‹åŒ–çš„å†…å­˜ï¼Œæˆ–è€…è®¿é—®äº†å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œå®ƒå°±ä¼šç«‹å³æŠ¥å‘Šä¸€ä¸ªé”™è¯¯ã€‚å½“ç¨‹åºé€€å‡ºæ—¶ï¼ŒValgrindä¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰çš„å†…å­˜éƒ½å·²ç»è¢«æ­£ç¡®é‡Šæ”¾ï¼Œå¦‚æœæœ‰ä»»ä½•å†…å­˜æ³„æ¼ï¼Œå®ƒä¹Ÿä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ã€‚</p><blockquote><p><strong>valgrindå·¥å…·</strong></p></blockquote><p>ï¼ˆ1ï¼‰Memcheckã€‚è¿™æ˜¯valgrindåº”ç”¨æœ€å¹¿æ³›çš„å·¥å…·ï¼Œä¸€ä¸ªé‡é‡çº§çš„å†…å­˜æ£€æŸ¥å™¨ï¼Œèƒ½å¤Ÿå‘ç°å¼€å‘ä¸­ç»å¤§å¤šæ•°å†…å­˜é”™è¯¯ä½¿ç”¨æƒ…å†µï¼Œæ¯”å¦‚ï¼šä½¿ç”¨æœªåˆå§‹åŒ–çš„å†…å­˜ï¼Œä½¿ç”¨å·²ç»é‡Šæ”¾äº†çš„å†…å­˜ï¼Œå†…å­˜è®¿é—®è¶Šç•Œç­‰ã€‚è¿™ä¹Ÿæ˜¯æœ¬æ–‡å°†é‡ç‚¹ä»‹ç»çš„éƒ¨åˆ†ã€‚</p><p>ï¼ˆ2ï¼‰Callgrindã€‚å®ƒä¸»è¦ç”¨æ¥æ£€æŸ¥ç¨‹åºä¸­å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜ã€‚</p><p>ï¼ˆ3ï¼‰Cachegrindã€‚å®ƒä¸»è¦ç”¨æ¥æ£€æŸ¥ç¨‹åºä¸­ç¼“å­˜ä½¿ç”¨å‡ºç°çš„é—®é¢˜ã€‚</p><p>ï¼ˆ4ï¼‰Helgrindã€‚å®ƒä¸»è¦ç”¨æ¥æ£€æŸ¥å¤šçº¿ç¨‹ç¨‹åºä¸­å‡ºç°çš„ç«äº‰é—®é¢˜ã€‚</p><p>ï¼ˆ5ï¼‰Massifã€‚å®ƒä¸»è¦ç”¨æ¥æ£€æŸ¥ç¨‹åºä¸­å †æ ˆä½¿ç”¨ä¸­å‡ºç°çš„é—®é¢˜ã€‚</p><p>ï¼ˆ6ï¼‰Extensionã€‚å¯ä»¥åˆ©ç”¨coreæä¾›çš„åŠŸèƒ½ï¼Œè‡ªå·±ç¼–å†™ç‰¹å®šçš„å†…å­˜è°ƒè¯•å·¥å…·ã€‚</p><blockquote><p><strong>Memcheckæ£€æŸ¥çš„åŸç†</strong></p></blockquote><ul><li><a href="https://zhuanlan.zhihu.com/p/510362477">Valgrindç¬”è®°ï¼ˆäºŒï¼‰ï¼šMemCheckåŸºæœ¬åŸç†</a></li></ul><p>Memcheckæ£€æµ‹å†…å­˜é—®é¢˜çš„åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240514112408569.png" alt="image-20240514112408569"></p><p>Memcheckæ˜¯Valgrindçš„ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒç”¨äºæ£€æµ‹Cå’ŒC++ç¨‹åºä¸­çš„å†…å­˜ç®¡ç†é—®é¢˜ã€‚å®ƒé€šè¿‡åœ¨ç¨‹åºè¿è¡ŒæœŸé—´æ‹¦æˆªæ‰€æœ‰å†…å­˜è®¿é—®å’Œç®¡ç†è¯·æ±‚ï¼Œæ¥æ£€æµ‹å†…å­˜æ³„æ¼ã€ä½¿ç”¨æœªåˆå§‹åŒ–çš„å†…å­˜ã€è®¿é—®å·²ç»é‡Šæ”¾çš„å†…å­˜ç­‰é—®é¢˜ã€‚</p><p>Memcheckçš„å·¥ä½œåŸç†ä¸»è¦ä¾èµ–äºä¸¤ä¸ªå…¨å±€è¡¨ï¼š</p><ol><li><strong>A-bitï¼ˆAddressability bitï¼‰è¡¨</strong>ï¼šA-bitè¡¨ç”¨äºæ ‡è®°å“ªäº›å†…å­˜æ˜¯å¯è®¿é—®çš„ã€‚å¯¹äºæ¯ä¸ªå­—èŠ‚çš„å†…å­˜ï¼ŒA-bitè¡¨éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ä½ã€‚å¦‚æœè¯¥ä½è¢«è®¾ç½®ï¼Œé‚£ä¹ˆå¯¹åº”çš„å†…å­˜å­—èŠ‚å°±æ˜¯å¯è®¿é—®çš„ã€‚å¦åˆ™ï¼Œè¯¥å­—èŠ‚æ˜¯ä¸å¯è®¿é—®çš„ã€‚å½“ç¨‹åºè¯•å›¾è¯»å†™ä¸€ä¸ªä¸å¯è®¿é—®çš„å†…å­˜å­—èŠ‚æ—¶ï¼ŒMemcheckä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ã€‚</li><li><strong>V-bitï¼ˆValidity bitï¼‰è¡¨</strong>ï¼šV-bitè¡¨ç”¨äºæ ‡è®°å“ªäº›å†…å­˜æ˜¯å·²åˆå§‹åŒ–çš„ã€‚å¯¹äºæ¯ä¸ªå­—èŠ‚çš„å†…å­˜ï¼ŒV-bitè¡¨éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ä½ã€‚å¦‚æœè¯¥ä½è¢«è®¾ç½®ï¼Œé‚£ä¹ˆå¯¹åº”çš„å†…å­˜å­—èŠ‚å°±æ˜¯å·²ç»è¢«åˆå§‹åŒ–çš„ã€‚å¦åˆ™ï¼Œè¯¥å­—èŠ‚æ˜¯æœªåˆå§‹åŒ–çš„ã€‚å½“ç¨‹åºè¯•å›¾è¯»å–ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å†…å­˜å­—èŠ‚æ—¶ï¼ŒMemcheckä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ã€‚</li></ol><h2 id="å†…å­˜æ³„æ¼ç¤ºä¾‹">å†…å­˜æ³„æ¼ç¤ºä¾‹</h2><p>Valgrind å¯ä»¥ç”¨æ¥æ£€æµ‹ç¨‹åºæ˜¯å¦æœ‰éæ³•ä½¿ç”¨å†…å­˜çš„é—®é¢˜ï¼Œä¾‹å¦‚è®¿é—®æœªåˆå§‹åŒ–çš„å†…å­˜ã€è®¿é—®æ•°ç»„æ—¶è¶Šç•Œã€å¿˜è®°é‡Šæ”¾åŠ¨æ€å†…å­˜ç­‰é—®é¢˜ã€‚åœ¨ Linux å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£… Valgrindï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ sudo apt-get install valgrind</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wget ftp://sourceware.org/pub/valgrind/valgrind-3.13.0.tar.bz2</span><br><span class="line">$ bzip2 -d valgrind-3.13.0.tar.bz2</span><br><span class="line">$ tar -xf valgrind-3.13.0.tar</span><br><span class="line">$ <span class="built_in">cd</span> valgrind-3.13.0</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æ¼”ç¤ºmemcheckçš„ç¤ºä¾‹ã€‚å…¶ä»–æ›´å¤šå·¥å…·çš„ç¤ºä¾‹è¯·çœ‹ï¼š<a href="https://blog.csdn.net/weixin_45518728/article/details/119865117">valgrindåŸºæœ¬åŠŸèƒ½ä»‹ç»ã€åŸºç¡€ä½¿ç”¨æ–¹æ³•è¯´æ˜</a></p><h3 id="æœªå³æ—¶é‡Šæ”¾">æœªå³æ—¶é‡Šæ”¾</h3><p>Valgrind å¯ä»¥ç”¨æ¥æ£€æµ‹ç¨‹åºåœ¨å“ªä¸ªä½ç½®å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œä¾‹å¦‚ä¸‹é¢çš„ç¨‹åºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> *array = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ç¨‹åºæ—¶ï¼Œéœ€è¦åŠ ä¸Š<code>-g</code>é€‰é¡¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ g++ -g -o main_c main.cpp</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Valgrind æ£€æµ‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ valgrind --tool=memcheck --leak-check=full  ./main_c</span><br><span class="line">==<span class="number">31416</span>== Memcheck, a memory error detector</span><br><span class="line">==<span class="number">31416</span>== Copyright (C) <span class="number">2002</span>-<span class="number">2017</span>, and GNU GPL&#x27;d, by Julian Seward et al.</span><br><span class="line">==<span class="number">3141</span>6== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span><br><span class="line">==<span class="number">3141</span>6== Command: ./main_c</span><br><span class="line">==<span class="number">3141</span>6==</span><br><span class="line">==<span class="number">3141</span>6==</span><br><span class="line">==<span class="number">3141</span>6== HEAP SUMMARY:</span><br><span class="line">==<span class="number">3141</span>6==     in use at exit: 4 bytes in 1 blocks</span><br><span class="line">==<span class="number">3141</span>6==   total heap usage: 1 allocs, 0 frees, 4 bytes allocated</span><br><span class="line">==<span class="number">3141</span>6==</span><br><span class="line">==<span class="number">3141</span>6== 4 bytes in 1 blocks are definitely lost in loss record 1 of 1</span><br><span class="line">==<span class="number">3141</span>6==    at 0x4C2DBF6: malloc (vg_replace_malloc.c:299)</span><br><span class="line">==<span class="number">3141</span>6==    by 0x<span class="number">400537</span>: main (main.c:5)</span><br><span class="line">==<span class="number">3141</span>6==</span><br><span class="line">==<span class="number">3141</span>6== LEAK SUMMARY:</span><br><span class="line">==<span class="number">3141</span>6==    definitely lost: 4 bytes in 1 blocks</span><br><span class="line">==<span class="number">3141</span>6==    indirectly lost: 0 bytes in 0 blocks</span><br><span class="line">==<span class="number">3141</span>6==      possibly lost: 0 bytes in 0 blocks</span><br><span class="line">==<span class="number">3141</span>6==    still reachable: 0 bytes in 0 blocks</span><br><span class="line">==<span class="number">3141</span>6==         suppressed: 0 bytes in 0 blocks</span><br><span class="line">==<span class="number">3141</span>6==</span><br><span class="line">==<span class="number">3141</span>6== For counts of detected and suppressed errors, rerun with: -v</span><br><span class="line">==<span class="number">3141</span>6== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)</span><br></pre></td></tr></table></figure><p>çœ‹çœ‹è¾“å‡ºä¿¡æ¯ä¸­çš„<code>HEAP SUMMARY</code>ï¼Œå®ƒè¡¨ç¤ºç¨‹åºåœ¨å †ä¸Šåˆ†é…å†…å­˜çš„æƒ…å†µï¼Œå…¶ä¸­çš„<code>1 allocs</code>è¡¨ç¤ºç¨‹åºåˆ†é…äº† 1 æ¬¡å†…å­˜ï¼Œ<code>0 frees</code>è¡¨ç¤ºç¨‹åºé‡Šæ”¾äº† 0 æ¬¡å†…å­˜ï¼Œ<code>4 bytes allocated</code>è¡¨ç¤ºåˆ†é…äº† 4 ä¸ªå­—èŠ‚çš„å†…å­˜ã€‚<br>ã€€å¦å¤–ï¼ŒValgrind ä¹Ÿä¼šæŠ¥å‘Šç¨‹åºæ˜¯åœ¨å“ªä¸ªä½ç½®å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚ä¾‹å¦‚ï¼Œä»ä¸‹é¢çš„ä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºå‘ç”Ÿäº†ä¸€æ¬¡å†…å­˜æ³„æ¼ï¼Œä½ç½®æ˜¯<code>main.c</code>æ–‡ä»¶çš„ç¬¬ 5 è¡Œã€‚</p><p>Valgrind ä¹Ÿå¯ä»¥ç”¨æ¥æ£€æµ‹ C++ ç¨‹åºçš„å†…å­˜æ³„æ¼ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ C++ ç¨‹åºï¼Œæ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> ptr = <span class="keyword">new</span> std::<span class="built_in">string</span>(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> ptr;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Valgrind åˆ†æè¿™æ®µç¨‹åºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all ./main_cpp</span><br><span class="line">==31438== Memcheck, a memory error detector</span><br><span class="line">==31438== Copyright (C) 2002-2017, and GNU GPL<span class="string">&#x27;d, by Julian Seward et al.</span></span><br><span class="line"><span class="string">==31438== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span></span><br><span class="line"><span class="string">==31438== Command: ./main_cpp</span></span><br><span class="line"><span class="string">==31438==</span></span><br><span class="line"><span class="string">==31438==</span></span><br><span class="line"><span class="string">==31438== HEAP SUMMARY:</span></span><br><span class="line"><span class="string">==31438==     in use at exit: 72,704 bytes in 1 blocks</span></span><br><span class="line"><span class="string">==31438==   total heap usage: 2 allocs, 1 frees, 72,736 bytes allocated</span></span><br><span class="line"><span class="string">==31438==</span></span><br><span class="line"><span class="string">==31438== 72,704 bytes in 1 blocks are still reachable in loss record 1 of 1</span></span><br><span class="line"><span class="string">==31438==    at 0x4C2DBF6: malloc (vg_replace_malloc.c:299)</span></span><br><span class="line"><span class="string">==31438==    by 0x4EC3EFF: ??? (in /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21)</span></span><br><span class="line"><span class="string">==31438==    by 0x40104E9: call_init.part.0 (dl-init.c:72)</span></span><br><span class="line"><span class="string">==31438==    by 0x40105FA: call_init (dl-init.c:30)</span></span><br><span class="line"><span class="string">==31438==    by 0x40105FA: _dl_init (dl-init.c:120)</span></span><br><span class="line"><span class="string">==31438==    by 0x4000CF9: ??? (in /lib/x86_64-linux-gnu/ld-2.23.so)</span></span><br><span class="line"><span class="string">==31438==</span></span><br><span class="line"><span class="string">==31438== LEAK SUMMARY:</span></span><br><span class="line"><span class="string">==31438==    definitely lost: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31438==    indirectly lost: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31438==      possibly lost: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31438==    still reachable: 72,704 bytes in 1 blocks</span></span><br><span class="line"><span class="string">==31438==         suppressed: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31438==</span></span><br><span class="line"><span class="string">==31438== For counts of detected and suppressed errors, rerun with: -v</span></span><br><span class="line"><span class="string">==31438== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Valgrind åˆ†æ C++ ç¨‹åºæ—¶ï¼Œæœ‰ä¸€äº›é—®é¢˜éœ€è¦ç•™æ„ã€‚ä¾‹å¦‚ï¼Œè¿™ä¸ªç¨‹åºå¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œä½†æ˜¯ä»<code>HEAP SUMMARY</code>å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºåˆ†é…äº† 2 æ¬¡å†…å­˜ï¼Œä½†å´åªé‡Šæ”¾äº† 1 æ¬¡å†…å­˜ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ</p><p>è§£é‡Šï¼š</p><p>ä½ çš„è¿™æ®µä»£ç ä¸­ï¼Œ<code>new std::string(&quot;Hello, World!&quot;)</code> è¿™è¡Œä»£ç å®é™…ä¸Šè¿›è¡Œäº†ä¸¤æ¬¡å†…å­˜åˆ†é…ï¼š</p><ol><li>ç¬¬ä¸€æ¬¡åˆ†é…æ˜¯åˆ›å»º <code>std::string</code> å¯¹è±¡æœ¬èº«ï¼Œè¿™ä¼šåœ¨å †ä¸Šåˆ†é…ä¸€å—å†…å­˜ç”¨æ¥å­˜å‚¨ <code>std::string</code> å¯¹è±¡çš„å…ƒæ•°æ®ï¼Œå¦‚é•¿åº¦ã€å®¹é‡ç­‰ã€‚</li><li>ç¬¬äºŒæ¬¡åˆ†é…æ˜¯åœ¨ <code>std::string</code> å¯¹è±¡åˆå§‹åŒ–æ—¶ï¼Œå¯¹å­—ç¬¦ä¸² â€œHello, World!â€ è¿›è¡Œåˆ†é…ï¼Œå­˜å‚¨å®é™…çš„å­—ç¬¦ä¸²å†…å®¹ã€‚</li></ol><p>å› æ­¤ï¼Œä½ çš„ç¨‹åºå®é™…ä¸Šè¿›è¡Œäº†ä¸¤æ¬¡å†…å­˜åˆ†é…ã€‚</p><p>ç„¶ååœ¨ <code>delete ptr;</code> è¿™è¡Œä»£ç æ‰§è¡Œæ—¶ï¼Œä¼šè°ƒç”¨ <code>std::string</code> çš„ææ„å‡½æ•°ï¼Œè‡ªåŠ¨é‡Šæ”¾ç”¨äºå­˜å‚¨å­—ç¬¦ä¸²å†…å®¹çš„å†…å­˜ï¼Œç„¶åå†é‡Šæ”¾ <code>std::string</code> å¯¹è±¡æœ¬èº«çš„å†…å­˜ã€‚æ‰€ä»¥è™½ç„¶ä½ åªå†™äº†ä¸€æ¬¡ <code>delete</code>ï¼Œä½†å®é™…ä¸Šè¿›è¡Œäº†ä¸¤æ¬¡å†…å­˜é‡Šæ”¾ã€‚</p><p>ç„¶è€Œï¼ŒValgrind æŠ¥å‘Šçš„ â€œfreesâ€ æ•°é‡å¯èƒ½åªè®¡ç®—äº†ä½ ç›´æ¥è°ƒç”¨çš„ <code>delete</code> æ“ä½œï¼Œè€Œæ²¡æœ‰è®¡ç®— <code>std::string</code> ææ„å‡½æ•°ä¸­è‡ªåŠ¨è¿›è¡Œçš„å†…å­˜é‡Šæ”¾ï¼Œå› æ­¤å®ƒæ˜¾ç¤º â€œ1 freesâ€ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½ çš„ä»£ç æ˜¾ç¤º â€œ2 allocs, 1 freesâ€ã€‚</p><h3 id="æ£€æµ‹è¶Šç•Œè®¿é—®">æ£€æµ‹è¶Šç•Œè®¿é—®</h3><p>C++ ç¨‹åºç»å¸¸å‡ºç°çš„ Bug å°±æ˜¯æ•°ç»„è¶Šç•Œè®¿é—®ï¼Œä¾‹å¦‚ä¸‹é¢çš„ç¨‹åºå‡ºç°äº†è¶Šç•Œè®¿é—®ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">v</span><span class="params">(<span class="number">10</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    std::cout &lt;&lt; v[<span class="number">10</span>] &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Valgrind åˆ†æè¿™æ®µç¨‹åºï¼ŒValgrind ä¼šæç¤ºè¶Šç•Œè®¿é—®ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ g++ -std=c++<span class="number">11</span> -g -o main_cpp main.cpp</span><br><span class="line">$ valgrind --tool=memcheck --leak-check=full ./main_cpp</span><br><span class="line">==<span class="number">31523</span>== Memcheck, a memory error detector</span><br><span class="line">==<span class="number">31523</span>== <span class="built_in">Copyright</span> (C) <span class="number">2002</span><span class="number">-2017</span>, <span class="keyword">and</span> GNU GP<span class="string">L&#x27;d, by Julian Seward et al.</span></span><br><span class="line"><span class="string">==31523== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span></span><br><span class="line"><span class="string">==31523== Command: ./main_cpp</span></span><br><span class="line"><span class="string">==31523==</span></span><br><span class="line"><span class="string">==31523== Invalid read of size 4</span></span><br><span class="line"><span class="string">==31523==    at 0x400AD7: main (main.cpp:7)</span></span><br><span class="line"><span class="string">==31523==  Address 0x5ab5ca8 is 0 bytes after a block of size 40 alloc&#x27;</span>d</span><br><span class="line">==<span class="number">31523</span>==    at <span class="number">0x4C2E216</span>: <span class="keyword">operator</span> <span class="built_in">new</span>(<span class="type">unsigned</span> <span class="type">long</span>) (vg_replace_malloc.c:<span class="number">334</span>)</span><br><span class="line">==<span class="number">31523</span>==    by <span class="number">0x4010D3</span>: __gnu_cxx::new_allocator&lt;<span class="type">int</span>&gt;::<span class="built_in">allocate</span>(<span class="type">unsigned</span> <span class="type">long</span>, <span class="type">void</span> <span class="type">const</span>*) (new_allocator.h:<span class="number">104</span>)</span><br><span class="line">==<span class="number">31523</span>==    by <span class="number">0x401040</span>: std::allocator_traits&lt;std::allocator&lt;<span class="type">int</span>&gt; &gt;::<span class="built_in">allocate</span>(std::allocator&lt;<span class="type">int</span>&gt;&amp;, <span class="type">unsigned</span> <span class="type">long</span>) (alloc_traits.h:<span class="number">491</span>)</span><br><span class="line">==<span class="number">31523</span>==    by <span class="number">0x400F91</span>: std::_Vector_base&lt;<span class="type">int</span>, std::allocator&lt;<span class="type">int</span>&gt; &gt;::_M_allocate(<span class="type">unsigned</span> <span class="type">long</span>) (stl_vector.h:<span class="number">170</span>)</span><br><span class="line">==<span class="number">31523</span>==    by <span class="number">0x400E7E</span>: std::_Vector_base&lt;<span class="type">int</span>, std::allocator&lt;<span class="type">int</span>&gt; &gt;::_M_create_storage(<span class="type">unsigned</span> <span class="type">long</span>) (stl_vector.h:<span class="number">185</span>)</span><br><span class="line">==<span class="number">31523</span>==    by <span class="number">0x400D1E</span>: std::_Vector_base&lt;<span class="type">int</span>, std::allocator&lt;<span class="type">int</span>&gt; &gt;::_Vector_base(<span class="type">unsigned</span> <span class="type">long</span>, std::allocator&lt;<span class="type">int</span>&gt; <span class="type">const</span>&amp;) (stl_vector.h:<span class="number">136</span>)</span><br><span class="line">==<span class="number">31523</span>==    by <span class="number">0x400C11</span>: std::vector&lt;<span class="type">int</span>, std::allocator&lt;<span class="type">int</span>&gt; &gt;::<span class="built_in">vector</span>(<span class="type">unsigned</span> <span class="type">long</span>, <span class="type">int</span> <span class="type">const</span>&amp;, std::allocator&lt;<span class="type">int</span>&gt; <span class="type">const</span>&amp;) (stl_vector.h:<span class="number">291</span>)</span><br><span class="line">==<span class="number">31523</span>==    by <span class="number">0x400AB9</span>: <span class="built_in">main</span> (main.cpp:<span class="number">6</span>)</span><br></pre></td></tr></table></figure><p><code>Invalid read of size 4</code>è¡¨ç¤ºè¶Šç•Œè¯»å– 4 ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªæ“ä½œå‡ºç°åœ¨<code>main.cpp</code>æ–‡ä»¶çš„ç¬¬ 7 è¡Œã€‚å¦å¤–å¯ä»¥çœ‹åˆ°ï¼Œ<code>vector</code>åˆ†é…äº†ä¸€å— 40 å­—èŠ‚çš„å†…å­˜ï¼Œç¨‹åºè¶Šç•Œè®¿é—®ç´§æ€¥ç€è¿™å—å†…å­˜ä¹‹åçš„ 4 ä¸ªå­—èŠ‚ã€‚</p><h3 id="æ£€æµ‹æœªåˆå§‹åŒ–çš„å†…å­˜">æ£€æµ‹æœªåˆå§‹åŒ–çš„å†…å­˜</h3><p>å¦ä¸€ç§ç»å¸¸å‡ºç°çš„ Bugï¼Œå°±æ˜¯ç¨‹åºè®¿é—®äº†æœªåˆå§‹åŒ–çš„å†…å­˜ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;X is zero&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Valgrind æ£€æµ‹è¿™ä¸ªç¨‹åºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ g++ -std=c++<span class="number">11</span> -g -o main_cpp main.cpp</span><br><span class="line">$ valgrind --tool=memcheck --leak-check=full ./main_cpp</span><br><span class="line">==<span class="number">31554</span>== Memcheck, a memory error detector</span><br><span class="line">==<span class="number">31554</span>== <span class="built_in">Copyright</span> (C) <span class="number">2002</span><span class="number">-2017</span>, <span class="keyword">and</span> GNU GP<span class="string">L&#x27;d, by Julian Seward et al.</span></span><br><span class="line"><span class="string">==31554== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span></span><br><span class="line"><span class="string">==31554== Command: ./main_cpp</span></span><br><span class="line"><span class="string">==31554==</span></span><br><span class="line"><span class="string">==31554== Conditional jump or move depends on uninitialised value(s)</span></span><br><span class="line"><span class="string">==31554==    at 0x400852: main (main.cpp:6)</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºä¸­æç¤ºäº†<code>main.cpp</code>æ–‡ä»¶çš„ç¬¬ 6 è¡Œè®¿é—®äº†æœªåˆå§‹åŒ–çš„å†…å­˜ã€‚</p><p>å³å­¦å³ç”¨ä¸€æ³¢ã€<a href="https://leetcode.cn/problems/decode-string/">394. å­—ç¬¦ä¸²è§£ç </a>ã€‘</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">string s;</span><br><span class="line">cin&gt;&gt;s;</span><br><span class="line"><span class="comment">// 3[a2[c]]</span></span><br><span class="line"><span class="type">int</span> len=s.<span class="built_in">size</span>();</span><br><span class="line">deque&lt;string&gt; str;</span><br><span class="line">deque&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">string ans=<span class="string">&quot;&quot;</span>,cur=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="type">int</span> num=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(s[i]&gt;=<span class="string">&#x27;0&#x27;</span>&amp;&amp;s[i]&lt;=<span class="string">&#x27;9&#x27;</span>)&#123;</span><br><span class="line">num=num*<span class="number">10</span>+(<span class="type">int</span>)(s[i]-<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(s[i]==<span class="string">&#x27;[&#x27;</span>)&#123;</span><br><span class="line">q.<span class="built_in">push_back</span>(num);</span><br><span class="line">num=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(cur.<span class="built_in">size</span>()&gt;<span class="number">0</span>) str.<span class="built_in">push_back</span>(cur);</span><br><span class="line">cur=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(s[i]==<span class="string">&#x27;]&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(cur.<span class="built_in">size</span>())</span><br><span class="line">str.<span class="built_in">push_back</span>(cur); </span><br><span class="line">string str_tmp=str.<span class="built_in">back</span>();str.<span class="built_in">pop_back</span>();</span><br><span class="line"><span class="type">int</span> num_tmp=q.<span class="built_in">back</span>();q.<span class="built_in">pop_back</span>();</span><br><span class="line">string res=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;num_tmp;j++)&#123;</span><br><span class="line">res=res+str_tmp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(q.<span class="built_in">size</span>())&#123;</span><br><span class="line">string tmp=<span class="string">&quot;&quot;</span>;</span><br><span class="line">tmp=str.<span class="built_in">back</span>();</span><br><span class="line">str.<span class="built_in">pop_back</span>();</span><br><span class="line">str.<span class="built_in">push_back</span>(tmp+res);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">ans=ans+res;</span><br><span class="line">&#125;</span><br><span class="line">cur=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(q.<span class="built_in">size</span>())&#123;</span><br><span class="line">cur=cur+s[i];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">ans=ans+s[i];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cout&lt;&lt;ans&lt;&lt;endl;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&quot;3[z]2[2[y]pq4[2[jk]e1[f]]]ef&quot;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å†…å­˜æ£€æµ‹å·¥å…·æ£€æµ‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ vim main.<span class="built_in">cpp</span></span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ g++ -g -o main_c main.<span class="built_in">cpp</span></span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ valgrind --tool=memcheck --leak-check=full  ./main_c</span><br><span class="line">==<span class="number">1335995</span>== Memcheck, a memory error detector</span><br><span class="line">==<span class="number">1335995</span>== <span class="built_in">Copyright</span> (C) <span class="number">2002</span><span class="number">-2017</span>, <span class="keyword">and</span> GNU GP<span class="string">L&#x27;d, by Julian Seward et al.</span></span><br><span class="line"><span class="string">==1335995== Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info</span></span><br><span class="line"><span class="string">==1335995== Command: ./main_c</span></span><br><span class="line"><span class="string">==1335995==</span></span><br><span class="line"><span class="string">3[z]2[2[y]pq4[2[jk]e1[f]]]ef</span></span><br><span class="line"><span class="string">==1335995== Use of uninitialised value of size 8</span></span><br><span class="line"><span class="string">==1335995==    at 0x49ACC38: std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;::basic_string(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;) (in /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.28)</span></span><br><span class="line"><span class="string">==1335995==    by 0x10A87C: main (main.cpp:32)</span></span><br><span class="line"><span class="string">==1335995==</span></span><br><span class="line"><span class="string">==1335995== Invalid read of size 8</span></span><br><span class="line"><span class="string">==1335995==    at 0x49ACC38: std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;::basic_string(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;) (in /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.28)</span></span><br><span class="line"><span class="string">==1335995==    by 0x10A87C: main (main.cpp:32)</span></span><br><span class="line"><span class="string">==1335995==  Address 0x1e8 is not stack&#x27;</span>d, malloc<span class="number">&#x27;</span>d <span class="built_in">or</span> (recently) free<span class="number">&#x27;</span>d</span><br><span class="line">==<span class="number">1335995</span>==</span><br><span class="line">==<span class="number">1335995</span>==</span><br><span class="line">==<span class="number">1335995</span>== Process terminating with <span class="keyword">default</span> action of signal <span class="number">11</span> (SIGSEGV): dumping core</span><br><span class="line">==<span class="number">1335995</span>==  Access <span class="keyword">not</span> within mapped region at address <span class="number">0x1E8</span></span><br><span class="line">==<span class="number">1335995</span>==    at <span class="number">0x49ACC38</span>: std::__cxx11::basic_string&lt;<span class="type">char</span>, std::char_traits&lt;<span class="type">char</span>&gt;, std::allocator&lt;<span class="type">char</span>&gt; &gt;::<span class="built_in">basic_string</span>(std::__cxx11::basic_string&lt;<span class="type">char</span>, std::char_traits&lt;<span class="type">char</span>&gt;, std::allocator&lt;<span class="type">char</span>&gt; &gt; <span class="type">const</span>&amp;) (in /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="number">.6</span><span class="number">.0</span><span class="number">.28</span>)</span><br><span class="line">==<span class="number">1335995</span>==    by <span class="number">0x10A87C</span>: <span class="built_in">main</span> (main.cpp:<span class="number">32</span>)</span><br><span class="line">==<span class="number">1335995</span>==  If you believe <span class="keyword">this</span> happened as a result of a stack</span><br><span class="line">==<span class="number">1335995</span>==  overflow in your program<span class="number">&#x27;</span>s main <span class="built_in">thread</span> (unlikely but</span><br><span class="line">==<span class="number">1335995</span>==  possible), you can <span class="keyword">try</span> to increase the size of the</span><br><span class="line">==<span class="number">1335995</span>==  main thread stack <span class="keyword">using</span> the --main-stacksize= flag.</span><br><span class="line">==<span class="number">1335995</span>==  The main thread stack size used in <span class="keyword">this</span> run was <span class="number">8388608.</span></span><br><span class="line">==<span class="number">1335995</span>==</span><br><span class="line">==<span class="number">1335995</span>== HEAP SUMMARY:</span><br><span class="line">==<span class="number">1335995</span>==     in use at exit: <span class="number">1</span>,<span class="number">183</span> bytes in <span class="number">5</span> blocks</span><br><span class="line">==<span class="number">1335995</span>==   total heap usage: <span class="number">7</span> allocs, <span class="number">2</span> frees, <span class="number">74</span>,<span class="number">911</span> bytes allocated</span><br><span class="line">==<span class="number">1335995</span>==</span><br><span class="line">==<span class="number">1335995</span>== LEAK SUMMARY:</span><br><span class="line">==<span class="number">1335995</span>==    definitely lost: <span class="number">0</span> bytes in <span class="number">0</span> blocks</span><br><span class="line">==<span class="number">1335995</span>==    indirectly lost: <span class="number">0</span> bytes in <span class="number">0</span> blocks</span><br><span class="line">==<span class="number">1335995</span>==      possibly lost: <span class="number">0</span> bytes in <span class="number">0</span> blocks</span><br><span class="line">==<span class="number">1335995</span>==    still reachable: <span class="number">1</span>,<span class="number">183</span> bytes in <span class="number">5</span> blocks</span><br><span class="line">==<span class="number">1335995</span>==         suppressed: <span class="number">0</span> bytes in <span class="number">0</span> blocks</span><br><span class="line">==<span class="number">1335995</span>== Reachable <span class="built_in">blocks</span> (those to which a pointer was found) are <span class="keyword">not</span> shown.</span><br><span class="line">==<span class="number">1335995</span>== To see them, rerun with: --leak-check=full --show-leak-kinds=all</span><br><span class="line">==<span class="number">1335995</span>==</span><br><span class="line">==<span class="number">1335995</span>== Use --track-origins=yes to see where uninitialised values come from</span><br><span class="line">==<span class="number">1335995</span>== For lists of detected <span class="keyword">and</span> suppressed errors, rerun with: -s</span><br><span class="line">==<span class="number">1335995</span>== ERROR SUMMARY: <span class="number">2</span> errors from <span class="number">2</span> <span class="built_in">contexts</span> (suppressed: <span class="number">0</span> from <span class="number">0</span>)</span><br><span class="line">æ®µé”™è¯¯</span><br></pre></td></tr></table></figure><p>ä¸€ä¸‹å°±çŸ¥é“ï¼Œé—®é¢˜åœ¨è¿™</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tmp</span><span class="operator">=</span>str.back()<span class="comment">;</span></span><br><span class="line">str.pop_back()<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>å‚è€ƒèµ„æ–™</p><ul><li><a href="https://www.it.uc3m.es/pbasanta/asng/course_notes/memory_profiler_en.html#memcheck_tool">Chapter 17. The memory profiler Valgrind</a></li><li><a href="https://senlinzhan.github.io/2017/12/31/valgrind/">ä½¿ç”¨ Valgrind æ£€æµ‹ C++ å†…å­˜æ³„æ¼</a></li><li><a href="https://zhuanlan.zhihu.com/p/643271982">ã€C/C++ é›†æˆå†…å­˜è°ƒè¯•ã€å†…å­˜æ³„æ¼æ£€æµ‹å’Œæ€§èƒ½åˆ†æçš„å·¥å…· Valgrind ã€‘Linux ä¸‹ Valgrind å·¥å…·çš„å…¨é¢ä½¿ç”¨æŒ‡å—</a></li><li><a href="https://zhuanlan.zhihu.com/p/56538645">å†…å­˜æ£€æµ‹ç‹è€…ä¹‹å‰‘â€”valgrind</a></li></ul>]]></content>
    
    
    <summary type="html">å†…å­˜æ£€æµ‹-Valgrind</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>Cppé¢ç»</title>
    <link href="https://penge666.github.io/posts/680a3d55.html"/>
    <id>https://penge666.github.io/posts/680a3d55.html</id>
    <published>2024-05-13T12:35:09.000Z</published>
    <updated>2024-05-14T02:18:32.392Z</updated>
    
    <content type="html"><![CDATA[<h2 id="C-98"><a href="#C-98" class="headerlink" title="C++98"></a>C++98</h2><h3 id="1-åœ¨mainæ‰§è¡Œçš„å‰åéœ€è¦å¤„ç†ä»€ä¹ˆå·¥ä½œï¼Ÿ"><a href="#1-åœ¨mainæ‰§è¡Œçš„å‰åéœ€è¦å¤„ç†ä»€ä¹ˆå·¥ä½œï¼Ÿ" class="headerlink" title="1. åœ¨mainæ‰§è¡Œçš„å‰åéœ€è¦å¤„ç†ä»€ä¹ˆå·¥ä½œï¼Ÿ"></a>1. åœ¨mainæ‰§è¡Œçš„å‰åéœ€è¦å¤„ç†ä»€ä¹ˆå·¥ä½œï¼Ÿ</h3><p><strong>Mainå‡½æ•°ä¹‹å‰</strong></p><p>(1) è®¾ç½®æ ˆæŒ‡é’ˆ</p><p>(2) å…¨å±€å¯¹è±¡åˆå§‹åŒ–ï¼Œåœ¨mainä¹‹å‰è°ƒç”¨æ„é€ å‡½æ•°</p><p>(3) å°†mainå‡½æ•°çš„å‚æ•°argcï¼Œargvç­‰ä¼ é€’ç»™mainå‡½æ•°</p><p><strong>Mainå‡½æ•°ä¹‹å</strong></p><p>å…¨å±€å¯¹è±¡çš„ææ„å‡½æ•°</p><h3 id="2-ä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Ÿ"><a href="#2-ä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Ÿ" class="headerlink" title="2.ä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Ÿ"></a>2.ä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Ÿ</h3><p>å­¦ä¹ è‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/30007037">C/C++å†…å­˜å¯¹é½è¯¦è§£</a></p><p>è¿˜æ˜¯å¾—çœ‹ä¾‹å­ï¼šã€ä»ä¾‹å­è§£é‡Šæ¦‚å¿µã€‘</p><p>è¿˜æ˜¯ç”¨ä¸€ä¸ªä¾‹å­å¸¦å‡ºè¿™ä¸ªé—®é¢˜ï¼Œçœ‹ä¸‹é¢çš„å°ç¨‹åºï¼Œç†è®ºä¸Šï¼Œ32ä½ç³»ç»Ÿä¸‹ï¼Œintå 4byteï¼Œcharå ä¸€ä¸ªbyteï¼Œé‚£ä¹ˆå°†å®ƒä»¬æ”¾åˆ°ä¸€ä¸ªç»“æ„ä½“ä¸­åº”è¯¥å 4+1=5byteï¼›ä½†æ˜¯å®é™…ä¸Šï¼Œé€šè¿‡è¿è¡Œç¨‹åºå¾—åˆ°çš„ç»“æœæ˜¯8 byteï¼Œè¿™å°±æ˜¯å†…å­˜å¯¹é½æ‰€å¯¼è‡´çš„ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//32ä½ç³»ç»Ÿ</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span>&#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">char</span> y;</span><br><span class="line">&#125;s;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">sizeof</span>(s);  <span class="comment">// è¾“å‡º8</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°ä»£è®¡ç®—æœºä¸­å†…å­˜ç©ºé—´éƒ½æ˜¯æŒ‰ç…§ byte åˆ’åˆ†çš„ï¼Œä»ç†è®ºä¸Šè®²ä¼¼ä¹å¯¹ä»»ä½•ç±»å‹çš„å˜é‡çš„è®¿é—®å¯ä»¥ä»ä»»ä½•åœ°å€å¼€å§‹ï¼Œä½†æ˜¯å®é™…çš„è®¡ç®—æœºç³»ç»Ÿå¯¹åŸºæœ¬ç±»å‹æ•°æ®åœ¨å†…å­˜ä¸­å­˜æ”¾çš„ä½ç½®æœ‰é™åˆ¶ï¼Œå®ƒä»¬ä¼šè¦æ±‚è¿™äº›æ•°æ®çš„é¦–åœ°å€çš„å€¼æ˜¯æŸä¸ªæ•°kï¼ˆé€šå¸¸å®ƒä¸º4æˆ–8ï¼‰çš„å€æ•°ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å†…å­˜å¯¹é½ã€‚</p><p>ç²¾ç®€ï¼š</p><p>(1) åœ¨è®¡ç®—æœºä¸­ï¼Œå†…å­˜æ˜¯æŒ‰å­—èŠ‚åˆ’åˆ†çš„ï¼Œè€ŒCPUåœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„è¯»å–ï¼Œå®é™…ä¸Šæ˜¯<strong>æŒ‰å—çš„å¤§å°è¯»å–</strong>ï¼Œå—å¤§å°å¯ä»¥æ˜¯2ï¼Œ4ï¼Œ8ï¼Œ16ç­‰ç­‰ï¼Œç§°ä¸ºå†…å­˜è®¿é—®ç²’åº¦ã€‚</p><p>(2) å†…å­˜å¯¹é½åˆ™æ˜¯å°†ç‰¹å®šçš„æ•°æ®ç±»å‹æŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ‘†æ”¾åœ¨å†…å­˜ä¸Šï¼Œå…·ä½“è§„åˆ™æ˜¯æŒ‰ç…§å˜é‡çš„å£°æ˜é¡ºåºï¼Œä¾æ¬¡å®‰æ’å†…å­˜ï¼Œå…¶åç§»é‡ä¸ºå˜é‡å¤§å°çš„æ•´æ•°å€ã€‚</p><h3 id="3-ä¸ºä»€ä¹ˆè¦åšå†…å­˜å¯¹é½ï¼Ÿ"><a href="#3-ä¸ºä»€ä¹ˆè¦åšå†…å­˜å¯¹é½ï¼Ÿ" class="headerlink" title="3. ä¸ºä»€ä¹ˆè¦åšå†…å­˜å¯¹é½ï¼Ÿ"></a>3. ä¸ºä»€ä¹ˆè¦åšå†…å­˜å¯¹é½ï¼Ÿ</h3><p>è¿™ä¸ªçš„è¯å±•å¼€è¯´å°±æ˜¯ï¼š</p><p>å°½ç®¡å†…å­˜æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†å¤„ç†å™¨å¹¶ä¸æ˜¯æŒ‰å­—èŠ‚å—æ¥å­˜å–å†…å­˜çš„.å®ƒä¸€èˆ¬ä¼šä»¥åŒå­—èŠ‚,å››å­—èŠ‚,8å­—èŠ‚,16å­—èŠ‚ç”šè‡³32å­—èŠ‚ä¸ºå•ä½æ¥å­˜å–å†…å­˜ï¼Œæˆ‘ä»¬å°†ä¸Šè¿°è¿™äº›å­˜å–å•ä½ç§°ä¸ºå†…å­˜å­˜å–ç²’åº¦.</p><p>ç°åœ¨è€ƒè™‘4å­—èŠ‚å­˜å–ç²’åº¦çš„å¤„ç†å™¨å–intç±»å‹å˜é‡ï¼ˆ32ä½ç³»ç»Ÿï¼‰ï¼Œè¯¥å¤„ç†å™¨åªèƒ½ä»åœ°å€ä¸º4çš„å€æ•°çš„å†…å­˜å¼€å§‹è¯»å–æ•°æ®ã€‚</p><p>å‡å¦‚æ²¡æœ‰å†…å­˜å¯¹é½æœºåˆ¶ï¼Œæ•°æ®å¯ä»¥ä»»æ„å­˜æ”¾ï¼Œç°åœ¨ä¸€ä¸ªintå˜é‡å­˜æ”¾åœ¨ä»åœ°å€1å¼€å§‹çš„è”ç³»å››ä¸ªå­—èŠ‚åœ°å€ä¸­ï¼Œè¯¥å¤„ç†å™¨å»å–æ•°æ®æ—¶ï¼Œè¦å…ˆä»0åœ°å€å¼€å§‹è¯»å–ç¬¬ä¸€ä¸ª4å­—èŠ‚å—,å‰”é™¤ä¸æƒ³è¦çš„å­—èŠ‚ï¼ˆ0åœ°å€ï¼‰,ç„¶åä»åœ°å€4å¼€å§‹è¯»å–ä¸‹ä¸€ä¸ª4å­—èŠ‚å—,åŒæ ·å‰”é™¤ä¸è¦çš„æ•°æ®ï¼ˆ5ï¼Œ6ï¼Œ7åœ°å€ï¼‰,æœ€åç•™ä¸‹çš„ä¸¤å—æ•°æ®åˆå¹¶æ”¾å…¥å¯„å­˜å™¨.è¿™éœ€è¦åšå¾ˆå¤šå·¥ä½œ.</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240513204345153.png" alt="image-20240513204345153"></p><p>ç°åœ¨æœ‰äº†å†…å­˜å¯¹é½çš„ï¼Œintç±»å‹æ•°æ®åªèƒ½å­˜æ”¾åœ¨æŒ‰ç…§å¯¹é½è§„åˆ™çš„å†…å­˜ä¸­ï¼Œæ¯”å¦‚è¯´0åœ°å€å¼€å§‹çš„å†…å­˜ã€‚é‚£ä¹ˆç°åœ¨è¯¥å¤„ç†å™¨åœ¨å–æ•°æ®æ—¶ä¸€æ¬¡æ€§å°±èƒ½å°†æ•°æ®è¯»å‡ºæ¥äº†ï¼Œè€Œä¸”ä¸éœ€è¦åšé¢å¤–çš„æ“ä½œï¼Œæé«˜äº†æ•ˆç‡ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240513204405396.png" alt="image-20240513204405396"></p><p>ç²¾ç®€ï¼š</p><p>(1) <strong>å¹³å°åŸå› (ç§»æ¤åŸå› )ï¼š</strong>ä¸æ˜¯æ‰€æœ‰çš„ç¡¬ä»¶å¹³å°éƒ½èƒ½è®¿é—®ä»»æ„åœ°å€ä¸Šçš„ä»»æ„æ•°æ®çš„ï¼›æŸäº›ç¡¬ä»¶å¹³å°åªèƒ½åœ¨æŸäº›åœ°å€å¤„å–æŸäº›ç‰¹å®šç±»å‹çš„æ•°æ®ï¼Œå¦åˆ™æŠ›å‡ºç¡¬ä»¶å¼‚å¸¸ã€‚</p><p>(2) <strong>æ€§èƒ½åŸå› ï¼š</strong>æ•°æ®ç»“æ„(å°¤å…¶æ˜¯æ ˆ)åº”è¯¥å°½å¯èƒ½åœ°åœ¨è‡ªç„¶è¾¹ç•Œä¸Šå¯¹é½ã€‚åŸå› åœ¨äºï¼Œä¸ºäº†è®¿é—®æœªå¯¹é½çš„å†…å­˜ï¼Œå¤„ç†å™¨éœ€è¦ä½œä¸¤æ¬¡å†…å­˜è®¿é—®ï¼›è€Œå¯¹é½çš„å†…å­˜è®¿é—®ä»…éœ€è¦ä¸€æ¬¡è®¿é—®ã€‚</p><h3 id="4-è¯´è¯´å†…å­˜å¯¹é½è§„åˆ™ï¼Ÿ"><a href="#4-è¯´è¯´å†…å­˜å¯¹é½è§„åˆ™ï¼Ÿ" class="headerlink" title="4. è¯´è¯´å†…å­˜å¯¹é½è§„åˆ™ï¼Ÿ"></a>4. è¯´è¯´å†…å­˜å¯¹é½è§„åˆ™ï¼Ÿ</h3><p>æ¯ä¸ªç‰¹å®šå¹³å°ä¸Šçš„ç¼–è¯‘å™¨éƒ½æœ‰è‡ªå·±çš„é»˜è®¤â€œå¯¹é½ç³»æ•°â€ï¼ˆä¹Ÿå«å¯¹é½æ¨¡æ•°ï¼‰ã€‚gccä¸­é»˜è®¤#pragma pack(4)ï¼Œå¯ä»¥é€šè¿‡é¢„ç¼–è¯‘å‘½ä»¤#pragma pack(n)ï¼Œn = 1,2,4,8,16æ¥æ”¹å˜è¿™ä¸€ç³»æ•°ã€‚</p><p>æœ‰æ•ˆå¯¹å…¶å€¼ï¼šæ˜¯ç»™å®šå€¼#pragma pack(n)å’Œç»“æ„ä½“ä¸­æœ€é•¿æ•°æ®ç±»å‹é•¿åº¦ä¸­è¾ƒå°çš„é‚£ä¸ªã€‚æœ‰æ•ˆå¯¹é½å€¼ä¹Ÿå«<strong>å¯¹é½å•ä½</strong>ã€‚</p><p>äº†è§£äº†ä¸Šé¢çš„æ¦‚å¿µåï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ¥çœ‹çœ‹å†…å­˜å¯¹é½éœ€è¦éµå¾ªçš„è§„åˆ™ï¼š</p><p>(1) ç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜çš„<strong>åç§»é‡ï¼ˆoffsetï¼‰</strong>ä¸º0ï¼Œä»¥åæ¯ä¸ªæˆå‘˜ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„ offset éƒ½æ˜¯<strong>è¯¥æˆå‘˜å¤§å°ä¸æœ‰æ•ˆå¯¹é½å€¼ä¸­è¾ƒå°é‚£ä¸ª</strong>çš„æ•´æ•°å€ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æˆå‘˜ä¹‹é—´åŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</p><p>(3) <strong>ç»“æ„ä½“çš„æ€»å¤§å°</strong>ä¸º æœ‰æ•ˆå¯¹é½å€¼ çš„<strong>æ•´æ•°å€</strong>ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æœ€æœ«ä¸€ä¸ªæˆå‘˜ä¹‹ååŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</p><p>ä¸‹é¢ç»™å‡ºå‡ ä¸ªä¾‹å­ä»¥ä¾¿äºç†è§£ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//32ä½ç³»ç»Ÿ</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;    </span><br><span class="line">    <span class="type">char</span> c1;  </span><br><span class="line">    <span class="type">char</span> c2;  </span><br><span class="line">&#125;x1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span>&#123;</span><br><span class="line">    <span class="type">char</span> c1;  </span><br><span class="line">    <span class="type">int</span> i;    </span><br><span class="line">    <span class="type">char</span> c2;  </span><br><span class="line">&#125;x2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span>&#123;</span><br><span class="line">    <span class="type">char</span> c1;  </span><br><span class="line">    <span class="type">char</span> c2; </span><br><span class="line">    <span class="type">int</span> i;    </span><br><span class="line">&#125;x3;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">sizeof</span>(x1));  <span class="comment">// è¾“å‡º8</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">sizeof</span>(x2));  <span class="comment">// è¾“å‡º12</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">sizeof</span>(x3));  <span class="comment">// è¾“å‡º8</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæµ‹è¯•éƒ½æ˜¯åœ¨Linuxç¯å¢ƒä¸‹è¿›è¡Œçš„ï¼Œlinuxä¸‹é»˜è®¤#pragma pack(4)ï¼Œä¸”ç»“æ„ä½“ä¸­æœ€é•¿çš„æ•°æ®ç±»å‹ä¸º4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æœ‰æ•ˆå¯¹é½å•ä½ä¸º4å­—èŠ‚ï¼Œä¸‹é¢æ ¹æ®ä¸Šé¢æ‰€è¯´çš„è§„åˆ™ä»¥s2æ¥åˆ†æå…¶å†…å­˜å¸ƒå±€ï¼š</p><p>é¦–å…ˆä½¿ç”¨è§„åˆ™1ï¼Œå¯¹æˆå‘˜å˜é‡è¿›è¡Œå¯¹é½ï¼š</p><p>sizeof(c1) = 1 &lt;= 4(æœ‰æ•ˆå¯¹é½ä½)ï¼ŒæŒ‰ç…§1å­—èŠ‚å¯¹é½ï¼Œå ç”¨ç¬¬0å•å…ƒï¼›</p><p>sizeof(i) = 4 &lt;= 4(æœ‰æ•ˆå¯¹é½ä½)ï¼Œç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„åç§»è¦ä¸º4çš„å€æ•°ï¼Œå ç”¨ç¬¬4ï¼Œ5ï¼Œ6ï¼Œ7å•å…ƒï¼›</p><p>sizeof(c2) = 1 &lt;= 4(æœ‰æ•ˆå¯¹é½ä½)ï¼Œç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„åç§»è¦ä¸º1çš„å€æ•°ï¼Œå ç”¨ç¬¬8å•å…ƒï¼›</p><p>ç„¶åä½¿ç”¨è§„åˆ™2ï¼Œå¯¹ç»“æ„ä½“æ•´ä½“è¿›è¡Œå¯¹é½ï¼š</p><p>s2ä¸­å˜é‡iå ç”¨å†…å­˜æœ€å¤§å 4å­—èŠ‚ï¼Œè€Œæœ‰æ•ˆå¯¹é½å•ä½ä¹Ÿä¸º4å­—èŠ‚ï¼Œä¸¤è€…è¾ƒå°å€¼å°±æ˜¯4å­—èŠ‚ã€‚å› æ­¤æ•´ä½“ä¹Ÿæ˜¯æŒ‰ç…§4å­—èŠ‚å¯¹é½ã€‚ç”±è§„åˆ™1å¾—åˆ°s2å 9ä¸ªå­—èŠ‚ï¼Œæ­¤å¤„å†æŒ‰ç…§è§„åˆ™2è¿›è¡Œæ•´ä½“çš„4å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥æ•´ä¸ªç»“æ„ä½“å ç”¨12ä¸ªå­—èŠ‚ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œä¸éš¾å¾—å‡ºä¸Šé¢ä¾‹å­ä¸‰ä¸ªç»“æ„ä½“çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240513204725927.png" alt="image-20240513204725927"></p><p><strong>#pragma pack(n)</strong></p><p>ä¸åŒå¹³å°ä¸Šç¼–è¯‘å™¨çš„ pragma pack é»˜è®¤å€¼ä¸åŒã€‚è€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é¢„ç¼–è¯‘å‘½ä»¤#pragma pack(n), n= 1,2,4,8,16æ¥æ”¹å˜å¯¹é½ç³»æ•°ã€‚</p><p>ä¾‹å¦‚ï¼Œå¯¹äºä¸Šä¸ªä¾‹å­çš„ä¸‰ä¸ªç»“æ„ä½“ï¼Œå¦‚æœå‰é¢åŠ ä¸Š#pragma pack(1)ï¼Œé‚£ä¹ˆæ­¤æ—¶æœ‰æ•ˆå¯¹é½å€¼ä¸º1å­—èŠ‚ï¼Œæ­¤æ—¶æ ¹æ®å¯¹é½è§„åˆ™ï¼Œä¸éš¾çœ‹å‡ºæˆå‘˜æ˜¯è¿ç»­å­˜æ”¾çš„ï¼Œä¸‰ä¸ªç»“æ„ä½“çš„å¤§å°éƒ½æ˜¯6å­—èŠ‚ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240513204744215.png" alt="image-20240513204744215"></p><p>å¦‚æœå‰é¢åŠ ä¸Š#pragma pack(2)ï¼Œæœ‰æ•ˆå¯¹é½å€¼ä¸º2å­—èŠ‚ï¼Œæ­¤æ—¶æ ¹æ®å¯¹é½è§„åˆ™ï¼Œä¸‰ä¸ªç»“æ„ä½“çš„å¤§å°åº”ä¸º6,8,6ã€‚å†…å­˜åˆ†å¸ƒå›¾å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240513204752271.png" alt="image-20240513204752271"></p><p>ç»è¿‡ä¸Šé¢çš„å®ä¾‹åˆ†æï¼Œå¤§å®¶åº”è¯¥å¯¹å†…å­˜å¯¹é½æœ‰äº†å…¨é¢çš„è®¤è¯†å’Œäº†è§£ï¼Œåœ¨ä»¥åçš„ç¼–ç ä¸­å®šä¹‰ç»“æ„ä½“æ—¶éœ€è¦è€ƒè™‘æˆå‘˜å˜é‡å®šä¹‰çš„å…ˆåé¡ºåºäº†ã€‚</p><p>ç²¾ç®€ï¼š</p><p>(1) æ¯ä¸ªç‰¹å®šå¹³å°ä¸Šçš„ç¼–è¯‘å™¨éƒ½æœ‰è‡ªå·±çš„é»˜è®¤<strong>â€œå¯¹é½ç³»æ•°â€ï¼ˆä¹Ÿå«å¯¹é½æ¨¡æ•°ï¼‰</strong>ã€‚32ä½ç³»ç»Ÿï¼Œgccä¸­é»˜è®¤#pragma pack(4)ï¼Œå³å¯¹é½ç³»æ•°é»˜è®¤ä¸º4ã€‚å¯ä»¥é€šè¿‡é¢„ç¼–è¯‘å‘½ä»¤#pragma pack(n)ï¼Œn = 1,2,4,8,16æ¥æ”¹å˜è¿™ä¸€ç³»æ•°ã€‚</p><p>(2) æœ‰æ•ˆå¯¹é½å€¼ï¼šæ˜¯ç»™å®šå€¼#pragma pack(n)å’Œç»“æ„ä½“ä¸­æœ€é•¿æ•°æ®ç±»å‹é•¿åº¦ä¸­<strong>è¾ƒå°</strong>çš„é‚£ä¸ªã€‚<strong>æœ‰æ•ˆå¯¹é½å€¼ä¹Ÿå«å¯¹é½å•ä½</strong>ã€‚</p><p>(3) ç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜çš„åç§»é‡ä¸º0ï¼Œä»¥åæ¯ä¸ªæˆå‘˜ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„åç§»é‡éƒ½æ˜¯è¯¥æˆå‘˜å¤§å°ä¸æœ‰æ•ˆå¯¹é½å€¼ä¸­<strong>è¾ƒå°</strong>æ•°çš„æ•´æ•°å€ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æˆå‘˜ä¹‹é—´åŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</p><p>(4) ç»“æ„ä½“çš„æ€»å¤§å°ä¸º<strong>æœ‰æ•ˆå¯¹é½å€¼çš„æ•´æ•°å€</strong>ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æœ€æœ«ä¸€ä¸ªæˆå‘˜ä¹‹ååŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</p><h3 id="5-æŒ‡é’ˆå’Œå¼•ç”¨çš„åŒºåˆ«ï¼Ÿ"><a href="#5-æŒ‡é’ˆå’Œå¼•ç”¨çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="5. æŒ‡é’ˆå’Œå¼•ç”¨çš„åŒºåˆ«ï¼Ÿ"></a>5. æŒ‡é’ˆå’Œå¼•ç”¨çš„åŒºåˆ«ï¼Ÿ</h3><p>(1) æŒ‡é’ˆæ˜¯ä¸€ä¸ªå˜é‡ï¼Œå­˜å‚¨çš„æ˜¯ä¸€ä¸ªåœ°å€ã€‚å¼•ç”¨è·ŸåŸæ¥çš„å˜é‡å®è´¨ä¸Šæ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œæ˜¯åŸå˜é‡çš„åˆ«å</p><p>(2) æŒ‡é’ˆå¯ä»¥æœ‰å¤šçº§ï¼Œå¼•ç”¨åªæœ‰ä¸€çº§</p><p>(3) æŒ‡é’ˆå¯ä»¥ä¸ºç©ºï¼Œå¼•ç”¨ä¸èƒ½ä¸ºNULLä¸”åœ¨å®šä¹‰æ—¶å¿…é¡»åˆå§‹åŒ–</p><p>(4) æŒ‡é’ˆåœ¨åˆå§‹åŒ–åå¯ä»¥æ”¹å˜æŒ‡å‘ï¼Œè€Œå¼•ç”¨åœ¨åˆå§‹åŒ–ä¹‹åä¸å¯å†æ”¹å˜</p><p>(5) sizeofæŒ‡é’ˆå¾—åˆ°çš„æ˜¯æœ¬æŒ‡é’ˆçš„å¤§å°ï¼Œsizeofå¼•ç”¨å¾—åˆ°çš„æ˜¯å¼•ç”¨æ‰€æŒ‡å‘å˜é‡çš„å¤§å°</p><ul><li><a href="https://zhuanlan.zhihu.com/p/140966943">C++ä¸­æŒ‡é’ˆä¸å¼•ç”¨çš„åŒºåˆ«</a></li></ul><h3 id="6-å †å’Œæ ˆçš„åŒºåˆ«ï¼Ÿ"><a href="#6-å †å’Œæ ˆçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="6. å †å’Œæ ˆçš„åŒºåˆ«ï¼Ÿ"></a>6. å †å’Œæ ˆçš„åŒºåˆ«ï¼Ÿ</h3><p>(1) æ ˆç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ï¼Œå †æ˜¯è‡ªå·±ç”³è¯·å’Œé‡Šæ”¾çš„ã€‚</p><p>(2) å †å‘ä¸Šï¼Œå‘é«˜åœ°å€æ–¹å‘å¢é•¿ã€‚æ ˆå‘ä¸‹ï¼Œå‘ä½åœ°å€æ–¹å‘å¢é•¿ã€‚</p><p>(3) åœ¨ç©ºé—´è¿ç»­æ€§ä¸Šï¼Œæ ˆåŒºçš„ç©ºé—´æ˜¯è¿ç»­çš„ï¼›ä½†å †çš„ç©ºé—´æ˜¯ä¸è¿ç»­çš„ã€‚</p><p>(4) å †åªèƒ½åŠ¨æ€åˆ†é…ã€‚æ ˆæœ‰é™æ€åˆ†é…å’ŒåŠ¨æ€åˆ†é…ï¼Œé™æ€åˆ†é…ç”±ç¼–è¯‘å™¨å®Œæˆï¼ŒåŠ¨æ€åˆ†é…ç”±allocaå‡½æ•°åˆ†é…ï¼Œä½†æ ˆçš„åŠ¨æ€åˆ†é…çš„èµ„æºç”±ç¼–è¯‘å™¨è¿›è¡Œé‡Šæ”¾ï¼Œæ— éœ€ç¨‹åºå‘˜å®ç°ã€‚</p><p>(5) å› ä¸ºæ“ä½œç³»ç»Ÿä¼šåœ¨åº•å±‚å¯¹æ ˆæä¾›æ”¯æŒï¼Œä¼šåˆ†é…ä¸“é—¨çš„å¯„å­˜å™¨å­˜æ”¾æ ˆçš„åœ°å€ï¼Œæ ˆçš„å…¥æ ˆå‡ºæ ˆæ“ä½œä¹Ÿååˆ†ç®€å•ï¼Œå¹¶ä¸”æœ‰ä¸“é—¨çš„æŒ‡ä»¤æ‰§è¡Œï¼Œæ‰€ä»¥æ ˆçš„æ•ˆç‡æ¯”è¾ƒé«˜ä¹Ÿæ¯”è¾ƒå¿«ã€‚</p><p>(6) å †çš„æ“ä½œæ˜¯ç”±C/C++å‡½æ•°åº“æä¾›çš„ï¼Œåœ¨åˆ†é…å †å†…å­˜çš„æ—¶å€™éœ€è¦ä¸€å®šçš„ç®—æ³•å¯»æ‰¾åˆé€‚å¤§å°çš„å†…å­˜ã€‚å¹¶ä¸”è·å–å †çš„å†…å®¹éœ€è¦ä¸¤æ¬¡è®¿é—®ï¼Œç¬¬ä¸€æ¬¡è®¿é—®æŒ‡é’ˆï¼Œç¬¬äºŒæ¬¡æ ¹æ®æŒ‡é’ˆä¿å­˜çš„åœ°å€è®¿é—®å†…å­˜ï¼Œå› æ­¤å †æ¯”è¾ƒæ…¢ã€‚</p><h3 id="7-new-delete-ä¸-malloc-freeçš„å¼‚åŒï¼Ÿ"><a href="#7-new-delete-ä¸-malloc-freeçš„å¼‚åŒï¼Ÿ" class="headerlink" title="7. new / delete ä¸ malloc / freeçš„å¼‚åŒï¼Ÿ"></a>7. new / delete ä¸ malloc / freeçš„å¼‚åŒï¼Ÿ</h3><p>(1) éƒ½å¯ç”¨äºå†…å­˜çš„åŠ¨æ€ç”³è¯·å’Œé‡Šæ”¾</p><p>(2) å‰è€…æ˜¯C++è¿ç®—ç¬¦ï¼Œåè€…æ˜¯C/C++è¯­è¨€æ ‡å‡†åº“å‡½æ•°</p><p>(3) newè‡ªåŠ¨è®¡ç®—è¦åˆ†é…çš„ç©ºé—´å¤§å°ï¼Œmallocéœ€è¦æ‰‹å·¥è®¡ç®—</p><p>(4) newæ˜¯ç±»å‹å®‰å…¨çš„ï¼Œmallocä¸æ˜¯ã€‚</p><p>(5) newçš„å®ç°è¿‡ç¨‹æ˜¯ï¼šé¦–å…ˆè°ƒç”¨åä¸ºoperator newçš„æ ‡å‡†åº“å‡½æ•°ï¼Œåˆ†é…è¶³å¤Ÿå¤§çš„åŸå§‹ç±»å‹çš„å†…å­˜ï¼Œæ¥ä¸‹æ¥åœ¨è¯¥å†…å­˜ä¸Šè°ƒç”¨æ„é€ å‡½æ•°åˆå§‹åŒ–å¯¹è±¡ï¼›æœ€åè¿”å›è¯¥å†…å­˜æŒ‡é’ˆã€‚</p><p>(6) deleteçš„å®ç°è¿‡ç¨‹ï¼šå¯¹æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡è¿è¡Œé€‚å½“çš„ææ„å‡½æ•°ï¼›ç„¶åé€šè¿‡è°ƒç”¨åä¸ºoperator deleteçš„æ ‡å‡†åº“å‡½æ•°é‡Šæ”¾è¯¥å¯¹è±¡æ‰€ç”¨å†…å­˜</p><p>(7) malloc/freeå¯é‡è½½ï¼Œnew/deleteä¸å¯é‡è½½ï¼Œoperator new/operator deleteå¯é‡è½½</p><h3 id="8-è¢«freeå›æ”¶çš„å†…å­˜æ˜¯ç«‹å³è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿå—ï¼Ÿ"><a href="#8-è¢«freeå›æ”¶çš„å†…å­˜æ˜¯ç«‹å³è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿå—ï¼Ÿ" class="headerlink" title="8. è¢«freeå›æ”¶çš„å†…å­˜æ˜¯ç«‹å³è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿå—ï¼Ÿ"></a>8. è¢«freeå›æ”¶çš„å†…å­˜æ˜¯ç«‹å³è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿå—ï¼Ÿ</h3><p>ä¸ä¼šï¼Œnewæˆ–è€…mallocç”³è¯·å†…å­˜æ˜¯å‘å†…å­˜ç®¡ç†å™¨ç”³è¯·ï¼Œå†…å­˜ç®¡ç†å™¨å†å‘æ“ä½œç³»ç»Ÿç”³è¯·ï¼Œè¿™é‡Œé¢æ¶‰åŠåˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœé¢‘ç¹çš„ç”³è¯·é‡Šæ”¾ï¼Œæ•ˆç‡ä¼šå¾ˆä½ï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹ç”³è¯·äº†å†…å­˜åï¼Œé‡Šæ”¾èµ„æºåå¹¶ä¸ä¼šç«‹å³å°†å†…å­˜è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè€Œæ˜¯æ”¾åˆ°ä¸€ä¸ªç±»ä¼¼äºå†…å­˜ç¼“å­˜æ± çš„åœ°æ–¹ï¼Œä¸‹æ¬¡ç”³è¯·çš„æ—¶å€™é¦–å…ˆä¼šåœ¨å†…å­˜ç¼“å­˜æ± ä¸­æŸ¥æ‰¾åˆé€‚çš„å†…å­˜ï¼Œå‡å°‘äº†å¤§é‡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæé«˜é€Ÿåº¦ã€‚</p><h3 id="9-å®å‡½æ•°å’Œæ™®é€šå‡½æ•°æœ‰ä½•åŒºåˆ«ï¼Ÿ"><a href="#9-å®å‡½æ•°å’Œæ™®é€šå‡½æ•°æœ‰ä½•åŒºåˆ«ï¼Ÿ" class="headerlink" title="9. å®å‡½æ•°å’Œæ™®é€šå‡½æ•°æœ‰ä½•åŒºåˆ«ï¼Ÿ"></a>9. å®å‡½æ•°å’Œæ™®é€šå‡½æ•°æœ‰ä½•åŒºåˆ«ï¼Ÿ</h3><p>(1) å®å‡½æ•°ä½œç”¨åœ¨é¢„ç¼–è¯‘æœŸï¼Œè¿›è¡Œæ–‡æœ¬æ›¿æ¢ï¼Œç›¸å½“äºç›´æ¥æ’å…¥äº†ä»£ç ï¼Œè¿è¡Œæ—¶ä¸å­˜åœ¨å‡½æ•°è°ƒç”¨ï¼Œæ‰§è¡Œèµ·æ¥æ›´å¿«ï¼›æ™®é€šå‡½æ•°è°ƒç”¨åœ¨è¿è¡Œæ—¶éœ€è¦è·³è½¬åˆ°å…·ä½“è°ƒç”¨å‡½æ•°ã€‚</p><p>(2) å®å‡½æ•°å±äºåœ¨ç»“æ„ä¸­æ’å…¥ä»£ç ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼›æ™®é€šå‡½æ•°è°ƒç”¨å…·æœ‰è¿”å›å€¼ã€‚</p><p>(3) å®å‡½æ•°å‚æ•°æ²¡æœ‰ç±»å‹ï¼Œä¸è¿›è¡Œç±»å‹æ£€æŸ¥ï¼›æ™®é€šå‡½æ•°å‚æ•°å…·æœ‰ç±»å‹ï¼Œéœ€è¦æ£€æŸ¥ç±»å‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®å®šä¹‰ï¼Œæ²¡æœ‰ç±»å‹æ£€æŸ¥</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SQUARE(x) ((x) * (x))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°å®šä¹‰ï¼Œæœ‰ç±»å‹æ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">square</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">double</span> y = <span class="number">1.5</span>;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨å®ï¼Œè™½ç„¶yçš„ç±»å‹ä¸æ˜¯æ•´æ•°ï¼Œä½†ä»ç„¶å¯ä»¥è®¡ç®—</span></span><br><span class="line">    <span class="type">double</span> r1 = <span class="built_in">SQUARE</span>(y);  <span class="comment">// ç»“æœæ˜¯2.25</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨å‡½æ•°ï¼Œå¦‚æœå°è¯•å°†yä½œä¸ºå‚æ•°ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸ºyçš„ç±»å‹ä¸å‡½æ•°æœŸæœ›çš„ç±»å‹ä¸åŒ¹é…</span></span><br><span class="line">    <span class="type">int</span> r2 = <span class="built_in">square</span>(y);  <span class="comment">// ç¼–è¯‘é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>SQUARE(x)</code>æ˜¯ä¸€ä¸ªå®ï¼Œå®ƒæ¥å—ä»»ä½•ç±»å‹çš„å‚æ•°<code>x</code>ï¼Œå¹¶è¿”å›<code>x</code>çš„å¹³æ–¹ã€‚å› ä¸ºå®æ²¡æœ‰ç±»å‹æ£€æŸ¥ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä¼ é€’ä»»ä½•ç±»å‹çš„å‚æ•°ç»™å®ï¼Œç¼–è¯‘å™¨ä¸ä¼šæŠ¥é”™ã€‚</p><p>ä½†æ˜¯ï¼Œ<code>square(x)</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæœŸæœ›ä¸€ä¸ªæ•´æ•°ç±»å‹çš„å‚æ•°<code>x</code>ã€‚å¦‚æœä½ å°è¯•å°†ä¸€ä¸ªéæ•´æ•°ç±»å‹çš„å€¼ï¼ˆå¦‚<code>double</code>ç±»å‹çš„å€¼ï¼‰ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸ºå‡½æ•°å‚æ•°çš„ç±»å‹æ£€æŸ¥å¤±è´¥ã€‚</p><h3 id="10-å®å®šä¹‰å’Œtypedefæœ‰ä½•åŒºåˆ«ï¼Ÿ"><a href="#10-å®å®šä¹‰å’Œtypedefæœ‰ä½•åŒºåˆ«ï¼Ÿ" class="headerlink" title="10. å®å®šä¹‰å’Œtypedefæœ‰ä½•åŒºåˆ«ï¼Ÿ"></a>10. å®å®šä¹‰å’Œtypedefæœ‰ä½•åŒºåˆ«ï¼Ÿ</h3><p>(1) å®ä¸»è¦ç”¨äºå®šä¹‰å¸¸é‡åŠä¹¦å†™å¤æ‚çš„å†…å®¹ï¼›typedefä¸»è¦ç”¨äºå®šä¹‰ç±»å‹åˆ«åã€‚</p><p>(2) å®æ›¿æ¢å‘ç”Ÿåœ¨é¢„ç¼–è¯‘æœŸï¼Œå±äºæ–‡æœ¬æ’å…¥æ›¿æ¢ï¼›typedefæ˜¯ç¼–è¯‘çš„ä¸€éƒ¨åˆ†ã€‚</p><p>(3) å®ä¸æ£€æŸ¥ç±»å‹ï¼›typedefä¼šæ£€æŸ¥æ•°æ®ç±»å‹ã€‚</p><h3 id="11-å®å®šä¹‰å’Œconstçš„åŒºåˆ«ï¼Ÿ"><a href="#11-å®å®šä¹‰å’Œconstçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="11. å®å®šä¹‰å’Œconstçš„åŒºåˆ«ï¼Ÿ"></a>11. å®å®šä¹‰å’Œconstçš„åŒºåˆ«ï¼Ÿ</h3><p>(1) å®å®šä¹‰å‘ç”Ÿåœ¨é¢„ç¼–è¯‘æœŸã€‚constæ˜¯åœ¨ç¼–è¯‘ã€è¿è¡Œçš„æ—¶å€™èµ·ä½œç”¨</p><p>(2) å®å®šä¹‰åªåšæ›¿æ¢ï¼Œä¸åšç±»å‹æ£€æŸ¥å’Œè®¡ç®—ã€‚constå¸¸é‡æœ‰æ•°æ®ç±»å‹ï¼Œç¼–è¯‘å™¨åšç±»å‹æ£€æŸ¥ã€‚</p><p>(3) defineåªæ˜¯å°†å®åç§°è¿›è¡Œæ–‡æœ¬æ›¿æ¢ï¼Œå ç”¨ä»£ç æ®µå†…å­˜ã€‚conståœ¨ç¨‹åºè¿è¡Œä¸­åªæœ‰ä¸€ä»½å¤‡ä»½ï¼Œå ç”¨æ•°æ®æ®µå†…å­˜ã€‚</p><h3 id="12-å†…è”å‡½æ•°å’Œå®å‡½æ•°çš„åŒºåˆ«ï¼Ÿ"><a href="#12-å†…è”å‡½æ•°å’Œå®å‡½æ•°çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="12. å†…è”å‡½æ•°å’Œå®å‡½æ•°çš„åŒºåˆ«ï¼Ÿ"></a>12. å†…è”å‡½æ•°å’Œå®å‡½æ•°çš„åŒºåˆ«ï¼Ÿ</h3><p>(1) å®å‡½æ•°åœ¨é¢„å¤„ç†é˜¶æ®µè¿›è¡Œæ–‡æœ¬æ›¿æ¢ï¼Œinlineå‡½æ•°åœ¨ç¼–è¯‘é˜¶æ®µè¿›è¡Œæ›¿æ¢</p><p>(2) inlineå‡½æ•°æœ‰ç±»å‹æ£€æŸ¥ï¼Œç›¸æ¯”å®å‡½æ•°æ¯”è¾ƒå®‰å…¨</p><p>(3) Inlineå‡½æ•°å…·æœ‰è¿”å›å€¼ï¼Œå®å‡½æ•°æ²¡æœ‰</p><h3 id="13-å˜é‡å£°æ˜å’Œå®šä¹‰çš„åŒºåˆ«ï¼Ÿ"><a href="#13-å˜é‡å£°æ˜å’Œå®šä¹‰çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="13. å˜é‡å£°æ˜å’Œå®šä¹‰çš„åŒºåˆ«ï¼Ÿ"></a>13. å˜é‡å£°æ˜å’Œå®šä¹‰çš„åŒºåˆ«ï¼Ÿ</h3><p>å£°æ˜ä»…ä»…æ˜¯æŠŠå˜é‡çš„å£°æ˜çš„ä½ç½®åŠç±»å‹æä¾›ç»™ç¼–è¯‘å™¨ï¼Œå¹¶ä¸åˆ†é…å†…å­˜ç©ºé—´ã€‚åªæœ‰åœ¨å®šä¹‰å¤„æ‰ä¸ºå…¶åˆ†é…å­˜å‚¨ç©ºé—´ã€‚<strong>ç›¸åŒå˜é‡å¯ä»¥åœ¨å¤šå¤„å£°æ˜ï¼Œä½†åªèƒ½åœ¨ä¸€å¤„å®šä¹‰</strong>ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜ä¸€ä¸ªå˜é‡</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> a;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªå˜é‡</span></span><br><span class="line"><span class="type">int</span> a = <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>isOK!</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> a;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> a;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-strlenå’Œsizeofçš„åŒºåˆ«ï¼Ÿ"><a href="#14-strlenå’Œsizeofçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="14. strlenå’Œsizeofçš„åŒºåˆ«ï¼Ÿ"></a>14. strlenå’Œsizeofçš„åŒºåˆ«ï¼Ÿ</h3><p>(1) sizeofæ˜¯C/C++æ“ä½œç¬¦ï¼Œå¹¶ä¸æ˜¯å‡½æ•°ï¼Œç»“æœåœ¨ç¼–è¯‘æ—¶å¾—åˆ°ã€‚strlenæ˜¯å­—ç¬¦å¤„ç†çš„åº“å‡½æ•°ã€‚</p><p>(2) sizeofå‚æ•°å¯ä»¥æ˜¯ä»»ä½•æ•°æ®çš„ç±»å‹æˆ–è€…æ•°æ®ã€‚strlençš„å‚æ•°åªèƒ½æ˜¯å­—ç¬¦æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘äº†ä¸€ä¸ªç»“å°¾æ˜¯â€™\0â€™çš„å­—ç¬¦ä¸²ã€‚</p><h3 id="15-å¸¸é‡æŒ‡é’ˆå’ŒæŒ‡é’ˆå¸¸é‡çš„åŒºåˆ«ï¼Ÿ"><a href="#15-å¸¸é‡æŒ‡é’ˆå’ŒæŒ‡é’ˆå¸¸é‡çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="15. å¸¸é‡æŒ‡é’ˆå’ŒæŒ‡é’ˆå¸¸é‡çš„åŒºåˆ«ï¼Ÿ"></a>15. å¸¸é‡æŒ‡é’ˆå’ŒæŒ‡é’ˆå¸¸é‡çš„åŒºåˆ«ï¼Ÿ</h3><p>(1) æŒ‡é’ˆå¸¸é‡ï¼ˆåº•å±‚constï¼‰æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘äº†ä¸€ä¸ªåªè¯»å€¼ã€‚å®ƒå®é™…ä¸Šåªæ˜¯é™åˆ¶äº†æŒ‡é’ˆçš„æ‹¥æœ‰è€…ä¸èƒ½é€šè¿‡æŒ‡é’ˆä¿®æ”¹å®ƒæ‰€æŒ‡å‘çš„å€¼ï¼Œå¯¹è¿™ä¸ªå€¼çš„å±æ€§æ²¡æœ‰é™åˆ¶ï¼Œè¿™ä¸ªå€¼æ˜¯å¯ä»¥æ˜¯å¸¸é‡ä¹Ÿå¯ä»¥å˜é‡ï¼Œå‡ä¸å½±å“ã€‚</p><p>(2) å¸¸é‡æŒ‡é’ˆï¼ˆé¡¶å±‚constï¼‰æ˜¯ä¸€ä¸ªä¸èƒ½ç»™æ”¹å˜æŒ‡å‘çš„æŒ‡é’ˆï¼Œå³æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡é’ˆä¿®æ”¹å®ƒæ‰€æŒ‡å‘çš„å€¼ï¼Œä½†ä¸èƒ½ä¿®æ”¹æŒ‡é’ˆçš„æŒ‡å‘ã€‚</p><p>è¯¦ç»†è¯´æ˜ï¼š</p><p><strong>æŒ‡é’ˆå¸¸é‡</strong></p><p>æŒ‡é’ˆå¸¸é‡ï¼šé¡¾åæ€ä¹‰å®ƒå°±æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œä½†æ˜¯æ˜¯æŒ‡é’ˆä¿®é¥°çš„ã€‚</p><p>æ ¼å¼ä¸ºï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> * <span class="keyword">const</span> p <span class="comment">//æŒ‡é’ˆå¸¸é‡</span></span><br><span class="line">åœ¨è¿™ä¸ªä¾‹å­ä¸‹å®šä¹‰ä»¥ä¸‹ä»£ç ï¼š</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸‹å®šä¹‰ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> aï¼Œbï¼›</span><br><span class="line"><span class="built_in">int</span> * <span class="keyword">const</span> p=&amp;a <span class="comment">//æŒ‡é’ˆå¸¸é‡</span></span><br><span class="line"><span class="comment">//é‚£ä¹ˆåˆ†ä¸ºä¸€ä¸‹ä¸¤ç§æ“ä½œ</span></span><br><span class="line">*p=<span class="number">9</span>;<span class="comment">//æ“ä½œæˆåŠŸ</span></span><br><span class="line">p=&amp;b;<span class="comment">//æ“ä½œé”™è¯¯å› ä¸ºå£°æ˜äº†æŒ‡é’ˆå¸¸é‡ï¼Œè¯´æ˜æŒ‡é’ˆå˜é‡ä¸å…è®¸ä¿®æ”¹ã€‚å¦‚åŒæ¬¡æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªåœ°å€è¯¥åœ°å€ä¸èƒ½è¢«ä¿®æ”¹ï¼Œä½†æ˜¯è¯¥åœ°å€é‡Œçš„å†…å®¹å¯ä»¥è¢«ä¿®æ”¹</span></span><br></pre></td></tr></table></figure><p><strong>å¸¸é‡æŒ‡é’ˆ</strong></p><p>å¸¸é‡æŒ‡é’ˆï¼šå¦‚æœåœ¨å®šä¹‰æŒ‡é’ˆå˜é‡çš„æ—¶å€™ï¼Œæ•°æ®ç±»å‹å‰ç”¨constä¿®é¥°ï¼Œè¢«å®šä¹‰çš„æŒ‡é’ˆå˜é‡å°±æ˜¯æŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆå˜é‡ï¼ŒæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆå˜é‡ç§°ä¸ºå¸¸é‡æŒ‡é’ˆï¼Œæ ¼å¼å¦‚ä¸‹</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">int</span> *p = &amp;a; <span class="comment">//å¸¸é‡æŒ‡é’ˆ</span></span><br><span class="line">åœ¨è¿™ä¸ªä¾‹å­ä¸‹å®šä¹‰ä»¥ä¸‹ä»£ç ï¼š</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸‹å®šä¹‰ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> aï¼Œbï¼›</span><br><span class="line"> <span class="keyword">const</span> <span class="built_in">int</span> *p=&amp;a <span class="comment">//å¸¸é‡æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">//é‚£ä¹ˆåˆ†ä¸ºä¸€ä¸‹ä¸¤ç§æ“ä½œ</span></span><br><span class="line">*p=<span class="number">9</span>;<span class="comment">//æ“ä½œé”™è¯¯</span></span><br><span class="line">p=&amp;b;<span class="comment">//æ“ä½œæˆåŠŸ</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºå¸¸é‡æŒ‡é’ˆæœ¬è´¨æ˜¯æŒ‡é’ˆï¼Œå¹¶ä¸”è¿™ä¸ªæŒ‡é’ˆæ˜¯ä¸€ä¸ªæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘çš„å˜é‡çš„å€¼ä¸å¯é€šè¿‡è¯¥æŒ‡é’ˆä¿®æ”¹ï¼Œä½†æ˜¯æŒ‡é’ˆæŒ‡å‘çš„å€¼å¯ä»¥æ”¹å˜ã€‚</p><p>å› ä¸ºå¸¸é‡æŒ‡é’ˆæœ¬è´¨æ˜¯æŒ‡é’ˆï¼Œå¹¶ä¸”è¿™ä¸ªæŒ‡é’ˆæ˜¯ä¸€ä¸ªæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘çš„å˜é‡çš„å€¼ä¸å¯é€šè¿‡è¯¥æŒ‡é’ˆä¿®æ”¹ï¼Œä½†æ˜¯æŒ‡é’ˆæŒ‡å‘çš„å€¼å¯ä»¥æ”¹å˜ã€‚</p><h3 id="16-æŒ‡é’ˆå¸¸é‡èƒ½ä¸èƒ½èµ‹å€¼ç»™éæŒ‡é’ˆå¸¸é‡ï¼Ÿ"><a href="#16-æŒ‡é’ˆå¸¸é‡èƒ½ä¸èƒ½èµ‹å€¼ç»™éæŒ‡é’ˆå¸¸é‡ï¼Ÿ" class="headerlink" title="16. æŒ‡é’ˆå¸¸é‡èƒ½ä¸èƒ½èµ‹å€¼ç»™éæŒ‡é’ˆå¸¸é‡ï¼Ÿ"></a>16. æŒ‡é’ˆå¸¸é‡èƒ½ä¸èƒ½èµ‹å€¼ç»™éæŒ‡é’ˆå¸¸é‡ï¼Ÿ</h3><p>ä¸èƒ½ï¼ŒæŒ‡é’ˆå¸¸é‡é™åˆ¶äº†æŒ‡é’ˆçš„æ‹¥æœ‰è€…ä¸èƒ½é€šè¿‡æŒ‡é’ˆä¿®æ”¹å®ƒæ‰€æŒ‡å‘çš„å€¼ï¼Œå¦‚æœæŒ‡é’ˆå¸¸é‡å¯ä»¥èµ‹å€¼ç»™éæŒ‡é’ˆå¸¸é‡ï¼Œé‚£å°±æ„å‘³ç€æ‹¥æœ‰è€…å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•è·å–å†™æƒé™ï¼Œè¿™åœ¨è¯­ä¹‰ä¸Šæ˜¯å†²çªçš„ã€‚</p><h3 id="17-C-å’ŒPythonçš„åŒºåˆ«ï¼Ÿ"><a href="#17-C-å’ŒPythonçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="17. C++å’ŒPythonçš„åŒºåˆ«ï¼Ÿ"></a>17. C++å’ŒPythonçš„åŒºåˆ«ï¼Ÿ</h3><p>(1) Pythonæ˜¯ä¸€ç§è„šæœ¬è¯­è¨€ï¼Œæ˜¯è§£é‡Šæ‰§è¡Œçš„ï¼Œè€ŒC++æ˜¯ç¼–è¯‘è¯­è¨€ï¼Œæ˜¯éœ€è¦ç¼–è¯‘ååœ¨ç‰¹å®šå¹³å°è¿è¡Œçš„ã€‚</p><p>(2) pythonå¯ä»¥å¾ˆæ–¹ä¾¿çš„è·¨å¹³å°ï¼Œä½†æ˜¯æ•ˆç‡æ²¡æœ‰C++é«˜ã€‚</p><p>(3) C++ä¸­éœ€è¦äº‹å…ˆå®šä¹‰å˜é‡çš„ç±»å‹ï¼Œè€ŒPythonä¸éœ€è¦</p><p>(4) Pythonçš„åº“å‡½æ•°æ¯”C++çš„å¤šï¼Œè°ƒç”¨èµ·æ¥å¾ˆæ–¹ä¾¿</p><h3 id="18-C-ä¸­structå’Œclassçš„åŒºåˆ«ï¼Ÿ"><a href="#18-C-ä¸­structå’Œclassçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="18. C++ä¸­structå’Œclassçš„åŒºåˆ«ï¼Ÿ"></a>18. C++ä¸­structå’Œclassçš„åŒºåˆ«ï¼Ÿ</h3><p>(1) ä¸¤è€…éƒ½æ‹¥æœ‰æˆå‘˜å‡½æ•°ã€å…¬æœ‰å’Œç§æœ‰éƒ¨åˆ†</p><p>(2) ä»»ä½•å¯ä»¥ä½¿ç”¨classå®Œæˆçš„å·¥ä½œï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨structå®Œæˆ</p><p>(3) ä¸¤è€…ä¸­å¦‚æœä¸å¯¹æˆå‘˜ä¸æŒ‡å®šå…¬ç§æœ‰ï¼Œstructé»˜è®¤æ˜¯å…¬æœ‰çš„ï¼Œclassåˆ™é»˜è®¤æ˜¯ç§æœ‰çš„</p><p>(4) classé»˜è®¤æ˜¯privateç»§æ‰¿ï¼Œè€Œstructæ¨¡å¼æ˜¯publicç»§æ‰¿</p><h3 id="19-C-å’ŒCçš„structçš„åŒºåˆ«ï¼Ÿ"><a href="#19-C-å’ŒCçš„structçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="19. C++å’ŒCçš„structçš„åŒºåˆ«ï¼Ÿ"></a>19. C++å’ŒCçš„structçš„åŒºåˆ«ï¼Ÿ</h3><p>Cè¯­è¨€ï¼šstructæ˜¯ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼ˆUDTï¼‰ï¼Œä¸èƒ½è®¾ç½®æƒé™ï¼Œæˆå‘˜ä¸å¯ä»¥æ˜¯å‡½æ•°ï¼Œä¸èƒ½è¢«ç»§æ‰¿ã€‚</p><p>C++ï¼šstructæ˜¯æŠ½è±¡æ•°æ®ç±»å‹ï¼ˆADTï¼‰æ”¯æŒæˆå‘˜å‡½æ•°çš„å®šä¹‰ï¼Œèƒ½è®¾ç½®æƒé™ï¼Œèƒ½è¢«ç»§æ‰¿ä¸å®ç°å¤šæ€ã€‚</p><h3 id="20-C-ä¸­constå’Œstaticçš„ä½œç”¨ï¼Ÿ"><a href="#20-C-ä¸­constå’Œstaticçš„ä½œç”¨ï¼Ÿ" class="headerlink" title="20. C++ä¸­constå’Œstaticçš„ä½œç”¨ï¼Ÿ"></a>20. C++ä¸­constå’Œstaticçš„ä½œç”¨ï¼Ÿ</h3><p><strong>(1) Staticï¼ˆç±»å¤–ï¼‰ï¼š</strong></p><p>â‘ ã€€éšè—ã€‚æ‰€æœ‰ä¸åŠ staticçš„å…¨å±€å˜é‡å’Œå‡½æ•°å…·æœ‰å…¨å±€å¯è§æ€§ï¼Œå¯ä»¥åœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨ï¼ŒåŠ äº†ä¹‹ååªèƒ½åœ¨è¯¥æ–‡ä»¶æ‰€åœ¨çš„ç¼–è¯‘æ¨¡å—ä¸­ä½¿ç”¨</p><p>â‘¡ã€€é™æ€å˜é‡æ²¡æœ‰å®šä¹‰åˆå§‹å€¼æ—¶ï¼Œä¼šåˆå§‹åŒ–ä¸º0ã€‚</p><p>â‘¢ã€€é™æ€å˜é‡åœ¨å‡½æ•°å†…å®šä¹‰ï¼Œç”Ÿå‘½å‘¨æœŸè·Ÿéšç¨‹åºï¼ˆåŒå…¨å±€å˜é‡ï¼‰ï¼Œä¸”åªè¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–ï¼Œå…·æœ‰è®°å¿†æ€§ï¼Œå…¶ä½œç”¨èŒƒå›´ä¸å±€éƒ¨å˜é‡ç›¸åŒï¼Œå‡½æ•°é€€å‡ºåä»ç„¶å­˜åœ¨ï¼Œä½†ä¸èƒ½ä½¿ç”¨</p><p><strong>(2) Staticï¼ˆç±»å†…ï¼‰ï¼š</strong></p><p>â‘ ã€€staticæˆå‘˜å˜é‡ï¼šåªä¸ç±»å…³è”ï¼Œä¸ä¸ç±»çš„å¯¹è±¡å…³è”ã€‚å®šä¹‰æ—¶è¦åˆ†é…ç©ºé—´ï¼Œä¸èƒ½åœ¨ç±»å£°æ˜ä¸­åˆå§‹åŒ–ï¼Œ å¿…é¡»åœ¨ç±»å®šä¹‰ä½“å¤–éƒ¨åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ—¶ä¸éœ€è¦æ ‡ç¤ºä¸ºstaticï¼›å¯ä»¥è¢«éstaticæˆå‘˜å‡½æ•°ä»»æ„è®¿é—®ã€‚</p><p>â‘¡ã€€staticæˆå‘˜å‡½æ•°ï¼šä¸å…·æœ‰thisæŒ‡é’ˆï¼Œæ— æ³•è®¿é—®ç±»å¯¹è±¡çš„éstaticæˆå‘˜å˜é‡å’Œéstaticæˆå‘˜å‡½æ•°ï¼›ä¸èƒ½è¢«å£°æ˜ä¸ºconstã€è™šå‡½æ•°å’Œvolatileï¼›å¯ä»¥è¢«éstaticæˆå‘˜å‡½æ•°ä»»æ„è®¿é—®</p><p><strong>(3) Constï¼ˆç±»å¤–ï¼‰ï¼š</strong></p><p>â‘ ã€€constå¸¸é‡åœ¨å®šä¹‰æ—¶å¿…é¡»åˆå§‹åŒ–ï¼Œä¹‹åæ— æ³•æ›´æ”¹</p><p>â‘¡ã€€constå½¢å‚å¯ä»¥æ¥æ”¶constå’Œéconstç±»å‹çš„å®å‚</p><p><strong>(4) Constï¼ˆç±»å†…ï¼‰ï¼š</strong></p><p>â‘ ã€€constæˆå‘˜å˜é‡ï¼šåªèƒ½é€šè¿‡æ„é€ å‡½æ•°åˆå§‹åŒ–åˆ—è¡¨è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”å¿…é¡»æœ‰æ„é€ å‡½æ•°ï¼›ä¸åŒç±»å¯¹å…¶constæ•°æ®æˆå‘˜çš„å€¼å¯ä»¥ä¸åŒï¼Œæ‰€ä»¥ä¸èƒ½åœ¨ç±»ä¸­å£°æ˜æ—¶åˆå§‹åŒ–</p><p>â‘¡ã€€constæˆå‘˜å‡½æ•°ï¼šconstç±»å¯¹è±¡ä¸å¯ä»¥è°ƒç”¨ç±»ä¸­çš„éconstæˆå‘˜å‡½æ•°ï¼›éconstç±»å¯¹è±¡åˆ™å‡å¯è°ƒç”¨ï¼›constæˆå‘˜å‡½æ•°ä¸å¯ä»¥æ”¹å˜ç±»ä¸­émutableæ•°æ®æˆå‘˜çš„å€¼ã€‚</p><p>ä¸¾ä¾‹è¯´æ˜</p><p>åœ¨C++ä¸­ï¼Œ<code>const</code>å’Œ<code>static</code>éƒ½æ˜¯ä¿®é¥°ç¬¦ï¼Œå®ƒä»¬å¯ä»¥ç”¨æ¥ä¿®æ”¹å˜é‡ã€å‡½æ•°æˆ–å¯¹è±¡çš„è¡Œä¸ºã€‚</p><ul><li><code>const</code>: <code>const</code>å…³é”®å­—å¯ä»¥ç”¨æ¥ä¿®é¥°å˜é‡ï¼Œè¡¨ç¤ºè¿™ä¸ªå˜é‡çš„å€¼æ˜¯å¸¸é‡ï¼Œä¸èƒ½è¢«ä¿®æ”¹ã€‚åœ¨ç±»ä¸­ï¼Œå¦‚æœä¸€ä¸ªæˆå‘˜å‡½æ•°è¢«å£°æ˜ä¸º<code>const</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¸èƒ½ä¿®æ”¹ç±»çš„ä»»ä½•æˆå‘˜å˜é‡ï¼ˆé™¤éè¿™ä¸ªå˜é‡æ˜¯<code>mutable</code>çš„ï¼‰ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">int</span> y;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setX</span><span class="params">(<span class="type">int</span> a)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="comment">// x = a;  // Error, can&#x27;t modify x in a const function</span></span><br><span class="line">        y = a;  <span class="comment">// OK, y is mutable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>static</code>: <code>static</code>å…³é”®å­—åœ¨ç±»ä¸­æœ‰ä¸¤ç§ç”¨æ³•ã€‚ä¸€ç§æ˜¯ä¿®é¥°æˆå‘˜å˜é‡ï¼Œè¿™æ ·è¿™ä¸ªå˜é‡å°±å˜æˆäº†ä¸€ä¸ªé™æ€æˆå‘˜å˜é‡ï¼Œå®ƒä¸å±äºç±»çš„ä»»ä½•å¯¹è±¡ï¼Œè€Œæ˜¯å±äºç±»æœ¬èº«ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½å…±äº«è¿™ä¸€ä¸ªå˜é‡ã€‚å¦ä¸€ç§æ˜¯ä¿®é¥°æˆå‘˜å‡½æ•°ï¼Œè¿™æ ·è¿™ä¸ªå‡½æ•°å°±å˜æˆäº†ä¸€ä¸ªé™æ€æˆå‘˜å‡½æ•°ï¼Œå®ƒå¯ä»¥åœ¨ä¸åˆ›å»ºå¯¹è±¡çš„æƒ…å†µä¸‹è¢«è°ƒç”¨ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> x;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">setX</span><span class="params">(<span class="type">int</span> a)</span> </span>&#123;</span><br><span class="line">        x = a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> MyClass::x = <span class="number">0</span>;  <span class="comment">// Define static member variable</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MyClass::<span class="built_in">setX</span>(<span class="number">10</span>);  <span class="comment">// Call static member function</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ç±»å¤–éƒ¨æ¥çœ‹ï¼Œ<code>const</code>å’Œ<code>static</code>ä¿®é¥°çš„æˆå‘˜å˜é‡æˆ–å‡½æ•°å¯ä»¥é€šè¿‡ç±»åç›´æ¥è®¿é—®ï¼ˆå¯¹äº<code>static</code>ï¼‰ï¼Œæˆ–è€…é€šè¿‡å¯¹è±¡è®¿é—®ä½†ä¸èƒ½ä¿®æ”¹ï¼ˆå¯¹äº<code>const</code>ï¼‰ã€‚</p><h3 id="21-æ•°ç»„åå’ŒæŒ‡é’ˆï¼ˆè¿™é‡Œä¸ºæŒ‡å‘æ•°ç»„é¦–å…ƒç´ çš„æŒ‡é’ˆï¼‰çš„åŒºåˆ«ï¼Ÿ"><a href="#21-æ•°ç»„åå’ŒæŒ‡é’ˆï¼ˆè¿™é‡Œä¸ºæŒ‡å‘æ•°ç»„é¦–å…ƒç´ çš„æŒ‡é’ˆï¼‰çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="21.æ•°ç»„åå’ŒæŒ‡é’ˆï¼ˆè¿™é‡Œä¸ºæŒ‡å‘æ•°ç»„é¦–å…ƒç´ çš„æŒ‡é’ˆï¼‰çš„åŒºåˆ«ï¼Ÿ"></a>21.æ•°ç»„åå’ŒæŒ‡é’ˆï¼ˆè¿™é‡Œä¸ºæŒ‡å‘æ•°ç»„é¦–å…ƒç´ çš„æŒ‡é’ˆï¼‰çš„åŒºåˆ«ï¼Ÿ</h3><p>(1) ç¼–è¯‘å™¨ä¸ºäº†ç®€åŒ–å¯¹æ•°ç»„çš„æ”¯æŒï¼Œå®é™…ä¸Šæ˜¯åˆ©ç”¨æŒ‡é’ˆå®ç°äº†å¯¹æ•°ç»„çš„æ”¯æŒã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å°†è¡¨è¾¾å¼ä¸­çš„æ•°ç»„å…ƒç´ å¼•ç”¨è½¬æ¢ä¸ºæŒ‡é’ˆåŠ åç§»é‡çš„å¼•ç”¨ã€‚</p><p>(2) äºŒè€…å‡å¯é€šè¿‡å¢å‡åç§»é‡æ¥è®¿é—®æ•°ç»„ä¸­çš„å…ƒç´ ã€‚</p><p>(3) æ•°ç»„åä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æŒ‡é’ˆï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªå¸¸é‡æŒ‡é’ˆï¼Œæ‰€ä»¥ä¸èƒ½è¿›è¡Œè‡ªå¢è‡ªå‡æ“ä½œã€‚</p><p>(4) å½“æ•°ç»„åå½“åšå½¢å‚ä¼ é€’ç»™è°ƒç”¨å‡½æ•°åï¼Œå°±å¤±å»äº†åŸæœ‰ç‰¹æ€§ï¼Œé€€åŒ–æˆä¸€èˆ¬æŒ‡é’ˆï¼Œå¤šäº†è‡ªå¢ã€è‡ªå‡æ“ä½œï¼Œ ä½†sizeofè¿ç®—ç¬¦ä¸èƒ½å†å¾—åˆ°åŸæ•°ç»„çš„å¤§å°äº†ã€‚</p><h3 id="22-Cä»£ç ä½¿ç”¨Cè¯­è¨€ç¼–è¯‘å’ŒC-ç¼–è¯‘æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ"><a href="#22-Cä»£ç ä½¿ç”¨Cè¯­è¨€ç¼–è¯‘å’ŒC-ç¼–è¯‘æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ" class="headerlink" title="22. Cä»£ç ä½¿ç”¨Cè¯­è¨€ç¼–è¯‘å’ŒC++ç¼–è¯‘æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ"></a>22. Cä»£ç ä½¿ç”¨Cè¯­è¨€ç¼–è¯‘å’ŒC++ç¼–è¯‘æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</h3><p>(1) C++è™½ç„¶è¯­æ³•ä¸Šæ”¯æŒå’Œå…¼å®¹Cè¯­è¨€ï¼Œä½†ä¸ºäº†æ”¯æŒå¤šç§ç‰¹æ€§ï¼Œåœ¨ç¼–è¯‘ä¸Šå´åšäº†å¾ˆå¤šCè¯­è¨€æ‰€æ²¡æœ‰çš„å…¶ä»–å¤„ç†ã€‚</p><p>(2) æ¯”å¦‚è¯´ç°åœ¨æœ‰ä¸€ä¸ªCè¯­è¨€å‡½æ•°åº“ï¼Œè€Œæˆ‘ä»¬ç”¨C++å»è°ƒç”¨è¯¥å‡½æ•°åº“ï¼Œåœ¨ç¼–è¯‘é“¾æ¥æ—¶é“¾æ¥å™¨ä¼šæŠ¥é”™ã€‚å› ä¸º<strong>C++ä¸ºäº†æ”¯æŒå‡½æ•°é‡è½½ï¼Œä¼šåœ¨ç¼–è¯‘æ—¶ç»™æ¯ä¸ªå‡½æ•°è¿›è¡Œâ€œæ”¹åâ€</strong>ï¼Œä½†æ˜¯Cè¯­è¨€åœ¨ç¼–è¯‘æ—¶åˆ™ä¸ä¼šæ”¹åï¼ŒCå‡½æ•°åº“ä¸­çš„å‡½æ•°åéƒ½ä¿æŒåŸæ ·ï¼Œè¿™å°±ä¼šä½¿é“¾æ¥å™¨åœ¨å‡½æ•°åº“ä¸­æ‰¾ä¸åˆ°æ”¹ååçš„å¯¹åº”å‡½æ•°åœ°å€ï¼Œç„¶åæŠ¥é”™ã€‚<strong>extern â€œCâ€å¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜</strong>ã€‚</p><p>(3) å› ä¸ºC++çš„å‡½æ•°æ”¹åè§„åˆ™ï¼Œ<strong>C++ä»£ç åœ¨ä½¿ç”¨å…¶ä»–æ¨¡å—çš„å‡½æ•°å‰å¿…é¡»åŒ…å«å…¶å¤´æ–‡ä»¶æˆ–æ˜¾å¼å£°æ˜å‡½æ•°</strong>ï¼Œä¸ç„¶å®ƒæ— æ³•è¯†åˆ«è¯¥å‡½æ•°æ˜¯Cå‡½æ•°è¿˜æ˜¯C++å‡½æ•°ï¼Œæ˜¯å¦éœ€è¦è¿›è¡Œæ”¹åã€‚<strong>Cè¯­è¨€ç¼–è¯‘å™¨å³ä½¿ä¸æå‰å£°æ˜å‡½æ•°ä¹Ÿå¯ä»¥è°ƒç”¨å‡½æ•°ï¼Œå› ä¸ºCç¼–è¯‘å™¨æ²¡æœ‰æ”¹åè§„åˆ™</strong>ã€‚</p><h3 id="23-externâ€Câ€çš„ç”¨æ³•ï¼Ÿ"><a href="#23-externâ€Câ€çš„ç”¨æ³•ï¼Ÿ" class="headerlink" title="23. externâ€Câ€çš„ç”¨æ³•ï¼Ÿ"></a>23. externâ€Câ€çš„ç”¨æ³•ï¼Ÿ</h3><p>åœ¨ç¨‹åºä¸­åŠ ä¸Šextern â€œCâ€åï¼Œç›¸å½“äºå‘Šè¯‰ç¼–è¯‘å™¨è¿™éƒ¨åˆ†ä»£ç æ˜¯Cè¯­è¨€å†™çš„ï¼Œå› æ­¤è¦æŒ‰ç…§Cè¯­è¨€è¿›è¡Œç¼–è¯‘ï¼Œè€Œä¸æ˜¯C++ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µæ—¶ä¼šç”¨åˆ°è¯¥è¯­æ³•ï¼š</p><p>(1) <strong>C++ä»£ç ä¸­è°ƒç”¨Cè¯­è¨€å‡½æ•°åº“</strong>ï¼›</p><p>(2) <strong>åœ¨å¤šä¸ªäººååŒå¼€å‘æ—¶ï¼Œå¯èƒ½æœ‰äººæ“…é•¿Cè¯­è¨€ï¼Œè€Œæœ‰äººæ“…é•¿C++</strong></p><h3 id="24-è¯´è¯´é‡æŒ‡é’ˆå’Œæ‚¬ç©ºæŒ‡é’ˆï¼Ÿ"><a href="#24-è¯´è¯´é‡æŒ‡é’ˆå’Œæ‚¬ç©ºæŒ‡é’ˆï¼Ÿ" class="headerlink" title="24. è¯´è¯´é‡æŒ‡é’ˆå’Œæ‚¬ç©ºæŒ‡é’ˆï¼Ÿ"></a>24. è¯´è¯´é‡æŒ‡é’ˆå’Œæ‚¬ç©ºæŒ‡é’ˆï¼Ÿ</h3><p>(1) <strong>é‡æŒ‡é’ˆï¼š</strong>æŒ‡çš„æ˜¯æ²¡æœ‰è¢«åˆå§‹åŒ–è¿‡çš„æŒ‡é’ˆã€‚è§£å†³æ–¹æ³•ï¼šå®šä¹‰æŒ‡é’ˆå˜é‡è¦åŠæ—¶åˆå§‹åŒ–æˆ–è€…ç½®ç©ºã€‚ï¼ˆä¿æŒè‰¯å¥½çš„ç¼–ç è§„èŒƒï¼‰</p><p>(2) <strong>æ‚¬ç©ºæŒ‡é’ˆï¼š</strong>æŒ‡é’ˆæœ€åˆæŒ‡å‘çš„å†…å­˜å·²ç»è¢«é‡Šæ”¾äº†çš„ä¸€ç§æŒ‡é’ˆã€‚è§£å†³æ–¹æ³•ï¼šé‡Šæ”¾æ“ä½œåç«‹å³ç½®ç©ºï¼Œæˆ–è€…ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ</p><p>é‡æŒ‡é’ˆå’Œç©ºæ‚¬æŒ‡é’ˆçš„åŒºåˆ«æ˜¯é‡æŒ‡é’ˆæ˜¯æŒ‡å‘æœªçŸ¥åœ°å€çš„æŒ‡é’ˆï¼Œè€Œç©ºæ‚¬æŒ‡é’ˆæ˜¯æŒ‡å‘å·²ç»è¢«é‡Šæ”¾çš„åœ°å€çš„æŒ‡é’ˆ</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void *p;</span><br><span class="line">// æ­¤æ—¶ p æ˜¯â€œé‡æŒ‡é’ˆâ€</span><br></pre></td></tr></table></figure><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void *p <span class="operator">=</span> malloc(size)<span class="comment">;</span></span><br><span class="line">assert(p)<span class="comment">;</span></span><br><span class="line">free(p)<span class="comment">; </span></span><br><span class="line">// ç°åœ¨ p æ˜¯â€œæ‚¬ç©ºæŒ‡é’ˆâ€</span><br><span class="line">// é¿å…â€œæ‚¬ç©ºæŒ‡é’ˆâ€</span><br><span class="line"><span class="attribute">p</span> <span class="operator">=</span> NULL<span class="comment">;</span></span><br></pre></td></tr></table></figure><h3 id="25-C-ä¸­çš„é‡è½½ã€é‡å†™ï¼ˆè¦†ç›–ï¼‰å’Œéšè—çš„åŒºåˆ«ï¼Ÿ"><a href="#25-C-ä¸­çš„é‡è½½ã€é‡å†™ï¼ˆè¦†ç›–ï¼‰å’Œéšè—çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="25. C++ä¸­çš„é‡è½½ã€é‡å†™ï¼ˆè¦†ç›–ï¼‰å’Œéšè—çš„åŒºåˆ«ï¼Ÿ"></a>25. C++ä¸­çš„é‡è½½ã€é‡å†™ï¼ˆè¦†ç›–ï¼‰å’Œéšè—çš„åŒºåˆ«ï¼Ÿ</h3><p>(1) é‡è½½æ˜¯æŒ‡åœ¨<strong>åŒä¸€èŒƒå›´å®šä¹‰ä¸­çš„åŒåå‡½æ•°</strong>æ‰å­˜åœ¨é‡è½½å…³ç³»ã€‚ä¸»è¦ç‰¹ç‚¹æ˜¯<strong>å‡½æ•°åç›¸åŒï¼Œå‚æ•°ç±»å‹å’Œæ•°ç›®æœ‰æ‰€ä¸åŒ</strong>ï¼Œä¸èƒ½å‡ºç°å‚æ•°ä¸ªæ•°å’Œç±»å‹å‡ç›¸åŒï¼Œä»…ä»…ä¾é è¿”å›å€¼ä¸åŒæ¥åŒºåˆ†çš„å‡½æ•°ã€‚</p><p>(2) é‡å†™æŒ‡çš„æ˜¯åœ¨æ´¾ç”Ÿç±»ä¸­é‡å†™çˆ¶ç±»çš„å‡½æ•°ä½“ï¼Œ<strong>è¦æ±‚åŸºç±»å‡½æ•°å¿…é¡»æ˜¯è™šå‡½æ•°</strong>ï¼Œä¸”é‡å†™çš„å‡½æ•°ç­¾å<strong>ï¼ˆè¿”å›å€¼ã€å‡½æ•°åã€å‚æ•°åˆ—è¡¨ï¼‰</strong>å¿…é¡»å®Œå…¨ä¸€è‡´ã€‚</p><p>(3) éšè—æŒ‡çš„æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œæ´¾ç”Ÿç±»ä¸­çš„å‡½æ•°å±è”½äº†åŸºç±»ä¸­çš„åŒåå‡½æ•°ã€‚</p><p>(4) <strong>é‡å†™æ˜¯çˆ¶ç±»å’Œå­ç±»ä¹‹é—´çš„å‚ç›´å…³ç³»ï¼Œé‡è½½æ˜¯ä¸åŒå‡½æ•°ä¹‹é—´çš„æ°´å¹³å…³ç³»</strong></p><p>(5) <strong>éšè—å’Œé‡å†™çš„åŒºåˆ«åœ¨äºåŸºç±»å‡½æ•°æ˜¯å¦æ˜¯è™šå‡½æ•°</strong>ã€‚</p><h3 id="26-æµ…æ‹·è´å’Œæ·±æ‹·è´çš„åŒºåˆ«ï¼Ÿ"><a href="#26-æµ…æ‹·è´å’Œæ·±æ‹·è´çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="26. æµ…æ‹·è´å’Œæ·±æ‹·è´çš„åŒºåˆ«ï¼Ÿ"></a>26. æµ…æ‹·è´å’Œæ·±æ‹·è´çš„åŒºåˆ«ï¼Ÿ</h3><p>(1) æµ…æ‹·è´å°±æ˜¯å°†å¯¹è±¡çš„æŒ‡é’ˆè¿›è¡Œç®€å•çš„å¤åˆ¶ï¼ŒåŸå¯¹è±¡å’Œå‰¯æœ¬æŒ‡å‘çš„æ˜¯ç›¸åŒçš„èµ„æºã€‚å¦‚æœåŸæ¥çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„èµ„æºé‡Šæ”¾äº†ï¼Œé‚£ä¹ˆä½¿ç”¨æ–°æŒ‡é’ˆå°±ä¼šå‡ºç°é”™è¯¯ã€‚</p><p>(2) æ·±æ‹·è´æ˜¯æ–°å¼€è¾Ÿä¸€å—ç©ºé—´ï¼Œå°†åŸå¯¹è±¡çš„èµ„æºå¤åˆ¶åˆ°æ–°çš„ç©ºé—´ä¸­ï¼Œå¹¶è¿”å›è¯¥ç©ºé—´çš„åœ°å€ã€‚å³ä½¿åŸå…ˆçš„å¯¹è±¡è¢«ææ„æ‰ï¼Œé‡Šæ”¾å†…å­˜äº†ä¹Ÿä¸ä¼šå½±å“åˆ°æ·±æ‹·è´å¾—åˆ°çš„å€¼ã€‚</p><h3 id="27-publicï¼Œprotectedå’Œprivateæƒé™çš„åŒºåˆ«ï¼Ÿ"><a href="#27-publicï¼Œprotectedå’Œprivateæƒé™çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="27. publicï¼Œprotectedå’Œprivateæƒé™çš„åŒºåˆ«ï¼Ÿ"></a>27. publicï¼Œprotectedå’Œprivateæƒé™çš„åŒºåˆ«ï¼Ÿ</h3><p><strong>(1) è®¿é—®æƒé™ï¼š</strong></p><p>â‘ ã€€publicçš„å˜é‡å’Œå‡½æ•°åœ¨ç±»çš„å†…éƒ¨å¤–éƒ¨éƒ½å¯ä»¥è®¿é—®ã€‚</p><p>â‘¡ã€€protectedçš„å˜é‡å’Œå‡½æ•°åªèƒ½åœ¨ç±»çš„å†…éƒ¨å’Œå…¶æ´¾ç”Ÿç±»ä¸­è®¿é—®ã€‚</p><p>â‘¢ã€€privateä¿®é¥°çš„å…ƒç´ åªèƒ½åœ¨ç±»å†…è®¿é—®ã€‚</p><p><strong>(2) ç»§æ‰¿æƒé™ï¼š</strong></p><p>â‘ ã€€Public:åŸºç±»çš„å…¬æœ‰æˆå‘˜å’Œä¿æŠ¤æˆå‘˜ä½œä¸ºæ´¾ç”Ÿç±»çš„æˆå‘˜æ—¶ï¼Œéƒ½ä¿æŒåŸæœ‰çš„è®¿é—®æƒé™ï¼ŒåŸºç±»çš„ç§æœ‰æˆå‘˜ä»»ç„¶æ˜¯ç§æœ‰çš„</p><p>â‘¡ã€€Protectedï¼šåŸºç±»çš„å…¬æœ‰æˆå‘˜å’Œä¿æŠ¤æˆå‘˜éƒ½æˆä¸ºæ´¾ç”Ÿç±»çš„ä¿æŠ¤æˆå‘˜ï¼ŒåŸºç±»çš„ç§æœ‰æˆå‘˜ä»ç„¶æ˜¯ç§æœ‰çš„</p><p>â‘¢ã€€privateï¼šåŸºç±»çš„å…¬æœ‰æˆå‘˜å’Œä¿æŠ¤æˆå‘˜éƒ½æˆä¸ºæ´¾ç”Ÿç±»çš„ç§æœ‰æˆå‘˜ï¼ŒåŸºç±»çš„ç§æœ‰æˆå‘˜ä»»ç„¶æ˜¯ç§æœ‰çš„</p><p><strong>å¯¹äºç»§æ‰¿æƒé™è€Œè¨€ï¼Œå®ƒæ‰€é’ˆå¯¹çš„æ˜¯ç±»å¤–çš„è®¿é—®æƒé™ã€‚å¯¹äºç±»å†…æ¥è¯´ï¼Œä¸ç®¡æ˜¯ä½•ç§ç»§æ‰¿ï¼Œæ´¾ç”Ÿç±»å‡å¯è®¿é—®åŸºç±»çš„å…¬ç”¨å’Œä¿æŠ¤æˆå‘˜ï¼Œä½†ä¸å¯è®¿é—®åŸºç±»çš„ç§æœ‰æˆå‘˜ã€‚</strong></p><h3 id="28-å¦‚ä½•ç”¨ä»£ç åˆ¤æ–­å¤§å°ç«¯å­˜å‚¨ï¼Ÿ"><a href="#28-å¦‚ä½•ç”¨ä»£ç åˆ¤æ–­å¤§å°ç«¯å­˜å‚¨ï¼Ÿ" class="headerlink" title="28. å¦‚ä½•ç”¨ä»£ç åˆ¤æ–­å¤§å°ç«¯å­˜å‚¨ï¼Ÿ"></a>28. å¦‚ä½•ç”¨ä»£ç åˆ¤æ–­å¤§å°ç«¯å­˜å‚¨ï¼Ÿ</h3><p>(1) <strong>å¤§ç«¯å­˜å‚¨ï¼š</strong>å­—æ•°æ®çš„é«˜å­—èŠ‚å­˜å‚¨åœ¨ä½åœ°å€ä¸­</p><p>(2) <strong>å°ç«¯å­˜å‚¨ï¼š</strong>å­—æ•°æ®çš„é«˜å­—èŠ‚å­˜å‚¨åœ¨é«˜åœ°å€ä¸­</p><p>(3) <strong>æ–¹å¼ä¸€ï¼šä½¿ç”¨å¼ºåˆ¶ç±»å‹è½¬æ¢</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> int long long</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> a=<span class="number">0x1234</span>;</span><br><span class="line"><span class="type">char</span> c=(<span class="type">char</span>)(a);</span><br><span class="line"><span class="keyword">if</span>(c==<span class="number">0x12</span>)&#123;</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;big&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;small&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(4) <strong>æ–¹å¼äºŒï¼šä½¿ç”¨unionè”åˆä½“</strong></p><ul><li><a href="https://blog.csdn.net/sxg226273531/article/details/135996096">å¦‚ä½•ä½¿ç”¨è”åˆä½“åˆ¤æ–­å¤§å°ç«¯ï¼Œè¯¦ç»†ä»‹ç»å…¶å†…å­˜åŸç†ï¼ˆé™„å®Œæ•´ä»£ç ï¼‰</a></li></ul><h3 id="29-volatileã€mutableå’Œexplicitå…³é”®å­—çš„ç”¨æ³•ï¼Ÿ"><a href="#29-volatileã€mutableå’Œexplicitå…³é”®å­—çš„ç”¨æ³•ï¼Ÿ" class="headerlink" title="29. volatileã€mutableå’Œexplicitå…³é”®å­—çš„ç”¨æ³•ï¼Ÿ"></a>29. volatileã€mutableå’Œexplicitå…³é”®å­—çš„ç”¨æ³•ï¼Ÿ</h3><p>(1) volatile å…³é”®å­—æ˜¯ä¸€ç§ç±»å‹ä¿®é¥°ç¬¦ï¼Œ<strong>ç”¨å®ƒå£°æ˜çš„ç±»å‹å˜é‡è¡¨ç¤ºå®ƒå¯èƒ½è¢«æŸäº›ç¼–è¯‘å™¨æœªçŸ¥çš„å› ç´ æ›´æ”¹</strong>ï¼Œæ‰€ä»¥ç³»ç»Ÿæ€»æ˜¯é‡æ–°ä»å®ƒæ‰€åœ¨çš„å†…å­˜è¯»å–æ•°æ®è€Œä¸ä¼šå»ä½¿ç”¨å†…å­˜è¯»å–ä¼˜åŒ–ï¼ˆä½¿ç”¨å¯„å­˜å™¨ï¼‰ï¼Œå³ä½¿å®ƒå‰é¢çš„æŒ‡ä»¤åˆšåˆšä»è¯¥å¤„è¯»å–è¿‡æ•°æ®ã€‚</p><p>ã€é˜²æ­¢ç¼–è¯‘çš„æ—¶å€™è¢«ä¼˜åŒ–ï¼æ¯æ¬¡éƒ½å¾—ä»å†…å­˜ä¸­è¯»å–ï¼ã€‘</p><p>(2) mutableå…³é”®å­—æ˜¯ä¸€ç§ç±»å‹ä¿®é¥°ç¬¦ï¼Œ<strong>è¢«mutableä¿®é¥°çš„æ•°æ®æˆå‘˜è¡¨ç¤ºä»–å¯ä»¥è¢«constæˆå‘˜å‡½æ•°æ‰€ä¿®æ”¹ï¼ˆconstæˆå‘˜å‡½æ•°æ— æ³•ä¿®æ”¹ç±»ä¸­çš„æ™®é€šæ•°æ®æˆå‘˜ï¼‰</strong>ï¼Œå®ƒçš„ä¿®æ”¹ä¸ä¼šå½±å“æ•´ä¸ªç±»å¯¹è±¡çš„çŠ¶æ€ã€‚</p><p>(3) <strong>explicitå…³é”®å­—ç”¨æ¥ä¿®é¥°ç±»çš„æ„é€ å‡½æ•°ï¼Œ</strong>åŠ ä¸Šè¯¥å…³é”®å­—ï¼Œè¡¨ç¤ºè¯¥ç±»ä¸èƒ½å‘ç”Ÿç›¸åº”çš„éšå¼ç±»å‹è½¬æ¢ï¼ˆå‡½æ•°è°ƒç”¨ä¼ å‚æ—¶çš„ç±»å‹è½¬æ¢ï¼‰ï¼Œåªèƒ½ä»¥æ˜¾å¼åœ°è¿›è¡Œç±»å‹è½¬æ¢ï¼ˆè°ƒç”¨æ„é€ å‡½æ•°ï¼‰ ã€‚</p><h3 id="30-C-ä¸­æœ‰å‡ ç§ç±»å‹çš„newï¼Ÿ"><a href="#30-C-ä¸­æœ‰å‡ ç§ç±»å‹çš„newï¼Ÿ" class="headerlink" title="30. C++ä¸­æœ‰å‡ ç§ç±»å‹çš„newï¼Ÿ"></a>30. C++ä¸­æœ‰å‡ ç§ç±»å‹çš„newï¼Ÿ</h3><p>ã€æœªçœ‹ã€‘</p><p>åœ¨C++ä¸­ï¼Œnewæœ‰ä¸‰ç§å…¸å‹çš„ä½¿ç”¨æ–¹æ³•ï¼š<strong>plain newï¼Œnothrow newå’Œplacement new</strong></p><p>(1) <strong>plain new</strong>ï¼šæœ€æ™®é€šçš„newï¼Œå®ƒåœ¨åˆ†é…å†…å­˜å¤±è´¥æ—¶ä¼šæŠ›å‡ºstd::bad_allocå¼‚å¸¸è€Œä¸æ˜¯è¿”å›NULL</p><p>(2) <strong>nothrow new</strong> ï¼šä¸ä¼šæŠ›å‡ºå¼‚å¸¸çš„newï¼Œåˆ†é…å†…å­˜å¤±è´¥æ—¶è¿”å›NULL</p><p>(3) <strong>placement new</strong>ï¼šä¸åˆ†é…å†…å­˜ï¼Œåªåœ¨ä¸€å—åˆ†é…å¥½äº†çš„å†…å­˜ä¸Šè°ƒç”¨ç±»çš„æ„é€ å‡½æ•°</p><h3 id="31-å½¢å‚ä¸å®å‚çš„åŒºåˆ«ï¼Ÿ"><a href="#31-å½¢å‚ä¸å®å‚çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="31. å½¢å‚ä¸å®å‚çš„åŒºåˆ«ï¼Ÿ"></a>31. å½¢å‚ä¸å®å‚çš„åŒºåˆ«ï¼Ÿ</h3><p>(1) <strong>å½¢å‚åœ¨å®šä¹‰æ—¶ä¸åˆ†é…å†…å­˜ï¼Œåªæœ‰åœ¨è¢«è°ƒç”¨æ—¶æ‰åˆ†é…å†…å­˜</strong></p><p>(2) å®å‚å¯ä»¥ä»»æ„å½¢å¼çš„è¡¨è¾¾å¼ï¼Œä½†åœ¨è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå®ƒä»¬éƒ½å¿…é¡»å…·æœ‰ç¡®å®šçš„å€¼</p><p>(3) å®å‚å’Œå½¢å‚åœ¨æ•°é‡ä¸Šï¼Œç±»å‹ä¸Šï¼Œé¡ºåºä¸Šåº”ä¸¥æ ¼ä¸€è‡´ï¼Œå¦åˆ™ä¼šå‘ç”Ÿ<strong>â€œç±»å‹ä¸åŒ¹é…â€</strong>çš„é”™è¯¯</p><p>(4) <strong>å‡½æ•°è°ƒç”¨ä¸­å‘ç”Ÿçš„æ•°æ®ä¼ é€æ˜¯å•å‘çš„ã€‚</strong> å³åªèƒ½æŠŠå®å‚çš„å€¼ä¼ é€ç»™å½¢å‚ã€‚</p><h3 id="32-å€¼ä¼ é€’ã€æŒ‡é’ˆä¼ é€’ã€å¼•ç”¨ä¼ é€’çš„åŒºåˆ«å’Œæ•ˆç‡ï¼Ÿ"><a href="#32-å€¼ä¼ é€’ã€æŒ‡é’ˆä¼ é€’ã€å¼•ç”¨ä¼ é€’çš„åŒºåˆ«å’Œæ•ˆç‡ï¼Ÿ" class="headerlink" title="32. å€¼ä¼ é€’ã€æŒ‡é’ˆä¼ é€’ã€å¼•ç”¨ä¼ é€’çš„åŒºåˆ«å’Œæ•ˆç‡ï¼Ÿ"></a>32. å€¼ä¼ é€’ã€æŒ‡é’ˆä¼ é€’ã€å¼•ç”¨ä¼ é€’çš„åŒºåˆ«å’Œæ•ˆç‡ï¼Ÿ</h3><p>(1) å€¼ä¼ é€’ï¼šå®å‚çš„å€¼å‘å½¢å‚è¿›è¡Œå€¼æ‹·è´ï¼Œå¦‚æœå€¼ä¼ é€’çš„å¯¹è±¡æ˜¯ç±»å¯¹è±¡æˆ–æ˜¯å¤§çš„ç»“æ„ä½“å¯¹è±¡ï¼Œå°†è€—è´¹ä¸€å®šçš„æ—¶é—´å’Œç©ºé—´ã€‚</p><p>(2) æŒ‡é’ˆä¼ é€’ï¼šåŒæ ·æœ‰å®å‚çš„å€¼å‘å½¢å‚è¿›è¡Œå€¼æ‹·è´ï¼Œä½†æ‹·è´çš„æ•°æ®æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„åœ°å€ã€‚</p><p>(3) å¼•ç”¨ä¼ é€’ï¼šåŒæ ·æœ‰ä¸Šè¿°çš„æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œä½†å…¶æ˜¯é’ˆå¯¹åœ°å€çš„ï¼Œç›¸å½“äºä¸ºè¯¥æ•°æ®æ‰€åœ¨çš„åœ°å€èµ·äº†ä¸€ä¸ªåˆ«åã€‚</p><p>(4) <strong>æ•ˆç‡ä¸Šè®²ï¼ŒæŒ‡é’ˆä¼ é€’å’Œå¼•ç”¨ä¼ é€’æ¯”å€¼ä¼ é€’æ•ˆç‡é«˜ã€‚ä¸€èˆ¬ä¸»å¼ ä½¿ç”¨å¼•ç”¨ä¼ é€’ï¼Œä»£ç é€»è¾‘ä¸Šæ›´åŠ ç´§å‡‘ã€æ¸…æ™°</strong>ã€‚</p><h3 id="33-C-æœ‰å“ªå‡ ç§çš„æ„é€ å‡½æ•°ï¼Ÿ"><a href="#33-C-æœ‰å“ªå‡ ç§çš„æ„é€ å‡½æ•°ï¼Ÿ" class="headerlink" title="33. C++æœ‰å“ªå‡ ç§çš„æ„é€ å‡½æ•°ï¼Ÿ"></a>33. C++æœ‰å“ªå‡ ç§çš„æ„é€ å‡½æ•°ï¼Ÿ</h3><p>(1) é»˜è®¤æ„é€ å‡½æ•°ï¼ˆæ— å‚æ•°ï¼‰</p><p>(2) åˆå§‹åŒ–æ„é€ å‡½æ•°ï¼ˆæœ‰å‚æ•°ï¼‰</p><p>(3) æ‹·è´æ„é€ å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CExample</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">CExample</span>(<span class="type">int</span> b)</span><br><span class="line">    &#123;</span><br><span class="line">        a=b;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;constructor is called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">CExample</span>(<span class="type">const</span> CExample &amp; c)</span><br><span class="line">    &#123;</span><br><span class="line">        a=c.a;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;copy constructor is called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ææ„å‡½æ•°</span></span><br><span class="line">    ~<span class="built_in">CExample</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;destructor is called\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout&lt;&lt;a&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">CExample <span class="title">A</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">    CExample B=A;</span><br><span class="line">    B.<span class="built_in">Show</span>(); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="34-ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Ÿ"><a href="#34-ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Ÿ" class="headerlink" title="34. ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Ÿ"></a>34. ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Ÿ</h3><p>(1) ç”¨ç±»çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡å»åˆå§‹åŒ–æ„é€ ä¸€ä¸ªç±»çš„æ–°å¯¹è±¡çš„æ—¶å€™</p><p>(2) å‡½æ•°çš„å‚æ•°æ˜¯ç±»çš„å¯¹è±¡æ—¶ï¼ˆå€¼ä¼ é€’ï¼‰</p><p>(3) å‡½æ•°çš„è¿”å›å€¼æ˜¯å‡½æ•°ä½“å†…å±€éƒ¨å¯¹è±¡çš„ç±»çš„å¯¹è±¡æ—¶</p><h3 id="35-è¯´è¯´C-ä¸­çš„åˆå§‹åŒ–ï¼Ÿ"><a href="#35-è¯´è¯´C-ä¸­çš„åˆå§‹åŒ–ï¼Ÿ" class="headerlink" title="35. è¯´è¯´C++ä¸­çš„åˆå§‹åŒ–ï¼Ÿ"></a>35. è¯´è¯´C++ä¸­çš„åˆå§‹åŒ–ï¼Ÿ</h3><p>C++ä¸­å˜é‡çš„åˆå§‹åŒ–æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œå¦‚ï¼šé»˜è®¤åˆå§‹åŒ–ï¼Œå€¼åˆå§‹åŒ–ï¼Œç›´æ¥åˆå§‹åŒ–ï¼Œæ‹·è´åˆå§‹åŒ–ã€‚ä¸‹é¢ä¸€ä¸€ä»‹ç»ã€‚</p><p>(1) <strong>é»˜è®¤åˆå§‹åŒ–</strong></p><p>â‘ ã€€é»˜è®¤åˆå§‹åŒ–æ˜¯æŒ‡å®šä¹‰å˜é‡æ—¶ æ²¡æœ‰æŒ‡å®šåˆå€¼æ—¶è¿›è¡Œçš„åˆå§‹åŒ–æ“ä½œã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int a<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>â‘¡ã€€å¯¹äºå†…ç½®ç±»å‹å˜é‡ï¼ˆå¦‚intï¼Œdoubleï¼Œboolç­‰ï¼‰ï¼Œ<strong>å¦‚æœæ˜¯å…¨å±€å˜é‡æˆ–é™æ€å˜é‡ï¼Œåˆ™åˆå§‹åŒ–ä¸º0ï¼Œå¦‚æœæ˜¯æ ˆæˆ–è€…å †å˜é‡ï¼Œåˆ™å°†æ‹¥æœ‰æœªå®šä¹‰çš„å€¼</strong>ã€‚</p><p>â‘¢ã€€å¯¹äºç±»ç±»å‹çš„å˜é‡ï¼ˆå¦‚stringæˆ–å…¶ä»–è‡ªå®šä¹‰ç±»å‹ï¼‰ï¼Œä¸ç®¡å®šä¹‰äºä½•å¤„ï¼Œéƒ½ä¼šæ‰§è¡Œé»˜è®¤æ„é€ å‡½æ•°ã€‚å¦‚æœè¯¥ç±»æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œåˆ™ä¼šå¼•å‘é”™è¯¯ã€‚å› æ­¤ï¼Œå»ºè®®ä¸ºæ¯ä¸ªç±»éƒ½å®šä¹‰ä¸€ä¸ªé»˜è®¤æ„é€ å‡½æ•°ï¼ˆ=defaultï¼‰ã€‚</p><p>â‘£ã€€æ³¨æ„ï¼šé»˜è®¤åˆå§‹åŒ–çš„å€¼å¹¶ä¸æ˜¯ç»å¯¹çš„ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹ä¼šäº§ç”ŸæœªçŸ¥çš„é”™è¯¯ï¼Œ<strong>ä¸€èˆ¬å®šä¹‰å˜é‡æ—¶æœ€å¥½éƒ½è¦ä¸ºå®ƒè®¾å®šåˆå§‹å€¼ï¼Œè¿™æ˜¯ä¸€ç§è‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ã€‚</strong></p><p>(2) <strong>å€¼åˆå§‹åŒ–</strong></p><p>â‘ ã€€å€¼åˆå§‹åŒ–æ˜¯æŒ‡ä½¿ç”¨äº†åˆå§‹åŒ–å™¨ï¼ˆå³ä½¿ç”¨äº†åœ†æ‹¬å·æˆ–èŠ±æ‹¬å·ï¼‰ä½†å´æ²¡æœ‰æä¾›åˆå§‹å€¼çš„æƒ…å†µã€‚</p><p>â‘¡ã€€ç‰¹åˆ«çš„ï¼Œé‡‡ç”¨åŠ¨æ€åˆ†é…å†…å­˜çš„æ–¹å¼ï¼ˆå³é‡‡ç”¨newå…³é”®å­—ï¼‰åˆ›å»ºçš„å˜é‡ï¼Œä¸åŠ æ‹¬å·æ—¶ï¼Œå¦‚int <em>p=new intï¼Œæ˜¯é»˜è®¤åˆå§‹åŒ–ï¼ŒåŠ äº†æ‹¬å·ï¼Œå¦‚int </em>p=new int()ï¼Œä¸ºå€¼åˆå§‹åŒ–ã€‚</p><p>â‘¢ã€€è‹¥ä¸é‡‡ç”¨åŠ¨æ€åˆ†é…å†…å­˜çš„æ–¹å¼ï¼ˆå³ä¸é‡‡ç”¨newè¿ç®—ç¬¦ï¼‰ï¼Œå†™æˆint a();æ˜¯é”™è¯¯çš„å€¼åˆå§‹åŒ–æ–¹å¼ï¼Œå› ä¸ºè¿™ç§æ–¹å¼æ˜¯å£°æ˜äº†ä¸€ä¸ªå‡½æ•°è€Œä¸æ˜¯è¿›è¡Œå€¼åˆå§‹åŒ–ã€‚å¦‚æœä¸€å®šè¦è¿›è¡Œå€¼åˆå§‹åŒ–ï¼Œå¿…é¡»ç»“åˆæ‹·è´åˆå§‹åŒ–ä½¿ç”¨ï¼Œå³å†™æˆint a=int()ã€‚</p><p>â‘£ã€€å€¼åˆå§‹åŒ–å’Œé»˜è®¤åˆå§‹åŒ–ä¸€æ ·ï¼Œå¯¹äºå†…ç½®ç±»å‹åˆå§‹åŒ–ä¸º0ï¼Œå¯¹äºç±»ç±»å‹åˆ™è°ƒç”¨å…¶é»˜è®¤æ„é€ å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œåˆ™ä¸èƒ½è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>(3) <strong>ç›´æ¥åˆå§‹åŒ–</strong></p><p>â‘ ã€€ç›´æ¥åˆå§‹åŒ–æ˜¯æŒ‡é‡‡ç”¨å°æ‹¬å·çš„æ–¹å¼è¿›è¡Œå˜é‡åˆå§‹åŒ–ï¼ˆå°æ‹¬å·é‡Œä¸€å®šè¦æœ‰åˆå§‹å€¼ï¼Œå¦‚æœæ²¡æä¾›åˆå§‹å€¼ï¼Œé‚£å°±æ˜¯å€¼åˆå§‹åŒ–äº†ï¼ï¼‰</p><p>â‘¡ã€€<strong>å¯¹äºç±»ç±»å‹æ¥è¯´ï¼Œç›´æ¥åˆå§‹åŒ–ä¼šç›´æ¥è°ƒç”¨ä¸å®å‚åŒ¹é…çš„æ„é€ å‡½æ•°ã€‚</strong></p><p>(4) <strong>æ‹·è´åˆå§‹åŒ–</strong></p><p>â‘ ã€€æ‹·è´åˆå§‹åŒ–æ˜¯æŒ‡é‡‡ç”¨ç­‰å·ï¼ˆ=ï¼‰è¿›è¡Œåˆå§‹åŒ–çš„æ–¹å¼ï¼Œç¼–è¯‘å™¨æŠŠç­‰å·å³ä¾§çš„åˆå§‹å€¼æ‹·è´åˆ°æ–°åˆ›å»ºçš„å¯¹è±¡ä¸­å»ã€‚</p><p>â‘¡ã€€æ‹·è´åˆå§‹åŒ–é¦–å…ˆä½¿ç”¨æŒ‡å®šæ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œç„¶åç”¨<strong>æ‹·è´æ„é€ å‡½æ•°</strong>å°†é‚£ä¸ªä¸´æ—¶å¯¹è±¡æ‹·è´åˆ°æ­£åœ¨åˆ›å»ºçš„å¯¹è±¡ã€‚</p><h3 id="36-ç›´æ¥åˆå§‹åŒ–ã€æ‹·è´åˆå§‹åŒ–ã€èµ‹å€¼çš„å·®åˆ«ï¼Ÿ"><a href="#36-ç›´æ¥åˆå§‹åŒ–ã€æ‹·è´åˆå§‹åŒ–ã€èµ‹å€¼çš„å·®åˆ«ï¼Ÿ" class="headerlink" title="36. ç›´æ¥åˆå§‹åŒ–ã€æ‹·è´åˆå§‹åŒ–ã€èµ‹å€¼çš„å·®åˆ«ï¼Ÿ"></a>36. ç›´æ¥åˆå§‹åŒ–ã€æ‹·è´åˆå§‹åŒ–ã€èµ‹å€¼çš„å·®åˆ«ï¼Ÿ</h3><p>(1) è¿™ä¸‰ç§æ“ä½œéå¸¸ç±»ä¼¼ï¼Œè¯­æ³•ä¸Šä¹Ÿå¾ˆç›¸åƒï¼Œ<strong>åŒºåˆ†è¿™ä¸‰è€…ä¸»è¦çœ‹ä»–ä»¬çš„æœ€ç»ˆè°ƒç”¨çš„å‡½æ•°</strong>ã€‚</p><p>(2) ç›´æ¥åˆå§‹åŒ–ï¼š<strong>è¦åˆ›å»ºçš„å¯¹è±¡ä¸å­˜åœ¨</strong>ï¼Œä¸»è¦åˆ©ç”¨<strong>åˆå§‹åŒ–å™¨ï¼ˆåœ†æ‹¬å·ï¼‰</strong>ä½¿ç”¨å…¶ä»–çš„åˆå§‹å€¼è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œä¸€èˆ¬è¿™ä¸ªåˆå§‹å€¼æ˜¯åˆ«çš„å¯¹è±¡æˆ–æ•°æ®ç±»å‹ï¼Œ<strong>ç›´æ¥åˆå§‹åŒ–è°ƒç”¨ç±»çš„æ„é€ å‡½æ•°ï¼ˆè°ƒç”¨å‚æ•°ç±»å‹æœ€ä½³åŒ¹é…çš„é‚£ä¸ªï¼‰</strong>ã€‚</p><p>(3) æ‹·è´åˆå§‹åŒ–ï¼š<strong>è¦åˆ›å»ºçš„å¯¹è±¡ä¸å­˜åœ¨</strong>ï¼Œä½¿ç”¨å·²æœ‰çš„å¯¹è±¡ï¼ˆä¸åˆ›å»ºçš„å¯¹è±¡ç±»å‹ä¸€è‡´ï¼‰æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™ä¸ªå·²æœ‰çš„å¯¹è±¡æ—¢å¯ä»¥æ˜¯ä¸´æ—¶å¯¹è±¡ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–å¯¹è±¡ã€‚<strong>æ—¢å¯ä»¥ä½¿ç”¨åˆå§‹åŒ–å™¨ï¼ˆåœ†æ‹¬å·ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨èµ‹å€¼å·ï¼ˆâ€œ=â€ï¼‰æ¥è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œä½†ä»–ä»¬çš„èƒŒåéƒ½ä¼šè°ƒç”¨ç±»çš„æ‹·è´æ„é€ å‡½æ•°</strong>ã€‚</p><p>(4) èµ‹å€¼ï¼š<strong>è¦åˆ›å»ºçš„å¯¹è±¡å·²å­˜åœ¨</strong>ï¼Œç”¨å·²å­˜åœ¨çš„å¯¹è±¡ç»™å®ƒèµ‹å€¼ï¼Œè¿™å±äºé‡è½½â€œ=â€å·è¿ç®—ç¬¦çš„èŒƒç•´ï¼Œä»–å¹¶ä¸æ˜¯ä¸€ç§åˆå§‹åŒ–æ“ä½œï¼Œ<strong>èƒŒåè°ƒç”¨ç±»çš„é‡è½½â€œ=â€è¿ç®—ç¬¦å‡½æ•°</strong>ã€‚</p><p>(5) å¯¹äºå†…ç½®ç±»å‹å˜é‡ï¼ˆå¦‚intï¼Œdoubleï¼Œboolç­‰ï¼‰ï¼Œç›´æ¥åˆå§‹åŒ–ä¸æ‹·è´åˆå§‹åŒ–å·®åˆ«å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p><h3 id="37-é™æ€å˜é‡ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–ï¼Ÿ"><a href="#37-é™æ€å˜é‡ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–ï¼Ÿ" class="headerlink" title="37. é™æ€å˜é‡ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–ï¼Ÿ"></a>37. é™æ€å˜é‡ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–ï¼Ÿ</h3><p>è§†ç¼–è¯‘å™¨è€Œå®šï¼Œæœ‰äº›å¯èƒ½åœ¨ä»£ç æ‰§è¡Œä¹‹å‰å°±åˆå§‹åŒ–ï¼Œæœ‰äº›åˆ™å¯èƒ½ç›´åˆ°ä»£ç æ‰§è¡Œæ—¶æ‰åˆå§‹åŒ–ã€‚</p><h3 id="38-deleteã€delete-çš„åŒºåˆ«ï¼Ÿ"><a href="#38-deleteã€delete-çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="38. deleteã€delete []çš„åŒºåˆ«ï¼Ÿ"></a>38. deleteã€delete []çš„åŒºåˆ«ï¼Ÿ</h3><p>deleteåªä¼šè°ƒç”¨ä¸€æ¬¡ææ„å‡½æ•°ï¼Œdelete [] ä¼šæ ¹æ®æ•°ç»„å…ƒç´ çš„æ•°é‡ï¼Œå¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ è°ƒç”¨ææ„å‡½æ•°ã€‚</p><h3 id="39-mallocã€callocã€reallocçš„åŒºåˆ«ï¼Ÿ"><a href="#39-mallocã€callocã€reallocçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="39. mallocã€callocã€reallocçš„åŒºåˆ«ï¼Ÿ"></a>39. mallocã€callocã€reallocçš„åŒºåˆ«ï¼Ÿ</h3><p>(1) <strong>mallocå‡½æ•°</strong>ï¼švoid* malloc(unsigned int num_size); éœ€è¦æ‰‹åŠ¨è®¡ç®—åˆ†é…å¤§å°ï¼Œç”³è¯·çš„ç©ºé—´çš„å€¼æ˜¯éšæœºåˆå§‹åŒ–çš„</p><p>(2) <strong>callocå‡½æ•°</strong>ï¼švoid* calloc(size_t n,size_t size);æ— éœ€æ‰‹åŠ¨è®¡ç®—åˆ†é…å¤§å°ï¼Œç”³è¯·çš„ç©ºé—´çš„å€¼æ˜¯åˆå§‹åŒ–ä¸º0çš„</p><p>(3) <strong>reallocå‡½æ•°</strong> ï¼šç»™åŠ¨æ€åˆ†é…çš„ç©ºé—´åˆ†é…é¢å¤–çš„ç©ºé—´ï¼Œç”¨äºæ‰©å……å®¹é‡ã€‚</p><p>è¯¦ç»†è§£é‡Šï¼š</p><p><code>malloc</code>, <code>calloc</code> å’Œ <code>realloc</code> éƒ½æ˜¯ C å’Œ C++ è¯­è¨€ä¸­ç”¨æ¥åŠ¨æ€åˆ†é…å†…å­˜çš„å‡½æ•°ï¼Œä½†å®ƒä»¬å„æœ‰ä¸åŒçš„ç”¨é€”å’Œè¡Œä¸ºã€‚</p><ul><li><code>malloc</code>: è¿™æ˜¯æœ€å¸¸ç”¨çš„åŠ¨æ€å†…å­˜åˆ†é…å‡½æ•°ã€‚<code>malloc</code> æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³è¦åˆ†é…çš„å­—èŠ‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªæŒ‡å‘æ–°åˆ†é…å†…å­˜çš„æŒ‡é’ˆï¼Œæˆ–è€…åœ¨æ— æ³•åˆ†é…å†…å­˜æ—¶è¿”å› NULLã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>malloc</code> ä¸ä¼šæ¸…é›¶æ–°åˆ†é…çš„å†…å­˜ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> *arr = (<span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="number">10</span> * <span class="keyword">sizeof</span>(<span class="type">int</span>)); <span class="comment">// åˆ†é…è¶³å¤Ÿå­˜å‚¨10ä¸ªæ•´æ•°çš„å†…å­˜</span></span><br></pre></td></tr></table></figure><ul><li><code>calloc</code>: è¿™ä¸ªå‡½æ•°ä¸ <code>malloc</code> ç±»ä¼¼ï¼Œä½†å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šè¦åˆ†é…çš„å…ƒç´ æ•°é‡å’Œæ¯ä¸ªå…ƒç´ çš„å¤§å°ã€‚<code>calloc</code> ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘æ–°åˆ†é…å†…å­˜çš„æŒ‡é’ˆï¼Œæˆ–è€…åœ¨æ— æ³•åˆ†é…å†…å­˜æ—¶è¿”å› NULLã€‚ä¸ <code>malloc</code> ä¸åŒï¼Œ<code>calloc</code> ä¼šæ¸…é›¶æ–°åˆ†é…çš„å†…å­˜ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> *arr = (<span class="type">int</span>*)<span class="built_in">calloc</span>(<span class="number">10</span>, <span class="keyword">sizeof</span>(<span class="type">int</span>)); <span class="comment">// åˆ†é…è¶³å¤Ÿå­˜å‚¨10ä¸ªæ•´æ•°çš„å†…å­˜ï¼Œå¹¶å°†å†…å­˜æ¸…é›¶</span></span><br></pre></td></tr></table></figure><ul><li><code>realloc</code>: è¿™ä¸ªå‡½æ•°ç”¨äºæ”¹å˜å·²åˆ†é…çš„å†…å­˜å¤§å°ã€‚<code>realloc</code> æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªæŒ‡å‘å·²åˆ†é…å†…å­˜çš„æŒ‡é’ˆå’Œæ–°çš„å†…å­˜å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚<code>realloc</code> ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘æ–°å†…å­˜çš„æŒ‡é’ˆï¼Œæˆ–è€…åœ¨æ— æ³•åˆ†é…å†…å­˜æ—¶è¿”å› NULLã€‚å¦‚æœæ–°çš„å†…å­˜å¤§å°å¤§äºåŸæ¥çš„å¤§å°ï¼Œ<code>realloc</code> ä¼šä¿ç•™åŸæ¥å†…å­˜çš„å†…å®¹ï¼Œå¹¶å¯èƒ½å°†æ–°çš„å†…å­˜éƒ¨åˆ†åˆå§‹åŒ–ä¸ºé›¶ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> *arr = (<span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="number">10</span> * <span class="keyword">sizeof</span>(<span class="type">int</span>)); <span class="comment">// åˆ†é…è¶³å¤Ÿå­˜å‚¨10ä¸ªæ•´æ•°çš„å†…å­˜</span></span><br><span class="line">arr = (<span class="type">int</span>*)<span class="built_in">realloc</span>(arr, <span class="number">20</span> * <span class="keyword">sizeof</span>(<span class="type">int</span>)); <span class="comment">// æ‰©å¤§å†…å­˜ä»¥å­˜å‚¨20ä¸ªæ•´æ•°</span></span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨è¿™äº›å‡½æ•°æ—¶ï¼Œä¸€å®šè¦è®°ä½åœ¨ä¸å†éœ€è¦å†…å­˜æ—¶ä½¿ç”¨ <code>free</code> å‡½æ•°é‡Šæ”¾å®ƒï¼Œä»¥é˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p><h3 id="40-è¯´è¯´ç±»æˆå‘˜çš„åˆå§‹åŒ–æ–¹å¼ï¼Ÿ"><a href="#40-è¯´è¯´ç±»æˆå‘˜çš„åˆå§‹åŒ–æ–¹å¼ï¼Ÿ" class="headerlink" title="40. è¯´è¯´ç±»æˆå‘˜çš„åˆå§‹åŒ–æ–¹å¼ï¼Ÿ"></a>40. è¯´è¯´ç±»æˆå‘˜çš„åˆå§‹åŒ–æ–¹å¼ï¼Ÿ</h3><p>(1) <strong>æ„é€ å‡½æ•°åˆå§‹åŒ–ï¼š</strong>åœ¨æ„é€ å‡½æ•°ä½“ä¸­åˆå§‹åŒ–,åœ¨æ‰€æœ‰çš„æ•°æ®æˆå‘˜è¢«åˆ†é…å†…å­˜ç©ºé—´åï¼Œæ‰è¿›è¡Œèµ‹å€¼æ“ä½œã€‚èƒŒåä¼šè°ƒç”¨ä¸€æ¬¡æ•°æ®æˆå‘˜çš„æ„é€ å‡½æ•°å’Œèµ‹å€¼å‡½æ•°ã€‚</p><p>(2) <strong>åˆå§‹åŒ–åˆ—è¡¨ï¼š</strong>ç»™æ•°æ®æˆå‘˜åˆ†é…å†…å­˜ç©ºé—´æ—¶å°±è¿›è¡Œåˆå§‹åŒ–ï¼Œç›¸æ¯”èµ·æ„é€ å‡½æ•°åˆå§‹åŒ–ï¼Œå°‘äº†ä¸€æ¬¡è°ƒç”¨èµ‹å€¼å‡½æ•°çš„æ“ä½œï¼Œå› æ­¤æ•ˆç‡ä¼šæ›´é«˜ä¸€äº›ã€‚</p><h3 id="41-æ„é€ å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Ÿ"><a href="#41-æ„é€ å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Ÿ" class="headerlink" title="41. æ„é€ å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Ÿ"></a>41. æ„é€ å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Ÿ</h3><p>(1) åŸºç±»çš„æ„é€ å‡½æ•°</p><p>(2) æ´¾ç”Ÿç±»çš„æ•°æ®æˆå‘˜çš„æ„é€ å‡½æ•°</p><p>(3) æ´¾ç”Ÿç±»è‡ªå·±çš„æ„é€ å‡½æ•°</p><h3 id="42-ææ„å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Ÿ"><a href="#42-ææ„å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Ÿ" class="headerlink" title="42. ææ„å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Ÿ"></a>42. ææ„å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Ÿ</h3><p>(1) è°ƒç”¨æ´¾ç”Ÿç±»çš„ææ„å‡½æ•°ï¼›</p><p>(2) è°ƒç”¨æ´¾ç”Ÿç±»çš„æ•°æ®æˆå‘˜çš„ææ„å‡½æ•°ï¼›</p><p>(3) è°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°ã€‚</p><h3 id="43-æœ‰å“ªäº›æƒ…å†µå¿…é¡»ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼Ÿ"><a href="#43-æœ‰å“ªäº›æƒ…å†µå¿…é¡»ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼Ÿ" class="headerlink" title="43. æœ‰å“ªäº›æƒ…å†µå¿…é¡»ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼Ÿ"></a>43. æœ‰å“ªäº›æƒ…å†µå¿…é¡»ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼Ÿ</h3><p>è¦ä¸ç„¶è¿›å…¥åˆ°æ‹¬å·é‡Œé¢å°±å¯¹è±¡å°±æ„é€ å®Œæˆäº†ã€‚</p><p>(1) å½“åˆå§‹åŒ–ä¸€ä¸ªå¼•ç”¨æˆå‘˜æ—¶</p><p>(2) å½“åˆå§‹åŒ–ä¸€ä¸ªå¸¸é‡æˆå‘˜æ—¶</p><p>(3) å½“è°ƒç”¨ä¸€ä¸ªåŸºç±»çš„æ„é€ å‡½æ•°ï¼Œè€Œå®ƒæ‹¥æœ‰ä¸€ç»„å‚æ•°æ—¶</p><p>(4) å½“è°ƒç”¨ä¸€ä¸ªæˆå‘˜ç±»çš„æ„é€ å‡½æ•°ï¼Œè€Œå®ƒæ‹¥æœ‰ä¸€ç»„å‚æ•°æ—¶</p><h3 id="44-åˆå§‹åŒ–åˆ—è¡¨çš„åˆå§‹åŒ–é¡ºåºï¼Ÿ"><a href="#44-åˆå§‹åŒ–åˆ—è¡¨çš„åˆå§‹åŒ–é¡ºåºï¼Ÿ" class="headerlink" title="44. åˆå§‹åŒ–åˆ—è¡¨çš„åˆå§‹åŒ–é¡ºåºï¼Ÿ"></a>44. åˆå§‹åŒ–åˆ—è¡¨çš„åˆå§‹åŒ–é¡ºåºï¼Ÿ</h3><p>è¿™å’Œå¯¹è±¡å†…å­˜æœ‰å…³ã€‚</p><p>åˆå§‹åŒ–åˆ—è¡¨ä¸­å‡ºç°çš„é¡ºåºå¹¶ä¸æ˜¯çœŸæ­£çš„åˆå§‹åŒ–é¡ºåºï¼Œåˆå§‹åŒ–é¡ºåºåªå–å†³äºæˆå‘˜å˜é‡åœ¨ç±»ä¸­çš„å£°æ˜é¡ºåºã€‚æˆ‘ä»¬åº”å°½å¯èƒ½ä¿è¯æˆå‘˜å˜é‡çš„å£°æ˜é¡ºåºä¸åˆå§‹åŒ–åˆ—è¡¨é¡ºåºä¸€è‡´ï¼Œæ‰èƒ½çœŸæ­£ä¿è¯å…¶æ•ˆç‡ã€‚</p><h3 id="45-C-ä¸­æ–°å¢çš„stringä¸Cä¸­çš„-char-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#45-C-ä¸­æ–°å¢çš„stringä¸Cä¸­çš„-char-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="45. C++ä¸­æ–°å¢çš„stringä¸Cä¸­çš„ char *æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>45. C++ä¸­æ–°å¢çš„stringä¸Cä¸­çš„ char *æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><p>(1) stringå¯¹char*è¿›è¡Œäº†å°è£…ï¼ŒåŒ…å«äº†å­—ç¬¦ä¸²çš„å±æ€§ä»¥åŠå¯¹å¤–æä¾›äº†é€šç”¨æ–¹æ³•ã€‚</p><p>(2) stringå¯ä»¥è¿›è¡ŒåŠ¨æ€æ‰©å±•ï¼Œåœ¨æ¯æ¬¡æ‰©å±•çš„æ—¶å€™å¦å¤–ç”³è¯·ä¸€å—åŸç©ºé—´å¤§å°ä¸¤å€çš„ç©ºé—´ï¼ˆ2^nï¼‰ï¼Œç„¶åå°†åŸå­—ç¬¦ä¸²æ‹·è´è¿‡å»ï¼Œå¹¶åŠ ä¸Šæ–°å¢çš„å†…å®¹ã€‚</p><h3 id="46-ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Œå¦‚ä½•æ£€æµ‹ä¸é¿å…ï¼Ÿ"><a href="#46-ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Œå¦‚ä½•æ£€æµ‹ä¸é¿å…ï¼Ÿ" class="headerlink" title="46. ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Œå¦‚ä½•æ£€æµ‹ä¸é¿å…ï¼Ÿ"></a>46. ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Œå¦‚ä½•æ£€æµ‹ä¸é¿å…ï¼Ÿ</h3><p>(1) å†…å­˜æ³„æ¼æ˜¯æŒ‡å †å†…å­˜çš„æ³„æ¼ã€‚å †å†…å­˜æ˜¯æŒ‡ç¨‹åºä»å †ä¸­åˆ†é…çš„å†…å­˜å—ï¼Œä½¿ç”¨å®Œåå¿…é¡»æ˜¾å¼é‡Šæ”¾çš„å†…å­˜ï¼Œå¦åˆ™ï¼Œè¿™å—å†…å­˜å°±ä¸èƒ½è¢«å†æ¬¡ä½¿ç”¨ï¼Œæˆ‘ä»¬å°±è¯´è¿™å—å†…å­˜æ³„æ¼äº†ã€‚</p><p>(2) æ£€æµ‹æ–¹æ³•ï¼šæœ‰ä¸“é—¨çš„å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·ï¼ŒLinuxä¸‹å¯ä»¥ä½¿ç”¨Valgrindå·¥å…· ï¼ŒWindowsä¸‹å¯ä»¥ä½¿ç”¨CRTåº“ã€‚</p><p>(3) é¿å…æ–¹æ³•ï¼šä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Œè‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ã€‚</p><h3 id="47-ä»€ä¹ˆæ˜¯å†…å­˜æº¢å‡ºå’Œå†…å­˜è¶Šç•Œï¼Ÿ"><a href="#47-ä»€ä¹ˆæ˜¯å†…å­˜æº¢å‡ºå’Œå†…å­˜è¶Šç•Œï¼Ÿ" class="headerlink" title="47. ä»€ä¹ˆæ˜¯å†…å­˜æº¢å‡ºå’Œå†…å­˜è¶Šç•Œï¼Ÿ"></a>47. ä»€ä¹ˆæ˜¯å†…å­˜æº¢å‡ºå’Œå†…å­˜è¶Šç•Œï¼Ÿ</h3><p>(1) å†…å­˜æº¢å‡ºæŒ‡çš„æ˜¯ç¨‹åºåœ¨ç”³è¯·å†…å­˜æ—¶ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ä¾›å…¶ä½¿ç”¨ã€‚</p><p>(2) å†…å­˜è¶Šç•ŒæŒ‡çš„æ˜¯ç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œä½¿ç”¨çš„æ—¶å€™è¶…å‡ºäº†è¿™å—å†…å­˜åŒºåŸŸã€‚</p><h3 id="48-ä»‹ç»C-é¢å‘å¯¹è±¡çš„ä¸‰å¤§ç‰¹æ€§ï¼Ÿ"><a href="#48-ä»‹ç»C-é¢å‘å¯¹è±¡çš„ä¸‰å¤§ç‰¹æ€§ï¼Ÿ" class="headerlink" title="48. ä»‹ç»C++é¢å‘å¯¹è±¡çš„ä¸‰å¤§ç‰¹æ€§ï¼Ÿ"></a>48. ä»‹ç»C++é¢å‘å¯¹è±¡çš„ä¸‰å¤§ç‰¹æ€§ï¼Ÿ</h3><p>(1) <strong>ç»§æ‰¿</strong></p><p>è®©æŸä¸ªç±»è·å¾—å¦ä¸€ä¸ªç±»çš„å±æ€§å’Œæ–¹æ³•ã€‚å®ƒå¯ä»¥ä½¿ç”¨ç°æœ‰ç±»çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶åœ¨æ— éœ€é‡æ–°ç¼–å†™åŸæ¥çš„ç±»çš„æƒ…å†µä¸‹å¯¹è¿™äº›åŠŸèƒ½è¿›è¡Œæ‰©å±•ï¼Œæ˜¯ä»£ç å¤ç”¨çš„ä¸€ç§æœºåˆ¶ã€‚</p><p>å¸¸è§çš„ç»§æ‰¿æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p><strong>å®ç°ç»§æ‰¿ï¼š</strong>æŒ‡ä½¿ç”¨åŸºç±»çš„å±æ€§å’Œæ–¹æ³•è€Œæ— éœ€é¢å¤–ç¼–ç çš„èƒ½åŠ›</p><p><strong>æ¥å£ç»§æ‰¿ï¼š</strong>æŒ‡ä»…ä½¿ç”¨å±æ€§å’Œæ–¹æ³•çš„åç§°ã€ä½†æ˜¯å­ç±»å¿…é¡»æä¾›å®ç°çš„èƒ½åŠ›</p><p>(2) <strong>å°è£…</strong></p><p>æ•°æ®å’Œä»£ç æ†ç»‘åœ¨ä¸€èµ·ï¼Œé¿å…å¤–ç•Œå¹²æ‰°å’Œä¸ç¡®å®šæ€§è®¿é—®ã€‚åœ¨C++ä¸­å€Ÿä»¥æƒé™æœºåˆ¶å®ç°è¿™ä¸€ç‰¹æ€§ï¼Œåˆ©ç”¨ä¸‰ç§è®¿é—®æƒé™æ§åˆ¶å¤–ç•Œå¯¹å¯¹è±¡æ•°æ®çš„è®¿é—®ã€‚</p><p>(3) <strong>å¤šæ€</strong></p><p>å¤šæ€æ˜¯åŒä¸€ä¸ªè¡Œä¸ºå…·æœ‰å¤šä¸ªä¸åŒè¡¨ç°å½¢å¼æˆ–å½¢æ€çš„èƒ½åŠ›ã€‚</p><p>å¸¸è§çš„å¤šæ€æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p><strong>ç¼–è¯‘æ—¶å¤šæ€ï¼ˆé‡è½½ï¼‰ï¼š</strong>æ˜¯æŒ‡å…è®¸å­˜åœ¨å¤šä¸ªåŒåå‡½æ•°ï¼Œè€Œè¿™äº›å‡½æ•°çš„å‚æ•°è¡¨ä¸åŒ</p><p><strong>è¿è¡Œæ—¶å¤šæ€ï¼ˆé‡å†™ï¼‰ï¼š</strong>æ˜¯æŒ‡å­ç±»é‡æ–°å®šä¹‰çˆ¶ç±»çš„è™šå‡½æ•°çš„åšæ³•</p><h3 id="49-è¯´è¯´C-çš„å››ç§å¼ºåˆ¶è½¬æ¢ï¼Ÿ"><a href="#49-è¯´è¯´C-çš„å››ç§å¼ºåˆ¶è½¬æ¢ï¼Ÿ" class="headerlink" title="49. è¯´è¯´C++çš„å››ç§å¼ºåˆ¶è½¬æ¢ï¼Ÿ"></a>49. è¯´è¯´C++çš„å››ç§å¼ºåˆ¶è½¬æ¢ï¼Ÿ</h3><p>(1) <strong>reinterpret_castï¼š</strong>reinterpret_cast ç”¨ä»¥å¤„ç†äº’ä¸ç›¸å…³çš„ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œreinterpret_cast æ“ä½œæ‰§è¡Œçš„æ˜¯æ¯”ç‰¹ä½æ‹·è´ï¼Œå³ç¼–è¯‘å™¨ä¸ä¼šåšä»»ä½•æ£€æŸ¥,æˆªæ–­,è¡¥é½çš„æ“ä½œ,åªæ˜¯æŠŠæ¯”ç‰¹ä½æ‹·è´è¿‡å»ã€‚è¿™ç§è½¬æ¢æä¾›äº†å¾ˆå¼ºçš„çµæ´»æ€§ï¼Œä½†è½¬æ¢çš„å®‰å…¨æ€§åªèƒ½ç”±ç¨‹åºå‘˜çš„ç»†å¿ƒæ¥ä¿è¯äº†ã€‚</p><p>(2) <strong>const_castï¼š</strong>è¯¥è¿ç®—ç¬¦ç”¨æ¥ä¿®æ”¹ç±»å‹çš„constå±æ€§ï¼Œå¯ä»¥ä½¿æŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆè¢«è½¬åŒ–æˆæŒ‡å‘éå¸¸é‡çš„æŒ‡é’ˆï¼Œå¹¶ä¸”ä»ç„¶æŒ‡å‘åŸæ¥çš„å¯¹è±¡ï¼Œä½¿æ‹¥æœ‰è€…å¯ä»¥é€šè¿‡æŒ‡é’ˆä¿®æ”¹å¯¹è±¡ã€‚</p><p>(3) <strong>static_castï¼š</strong>static_cast ç”¨äºè¿›è¡Œæ¯”è¾ƒâ€œè‡ªç„¶â€å’Œä½é£é™©çš„è½¬æ¢ï¼Œå¦‚<strong>æ•´å‹å’Œæµ®ç‚¹å‹ã€å­—ç¬¦å‹ä¸æ•´å‹</strong>ä¹‹é—´çš„äº’ç›¸è½¬æ¢ã€‚static_cast <strong>ä¸èƒ½ç”¨äºåœ¨ä¸åŒç±»å‹çš„æŒ‡é’ˆä¹‹é—´äº’ç›¸è½¬æ¢ï¼Œä¹Ÿä¸èƒ½ç”¨äºæ•´å‹å’ŒæŒ‡é’ˆä¹‹é—´çš„äº’ç›¸è½¬æ¢ï¼Œå½“ç„¶ä¹Ÿä¸èƒ½ç”¨äºä¸åŒç±»å‹çš„å¼•ç”¨ä¹‹é—´çš„è½¬æ¢ã€‚</strong>å› ä¸ºè¿™äº›å±äºé£é™©æ¯”è¾ƒé«˜çš„è½¬æ¢ã€‚ä»–çš„å®‰å…¨æ€§æ¯”èµ·reinterpret_cast æ›´é«˜ï¼Œä½†æ˜¯ç”±äºè¯¥æ“ä½œç¬¦æ²¡æœ‰è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥æœºåˆ¶ï¼Œåœ¨è¿›è¡Œä¸‹è¡Œè½¬æ¢ï¼ˆæŠŠåŸºç±»æŒ‡é’ˆæˆ–å¼•ç”¨è½¬æ¢æˆæ´¾ç”Ÿç±»æŒ‡é’ˆæˆ–å¼•ç”¨ï¼‰æ—¶ä»ç„¶æ˜¯ä¸å®‰å…¨çš„ã€‚</p><p>(4) <strong>dynamic_castï¼š</strong>dynamic_castä¸»è¦ç”¨äºç±»å±‚æ¬¡é—´çš„ä¸Šè¡Œè½¬æ¢å’Œä¸‹è¡Œè½¬æ¢ï¼Œå› ä¸ºæœ‰åŠ¨æ€ç±»å‹æ£€æµ‹ï¼Œåœ¨è¿›è¡Œä¸‹è¡Œè½¬æ¢æ—¶æ¯”static_castæ›´å®‰å…¨ã€‚</p><p>ä¸¾ä¾‹</p><p>C++ä¸­æœ‰å››ç§ç±»å‹çš„å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œåˆ†åˆ«æ˜¯ <code>static_cast</code>ï¼Œ<code>dynamic_cast</code>ï¼Œ<code>const_cast</code> å’Œ <code>reinterpret_cast</code>ã€‚</p><ol><li><code>static_cast</code>ï¼šè¿™æ˜¯æœ€å¸¸ç”¨çš„ç±»å‹è½¬æ¢ç¬¦ã€‚å®ƒå¯ä»¥åœ¨ä»»ä½•çš„æ•°æ®ç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œä½†æ˜¯è½¬æ¢çš„ç±»å‹éœ€è¦æ˜¯ç›¸å…³çš„ï¼Œå¦åˆ™å¯èƒ½ä¼šäº§ç”Ÿæ„å¤–çš„ç»“æœã€‚</li></ol><p>ä¾‹å¦‚ï¼Œå°†æ•´æ•°è½¬æ¢ä¸ºæµ®ç‚¹æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="type">float</span> b = <span class="built_in">static_cast</span>&lt;<span class="type">float</span>&gt;(a);  <span class="comment">// b = 10.0</span></span><br></pre></td></tr></table></figure><ol><li><code>dynamic_cast</code>ï¼šè¿™ä¸ªç±»å‹è½¬æ¢ç¬¦ä¸»è¦ç”¨åœ¨ç±»çš„ç»§æ‰¿ä½“ç³»ä¸­ï¼Œç”¨äºè¿›è¡Œä¸Šè¡Œè½¬æ¢å’Œå®‰å…¨çš„ä¸‹è¡Œè½¬æ¢ã€‚å½“æˆ‘ä»¬è¯•å›¾å°†çˆ¶ç±»æŒ‡é’ˆè½¬æ¢ä¸ºå­ç±»æŒ‡é’ˆæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>dynamic_cast</code>ã€‚</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base &#123;&#125;;</span><br><span class="line"></span><br><span class="line">Base* base = <span class="keyword">new</span> <span class="built_in">Derived</span>();</span><br><span class="line">Derived* derived = <span class="built_in">dynamic_cast</span>&lt;Derived*&gt;(base);  <span class="comment">// å®‰å…¨çš„ä¸‹è¡Œè½¬æ¢</span></span><br></pre></td></tr></table></figure><ol><li><code>const_cast</code>ï¼šè¿™ä¸ªç±»å‹è½¬æ¢ç¬¦ç”¨äºç§»é™¤å¸¸é‡æ€§ã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ª <code>const</code> å˜é‡ï¼Œä½†æˆ‘ä»¬éœ€è¦ä¿®æ”¹å®ƒï¼Œå¯ä»¥ä½¿ç”¨ <code>const_cast</code>ã€‚</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="type">int</span>* p = <span class="built_in">const_cast</span>&lt;<span class="type">int</span>*&gt;(&amp;a);</span><br><span class="line">*p = <span class="number">20</span>;  <span class="comment">// aç°åœ¨æ˜¯20ï¼Œä½†è¿™æ ·åšæ˜¯å±é™©çš„ï¼Œå› ä¸ºaæœ¬æ¥æ˜¯constçš„</span></span><br></pre></td></tr></table></figure><ol><li><code>reinterpret_cast</code>ï¼šè¿™ä¸ªç±»å‹è½¬æ¢ç¬¦ç”¨äºè¿›è¡Œä½çº§åˆ«çš„ç±»å‹è½¬æ¢ï¼Œå®ƒå¯ä»¥åœ¨ä»»ä½•æŒ‡é’ˆæˆ–æ•´æ•°ç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ä½†æ˜¯ä½¿ç”¨è¿™ä¸ªè½¬æ¢ç¬¦éœ€è¦éå¸¸å°å¿ƒï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šäº§ç”Ÿæ„å¤–çš„ç»“æœã€‚</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="type">int</span>* p = &amp;a;</span><br><span class="line"><span class="type">char</span>* c = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(p);  <span class="comment">// å°†int*è½¬æ¢ä¸ºchar*</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå°½ç®¡ C++ æä¾›äº†è¿™äº›å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä½†åº”å°½é‡é¿å…ä½¿ç”¨å®ƒä»¬ï¼Œé™¤éä½ éå¸¸ç¡®å®šä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä½¿ç”¨å¼ºåˆ¶ç±»å‹è½¬æ¢å¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚</p><h3 id="50-å¦‚ä½•è·å¾—ç»“æ„æˆå‘˜ç›¸å¯¹äºç»“æ„å¼€å¤´çš„å­—èŠ‚åç§»é‡ï¼Ÿ"><a href="#50-å¦‚ä½•è·å¾—ç»“æ„æˆå‘˜ç›¸å¯¹äºç»“æ„å¼€å¤´çš„å­—èŠ‚åç§»é‡ï¼Ÿ" class="headerlink" title="50. å¦‚ä½•è·å¾—ç»“æ„æˆå‘˜ç›¸å¯¹äºç»“æ„å¼€å¤´çš„å­—èŠ‚åç§»é‡ï¼Ÿ"></a>50. å¦‚ä½•è·å¾—ç»“æ„æˆå‘˜ç›¸å¯¹äºç»“æ„å¼€å¤´çš„å­—èŠ‚åç§»é‡ï¼Ÿ</h3><p>ä½¿ç”¨<stddef.h>å¤´æ–‡ä»¶ä¸­çš„ï¼Œoffsetofå®</p><p>offsetofç”¨æ³•ï¼šoffsetof(S, x)ï¼ŒSä¸ºç»“æ„ä½“å¯¹è±¡ï¼Œxä¸ºç»“æ„ä½“æ•°æ®æˆå‘˜ä¹‹ä¸€</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> offsetof(s, m) (reinterpret_cast<span class="string">&lt;size_t&gt;</span>(&amp;reinterpret_cast<span class="string">&lt;const volatile char&amp;&gt;</span>(static_cast<span class="string">&lt;s*&gt;</span>(nullptr)-&gt;m)))</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">S</span> &#123;</span><br><span class="line">    <span class="type">char</span> a;</span><br><span class="line">    <span class="type">double</span> b;</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;the first element is at offset &quot;</span>&lt;&lt;<span class="built_in">offsetof</span>(<span class="keyword">struct</span> S, a)&lt;&lt;std::endl;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;the second is at offset &quot;</span>&lt;&lt;<span class="built_in">offsetof</span>(<span class="keyword">struct</span> S, b)&lt;&lt;std::endl;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;the third element is at offset &quot;</span>&lt;&lt;<span class="built_in">offsetof</span>(<span class="keyword">struct</span> S, c)&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£é‡Š</strong></p><p>æ­¤å¤„ï¼Œé€šè¿‡ <code>static_cast&lt;s*&gt;(nullptr)</code>ï¼Œç¼–è¯‘å™¨ç›¸ä¿¡åœ¨ <code>nullptr</code> å¤„ï¼ˆ<code>0x0</code>ï¼‰æœ‰ä¸€ä¸ªçœŸå®å­˜åœ¨çš„ <code>s</code> ç±»å‹çš„å¯¹è±¡ã€‚</p><p>æ­¤å¤„ä½¿ç”¨ <code>static_cast</code> è€Œé <code>reinterpret_cast</code> æ˜¯å› ä¸º C++ æ ‡å‡†ä¸å…è®¸å°† <code>nullptr</code> é€šè¿‡ <code>reinterpret_cast</code> è½¬æ¢æˆå…¶ä»–ç±»å‹çš„æŒ‡é’ˆï¼›</p><p>æ­¤ç±»è½¬æ¢åº”ç”¨ <code>static_cast</code>ã€‚ç”±äº <code>static_cast&lt;s*&gt;(nullptr)</code> è¿”å›æŒ‡å‘ <code>s</code> ç±»å‹å¯¹è±¡çš„æŒ‡é’ˆï¼Œå› æ­¤ <code>static_cast&lt;s*&gt;(nullptr)-&gt;m</code> å°±æ˜¯ä¸€ä¸ªè™šæ‹Ÿä½†åœ¨ç¼–è¯‘å™¨çœ‹æ¥å¯ç”¨çš„æˆå‘˜å˜é‡ <code>m</code>ã€‚</p><p>ä¸ºäº†æ±‚å¾—ä»¥å­—èŠ‚ä¸ºå•ä½çš„ <code>ptrdiff_t</code>ï¼Œå®ç°ä¸­é€šè¿‡ <code>&amp;reinterpret_cast&lt;const volatile char&amp;&gt;(static_cast&lt;s*&gt;(nullptr)-&gt;m)</code> è·å¾—ä¸€ä¸ª <code>const volatile char*</code> ç±»å‹çš„å˜é‡ã€‚</p><p>ç”±äºåœ¨è¯¥å®ç°ä¸­ï¼Œè™šæ‹Ÿçš„å˜é‡ä½äº <code>0x0</code> ä½ç½®ï¼Œæ•…è€Œ <code>&amp;reinterpret_cast&lt;const volatile char&amp;&gt;(static_cast&lt;s*&gt;(nullptr)-&gt;m)</code> å³æ˜¯ <code>m</code> åœ¨ <code>s</code> ç±»å‹å¯¹è±¡å½“ä¸­ç›¸å¯¹å¯¹è±¡èµ·å§‹åœ°å€çš„åç§»é‡ã€‚</p><p>æœ€åï¼Œåªéœ€å°†å®ƒè½¬æ¢ä¸º <code>size_t</code> ç±»å‹çš„å€¼å³å¯ã€‚</p><p>å…·ä½“ï¼š<a href="https://zhuanlan.zhihu.com/p/677486774">ç†è§£C/C++ ä¸­çš„offsetof å®åŸç†</a></p><h3 id="51-é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹ï¼Œé™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šçš„ä»‹ç»ï¼Ÿ"><a href="#51-é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹ï¼Œé™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šçš„ä»‹ç»ï¼Ÿ" class="headerlink" title="51. é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹ï¼Œé™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šçš„ä»‹ç»ï¼Ÿ"></a>51. é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹ï¼Œé™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šçš„ä»‹ç»ï¼Ÿ</h3><p>(1) é™æ€ç±»å‹ï¼šå¯¹è±¡åœ¨å£°æ˜æ—¶é‡‡ç”¨çš„ç±»å‹ï¼Œåœ¨ç¼–è¯‘æœŸæ—¢å·²ç¡®å®šï¼›</p><p>(2) åŠ¨æ€ç±»å‹ï¼šé€šå¸¸æ˜¯æŒ‡ä¸€ä¸ªæŒ‡é’ˆæˆ–å¼•ç”¨ç›®å‰æ‰€æŒ‡å¯¹è±¡çš„ç±»å‹ï¼Œæ˜¯åœ¨è¿è¡ŒæœŸå†³å®šçš„ï¼›</p><p>(3) é™æ€ç»‘å®šï¼šç»‘å®šçš„æ˜¯é™æ€ç±»å‹ï¼Œæ‰€å¯¹åº”çš„å‡½æ•°æˆ–å±æ€§ä¾èµ–äºå¯¹è±¡çš„é™æ€ç±»å‹ï¼Œå‘ç”Ÿåœ¨ç¼–è¯‘æœŸï¼›</p><p>(4) åŠ¨æ€ç»‘å®šï¼šç»‘å®šçš„æ˜¯åŠ¨æ€ç±»å‹ï¼Œæ‰€å¯¹åº”çš„å‡½æ•°æˆ–å±æ€§ä¾èµ–äºå¯¹è±¡çš„åŠ¨æ€ç±»å‹ï¼Œå‘ç”Ÿåœ¨è¿è¡ŒæœŸï¼›</p><h3 id="52-å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#52-å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="52. å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>52. å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><p>(1) ç”Ÿå‘½å‘¨æœŸï¼šå…¨å±€å˜é‡éšä¸»ç¨‹åºåˆ›å»ºå’Œåˆ›å»ºï¼Œéšä¸»ç¨‹åºé”€æ¯è€Œé”€æ¯ï¼›å±€éƒ¨å˜é‡åœ¨å±€éƒ¨å‡½æ•°å†…éƒ¨ï¼Œç”šè‡³å±€éƒ¨å¾ªç¯ä½“ç­‰å†…éƒ¨å­˜åœ¨ï¼Œé€€å‡ºå°±ä¸å­˜åœ¨ï¼›</p><p>(2) ä½œç”¨åŸŸï¼šé€šè¿‡å£°æ˜åå…¨å±€å˜é‡åœ¨ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†éƒ½å¯ä»¥ç”¨åˆ°ï¼›å±€éƒ¨å˜é‡åˆ†é…åœ¨å †æ ˆåŒºï¼Œåªèƒ½åœ¨å±€éƒ¨ä½¿ç”¨</p><h3 id="53-æŒ‡é’ˆåŠ å‡è®¡ç®—è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ"><a href="#53-æŒ‡é’ˆåŠ å‡è®¡ç®—è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ" class="headerlink" title="53. æŒ‡é’ˆåŠ å‡è®¡ç®—è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ"></a>53. æŒ‡é’ˆåŠ å‡è®¡ç®—è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ</h3><p>æŒ‡é’ˆåŠ å‡æœ¬è´¨æ˜¯å¯¹å…¶æ‰€æŒ‡åœ°å€çš„ç§»åŠ¨ï¼Œç§»åŠ¨çš„æ­¥é•¿è·ŸæŒ‡é’ˆçš„ç±»å‹æ˜¯æœ‰å…³ç³»çš„ï¼Œå› æ­¤åœ¨æ¶‰åŠåˆ°æŒ‡é’ˆåŠ å‡è¿ç®—éœ€è¦ååˆ†å°å¿ƒï¼ŒåŠ å¤šæˆ–è€…å‡å¤šéƒ½ä¼šå¯¼è‡´æŒ‡é’ˆæŒ‡å‘ä¸€å—æœªçŸ¥çš„å†…å­˜åœ°å€ï¼Œå³å†…å­˜è¶Šç•Œã€‚</p><h3 id="54-æ€æ ·åˆ¤æ–­ä¸¤ä¸ªæµ®ç‚¹æ•°æ˜¯å¦ç›¸ç­‰ï¼Ÿ"><a href="#54-æ€æ ·åˆ¤æ–­ä¸¤ä¸ªæµ®ç‚¹æ•°æ˜¯å¦ç›¸ç­‰ï¼Ÿ" class="headerlink" title="54. æ€æ ·åˆ¤æ–­ä¸¤ä¸ªæµ®ç‚¹æ•°æ˜¯å¦ç›¸ç­‰ï¼Ÿ"></a>54. æ€æ ·åˆ¤æ–­ä¸¤ä¸ªæµ®ç‚¹æ•°æ˜¯å¦ç›¸ç­‰ï¼Ÿ</h3><p>å¯¹ä¸¤ä¸ªæµ®ç‚¹æ•°åˆ¤æ–­æ˜¯å¦ç›¸ç­‰ä¸èƒ½ç›´æ¥ç”¨==æ¥åˆ¤æ–­ï¼Œä¼šå‡ºé”™ï¼æ˜æ˜ç›¸ç­‰çš„ä¸¤ä¸ªæ•°æ¯”è¾ƒåè€Œæ˜¯ä¸ç›¸ç­‰ï¼å¯¹äºä¸¤ä¸ªæµ®ç‚¹æ•°æ¯”è¾ƒåªèƒ½é€šè¿‡ç›¸å‡å¹¶ä¸é¢„å…ˆè®¾å®šçš„ç²¾åº¦æ¯”è¾ƒï¼Œè®°å¾—è¦å–ç»å¯¹å€¼ï¼</p><h3 id="55-ç±»å¦‚ä½•å®ç°åªèƒ½é™æ€åˆ†é…å’Œåªèƒ½åŠ¨æ€åˆ†é…ï¼Ÿ"><a href="#55-ç±»å¦‚ä½•å®ç°åªèƒ½é™æ€åˆ†é…å’Œåªèƒ½åŠ¨æ€åˆ†é…ï¼Ÿ" class="headerlink" title="55. ç±»å¦‚ä½•å®ç°åªèƒ½é™æ€åˆ†é…å’Œåªèƒ½åŠ¨æ€åˆ†é…ï¼Ÿ"></a>55. ç±»å¦‚ä½•å®ç°åªèƒ½é™æ€åˆ†é…å’Œåªèƒ½åŠ¨æ€åˆ†é…ï¼Ÿ</h3><p>(1) å®ç°åªèƒ½é™æ€åˆ†é…ï¼šæŠŠoperator newè¿ç®—ç¬¦é‡è½½ä¸ºprivateå±æ€§ã€‚</p><p>(2) å®ç°åªèƒ½åŠ¨æ€åˆ†é…ï¼šæŠŠæ„é€ å‡½æ•°è®¾ä¸ºprivateå±æ€§</p><h3 id="56-çŸ¥é“C-ä¸­çš„ç»„åˆå—-å®ƒä¸ç»§æ‰¿ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹å—ï¼Ÿ"><a href="#56-çŸ¥é“C-ä¸­çš„ç»„åˆå—-å®ƒä¸ç»§æ‰¿ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹å—ï¼Ÿ" class="headerlink" title="56. çŸ¥é“C++ä¸­çš„ç»„åˆå—?å®ƒä¸ç»§æ‰¿ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹å—ï¼Ÿ"></a>56. çŸ¥é“C++ä¸­çš„ç»„åˆå—?å®ƒä¸ç»§æ‰¿ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹å—ï¼Ÿ</h3><p>ç»§æ‰¿æœ‰ä»¥ä¸‹å‡ ä¸ªç¼ºç‚¹ï¼š</p><p>(1) çˆ¶ç±»çš„å†…éƒ¨ç»†èŠ‚å¯¹å­ç±»æ˜¯å¯è§çš„ï¼Œç ´åäº†å°è£…æ€§ã€‚</p><p>(2) å­ç±»ä»çˆ¶ç±»ç»§æ‰¿çš„æ–¹æ³•åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šä¸‹æ¥äº†ï¼Œæ‰€ä»¥æ— æ³•åœ¨è¿è¡ŒæœŸé—´æ”¹å˜ä»çˆ¶ç±»ç»§æ‰¿çš„æ–¹æ³•çš„è¡Œä¸ºã€‚</p><p>(3) å­ç±»ä¸çˆ¶ç±»æ˜¯ä¸€ç§é«˜è€¦åˆï¼Œè¿èƒŒäº†é¢å‘å¯¹è±¡æ€æƒ³ã€‚</p><p>ä½¿ç”¨ç»„åˆçš„ç›®çš„å³ä¸ºäº†å…‹æœè¿™å‡ ä¸ªç¼ºç‚¹ï¼Œä½†ä¹Ÿå› æ­¤äº§ç”Ÿäº†å¦ä¸€äº›ç¼ºç‚¹ï¼Œå¦‚ï¼šå®¹æ˜“äº§ç”Ÿè¿‡å¤šçš„å¯¹è±¡ã€ä¸ºäº†èƒ½ç»„åˆå¤šä¸ªå¯¹è±¡ï¼Œå¿…é¡»ä»”ç»†å¯¹æ¥å£è¿›è¡Œå®šä¹‰ã€‚</p><h3 id="57-ä¸ºä»€ä¹ˆæ¨¡æ¿ç±»ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­ï¼Ÿ"><a href="#57-ä¸ºä»€ä¹ˆæ¨¡æ¿ç±»ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­ï¼Ÿ" class="headerlink" title="57. ä¸ºä»€ä¹ˆæ¨¡æ¿ç±»ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­ï¼Ÿ"></a>57. ä¸ºä»€ä¹ˆæ¨¡æ¿ç±»ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­ï¼Ÿ</h3><p>æ¨¡æ¿å®šä¹‰å¾ˆç‰¹æ®Šï¼Œç¼–è¯‘å™¨åœ¨é‡åˆ°ä»»ä½•çš„æ¨¡æ¿å®šä¹‰æ—¶ä¸ä¼šä¸ºå®ƒåˆ†é…å†…å­˜ç©ºé—´ï¼Œå®ƒä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«ä¸€ä¸ªæ¨¡æ¿å®ä¾‹å‘ŠçŸ¥æ‰ä¼šåˆ†é…å†…å­˜ç©ºé—´ã€‚å¦‚æœåœ¨åˆ†ç¦»å¼ç¼–è¯‘ç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ç¼–è¯‘æŸä¸€ä¸ªæºæ–‡ä»¶æ—¶å¹¶ä¸çŸ¥é“å¦ä¸€ä¸ªæºæ–‡ä»¶çš„å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šå»æŸ¥æ‰¾ï¼ˆå½“é‡åˆ°æœªå†³ç¬¦å·æ—¶å®ƒä¼šå¯„å¸Œæœ›äºè¿æ¥å™¨ï¼‰ï¼ŒåŒæ—¶ç”±äºæ¨¡æ¿å®šä¹‰æ²¡æœ‰è¢«åˆ†é…ç©ºé—´ï¼Œé“¾æ¥å™¨ä¹Ÿæ— æ³•æŸ¥æ‰¾åˆ°å‡½æ•°çš„å…¥å£åœ°å€ã€‚</p><h3 id="58-ä½ äº†è§£é‡è½½è¿ç®—ç¬¦å—ï¼Ÿ"><a href="#58-ä½ äº†è§£é‡è½½è¿ç®—ç¬¦å—ï¼Ÿ" class="headerlink" title="58. ä½ äº†è§£é‡è½½è¿ç®—ç¬¦å—ï¼Ÿ"></a>58. ä½ äº†è§£é‡è½½è¿ç®—ç¬¦å—ï¼Ÿ</h3><p>C++é¢„å®šä¹‰ä¸­çš„è¿ç®—ç¬¦çš„æ“ä½œå¯¹è±¡åªå±€é™äºåŸºæœ¬çš„å†…ç½®æ•°æ®ç±»å‹ï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»å‹ï¼ˆç±»ï¼‰æ˜¯æ²¡æœ‰åŠæ³•æ“ä½œçš„ã€‚ä½†æ˜¯å¤§å¤šæ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹æˆ‘ä»¬å®šä¹‰çš„ç±»å‹è¿›è¡Œç±»ä¼¼çš„è¿ç®—ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æˆ‘ä»¬å¯¹è¿™ä¹ˆè¿ç®—ç¬¦è¿›è¡Œé‡æ–°å®šä¹‰ï¼Œèµ‹äºˆå…¶æ–°çš„åŠŸèƒ½ï¼Œä»¥æ»¡è¶³è‡ªèº«çš„éœ€æ±‚ã€‚<strong>è¿™å°±æ˜¯è¿ç®—ç¬¦é‡è½½ï¼Œå®ƒçš„å®è´¨å°±æ˜¯å‡½æ•°é‡è½½ã€‚</strong></p><p>è¿ç®—ç¬¦é‡è½½è§„åˆ™ï¼š</p><p>(1) ä¸ºäº†é˜²æ­¢ç”¨æˆ·å¯¹æ ‡å‡†ç±»å‹è¿›è¡Œè¿ç®—ç¬¦é‡è½½ï¼ŒC++è§„å®šé‡è½½åçš„è¿ç®—ç¬¦çš„æ“ä½œå¯¹è±¡å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ç”¨æˆ·å®šä¹‰çš„ç±»å‹ã€‚</p><p>(2) ä½¿ç”¨è¿ç®—ç¬¦ä¸èƒ½è¿æ³•è¿ç®—ç¬¦åŸæ¥çš„å¥æ³•è§„åˆ™ã€‚å¦‚ä¸èƒ½å°†â€˜+â€™é‡è½½ä¸ºä¸€ä¸ªæ“ä½œæ•°ã€‚</p><p>(3) ä¸èƒ½ä¿®æ”¹è¿ç®—ç¬¦åŸå…ˆçš„ä¼˜å…ˆçº§ã€‚</p><p>(4) ä¸èƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„è¿ç®—ç¬¦</p><p>(5) ä¸èƒ½è¿›è¡Œé‡è½½çš„è¿ç®—ç¬¦ï¼šæˆå‘˜è¿ç®—ç¬¦ï¼Œä½œç”¨åŸŸè¿ç®—ç¬¦ï¼Œæ¡ä»¶è¿ç®—ç¬¦ï¼Œsizeofè¿ç®—ç¬¦ï¼Œtypeidè¿ç®—ç¬¦ï¼Œconst_castã€dynamic_castã€reinterpret_castã€static_castå¼ºåˆ¶ç±»å‹è½¬æ¢è¿ç®—ç¬¦ã€‚</p><p>(6) å¤§å¤šæ•°è¿ç®—ç¬¦å¯ä»¥é€šè¿‡æˆå‘˜å‡½æ•°å’Œéæˆå‘˜å‡½æ•°è¿›è¡Œé‡è½½ï¼Œä½†æ˜¯ä¸‹é¢è¿™å››ç§è¿ç®—ç¬¦åªèƒ½é€šè¿‡æˆå‘˜å‡½æ•°è¿›è¡Œé‡è½½ï¼š= èµ‹å€¼è¿ç®—ç¬¦ï¼Œï¼ˆï¼‰å‡½æ•°è°ƒç”¨è¿ç®—ç¬¦ï¼Œ[ ]ä¸‹æ ‡è¿ç®—ç¬¦ï¼Œ-&gt;é€šè¿‡æŒ‡é’ˆè®¿é—®ç±»æˆå‘˜çš„è¿ç®—ç¬¦ã€‚</p><p>(7) ä¸€èˆ¬æ¥è¯´ï¼Œå•ç›®è¿ç®—ç¬¦é‡è½½ä¸ºç±»çš„æˆå‘˜å‡½æ•°ï¼ŒåŒç›®è¿ç®—ç¬¦é‡è½½ä¸ºç±»çš„å‹å…ƒå‡½æ•°</p><h3 id="59-å‰-å’Œå-é‡è½½çš„åŒºåˆ«ï¼Ÿ"><a href="#59-å‰-å’Œå-é‡è½½çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="59. å‰++å’Œå++é‡è½½çš„åŒºåˆ«ï¼Ÿ"></a>59. å‰++å’Œå++é‡è½½çš„åŒºåˆ«ï¼Ÿ</h3><p>(1) å‰++é‡è½½å‡½æ•°å‚æ•°åˆ—è¡¨ä¸éœ€è¦å¸¦å‚æ•°ï¼Œå++å‚æ•°åˆ—è¡¨éœ€è¦å¸¦å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ä»…ä»…åªæ˜¯åŒºåˆ†å‰++å’Œå++ç”¨ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ã€‚</p><p>(2) å‰++è¿”å›ä¸€ä¸ªå¼•ç”¨ï¼Œå++è¿”å›ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œå++æ•ˆç‡æ¯”è¾ƒé«˜ã€‚</p><h3 id="60-å½“ç¨‹åºä¸­æœ‰å‡½æ•°é‡è½½æ—¶ï¼Œå‡½æ•°çš„åŒ¹é…åŸåˆ™å’Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#60-å½“ç¨‹åºä¸­æœ‰å‡½æ•°é‡è½½æ—¶ï¼Œå‡½æ•°çš„åŒ¹é…åŸåˆ™å’Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="60. å½“ç¨‹åºä¸­æœ‰å‡½æ•°é‡è½½æ—¶ï¼Œå‡½æ•°çš„åŒ¹é…åŸåˆ™å’Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ"></a>60. å½“ç¨‹åºä¸­æœ‰å‡½æ•°é‡è½½æ—¶ï¼Œå‡½æ•°çš„åŒ¹é…åŸåˆ™å’Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>(1) åå­—æŸ¥æ‰¾</p><p>(2) ç¡®å®šå€™é€‰å‡½æ•°</p><p>(3) å¯»æ‰¾æœ€ä½³åŒ¹é…</p><h3 id="61-æ¡ä»¶ç¼–è¯‘çš„ä½œç”¨ï¼Ÿ"><a href="#61-æ¡ä»¶ç¼–è¯‘çš„ä½œç”¨ï¼Ÿ" class="headerlink" title="61. æ¡ä»¶ç¼–è¯‘çš„ä½œç”¨ï¼Ÿ"></a>61. æ¡ä»¶ç¼–è¯‘çš„ä½œç”¨ï¼Ÿ</h3><p>(1) ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæºç¨‹åºä¸­æ‰€æœ‰çš„è¡Œéƒ½å‚åŠ ç¼–è¯‘ã€‚ä½†æ˜¯æœ‰æ—¶å¸Œæœ›å¯¹å…¶ä¸­ä¸€éƒ¨åˆ†å†…å®¹åªåœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶æ‰è¿›è¡Œç¼–è¯‘ï¼Œä¹Ÿå°±æ˜¯å¯¹ä¸€éƒ¨åˆ†å†…å®¹æŒ‡å®šç¼–è¯‘çš„æ¡ä»¶ï¼Œè¿™å°±æ˜¯â€œæ¡ä»¶ç¼–è¯‘â€<strong>ã€‚</strong></p><p>(2) åœ¨ä¸€ä¸ªå¤§çš„è½¯ä»¶å·¥ç¨‹é‡Œé¢ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªæ–‡ä»¶åŒæ—¶åŒ…å«ä¸€ä¸ªå¤´æ–‡ä»¶ï¼Œå½“è¿™äº›æ–‡ä»¶ç¼–è¯‘é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸Šæ—¶ï¼Œå°±ä¼šå‡ºç°å¤§é‡â€œé‡å®šä¹‰â€é”™è¯¯ã€‚åœ¨å¤´æ–‡ä»¶ä¸­ä½¿ç”¨æ¡ä»¶ç¼–è¯‘å³å¯é¿å…è¯¥é”™è¯¯ã€‚</p><h3 id="62-éšå¼è½¬æ¢æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•æ¶ˆé™¤ç±»çš„éšå¼è½¬æ¢ï¼Ÿ"><a href="#62-éšå¼è½¬æ¢æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•æ¶ˆé™¤ç±»çš„éšå¼è½¬æ¢ï¼Ÿ" class="headerlink" title="62. éšå¼è½¬æ¢æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•æ¶ˆé™¤ç±»çš„éšå¼è½¬æ¢ï¼Ÿ"></a>62. éšå¼è½¬æ¢æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•æ¶ˆé™¤ç±»çš„éšå¼è½¬æ¢ï¼Ÿ</h3><p>(1) C++çš„åŸºæœ¬ç±»å‹ä¸­å¹¶éå®Œå…¨çš„å¯¹ç«‹ï¼Œéƒ¨åˆ†æ•°æ®ç±»å‹ä¹‹é—´æ˜¯å¯ä»¥è¿›è¡Œéšå¼è½¬æ¢çš„ã€‚æ‰€è°“éšå¼è½¬æ¢ï¼Œæ˜¯æŒ‡ä¸éœ€è¦ç”¨æˆ·å¹²é¢„ï¼Œç¼–è¯‘å™¨ç§ä¸‹è¿›è¡Œçš„ç±»å‹è½¬æ¢è¡Œä¸ºã€‚å¾ˆå¤šæ—¶å€™ç”¨æˆ·å¯èƒ½éƒ½ä¸çŸ¥é“è¿›è¡Œäº†å“ªäº›è½¬æ¢ã€‚<strong>æœ€å¸¸è§çš„éšå¼è½¬æ¢ä¸ºå‡½æ•°ä¼ å‚ã€‚</strong></p><p>(2) C++ä¸­æä¾›äº†explicitå…³é”®å­—ï¼Œåœ¨æ„é€ å‡½æ•°å£°æ˜çš„æ—¶å€™åŠ ä¸Šexplicitå…³é”®å­—ï¼Œèƒ½å¤Ÿç¦æ­¢éšå¼è½¬æ¢ã€‚</p><h3 id="63-å¦‚ä½•åœ¨ä¸ä½¿ç”¨é¢å¤–ç©ºé—´çš„æƒ…å†µä¸‹ï¼Œäº¤æ¢ä¸¤ä¸ªæ•°ï¼Ÿ"><a href="#63-å¦‚ä½•åœ¨ä¸ä½¿ç”¨é¢å¤–ç©ºé—´çš„æƒ…å†µä¸‹ï¼Œäº¤æ¢ä¸¤ä¸ªæ•°ï¼Ÿ" class="headerlink" title="63. å¦‚ä½•åœ¨ä¸ä½¿ç”¨é¢å¤–ç©ºé—´çš„æƒ…å†µä¸‹ï¼Œäº¤æ¢ä¸¤ä¸ªæ•°ï¼Ÿ"></a>63. å¦‚ä½•åœ¨ä¸ä½¿ç”¨é¢å¤–ç©ºé—´çš„æƒ…å†µä¸‹ï¼Œäº¤æ¢ä¸¤ä¸ªæ•°ï¼Ÿ</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(1)</span><br><span class="line"><span class="attribute">x</span>=x+y</span><br><span class="line"><span class="attribute">y</span>=x-y</span><br><span class="line"><span class="attribute">x</span>=x-y</span><br><span class="line">(2)</span><br><span class="line"><span class="attribute">x</span>=x^y</span><br><span class="line"><span class="attribute">y</span>=x^y</span><br><span class="line"><span class="attribute">x</span>=x&amp;y</span><br></pre></td></tr></table></figure><h3 id="64-ä½ çŸ¥é“strcpyå’Œmemcpyçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#64-ä½ çŸ¥é“strcpyå’Œmemcpyçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="64. ä½ çŸ¥é“strcpyå’Œmemcpyçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"></a>64. ä½ çŸ¥é“strcpyå’Œmemcpyçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>(1) <strong>å¤åˆ¶çš„å†…å®¹ä¸åŒã€‚</strong>strcpyåªèƒ½å¤åˆ¶å­—ç¬¦ä¸²ï¼Œè€Œmemcpyå¯ä»¥å¤åˆ¶ä»»æ„å†…å®¹ï¼Œä¾‹å¦‚å­—ç¬¦æ•°ç»„ã€æ•´å‹ã€ç»“æ„ä½“ã€ç±»å¯¹è±¡ç­‰ã€‚</p><p>(2) <strong>å¤åˆ¶çš„æ–¹æ³•ä¸åŒã€‚</strong>strcpyä¸éœ€è¦æŒ‡å®šé•¿åº¦ï¼Œå®ƒé‡åˆ°è¢«å¤åˆ¶å­—ç¬¦ä¸²çš„ç»“æŸç¬¦â€\0â€æ‰ç»“æŸï¼Œæ‰€ä»¥å®¹æ˜“æº¢å‡ºã€‚memcpyåˆ™æ˜¯æ ¹æ®å…¶ç¬¬3ä¸ªå‚æ•°å†³å®šå¤åˆ¶çš„é•¿åº¦ï¼Œæ›´åŠ å®‰å…¨ã€‚</p><p>(3) <strong>ç”¨é€”ä¸åŒã€‚</strong>é€šå¸¸åœ¨å¤åˆ¶å­—ç¬¦ä¸²æ—¶ç”¨strcpyï¼Œè€Œéœ€è¦å¤åˆ¶å…¶ä»–ç±»å‹æ•°æ®æ—¶åˆ™ä¸€èˆ¬ç”¨memcpyã€‚</p><h3 id="65-å¦‚æœæœ‰ä¸€ä¸ªç©ºç±»ï¼Œå®ƒä¼šé»˜è®¤æ·»åŠ å“ªäº›å‡½æ•°ï¼Ÿ"><a href="#65-å¦‚æœæœ‰ä¸€ä¸ªç©ºç±»ï¼Œå®ƒä¼šé»˜è®¤æ·»åŠ å“ªäº›å‡½æ•°ï¼Ÿ" class="headerlink" title="65. å¦‚æœæœ‰ä¸€ä¸ªç©ºç±»ï¼Œå®ƒä¼šé»˜è®¤æ·»åŠ å“ªäº›å‡½æ•°ï¼Ÿ"></a>65. å¦‚æœæœ‰ä¸€ä¸ªç©ºç±»ï¼Œå®ƒä¼šé»˜è®¤æ·»åŠ å“ªäº›å‡½æ•°ï¼Ÿ</h3><p>(1) é»˜è®¤æ„é€ å‡½æ•°</p><p>(2) æ‹·è´æ„é€ å‡½æ•°</p><p>(3) ææ„å‡½æ•°</p><p>(4) èµ‹å€¼è¿ç®—ç¬¦å‡½æ•°</p><h3 id="66-static-castæ¯”Cè¯­è¨€ä¸­çš„è½¬æ¢å¼ºåœ¨å“ªé‡Œï¼Ÿ"><a href="#66-static-castæ¯”Cè¯­è¨€ä¸­çš„è½¬æ¢å¼ºåœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="66. static_castæ¯”Cè¯­è¨€ä¸­çš„è½¬æ¢å¼ºåœ¨å“ªé‡Œï¼Ÿ"></a>66. static_castæ¯”Cè¯­è¨€ä¸­çš„è½¬æ¢å¼ºåœ¨å“ªé‡Œï¼Ÿ</h3><p>(1) æ›´åŠ å®‰å…¨</p><p>(2) æ›´ç›´æ¥æ˜æ˜¾ï¼Œèƒ½å¤Ÿä¸€çœ¼çœ‹å‡ºæ˜¯ä»€ä¹ˆç±»å‹è½¬æ¢ä¸ºä»€ä¹ˆç±»å‹ï¼Œå®¹æ˜“æ‰¾å‡ºç¨‹åºä¸­çš„é”™è¯¯</p><h3 id="67-æˆå‘˜å‡½æ•°é‡Œmemset-this-0-sizeof-this-ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"><a href="#67-æˆå‘˜å‡½æ•°é‡Œmemset-this-0-sizeof-this-ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ" class="headerlink" title="67. æˆå‘˜å‡½æ•°é‡Œmemset(this,0,sizeof(*this))ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"></a>67. æˆå‘˜å‡½æ•°é‡Œmemset(this,0,sizeof(*this))ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h3><p>æœ‰æ—¶å€™ç±»é‡Œé¢å®šä¹‰äº†å¾ˆå¤šint,char,structç­‰cè¯­è¨€é‡Œçš„é‚£äº›ç±»å‹çš„å˜é‡ï¼Œæˆ‘ä¹ æƒ¯åœ¨æ„é€ å‡½æ•°ä¸­å°†å®ƒä»¬åˆå§‹åŒ–ä¸º0ï¼Œä½†æ˜¯ä¸€å¥å¥çš„å†™å¤ªéº»çƒ¦ï¼Œæ‰€ä»¥ç›´æ¥å°±memset(this, 0, sizeof *this);å°†æ•´ä¸ªå¯¹è±¡çš„å†…å­˜å…¨éƒ¨ç½®ä¸º0ã€‚</p><p><strong>å¯¹äºè¿™ç§æƒ…å½¢å¯ä»¥å¾ˆå¥½çš„å·¥ä½œï¼Œä½†æ˜¯ä¸‹é¢å‡ ç§æƒ…å½¢æ˜¯ä¸å¯ä»¥è¿™ä¹ˆä½¿ç”¨çš„ï¼›</strong></p><p>(1) ç±»å«æœ‰è™šå‡½æ•°è¡¨ï¼šè¿™ä¹ˆåšä¼šç ´åè™šå‡½æ•°è¡¨ï¼Œåç»­å¯¹è™šå‡½æ•°çš„è°ƒç”¨éƒ½å°†å‡ºç°å¼‚å¸¸ï¼›</p><p>(2) ç±»ä¸­å«æœ‰C++ç±»å‹çš„å¯¹è±¡ï¼šä¾‹å¦‚ï¼Œç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªlistçš„å¯¹è±¡ï¼Œç”±äºåœ¨æ„é€ å‡½æ•°ä½“çš„ä»£ç æ‰§è¡Œä¹‹å‰å°±å¯¹listå¯¹è±¡å®Œæˆäº†åˆå§‹åŒ–ï¼Œå‡è®¾liståœ¨å®ƒçš„æ„é€ å‡½æ•°é‡Œåˆ†é…äº†å†…å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™ä¹ˆä¸€åšå°±ç ´åäº†listå¯¹è±¡çš„å†…å­˜ã€‚</p><h3 id="68-ä½ çŸ¥é“å›è°ƒå‡½æ•°å—-å®ƒçš„ä½œç”¨ï¼Ÿ"><a href="#68-ä½ çŸ¥é“å›è°ƒå‡½æ•°å—-å®ƒçš„ä½œç”¨ï¼Ÿ" class="headerlink" title="68. ä½ çŸ¥é“å›è°ƒå‡½æ•°å—?å®ƒçš„ä½œç”¨ï¼Ÿ"></a>68. ä½ çŸ¥é“å›è°ƒå‡½æ•°å—?å®ƒçš„ä½œç”¨ï¼Ÿ</h3><p>(1) å›è°ƒå‡½æ•°å°±æ˜¯ä¸€ä¸ªé€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨çš„å‡½æ•°ã€‚å›è°ƒçš„å‡½æ•°çš„å®šä¹‰ç”±ç¨‹åºå‘˜å®ç°ï¼Œä½†æ— éœ€ç¨‹åºå‘˜è°ƒç”¨ï¼Œå¯å°†å‡½æ•°æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ é€’ç»™æŸä¸ªå‡½æ•°åº“ä¸­çš„å‡½æ•°ï¼Œç”±å‡½æ•°åº“å»è°ƒç”¨ã€‚</p><p>(2) å›è°ƒå‡½æ•°æ˜¯åœ¨<strong>â€œä½ æƒ³è®©åˆ«äººçš„ä»£ç æ‰§è¡Œä½ çš„ä»£ç ï¼Œè€Œåˆ«äººçš„ä»£ç ä½ åˆä¸èƒ½åŠ¨â€</strong>è¿™ç§éœ€æ±‚ä¸‹äº§ç”Ÿçš„ã€‚</p><p>(3) å¯ä»¥åšå›è°ƒå‡½æ•°çš„å‡½æ•°æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ™®é€šå‡½æ•°ï¼Œä¸€ç§æ˜¯é™æ€æˆå‘˜å‡½æ•°ã€‚<strong>æ™®é€šæˆå‘˜å‡½æ•°ä¸èƒ½åšå›è°ƒå‡½æ•°</strong>ï¼Œå› ä¸ºæ™®é€šæˆå‘˜å‡½æ•°è‡ªå¸¦thisæŒ‡é’ˆå‚æ•°ï¼Œä¼šå¯¼è‡´å‡½æ•°å£°æ˜ä¸è°ƒç”¨ä¸åŒ¹é…çš„æƒ…å†µå‘ç”Ÿã€‚</p><p>(4) å›è°ƒå‡½æ•°æ˜¯ä¸€ç§è®¾è®¡ç³»ç»Ÿçš„æ€æƒ³ï¼Œèƒ½å¤Ÿè§£å†³ç³»ç»Ÿæ¶æ„ä¸­çš„éƒ¨åˆ†é—®é¢˜ï¼Œä½†æ˜¯ç³»ç»Ÿä¸­ä¸èƒ½è¿‡å¤šä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œå› ä¸ºå›è°ƒå‡½æ•°ä¼šæ”¹å˜æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œè½¨è¿¹å’Œæ‰§è¡Œé¡ºåºï¼Œè€—è´¹èµ„æºï¼Œè€Œä¸”ä¼šä½¿å¾—ä»£ç æ™¦æ¶©éš¾æ‡‚ã€‚</p><p><strong>å›è°ƒå‡½æ•°çš„æœ¬è´¨ç¡®å®æ˜¯å‡½æ•°æŒ‡é’ˆã€‚é€šè¿‡å‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥å°†å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œå›è°ƒâ€ã€‚</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//typedef int(*callback)(int);//å®šä¹‰å›è°ƒå‡½æ•°çš„åŸå‹ï¼ˆæ¥æ”¶å‚æ•°ã€è¿”å›å€¼ã€åç§°ç­‰ï¼‰</span></span><br><span class="line"><span class="keyword">using</span>  callback = <span class="built_in">int</span>(*)(<span class="type">int</span>);</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">func</span><span class="params">(<span class="type">int</span> x,callback cb)</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span> + <span class="built_in">cb</span>(x); &#125;<span class="comment">//æ¥æ”¶å›è°ƒå‡½æ•°æŒ‡é’ˆçš„å‡½æ•°ï¼ˆéœ€è¦ä½¿ç”¨å›è°ƒåŠŸèƒ½çš„åœ°æ–¹ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">callbackImpl1</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123; <span class="keyword">return</span> i; &#125;<span class="comment">//ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°å®ç°ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">callbackImpl2</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123; <span class="keyword">return</span> i + <span class="number">1</span>; &#125;<span class="comment">//ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°å®ç°ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> result1=<span class="built_in">func</span>(<span class="number">2</span>, &amp;callbackImpl1);<span class="comment">//æ³¨æ„ä¼ å…¥çš„æ˜¯ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°å®ç°çš„ï¼ˆåœ°å€ï¼‰æŒ‡é’ˆ</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;result=%d\n&quot;</span>, result1);</span><br><span class="line"><span class="type">int</span> result2 = <span class="built_in">func</span>(<span class="number">2</span>, &amp;callbackImpl2);<span class="comment">//æ³¨æ„ä¼ å…¥çš„æ˜¯ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°å®ç°çš„ï¼ˆåœ°å€ï¼‰æŒ‡é’ˆ</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;result=%d\n&quot;</span>, result2);</span><br><span class="line"><span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="69-C-ä»ä»£ç åˆ°å¯æ‰§è¡Œç¨‹åºç»å†äº†ä»€ä¹ˆï¼Ÿ"><a href="#69-C-ä»ä»£ç åˆ°å¯æ‰§è¡Œç¨‹åºç»å†äº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="69. C++ä»ä»£ç åˆ°å¯æ‰§è¡Œç¨‹åºç»å†äº†ä»€ä¹ˆï¼Ÿ"></a>69. C++ä»ä»£ç åˆ°å¯æ‰§è¡Œç¨‹åºç»å†äº†ä»€ä¹ˆï¼Ÿ</h3><p><strong>(1) é¢„ç¼–è¯‘</strong></p><p>ä¸»è¦å¤„ç†æºä»£ç æ–‡ä»¶ä¸­çš„ä»¥â€œ#â€å¼€å¤´çš„é¢„ç¼–è¯‘æŒ‡ä»¤ã€‚</p><p><strong>(2) ç¼–è¯‘</strong></p><p>æŠŠé¢„ç¼–è¯‘ä¹‹åç”Ÿæˆçš„xxx.iæˆ–xxx.iiæ–‡ä»¶ï¼Œè¿›è¡Œä¸€ç³»åˆ—è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æåŠä¼˜åŒ–åï¼Œç”Ÿæˆç›¸åº”çš„æ±‡ç¼–ä»£ç æ–‡ä»¶ã€‚</p><p><strong>(3) æ±‡ç¼–</strong></p><p>å°†æ±‡ç¼–ä»£ç è½¬å˜æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤(æœºå™¨ç æ–‡ä»¶)ã€‚ æ±‡ç¼–å™¨çš„æ±‡ç¼–è¿‡ç¨‹ç›¸å¯¹äºç¼–è¯‘å™¨æ¥è¯´æ›´ç®€å•ï¼Œæ²¡æœ‰å¤æ‚çš„è¯­æ³•ï¼Œä¹Ÿæ²¡æœ‰è¯­ä¹‰ï¼Œæ›´ä¸éœ€è¦åšæŒ‡ä»¤ä¼˜åŒ–ï¼Œåªæ˜¯æ ¹æ®æ±‡ç¼–æŒ‡ä»¤å’Œæœºå™¨æŒ‡ä»¤çš„å¯¹ç…§è¡¨ä¸€ä¸€ç¿»è¯‘è¿‡æ¥ã€‚</p><p><strong>(4) é“¾æ¥</strong></p><p>å°†ä¸åŒçš„æºæ–‡ä»¶äº§ç”Ÿçš„ç›®æ ‡æ–‡ä»¶è¿›è¡Œé“¾æ¥ï¼Œä»è€Œå½¢æˆä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„ç¨‹åºã€‚é“¾æ¥åˆ†ä¸ºé™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥ã€‚</p><h3 id="70-ç±»çš„å¯¹è±¡å­˜å‚¨ç©ºé—´ï¼Ÿ"><a href="#70-ç±»çš„å¯¹è±¡å­˜å‚¨ç©ºé—´ï¼Ÿ" class="headerlink" title="70. ç±»çš„å¯¹è±¡å­˜å‚¨ç©ºé—´ï¼Ÿ"></a>70. ç±»çš„å¯¹è±¡å­˜å‚¨ç©ºé—´ï¼Ÿ</h3><p>(1) éé™æ€æˆå‘˜çš„æ•°æ®ç±»å‹å¤§å°ä¹‹å’Œã€‚</p><p>(2) ç¼–è¯‘å™¨åŠ å…¥çš„é¢å¤–æˆå‘˜å˜é‡ï¼ˆå¦‚æŒ‡å‘è™šå‡½æ•°è¡¨çš„æŒ‡é’ˆï¼‰ã€‚</p><p>(3) ä¸ºäº†å†…å­˜å¯¹é½è€Œè¡¥å…¥çš„é¢å¤–ç©ºé—´ã€‚</p><p>(4) ç©ºç±»å¤§å°ä¸º1ï¼Œä½†è‹¥æ˜¯ä½œä¸ºåŸºç±»ï¼Œåˆ™å¤§å°ä¸º0ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>:<span class="keyword">public</span> A&#123;</span><br><span class="line">&#125;; </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">cout&lt;&lt;<span class="built_in">sizeof</span>(A)&lt;&lt;endl;</span><br><span class="line">cout&lt;&lt;<span class="built_in">sizeof</span>(B)&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h3 id="71-é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥çš„åŒºåˆ«ï¼Ÿ"><a href="#71-é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="71. é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥çš„åŒºåˆ«ï¼Ÿ"></a>71. é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥çš„åŒºåˆ«ï¼Ÿ</h3><p>é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥æ˜¯é’ˆå¯¹å‡½æ•°åº“æ¥è¯´çš„ï¼Œç°åœ¨çš„å‡½æ•°åº“åˆ†ä¸ºä¸¤ç§ï¼š<strong>é™æ€åº“å’ŒåŠ¨æ€åº“</strong>ã€‚ä»–ä»¬åˆ†åˆ«å¯¹åº”é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥ã€‚</p><p>(1) <strong>é™æ€é“¾æ¥ï¼š</strong>æ‰€æœ‰çš„å‡½æ•°å’Œæ•°æ®éƒ½è¢«ç¼–è¯‘è¿›ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚åœ¨ä½¿ç”¨é™æ€åº“çš„æƒ…å†µä¸‹ï¼Œåœ¨ç¼–è¯‘é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œé“¾æ¥å™¨ä»å‡½æ•°åº“ä¸­å¤åˆ¶å‡½æ•°å’Œæ•°æ®å¹¶æŠŠå®ƒä»¬å’Œåº”ç”¨ç¨‹åºçš„å…¶å®ƒæ¨¡å—ç»„åˆèµ·æ¥åˆ›å»ºæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚é™æ€é“¾æ¥æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><p>â‘ ã€€ç©ºé—´æµªè´¹ï¼šå› ä¸ºæ¯ä¸ªå¯æ‰§è¡Œç¨‹åºä¸­éƒ½æ‹¥æœ‰å‡½æ•°åº“æ•°æ®çš„ä¸€ä»½å‰¯æœ¬ï¼Œæ‰€ä»¥å¦‚æœå¤šä¸ªç¨‹åºå¯¹åŒä¸€ä¸ªç›®æ ‡æ–‡ä»¶éƒ½æœ‰ä¾èµ–ï¼Œå½“ä»–ä»¬åŒæ—¶è¿è¡Œåœ¨è®¡ç®—æœºä¸Šï¼Œä¼šå‡ºç°åŒä¸€ä¸ªå‡½æ•°åº“åœ¨å†…å­˜ä¸­æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œæµªè´¹å†…å­˜ç©ºé—´ï¼›</p><p>â‘¡ã€€æ›´æ–°å›°éš¾ï¼šæ¯å½“åº“å‡½æ•°çš„ä»£ç ä¿®æ”¹äº†ï¼Œæ‰€æœ‰ä¾èµ–è¯¥åº“çš„ç¨‹åºéƒ½éœ€è¦é‡æ–°è¿›è¡Œç¼–è¯‘é“¾æ¥ã€‚</p><p>â‘¢ã€€è¿è¡Œé€Ÿåº¦å¿«ï¼šå› ä¸ºåœ¨å¯æ‰§è¡Œç¨‹åºä¸­å·²ç»å…·å¤‡äº†æ‰€æœ‰æ‰§è¡Œç¨‹åºæ‰€éœ€è¦çš„ä»»ä½•ä¸œè¥¿ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œçš„æ—¶å€™è¿è¡Œé€Ÿåº¦å¿«ã€‚</p><p>(2) <strong>åŠ¨æ€é“¾æ¥ï¼š</strong>åŠ¨æ€é“¾æ¥ä¼šåœ¨ç¨‹åºè¿è¡Œæ—¶æ‰å°†å‡½æ•°åº“ä¸æºç¨‹åºæ‰§è¡Œé“¾æ¥ï¼Œè€Œä¸æ˜¯åƒé™æ€é“¾æ¥ä¸€æ ·æŠŠæ‰€æœ‰æ¨¡å—éƒ½é“¾æ¥æˆä¸€ä¸ªå•ç‹¬çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚åŠ¨æ€é“¾æ¥æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><p>â‘ ã€€å…±äº«åº“ï¼šå¦‚æœå¤šä¸ªç¨‹åºéƒ½ä¾èµ–åŒä¸€ä¸ªåº“ï¼Œè¯¥åº“ä¸ä¼šåƒé™æ€é“¾æ¥é‚£æ ·åœ¨å†…å­˜ä¸­å­˜åœ¨å¤šä»½å‰¯æœ¬ï¼Œè€Œæ˜¯è¿™å¤šä¸ªç¨‹åºåœ¨æ‰§è¡Œæ—¶å…±äº«åŒä¸€ä»½å‰¯æœ¬ï¼›</p><p>â‘¡ã€€æ›´æ–°æ–¹ä¾¿ï¼šæ›´æ–°æ—¶åªéœ€è¦æ›¿æ¢åŸæ¥çš„åº“æ–‡ä»¶ï¼Œä¾èµ–å®ƒçš„ç¨‹åºæ— éœ€é‡æ–°ç¼–è¯‘ã€‚å½“ç¨‹åºä¸‹ä¸€æ¬¡è¿è¡Œæ—¶ï¼Œæ–°åº“ä¼šè¢«è‡ªåŠ¨åŠ è½½åˆ°å†…å­˜å¹¶ä¸”ä¸å…¶ä»–ç¨‹åºæ‰§è¡Œé“¾æ¥ï¼Œç¨‹åºå°±å®Œæˆäº†å‡çº§è¿­ä»£ã€‚</p><p>æ€§èƒ½æŸè€—ï¼šå› ä¸ºæŠŠé“¾æ¥æ¨è¿Ÿåˆ°äº†ç¨‹åºè¿è¡Œæ—¶ï¼Œæ¯æ¬¡æ‰§è¡Œç¨‹åºéƒ½éœ€è¦è¿›è¡Œé“¾æ¥ï¼Œæ‰€ä»¥æ€§èƒ½ä¼šæœ‰ä¸€å®šæŸå¤±ã€‚</p><h3 id="72-ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæ‰€æœ‰çš„å‡½æ•°å†™æˆå†…è”å‡½æ•°ï¼Ÿ"><a href="#72-ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæ‰€æœ‰çš„å‡½æ•°å†™æˆå†…è”å‡½æ•°ï¼Ÿ" class="headerlink" title="72. ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæ‰€æœ‰çš„å‡½æ•°å†™æˆå†…è”å‡½æ•°ï¼Ÿ"></a>72. ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæ‰€æœ‰çš„å‡½æ•°å†™æˆå†…è”å‡½æ•°ï¼Ÿ</h3><p>(1) é¦–å…ˆï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆå‡½æ•°å£°æ˜ä¸ºå†…è”å‡½æ•°ï¼Œåœ¨è¯­æ³•ä¸Šæ²¡æœ‰é”™è¯¯ã€‚å› ä¸ºinlineåŒregisterä¸€æ ·ï¼Œåªæ˜¯ä¸ªå»ºè®®ï¼Œ<strong>ç¼–è¯‘å™¨å¹¶ä¸ä¸€å®šçœŸæ­£çš„å†…è”</strong>ã€‚</p><p>(2) å†…è”å‡½æ•°ä»¥ä»£ç å¤æ‚ä¸ºä»£ä»·ï¼Œçœå»äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€æ¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚å¦‚æœå†…è”å‡½æ•°ä½“å†…ä»£ç æ‰§è¡Œæ—¶é—´ç›¸æ¯”èµ·å‡½æ•°è°ƒç”¨å¼€é”€æ›´å¤§ï¼Œåˆ™æ²¡æœ‰å¤ªå¤§çš„æ„ä¹‰ã€‚<strong>ä¸€èˆ¬æ¥è¯´è‹¥æ˜¯å‡½æ•°ä½“ä»£ç æ¯”è¾ƒé•¿æˆ–è€…å†…éƒ¨å¸¦æœ‰å¾ªç¯ï¼Œåˆ™ä¸æ¨èä½¿ç”¨å†…è”å‡½æ•°ã€‚</strong></p><p>(3) <strong>å°†æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å£°æ˜ä¸ºinlineæ˜¯æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰çš„ï¼Œ</strong>å³ç¼–è¯‘å™¨å¹¶ä¸çœŸæ­£å¯¹å£°æ˜ä¸ºinlineçš„æ„é€ å’Œææ„å‡½æ•°è¿›è¡Œå†…è”æ“ä½œï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šåœ¨æ„é€ å’Œææ„å‡½æ•°ä¸­æ·»åŠ é¢å¤–çš„æ“ä½œï¼ˆç”³è¯·/é‡Šæ”¾å†…å­˜ï¼Œæ„é€ /ææ„å¯¹è±¡ç­‰ï¼‰ï¼Œè‡´ä½¿æ„é€ å‡½æ•°/ææ„å‡½æ•°å¹¶ä¸åƒçœ‹ä¸Šå»çš„é‚£ä¹ˆç²¾ç®€ã€‚</p><p>(4) <strong>å°†è™šå‡½æ•°å£°æ˜ä¸ºinlineï¼Œè¦åˆ†æƒ…å†µè®¨è®ºã€‚</strong>å½“æŒ‡å‘æ´¾ç”Ÿç±»çš„æŒ‡é’ˆï¼ˆå¤šæ€æ€§ï¼‰è°ƒç”¨å£°æ˜ä¸ºinlineçš„è™šå‡½æ•°æ—¶ï¼Œç”±äºinlineæ˜¯ç¼–è¯‘æœŸå†³å®šçš„ï¼Œè€Œè™šå‡½æ•°æ˜¯è¿è¡ŒæœŸå†³å®šçš„ï¼Œåœ¨ä¸çŸ¥é“å°†è¦è°ƒç”¨å“ªä¸ªå‡½æ•°çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¸ä¼šå†…è”å±•å¼€ï¼›å½“å¯¹è±¡æœ¬èº«è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨èƒ½å†³è®®å‡ºä¼šè°ƒç”¨å“ªä¸ªå‡½æ•°æ—¶ï¼Œå°±ä¼šå†…è”å±•å¼€ï¼Œå½“ç„¶å‰æä¾ç„¶æ˜¯å‡½æ•°å¹¶ä¸å¤æ‚çš„æƒ…å†µä¸‹ã€‚</p><h3 id="73-ä¸ºä»€ä¹ˆC-æ²¡æœ‰åƒåœ¾å›æ”¶æœºåˆ¶ï¼Ÿ"><a href="#73-ä¸ºä»€ä¹ˆC-æ²¡æœ‰åƒåœ¾å›æ”¶æœºåˆ¶ï¼Ÿ" class="headerlink" title="73. ä¸ºä»€ä¹ˆC++æ²¡æœ‰åƒåœ¾å›æ”¶æœºåˆ¶ï¼Ÿ"></a>73. ä¸ºä»€ä¹ˆC++æ²¡æœ‰åƒåœ¾å›æ”¶æœºåˆ¶ï¼Ÿ</h3><p>(1) å®ç°ä¸€ä¸ªåƒåœ¾å›æ”¶å™¨ä¼šå¸¦æ¥é¢å¤–çš„ç©ºé—´å’Œæ—¶é—´å¼€é”€ã€‚</p><p>(2) åƒåœ¾å›æ”¶ä¼šä½¿å¾—C++ä¸é€‚åˆè¿›è¡Œå¾ˆå¤šåº•å±‚çš„æ“ä½œã€‚</p><h3 id="74-è¯´è¯´C-çš„å†…å­˜åˆ†åŒºï¼Ÿ"><a href="#74-è¯´è¯´C-çš„å†…å­˜åˆ†åŒºï¼Ÿ" class="headerlink" title="74. è¯´è¯´C++çš„å†…å­˜åˆ†åŒºï¼Ÿ"></a>74. è¯´è¯´C++çš„å†…å­˜åˆ†åŒºï¼Ÿ</h3><p>åœ¨C++ä¸­ï¼Œå†…å­˜åˆ†æˆ5ä¸ªåŒºï¼Œä»–ä»¬åˆ†åˆ«æ˜¯<strong>å †ã€æ ˆã€å…¨å±€/é™æ€å­˜å‚¨åŒºå’Œå¸¸é‡å­˜å‚¨åŒºå’Œä»£ç åŒº</strong>ã€‚</p><p>(1) <strong>æ ˆï¼š</strong>åœ¨æ‰§è¡Œå‡½æ•°æ—¶ï¼Œå‡½æ•°å†…å±€éƒ¨å˜é‡çš„å­˜å‚¨å•å…ƒéƒ½å¯ä»¥åœ¨æ ˆä¸Šåˆ›å»ºï¼Œå‡½æ•°æ‰§è¡Œç»“æŸæ—¶è¿™äº›å­˜å‚¨å•å…ƒè‡ªåŠ¨è¢«é‡Šæ”¾ã€‚æ ˆå·¥ä½œæ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯åˆ†é…çš„å†…å­˜å®¹é‡æœ‰é™ã€‚</p><p>(2) <strong>å †ï¼š</strong>å°±æ˜¯é‚£äº›ç”±newåˆ†é…çš„å†…å­˜å—ï¼Œä»–ä»¬çš„é‡Šæ”¾ç¼–è¯‘å™¨ä¸å»ç®¡ï¼Œç”±æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå»æ§åˆ¶ï¼Œä¸€èˆ¬ä¸€ä¸ªnewå°±è¦å¯¹åº”ä¸€ä¸ªdeleteã€‚å¦‚æœç¨‹åºå‘˜æ²¡æœ‰é‡Šæ”¾æ‰ï¼Œé‚£ä¹ˆåœ¨ç¨‹åºç»“æŸåï¼Œæ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶ã€‚</p><p>(3) <strong>å…¨å±€/é™æ€å­˜å‚¨åŒºï¼š</strong>è¿™å—å†…å­˜åœ¨ç¼–è¯‘æ—¶å·²ç»åˆ†é…å¥½ï¼Œä¸”åœ¨ç¨‹åºè¿è¡ŒæœŸé—´éƒ½å­˜åœ¨ã€‚å®ƒä¸»è¦å­˜æ”¾é™æ€æ•°æ®ï¼ˆå±€éƒ¨staticå˜é‡ï¼Œå…¨å±€staticå˜é‡ï¼‰ã€å…¨å±€å˜é‡ã€‚</p><p>(4) <strong>å¸¸é‡å­˜å‚¨åŒºï¼š</strong>è¿™æ˜¯ä¸€å—æ¯”è¾ƒç‰¹æ®Šçš„å­˜å‚¨åŒºï¼Œä»–ä»¬é‡Œé¢å­˜æ”¾çš„æ˜¯å¸¸é‡ï¼Œä¸å…è®¸ä¿®æ”¹ã€‚</p><p>(5) <strong>ä»£ç åŒºï¼š</strong>å­˜æ”¾ç¨‹åºçš„äºŒè¿›åˆ¶ä»£ç ã€‚</p><h3 id="75-è¯´è¯´å‹å…ƒå‡½æ•°å’Œå‹å…ƒç±»çš„ç‰¹æ€§ï¼Ÿ"><a href="#75-è¯´è¯´å‹å…ƒå‡½æ•°å’Œå‹å…ƒç±»çš„ç‰¹æ€§ï¼Ÿ" class="headerlink" title="75. è¯´è¯´å‹å…ƒå‡½æ•°å’Œå‹å…ƒç±»çš„ç‰¹æ€§ï¼Ÿ"></a>75. è¯´è¯´å‹å…ƒå‡½æ•°å’Œå‹å…ƒç±»çš„ç‰¹æ€§ï¼Ÿ</h3><p>å‹å…ƒæä¾›äº†<strong>ä¸åŒç±»çš„æˆå‘˜å‡½æ•°ä¹‹é—´ã€ç±»çš„æˆå‘˜å‡½æ•°å’Œä¸€èˆ¬å‡½æ•°ä¹‹é—´</strong>è¿›è¡Œæ•°æ®å…±äº«çš„æœºåˆ¶ã€‚é€šè¿‡å‹å…ƒï¼Œå¤–éƒ¨çš„æ™®é€šå‡½æ•°æˆ–è€…å¦ä¸€ä¸ªç±»ä¸­çš„æˆå‘˜å‡½æ•°å¯ä»¥è®¿é—®æœ¬ç±»ä¸­çš„ç§æœ‰æˆå‘˜å’Œä¿æŠ¤æˆå‘˜ã€‚å‹å…ƒçš„æ­£ç¡®ä½¿ç”¨èƒ½æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼Œä½†åŒæ—¶ä¹Ÿç ´åäº†ç±»çš„å°è£…æ€§å’Œæ•°æ®çš„éšè—æ€§ï¼Œå¯¼è‡´ç¨‹åºå¯ç»´æŠ¤æ€§å˜å·®ã€‚å‹å…ƒå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p><p>(1) <strong>å‹å…ƒå…³ç³»ä¸èƒ½è¢«ç»§æ‰¿ã€‚</strong></p><p>(2) <strong>å‹å…ƒå…³ç³»æ˜¯å•å‘çš„ï¼Œä¸å…·æœ‰äº¤æ¢æ€§ã€‚</strong>è‹¥ç±»Bæ˜¯ç±»Açš„å‹å…ƒï¼Œç±»Aä¸ä¸€å®šæ˜¯ç±»Bçš„å‹å…ƒï¼Œè¦çœ‹åœ¨ç±»ä¸­æ˜¯å¦æœ‰ç›¸åº”çš„å£°æ˜ã€‚</p><p><strong>å‹å…ƒå…³ç³»ä¸å…·æœ‰ä¼ é€’æ€§ã€‚</strong>è‹¥ç±»Bæ˜¯ç±»Açš„å‹å…ƒï¼Œç±»Cæ˜¯Bçš„å‹å…ƒï¼Œç±»Cä¸ä¸€å®šæ˜¯ç±»Açš„å‹å…ƒï¼ŒåŒæ ·è¦çœ‹ç±»ä¸­æ˜¯å¦æœ‰ç›¸åº”çš„å£°æ˜ã€‚</p><h3 id="76-å…³äºthisæŒ‡é’ˆä½ çŸ¥é“ä»€ä¹ˆï¼Ÿ"><a href="#76-å…³äºthisæŒ‡é’ˆä½ çŸ¥é“ä»€ä¹ˆï¼Ÿ" class="headerlink" title="76. å…³äºthisæŒ‡é’ˆä½ çŸ¥é“ä»€ä¹ˆï¼Ÿ"></a>76. å…³äºthisæŒ‡é’ˆä½ çŸ¥é“ä»€ä¹ˆï¼Ÿ</h3><p>(1) thisæŒ‡é’ˆæ˜¯ç±»çš„æŒ‡é’ˆï¼ŒæŒ‡å‘å¯¹è±¡çš„é¦–åœ°å€ã€‚</p><p>(2) thisæŒ‡é’ˆåªèƒ½åœ¨æ™®é€šæˆå‘˜å‡½æ•°ä¸­ä½¿ç”¨ï¼Œåœ¨å…¨å±€å‡½æ•°ã€é™æ€æˆå‘˜å‡½æ•°ä¸­éƒ½ä¸èƒ½ç”¨thisã€‚</p><p>(3) thisåœ¨æˆå‘˜å‡½æ•°çš„å¼€å§‹æ‰§è¡Œå‰æ„é€ ï¼Œåœ¨æˆå‘˜çš„æ‰§è¡Œç»“æŸåæ¸…é™¤ã€‚</p><p>(4) thisæŒ‡é’ˆåªæœ‰åœ¨æ™®é€šæˆå‘˜å‡½æ•°ä¸­æ‰æœ‰å®šä¹‰ï¼Œä¸”å­˜å‚¨ä½ç½®ä¼šå› ç¼–è¯‘å™¨ä¸åŒæœ‰ä¸åŒå­˜å‚¨ä½ç½®ã€‚</p><p>(5) thisæŒ‡é’ˆä¸»è¦å¯ç”¨äºè¿”å›ç±»å¯¹è±¡æœ¬èº«çš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨ return *thisã€‚æˆ–è€…å½“å½¢å‚æ•°ä¸æˆå‘˜å˜é‡åç›¸åŒæ—¶ç”¨äºåŒºåˆ†ï¼Œå¦‚this-&gt;n = nã€‚</p><h3 id="77-åœ¨æˆå‘˜å‡½æ•°ä¸­è°ƒç”¨delete-thisä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ"><a href="#77-åœ¨æˆå‘˜å‡½æ•°ä¸­è°ƒç”¨delete-thisä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ" class="headerlink" title="77. åœ¨æˆå‘˜å‡½æ•°ä¸­è°ƒç”¨delete thisä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ"></a>77. åœ¨æˆå‘˜å‡½æ•°ä¸­è°ƒç”¨delete thisä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h3><p>å½“è°ƒç”¨delete thisæ—¶ï¼Œç±»å¯¹è±¡çš„å†…å­˜ç©ºé—´è¢«é‡Šæ”¾ã€‚å› ä¸ºç±»æˆå‘˜å‡½æ•°å¹¶æ²¡æœ‰å­˜æ”¾åœ¨ç±»å¯¹è±¡çš„å†…å­˜ç©ºé—´ä¸­ï¼Œæ‰€ä»¥åœ¨delete thisä¹‹åè¿›è¡Œçš„å…¶ä»–ä»»ä½•å‡½æ•°è°ƒç”¨ï¼Œåªè¦ä¸æ¶‰åŠåˆ°thisæŒ‡é’ˆçš„å†…å®¹ï¼Œéƒ½èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚ä¸€æ—¦æ¶‰åŠåˆ°thisæŒ‡é’ˆï¼Œå¦‚æ“ä½œæ•°æ®æˆå‘˜ï¼Œè°ƒç”¨è™šå‡½æ•°ç­‰ï¼Œå› ä¸ºå†…å­˜è¢«é‡Šæ”¾ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç°ä¸å¯é¢„æœŸçš„é—®é¢˜ã€‚</p><h3 id="78-å¦‚æœåœ¨ç±»çš„ææ„å‡½æ•°ä¸­è°ƒç”¨delete-thisï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"><a href="#78-å¦‚æœåœ¨ç±»çš„ææ„å‡½æ•°ä¸­è°ƒç”¨delete-thisï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ" class="headerlink" title="78. å¦‚æœåœ¨ç±»çš„ææ„å‡½æ•°ä¸­è°ƒç”¨delete thisï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"></a>78. å¦‚æœåœ¨ç±»çš„ææ„å‡½æ•°ä¸­è°ƒç”¨delete thisï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h3><p>ä¼šå¯¼è‡´å †æ ˆæº¢å‡ºã€‚å› ä¸ºdeleteä¼šè°ƒç”¨ææ„å‡½æ•°ï¼Œå¯¼è‡´é€’å½’ã€‚</p><h3 id="79-C-ä¸­ç±»çš„æ•°æ®æˆå‘˜å’Œæˆå‘˜å‡½æ•°å†…å­˜åˆ†å¸ƒæƒ…å†µï¼Ÿ"><a href="#79-C-ä¸­ç±»çš„æ•°æ®æˆå‘˜å’Œæˆå‘˜å‡½æ•°å†…å­˜åˆ†å¸ƒæƒ…å†µï¼Ÿ" class="headerlink" title="79. C++ä¸­ç±»çš„æ•°æ®æˆå‘˜å’Œæˆå‘˜å‡½æ•°å†…å­˜åˆ†å¸ƒæƒ…å†µï¼Ÿ"></a>79. C++ä¸­ç±»çš„æ•°æ®æˆå‘˜å’Œæˆå‘˜å‡½æ•°å†…å­˜åˆ†å¸ƒæƒ…å†µï¼Ÿ</h3><p>(1) æ™®é€šæ•°æ®æˆå‘˜å­˜æ”¾åœ¨å¯¹è±¡å†…å­˜ç©ºé—´ä¸­</p><p>(2) é™æ€æ•°æ®æˆå‘˜å­˜æ”¾åœ¨å…¨å±€/é™æ€å­˜å‚¨åŒºä¸­</p><p>(3) æ™®é€šæˆå‘˜å‡½æ•°å’Œé™æ€æˆå‘˜å‡½æ•°éƒ½å­˜æ”¾åœ¨ä»£ç åŒºä¸­</p><h3 id="80-C-çš„å¤šæ€æ€ä¹ˆå®ç°ï¼Ÿ"><a href="#80-C-çš„å¤šæ€æ€ä¹ˆå®ç°ï¼Ÿ" class="headerlink" title="80. C++çš„å¤šæ€æ€ä¹ˆå®ç°ï¼Ÿ"></a>80. C++çš„å¤šæ€æ€ä¹ˆå®ç°ï¼Ÿ</h3><p>C++çš„å¤šæ€æœºåˆ¶æœ‰ä¸¤ç§ï¼Œåˆ†ä¸ºç¼–è¯‘æ—¶å¤šæ€å’Œè¿è¡Œæ—¶å¤šæ€ï¼Œä¸‹é¢åˆ†åˆ«ä»‹ç»è¿™ä¸¤ç§å¤šæ€ã€‚</p><p><strong>ç¼–è¯‘æ—¶å¤šæ€</strong></p><p>(1) ä¸»è¦é€šè¿‡æ¨¡æ¿å’Œå‡½æ•°é‡è½½å®ç°ï¼Œåœ¨ç¼–è¯‘æœŸå‘ç”Ÿï¼Œç”±ç¼–è¯‘å™¨è¿›è¡Œæ¨æ–­å†³è®®ã€‚</p><p>(2) ä¼˜ç‚¹ï¼š</p><p>â‘ ã€€å®ƒå¸¦æ¥äº†æ³›å‹ç¼–ç¨‹çš„æ¦‚å¿µï¼Œä½¿å¾—C++æ‹¥æœ‰æ³›å‹ç¼–ç¨‹ä¸STLè¿™æ ·çš„å¼ºå¤§æ­¦å™¨ã€‚</p><p>â‘¡ã€€åœ¨ç¼–è¯‘å™¨å®Œæˆå¤šæ€ï¼Œæé«˜è¿è¡ŒæœŸæ•ˆç‡ã€‚</p><p>â‘¢ã€€å…·æœ‰å¾ˆå¼ºçš„é€‚é…æ€§ä¸æ¾è€¦åˆæ€§ï¼Œå¯¹äºç‰¹æ®Šç±»å‹å¯ç”±æ¨¡æ¿åç‰¹åŒ–ã€å…¨ç‰¹åŒ–æ¥å¤„ç†ã€‚</p><p>(3) ç¼ºç‚¹ï¼š</p><p>â‘ ã€€ç¨‹åºå¯è¯»æ€§é™ä½ï¼Œä»£ç è°ƒè¯•å¸¦æ¥å›°éš¾ã€‚</p><p>â‘¡ã€€æ— æ³•å®ç°æ¨¡æ¿çš„åˆ†ç¦»ç¼–è¯‘ï¼Œå½“å·¥ç¨‹å¾ˆå¤§æ—¶ï¼Œç¼–è¯‘æ—¶é—´ä¸å¯å°è§‘ã€‚</p><p><strong>è¿è¡Œæ—¶å¤šæ€</strong></p><p>(1) è¿è¡ŒæœŸå¤šæ€çš„è®¾è®¡æ€æƒ³è¦å½’ç»“åˆ°ç±»ç»§æ‰¿ä½“ç³»çš„è®¾è®¡ä¸Šå»ã€‚å¯¹äºæœ‰ç›¸å…³åŠŸèƒ½çš„å¯¹è±¡é›†åˆï¼Œæˆ‘ä»¬æ€»å¸Œæœ›èƒ½å¤ŸæŠ½è±¡å‡ºå®ƒä»¬å…±æœ‰çš„åŠŸèƒ½é›†åˆï¼Œåœ¨åŸºç±»ä¸­å°†è¿™äº›åŠŸèƒ½å£°æ˜ä¸ºè™šæ¥å£ï¼ˆè™šå‡½æ•°ï¼‰ï¼Œç„¶åç”±å­ç±»ç»§æ‰¿åŸºç±»å»é‡å†™è¿™äº›è™šæ¥å£ï¼Œä»¥å®ç°å­ç±»ç‰¹æœ‰çš„å…·ä½“åŠŸèƒ½ã€‚</p><p>(2) åœ¨C++ä¸­ï¼Œä¸»è¦ç”±è™šè¡¨å’Œè™šè¡¨æŒ‡é’ˆå®ç°è¿è¡Œæ—¶å¤šæ€ã€‚è¿è¡Œæ—¶å¤šæ€å®ç°ç»†èŠ‚å¦‚ä¸‹ï¼š</p><p>â‘ ã€€ç¼–è¯‘å™¨åœ¨å‘ç°åŸºç±»ä¸­æœ‰è™šå‡½æ•°æ—¶ï¼Œä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªå«æœ‰è™šå‡½æ•°çš„ç±»ç”Ÿæˆä¸€ä»½è™šè¡¨ï¼Œè¯¥è¡¨æ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼Œè™šè¡¨é‡Œä¿å­˜äº†è™šå‡½æ•°çš„å…¥å£åœ°å€ã€‚</p><p>â‘¡ã€€ç¼–è¯‘å™¨ä¼šåœ¨æ¯ä¸ªå¯¹è±¡çš„å‰å››ä¸ªå­—èŠ‚ä¸­ä¿å­˜ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆï¼Œå³vptrï¼ŒæŒ‡å‘å¯¹è±¡æ‰€å±ç±»çš„è™šè¡¨ã€‚åœ¨æ„é€ æ—¶ï¼Œæ ¹æ®å¯¹è±¡çš„ç±»å‹å»åˆå§‹åŒ–è™šæŒ‡é’ˆvptrï¼Œä»è€Œè®©vptræŒ‡å‘æ­£ç¡®çš„è™šè¡¨ï¼Œä»è€Œåœ¨è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œèƒ½æ‰¾åˆ°æ­£ç¡®çš„å‡½æ•°</p><p>â‘¢ã€€åœ¨æ´¾ç”Ÿç±»å®šä¹‰å¯¹è±¡æ—¶ï¼Œä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œæ­¤æ—¶ï¼Œç¼–è¯‘å™¨åªâ€œçœ‹åˆ°äº†çˆ¶ç±»ï¼Œå¹¶ä¸ºçˆ¶ç±»å¯¹è±¡åˆå§‹åŒ–è™šè¡¨æŒ‡é’ˆï¼Œä»¤å®ƒæŒ‡å‘çˆ¶ç±»çš„è™šè¡¨ï¼›å½“è°ƒç”¨å­ç±»çš„æ„é€ å‡½æ•°æ—¶ï¼Œä¸ºå­ç±»å¯¹è±¡åˆå§‹åŒ–è™šè¡¨æŒ‡é’ˆï¼Œä»¤å®ƒæŒ‡å‘å­ç±»çš„è™šè¡¨</p><p>â‘£ã€€å½“æ´¾ç”Ÿç±»å¯¹åŸºç±»çš„è™šå‡½æ•°æ²¡æœ‰é‡å†™æ—¶ï¼Œæ´¾ç”Ÿç±»çš„è™šè¡¨æŒ‡é’ˆæŒ‡å‘çš„æ˜¯åŸºç±»çš„è™šè¡¨ï¼›å½“æ´¾ç”Ÿç±»å¯¹åŸºç±»çš„è™šå‡½æ•°é‡å†™æ—¶ï¼Œæ´¾ç”Ÿç±»çš„è™šè¡¨æŒ‡é’ˆæŒ‡å‘çš„æ˜¯è‡ªèº«çš„è™šè¡¨ï¼›å½“æ´¾ç”Ÿç±»ä¸­æœ‰è‡ªå·±çš„è™šå‡½æ•°æ—¶ï¼Œåœ¨è‡ªå·±çš„è™šè¡¨ä¸­å°†æ­¤è™šå‡½æ•°åœ°å€æ·»åŠ åœ¨åé¢</p><p>(3) ä¼˜ç‚¹ï¼š</p><p>é¢å‘å¯¹è±¡è®¾è®¡ä¸­é‡è¦çš„ç‰¹æ€§ï¼Œå¯¹å®¢è§‚ä¸–ç•Œç›´è§‰è®¤è¯†ã€‚</p><p>(4) ç¼ºç‚¹ï¼š</p><p>â‘ ã€€è¿è¡ŒæœŸé—´è¿›è¡Œè™šå‡½æ•°ç»‘å®šï¼Œæé«˜äº†ç¨‹åºè¿è¡Œå¼€é”€ã€‚</p><p>â‘¡ã€€åºå¤§çš„ç±»ç»§æ‰¿å±‚æ¬¡ï¼Œå¯¹æ¥å£çš„ä¿®æ”¹æ˜“å½±å“ç±»ç»§æ‰¿å±‚æ¬¡ã€‚</p><p>â‘¢ã€€ç”±äºè™šå‡½æ•°åœ¨è¿è¡ŒæœŸåœ¨ç¡®å®šï¼Œæ‰€ä»¥ç¼–è¯‘å™¨æ— æ³•å¯¹è™šå‡½æ•°è¿›è¡Œä¼˜åŒ–ã€‚</p><p>â‘£ã€€è™šè¡¨æŒ‡é’ˆå¢å¤§äº†å¯¹è±¡ä½“ç§¯ï¼Œç±»ä¹Ÿå¤šäº†ä¸€å¼ è™šå‡½æ•°è¡¨ã€‚</p><h3 id="81-ä¸ºä»€ä¹ˆè¦æŠŠææ„å‡½æ•°å†™æˆè™šå‡½æ•°ï¼Ÿ"><a href="#81-ä¸ºä»€ä¹ˆè¦æŠŠææ„å‡½æ•°å†™æˆè™šå‡½æ•°ï¼Ÿ" class="headerlink" title="81. ä¸ºä»€ä¹ˆè¦æŠŠææ„å‡½æ•°å†™æˆè™šå‡½æ•°ï¼Ÿ"></a>81. ä¸ºä»€ä¹ˆè¦æŠŠææ„å‡½æ•°å†™æˆè™šå‡½æ•°ï¼Ÿ</h3><p>ç”±äºç±»çš„å¤šæ€æ€§ï¼ŒåŸºç±»æŒ‡é’ˆå¯ä»¥æŒ‡å‘æ´¾ç”Ÿç±»çš„å¯¹è±¡ã€‚å¦‚æœææ„å‡½æ•°ä¸è¢«å£°æ˜æˆè™šå‡½æ•°ï¼Œåˆ™ç¼–è¯‘å™¨å®æ–½é™æ€ç»‘å®šï¼Œåœ¨åˆ é™¤åŸºç±»æŒ‡é’ˆæ—¶ï¼Œåªä¼šè°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°è€Œä¸è°ƒç”¨æ´¾ç”Ÿç±»ææ„å‡½æ•°ï¼Œè¿™æ ·å°±ä¼šé€ æˆæ´¾ç”Ÿç±»å¯¹è±¡ææ„ä¸å®Œå…¨ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p><h3 id="82-è™šå‡½æ•°è¡¨å­˜æ”¾åœ¨å†…å­˜çš„ä»€ä¹ˆåŒºåŸŸï¼Ÿ"><a href="#82-è™šå‡½æ•°è¡¨å­˜æ”¾åœ¨å†…å­˜çš„ä»€ä¹ˆåŒºåŸŸï¼Ÿ" class="headerlink" title="82. è™šå‡½æ•°è¡¨å­˜æ”¾åœ¨å†…å­˜çš„ä»€ä¹ˆåŒºåŸŸï¼Ÿ"></a>82. è™šå‡½æ•°è¡¨å­˜æ”¾åœ¨å†…å­˜çš„ä»€ä¹ˆåŒºåŸŸï¼Ÿ</h3><p>C++ä¸­è™šå‡½æ•°è¡¨ä½äºåªè¯»æ•°æ®æ®µï¼ˆ.rodataï¼‰ï¼Œä¹Ÿå°±æ˜¯C++å†…å­˜æ¨¡å‹ä¸­çš„å¸¸é‡åŒºï¼›</p><p>è™šå‡½æ•°åˆ™ä½äºä»£ç æ®µï¼ˆ.textï¼‰ï¼Œä¹Ÿå°±æ˜¯C++å†…å­˜æ¨¡å‹ä¸­çš„ä»£ç åŒºã€‚</p><h3 id="83-æ¨¡æ¿åç‰¹åŒ–äº†è§£å—ï¼Ÿ"><a href="#83-æ¨¡æ¿åç‰¹åŒ–äº†è§£å—ï¼Ÿ" class="headerlink" title="83. æ¨¡æ¿åç‰¹åŒ–äº†è§£å—ï¼Ÿ"></a>83. æ¨¡æ¿åç‰¹åŒ–äº†è§£å—ï¼Ÿ</h3><p>(1) é€šè¿‡ç¼–å†™æ¨¡æ¿ï¼Œèƒ½é€‚åº”å¤šç§ç±»å‹çš„éœ€æ±‚ï¼Œä½¿æ¯ç§ç±»å‹éƒ½å…·æœ‰ç›¸åŒçš„åŠŸèƒ½ï¼Œä½†å¯¹äºæŸç§ç‰¹å®šç±»å‹ï¼Œå¦‚æœè¦å®ç°å…¶ç‰¹æœ‰çš„åŠŸèƒ½ï¼Œå•ä¸€æ¨¡æ¿å°±æ— æ³•åšåˆ°ï¼Œè¿™æ—¶å°±éœ€è¦æ¨¡æ¿ç‰¹ä¾‹åŒ–ï¼ˆæ¨¡æ¿åç‰¹åŒ–ï¼‰ã€‚</p><p>(2) æ‰€è°“çš„æ¨¡æ¿åç‰¹åŒ–å¯¹å•ä¸€æ¨¡æ¿æä¾›çš„ä¸€ä¸ªç‰¹æ®Šå®ä¾‹ï¼Œå®ƒå°†ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡æ¿å‚æ•°ç»‘å®šåˆ°ç‰¹å®šçš„ç±»å‹æˆ–å€¼ä¸Šã€‚</p><p>(3) ç‰¹ä¾‹åŒ–çš„æœ¬è´¨æ˜¯å®ä¾‹åŒ–ä¸€ä¸ªæ¨¡æ¿ï¼Œè€Œéé‡è½½å®ƒã€‚ç‰¹ä¾‹åŒ–ä¸å½±å“å‚æ•°åŒ¹é…ã€‚å‚æ•°åŒ¹é…éƒ½ä»¥<strong>æœ€ä½³åŒ¹é…</strong>ä¸ºåŸåˆ™ã€‚</p><p>(4) å¯ä»¥ç‰¹ä¾‹åŒ–ç±»ä¸­çš„éƒ¨åˆ†æˆå‘˜å‡½æ•°è€Œä¸æ˜¯æ•´ä¸ªç±»ã€‚</p><p>ä¸¾ä¾‹ï¼š</p><p>æ¨¡æ¿åç‰¹åŒ–æ˜¯C++æ¨¡æ¿ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µã€‚ç®€å•æ¥è¯´ï¼Œæ¨¡æ¿åç‰¹åŒ–å°±æ˜¯å¯¹æ¨¡æ¿è¿›è¡Œéƒ¨åˆ†ç‰¹åŒ–ï¼Œä¹Ÿå°±æ˜¯å°†æ¨¡æ¿çš„éƒ¨åˆ†å‚æ•°å…·ä½“åŒ–ã€‚æ¨¡æ¿åç‰¹åŒ–å¯ä»¥è®©æˆ‘ä»¬ä¸ºç‰¹å®šçš„ç±»å‹æˆ–æ¡ä»¶æä¾›ç‰¹åŒ–çš„å®ç°ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¨¡æ¿ç±»ç”¨äºå­˜å‚¨æ•°ç»„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="type">int</span> N&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Array</span> &#123;</span><br><span class="line">    T data[N];</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œæˆ‘ä»¬æƒ³è¦å¯¹<code>bool</code>ç±»å‹çš„æ•°ç»„è¿›è¡Œç‰¹åŒ–ï¼Œå› ä¸º<code>bool</code>ç±»å‹çš„æ•°ç»„å¯ä»¥é€šè¿‡ä½æ“ä½œè¿›è¡Œå‹ç¼©å­˜å‚¨ï¼Œä»è€ŒèŠ‚çœç©ºé—´ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¨¡æ¿åç‰¹åŒ–æ¥å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> N&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Array</span>&lt;<span class="type">bool</span>, N&gt; &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ä½æ“ä½œè¿›è¡Œå‹ç¼©å­˜å‚¨</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> data[(N+<span class="number">7</span>)/<span class="number">8</span>];</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>Array&lt;bool, N&gt;</code>æ˜¯<code>Array&lt;T, N&gt;</code>çš„ä¸€ä¸ªåç‰¹åŒ–ç‰ˆæœ¬ã€‚å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>Array&lt;bool, 100&gt;</code>å¯¹è±¡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨åç‰¹åŒ–ç‰ˆæœ¬çš„æ¨¡æ¿ï¼Œä»è€Œå®ç°å¯¹<code>bool</code>ç±»å‹æ•°ç»„çš„ä¼˜åŒ–å­˜å‚¨ã€‚</p><h3 id="84-å“ªäº›å‡½æ•°ä¸èƒ½è¢«å®šä¹‰ä¸ºè™šå‡½æ•°ï¼Ÿ"><a href="#84-å“ªäº›å‡½æ•°ä¸èƒ½è¢«å®šä¹‰ä¸ºè™šå‡½æ•°ï¼Ÿ" class="headerlink" title="84. å“ªäº›å‡½æ•°ä¸èƒ½è¢«å®šä¹‰ä¸ºè™šå‡½æ•°ï¼Ÿ"></a>84. å“ªäº›å‡½æ•°ä¸èƒ½è¢«å®šä¹‰ä¸ºè™šå‡½æ•°ï¼Ÿ</h3><p>(1) <strong>æ„é€ å‡½æ•°ã€‚</strong>æ¯ä¸€ä¸ªå£°æ˜äº†è™šå‡½æ•°çš„ç±»å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘è™šè¡¨(vtable)çš„æŒ‡é’ˆï¼Œä½†æ˜¯è¿™ä¸ªæŒ‡å‘vtableçš„æŒ‡é’ˆäº‹å®ä¸Šæ˜¯å­˜å‚¨åœ¨å¯¹è±¡çš„å†…å­˜ç©ºé—´çš„,å‡è®¾æ„é€ å‡½æ•°æ˜¯è™šçš„ï¼Œå°±é¡»è¦é€šè¿‡ vtableæ¥è°ƒç”¨ï¼Œä½†æ˜¯å¯¹è±¡è¿˜æ²¡æœ‰å®ä¾‹åŒ–ï¼Œä¹Ÿå°±æ˜¯å†…å­˜ç©ºé—´è¿˜æ²¡æœ‰ï¼Œæ€ä¹ˆæ‰¾vtableå‘¢ï¼Ÿå†è€…ï¼Œè™šå‡½æ•°ä¸»è¦æ˜¯åœ¨è°ƒç”¨å¯¹è±¡ä¸ç¡®å®šçš„æƒ…å†µä¸‹ä½¿ç”¨çš„ï¼Œç„¶è€Œæ„é€ å‡½æ•°æœ¬èº«å°±æ˜¯è¦åˆå§‹åŒ–å®ä¾‹ï¼Œé‚£ä½¿ç”¨è™šå‡½æ•°ä¹Ÿæ²¡æœ‰å®é™…æ„ä¹‰ã€‚</p><p>(2) <strong>é™æ€å‡½æ•°ã€‚</strong>é™æ€å‡½æ•°ä¸å±äºå¯¹è±¡å±äºç±»ï¼Œé™æ€æˆå‘˜å‡½æ•°æ²¡æœ‰thisæŒ‡é’ˆï¼Œå› æ­¤é™æ€å‡½æ•°è®¾ç½®ä¸ºè™šå‡½æ•°æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚</p><p>(3) <strong>å‹å…ƒå‡½æ•°ã€‚</strong>å‹å…ƒå‡½æ•°ä¸å±äºç±»çš„æˆå‘˜å‡½æ•°ï¼Œä¸èƒ½è¢«ç»§æ‰¿ã€‚å¯¹äºæ²¡æœ‰ç»§æ‰¿ç‰¹æ€§çš„å‡½æ•°æ²¡æœ‰è™šå‡½æ•°çš„è¯´æ³•ã€‚</p><p>(4) <strong>æ™®é€šå‡½æ•°ã€‚</strong>æ™®é€šå‡½æ•°ä¸å±äºç±»çš„æˆå‘˜å‡½æ•°ï¼Œä¸å…·æœ‰ç»§æ‰¿ç‰¹æ€§ï¼Œå› æ­¤æ™®é€šå‡½æ•°æ²¡æœ‰è™šå‡½æ•°ã€‚</p><h3 id="85-æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å¯ä»¥è°ƒç”¨è™šå‡½æ•°å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ"><a href="#85-æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å¯ä»¥è°ƒç”¨è™šå‡½æ•°å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="85. æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å¯ä»¥è°ƒç”¨è™šå‡½æ•°å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ"></a>85. æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å¯ä»¥è°ƒç”¨è™šå‡½æ•°å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</h3><p>(1) <strong>æ„é€ å‡½æ•°è°ƒç”¨è™šå‡½æ•°æ²¡æœ‰æ„ä¹‰</strong>ï¼Œå› ä¸ºçˆ¶ç±»å¯¹è±¡ä¼šåœ¨å­ç±»ä¹‹å‰è¿›è¡Œæ„é€ ï¼Œæ­¤æ—¶å­ç±»éƒ¨åˆ†çš„æ•°æ®æˆå‘˜è¿˜æœªåˆå§‹åŒ–ï¼Œå› æ­¤è°ƒç”¨å­ç±»çš„è™šå‡½æ•°æ—¶ä¸å®‰å…¨çš„ï¼Œæ•…è€ŒC++ä¸ä¼šè¿›è¡ŒåŠ¨æ€è”ç¼–ã€‚</p><p>(2) <strong>ææ„å‡½æ•°è°ƒç”¨è™šå‡½æ•°æ²¡æœ‰æ„ä¹‰ï¼Œ</strong>ææ„å‡½æ•°æ˜¯ç”¨æ¥é”€æ¯ä¸€ä¸ªå¯¹è±¡çš„ï¼Œåœ¨é”€æ¯ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå…ˆè°ƒç”¨å­ç±»çš„ææ„å‡½æ•°ï¼Œç„¶åå†è°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°ã€‚æ‰€ä»¥åœ¨è°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°æ—¶ï¼Œæ´¾ç”Ÿç±»å¯¹è±¡çš„æ•°æ®æˆå‘˜å·²ç»é”€æ¯ï¼Œè¿™ä¸ªæ—¶å€™å†è°ƒç”¨å­ç±»çš„è™šå‡½æ•°æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚</p><h3 id="86-æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å¯å¦æŠ›å‡ºå¼‚å¸¸ï¼Ÿ"><a href="#86-æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å¯å¦æŠ›å‡ºå¼‚å¸¸ï¼Ÿ" class="headerlink" title="86. æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å¯å¦æŠ›å‡ºå¼‚å¸¸ï¼Ÿ"></a>86. æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å¯å¦æŠ›å‡ºå¼‚å¸¸ï¼Ÿ</h3><p>(1) <strong>æ„é€ å‡½æ•°ä¸å¯æŠ›å‡ºå¼‚å¸¸ï¼š</strong>C++åªä¼šææ„å·²ç»å®Œæˆçš„å¯¹è±¡ï¼Œå¯¹è±¡åªæœ‰åœ¨å…¶æ„é€ å‡½æ•°æ‰§è¡Œå®Œæ¯•æ‰ç®—æ˜¯å®Œå…¨æ„é€ å¦¥å½“ã€‚åœ¨æ„é€ å‡½æ•°ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œæ§åˆ¶æƒè½¬å‡ºæ„é€ å‡½æ•°ä¹‹å¤–ã€‚å› æ­¤ï¼Œ<strong>å¦‚æœæŸä¸ªå¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™è¯¥å¯¹è±¡çš„ææ„å‡½æ•°ä¸ä¼šè¢«è°ƒç”¨ã€‚å› æ­¤ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</strong></p><p>(2) <strong>ææ„å‡½æ•°ä¸å¯æŠ›å‡ºå¼‚å¸¸ï¼š</strong>å¦‚æœææ„å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™å¼‚å¸¸ç‚¹ä¹‹åçš„ç¨‹åºä¸ä¼šæ‰§è¡Œï¼Œå¦‚æœææ„å‡½æ•°åœ¨å¼‚å¸¸ç‚¹ä¹‹åæ‰§è¡Œäº†æŸäº›å¿…è¦çš„åŠ¨ä½œæ¯”å¦‚é‡Šæ”¾æŸäº›èµ„æºï¼Œåˆ™è¿™äº›åŠ¨ä½œä¸ä¼šæ‰§è¡Œï¼Œä¼šé€ æˆè¯¸å¦‚èµ„æºæ³„æ¼çš„é—®é¢˜ã€‚å†è€…ï¼Œé€šå¸¸å¼‚å¸¸å‘ç”Ÿæ—¶ï¼ŒC++ çš„æœºåˆ¶ä¼šè°ƒç”¨å·²ç»æ„é€ å¯¹è±¡çš„ææ„å‡½æ•°æ¥é‡Šæ”¾èµ„æºï¼Œæ­¤æ—¶è‹¥ææ„å‡½æ•°æœ¬èº«ä¹ŸæŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™å‰ä¸€ä¸ªå¼‚å¸¸å°šæœªå¤„ç†ï¼Œåˆæœ‰æ–°çš„å¼‚å¸¸ï¼Œä¼šé€ æˆç¨‹åºå´©æºƒçš„é—®é¢˜ã€‚</p><h3 id="87-æ¨¡æ¿ç±»å’Œæ¨¡æ¿å‡½æ•°çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#87-æ¨¡æ¿ç±»å’Œæ¨¡æ¿å‡½æ•°çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="87. æ¨¡æ¿ç±»å’Œæ¨¡æ¿å‡½æ•°çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"></a>87. æ¨¡æ¿ç±»å’Œæ¨¡æ¿å‡½æ•°çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>å‡½æ•°æ¨¡æ¿çš„å®ä¾‹åŒ–æ˜¯ç”±ç¼–è¯‘å™¨åœ¨å¤„ç†å‡½æ•°è°ƒç”¨æ—¶è‡ªåŠ¨å®Œæˆçš„ï¼Œè€Œç±»æ¨¡æ¿çš„å®ä¾‹åŒ–å¿…é¡»ç”±ç¨‹åºå‘˜åœ¨ä»£ç ä¸­æ˜¾å¼åœ°æŒ‡å®šã€‚å³å‡½æ•°æ¨¡æ¿å…è®¸éšå¼è°ƒç”¨å’Œæ˜¾å¼è°ƒç”¨ï¼Œè€Œç±»æ¨¡æ¿åªèƒ½æ˜¾å¼è°ƒç”¨ã€‚</p><h3 id="88-ä»€ä¹ˆæ˜¯è™šç»§æ‰¿ï¼Ÿ"><a href="#88-ä»€ä¹ˆæ˜¯è™šç»§æ‰¿ï¼Ÿ" class="headerlink" title="88. ä»€ä¹ˆæ˜¯è™šç»§æ‰¿ï¼Ÿ"></a>88. ä»€ä¹ˆæ˜¯è™šç»§æ‰¿ï¼Ÿ</h3><p>(1) ç”±äºC++æ”¯æŒå¤šç»§æ‰¿ï¼Œå› æ­¤é™¤äº†publicã€protectedå’Œprivateä¸‰ç§ç»§æ‰¿æ–¹å¼å¤–ï¼Œè¿˜æ”¯æŒè™šæ‹Ÿï¼ˆvirtualï¼‰ç»§æ‰¿ã€‚</p><p>(2) å¤šç»§æ‰¿æœ‰å¯èƒ½å¼•å‘ä¸€ç›´ç‰¹åˆ«æƒ…å†µï¼šBå’ŒCå…¬æœ‰ç»§æ‰¿Aï¼ŒDåˆå…¬æœ‰ç»§æ‰¿Bå’ŒCï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸€ç§è±å½¢ç»§æ‰¿æˆ–è€…é’»çŸ³ç»§æ‰¿ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240513220826075.png" alt="image-20240513220826075"></p><p>(3) å¦‚æœDè°ƒç”¨äº†Açš„æ–¹æ³•ï¼Œåˆ™ä¼šå¼•å‘æ•°æ®çš„äºŒä¹‰æ€§å’Œå†—ä½™ï¼Œç¼–è¯‘å™¨ä¸çŸ¥é“æ˜¯è¦è°ƒç”¨Bæ‰€ç»§æ‰¿çš„Aï¼Œè¿˜æ˜¯Cæ‰€ç»§æ‰¿çš„Aã€‚</p><p>(4) ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC++å¼•å…¥äº†è™šæ‹Ÿç»§æ‰¿ï¼Œåœ¨è™šæ‹Ÿç»§æ‰¿çš„æƒ…å†µä¸‹ï¼Œæ— è®ºåŸºç±»è¢«ç»§æ‰¿å¤šå°‘æ¬¡ï¼Œåªä¼šå­˜åœ¨ä¸€ä¸ªå®ä½“ã€‚</p><h3 id="89-æŠ½è±¡åŸºç±»ä¸ºä»€ä¹ˆä¸èƒ½åˆ›å»ºå¯¹è±¡ï¼Ÿçº¯è™šå‡½æ•°åˆæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#89-æŠ½è±¡åŸºç±»ä¸ºä»€ä¹ˆä¸èƒ½åˆ›å»ºå¯¹è±¡ï¼Ÿçº¯è™šå‡½æ•°åˆæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="89. æŠ½è±¡åŸºç±»ä¸ºä»€ä¹ˆä¸èƒ½åˆ›å»ºå¯¹è±¡ï¼Ÿçº¯è™šå‡½æ•°åˆæ˜¯ä»€ä¹ˆï¼Ÿ"></a>89. æŠ½è±¡åŸºç±»ä¸ºä»€ä¹ˆä¸èƒ½åˆ›å»ºå¯¹è±¡ï¼Ÿçº¯è™šå‡½æ•°åˆæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>(1) å¸¦æœ‰çº¯è™šå‡½æ•°çš„ç±»ä¸ºæŠ½è±¡ç±»ã€‚æŠ½è±¡ç±»æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»ï¼Œå®ƒæ˜¯ä¸ºäº†æŠ½è±¡å’Œè®¾è®¡çš„ç›®çš„ä¸ºå»ºç«‹çš„ã€‚æŠ½è±¡ç±»ä¼šå°†æ‰€æœ‰æ´¾ç”Ÿç±»ä¸­æœ‰å…³çš„æ“ä½œæŠ½è±¡æˆä¸€ä¸ªé€šç”¨æ¥å£ä¸”ä¸åšå…·ä½“å®ç°ï¼ˆçº¯è™šå‡½æ•°ï¼‰ï¼Œå…·ä½“å®ç°ç”±æ´¾ç”Ÿç±»å®ç°ï¼Œå› æ­¤æŠ½è±¡åŸºç±»ä¸å¯ä»¥åˆ›å»ºå¯¹è±¡ã€‚</p><p>(2) çº¯è™šå‡½æ•°æ˜¯ä¸€ç§ç‰¹æ®Šçš„è™šå‡½æ•°ï¼Œè¯¥ç±»å‡½æ•°æ²¡æœ‰å‡½æ•°ä½“ã€‚å› ä¸ºåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œåœ¨åŸºç±»ä¸­ä¸èƒ½å¯¹è™šå‡½æ•°ç»™å‡ºæœ‰æ„ä¹‰çš„å®ç°ï¼Œè€ŒæŠŠå®ƒå£°æ˜ä¸ºçº¯è™šå‡½æ•°ï¼Œå®ƒçš„å®ç°ç•™ç»™è¯¥åŸºç±»çš„æ´¾ç”Ÿç±»å»åšã€‚</p><h3 id="90-è¯´è¯´RTTIï¼Ÿ"><a href="#90-è¯´è¯´RTTIï¼Ÿ" class="headerlink" title="90. è¯´è¯´RTTIï¼Ÿ"></a>90. è¯´è¯´RTTIï¼Ÿ</h3><p><strong>è¿è¡Œæ—¶ç±»å‹è¯†åˆ«ï¼ˆRun-time type identification , RTTIï¼‰</strong>ï¼Œæ˜¯æŒ‡åœ¨åªæœ‰ä¸€ä¸ªæŒ‡å‘åŸºç±»çš„æŒ‡é’ˆæˆ–å¼•ç”¨æ—¶ï¼Œç¡®å®šæ‰€æŒ‡å¯¹è±¡çš„å‡†ç¡®ç±»å‹çš„æ“ä½œã€‚å…¶å¸¸è¢«è¯´æˆæ˜¯C++çš„å››å¤§æ‰©å±•ä¹‹ä¸€ï¼ˆå…¶ä»–ä¸‰ä¸ªä¸ºå¼‚å¸¸ã€æ¨¡æ¿å’Œåå­—ç©ºé—´ï¼‰ã€‚ä½¿ç”¨RTTIæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><p>1ã€typeid()</p><p>ç¬¬ä¸€ç§å°±åƒsizeof()ï¼Œå®ƒçœ‹ä¸Šåƒä¸€ä¸ªå‡½æ•°ï¼Œä½†å®é™…ä¸Šå®ƒæ˜¯ç”±ç¼–è¯‘å™¨å®ç°çš„ã€‚typeid()å¸¦æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡å¼•ç”¨æˆ–æŒ‡é’ˆï¼Œè¿”å›å…¨å±€typeinfoç±»çš„å¸¸é‡å¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨ã€‚å¯ä»¥ç”¨è¿ç®—ç¬¦â€œ= =â€å’Œâ€œ!=â€æ¥äº’ç›¸æ¯”è¾ƒè¿™äº›å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ç”¨name()æ¥è·å¾—ç±»å‹çš„åç§°ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨typeid æ£€æŸ¥åŸºæœ¬ç±»å‹å’Œéå¤šæ€ç±»å‹ã€‚å¦‚æœæƒ³çŸ¥é“ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡å¯¹è±¡çš„ç²¾ç¡®ç±»å‹ï¼Œæˆ‘ä»¬å¿…é¡»é€†å‘å¼•ç”¨è¿™ä¸ªæŒ‡é’ˆã€‚æ¯”å¦‚ï¼š</p><p>2ã€dynamic_cast (expression)</p><p>è¯¥è¿ç®—ç¬¦ä¸ºå¼ºåˆ¶ç±»å‹è½¬æ¢ç¬¦ï¼Œä¸Šæ–‡ç¬¬49æ¡æœ‰æåŠ</p><h3 id="91-å¤šç»§æ‰¿çš„ä¼˜ç¼ºç‚¹ï¼Œä½œä¸ºä¸€ä¸ªå¼€å‘è€…æ€ä¹ˆçœ‹å¾…å¤šç»§æ‰¿ï¼Ÿ"><a href="#91-å¤šç»§æ‰¿çš„ä¼˜ç¼ºç‚¹ï¼Œä½œä¸ºä¸€ä¸ªå¼€å‘è€…æ€ä¹ˆçœ‹å¾…å¤šç»§æ‰¿ï¼Ÿ" class="headerlink" title="91. å¤šç»§æ‰¿çš„ä¼˜ç¼ºç‚¹ï¼Œä½œä¸ºä¸€ä¸ªå¼€å‘è€…æ€ä¹ˆçœ‹å¾…å¤šç»§æ‰¿ï¼Ÿ"></a>91. å¤šç»§æ‰¿çš„ä¼˜ç¼ºç‚¹ï¼Œä½œä¸ºä¸€ä¸ªå¼€å‘è€…æ€ä¹ˆçœ‹å¾…å¤šç»§æ‰¿ï¼Ÿ</h3><p>å¤šé‡ç»§æ‰¿çš„ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ä¸€ä¸ªå¯¹è±¡å¯ä»¥è°ƒç”¨å¤šä¸ªåŸºç±»ä¸­çš„æ¥å£ã€‚å¤šç»§æ‰¿å®¹æ˜“å¯¼è‡´è±å½¢ç»§æ‰¿é—®é¢˜ï¼Œè™½ç„¶å¯ä»¥ç”¨è™šç»§æ‰¿è§£å†³è¯¥é—®é¢˜ï¼Œä½†ä¹Ÿä¼šé€ æˆå†…å­˜ç»“æ„å¤æ‚ï¼Œæ•ˆç‡é™ä½ï¼Œç»§æ‰¿ä½“ç³»è¿‡äºå¤æ‚åŒ–çš„ç¼ºç‚¹ã€‚</p><h3 id="92-ä¸ºä»€ä¹ˆæ‹·è´æ„é€ å‡½æ•°å¿…é¡»ä¼ å¼•ç”¨ä¸èƒ½ä¼ å€¼ï¼Ÿ"><a href="#92-ä¸ºä»€ä¹ˆæ‹·è´æ„é€ å‡½æ•°å¿…é¡»ä¼ å¼•ç”¨ä¸èƒ½ä¼ å€¼ï¼Ÿ" class="headerlink" title="92. ä¸ºä»€ä¹ˆæ‹·è´æ„é€ å‡½æ•°å¿…é¡»ä¼ å¼•ç”¨ä¸èƒ½ä¼ å€¼ï¼Ÿ"></a>92. ä¸ºä»€ä¹ˆæ‹·è´æ„é€ å‡½æ•°å¿…é¡»ä¼ å¼•ç”¨ä¸èƒ½ä¼ å€¼ï¼Ÿ</h3><p>æ‹·è´æ„é€ å‡½æ•°çš„ä½œç”¨å°±æ˜¯ç”¨æ¥æ‹·è´å¯¹è±¡çš„ï¼Œä½¿ç”¨ä¸€ä¸ªå·²å­˜åœ¨çš„å¯¹è±¡æ¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚å¦‚æœä½¿ç”¨ä¼ å€¼æ–¹å¼ï¼Œé‚£ä¹ˆåœ¨æ‹·è´æ„é€ å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œ<strong>åœ¨è¿›è¡Œå‚æ•°ä¼ é€’çš„æ—¶å€™å°±ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Œè¿™æ ·ä¼šå¯¼è‡´é€’å½’æº¢å‡ºã€‚</strong></p><h3 id="93-ä¸ºä»€ä¹ˆåœ¨C-C-ä¸­è¦å°†ä»£ç åˆ†ä¸ºå¤´æ–‡ä»¶å’Œæºæ–‡ä»¶ï¼Œä¸èƒ½å†™åˆ°ä¸€èµ·å—ï¼Ÿ"><a href="#93-ä¸ºä»€ä¹ˆåœ¨C-C-ä¸­è¦å°†ä»£ç åˆ†ä¸ºå¤´æ–‡ä»¶å’Œæºæ–‡ä»¶ï¼Œä¸èƒ½å†™åˆ°ä¸€èµ·å—ï¼Ÿ" class="headerlink" title="93. ä¸ºä»€ä¹ˆåœ¨C/C++ä¸­è¦å°†ä»£ç åˆ†ä¸ºå¤´æ–‡ä»¶å’Œæºæ–‡ä»¶ï¼Œä¸èƒ½å†™åˆ°ä¸€èµ·å—ï¼Ÿ"></a>93. ä¸ºä»€ä¹ˆåœ¨C/C++ä¸­è¦å°†ä»£ç åˆ†ä¸ºå¤´æ–‡ä»¶å’Œæºæ–‡ä»¶ï¼Œä¸èƒ½å†™åˆ°ä¸€èµ·å—ï¼Ÿ</h3><p>(1) <strong>å°†æ‰€æœ‰ä»£ç å†™å…¥ä¸€ä¸ªæ–‡ä»¶ä¸­å½“ç„¶å¯ä»¥ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡ç¼–è¯‘ä¸”æ­£å¸¸è¿è¡Œ</strong>ã€‚</p><p>(2) <strong>åˆ†å¼€å†™çš„ç›®çš„æ˜¯æ–¹ä¾¿æœªæ¥ã€‚</strong>æœ‰æ—¶å€™æˆ‘ä»¬å†™çš„ä»£ç ä¼šç»™åˆ«äººå»ç”¨ï¼Œå¦‚æœæ˜¯éå¼€æºä»£ç ï¼Œå¯ä»¥å°†æºæ–‡ä»¶å°è£…èµ·æ¥å¹¶ç”Ÿæˆåº“æ–‡ä»¶ï¼ˆ<strong>åº“æ–‡ä»¶æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— æ³•æŸ¥é˜…ä»£ç </strong>ï¼‰ã€‚åªå¯¹å¤–å¼€æ”¾å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶ï¼Œé‚£ä¹ˆåˆ«äººå°±æ— æ³•çœ‹åˆ°ä»£ç çš„å…·ä½“å®ç°äº†ã€‚</p><h2 id="C-11"><a href="#C-11" class="headerlink" title="C++11"></a>C++11</h2><h3 id="1-autoã€decltypeçš„ç”¨æ³•ï¼Ÿ"><a href="#1-autoã€decltypeçš„ç”¨æ³•ï¼Ÿ" class="headerlink" title="1. autoã€decltypeçš„ç”¨æ³•ï¼Ÿ"></a>1. autoã€decltypeçš„ç”¨æ³•ï¼Ÿ</h3><p>(1) autoï¼šC++11å¼•å…¥äº†autoç±»å‹è¯´æ˜ç¬¦ï¼Œå®ƒå¯ä»¥è®©ç¼–è¯‘å™¨é€šè¿‡åˆå§‹å€¼æ¥è¿›è¡Œç±»å‹æ¨æ¼”ï¼Œä½¿å¾—ç¨‹åºå‘˜æ— éœ€çŸ¥é“ç±»å‹åç§°å°±å¯ä»¥å®šä¹‰å˜é‡ï¼Œæ‰€ä»¥auto å®šä¹‰çš„å˜é‡å¿…é¡»æœ‰åˆå§‹å€¼ã€‚</p><p>(2) decltype: autoå®šä¹‰çš„å˜é‡å¿…é¡»åˆå§‹åŒ–ï¼Œå¦‚æœæˆ‘ä»¬ä¸æƒ³è¦åˆå§‹åŒ–å°±å¯ä»¥ä½¿ç”¨decltypeï¼Œå®ƒä¼šè¿”å›å‚æ•°çš„æ•°æ®ç±»å‹ï¼Œå¹¶å®šä¹‰æ–°çš„å˜é‡ï¼Œè€Œä¸”æ–°å˜é‡çš„å€¼ä¸ä¼šè¢«åˆå§‹åŒ–ã€‚</p><h3 id="2-C-ä¸­NULLå’Œnullptrçš„åŒºåˆ«ï¼Ÿ"><a href="#2-C-ä¸­NULLå’Œnullptrçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="2. C++ä¸­NULLå’Œnullptrçš„åŒºåˆ«ï¼Ÿ"></a>2. C++ä¸­NULLå’Œnullptrçš„åŒºåˆ«ï¼Ÿ</h3><p>(1) NULLæ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼ŒCä¸­NULLä¸ºï¼ˆvoid*)0ï¼ŒC++ä¸­NULLä¸ºæ•´æ•°0ã€‚</p><p>(2) å°†NULLå®šä¹‰ä¸º0å¸¦æ¥çš„ä¸€ä¸ªé—®é¢˜æ˜¯æ— æ³•ä¸æ•´æ•°çš„0åŒºåˆ†ï¼Œå› ä¸ºC++ä¸­å…è®¸æœ‰å‡½æ•°é‡è½½ï¼Œè‹¥æ˜¯æœ‰ä¸ªaã€bä¸¤ä¸ªé‡è½½å‡½æ•°ï¼Œå‚æ•°åˆ†åˆ«ä¸ºæ•´æ•°å’ŒæŒ‡é’ˆï¼Œé‚£ä¹ˆåœ¨ä¼ å…¥NULLå‚æ•°æ—¶ï¼Œä¼šæŠŠNULLå½“åšæ•´æ•°0æ¥çœ‹ï¼Œå¯¼è‡´é”™è¯¯è°ƒç”¨äº†å‚æ•°ä¸ºæ•´æ•°çš„å‡½æ•°ã€‚</p><p>(3) nullptrå¯ä»¥è§£å†³è¿™ä¸€é—®é¢˜ï¼Œnullptrå¯ä»¥æ˜ç¡®åŒºåˆ†æ•´å‹å’ŒæŒ‡é’ˆç±»å‹ï¼Œèƒ½å¤Ÿæ ¹æ®ç¯å¢ƒè‡ªåŠ¨è½¬æ¢æˆç›¸åº”çš„æŒ‡é’ˆç±»å‹ï¼Œä½†ä¸ä¼šè¢«è½¬æ¢ä¸ºä»»ä½•æ•´å‹ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆå‚æ•°ä¼ é€’é”™è¯¯ã€‚</p><h3 id="3-è¯´è¯´finalå’Œoverrideå…³é”®å­—ï¼Ÿ"><a href="#3-è¯´è¯´finalå’Œoverrideå…³é”®å­—ï¼Ÿ" class="headerlink" title="3. è¯´è¯´finalå’Œoverrideå…³é”®å­—ï¼Ÿ"></a>3. è¯´è¯´finalå’Œoverrideå…³é”®å­—ï¼Ÿ</h3><p>(1) OverrideæŒ‡å®šäº†å­ç±»çš„è¿™ä¸ªè™šå‡½æ•°æ˜¯å¯¹çˆ¶ç±»è™šå‡½æ•°çš„é‡å†™ï¼Œå¦‚æœå‡½æ•°åä¸å°å¿ƒæ‰“é”™äº†çš„è¯ï¼Œç¼–è¯‘å™¨ä¼šè¿›è¡ŒæŠ¥é”™ã€‚</p><p>(2) å½“ä¸å¸Œæœ›æŸä¸ªç±»è¢«ç»§æ‰¿ï¼Œæˆ–ä¸å¸Œæœ›æŸä¸ªè™šå‡½æ•°è¢«é‡å†™ï¼Œå¯ä»¥åœ¨ç±»åå’Œè™šå‡½æ•°åæ·»åŠ finalå…³é”®å­—ï¼Œæ·»åŠ finalå…³é”®å­—åå¦‚æœè¢«ç»§æ‰¿æˆ–é‡å†™ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚</p><p>ä¸¾ä¾‹ï¼š</p><p>åœ¨C++ä¸­ï¼Œ<code>final</code> å’Œ <code>override</code> æ˜¯ä¸¤ä¸ªéå¸¸æœ‰ç”¨çš„å…³é”®å­—ï¼Œå®ƒä»¬ä¸»è¦ç”¨äºç±»å’Œæˆå‘˜å‡½æ•°çš„ç»§æ‰¿ã€‚</p><ol><li><code>final</code> å…³é”®å­—å¯ä»¥ç”¨äºé˜»æ­¢ç±»çš„è¿›ä¸€æ­¥ç»§æ‰¿ï¼Œæˆ–è€…é˜»æ­¢è™šå‡½æ•°çš„è¿›ä¸€æ­¥è¦†ç›–ã€‚ä¾‹å¦‚ï¼š</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> <span class="keyword">final</span> &#123;   <span class="comment">// è¿™ä¸ªç±»ä¸èƒ½è¢«ç»§æ‰¿</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">func</span><span class="params">()</span> <span class="keyword">final</span> </span>&#123;   <span class="comment">// è¿™ä¸ªå‡½æ•°ä¸èƒ½è¢«å­ç±»è¦†ç›–</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol><li><code>override</code> å…³é”®å­—ç”¨äºæ˜ç¡®è¡¨ç¤ºä¸€ä¸ªè™šå‡½æ•°è¦†ç›–äº†åŸºç±»ä¸­çš„è™šå‡½æ•°ã€‚è¿™æœ‰åŠ©äºç¼–è¯‘å™¨æ£€æŸ¥æˆ‘ä»¬çš„ä»£ç ï¼Œå¦‚æœåŸºç±»ä¸­æ²¡æœ‰å¯¹åº”çš„è™šå‡½æ•°ï¼Œä½¿ç”¨ <code>override</code> å°†å¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚ä¾‹å¦‚ï¼š</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;   <span class="comment">// æ˜ç¡®è¡¨ç¤ºè¿™ä¸ªå‡½æ•°è¦†ç›–äº†åŸºç±»çš„è™šå‡½æ•°</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±æ˜¯ <code>final</code> å’Œ <code>override</code> åœ¨C++ä¸­çš„åŸºæœ¬ç”¨æ³•ã€‚è¿™ä¸¤ä¸ªå…³é”®å­—éƒ½å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™å‡ºæ›´æ¸…æ™°ã€æ›´å®‰å…¨çš„ä»£ç ã€‚</p><h3 id="4-C-ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿ"><a href="#4-C-ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿ" class="headerlink" title="4. C++ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿ"></a>4. C++ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿ</h3><p>(1) æ™ºèƒ½æŒ‡é’ˆä¼šç®¡ç†ç¨‹åºå‘˜ç”³è¯·çš„å†…å­˜ï¼Œåœ¨ä½¿ç”¨ç»“æŸåä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œé˜²æ­¢å †å†…å­˜æ³„æ¼ã€‚</p><p>(2) <strong>auto_ptrï¼š</strong>æœ€åŸå§‹çš„æ™ºèƒ½æŒ‡é’ˆã€‚auto_ptré‡‡ç”¨çš„æ˜¯<strong>ç‹¬äº«æ‰€æœ‰æƒè¯­ä¹‰</strong>ï¼Œä¸€ä¸ªéç©ºçš„auto_ptræ€»æ˜¯æ‹¥æœ‰å®ƒæ‰€æŒ‡å‘çš„èµ„æºï¼Œè½¬ç§»ä¸€ä¸ªauto_ptrå°†ä¼šæŠŠæ‰€æœ‰æƒå…¨éƒ¨ä»æºæŒ‡é’ˆè½¬ç§»ç»™ç›®æ ‡æŒ‡é’ˆï¼ŒæºæŒ‡é’ˆè¢«ç½®ç©ºã€‚ç”±äºæ”¯æŒæ‹·è´è¯­ä¹‰ï¼Œæ‹·è´åæºå¯¹è±¡å˜å¾—æ— æ•ˆï¼Œå¦‚æœç¨‹åºå‘˜å¿½è§†äº†è¿™ç‚¹ï¼Œè¿™å¯èƒ½å¼•å‘å¾ˆä¸¥é‡çš„é—®é¢˜ã€‚<strong>åœ¨C++11ä¸­è¯¥æŒ‡é’ˆå·²è¢«å¼ƒç”¨</strong>ã€‚</p><p>(3) <strong>unique_ptrï¼š</strong>ä¸auto_ptrç±»ä¼¼ï¼Œé‡‡ç”¨<strong>ç‹¬äº«æ‰€æœ‰æƒè¯­ä¹‰</strong>ã€‚<strong>unique_ptræä¾›ç§»åŠ¨è¯­ä¹‰</strong>ï¼Œè¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šé¿å…äº†auto_ptrçš„é”™è¯¯ï¼Œå› ä¸ºå¾ˆæ˜æ˜¾å¿…é¡»ä½¿ç”¨std::move()è¿›è¡Œè½¬ç§»ï¼Œæé†’ç¨‹åºå‘˜åœ¨è¿™ä¸ªåœ°æ–¹å‘ç”Ÿäº†ç§»åŠ¨ã€‚</p><p>(4) <strong>shared_ptrï¼š</strong>é‡‡ç”¨<strong>å¼•ç”¨è®¡æ•°å™¨</strong>çš„æ–¹æ³•ï¼Œå…è®¸å¤šä¸ªæ™ºèƒ½æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ¯å½“å¤šä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘è¯¥å¯¹è±¡æ—¶ï¼ŒæŒ‡å‘è¯¥å¯¹è±¡çš„æ‰€æœ‰æ™ºèƒ½æŒ‡é’ˆå†…éƒ¨çš„å¼•ç”¨è®¡æ•°åŠ 1ï¼Œæ¯å½“å‡å°‘ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆæŒ‡å‘å¯¹è±¡æ—¶ï¼Œå¼•ç”¨è®¡æ•°ä¼šå‡1ï¼Œå½“è®¡æ•°ä¸º0çš„æ—¶å€™ä¼šè‡ªåŠ¨çš„é‡Šæ”¾åŠ¨æ€åˆ†é…çš„èµ„æºã€‚å¼•ç”¨è®¡æ•°å™¨çš„å˜åŒ–ä¾æ®å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>â‘ ã€€æ¯æ¬¡åˆ›å»ºç±»çš„æ–°å¯¹è±¡æ—¶ï¼Œåˆå§‹åŒ–æŒ‡é’ˆå¹¶å°†å¼•ç”¨è®¡æ•°ç½®ä¸º1</p><p>â‘¡ã€€å½“å¯¹è±¡ä½œä¸ºå¦ä¸€å¯¹è±¡çš„å‰¯æœ¬è€Œåˆ›å»ºæ—¶ï¼Œæ‹·è´æ„é€ å‡½æ•°ä¼šæ‹·è´æŒ‡é’ˆå¹¶å¢åŠ ä¸ä¹‹ç›¸åº”çš„å¼•ç”¨è®¡æ•°</p><p>â‘¢ã€€å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œèµ‹å€¼æ—¶ï¼Œèµ‹å€¼æ“ä½œç¬¦å‡å°‘å·¦æ“ä½œæ•°æ‰€æŒ‡å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆå¦‚æœå¼•ç”¨è®¡æ•°ä¸ºå‡è‡³0ï¼Œåˆ™åˆ é™¤å¯¹è±¡ï¼‰ï¼Œå¹¶å¢åŠ å³æ“ä½œæ•°æ‰€æŒ‡å¯¹è±¡çš„å¼•ç”¨è®¡æ•°</p><p>â‘£ã€€è°ƒç”¨ææ„å‡½æ•°æ—¶ï¼Œæ„é€ å‡½æ•°å‡å°‘å¼•ç”¨è®¡æ•°ï¼ˆå¦‚æœå¼•ç”¨è®¡æ•°å‡è‡³0ï¼Œåˆ™åˆ é™¤åŸºç¡€å¯¹è±¡ï¼‰</p><p>(5) <strong>weak_ptrï¼š</strong> ç”±äºshared_ptrå¼•ç”¨è®¡æ•°å­˜åœ¨çš„é—®é¢˜ï¼Œå³äº’ç›¸å¼•ç”¨å½¢æˆç¯ï¼ˆç¯å½¢å¼•ç”¨ï¼‰ï¼Œä½¿å¾—ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜éƒ½æ— æ³•é‡Šæ”¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>â‘ ã€€ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC++å¼•å…¥äº†weak_ptr(å¼±å¼•ç”¨)ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªç”±shared_ptrç®¡ç†çš„å¯¹è±¡è€Œä¸å½±å“æ‰€æŒ‡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>å®ƒåªå¼•ç”¨ï¼Œä¸è®¡æ•°</strong>ã€‚</p><p>â‘¡ã€€å¦‚æœä¸€å—å†…å­˜è¢«shared_ptrå’Œweak_ptråŒæ—¶å¼•ç”¨ï¼Œå½“æ‰€æœ‰shared_ptrææ„äº†ä¹‹åï¼Œä¸ç®¡è¿˜æœ‰æ²¡æœ‰weak_ptrå¼•ç”¨è¯¥å†…å­˜ï¼Œå†…å­˜ä¹Ÿä¼šè¢«é‡Šæ”¾ã€‚</p><p>â‘¢ã€€weak_pträ¸ä¿è¯å®ƒæŒ‡å‘çš„å†…å­˜ä¸€å®šæ˜¯æœ‰æ•ˆçš„ï¼Œåœ¨ä½¿ç”¨ä¹‹å‰åº”å…ˆæ£€æŸ¥weak_ptræ˜¯å¦ä¸ºç©ºæŒ‡é’ˆï¼Œé¿å…è®¿é—®éæ³•å†…å­˜ï¼Œä¹Ÿå› æ­¤weak_ptrå¹¶ä¸èƒ½ç›´æ¥è®¿é—®å¯¹è±¡ï¼Œä»–åªèƒ½é€šè¿‡è½¬åŒ–ä¸ºshared_ptræ¥ä½¿ç”¨å¯¹è±¡ã€‚</p><blockquote><p><strong>share_ptræ‰‹å†™</strong></p></blockquote><p><strong>share_ptr-double freeé—®é¢˜</strong>ï¼šdouble free é—®é¢˜å°±æ˜¯ä¸€å—å†…å­˜ç©ºé—´æˆ–è€…èµ„æºè¢«é‡Šæ”¾ä¸¤æ¬¡ã€‚</p><p>double free å¯èƒ½æ˜¯ä¸‹é¢è¿™äº›åŸå› é€ æˆçš„ï¼š</p><ul><li>ç›´æ¥ä½¿ç”¨åŸå§‹æŒ‡é’ˆåˆ›å»ºå¤šä¸ª shared_ptrï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ shared_ptr çš„ make_shared å·¥å‚å‡½æ•°ï¼Œä»è€Œå¯¼è‡´å¤šä¸ªç‹¬ç«‹çš„å¼•ç”¨è®¡æ•°ã€‚</li><li>å¾ªç¯å¼•ç”¨ï¼Œå³ä¸¤ä¸ªæˆ–å¤šä¸ª shared_ptr äº’ç›¸å¼•ç”¨ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°æ°¸è¿œæ— æ³•é™ä¸ºé›¶ï¼Œä»è€Œæ— æ³•é‡Šæ”¾å†…å­˜ã€‚</li></ul><p>case1:ä¸¾ä¾‹</p><p>åœ¨C++ä¸­ï¼Œstd::shared_ptr æ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒå¯ä»¥è‡ªåŠ¨ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å®ƒé€šè¿‡å¼•ç”¨è®¡æ•°æ¥ç¡®ä¿å½“æ²¡æœ‰ä»»ä½• shared_ptr æŒ‡å‘ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè¯¥å¯¹è±¡ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</p><p>ç„¶è€Œï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æŒ‡é’ˆåˆ›å»ºå¤šä¸ª shared_ptrï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ shared_ptr çš„ make_shared å·¥å‚å‡½æ•°ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤šä¸ªç‹¬ç«‹çš„å¼•ç”¨è®¡æ•°ï¼Œè¿›è€Œå¯¼è‡´double-freeçš„é—®é¢˜ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>* ptr = <span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">10</span>); <span class="comment">// åˆ›å»ºä¸€ä¸ªåŸå§‹æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæ–°çš„intå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„shared_ptrï¼Œå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="function">std::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp1</span><span class="params">(ptr)</span></span>;</span><br><span class="line"><span class="function">std::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp2</span><span class="params">(ptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“sp1å’Œsp2ç¦»å¼€å…¶ä½œç”¨åŸŸæ—¶ï¼Œå®ƒä»¬éƒ½ä¼šè¯•å›¾åˆ é™¤åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¯¼è‡´double-freeçš„é—®é¢˜</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªç‹¬ç«‹çš„ shared_ptrï¼Œå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚å½“å®ƒä»¬ç¦»å¼€å…¶ä½œç”¨åŸŸæ—¶ï¼Œå®ƒä»¬éƒ½ä¼šè¯•å›¾åˆ é™¤åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¯¼è‡´double-freeçš„é—®é¢˜ã€‚</p><p>æ­£ç¡®çš„åšæ³•æ˜¯ä½¿ç”¨ make_shared å·¥å‚å‡½æ•°æ¥åˆ›å»º shared_ptrï¼Œæˆ–è€…åªä½¿ç”¨ä¸€ä¸ªåŸå§‹æŒ‡é’ˆæ¥åˆå§‹åŒ–ä¸€ä¸ª shared_ptrï¼Œç„¶åä½¿ç”¨è¿™ä¸ª shared_ptr æ¥åˆå§‹åŒ–å…¶ä»–çš„ shared_ptrã€‚è¿™æ ·ï¼Œæ‰€æœ‰çš„ shared_ptr éƒ½ä¼šå…±äº«åŒä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>; <span class="comment">// ä½¿ç”¨åŸå§‹æŒ‡é’ˆåˆå§‹åŒ–ä¸€ä¸ªshared_ptr</span></span><br><span class="line">std::shared_ptr&lt;<span class="type">int</span>&gt; sp2 = sp1; <span class="comment">// ä½¿ç”¨sp1åˆå§‹åŒ–sp2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–è€…</span></span><br><span class="line"></span><br><span class="line">std::shared_ptr&lt;<span class="type">int</span>&gt; sp1 = std::<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt;(<span class="number">10</span>); <span class="comment">// ä½¿ç”¨make_sharedåˆ›å»ºä¸€ä¸ªshared_ptr</span></span><br><span class="line">std::shared_ptr&lt;<span class="type">int</span>&gt; sp2 = sp1; <span class="comment">// ä½¿ç”¨sp1åˆå§‹åŒ–sp2</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°æ­£ç¡®çš„åšæ³•ä¸­ï¼Œæ‰€æœ‰çš„ shared_ptr éƒ½ä¼šå…±äº«åŒä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå› æ­¤ä¸ä¼šå‡ºç°double-freeçš„é—®é¢˜ã€‚</p><p>case2:</p><p>å¾ªç¯å¼•ç”¨é—®é¢˜</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>; <span class="comment">// å‰å‘å£°æ˜</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::shared_ptr&lt;B&gt; b_ptr;</span><br><span class="line">    ~<span class="built_in">A</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;A destructor called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::shared_ptr&lt;A&gt; a_ptr;</span><br><span class="line">    ~<span class="built_in">B</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;B destructor called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        std::shared_ptr&lt;A&gt; a = std::<span class="built_in">make_shared</span>&lt;A&gt;();</span><br><span class="line">        std::shared_ptr&lt;B&gt; b = std::<span class="built_in">make_shared</span>&lt;B&gt;();</span><br><span class="line">        a-&gt;b_ptr = b; <span class="comment">// A æŒ‡å‘ B</span></span><br><span class="line">        b-&gt;a_ptr = a; <span class="comment">// B æŒ‡å‘ A</span></span><br><span class="line">    &#125; <span class="comment">// a å’Œ b ç¦»å¼€ä½œç”¨åŸŸï¼Œä½†ç”±äºå¾ªç¯å¼•ç”¨ï¼Œå®ƒä»¬çš„ææ„å‡½æ•°ä¸ä¼šè¢«è°ƒç”¨</span></span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;End of main&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨weak_ptr</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>; <span class="comment">// å‰å‘å£°æ˜</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::shared_ptr&lt;B&gt; b_ptr;</span><br><span class="line">    ~<span class="built_in">A</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;A destructor called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::weak_ptr&lt;A&gt; a_ptr; <span class="comment">// ä½¿ç”¨ weak_ptr æ›¿ä»£ shared_ptr</span></span><br><span class="line">    ~<span class="built_in">B</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;B destructor called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        std::shared_ptr&lt;A&gt; a = std::<span class="built_in">make_shared</span>&lt;A&gt;();</span><br><span class="line">        std::shared_ptr&lt;B&gt; b = std::<span class="built_in">make_shared</span>&lt;B&gt;();</span><br><span class="line">        a-&gt;b_ptr = b; <span class="comment">// A æŒ‡å‘ B</span></span><br><span class="line">        b-&gt;a_ptr = a; <span class="comment">// B å¯¹ A ä½¿ç”¨ weak_ptr</span></span><br><span class="line">    &#125; <span class="comment">// a å’Œ b ç¦»å¼€ä½œç”¨åŸŸï¼Œå®ƒä»¬çš„ææ„å‡½æ•°ä¼šè¢«æ­£ç¡®è°ƒç”¨</span></span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;End of main&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>enable_shared_from_this</strong><br>ä»åå­—å¯ä»¥çœ‹å‡ºå‡ ä¸ªå…³é”®è¯ï¼šenable: å…è®¸ shared æŒ‡ shared_ptr, from_this åˆ™æ˜¯æŒ‡ä»ç±»è‡ªèº«this æ„é€  shared_ptrã€‚</p><p>æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SomeData</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SomeAPI</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;SomeData&gt;&amp; d)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SomeData</span> &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">NeedCallSomeAPI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// éœ€è¦ç”¨thisè°ƒç”¨SomeAPI</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç éœ€è¦åœ¨NeedCallSomeAPIå‡½æ•°ä¸­è°ƒç”¨SomeAPIï¼Œè€ŒSomeAPIéœ€è¦çš„æ˜¯ä¸€ä¸ªstd::shared_ptrçš„å®å‚ã€‚è¿™ä¸ªæ—¶å€™åº”è¯¥æ€ä¹ˆåšï¼Ÿ è¿™æ ·å—ï¼Ÿ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SomeData</span> &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">NeedCallSomeAPI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">SomeAPI</span>(std::shared_ptr&lt;SomeData&gt;&#123;<span class="keyword">this</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„åšæ³•æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºSomeAPIè°ƒç”¨ç»“æŸåstd::shared_ptrå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¼šé™ä¸º0ï¼Œå¯¼è‡´ this è¢«æ„å¤–é‡Šæ”¾ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨std::enable_shared_from_this ï¼Œä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦è®©SomeDataç»§æ‰¿std::enable_shared_from_thisï¼Œç„¶åè°ƒç”¨shared_from_thisï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">st</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">const</span> shared_ptr&lt;st&gt; &amp;d)</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">st</span> : enable_shared_from_this&lt;st&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">static</span> shared_ptr&lt;st&gt; <span class="title">New</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;st&gt;(<span class="keyword">new</span> st);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">fun</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> num = <span class="number">66</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">const</span> shared_ptr&lt;st&gt; &amp;d)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; d-&gt;num &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> p = st::<span class="built_in">New</span>();</span><br><span class="line">    p-&gt;<span class="built_in">f1</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼Œå½“ä¸‹é¢ğŸ‘‡è¿™äº›åœºæ™¯ç”¨åˆ° shared_ptr æ—¶ï¼Œéœ€è¦æ­é…ä¸Š enable_shared_from_this:</p><ul><li>å½“ä½ éœ€è¦å°†thisæŒ‡é’ˆä¼ é€’ç»™å…¶ä»–å‡½æ•°æˆ–æ–¹æ³•ï¼Œè€Œè¿™äº›å‡½æ•°æˆ–æ–¹æ³•éœ€è¦ä¸€ä¸ªstd::shared_ptrï¼Œè€Œä¸æ˜¯è£¸æŒ‡é’ˆã€‚</li><li>å½“ä½ éœ€è¦åœ¨ç±»çš„æˆå‘˜å‡½æ•°å†…éƒ¨åˆ›å»ºæŒ‡å‘å½“å‰å¯¹è±¡çš„std::shared_ptrï¼Œä¾‹å¦‚åœ¨å›è°ƒå‡½æ•°æˆ–äº‹ä»¶å¤„ç†ä¸­ã€‚</li></ul><p>æ‰‹æ•²æ™ºèƒ½æŒ‡é’ˆæ˜¯é¢è¯•å¸¸è§çš„é¢˜ç›®ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleSharedPtr</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">SimpleSharedPtr</span><span class="params">(T* ptr = <span class="literal">nullptr</span>)</span> : ptr_(ptr), count_(ptr ? new size_t(<span class="number">1</span>) : nullptr) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">SimpleSharedPtr</span>(<span class="type">const</span> SimpleSharedPtr&amp; other) : <span class="built_in">ptr_</span>(other.ptr_), <span class="built_in">count_</span>(other.count_) &#123;</span><br><span class="line">        <span class="keyword">if</span> (count_) &#123;</span><br><span class="line">            ++(*count_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èµ‹å€¼æ“ä½œç¬¦</span></span><br><span class="line">    SimpleSharedPtr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> SimpleSharedPtr&amp; other) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;other) &#123;</span><br><span class="line">            <span class="built_in">release</span>();</span><br><span class="line">            ptr_ = other.ptr_;</span><br><span class="line">            count_ = other.count_;</span><br><span class="line">            <span class="keyword">if</span> (count_) &#123;</span><br><span class="line">                ++(*count_);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ææ„å‡½æ•°</span></span><br><span class="line">    ~<span class="built_in">SimpleSharedPtr</span>() &#123;</span><br><span class="line">        <span class="built_in">release</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="type">const</span> &#123; <span class="keyword">return</span> *ptr_; &#125;</span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;() <span class="type">const</span> &#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    <span class="function">T* <span class="title">get</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> count_ ? *count_ : <span class="number">0</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count_ &amp;&amp; --(*count_) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">delete</span> ptr_;</span><br><span class="line">            <span class="keyword">delete</span> count_;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    T* ptr_;</span><br><span class="line">    <span class="type">size_t</span>* count_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyClass</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;MyClass æ„é€ å‡½æ•°\n&quot;</span>; &#125;</span><br><span class="line">    ~<span class="built_in">MyClass</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;MyClass ææ„å‡½æ•°\n&quot;</span>; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">do_something</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;MyClass::do_something() è¢«è°ƒç”¨\n&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">SimpleSharedPtr&lt;MyClass&gt; <span class="title">ptr1</span><span class="params">(<span class="keyword">new</span> MyClass())</span></span>;</span><br><span class="line">        &#123;</span><br><span class="line">            SimpleSharedPtr&lt;MyClass&gt; ptr2 = ptr1;</span><br><span class="line">            ptr1-&gt;<span class="built_in">do_something</span>();</span><br><span class="line">            ptr2-&gt;<span class="built_in">do_something</span>();</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;å¼•ç”¨è®¡æ•°: &quot;</span> &lt;&lt; ptr1.<span class="built_in">use_count</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å¼•ç”¨è®¡æ•°: &quot;</span> &lt;&lt; ptr1.<span class="built_in">use_count</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><a href="https://csguide.cn/cpp/memory/shared_ptr.html#%E6%89%8B%E5%86%99-shared-ptr">https://csguide.cn/cpp/memory/shared_ptr.html#%E6%89%8B%E5%86%99-shared-ptr</a></li></ul><h3 id="5-è¯´è¯´STLå®¹å™¨ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿ"><a href="#5-è¯´è¯´STLå®¹å™¨ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿ" class="headerlink" title="5. è¯´è¯´STLå®¹å™¨ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿ"></a>5. è¯´è¯´STLå®¹å™¨ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿ</h3><p>å…·å¤‡<strong>ç‹¬å æ‰€æœ‰æƒè¯­ä¹‰</strong>çš„æ™ºèƒ½æŒ‡é’ˆä¸èƒ½åœ¨STLçš„å®¹å™¨ä¸­ä½¿ç”¨ï¼Œå¦‚auto_ptrå’Œunique_ptrï¼Œå› ä¸ºSTLå®¹å™¨ä¸­çš„å…ƒç´ ç»å¸¸è¦æ”¯æŒæ‹·è´ã€èµ‹å€¼æ“ä½œï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­auto_pträ¼šä¼ é€’æ‰€æœ‰æƒï¼Œå®¹æ˜“å¯¼è‡´é”™è¯¯ï¼Œè€Œunique_ptråˆä¸æ”¯æŒæ™®é€šçš„æ‹·è´å’Œèµ‹å€¼æ“ä½œï¼Œä¹Ÿä¸èƒ½ç”¨åœ¨STLæ ‡å‡†å®¹å™¨ä¸­ã€‚</p><h3 id="6-è¯´è¯´lambdaå‡½æ•°ï¼Ÿ"><a href="#6-è¯´è¯´lambdaå‡½æ•°ï¼Ÿ" class="headerlink" title="6. è¯´è¯´lambdaå‡½æ•°ï¼Ÿ"></a>6. è¯´è¯´lambdaå‡½æ•°ï¼Ÿ</h3><p>åˆ©ç”¨lambdaè¡¨è¾¾å¼å¯ä»¥ç¼–å†™å†…åµŒçš„åŒ¿åå‡½æ•°ï¼Œç”¨ä»¥æ›¿æ¢ç‹¬ç«‹å‡½æ•°æˆ–è€…å‡½æ•°å¯¹è±¡ã€‚æ¯å½“ä½ å®šä¹‰ä¸€ä¸ªlambdaè¡¨è¾¾å¼åï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåŒ¿åç±»ï¼ˆè¿™ä¸ªç±»å½“ç„¶é‡è½½äº†()è¿ç®—ç¬¦ï¼‰ï¼Œæˆ‘ä»¬ç§°ä¸ºé—­åŒ…ç±»å‹ï¼ˆclosure typeï¼‰ã€‚é‚£ä¹ˆåœ¨è¿è¡Œæ—¶ï¼Œè¿™ä¸ªlambdaè¡¨è¾¾å¼å°±ä¼šè¿”å›ä¸€ä¸ªåŒ¿åçš„é—­åŒ…å®ä¾‹ï¼Œè¯¥å®ä¾‹æ˜¯ä¸€ä¸ªå³å€¼ã€‚lambdaçš„ä¼˜ç‚¹æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><p>(1) <strong>è·ç¦»</strong>ï¼šå¾ˆå¤šäººè®¤ä¸ºï¼Œè®©å®šä¹‰ä½äºä½¿ç”¨çš„åœ°æ–¹é™„è¿‘å¾ˆæœ‰ç”¨ã€‚è¿™æ ·ï¼Œå°±æ— éœ€ç¿»é˜…å¾ˆå¤šé¡µçš„æºä»£ç ï¼Œä»¥äº†è§£å‡½æ•°ã€‚å¦å¤–ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹ä»£ç ï¼Œè®¾è®¡çš„å†…å®¹å°±åœ¨é™„è¿‘ï¼Œå°±å¾ˆå¥½ä¿®æ”¹ã€‚</p><p>(2) <strong>ç®€æ´</strong>ï¼šå‡½æ•°ç¬¦ä»£ç è¦æ¯”lambdaä»£ç æ›´åŠ ç¹çï¼Œå‡½æ•°å’Œlambdaçš„ç®€æ´ç¨‹åº¦ç›¸å½“ã€‚</p><p>(3) <strong>åŠŸèƒ½</strong>ï¼šlambdaå¯ä»¥è®¿é—®ä½œç”¨åŸŸå†…çš„ä»»ä½•åŠ¨æ€å˜é‡ï¼Œå¯ä»¥é‡‡ç”¨å–å€¼ã€å¼•ç”¨çš„å½¢å¼è¿›è¡Œæ•è·ã€‚</p><h3 id="7-ä»€ä¹ˆæ˜¯å£°æ˜æ—¶åˆå§‹åŒ–ï¼Ÿ"><a href="#7-ä»€ä¹ˆæ˜¯å£°æ˜æ—¶åˆå§‹åŒ–ï¼Ÿ" class="headerlink" title="7. ä»€ä¹ˆæ˜¯å£°æ˜æ—¶åˆå§‹åŒ–ï¼Ÿ"></a>7. ä»€ä¹ˆæ˜¯å£°æ˜æ—¶åˆå§‹åŒ–ï¼Ÿ</h3><p>C++11æ–°å¢äº†<strong>ç±»æˆå‘˜åˆå§‹åŒ–æ–°æœºåˆ¶</strong>â€”â€”å£°æ˜æ—¶åˆå§‹åŒ–ï¼Œå¯ä»¥ç›´æ¥åœ¨ç±»ä¸­å£°æ˜æ•°æ®æˆå‘˜æ—¶å°±è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œè€Œä¸ç”¨å€ŸåŠ©æ„é€ å‡½æ•°æˆ–è€…åˆå§‹åŒ–åˆ—è¡¨ã€‚</p><h3 id="8-C-11æ·»åŠ å“ªå‡ ç§æ„é€ å‡½æ•°å…³é”®å­—ï¼Ÿ"><a href="#8-C-11æ·»åŠ å“ªå‡ ç§æ„é€ å‡½æ•°å…³é”®å­—ï¼Ÿ" class="headerlink" title="8. C++11æ·»åŠ å“ªå‡ ç§æ„é€ å‡½æ•°å…³é”®å­—ï¼Ÿ"></a>8. C++11æ·»åŠ å“ªå‡ ç§æ„é€ å‡½æ•°å…³é”®å­—ï¼Ÿ</h3><p>(1) defaultå…³é”®å­—å¯ä»¥æ˜¾å¼è¦æ±‚ç¼–è¯‘å™¨ç”Ÿæˆé»˜è®¤æ„é€ å‡½æ•°ï¼Œé˜²æ­¢åœ¨è°ƒç”¨æ—¶ç›¸å…³æ„é€ å‡½æ•°æ²¡æœ‰å®šä¹‰è€ŒæŠ¥é”™ã€‚</p><p>(2) deleteå…³é”®å­—å¯ä»¥åˆ é™¤æ„é€ å‡½æ•°ã€èµ‹å€¼è¿ç®—ç¬¦å‡½æ•°ç­‰ï¼Œåœ¨ä½¿ç”¨æ—¶ç¼–è¯‘å™¨ä¼šæŠ¥é”™</p><h3 id="9-è¯´è¯´C-çš„å·¦å€¼å’Œå³å€¼ï¼Ÿ"><a href="#9-è¯´è¯´C-çš„å·¦å€¼å’Œå³å€¼ï¼Ÿ" class="headerlink" title="9. è¯´è¯´C++çš„å·¦å€¼å’Œå³å€¼ï¼Ÿ"></a>9. è¯´è¯´C++çš„å·¦å€¼å’Œå³å€¼ï¼Ÿ</h3><p>(1) åœ¨C++11ä¸­æ‰€æœ‰çš„å€¼å¿…å±äºå·¦å€¼ã€å³å€¼ä¸¤è€…ä¹‹ä¸€ï¼Œå³å€¼åˆå¯ä»¥ç»†åˆ†ä¸ºçº¯å³å€¼ã€å°†äº¡å€¼ã€‚</p><p>(2) åœ¨C++11ä¸­å¯ä»¥å–åœ°å€çš„ã€æœ‰åå­—çš„å°±æ˜¯å·¦å€¼ï¼Œåä¹‹ï¼Œä¸èƒ½å–åœ°å€çš„ã€æ²¡æœ‰åå­—çš„å°±æ˜¯å³å€¼ï¼ˆå°†äº¡å€¼æˆ–çº¯å³å€¼ï¼‰ã€‚</p><p>(3) çº¯å³å€¼çš„æ¦‚å¿µç­‰åŒäºæˆ‘ä»¬åœ¨C++98æ ‡å‡†ä¸­å³å€¼çš„æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯ä¸´æ—¶å˜é‡å’Œå­—é¢é‡å€¼ï¼›å°†äº¡å€¼åˆ™æ˜¯C++11æ–°å¢çš„æ–°å³å€¼ï¼Œå®ƒè¡¨ç¤ºè¯¥å¯¹è±¡çš„å†…å­˜ç©ºé—´æ¥ä¸‹æ¥ä¼šè¢«å…¶ä»–å¯¹è±¡æ¥ç®¡ã€‚é€šè¿‡è¿™ç§æ¥ç®¡ç©ºé—´çš„æ–¹å¼å¯ä»¥é¿å…å†…å­˜ç©ºé—´çš„é‡Šæ”¾å’Œåˆ†é…ï¼Œå»¶é•¿å˜é‡å€¼çš„ç”Ÿå‘½æœŸã€‚</p><p>(4) C++11å¯¹äºå¼•ç”¨äº†ä¹Ÿæœ‰äº†æ–°çš„è§£é‡Šã€‚ä¼ ç»Ÿçš„C++å¼•ç”¨è¢«ç§°ä¸º<strong>å·¦å€¼å¼•ç”¨</strong>ï¼Œç¬¦å·ä¸º&amp;ï¼Œä»–å…³è”çš„æ˜¯å·¦å€¼ã€‚C++11ä¸­å¢åŠ äº†<strong>å³å€¼å¼•ç”¨</strong>ï¼Œç¬¦å·ä¸º&amp;&amp;ã€‚<strong>å³å€¼å¼•ç”¨ä¼šå…³è”åˆ°å³å€¼</strong>ï¼Œå³å€¼è¢«å­˜å‚¨åˆ°ç‰¹å®šä½ç½®ï¼Œå³å€¼å¼•ç”¨ä¼šæŒ‡å‘è¯¥ç‰¹å®šä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>å³å€¼è™½ç„¶æ— æ³•è·å–åœ°å€ï¼Œä½†æ˜¯å³å€¼å¼•ç”¨æ˜¯å¯ä»¥è·å–åœ°å€çš„</strong>ï¼Œè¯¥åœ°å€è¡¨ç¤ºä¸´æ—¶å¯¹è±¡çš„å­˜å‚¨ä½ç½®ã€‚ä½¿ç”¨std::moveå¯ä»¥ä½¿ä¸€ä¸ªå·¦å€¼è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ã€‚</p><h3 id="10-è¯´è¯´ç§»åŠ¨æ„é€ å‡½æ•°ï¼Ÿ"><a href="#10-è¯´è¯´ç§»åŠ¨æ„é€ å‡½æ•°ï¼Ÿ" class="headerlink" title="10. è¯´è¯´ç§»åŠ¨æ„é€ å‡½æ•°ï¼Ÿ"></a>10. è¯´è¯´ç§»åŠ¨æ„é€ å‡½æ•°ï¼Ÿ</h3><p>(1) ç§»åŠ¨æ„é€ æ˜¯C++11æ ‡å‡†ä¸­æä¾›çš„ä¸€ç§æ–°çš„æ„é€ æ–¹æ³•ï¼Œç”¨æ¥ç»™äºˆç¨‹åºå‘˜æ–°çš„æ„é€ é€‰æ‹©ï¼Œç”¨ä»¥æ›¿æ¢æ‹·è´æ„é€ ã€‚</p><p>(2) æ‹·è´æ„é€ å‡½æ•°æ˜¯å…ˆå°†ä¼ å…¥çš„å‚æ•°å¯¹è±¡è¿›è¡Œä¸€æ¬¡æ·±æ‹·è´ï¼Œå†ä¼ ç»™æ–°å¯¹è±¡ã€‚è¿™å°±ä¼šæœ‰ä¸€æ¬¡æ‹·è´å¯¹è±¡çš„å¼€é”€ï¼Œæ‹·è´çš„å†…å­˜è¶Šå¤§è¶Šè€—è´¹æ—¶é—´ï¼Œå¹¶ä¸”è¿›è¡Œäº†æ·±æ‹·è´ï¼Œå°±éœ€è¦ç»™å¯¹è±¡åˆ†é…åœ°å€ç©ºé—´ã€‚</p><p>(3) ç§»åŠ¨æ„é€ å‡½æ•°ä¼šç›´æ¥æ¥ç®¡æºå¯¹è±¡ç©ºé—´ï¼Œæ—¢ä¸ä¼šäº§ç”Ÿé¢å¤–çš„æ‹·è´å¼€é”€ï¼Œä¹Ÿä¸ä¼šç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´ã€‚æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼ŒèŠ‚çœå†…å­˜æ¶ˆè€—ã€‚</p><p>(4) ç§»åŠ¨æ„é€ å‡½æ•°çš„å‚æ•°å¿…é¡»æ˜¯<strong>è‡ªèº«ç±»å‹çš„å³å€¼å¼•ç”¨</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´èƒ½è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°çš„å‚æ•°å¿…ç„¶æ˜¯ä¸ªå³å€¼ï¼ˆçº¯å³å€¼å’Œå°†äº¡å€¼ï¼‰ã€‚</p><h3 id="11-ä»€ä¹ˆæ˜¯åˆ—è¡¨åˆå§‹åŒ–ï¼Ÿ"><a href="#11-ä»€ä¹ˆæ˜¯åˆ—è¡¨åˆå§‹åŒ–ï¼Ÿ" class="headerlink" title="11. ä»€ä¹ˆæ˜¯åˆ—è¡¨åˆå§‹åŒ–ï¼Ÿ"></a>11. ä»€ä¹ˆæ˜¯åˆ—è¡¨åˆå§‹åŒ–ï¼Ÿ</h3><p>åˆ—è¡¨åˆå§‹åŒ–æ˜¯C++ 11æ–°å¼•è¿›çš„åˆå§‹åŒ–æ–¹å¼ï¼Œå®ƒé‡‡ç”¨ä¸€å¯¹èŠ±æ‹¬å·ï¼ˆå³<strong>ï½›ï½</strong>ï¼‰è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚èƒ½ç”¨ç›´æ¥åˆå§‹åŒ–å’Œæ‹·è´åˆå§‹åŒ–çš„åœ°æ–¹éƒ½èƒ½ç”¨åˆ—è¡¨åˆå§‹åŒ–ï¼Œè€Œä¸”åˆ—è¡¨åˆå§‹åŒ–èƒ½å¯¹å®¹å™¨è¿›è¡Œæ–¹ä¾¿çš„åˆå§‹åŒ–ï¼Œå› æ­¤åœ¨æ–°çš„C++æ ‡å‡†ä¸­ï¼Œæ¨èä½¿ç”¨åˆ—è¡¨åˆå§‹åŒ–çš„æ–¹å¼è¿›è¡Œåˆå§‹åŒ–ã€‚</p><h3 id="12-åˆå§‹åŒ–åˆ—è¡¨å’Œåˆ—è¡¨åˆå§‹åŒ–çš„åŒºåˆ«ï¼Ÿ"><a href="#12-åˆå§‹åŒ–åˆ—è¡¨å’Œåˆ—è¡¨åˆå§‹åŒ–çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="12.åˆå§‹åŒ–åˆ—è¡¨å’Œåˆ—è¡¨åˆå§‹åŒ–çš„åŒºåˆ«ï¼Ÿ"></a>12.åˆå§‹åŒ–åˆ—è¡¨å’Œåˆ—è¡¨åˆå§‹åŒ–çš„åŒºåˆ«ï¼Ÿ</h3><p>(1) åˆå§‹åŒ–åˆ—è¡¨æ˜¯åœ¨åˆ›å»ºç±»å¯¹è±¡æ—¶ï¼Œå¯¹ç±»å¯¹è±¡å†…éƒ¨çš„æ•°æ®æˆå‘˜è¿›è¡Œçš„ä¸€ç§åˆå§‹åŒ–æ–¹å¼ï¼Œå…·ä½“ç”¨åœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­ã€‚</p><h2 id="STL"><a href="#STL" class="headerlink" title="STL"></a>STL</h2><h3 id="1-ä»€ä¹ˆæ˜¯STLï¼Ÿ"><a href="#1-ä»€ä¹ˆæ˜¯STLï¼Ÿ" class="headerlink" title="1.ä»€ä¹ˆæ˜¯STLï¼Ÿ"></a>1.ä»€ä¹ˆæ˜¯STLï¼Ÿ</h3><p>Standard Template Libraryï¼ˆæ ‡å‡†æ¨¡æ¿åº“ï¼‰ï¼Œæ˜¯C++çš„æ ‡å‡†åº“ä¹‹ä¸€ï¼Œå®ƒæ˜¯ä¸€å¥—åŸºäºæ¨¡æ¿çš„å®¹å™¨ç±»åº“ï¼Œè¿˜åŒ…æ‹¬è®¸å¤šå¸¸ç”¨çš„ç®—æ³•ï¼Œæé«˜äº†ç¨‹åºå¼€å‘æ•ˆç‡å’Œå¤ç”¨æ€§ã€‚STLåŒ…å«6å¤§éƒ¨ä»¶ï¼š<strong>å®¹å™¨ã€è¿­ä»£å™¨ã€ç®—æ³•ã€ä»¿å‡½æ•°ã€é€‚é…å™¨å’Œç©ºé—´é…ç½®å™¨</strong>ã€‚</p><h3 id="2-SGIçš„äºŒçº§ç©ºé—´é…ç½®å™¨äº†è§£å—ï¼Ÿ"><a href="#2-SGIçš„äºŒçº§ç©ºé—´é…ç½®å™¨äº†è§£å—ï¼Ÿ" class="headerlink" title="2.SGIçš„äºŒçº§ç©ºé—´é…ç½®å™¨äº†è§£å—ï¼Ÿ"></a>2.SGIçš„äºŒçº§ç©ºé—´é…ç½®å™¨äº†è§£å—ï¼Ÿ</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/331809729">5 åƒå­—é•¿æ–‡+ 30 å¼ å›¾è§£ | é™ªä½ æ‰‹æ’• STL ç©ºé—´é…ç½®å™¨æºç </a></li><li><a href="https://blog.csdn.net/xiajun07061225/article/details/8807890">ã€STLæ·±å…¥å­¦ä¹ ã€‘SGI STLç©ºé—´é…ç½®å™¨è¯¦è§£ï¼ˆäºŒï¼‰-ç¬¬äºŒçº§ç©ºé—´é…ç½®å™¨</a></li></ul><p>(1) å¯¹è±¡æ„é€ å‰çš„ç©ºé—´é…ç½®å’Œå¯¹è±¡ææ„åçš„ç©ºé—´é‡Šæ”¾ï¼Œç”±<stl_alloc.h>è´Ÿè´£ï¼ŒSGIè®¾è®¡äº†<strong>åŒå±‚çº§é…ç½®å™¨</strong>ï¼š</p><p>â‘ ã€€ç¬¬ä¸€çº§ç©ºé—´é…ç½®å™¨ç›´æ¥ä½¿ç”¨mallocå’Œfreeï¼Œå¦‚æœåœ¨ç”³è¯·åŠ¨æ€å†…å­˜æ—¶æ‰¾ä¸åˆ°è¶³å¤Ÿå¤§çš„å†…å­˜å—ï¼Œå°†è¿”å›NULL æŒ‡é’ˆï¼Œå®£å‘Šå†…å­˜ç”³è¯·å¤±è´¥ã€‚</p><p>â‘¡ã€€ç¬¬äºŒçº§ç©ºé—´é…ç½®å™¨è§†æƒ…å†µä½¿ç”¨ä¸åŒçš„ç­–ç•¥ï¼Œå½“ç”³è¯·å†…å­˜å¤§äº128å­—èŠ‚æ—¶ï¼Œè°ƒç”¨ç¬¬ä¸€çº§é…ç½®å™¨ã€‚å½“ç”³è¯·å†…å­˜å°äº128bå­—èŠ‚æ—¶ï¼Œé‡‡ç”¨å†…å­˜æ± æ–¹å¼ï¼Œç»´æŠ¤16ä¸ªï¼ˆ128/8ï¼‰è‡ªç”±é“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ç»´æŠ¤8å­—èŠ‚å¤§å°çš„å†…å­˜å—ï¼Œä»ä¸­è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚æœå†…å­˜ä¸è¶³è½¬ç¬¬ä¸€çº§é…ç½®å™¨å¤„ç†ã€‚</p><p>(2) <strong>äºŒçº§ç©ºé—´é…ç½®å™¨å­˜åœ¨çš„é—®é¢˜</strong>ï¼š</p><p>â‘ ã€€è‡ªç”±é“¾è¡¨æ‰€æŒ‚åŒºå—éƒ½æ˜¯8çš„æ•´æ•°å€ï¼Œå› æ­¤å½“æˆ‘ä»¬éœ€è¦é8å€æ•°çš„åŒºå—ï¼Œå¾€å¾€ä¼šå¯¼è‡´æµªè´¹ã€‚</p><p>â‘¡ã€€ç”±äºé…ç½®å™¨çš„é“¾è¡¨éƒ½æ˜¯é™æ€å˜é‡ï¼Œä»–ä»¬å­˜æ”¾åœ¨å…¨å±€/é™æ€åŒºï¼Œå…¶é‡Šæ”¾æ—¶æœºå°±æ˜¯ç¨‹åºç»“æŸï¼Œè¿™æ ·å­ä¼šå¯¼è‡´è‡ªç”±é“¾è¡¨ä¸€ç›´å ç”¨å†…å­˜ã€‚</p><h3 id="3-traitsæŠ€æ³•"><a href="#3-traitsæŠ€æ³•" class="headerlink" title="3.traitsæŠ€æ³•?"></a>3.traitsæŠ€æ³•?</h3><p>å…¥é—¨æ¡ˆä¾‹ï¼š</p><p>åœ¨C++ä¸­ï¼Œtraitsï¼ˆç‰¹æ€§ï¼‰æ˜¯ä¸€ç§å¸¸ç”¨çš„æŠ€æœ¯ï¼Œä¸»è¦ç”¨äºåœ¨ç¼–è¯‘æœŸé—´è·å–ç±»å‹çš„ä¿¡æ¯ã€‚é€šè¿‡traitsï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å‡ºæ›´åŠ é€šç”¨ã€çµæ´»çš„ä»£ç ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„traitsçš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªtraitsæ¨¡æ¿</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyTraits</span> &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‡è®¾ç±»å‹Tä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆ</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">bool</span> is_pointer = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹æŒ‡é’ˆç±»å‹è¿›è¡Œç‰¹åŒ–</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyTraits</span>&lt;T*&gt; &#123;</span><br><span class="line">    <span class="comment">// å¯¹äºæŒ‡é’ˆç±»å‹ï¼Œæˆ‘ä»¬è®¾å®šis_pointerä¸ºtrue</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">bool</span> is_pointer = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; MyTraits&lt;<span class="type">int</span>&gt;::is_pointer &lt;&lt; endl;  <span class="comment">// è¾“å‡º0ï¼Œè¡¨ç¤ºintä¸æ˜¯æŒ‡é’ˆ</span></span><br><span class="line">    cout &lt;&lt; MyTraits&lt;<span class="type">int</span>*&gt;::is_pointer &lt;&lt; endl; <span class="comment">// è¾“å‡º1ï¼Œè¡¨ç¤ºint*æ˜¯æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>MyTraits</code> çš„æ¨¡æ¿ï¼Œå¹¶å¯¹æŒ‡é’ˆç±»å‹è¿›è¡Œäº†ç‰¹åŒ–ã€‚é€šè¿‡ <code>MyTraits</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘æœŸé—´åˆ¤æ–­ä¸€ä¸ªç±»å‹æ˜¯å¦æ˜¯æŒ‡é’ˆç±»å‹ã€‚</p><p>é™¤äº†è¿™ä¸ªç®€å•çš„ä¾‹å­ï¼Œtraitsè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„åº”ç”¨ï¼Œä¾‹å¦‚è·å–ä¸€ä¸ªç±»å‹çš„å¤§å°ã€åˆ¤æ–­ä¸€ä¸ªç±»å‹æ˜¯å¦æ˜¯constç±»å‹ã€è·å–ä¸€ä¸ªå®¹å™¨çš„è¿­ä»£å™¨ç±»å‹ç­‰ç­‰ã€‚é€šè¿‡traitsï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°æŠ½è±¡å’Œå°è£…ä»£ç ï¼Œæé«˜ä»£ç çš„å¤ç”¨æ€§å’Œçµæ´»æ€§ã€‚</p><h3 id="4-è¯´è¯´STLä¸­çš„å®¹å™¨ï¼Ÿ"><a href="#4-è¯´è¯´STLä¸­çš„å®¹å™¨ï¼Ÿ" class="headerlink" title="4.è¯´è¯´STLä¸­çš„å®¹å™¨ï¼Ÿ"></a>4.è¯´è¯´STLä¸­çš„å®¹å™¨ï¼Ÿ</h3><p>(1) <strong>vector</strong></p><p>â‘ ã€€vectoråº•å±‚æ˜¯ä¸€ä¸ªåŠ¨æ€æ•°ç»„ï¼ŒåŒ…å«ä¸‰ä¸ªè¿­ä»£å™¨ï¼šstartã€finishã€end_of_storageã€‚startå’Œfinishä¹‹é—´æ˜¯å·²ç»è¢«ä½¿ç”¨çš„ç©ºé—´èŒƒå›´ï¼Œè¡¨ç¤ºå½“å‰vectorä¸­æœ‰å¤šå°‘ä¸ªå…ƒç´ ï¼Œå³æœ‰æ•ˆç©ºé—´sizeã€‚startå’Œend_of_storageæ˜¯æ•´å—è¿ç»­ç©ºé—´åŒ…æ‹¬å¤‡ç”¨ç©ºé—´çš„å¤§å°ï¼Œè¡¨ç¤ºå®ƒåˆ†é…çš„å†…å­˜ä¸­å¯ä»¥å®¹çº³å¤šå°‘å…ƒç´ ï¼Œå³å®¹é‡capacityã€‚</p><p>â‘¡ã€€<strong>å½“ç©ºé—´ä¸å¤Ÿè£…ä¸‹æ•°æ®ï¼ˆvec.push_back(val)ï¼‰æ—¶ï¼Œä¼šè‡ªåŠ¨ç”³è¯·å¦ä¸€ç‰‡æ›´å¤§çš„ç©ºé—´ï¼ˆ1.5å€æˆ–è€…2å€ï¼‰</strong>ï¼Œç„¶åæŠŠåŸæ¥çš„æ•°æ®æ‹·è´åˆ°æ–°çš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€é‡Šæ”¾åŸæ¥çš„é‚£ç‰‡ç©ºé—´ã€‚ä¹‹æ‰€ä»¥æ˜¯1.5å€æˆ–è€…2å€ï¼Œæ˜¯å› ä¸ºè€ƒè™‘åˆ°å¯èƒ½äº§ç”Ÿçš„å †ç©ºé—´æµªè´¹ï¼Œå¢é•¿å€æ•°ä¸èƒ½å¤ªå¤§ï¼Œä½¿ç”¨1.5æˆ–è€…2æ˜¯æ¯”è¾ƒåˆç†çš„å€æ•°ã€‚</p><p>â‘¢ã€€å½“é‡Šæ”¾æˆ–è€…åˆ é™¤ï¼ˆvec.clear()ï¼‰é‡Œé¢çš„æ•°æ®æ—¶ï¼Œå…¶<strong>å­˜å‚¨ç©ºé—´ä¸é‡Šæ”¾</strong>ï¼Œä»…ä»…æ˜¯æ¸…ç©ºäº†é‡Œé¢çš„æ•°æ®ã€‚</p><p>â‘£ã€€å¯¹vectorçš„ä»»ä½•æ“ä½œä¸€æ—¦å¼•èµ·äº†ç©ºé—´çš„é‡æ–°é…ç½®ï¼ŒæŒ‡å‘åŸvectorçš„æ‰€æœ‰è¿­ä»£å™¨éƒ½ä¼šå¤±æ•ˆã€‚</p><p>â‘¤ã€€reserveå‡½æ•°çš„ä½œç”¨ï¼šå°†vectorç›´æ¥æ‰©å……åˆ°ç¡®å®šçš„å¤§å°ï¼Œå¯ä»¥å‡å°‘å¤šæ¬¡å¼€è¾Ÿå’Œé‡Šæ”¾ç©ºé—´çš„æ•ˆç‡é—®é¢˜ï¼ˆä¼˜åŒ–push_backï¼‰ï¼Œè¿˜å¯ä»¥å‡å°‘æ‹·è´æ•°æ®çš„æ¬¡æ•°ï¼Œ<strong>å®ƒç›´æ¥æ›´æ”¹capacity</strong>ã€‚</p><p>â‘¥ã€€resize()å‡½æ•°çš„ä½œç”¨ï¼š<strong>å¯ä»¥æ”¹å˜vectoræœ‰æ•ˆç©ºé—´çš„å¤§å°ï¼Œå³sizeçš„å¤§å°</strong>ã€‚å¦‚æœsizeå¤§äºcapacityï¼Œcapacityçš„å¤§å°ä¹Ÿä¼šéšç€æ”¹å˜ã€‚</p><p>â‘¦ã€€vectorçš„åº•å±‚å®ç°è¦æ±‚è¿ç»­çš„å¯¹è±¡æ’åˆ—ï¼Œå¼•ç”¨å¹¶éå¯¹è±¡ï¼Œæ²¡æœ‰å®é™…åœ°å€ï¼Œå› æ­¤<strong>vectorçš„å…ƒç´ ç±»å‹ä¸èƒ½æ˜¯å¼•ç”¨</strong>ã€‚</p><p>â‘§ã€€å½“åˆ é™¤å®¹å™¨ä¸­ä¸€ä¸ªå…ƒç´ å,è¯¥è¿­ä»£å™¨æ‰€æŒ‡å‘çš„å…ƒç´ å·²ç»è¢«åˆ é™¤ï¼Œé‚£ä¹ˆä¹Ÿé€ æˆè¿­ä»£å™¨å¤±æ•ˆã€‚<strong>eraseæ–¹æ³•ä¼šè¿”å›ä¸‹ä¸€ä¸ªæœ‰æ•ˆçš„è¿­ä»£å™¨</strong>ã€‚</p><p>â‘¨ã€€é‡Šæ”¾vectorå†…å­˜çš„æ–¹æ³•ï¼š</p><p><strong>vec.clear()ï¼š</strong>æ¸…ç©ºå†…å®¹ï¼Œä½†æ˜¯ä¸é‡Šæ”¾å†…å­˜ã€‚</p><p><strong>vector().swap(vec)ï¼š</strong>æ¸…ç©ºå†…å®¹ï¼Œä¸”é‡Šæ”¾å†…å­˜ï¼Œæƒ³å¾—åˆ°ä¸€ä¸ªå…¨æ–°çš„vectorã€‚</p><p><strong>vec.shrink_to_fit()ï¼š</strong>è¯·æ±‚å®¹å™¨é™ä½å…¶capacityå’ŒsizeåŒ¹é…ã€‚</p><p><strong>vec.clear();vec.shrink_to_fit();ï¼š</strong>æ¸…ç©ºå†…å®¹ï¼Œä¸”é‡Šæ”¾å†…å­˜ã€‚</p><p>(2) <strong>List</strong></p><p>â‘ ã€€listçš„åº•å±‚æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œä»¥ç»“ç‚¹ä¸ºå•ä½å­˜æ”¾æ•°æ®ï¼Œ<strong>ç»“ç‚¹çš„åœ°å€åœ¨å†…å­˜ä¸­ä¸ä¸€å®šè¿ç»­</strong>ï¼Œæ¯æ¬¡æ’å…¥æˆ–åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå°±é…ç½®æˆ–é‡Šæ”¾ä¸€ä¸ªå…ƒç´ ç©ºé—´ã€‚</p><p>â‘¡ã€€listä¸æ”¯æŒéšæœºå­˜å–ï¼Œå¦‚æœéœ€è¦å¤§é‡çš„æ’å…¥å’Œåˆ é™¤ï¼Œè€Œä¸å…³å¿ƒéšæœºå­˜å–ï¼Œåˆ™å¯ä»¥ä½¿ç”¨listã€‚</p><p>(3) <strong>Deque</strong></p><p>â‘ ã€€dequeçš„æ˜¯ä¸€ä¸ª<strong>åŒå‘å¼€å£çš„è¿ç»­çº¿æ€§ç©ºé—´ï¼ˆåŒç«¯é˜Ÿåˆ—ï¼‰</strong>ï¼Œåœ¨å¤´å°¾ä¸¤ç«¯è¿›è¡Œå…ƒç´ çš„æ’å…¥è·Ÿåˆ é™¤æ“ä½œéƒ½æœ‰ç†æƒ³çš„æ—¶é—´å¤æ‚åº¦ã€‚</p><p>â‘¡ã€€dequeçš„åº•å±‚å¹¶ä¸æ˜¯çœŸæ­£è¿ç»­çš„ç©ºé—´ï¼Œè€Œæ˜¯ç”±ä¸€æ®µæ®µè¿ç»­çš„å°ç©ºé—´æ‹¼æ¥è€Œæˆï¼Œå®é™…<strong>dequeç±»ä¼¼äºä¸€ä¸ªåŠ¨æ€çš„äºŒç»´æ•°ç»„</strong>ï¼Œç”±ä¸€ä¸ªmapï¼ˆä¸­æ§æŒ‡é’ˆæ•°ç»„ï¼‰å’Œå¤šä¸ªè¿ç»­çš„ç¼“å†²åŒºç»„æˆã€‚</p><p>â‘¢ã€€å½“dequeä¸æ–­å¢åŠ å…ƒç´ æ—¶ï¼Œä¸€æ—¦mapï¼ˆä¸­æ§æŒ‡é’ˆæ•°ç»„ï¼‰æ»¡äº†ï¼Œé‚£ä¹ˆä¼šå¢å®¹ï¼Œä¸è¿‡<strong>mapå¢å®¹çš„ä»£ä»·éå¸¸ä½ï¼Œå› ä¸ºåªéœ€è¦æ‹·è´å­˜å‚¨æ•°æ®çš„bufferæ•°ç»„çš„æŒ‡é’ˆï¼Œä¸éœ€è¦æ‹·è´bufferä¸­çš„å†…å®¹</strong>ã€‚</p><p>â‘£ã€€åŒç«¯é˜Ÿåˆ—åº•å±‚æ˜¯ä¸€æ®µå‡è±¡çš„è¿ç»­ç©ºé—´ï¼Œå®é™…æ˜¯<strong>åˆ†æ®µè¿ç»­</strong>çš„ï¼Œä¸ºäº†ç»´æŠ¤å…¶â€œæ•´ä½“è¿ç»­â€ä»¥åŠéšæœºè®¿é—®çš„å‡è±¡ï¼Œdequeçš„è¿­ä»£å™¨è®¾è®¡å°±æ¯”è¾ƒå¤æ‚ã€‚<strong>ç”±curã€firstã€lastæŒ‡å‘å½“å‰éå†bufferæ•°ç»„ï¼ŒnodeæŒ‡å‘mapä¸­çš„å…ƒç´ </strong>ï¼Œéå†dequeçš„æ“ä½œç”±è¿™å‡ ä¸ªæŒ‡é’ˆè¿›è¡Œç»´æŠ¤ã€‚</p><p>â‘¤ã€€dequeå¹¶ä¸æ˜¯ä»mapçš„ç¬¬ä¸€ä¸ªä½ç½®å°±å¼€å§‹å­˜æ”¾å…ƒç´ ï¼Œè€Œæ˜¯ä»ä¸­é—´å¼€å§‹å­˜æ”¾ï¼Œè¿™æ ·åœ¨å¤´éƒ¨å’Œå°¾éƒ¨æ’å…¥å…ƒç´ å°±ä¼šå˜å¾—å®¹æ˜“ã€‚</p><p>â‘¥ã€€ä¸vectoræ¯”è¾ƒï¼šå¤´éƒ¨æ’å…¥å’Œåˆ é™¤æ—¶ï¼Œä¸éœ€è¦æ¬ç§»å…ƒç´ ï¼Œæ•ˆç‡ç‰¹åˆ«é«˜ï¼Œè€Œä¸”åœ¨æ‰©å®¹æ—¶ï¼Œä¹Ÿä¸éœ€è¦æ¬ç§»å¤§é‡çš„å…ƒç´ ï¼Œå› æ­¤å…¶æ•ˆç‡æ˜¯å¿…vectoré«˜çš„ã€‚</p><p>â‘¦ã€€ä¸listæ¯”è¾ƒï¼šå…¶åº•å±‚æ˜¯è¿ç»­ç©ºé—´ï¼Œç©ºé—´åˆ©ç”¨ç‡æ¯”è¾ƒé«˜ï¼Œä¸éœ€è¦å­˜å‚¨é¢å¤–å­—æ®µã€‚</p><p>â‘§ã€€ä¸é€‚åˆéå†ï¼Œå› ä¸ºåœ¨éå†æ—¶ï¼Œdequeçš„è¿­ä»£å™¨è¦é¢‘ç¹çš„å»æ£€æµ‹å…¶æ˜¯å¦ç§»åŠ¨åˆ°æŸæ®µå°ç©ºé—´çš„è¾¹ç•Œï¼Œå¯¼è‡´æ•ˆç‡ä½ä¸‹ã€‚ä¸é€‚åˆå¤§é‡çš„ä¸­é—´æ’å…¥åˆ é™¤ï¼Œä¹Ÿä¸é€‚åˆå¤§é‡çš„éšæœºè®¿é—®ã€‚</p><p>(4) <strong>map ã€setã€multisetã€multimap</strong></p><p>â‘ ã€€åº•å±‚æ•°æ®ç»“æ„éƒ½æ˜¯çº¢é»‘æ ‘ï¼Œæ˜¯ä¸€ç§è‡ªå¹³è¡¡çš„äºŒå‰æœç´¢æ ‘</p><p>â‘¡ã€€setå’Œmultisetä¼šæ ¹æ®ç‰¹å®šçš„æ’åºå‡†åˆ™è‡ªåŠ¨å°†å…ƒç´ æ’åºï¼Œsetä¸­å…ƒç´ ä¸å…è®¸é‡å¤ï¼Œmultisetå¯ä»¥é‡å¤ã€‚</p><p>â‘¢ã€€mapå’Œmultimapå°†keyå’Œvalueç»„æˆçš„é”®å€¼å¯¹ä½œä¸ºå…ƒç´ ï¼Œæ ¹æ®keyçš„æ’åºå‡†åˆ™è‡ªåŠ¨å°†å…ƒç´ æ’åºï¼Œmapä¸­å…ƒç´ çš„keyä¸å…è®¸é‡å¤ï¼Œmultimapå¯ä»¥é‡å¤ã€‚</p><p>â‘£ã€€mapå’Œsetçš„å¢åˆ æ”¹æŸ¥é€Ÿåº¦ä¸ºéƒ½æ˜¯lognï¼Œæ˜¯æ¯”è¾ƒé«˜æ•ˆçš„ã€‚</p><p>â‘¤ã€€mapå’Œsetçš„æ’å…¥åˆ é™¤æ•ˆç‡æ¯”åºåˆ—å®¹å™¨é«˜ï¼Œè€Œä¸”æ¯æ¬¡insertä¹‹åï¼Œä»¥å‰ä¿å­˜çš„iteratorä¸ä¼šå¤±æ•ˆã€‚å› ä¸ºå­˜å‚¨çš„æ˜¯ç»“ç‚¹ï¼Œä¸éœ€è¦å†…å­˜æ‹·è´å’Œå†…å­˜ç§»åŠ¨ã€‚</p><p>(5) <strong>unordered_mapã€unordered_set</strong></p><p>â‘ ã€€åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªé˜²å†—ä½™çš„å“ˆå¸Œè¡¨ï¼ˆé‡‡ç”¨é™¤ç•™ä½™æ•°æ³•ï¼‰ã€‚å…¶æ•°æ®çš„å­˜å‚¨å’ŒæŸ¥æ‰¾çš„æ•ˆç‡å¾ˆé«˜ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼›è€Œä»£ä»·ä»…ä»…æ˜¯æ¶ˆè€—æ¯”è¾ƒå¤šçš„å†…å­˜ã€‚</p><p>â‘¡ã€€ä½¿ç”¨å¼€é“¾æ³•è§£å†³å“ˆå¸Œå†²çªã€‚</p><p>â‘¢ã€€æ•°æ®çš„å­˜æ”¾æ˜¯æ— åºçš„</p><h3 id="5-ä»€ä¹ˆæ˜¯STLçš„é¡ºåºå®¹å™¨å’Œå…³è”å¼å®¹å™¨ï¼Ÿ"><a href="#5-ä»€ä¹ˆæ˜¯STLçš„é¡ºåºå®¹å™¨å’Œå…³è”å¼å®¹å™¨ï¼Ÿ" class="headerlink" title="5. ä»€ä¹ˆæ˜¯STLçš„é¡ºåºå®¹å™¨å’Œå…³è”å¼å®¹å™¨ï¼Ÿ"></a>5. ä»€ä¹ˆæ˜¯STLçš„é¡ºåºå®¹å™¨å’Œå…³è”å¼å®¹å™¨ï¼Ÿ</h3><p>(1) å…³è”å®¹å™¨(Associative Container)ä¸é¡ºåºå®¹å™¨(Sequential Container)çš„æœ¬è´¨åŒºåˆ«åœ¨äºï¼š<strong>å…³è”å®¹å™¨æ˜¯é€šè¿‡é”®(key)å­˜å‚¨å’Œè¯»å–å…ƒç´ çš„ï¼Œè€Œé¡ºåºå®¹å™¨åˆ™é€šè¿‡å…ƒç´ åœ¨å®¹å™¨ä¸­çš„ä½ç½®é¡ºåºå­˜å‚¨å’Œè®¿é—®å…ƒç´ </strong>ã€‚</p><p>(2) åœ¨STLä¸­ï¼Œè¿™é‡Œçš„â€œé¡ºåºâ€å’Œâ€œå…³è”â€æŒ‡çš„æ˜¯<strong>ä¸Šå±‚æ¥å£è¡¨ç°å‡ºæ¥çš„è®¿é—®æ–¹å¼</strong>ï¼Œå¹¶éåº•å±‚å­˜å‚¨æ–¹å¼ã€‚ä¸ºä»€ä¹ˆè¿™æ ·åˆ’åˆ†å‘¢ï¼Ÿå› ä¸ºå¯¹STLçš„ç”¨æˆ·æ¥è¯´ï¼Œä»–ä»¬å¹¶ä¸éœ€è¦çŸ¥é“å®¹å™¨çš„åº•å±‚å®ç°æœºåˆ¶ï¼Œåªè¦çŸ¥é“å¦‚ä½•é€šè¿‡ä¸Šå±‚æ¥å£è®¿é—®å®¹å™¨å…ƒç´ å°±å¯ä»¥äº†ï¼Œå¦åˆ™è¿èƒŒäº†æ³›å‹å®¹å™¨è®¾è®¡çš„åˆè¡·ã€‚</p><p>(3) é¡ºåºå®¹å™¨ä¸»è¦é‡‡ç”¨å‘é‡å’Œé“¾è¡¨åŠå…¶ç»„åˆä½œä¸ºåŸºæœ¬å­˜å‚¨ç»“æ„ï¼Œå¦‚å †æ ˆå’Œå„ç§é˜Ÿåˆ—ã€‚è€Œå…³è”å¼å®¹å™¨é‡‡ç”¨å¹³è¡¡äºŒå‰æœç´¢æ ‘ä½œä¸ºåº•å±‚å­˜å‚¨ç»“æ„ã€‚</p><h3 id="6-è¯´è¯´STLçš„å®¹å™¨é€‚é…å™¨ï¼Ÿ"><a href="#6-è¯´è¯´STLçš„å®¹å™¨é€‚é…å™¨ï¼Ÿ" class="headerlink" title="6. è¯´è¯´STLçš„å®¹å™¨é€‚é…å™¨ï¼Ÿ"></a>6. è¯´è¯´STLçš„å®¹å™¨é€‚é…å™¨ï¼Ÿ</h3><p>å®¹å™¨é€‚é…å™¨ï¼Œå…¶å°±æ˜¯å°†ä¸é€‚ç”¨çš„åºåˆ—å¼å®¹å™¨ï¼ˆåŒ…æ‹¬ vectorã€deque å’Œ listï¼‰å˜å¾—é€‚ç”¨ã€‚å®¹å™¨é€‚é…å™¨çš„åº•å±‚å®ç°éƒ½æ˜¯é€šè¿‡å°è£…æŸä¸ªåºåˆ—å¼å®¹å™¨ï¼Œå¹¶é‡æ–°ç»„åˆè¯¥å®¹å™¨ä¸­åŒ…å«çš„æˆå‘˜å‡½æ•°ï¼Œä½¿å…¶æ»¡è¶³æŸäº›ç‰¹å®šåœºæ™¯çš„éœ€è¦ã€‚</p><p>(1) <strong>stack</strong></p><p>â‘ ã€€stackï¼ˆæ ˆï¼‰æ˜¯ä¸€ç§<strong>å…ˆè¿›åå‡ºï¼ˆFirst In Last Outï¼‰</strong>çš„æ•°æ®ç»“æ„ï¼Œåªæœ‰ä¸€ä¸ªå‡ºå…¥å£ï¼Œé‚£å°±æ˜¯æ ˆé¡¶ï¼Œé™¤äº†å¯¹æ ˆé¡¶å…ƒç´ è¿›è¡Œæ“ä½œå¤–ï¼Œæ²¡æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥æ“ä½œå†…éƒ¨çš„å…¶ä»–å…ƒç´ ã€‚</p><p>â‘¡ã€€C++çš„æ ˆæ˜¯ä¸€ç§<strong>å®¹å™¨é€‚é…å™¨</strong>ï¼Œå…¶åº•å±‚æ•°æ®ç»“æ„ä¸€èˆ¬ç”¨<strong>listæˆ–deque</strong>å®ç°ï¼Œåªå¼€æ”¾ä¸€éƒ¨åˆ†çš„æ¥å£å’Œæ–¹æ³•å³å¯å®Œæˆå¯¹æ ˆçš„æ”¯æŒã€‚</p><p>(2) <strong>queue</strong></p><p>â‘ ã€€queueï¼ˆé˜Ÿåˆ—ï¼‰æ˜¯ä¸€ç§<strong>å…ˆè¿›å…ˆå‡ºï¼ˆFirst In First Outï¼‰</strong>çš„æ•°æ®ç»“æ„ï¼Œåªæœ‰ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£ï¼Œåˆ†åˆ«ä½äºé˜Ÿå¤´ä¸é˜Ÿå°¾ï¼Œåªèƒ½åœ¨é˜Ÿå°¾æ’å…¥å…ƒç´ ï¼Œåœ¨é˜Ÿå¤´å–å‡ºå…ƒç´ ï¼Œæ²¡æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥æ“ä½œå†…éƒ¨çš„å…¶ä»–å…ƒç´ ã€‚</p><p>â‘¡ã€€C++çš„é˜Ÿåˆ—æ˜¯ä¸€ç§<strong>å®¹å™¨é€‚é…å™¨</strong>ï¼Œå…¶åº•å±‚æ•°æ®ç»“æ„ä¸€èˆ¬ç”¨<strong>listæˆ–deque</strong>å®ç°ï¼Œåªå¼€æ”¾ä¸€éƒ¨åˆ†çš„æ¥å£å’Œæ–¹æ³•å³å¯å®Œæˆå¯¹é˜Ÿåˆ—çš„æ”¯æŒã€‚</p><p>(3) <strong>priority_queue</strong></p><p>â‘ ã€€priority_queueï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ª<strong>æ‹¥æœ‰æƒå€¼è§‚å¿µçš„queue</strong>ï¼Œå®ƒè·Ÿqueueä¸€æ ·åªèƒ½åœ¨é˜Ÿå°¾æ’å…¥å…ƒç´ ï¼Œåœ¨é˜Ÿå¤´å–å‡ºå…ƒç´ ã€‚åœ¨æ’å…¥å…ƒç´ æ—¶ï¼Œå…ƒç´ å¹¶éæŒ‰ç…§æ’å…¥æ¬¡åºæ’åˆ—ï¼Œå®ƒä¼šè‡ªåŠ¨æ ¹æ®æƒå€¼ï¼ˆé€šå¸¸æ˜¯å…ƒç´ çš„å®å€¼ï¼‰æ’åˆ—ï¼Œæƒå€¼æœ€é«˜ï¼Œæ’åœ¨æœ€å‰é¢ã€‚</p><p>â‘¡ã€€priority queueï¼ˆä¼˜å…ˆé˜Ÿåˆ—ï¼‰çš„åº•å±‚å®ç°æœºåˆ¶å®é™…ä¸Šæ˜¯<strong>å †</strong>ï¼Œå› ä¸ºå¤§æ ¹å †æ€»æ˜¯æœ€å¤§å€¼ä½äºå †çš„æ ¹éƒ¨ï¼Œä¼˜å…ˆçº§æœ€é«˜ã€‚</p><p>â‘¢ã€€C++ä¸­çš„å †æ˜¯å®¹å™¨é€‚é…å™¨ï¼Œä¸€èˆ¬æ˜¯vectorä¸ºåº•å±‚å®¹å™¨ï¼Œä»¥å †çš„å¤„ç†è§„åˆ™æ¥è¿›è¡Œç®¡ç†ã€‚</p><h3 id="7-è¯´è¯´STLçš„è¿­ä»£å™¨ï¼Ÿ"><a href="#7-è¯´è¯´STLçš„è¿­ä»£å™¨ï¼Ÿ" class="headerlink" title="7. è¯´è¯´STLçš„è¿­ä»£å™¨ï¼Ÿ"></a>7. è¯´è¯´STLçš„è¿­ä»£å™¨ï¼Ÿ</h3><p>(1) <strong>è¿­ä»£å™¨æ˜¯è¿æ¥å®¹å™¨å’Œç®—æ³•çš„ä¸€ç§é‡è¦æ¡¥æ¢ï¼Œé€šè¿‡è¿­ä»£å™¨å¯ä»¥åœ¨ä¸äº†è§£å®¹å™¨å†…éƒ¨åŸç†çš„æƒ…å†µä¸‹éå†å®¹å™¨ã€‚</strong></p><p>(2) åœ¨éå†å®¹å™¨çš„æ—¶å€™ï¼Œä¸å¯é¿å…çš„è¦å¯¹éå†çš„å®¹å™¨å†…éƒ¨æœ‰æ‰€äº†è§£ï¼Œæ‰€ä»¥ï¼Œå¹²è„†æŠŠè¿­ä»£å™¨çš„å¼€å‘å·¥ä½œäº¤ç»™å®¹å™¨çš„è®¾è®¡è€…å¥½äº†ï¼Œå¦‚æ­¤ä»¥æ¥ï¼Œæ‰€æœ‰å®ç°ç»†èŠ‚åè€Œå¾—ä»¥å°è£…èµ·æ¥ä¸è¢«ä½¿ç”¨è€…çœ‹åˆ°ï¼Œè¿™æ­£æ˜¯ä¸ºä»€ä¹ˆæ¯ä¸€ç§ STL å®¹å™¨éƒ½æä¾›æœ‰ä¸“å±è¿­ä»£å™¨çš„ç¼˜æ•…ã€‚</p><p>(3) è¿­ä»£å™¨ç§ç±»åˆ†ä¸º5ç±»ï¼š</p><p>â‘ ã€€<strong>è¾“å…¥è¿­ä»£å™¨ï¼š</strong>æ˜¯åªè¯»è¿­ä»£å™¨ï¼Œåœ¨æ¯ä¸ªè¢«éå†çš„ä½ç½®ä¸Šåªèƒ½è¯»å–ä¸€æ¬¡ã€‚</p><p>â‘¡ã€€<strong>è¾“å‡ºè¿­ä»£å™¨ï¼š</strong>æ˜¯åªå†™è¿­ä»£å™¨ï¼Œåœ¨æ¯ä¸ªè¢«éå†çš„ä½ç½®ä¸Šåªèƒ½è¢«å†™ä¸€æ¬¡ã€‚</p><p>â‘¢ã€€<strong>å‰å‘è¿­ä»£å™¨ï¼š</strong>å…¼å…·è¾“å…¥å’Œè¾“å‡ºè¿­ä»£å™¨çš„èƒ½åŠ›ï¼Œä½†æ˜¯å®ƒå¯ä»¥å¯¹åŒä¸€ä¸ªä½ç½®é‡å¤è¿›è¡Œè¯»å’Œå†™ã€‚ä½†å®ƒä¸æ”¯æŒoperatorâ€“ï¼Œæ‰€ä»¥åªèƒ½å‘å‰ç§»åŠ¨ã€‚</p><p>â‘£ã€€<strong>åŒå‘è¿­ä»£å™¨ï¼š</strong>å¾ˆåƒå‰å‘è¿­ä»£å™¨ï¼Œåªæ˜¯å®ƒå‘åç§»åŠ¨å’Œå‘å‰ç§»åŠ¨åŒæ ·å®¹æ˜“ã€‚</p><p>â‘¤ã€€<strong>éšæœºè®¿é—®è¿­ä»£å™¨ï¼š</strong>æœ‰åŒå‘è¿­ä»£å™¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚è€Œä¸”ï¼Œå®ƒè¿˜æä¾›äº†â€œè¿­ä»£å™¨ç®—æœ¯â€ï¼Œå³åœ¨ä¸€æ­¥å†…å¯ä»¥å‘å‰æˆ–å‘åè·³è·ƒä»»æ„ä½ç½®ï¼Œ åŒ…å«æŒ‡é’ˆçš„æ‰€æœ‰æ“ä½œï¼Œå¯è¿›è¡Œéšæœºè®¿é—®ï¼Œéšæ„ç§»åŠ¨æŒ‡å®šçš„æ­¥æ•°ã€‚</p><p>(5) é€šè¿‡traitsæŠ€æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°è¿­ä»£å™¨ä¸€äº›ç‰¹æ€§ï¼ŒSTLè§„å®šï¼Œæ¯ä¸€ä¸ªè¿­ä»£å™¨è‡³å°‘åŒ…å«ä»¥ä¸‹å‡ ç§ç‰¹æ€§ä¾›å¤–ç•Œè·å–ï¼Œæ–¹ä¾¿ç®—æ³•ä½¿ç”¨è¿­ä»£å™¨ã€‚</p><p>â‘ ã€€<strong>value_typeï¼š</strong>è¿­ä»£å™¨æ‰€æŒ‡å¯¹è±¡çš„ç±»å‹</p><p>â‘¡ã€€<strong>difference_typeï¼š</strong>ä¸¤ä¸ªè¿­ä»£å™¨ä¹‹é—´çš„è·ç¦»</p><p>â‘¢ã€€<strong>pointerï¼š</strong>è¿­ä»£å™¨æ‰€æŒ‡å¯¹è±¡çš„æŒ‡é’ˆç±»å‹</p><p>â‘£ã€€<strong>referenceï¼š</strong>è¿­ä»£å™¨æ‰€æŒ‡å¯¹è±¡çš„å¼•ç”¨ç±»å‹</p><p>â‘¤ã€€<strong>iterator_categoryï¼š</strong>è¿­ä»£å™¨ç§ç±»</p><p>(6) è¿­ä»£å™¨å¤±æ•ˆé—®é¢˜</p><p>â‘ ã€€<strong>æ•°ç»„å‹æ•°æ®ç»“æ„ï¼ˆvectorï¼‰ï¼š</strong>è¯¥æ•°æ®ç»“æ„çš„å…ƒç´ æ˜¯åˆ†é…åœ¨è¿ç»­çš„å†…å­˜ä¸­ï¼Œinsertå’Œeraseæ“ä½œï¼Œéƒ½ä¼šä½¿å¾—åˆ é™¤ç‚¹å’Œæ’å…¥ç‚¹ä¹‹åçš„å…ƒç´ æŒªä½ç½®ï¼Œæ‰€ä»¥ï¼Œæ’å…¥ç‚¹å’Œåˆ é™¤æ‰ä¹‹åçš„è¿­ä»£å™¨å…¨éƒ¨å¤±æ•ˆï¼Œä¹Ÿå°±æ˜¯è¯´insert( <em> iter)(æˆ–erase( </em> iter))ï¼Œç„¶åå†iter++ï¼Œæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚è§£å†³æ–¹æ³•ï¼šerase( * iter)çš„è¿”å›å€¼æ˜¯ä¸‹ä¸€ä¸ªæœ‰æ•ˆè¿­ä»£å™¨çš„å€¼ã€‚ iter =cont.erase(iter)ã€‚</p><p>â‘¡ã€€<strong>é“¾è¡¨å‹æ•°æ®ç»“æ„ï¼š</strong>å¯¹äºlistå‹çš„æ•°æ®ç»“æ„ï¼Œä½¿ç”¨äº†ä¸è¿ç»­åˆ†é…çš„å†…å­˜ï¼Œåˆ é™¤è¿ç®—ä½¿æŒ‡å‘åˆ é™¤ä½ç½®çš„è¿­ä»£å™¨å¤±æ•ˆï¼Œä½†æ˜¯ä¸ä¼šå¤±æ•ˆå…¶ä»–è¿­ä»£å™¨.è§£å†³åŠæ³•ä¸¤ç§ï¼Œerase( * iter)ä¼šè¿”å›ä¸‹ä¸€ä¸ªæœ‰æ•ˆè¿­ä»£å™¨çš„å€¼ï¼Œæˆ–è€…erase(iter++)ã€‚</p><p>â‘¢ã€€<strong>æ ‘å½¢æ•°æ®ç»“æ„ï¼š</strong> ä½¿ç”¨çº¢é»‘æ ‘æ¥å­˜å‚¨æ•°æ®ï¼Œæ’å…¥ä¸ä¼šä½¿å¾—ä»»ä½•è¿­ä»£å™¨å¤±æ•ˆï¼›åˆ é™¤è¿ç®—ä½¿æŒ‡å‘åˆ é™¤ä½ç½®çš„è¿­ä»£å™¨å¤±æ•ˆï¼Œä½†æ˜¯ä¸ä¼šå¤±æ•ˆå…¶ä»–è¿­ä»£å™¨ã€‚eraseè¿­ä»£å™¨åªæ˜¯è¢«åˆ å…ƒç´ çš„è¿­ä»£å™¨å¤±æ•ˆï¼Œä½†æ˜¯è¿”å›å€¼ä¸ºvoidï¼Œæ‰€ä»¥è¦é‡‡ç”¨erase(iter++)çš„æ–¹å¼åˆ é™¤è¿­ä»£å™¨ã€‚</p><p>â‘£ã€€<strong>Dequeï¼š</strong>æ’å…¥å¤´å°¾ä¼šä½¿<strong>è¿­ä»£å™¨å…¨éƒ¨å¤±æ•ˆä½†æ˜¯å¼•ç”¨ä¸å¤±æ•ˆ</strong>ã€‚å…¶åŸå› åœ¨äºæ’å…¥å¤´å°¾å¯èƒ½ä¼šè¿›è¡Œæ‰©å®¹ï¼Œç”±äºmapçš„é‡æ–°åˆ†é…ï¼Œè¿­ä»£å™¨çš„nodeå¤±æ•ˆï¼Œä½†æ˜¯åŸmapæŒ‡å‘çš„è¿ç»­æ•°ç»„å¹¶æ²¡æœ‰é‡æ–°åˆ†é…ã€‚å› æ­¤ï¼Œå¯¹æ•´ä¸ªè¿­ä»£å™¨æ¥è¯´æ˜¯å¤±æ•ˆçš„ï¼Œä½†å¯¹äºå…ƒç´ çš„æŒ‡é’ˆå’Œå¼•ç”¨ä»ç„¶æ˜¯æœ‰æ•ˆçš„ã€‚<strong>åˆ é™¤å¤´å°¾ä¼šä½¿è¢«åˆ é™¤çš„å…ƒç´ è¿­ä»£å™¨å’Œå¼•ç”¨å¤±æ•ˆï¼Œæ’å…¥å’Œåˆ é™¤ä¸­é—´ä¼šä½¿è¿­ä»£å™¨å’Œå¼•ç”¨å…¨éƒ¨å¤±æ•ˆã€‚</strong></p><p>â‘¤ã€€<strong>unodered_map/unordered_setï¼š</strong>ç”±äºåº•å±‚æ˜¯å“ˆå¸Œè¡¨ï¼Œè¿­ä»£å™¨æ˜¯å¦å¤±æ•ˆä¸»è¦çœ‹å“ˆå¸Œè¡¨çš„å®ç°ç­–ç•¥ï¼Œå¯¹äºä½¿ç”¨<strong>é™¤ç•™ä½™æ•°æ³•å’Œå¼€é“¾æ³•</strong>çš„å“ˆå¸Œè¡¨æ¥è¯´ï¼Œåˆ é™¤è¿ç®—ä½¿æŒ‡å‘åˆ é™¤ä½ç½®çš„è¿­ä»£å™¨å¤±æ•ˆï¼Œä½†æ˜¯ä¸ä¼šå¤±æ•ˆå…¶ä»–è¿­ä»£å™¨ã€‚</p><h3 id="8-è¯´è¯´STLå®¹å™¨çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Ÿ"><a href="#8-è¯´è¯´STLå®¹å™¨çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Ÿ" class="headerlink" title="8. è¯´è¯´STLå®¹å™¨çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Ÿ"></a>8. è¯´è¯´STLå®¹å™¨çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Ÿ</h3><p><strong>STLåªä¿è¯æœ€ä½é™åº¦çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œå³ï¼š</strong>å¤šä¸ªè¯»è€…æ˜¯å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»å–ä¸€ä¸ªå®¹å™¨çš„å†…å®¹ï¼Œä½†å¦‚æœæœ‰å¤šä¸ªå†™è€…ï¼Œåˆ™å¿…é¡»ä½¿ç”¨åŒæ­¥äº’æ–¥æœºåˆ¶ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><h3 id="9-STLå®¹å™¨çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ"><a href="#9-STLå®¹å™¨çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ" class="headerlink" title="9. STLå®¹å™¨çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ"></a>9. STLå®¹å™¨çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ</h3><p>(1) vectorçš„ä½¿ç”¨åœºæ™¯ï¼šåªæŸ¥çœ‹ï¼Œè€Œä¸é¢‘ç¹æ’å…¥åˆ é™¤çš„</p><p>(2) dequeçš„ä½¿ç”¨åœºæ™¯ï¼šå¤´å°¾éœ€è¦é¢‘ç¹æ’å…¥åˆ é™¤</p><p>(3) listçš„ä½¿ç”¨åœºæ™¯ï¼šé¢‘ç¹çš„æ’å…¥åˆ é™¤çš„åœºæ™¯ï¼Œä¸”ä½ç½®ä¸å›ºå®š</p><p>(4) Setï¼šé’ˆå¯¹å•ä¸€å€¼çš„å¢åˆ æŸ¥æ”¹æ“ä½œéƒ½è¦æœ‰ï¼Œä¸”è¦æ±‚æ•°æ®æœ‰åº</p><p>(5) Mapï¼šé’ˆå¯¹é”®å€¼å¯¹çš„å¢åˆ æŸ¥æ”¹æ“ä½œéƒ½è¦æœ‰ï¼Œä¸”è¦æ±‚æ•°æ®æœ‰åº</p><p>(6) unordered_setï¼šé’ˆå¯¹å•ä¸€å€¼çš„å¢åˆ æŸ¥æ”¹æ“ä½œéƒ½è¦æœ‰ï¼Œæ•°æ®æ’åˆ—æ— è¦æ±‚ã€‚</p><p>(7) unordered_mapï¼šé’ˆå¯¹é”®å€¼å¯¹çš„å¢åˆ æŸ¥æ”¹æ“ä½œéƒ½è¦æœ‰ï¼Œæ•°æ®æ’åˆ—æ— è¦æ±‚ã€‚</p>]]></content>
    
    
    <summary type="html">CppåŸºç¡€éƒ¨åˆ†</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>tinyxml:è§£æXMLæ ¼å¼æ–‡ä»¶</title>
    <link href="https://penge666.github.io/posts/60c6b3ce.html"/>
    <id>https://penge666.github.io/posts/60c6b3ce.html</id>
    <published>2024-05-13T08:58:25.000Z</published>
    <updated>2024-05-13T08:58:31.967Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>gdbè°ƒè¯•æ€»ç»“</title>
    <link href="https://penge666.github.io/posts/df73e2d8.html"/>
    <id>https://penge666.github.io/posts/df73e2d8.html</id>
    <published>2024-05-13T08:18:27.000Z</published>
    <updated>2024-05-13T08:54:18.379Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><strong>GDB</strong> (å…¨ç§°ä¸ºGNU Debuger) æ˜¯ä¸€æ¬¾ç”± GNU å¼€æºç»„ç»‡å‘å¸ƒã€åŸºäº UNIX/LINUX æ“ä½œç³»ç»Ÿçš„<strong>å‘½ä»¤è¡Œç¨‹åºè°ƒè¯•å·¥å…·</strong>ã€‚å¯¹äºä¸€å Linux ä¸‹å·¥ä½œçš„ C++ ç¨‹åºå‘˜ï¼ŒGDB æ˜¯å¿…ä¸å¯å°‘çš„å·¥å…·ã€‚</p><h2 id="GDBå¸¸ç”¨è°ƒè¯•å‘½ä»¤">GDBå¸¸ç”¨è°ƒè¯•å‘½ä»¤</h2><p>ä¸ºäº†ä¾¿äºè®²è§£ï¼Œå°†é€šè¿‡ä»¥ä¸‹ demo è¿›è¡Œä¸¾ä¾‹è¯´æ˜ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    sum = a + b;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    sum = <span class="built_in">add</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; sum &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ï¼‘ï¼å¯åŠ¨ GDB</strong></p><p>å¯¹äº C/C++ ç¨‹åºè°ƒè¯•ï¼Œ<strong>éœ€è¦åœ¨ç¼–è¯‘å‰åŠ å…¥ -g å‚æ•°é€‰é¡¹ï¼Œè¡¨ç¤ºåŠ å…¥ä¸€äº›è°ƒè¯•ä¿¡æ¯ã€‚è¿™æ ·åœ¨ç¼–è¯‘åç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶æ‰èƒ½ä½¿ç”¨ GDB è¿›è¡Œè°ƒè¯•</strong>ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -g main.cpp -o demo  <span class="comment">// ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨ GDB å‘½ä»¤ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb demo  <span class="comment">// å¯åŠ¨ GDB è°ƒè¯•</span></span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚å›¾ 1 æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ gdb main</span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04.1) 9.2</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">Type <span class="string">&quot;show copying&quot;</span> and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>...</span><br><span class="line">Reading symbols from main...</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure><p><strong>2. ç»ˆç«¯åˆ—å‡ºæºä»£ç </strong></p><p>æˆ‘ä»¬å¯ä»¥åœ¨ç»ˆç«¯åˆ—å‡ºè¦è°ƒè¯•çš„ä»£ç ï¼Œè¿™æ ·å¯ä»¥ä¸ç”¨æ‰“å¼€æºæ–‡ä»¶æŸ¥çœ‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list  <span class="comment">// æ‰§è¡Œä¸€æ¬¡åˆ—å‡º 10 è¡Œä»£ç ï¼Œå†æ‰§è¡Œä¸€æ¬¡åˆ—å‡ºåé¢ 10 è¡Œä»£ç </span></span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚å›¾ 2 æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>...</span><br><span class="line">Reading symbols from main...</span><br><span class="line">(gdb) list</span><br><span class="line">1       <span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line">2       using namespace std;</span><br><span class="line">3       int add(int a,int b)&#123;</span><br><span class="line">4           int <span class="built_in">sum</span> = 0;</span><br><span class="line">5           <span class="built_in">sum</span> = a + b;</span><br><span class="line">6           <span class="built_in">return</span> <span class="built_in">sum</span>;</span><br><span class="line">7       &#125;</span><br><span class="line">8       int main(int argc,char *argv[])&#123;</span><br><span class="line">9           int <span class="built_in">sum</span> = 0;</span><br><span class="line">10          <span class="built_in">sum</span> = add(1, 2);</span><br><span class="line">(gdb)</span><br><span class="line">11          cout &lt;&lt; <span class="string">sum &lt;&lt; endl;</span></span><br><span class="line"><span class="string">12          return 0;</span></span><br><span class="line"><span class="string">13      &#125;</span></span><br></pre></td></tr></table></figure><p><strong>3. è®¾ç½®æ–­ç‚¹</strong></p><p>æ–­ç‚¹æ˜¯ç¨‹åºè°ƒè¯•çš„å…³é”®æ‰€åœ¨ï¼Œéšå¿ƒæ‰€æ¬²åœ°è®¾ç½®æ–­ç‚¹ä½¿æˆ‘ä»¬è°ƒè¯•ç¨‹åºå˜å¾—é«˜æ•ˆã€‚</p><p>æ–­ç‚¹æ‰“åœ¨æºç¨‹åºç¬¬ n è¡Œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">break</span> n  <span class="comment">// åœ¨æºç¨‹åºç¬¬ n è¡Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œbreak å¯ä»¥ç”¨ b ç¼©å†™æ›¿ä»£</span></span><br></pre></td></tr></table></figure><p>æ–­ç‚¹æ‰“åœ¨æºç¨‹åº main() å‡½æ•°å…¥å£ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">break</span> main  <span class="comment">// åœ¨ main() å‡½æ•°å…¥å£æ‰“æ–­ç‚¹ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 9 è¡Œï¼Œbreak å¯ä»¥ç”¨ b ç¼©å†™æ›¿ä»£</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æ‰“åœ¨æºæ–‡ä»¶çš„å‡½æ•°å…¥å£ï¼Œ<strong>è‹¥è¦å°†æ–­ç‚¹æ‰“åœ¨å…¶ä»–æ–‡ä»¶çš„å‡½æ•°å…¥å£æˆ–è€…å…¶ä»–æ–‡ä»¶çš„ç‰¹å®šè¡Œå·åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</strong></p><p>ä¸‹é¢çš„å‘½ä»¤å¯ä»¥è§£å†³ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">break</span> otherfile:func  <span class="comment">// æ–­ç‚¹æ‰“åœ¨å…¶ä»–æ–‡ä»¶çš„å‡½æ•°å…¥å£</span></span><br><span class="line"><span class="keyword">break</span> otherfile:n     <span class="comment">// æ–­ç‚¹æ‰“åœ¨å…¶ä»–æ–‡ä»¶çš„ç¬¬ n è¡Œ</span></span><br><span class="line"><span class="comment">// æ³¨ï¼šotherfile ä¸ºå…¶ä»–æ–‡ä»¶ï¼Œä¾‹å¦‚ sort.cppï¼Œè€Œ n ä»£è¡¨è¡Œå·</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹æˆ‘ä»¬æ‰€æœ‰æ‰“çš„æ–­ç‚¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info <span class="keyword">break</span>  <span class="comment">// åˆ—å‡ºæˆ‘ä»¬æ‰€æœ‰æ‰“çš„æ–­ç‚¹çš„ä¿¡æ¯ï¼Œbreak å¯ä»¥ç”¨ b ç¼©å†™æ›¿ä»£</span></span><br></pre></td></tr></table></figure><p>é™¤äº†è®¾ç½®æ–­ç‚¹å¤–ï¼Œæˆ‘ä»¬è¿˜èƒ½åˆ é™¤æŒ‡å®šæ–­ç‚¹æˆ–è€…åˆ é™¤å…¨éƒ¨æ–­ç‚¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span>    <span class="comment">// åˆ é™¤å…¨éƒ¨æ–­ç‚¹</span></span><br><span class="line"><span class="keyword">delete</span> n  <span class="comment">// åˆ é™¤æŒ‡å®šæ–­ç‚¹ï¼Œn è¡¨ç¤ºæ–­ç‚¹å·</span></span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä½¿èƒ½å’Œå¤±èƒ½æ–­ç‚¹ï¼Œå¤±èƒ½è¡¨ç¤ºè¿™ä¸ªæ–­ç‚¹ä¸ä¼šåˆ é™¤ï¼Œåªæ˜¯æš‚æ—¶å¤±ä½œç”¨ï¼Œå¯ä»¥ç†è§£ä¸ºå±è”½ã€‚è‹¥æƒ³å†æ¬¡å¯ç”¨å¯ä»¥ç›´æ¥ä½¿èƒ½ï¼Œæ–­ç‚¹åŠŸèƒ½æ¢å¤ï¼Œä¸ç”¨å»é‡æ–°æ‰“æ–­ç‚¹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">disable n  <span class="comment">// å¤±èƒ½ç¬¬ n ä¸ªæ–­ç‚¹</span></span><br><span class="line">enable n   <span class="comment">// ä½¿èƒ½ç¬¬ n ä¸ªæ–­ç‚¹</span></span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚å›¾ 3 æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x11ce: file main.cpp, line 8.</span><br><span class="line">(gdb) b 10</span><br><span class="line">Breakpoint 2 at 0x11e8: file main.cpp, line 10.</span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0x00000000000011ce <span class="keyword">in</span> main(int, char**) at main.cpp:8</span><br><span class="line">2       breakpoint     keep y   0x00000000000011e8 <span class="keyword">in</span> main(int, char**) at main.cpp:10</span><br><span class="line">(gdb) delete</span><br><span class="line">Delete all breakpoints? (y or n) y</span><br><span class="line">(gdb) info b</span><br><span class="line">No breakpoints or watchpoints.</span><br></pre></td></tr></table></figure><p><strong>4. è¿è¡Œç¨‹åº</strong></p><p>è¿è¡Œç¨‹åºå‘½ä»¤ä¸æˆ‘ä»¬ IDE è°ƒè¯•ç¨‹åºç±»ä¼¼ï¼Œä¸¤è€…å¯ä»¥ä½œå¯¹æ¯”ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">run  <span class="comment">// ç±»æ¯”äº IDE çš„å…¨é€Ÿè¿è¡Œï¼Œé‡åˆ°æ–­ç‚¹ä¼šåœä¸‹ï¼Œrun å¯ä»¥ç”¨ r ç¼©å†™æ›¿ä»£</span></span><br><span class="line">next <span class="comment">// ç±»æ¯”äº IDE ä¸è¿›å…¥å‡½æ•°çš„å•æ­¥è°ƒè¯•ï¼Œnext å¯ä»¥ç”¨ n ç¼©å†™æ›¿ä»£</span></span><br><span class="line">step <span class="comment">// ç±»æ¯”äº IDE è¿›å…¥å‡½æ•°çš„å•æ­¥è°ƒè¯•ï¼Œstep å¯ä»¥ç”¨ s ç¼©å†™æ›¿ä»£</span></span><br><span class="line"><span class="keyword">continue</span> <span class="comment">// ç»§ç»­æ‰§è¡Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹åœä¸‹ï¼Œæ²¡æœ‰æ–­ç‚¹ç›´æ¥ç»“æŸï¼Œå¯ä»¥ç”¨ c ç¼©å†™æ›¿ä»£</span></span><br><span class="line">until n  <span class="comment">// ç›´æ¥è·³è½¬åˆ°æŒ‡å®šè¡Œå·ç¨‹åºï¼Œn è¡¨ç¤ºè¡Œå·</span></span><br><span class="line">finish   <span class="comment">// å½“ç¨‹åºè¿è¡Œåœ¨å‡½æ•°ä¸­æ—¶ï¼Œç›´æ¥æ‰§è¡Œå®Œå½“å‰å‡½æ•°å¹¶æ‰“å°å‡½æ•°è¿”å›ä¿¡æ¯</span></span><br><span class="line">kill  <span class="comment">// ç›´æ¥ç»“æŸå½“å‰è¿›ç¨‹ï¼Œç¨‹åºå¯ä»¥ä»å¤´è¿è¡Œ</span></span><br><span class="line">quit  <span class="comment">// é€€å‡º GDBï¼Œquit å¯ä»¥ç”¨ q ç¼©å†™æ›¿ä»£</span></span><br></pre></td></tr></table></figure><p><strong>5.æ‰“å°ä¿¡æ¯</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print x  <span class="comment">// å¯ä»¥æ‰“å°å˜é‡ã€åœ°å€ã€è¡¨è¾¾å¼å€¼ç­‰ï¼Œx è¡¨ç¤ºéœ€è¦æ‰“å°çš„ä¸œè¥¿ï¼Œprint å¯ä»¥ç”¨ p æ›¿ä»£</span></span><br><span class="line">bt  <span class="comment">// æ‰“å°å½“å‰è°ƒç”¨å †æ ˆçš„ä¿¡æ¯ï¼Œåé¢ä¼šç»§ç»­è®²</span></span><br></pre></td></tr></table></figure><p>GDB çš„å¸¸ç”¨è°ƒè¯•å‘½ä»¤åŸºæœ¬ä¸Šå°±è¿™äº›ï¼Œè€Œä¸”éƒ½æœ‰ç¼©å†™è¡¨ç¤ºï¼Œéå¸¸å¥½è®°å¿†çš„ï¼</p><h2 id="GDBè°ƒè¯•coreæ–‡ä»¶">GDBè°ƒè¯•coreæ–‡ä»¶</h2><p>Linuxåº”ç”¨ç¨‹åºå‘ç”Ÿ<code>Segmentation fault</code>æ®µé”™è¯¯æ—¶ï¼Œéœ€è¦åˆ©ç”¨<code>core dump</code>æ–‡ä»¶å®šä½é”™è¯¯ã€‚</p><p>æ®µé”™è¯¯segmentation faultï¼Œä¿¡å·SIGSEGVï¼Œæ˜¯ç”±äºè®¿é—®å†…å­˜ç®¡ç†å•å…ƒMMUå¼‚å¸¸æ‰€è‡´ï¼Œé€šå¸¸ç”±äºæ— æ•ˆå†…å­˜å¼•ç”¨ï¼Œå¦‚æŒ‡é’ˆå¼•ç”¨äº†ä¸€ä¸ªä¸å±äºå½“å‰è¿›ç¨‹åœ°å€ç©ºé—´ä¸­çš„åœ°å€ï¼Œæ“ä½œç³»ç»Ÿä¾¿ä¼šè¿›è¡Œå¹²æ¶‰å¼•å‘SIGSEGVä¿¡å·äº§ç”Ÿæ®µé”™è¯¯ã€‚</p><p><strong>æ®µé”™è¯¯äº§ç”Ÿçš„åŸå› </strong></p><ul><li>ç©ºæŒ‡é’ˆ</li><li>é‡æŒ‡é’ˆ</li><li>å †æ ˆè¶Šç•Œ</li><li>â€¦</li></ul><p><strong>æ ¸å¿ƒè½¬å‚¨</strong></p><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œå¸¸<strong>å°†â€œä¸»å†…å­˜â€ç§°ä¸ºæ ¸å¿ƒ(<code>core</code>)ï¼Œ<strong>è€Œ</strong>æ ¸å¿ƒæ˜ åƒ(<code>core image</code>) å°±æ˜¯ â€œè¿›ç¨‹â€(process)æ‰§è¡Œå½“æ—¶çš„å†…å­˜å†…å®¹ã€‚</strong></p><p>å½“è¿›ç¨‹å‘ç”Ÿé”™è¯¯æˆ–æ”¶åˆ°â€œä¿¡å·â€(signal) è€Œç»ˆæ­¢æ‰§è¡Œæ—¶ï¼Œ<strong>ç³»ç»Ÿä¼šå°†æ ¸å¿ƒæ˜ åƒå†™å…¥ä¸€ä¸ªæ–‡ä»¶</strong>ï¼Œä»¥ä½œä¸ºè°ƒè¯•ä¹‹ç”¨ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„<strong>æ ¸å¿ƒè½¬å‚¨(<code>core dump</code>)ã€‚</strong></p><p>ã€ç®€å•è§£é‡Šã€‘å½“åœ¨ä¸€ä¸ªç¨‹åºå´©æºƒæ—¶ï¼Œç³»ç»Ÿä¼šåœ¨æŒ‡å®šç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª<code>core</code>æ–‡ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code> core</code>æ–‡ä»¶æ¥å¯¹é€ æˆç¨‹åºå´©è´µçš„åŸå› è¿›è¡Œè°ƒè¯•å®šä½ã€‚</p><p><strong>1. äº§ç”Ÿ Segmentation fault ç¨‹åº</strong></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ª<strong>æ²¡æœ‰é€’å½’ç»ˆæ­¢æ¡ä»¶</strong>çš„ç¨‹åºï¼Œæ˜¾ç„¶ä¼šå‘ç”Ÿ Segmentation fault é”™è¯¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ g++ -g -o main main.cpp -lpthread -fpermissive</span><br><span class="line">main.cpp: In <span class="keyword">function</span> â€˜int recursion(int)â€™:</span><br><span class="line">main.cpp:5:1: warning: no <span class="built_in">return</span> statement <span class="keyword">in</span> <span class="keyword">function</span> returning non-void [-Wreturn-<span class="built_in">type</span>]</span><br><span class="line">    5 | &#125;</span><br><span class="line">      | ^</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ ./main</span><br><span class="line">æ®µé”™è¯¯ (æ ¸å¿ƒå·²è½¬å‚¨)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ç¼–è¯‘è¿è¡Œçš„æ—¶å€™æ˜¯æ²¡æœ‰ core æ–‡ä»¶çš„ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰é…ç½®ç”Ÿæˆ core æ–‡ä»¶ã€‚</p><p><strong>2. ç”Ÿæˆ core æ–‡ä»¶</strong></p><p>**Core æ–‡ä»¶æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ç±»å‹ï¼Œé€šå¸¸åœ¨ç¨‹åºå´©æºƒæ—¶ç”±æ“ä½œç³»ç»Ÿç”Ÿæˆã€‚å®ƒåŒ…å«äº†ç¨‹åºå´©æºƒæ—¶çš„å†…å­˜é•œåƒå’Œç¨‹åºçŠ¶æ€ä¿¡æ¯ï¼Œ**æ¯”å¦‚ç¨‹åºè®¡æ•°å™¨ã€å †æ ˆæŒ‡é’ˆã€å¯„å­˜å™¨çŠ¶æ€ç­‰ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥ç”¨æ¥è°ƒè¯•ç¨‹åºï¼Œæ‰¾å‡ºå¯¼è‡´ç¨‹åºå´©æºƒçš„åŸå› ã€‚</p><p>Core æ–‡ä»¶çš„åå­—é€šå¸¸ä¸º â€œcoreâ€ï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡æ“ä½œç³»ç»Ÿçš„è®¾ç½®æ¥æ”¹å˜ã€‚åœ¨ Unix å’Œç±» Unix ç³»ç»Ÿï¼ˆæ¯”å¦‚ Linuxï¼‰ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>ulimit</code> å‘½ä»¤æ¥æ§åˆ¶æ˜¯å¦ç”Ÿæˆ core æ–‡ä»¶ï¼Œä»¥åŠ core æ–‡ä»¶çš„å¤§å°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘ä»¬å…ˆä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ core æ–‡ä»¶å¤§å°ï¼Œè‹¥ç»“æœä¸º 0 è¡¨ç¤ºè¿˜æ²¡æœ‰ç”Ÿæˆ core æ–‡ä»¶ã€‚</span><br><span class="line"></span><br><span class="line"><span class="built_in">ulimit</span> -c  // æŸ¥çœ‹ core æ–‡ä»¶å¤§å°</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(base) sv<span class="meta">@sv</span>-NF5280M5:/home/sv/æ¡Œé¢$ ulimit -c</span><br><span class="line"><span class="number">0</span></span><br><span class="line">(base) sv<span class="meta">@sv</span>-NF5280M5:/home/sv/æ¡Œé¢$ ulimit -a</span><br><span class="line">core file <span class="title function_">size</span>          <span class="params">(blocks, -c)</span> <span class="number">0</span></span><br><span class="line">data seg <span class="title function_">size</span>           <span class="params">(kbytes, -d)</span> unlimited</span><br><span class="line">scheduling <span class="title function_">priority</span>             <span class="params">(-e)</span> <span class="number">0</span></span><br><span class="line">file <span class="title function_">size</span>               <span class="params">(blocks, -f)</span> unlimited</span><br><span class="line">pending <span class="title function_">signals</span>                 <span class="params">(-i)</span> <span class="number">255799</span></span><br><span class="line">max locked <span class="title function_">memory</span>       <span class="params">(kbytes, -l)</span> <span class="number">65536</span></span><br><span class="line">max memory <span class="title function_">size</span>         <span class="params">(kbytes, -m)</span> unlimited</span><br><span class="line">open <span class="title function_">files</span>                      <span class="params">(-n)</span> <span class="number">1024</span></span><br><span class="line">pipe <span class="title function_">size</span>            <span class="params">(<span class="number">512</span> bytes, -p)</span> <span class="number">8</span></span><br><span class="line">POSIX message <span class="title function_">queues</span>     <span class="params">(bytes, -q)</span> <span class="number">819200</span></span><br><span class="line">real-time <span class="title function_">priority</span>              <span class="params">(-r)</span> <span class="number">0</span></span><br><span class="line">stack <span class="title function_">size</span>              <span class="params">(kbytes, -s)</span> <span class="number">8192</span></span><br><span class="line">cpu <span class="title function_">time</span>               <span class="params">(seconds, -t)</span> unlimited</span><br><span class="line">max user <span class="title function_">processes</span>              <span class="params">(-u)</span> <span class="number">255799</span></span><br><span class="line">virtual <span class="title function_">memory</span>          <span class="params">(kbytes, -v)</span> unlimited</span><br><span class="line">file <span class="title function_">locks</span>                      <span class="params">(-x)</span> unlimited</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¿®æ”¹ core æ–‡ä»¶å¤§å°ä¸å—é™åˆ¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -c unlimited  <span class="comment">// ä¿®æ”¹ core æ–‡ä»¶å¤§å°ä¸å—é™åˆ¶</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä»¥ä¸‹å¹¶æœªæŸ¥æ‰¾åˆ°coreæ–‡ä»¶ã€‚</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/</span>æ¡Œé¢<span class="variable">$ </span>g++ -g -o main main.cpp -lpthread -fpermissive</span><br><span class="line">main.<span class="symbol">cpp:</span> <span class="title class_">In</span> function â€˜int recursion(int)â€™:</span><br><span class="line">main.<span class="symbol">cpp:</span><span class="number">5</span><span class="symbol">:</span><span class="number">1</span>: <span class="symbol">warning:</span> no <span class="keyword">return</span> statement <span class="keyword">in</span> function returning non-void [-<span class="title class_">Wreturn</span>-type]</span><br><span class="line">    <span class="number">5</span> |<span class="params"> &#125;</span></span><br><span class="line"><span class="params">      </span>| ^</span><br><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/</span>æ¡Œé¢<span class="variable">$ </span>./main</span><br><span class="line">æ®µé”™è¯¯ (æ ¸å¿ƒå·²è½¬å‚¨)</span><br><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/</span>æ¡Œé¢<span class="variable">$ </span>ls</span><br><span class="line"><span class="string">&#x27;æœªå‘½å 1.ods&#x27;</span>  <span class="string">&#x27;æœªå‘½å 2.odt&#x27;</span>   lu3018gtmnzo.tmp   main.c     params.odt</span><br><span class="line"><span class="string">&#x27;æœªå‘½å 1.odt&#x27;</span>   index.html      main               main.cpp   proxy.txt</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å½“å‰ç›®å½•ä¸‹<strong>æ²¡æœ‰çœ‹åˆ°coreæ–‡ä»¶çš„ç”Ÿæˆ</strong>ã€‚</p><p>è¿™æ˜¯å› ä¸º<strong>coreæ–‡ä»¶çš„é»˜è®¤ç”Ÿæˆè·¯å¾„ä¸å¯¹</strong>ï¼Œåªè¦å‘ç”Ÿæ®µé”™è¯¯æ—¶ï¼Œæ‹¬å·é‡Œå‡ºç°äº†<code>core dumped</code>å°±ä»£è¡¨<code>core</code>æ–‡ä»¶å·²ç”Ÿæˆã€‚</p><p>å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹<code>core</code>æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="regexp">/proc/</span>sys<span class="regexp">/kernel/</span>core_pattern</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ <span class="built_in">cat</span> /proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹<code>core</code>æ–‡ä»¶ç”Ÿæˆè·¯å¾„ä¸ºå½“å‰ç›®å½•ä¸‹</strong>ï¼Œè¾“å…¥å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c <span class="string">&quot;echo core &gt; /proc/sys/kernel/core_pattern &quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ä½¿ç”¨rootç”¨æˆ·æƒé™</p></blockquote><p>ä¿®æ”¹åï¼Œ<code>core</code>æ–‡ä»¶å°±ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆã€‚</p><p>æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">base) sv@sv-NF5280M5:/home/sv/æ¡Œé¢$ <span class="built_in">ls</span></span><br><span class="line"><span class="string">&#x27;æœªå‘½å 1.ods&#x27;</span>  <span class="string">&#x27;æœªå‘½å 2.odt&#x27;</span>   index.html         main     main.cpp     proxy.txt</span><br><span class="line"><span class="string">&#x27;æœªå‘½å 1.odt&#x27;</span>   core            lu3018gtmnzo.tmp   main.c   params.odt</span><br></pre></td></tr></table></figure><p><strong>3.è°ƒè¯• core æ–‡ä»¶</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/</span>æ¡Œé¢<span class="variable">$ </span>gdb main core</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å¯ä»¥æ‰“å°å½“å‰å †æ ˆä¿¡æ¯åˆ†æé—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">backtrace  <span class="comment">// æ‰“å°å½“å‰å †æ ˆä¿¡æ¯ï¼Œbacktrace å¯ä»¥ç”¨ bt çš„ç¼©å†™æ›¿ä»£</span></span><br></pre></td></tr></table></figure><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>           <span class="selector-tag">recursion</span>(n - <span class="number">1</span>);</span><br><span class="line">(gdb) <span class="selector-tag">bt</span></span><br><span class="line"><span class="selector-id">#0</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74180</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261907</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#1</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261906</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#2</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261905</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#3</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261904</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#4</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261903</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#5</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261902</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#6</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261901</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#7</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261900</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#8</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261899</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#9</span>  <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261898</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#10</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261897</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#11</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261896</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#12</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261895</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#13</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261894</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#14</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261893</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#15</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261892</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#16</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261891</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#17</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261890</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#18</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261889</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#19</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261888</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br><span class="line"><span class="selector-id">#20</span> <span class="number">0</span><span class="selector-tag">x000055fb7cc74185</span> <span class="selector-tag">in</span> <span class="selector-tag">recursion</span> (n=-<span class="number">261887</span>) <span class="selector-tag">at</span> <span class="selector-tag">main</span><span class="selector-class">.cpp</span>:<span class="number">4</span></span><br></pre></td></tr></table></figure><p>å¸¸ä½¿ç”¨çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bt æˆ– backtrace: æ˜¾ç¤ºå½“å‰çº¿ç¨‹çš„è°ƒç”¨æ ˆè·Ÿè¸ªã€‚</span><br><span class="line">info threads: åˆ—å‡ºæ‰€æœ‰çº¿ç¨‹ã€‚</span><br><span class="line">thread n: åˆ‡æ¢åˆ°æŒ‡å®šçš„çº¿ç¨‹å·ï¼Œnä¸ºæŒ‡å®šçš„çº¿ç¨‹å·</span><br><span class="line">list: æ˜¾ç¤ºå½“å‰æ‰§è¡Œçš„æºä»£ç ã€‚</span><br><span class="line"><span class="built_in">print</span> x: æ‰“å°å˜é‡æˆ–è¡¨è¾¾å¼çš„å€¼ï¼Œxä¸ºå˜é‡æˆ–è¡¨è¾¾å¼</span><br><span class="line">frame f: åˆ‡æ¢åˆ°ç‰¹å®šçš„æ ˆå¸§ã€‚fä¸ºæŒ‡å®šçš„æ ˆå¸§å·</span><br><span class="line">thread apply all bt: æ‰“å°æ‰€æœ‰å †æ ˆä¿¡æ¯</span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡çŒ®</p><ul><li><a href="https://blog.csdn.net/weixin_44046545/article/details/138252207">ä¸€ç¯‡æ–‡ç« è½»æ¾å­¦ä¼šä½¿ç”¨gdbè°ƒè¯•ç¨‹åºçš„coreæ–‡ä»¶ï¼ˆè°ƒè¯•å…¨è¿‡ç¨‹ï¼‰</a></li><li><a href="https://www.kancloud.cn/wizardforcel/gdb-tips-100">https://www.kancloud.cn/wizardforcel/gdb-tips-100</a></li><li>[<a href="https://ivanzz1001.github.io/records/post/cplusplus/2018/08/19/cpluscplus-gdbusage_part2">GDBè°ƒè¯•å¤šçº¿ç¨‹åŠå¤šè¿›ç¨‹</a>](<a href="https://ivanzz1001.github.io/records/post/cplusplus/2018/08/19/cpluscplus-gdbusage_part2">GDBè°ƒè¯•å¤šçº¿ç¨‹åŠå¤šè¿›ç¨‹</a>)</li></ul>]]></content>
    
    
    <summary type="html">GDBè°ƒè¯•</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>Linuxå®æˆ˜æŠ€èƒ½</title>
    <link href="https://penge666.github.io/posts/a9ea3099.html"/>
    <id>https://penge666.github.io/posts/a9ea3099.html</id>
    <published>2024-05-10T14:29:26.000Z</published>
    <updated>2024-05-11T09:39:55.324Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å‘çƒ§äº†2å¤©ï¼Œæ‰äº†ä¸€å¤©çš„æ°´ï¼Œçƒ§çš„å¿«è§å¤ªå¥¶äº†ã€‚</p><p>Lastï¼Œçºµä½¿äººç”Ÿç™¾èˆ¬æ»‹å‘³ï¼Œä¹Ÿè¦ç¬‘å¯¹ï¼ï¼ï¼</p><h2 id="LinuxèƒŒæ™¯ä»‹ç»">LinuxèƒŒæ™¯ä»‹ç»</h2><h3 id="Linuxç‰ˆæœ¬">Linuxç‰ˆæœ¬</h3><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å†…æ ¸ç‰ˆæœ¬ï¼š</span><br><span class="line"></span><br><span class="line"><span class="symbol">https:</span>//www.kernel<span class="meta">.org</span> </span><br></pre></td></tr></table></figure><p>å†…æ ¸ç‰ˆæœ¬åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œä¸»ç‰ˆæœ¬å·ã€æ¬¡ç‰ˆæœ¬å·ã€æœ«ç‰ˆæœ¬å·ï¼Œæ¬¡ç‰ˆæœ¬å·æ˜¯å¥‡æ•°ä¸ºå¼€å‘æ¿ï¼Œå¶æ•°ä¸ºç¨³å®šç‰ˆ</p><p>å‘è¡Œç‰ˆæœ¬</p><p>RedHatï¼šç»è¿‡ä¸“ä¸šæµ‹è¯•</p><p>Fedoraï¼šç¤¾åŒºå‘è¡Œï¼Œç‰ˆæœ¬è¾ƒæ–°ï¼Œä½†æ˜¯æ²¡æœ‰ç»è¿‡ä¸“ä¸šæµ‹è¯•ã€‚ï¼ˆä¹Ÿæ˜¯redhatå‘è¡Œï¼‰</p><p>CentOSï¼šç”¨RedHatçš„æºä»£ç ç¼–è¯‘ï¼Œä½†æ˜¯æŠŠRedHatçš„å•†æ ‡ç­‰å»æ‰ã€‚ä½†æ˜¯æ²¡æœ‰ä¸€äº›æŠ€æœ¯æ”¯æŒ</p><p>æ¡Œé¢å®‰è£…ï¼šDebianï¼ŒUbuntu</p><h3 id="å¸¸è§ç›®å½•">å¸¸è§ç›®å½•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/  æ ¹ç›®å½•</span><br><span class="line">/root  rootç”¨æˆ·çš„å®¶ç›®å½•</span><br><span class="line">/home/username  æ™®é€šç”¨æˆ·çš„å®¶ç›®å½•</span><br><span class="line">/etc  é…ç½®æ–‡ä»¶ç›®å½•</span><br><span class="line">/bin  å‘½ä»¤ç›®å½•</span><br><span class="line">/sbin  ç®¡ç†å‘½ä»¤ç›®å½•</span><br><span class="line">/usr/bin/usr/sbin  ç³»ç»Ÿé¢„è£…çš„å…¶ä»–å‘½ä»¤</span><br></pre></td></tr></table></figure><p><strong>sbinå’Œbinå‘½ä»¤çš„åŒºåˆ«</strong></p><p><code>sbin</code>å’Œ<code>bin</code>éƒ½æ˜¯Linuxæ–‡ä»¶ç³»ç»Ÿä¸­çš„é‡è¦ç›®å½•ï¼Œå®ƒä»¬åˆ†åˆ«å­˜æ”¾äº†ç³»ç»Ÿçš„é‡è¦å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ä¸¤ä¸ªç›®å½•çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œå®ƒä»¬å„è‡ªå­˜æ”¾çš„å‘½ä»¤çš„ä½¿ç”¨è€…ä¸åŒã€‚</p><ul><li><code>bin</code>ç›®å½•ï¼šè¿™ä¸ªç›®å½•å­˜æ”¾çš„æ˜¯æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è¿è¡Œçš„å‘½ä»¤ã€‚è¿™äº›å‘½ä»¤åŒ…æ‹¬å¾ˆå¤šåŸºæœ¬çš„Linuxå‘½ä»¤ï¼Œå¦‚lsã€cpã€rmç­‰ã€‚<code>bin</code>æ˜¯â€œbinaryâ€çš„ç¼©å†™ï¼Œæ„ä¸ºäºŒè¿›åˆ¶ï¼Œè¡¨ç¤ºè¿™ä¸ªç›®å½•ä¸‹å­˜æ”¾çš„éƒ½æ˜¯å¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li><li><code>sbin</code>ç›®å½•ï¼šè¿™ä¸ªç›®å½•å­˜æ”¾çš„æ˜¯ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆrootç”¨æˆ·ï¼‰æ‰èƒ½è¿è¡Œçš„å‘½ä»¤ã€‚è¿™äº›å‘½ä»¤ä¸€èˆ¬éƒ½æ˜¯å’Œç³»ç»Ÿç®¡ç†æœ‰å…³çš„ï¼Œå¦‚fdiskã€ifconfigç­‰ã€‚<code>sbin</code>æ˜¯â€œsystem binaryâ€çš„ç¼©å†™ï¼Œè¡¨ç¤ºè¿™ä¸ªç›®å½•ä¸‹å­˜æ”¾çš„éƒ½æ˜¯ç³»ç»Ÿå‘½ä»¤çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li></ul><p>æ€»çš„æ¥è¯´ï¼Œ<code>bin</code>å’Œ<code>sbin</code>çš„åŒºåˆ«åœ¨äºï¼Œ<code>bin</code>ç›®å½•ä¸‹çš„å‘½ä»¤æ˜¯ç»™æ‰€æœ‰ç”¨æˆ·ä½¿ç”¨çš„ï¼Œè€Œ<code>sbin</code>ç›®å½•ä¸‹çš„å‘½ä»¤åˆ™æ˜¯ç»™ç³»ç»Ÿç®¡ç†å‘˜ä½¿ç”¨çš„ã€‚</p><p>å¦å¤–ï¼Œé™¤äº†æ ¹ç›®å½•ä¸‹çš„<code>/bin</code>å’Œ<code>/sbin</code>ï¼Œåœ¨<code>/usr</code>ç›®å½•ä¸‹ä¹Ÿæœ‰<code>/usr/bin</code>å’Œ<code>/usr/sbin</code>ä¸¤ä¸ªç›®å½•ã€‚å®ƒä»¬çš„ä½œç”¨å’Œæ ¹ç›®å½•ä¸‹çš„<code>/bin</code>ã€<code>/sbin</code>ç±»ä¼¼ï¼Œåªä¸è¿‡<code>/usr/bin</code>å’Œ<code>/usr/sbin</code>ä¸­çš„å‘½ä»¤æ˜¯éå¿…éœ€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç³»ç»Ÿå¯ä»¥åœ¨æ²¡æœ‰è¿™äº›å‘½ä»¤çš„æƒ…å†µä¸‹æ­£å¸¸è¿è¡Œã€‚</p><h2 id="ç³»ç»Ÿæ“ä½œ">ç³»ç»Ÿæ“ä½œ</h2><h3 id="å¸®åŠ©å‘½ä»¤">å¸®åŠ©å‘½ä»¤</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">man</span> æ˜¯ manual çš„ç¼©å†™</span><br><span class="line"><span class="keyword">man</span> å¸®åŠ©ç”¨æ³•æ¼”ç¤º</span><br><span class="line">    #<span class="keyword">man</span> <span class="keyword">ls</span></span><br><span class="line"><span class="keyword">man</span> ä¹Ÿæ˜¯ä¸€æ¡å‘½ä»¤ï¼Œåˆ†ä¸º9ç« ï¼Œå¯ä»¥ä½¿ç”¨<span class="keyword">man</span>å‘½ä»¤è·å¾—<span class="keyword">man</span>çš„å¸®åŠ©</span><br><span class="line">    #<span class="keyword">man</span> 7 <span class="keyword">man</span></span><br></pre></td></tr></table></figure><p><strong>manå‘½ä»¤</strong></p><p><code>man 1 kill</code>ã€<code>man 2 kill</code>ï¼Œè¿™äº›å‘½ä»¤éƒ½æ˜¯æŸ¥çœ‹ kill å‘½ä»¤çš„æ‰‹å†Œï¼Œä½†æ˜¯æ–‡æ¡£å´å¤§ä¸ç›¸åŒã€‚</p><p><strong>å› ä¸º kill æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œçš„å·¥å…·ï¼Œ<code>which kill</code> çœ‹åˆ° /usr/bin/kill æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼›å…¶å®ï¼Œä¹Ÿæœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å«åš killã€‚</strong></p><p>man 1 kill æ˜¾ç¤ºçš„æ˜¯å‘½ä»¤è¡Œå·¥å…· kill çš„æ‰‹å†Œï¼›</p><p>man 2 kill æ˜¾ç¤ºç³»ç»Ÿè°ƒç”¨ kill çš„æ‰‹å†Œï¼›</p><p>æ˜¾ç¤ºä»€ä¹ˆç±»å‹çš„æ‰‹å†Œï¼Œç”± man å’Œå‘½ä»¤ä¸­é—´çš„æ•°å­—å†³å®šï¼Œç›®å‰å…±æœ‰ 9 ä¸ª man æ”¯æŒçš„æ•°å­—ã€‚</p><table><thead><tr><th>æ•°å­—</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>1</td><td>å¯æ‰§è¡Œç¨‹åºæˆ– Shell å‘½ä»¤</td></tr><tr><td>2</td><td>ç³»ç»Ÿè°ƒç”¨ï¼ˆå†…æ ¸æä¾›çš„å‡½æ•°ï¼‰</td></tr><tr><td>3</td><td>åº“è°ƒç”¨</td></tr><tr><td>4</td><td>ç‰¹æ®Šæ–‡ä»¶ï¼ˆé€šå¸¸ä½äº /dev ç›®å½•ï¼‰</td></tr><tr><td>5</td><td>æ–‡ä»¶æ ¼å¼å’Œçº¦å®šï¼ˆæ¯”å¦‚ /etc/passwdï¼‰</td></tr><tr><td>6</td><td>æ¸¸æˆ</td></tr><tr><td>7</td><td>æ‚é¡¹ï¼ˆåŒ…å’Œä¸€äº›çº¦å®šï¼‰Miscellaneous (including macro packages and conventions), e.g. man(7), groff(7)</td></tr><tr><td>8</td><td>ç³»ç»Ÿç®¡ç†å‘½ä»¤ï¼ˆé€šå¸¸æ˜¯ root ç”¨æˆ·æ‰§è¡Œçš„å‘½ä»¤ï¼‰</td></tr><tr><td>9</td><td>å†…æ ¸ç›¸å…³çš„æ–‡ä»¶ Kernel routines [Non standard]</td></tr></tbody></table><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">help</span></span><br><span class="line"><span class="keyword">shell</span>ï¼ˆå‘½ä»¤è§£é‡Šå™¨ï¼‰è‡ªå¸¦çš„å‘½ä»¤æˆä¸ºå†…éƒ¨å‘½ä»¤ï¼Œå…¶ä»–çš„æ˜¯å¤–éƒ¨å‘½ä»¤</span><br><span class="line">å†…éƒ¨å‘½ä»¤ä½¿ç”¨ <span class="keyword">help</span> å¸®åŠ©</span><br><span class="line">    #<span class="keyword">help</span> <span class="keyword">cd</span></span><br><span class="line">å¤–éƒ¨å‘½ä»¤ä½¿ç”¨<span class="keyword">help</span>å¸®åŠ©</span><br><span class="line">    #<span class="keyword">ls</span> --<span class="keyword">help</span></span><br><span class="line"></span><br><span class="line">å¯ä»¥é€šè¿‡<span class="keyword">type</span>æ¥åˆ¤æ–­ä¸€ä¸ªå‘½ä»¤æ˜¯å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨å‘½ä»¤</span><br><span class="line">    #<span class="keyword">type</span> <span class="keyword">ls</span></span><br><span class="line">    #<span class="keyword">type</span> <span class="keyword">cd</span></span><br></pre></td></tr></table></figure><p>Linuxçš„å‘½ä»¤å¯ä»¥åˆ†ä¸ºå†…éƒ¨å‘½ä»¤å’Œå¤–éƒ¨å‘½ä»¤ï¼š</p><ul><li>å†…ç½®å‘½ä»¤åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å°±è°ƒå…¥å†…å­˜ï¼Œæ˜¯å¸¸é©»å†…å­˜çš„ï¼Œæ‰€ä»¥æ‰§è¡Œæ•ˆç‡é«˜ã€‚</li><li>å¤–éƒ¨å‘½ä»¤æ˜¯ç³»ç»Ÿçš„è½¯ä»¶åŠŸèƒ½ï¼Œç”¨æˆ·éœ€è¦æ—¶æ‰ä»ç¡¬ç›˜ä¸­è¯»å…¥å†…å­˜ã€‚</li></ul><h3 id="æ–‡ä»¶ç®¡ç†">æ–‡ä»¶ç®¡ç†</h3><p>æ˜¾ç¤ºå½“å‰çš„ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span> æ˜¾ç¤ºå½“å‰çš„ç›®å½•åç§°</span><br></pre></td></tr></table></figure><p>æ›´æ”¹å½“å‰çš„æ“ä½œç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> æ›´æ”¹å½“å‰çš„æ“ä½œç›®å½•</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /path/to/... ç»å¯¹è·¯å¾„</span><br><span class="line"><span class="built_in">cd</span> ./path/to/... ç›¸å¯¹è·¯å¾„</span><br><span class="line"><span class="built_in">cd</span> ../path/to/... ç›¸å¯¹è·¯å¾„</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶</span><br><span class="line"><span class="built_in">ls</span> /  /root    è¿™æ ·ä¼šåŒæ—¶æŸ¥çœ‹æ ¹ç›®å½•å’Œ /rootç›®å½•ä¸‹çš„æ–‡ä»¶</span><br><span class="line">å¸¸ç”¨å‚æ•°</span><br><span class="line">    -l é•¿æ ¼å¼æ˜¾ç¤ºæ–‡ä»¶</span><br><span class="line">    -a æ˜¾ç¤ºéšè—æ–‡ä»¶</span><br><span class="line">    -r é€†åºæ˜¾ç¤ºï¼ˆé»˜è®¤æŒ‰ç…§æ–‡ä»¶åæ’åºï¼‰</span><br><span class="line">    -t æŒ‰ç…§æ—¶é—´é¡ºåºæ˜¾ç¤º   <span class="built_in">ls</span> -l -r -t ï¼ˆä¼šæŒ‰ç…§æ—¶é—´é€†å‘æ’åºï¼‰</span><br><span class="line">    -R é€’å½’æ˜¾ç¤º    -h äººæ€§åŒ–æ˜¾ç¤ºã€    -d åªæ˜¾ç¤ºç›®å½•</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/$ sudo <span class="built_in">ls</span> /  /root</span><br><span class="line">[sudo] sv çš„å¯†ç ï¼š</span><br><span class="line">/:</span><br><span class="line">bin   cdrom  data_old  etc   lib    lib64   lost+found  mmkv.default      mnt  proc  run   snap  swapfile  tmp  var</span><br><span class="line">boot  data   dev       home  lib32  libx32  media       mmkv.default.crc  opt  root  sbin  srv   sys       usr</span><br><span class="line"></span><br><span class="line">/root:</span><br><span class="line">snap</span><br></pre></td></tr></table></figure><p>ç›®å½•æ–‡ä»¶çš„åˆ›å»ºä¸åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span>  å»ºç«‹ç©ºç›®å½•</span><br><span class="line"><span class="built_in">mkdir</span> a</span><br><span class="line"></span><br><span class="line">å¸¸ç”¨å‚æ•°</span><br><span class="line">    -p  é€’å½’åˆ›å»ºå¤šçº§æ–‡ä»¶å¤¹</span><br><span class="line"></span><br><span class="line"><span class="built_in">rmdir</span> åˆ é™¤ç©ºæ–‡ä»¶å¤¹</span><br><span class="line"><span class="built_in">rmdir</span> a</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> å¯ä»¥åˆ é™¤éç©ºç›®å½•åŠæ–‡ä»¶</span><br><span class="line"></span><br><span class="line">å¸¸ç”¨å‚æ•°</span><br><span class="line">    -r åˆ é™¤ç›®å½•</span><br><span class="line">    -f å¼ºåˆ¶åˆ é™¤ï¼Œä¸æç¤º</span><br><span class="line">    éœ€è¦æ³¨æ„ï¼Œ<span class="built_in">rm</span> -rf åé¢å¯ä»¥è·Ÿå¤šä¸ªç›®å½•ï¼Œä¸è¦å‡ºç° <span class="built_in">rm</span> -rf / usr è¿™ç§ï¼Œä¼šä»æ ¹ç›®å½•å¼€å§‹åˆ é™¤</span><br></pre></td></tr></table></figure><p>å¤åˆ¶å’Œç§»åŠ¨ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> å¤åˆ¶æ–‡ä»¶å’Œç›®å½•</span><br><span class="line"><span class="built_in">cp</span> /root/a /tmpï¼ˆä¸´æ—¶æ–‡ä»¶ï¼‰</span><br><span class="line"></span><br><span class="line">å¸¸ç”¨å‚æ•°</span><br><span class="line">    -r/R é€’å½’å¤åˆ¶ç›®å½•</span><br><span class="line">    -v æ˜¾ç¤ºè¿‡ç¨‹</span><br><span class="line">    -p ä¿ç•™æ–‡ä»¶åŸæœ‰æ›´æ–°æ—¶é—´ï¼ˆå±æ€§ï¼‰</span><br><span class="line">    -a æ—¶é—´æˆ³+æ‰€æœ‰æƒ+å¤åˆ¶è¿æ¥æ–‡ä»¶å±æ€§è€Œéæ¡£æ¡ˆæœ¬èº«    -f å¼ºè¡Œè¦†ç›–    -i è¦†ç›–ä¹‹å‰å…ˆè¡Œæç¤º</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> ç§»åŠ¨æ–‡ä»¶æˆ–è€…é‡å‘½å</span><br><span class="line"><span class="built_in">mv</span> /a /othera</span><br><span class="line"><span class="built_in">mv</span> /a /tmp</span><br><span class="line"><span class="built_in">mv</span> /a /tmp/bï¼ˆç§»åŠ¨+é‡å‘½åï¼‰</span><br><span class="line"></span><br><span class="line">å¸¸ç”¨å‚æ•°</span><br><span class="line">    -i è¦†ç›–æ–‡ä»¶å‰æç¤º</span><br></pre></td></tr></table></figure><h3 id="é€šé…ç¬¦">é€šé…ç¬¦</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å®šä¹‰ï¼š<span class="built_in">shell</span> å†…å»ºçš„ç¬¦å·</span><br><span class="line">ç”¨é€”ï¼šæ“ä½œå¤šä¸ªç›¸ä¼¼ï¼ˆæœ‰ç®€å•è§„å¾‹çš„ï¼‰æ–‡ä»¶</span><br><span class="line">å¸¸ç”¨é€šé…ç¬¦ï¼š</span><br><span class="line">ã€€ã€€* åŒ¹é…ä»»ä½•å­—ç¬¦ä¸²</span><br><span class="line">ã€€ã€€ï¼Ÿ åŒ¹é…<span class="number">1</span>ä¸ªå­—ç¬¦ä¸²</span><br><span class="line">ã€€ã€€[<span class="built_in">xyz</span>] åŒ¹é…<span class="built_in">xyz</span>ä»»æ„ä¸€ä¸ªå­—ç¬¦</span><br><span class="line">ã€€ã€€[a-z] åŒ¹é…ä¸€ä¸ªèŒƒå›´</span><br><span class="line">ã€€ã€€[!<span class="built_in">xyz</span>]æˆ–è€…[^<span class="built_in">xyz</span>] ä¸åŒ¹é…</span><br></pre></td></tr></table></figure><h3 id="æ–‡æœ¬å†…å®¹æŸ¥çœ‹">æ–‡æœ¬å†…å®¹æŸ¥çœ‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> æ–‡æœ¬å†…å®¹æ˜¾ç¤ºåˆ°ç»ˆç«¯</span><br><span class="line">    æ˜¾ç¤ºå…¨éƒ¨</span><br><span class="line"><span class="built_in">head</span> æŸ¥çœ‹æ–‡ä»¶å¼€å¤´</span><br><span class="line">    <span class="built_in">head</span> test.txt  é»˜è®¤æŸ¥çœ‹å‰10è¡Œ</span><br><span class="line">    <span class="built_in">head</span> -5 test.txt </span><br><span class="line"></span><br><span class="line"><span class="built_in">tail</span> æŸ¥çœ‹æ–‡ä»¶ç»“å°¾</span><br><span class="line">    <span class="built_in">tail</span> -1000f catalina.out</span><br><span class="line">    å¸¸ç”¨å‚æ•° </span><br><span class="line">    -f æ–‡ä»¶å†…å®¹æ›´æ–°åï¼Œæ˜¾ç¤ºä¿¡æ¯åŒæ­¥æ›´æ–°</span><br><span class="line"></span><br><span class="line"><span class="built_in">wc</span> ç»Ÿè®¡æ–‡ä»¶å†…å®¹ä¿¡æ¯    </span><br><span class="line">    <span class="built_in">wc</span> -l /tmp/test.txt    æŸ¥çœ‹æ–‡ä»¶æœ‰å¤šå°‘è¡Œ</span><br><span class="line">    -cæˆ–--bytesæˆ–â€”â€”charsï¼šåªæ˜¾ç¤ºBytesæ•°ï¼›</span><br><span class="line">    -læˆ–â€”â€”linesï¼šåªæ˜¾ç¤ºåˆ—æ•°ï¼›</span><br><span class="line">    -wæˆ–â€”â€”wordsï¼šåªæ˜¾ç¤ºå­—æ•°ã€‚</span><br><span class="line">more åˆ†è¡Œæ˜¾ç¤º </span><br><span class="line">less</span><br></pre></td></tr></table></figure><p>Note:å¯ä»¥ä½¿ç”¨tail -f æŸ¥çœ‹æ—¥å¿—å†…å®¹ã€‚</p><h3 id="æ‰“åŒ…å’Œå‹ç¼©">æ‰“åŒ…å’Œå‹ç¼©</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">æœ€æ—©çš„Linuxå¤‡ä»½ä»‹è´¨æ˜¯ç£å¸¦ï¼Œä½¿ç”¨çš„å‘½ä»¤æ˜¯tar</span><br><span class="line">å¯ä»¥æ‰“åŒ…åçš„ç£å¸¦æ–‡ä»¶è¿›è¡Œå‹ç¼©å‚¨å­˜ï¼Œå‹ç¼©çš„å‘½ä»¤æ˜¯ gzip å’Œ bzip2</span><br><span class="line">ç»å¸¸ä½¿ç”¨çš„æ‰©å±•åæ˜¯ <span class="string">.tar.gz</span>  <span class="string">.tar.bz2</span>  <span class="string">.tgz</span></span><br><span class="line">tar æ‰“åŒ…å‘½ä»¤</span><br><span class="line">å¸¸ç”¨å‚æ•°</span><br><span class="line">    c æ‰“åŒ…</span><br><span class="line">    x è§£åŒ…</span><br><span class="line">    f æŒ‡å®šæ“ä½œç±»å‹ä¸ºæ–‡ä»¶    ã€€ã€€ v æ˜¾ç¤ºè¿›åº¦    P ä½¿ç”¨ç»å¯¹è·¯å¾„</span><br><span class="line">æ‰“åŒ…</span><br><span class="line">tar cf <span class="string">/tmp/etc-backup.tar</span> <span class="string">/etc</span>      æŠŠ  <span class="string">/etc</span> è¿™ä¸ªæ–‡ä»¶å¤¹æ‰“åŒ…æ”¾åœ¨<span class="string">/tmp/etc-backup.tar</span>ä¼šæç¤ºï¼Œä½†æ˜¯ä¹Ÿèƒ½æˆåŠŸï¼štar: Removing leading `/&#x27; from member names</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar cPf /tmp/etc-backup.tar /etc      ä½¿ç”¨ç»å¯¹è·¯å¾„ ï¼ˆæ²¡æœ‰æç¤ºï¼‰</span><br><span class="line">tar czf /tmp/etc-backup.tar.gz /etc  ï¼ˆtaré›†æˆäº†gzipå’Œbzip2ï¼‰</span><br><span class="line">tar cjf /tmp/etc-backup.tar.bz2 /etc  ï¼ˆå‹ç¼©æ¯”ä¾‹æ›´é«˜ï¼‰</span><br><span class="line"></span><br><span class="line">è§£åŒ…</span><br><span class="line">tar xf /tmp/etc-backup.tar -C /root  æŠŠ taråŒ…è§£å‹åˆ° /root ç›®å½•ä¸‹</span><br><span class="line">tar zxf /tmp/etc-backup.tar.gz -C /etc</span><br><span class="line">tar zjf /tmp/etc-backup.tar.gz -C /etc</span><br></pre></td></tr></table></figure><h3 id="VI">VI</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">å¤šæ¨¡å¼äº§ç”Ÿçš„åŸå› </span><br><span class="line">å››ç§æ¨¡å¼ï¼š</span><br><span class="line">    æ­£å¸¸æ¨¡å¼ï¼ˆ<span class="title class_">Normal</span>-modeï¼‰</span><br><span class="line">    æ’å…¥æ¨¡å¼ï¼ˆ<span class="title class_">Insert</span>-modeï¼‰</span><br><span class="line">    å‘½ä»¤æ¨¡å¼ï¼ˆ<span class="title class_">Command</span>-modeï¼‰</span><br><span class="line">    å¯è§†æ¨¡å¼ï¼ˆ<span class="title class_">Visual</span>-modeï¼‰</span><br><span class="line"></span><br><span class="line">i è¿›å…¥æ’å…¥æ¨¡å¼</span><br><span class="line">iæ˜¯å½“å‰å…‰æ ‡</span><br><span class="line">Iæ˜¯å…‰æ ‡å½“è¡Œå¼€å¤´</span><br><span class="line">aæ˜¯å…‰æ ‡åä¸€ä½</span><br><span class="line">Aæ˜¯å…‰æ ‡å½“è¡Œç»“å°¾</span><br><span class="line">oä¸‹ä¸€è¡Œï¼Œä¼šäº§ç”Ÿä¸€ä¸ªç©ºè¡Œ</span><br><span class="line">Oä¸Šä¸€è¡Œï¼Œä¼šäº§ç”Ÿä¸€ä¸ªç©ºè¡Œ</span><br><span class="line"></span><br><span class="line">vè¿›å…¥å¯è§†æ¨¡å¼</span><br><span class="line"></span><br><span class="line"><span class="symbol">:</span>è¿›å…¥å‘½ä»¤æ¨¡å¼</span><br><span class="line"></span><br><span class="line">escè¿”å›æ­£å¸¸æ¨¡å¼</span><br><span class="line"></span><br><span class="line">æ­£å¸¸æ¨¡å¼ä¸‹ï¼š</span><br><span class="line">hjklå¯ä»¥æ§åˆ¶ä¸Šä¸‹å·¦å³</span><br><span class="line"></span><br><span class="line">yyè¡¨ç¤ºå¤åˆ¶å½“è¡Œï¼Œpå¯ä»¥ç²˜è´´</span><br><span class="line"><span class="number">3</span>yyè¡¨ç¤ºå¤åˆ¶ä¸‰è¡Œ</span><br><span class="line">y<span class="variable">$ </span>è¡¨ç¤ºå¤åˆ¶ä»å…‰æ ‡åˆ°å½“è¡Œç»“å°¾</span><br><span class="line">dd d<span class="variable">$è¡¨</span>ç¤ºå‰ªåˆ‡</span><br><span class="line"></span><br><span class="line">æ“ä½œé”™è¯¯ï¼Œuå¯ä»¥æ’¤é”€ï¼Œctrl+ré‡åš</span><br><span class="line">xè¡¨ç¤ºåˆ é™¤å½“å‰å…‰æ ‡çš„å­—ç¬¦</span><br><span class="line">rå¯ä»¥æ›¿æ¢å½“å‰å­—ç¬¦</span><br><span class="line"></span><br><span class="line"><span class="symbol">:set</span> nu å¯ä»¥æŸ¥çœ‹ç›®å‰æ˜¯ç¬¬å‡ è¡Œ</span><br><span class="line">æ•°å­— + Gå¯ä»¥åˆ°æ•°å­—å¯¹åº”çš„è¡Œ</span><br><span class="line">gç§»åŠ¨åˆ°ç¬¬ä¸€è¡Œ</span><br><span class="line">Gç§»åŠ¨åˆ°æœ€åä¸€è¡Œ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">^æ¥åˆ°å…‰æ ‡æ‰€åœ¨è¡Œçš„å¼€å¤´ï¼Œ<span class="variable">$æ¥</span>åˆ°å…‰æ ‡æ‰€åœ¨è¡Œçš„ç»“å°¾</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> å‘½ä»¤æ¨¡å¼</span><br><span class="line"><span class="symbol">:w</span> /root/test.txt   æ–‡ä»¶æ–°å»ºçš„ï¼Œå¯ä»¥ä¿å­˜ä¸€ä¸ªæ–°æ–‡ä»¶</span><br><span class="line"><span class="symbol">:w</span> æ–‡ä»¶å·²ç»å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œä¿å­˜</span><br><span class="line"><span class="symbol">:wq</span> ä¿å­˜é€€å‡º</span><br><span class="line"><span class="symbol">:q!</span> å¼ºåˆ¶é€€å‡º</span><br><span class="line"></span><br><span class="line"><span class="symbol">:</span>! æ‰§è¡Œlinuxå‘½ä»¤ï¼Œçœ‹å®Œåå›è½¦é‡æ–°å›åˆ°vim</span><br><span class="line">/x  æŸ¥æ‰¾xå­—ç¬¦ï¼ŒnæŸ¥æ‰¾ä¸‹ä¸€ä¸ªï¼Œshift+nä¸Šä¸€ä¸ª</span><br><span class="line"><span class="symbol">:s/old/new</span> ç”¨æ–°å­—ç¬¦æ›¿æ¢æ—§å­—ç¬¦ï¼ˆåªæ­£å¯¹å…‰æ ‡æ‰€åœ¨çš„è¡Œï¼‰</span><br><span class="line"><span class="symbol">:%s/old/new</span> ç”¨æ–°å­—ç¬¦æ›¿æ¢æ—§å­—ç¬¦ï¼ˆæ•´ä¸ªæ–‡æœ¬ï¼Œä½†åªæ›¿æ¢ä¸€ä¸ªï¼‰</span><br><span class="line"><span class="symbol">:%s/old/new/g</span> ç”¨æ–°å­—ç¬¦æ›¿æ¢æ—§å­—ç¬¦ï¼ˆæ•´ä¸ªæ–‡æœ¬ï¼Œå…¨éƒ¨æ›¿æ¢ï¼‰</span><br><span class="line"><span class="symbol">:</span><span class="number">3</span>,<span class="number">5</span>s/x/X/g <span class="number">3</span><span class="number">-5</span>è¡Œå†…å…¨éƒ¨æ›¿æ¢ï¼Œæ›¿æ¢ä¸€ä¸ªå°±å»æ‰g</span><br><span class="line"></span><br><span class="line"><span class="symbol">:set</span> nu æ˜¾ç¤ºè¡Œå·</span><br><span class="line"><span class="symbol">:set</span> nonu ä¸æ˜¾ç¤ºè¡Œå·</span><br><span class="line"></span><br><span class="line">ä»¥ä¸Šæ˜¯å•æ¬¡ä¿®æ”¹çš„ï¼Œå¦‚æœè¦ä¿®æ”¹é»˜è®¤é…ç½®</span><br><span class="line">vim /etc/vimrc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¯è§†æ¨¡å¼</span><br><span class="line">ä¸‰ç§è¿›å…¥å¯è§†æ¨¡å¼çš„æ–¹å¼</span><br><span class="line">v å­—ç¬¦å¯è§†æ¨¡å¼</span><br><span class="line">V è¡Œå¯è§†æ¨¡å¼</span><br><span class="line">ctrl + v å—å¯è§†æ¨¡å¼</span><br><span class="line">    é…åˆdå’ŒIï¼ˆå¤§å†™iï¼‰å‘½ä»¤å¯ä»¥è¿›è¡Œå—çš„ä¾¿åˆ©æ“ä½œ</span><br><span class="line"></span><br><span class="line">éœ€è¦åœ¨å—çš„æ‰€æœ‰è¡Œä¹‹å‰åŠ å…¥ä¸€äº›å­—ç¬¦ï¼Œé€‰ä¸­å—ï¼ŒIçš„æ—¶å€™ä¼šåœ¨é€‰ä¸­çš„å—çš„ç¬¬ä¸€è¡Œçš„ç¬¬ä¸€ä¸ªå…‰æ ‡å¤„ï¼Œè¾“å…¥å­—ç¬¦ï¼Œè¿ç»­ä¸¤æ¬¡escã€‚</span><br><span class="line">é€‰ä¸­å—ï¼Œdï¼Œç„¶åé€‰ä¸­çš„å—å°±ä¼šè¢«åˆ é™¤</span><br></pre></td></tr></table></figure><h3 id="ç”¨æˆ·ä¸æƒé™ç®¡ç†">ç”¨æˆ·ä¸æƒé™ç®¡ç†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">useradd æ–°å»ºç”¨æˆ·</span><br><span class="line">    useradd dongyeï¼ˆå¯ä»¥ç”¨ <span class="built_in">id</span> dongye æ¥éªŒè¯æ˜¯å¦å­˜åœ¨ï¼‰</span><br><span class="line">    åˆ›å»ºä¸€ä¸ªç”¨æˆ·åï¼Œè‡ªåŠ¨åœ¨ /homeå»ºç«‹å®¶ç›®å½•ï¼Œå¹¶ä¸”åˆ›å»ºä¸€äº›éšè—æ–‡ä»¶ã€‚åŒæ—¶ï¼Œåœ¨ /etc/passwd è¿™ä¸ªæ–‡ä»¶é‡Œä¼šåŠ å…¥æ–°ç”¨æˆ·dongyeçš„æ•°æ®ï¼Œ/etc/shadowé‡Œé¢ä¹Ÿæœ‰ä¼šç›¸å…³æ•°æ®ï¼ˆå¯†ç ç›¸å…³ï¼‰ã€‚å¦‚æœæ²¡æœ‰ç»„çš„è¯ï¼Œåˆ›å»ºä¸€ä¸ªåŒåçš„ç»„ã€‚</span><br><span class="line">userdel åˆ é™¤ç”¨æˆ·</span><br><span class="line">    userdel dongye</span><br><span class="line">    userdel -r dongye åŒæ—¶åˆ é™¤å®¶ç›®å½•</span><br><span class="line">passwd ä¿®æ”¹ç”¨æˆ·å¯†ç </span><br><span class="line">    passwd dongye</span><br><span class="line">    passwdæ›´æ”¹å½“å‰ç”¨æˆ·å¯†ç </span><br><span class="line">    /etc/passwd å’Œ /etc/shadow é‡Œé¢çš„æ•°æ®ä¹Ÿè¢«åˆ é™¤</span><br><span class="line">usermod ä¿®æ”¹ä¸€ä¸ªç”¨æˆ·è´¦æˆ·</span><br><span class="line">    usermod -d /home/other dongye  å®¶ç›®å½•ä» /home/dongye æ”¹æˆ /home/other</span><br><span class="line">chage ä¿®æ”¹ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸ    è®¾ç½®ç”¨æˆ·å¯†ç çš„è¿‡æœŸæ—¶é—´ï¼Œç”šè‡³ç”¨æˆ·æœ¬èº«çš„è¿‡æœŸæ—¶é—´</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>å¥‡æ€ªçš„ç°è±¡</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@penge-<span class="keyword">virtual</span>-machine:/home<span class="meta"># useradd test</span></span><br><span class="line">root@penge-<span class="keyword">virtual</span>-machine:/home<span class="meta"># ls</span></span><br><span class="line">penge</span><br></pre></td></tr></table></figure><p><strong>GPTè§£ç­”</strong></p><p>åœ¨Linuxä¸­ï¼Œå½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·æ—¶ï¼Œç³»ç»Ÿä¼šé»˜è®¤åœ¨ <code>/home</code> ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¸ç”¨æˆ·ååŒåçš„å®¶ç›®å½•ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>useradd</code> å‘½ä»¤æ¥åˆ›å»ºæ–°ç”¨æˆ·ã€‚ä¸‹é¢æ˜¯ä¸€äº›ç¤ºä¾‹ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·å¹¶æŒ‡å®šå®¶ç›®å½•ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -m username</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>-m</code> é€‰é¡¹è¡¨ç¤ºåˆ›å»ºå®¶ç›®å½•ã€‚</p><ul><li>å¦‚æœä½ æƒ³æŒ‡å®šå®¶ç›®å½•çš„è·¯å¾„ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>-d</code> é€‰é¡¹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -m -d /home/custom_directory username</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œ<code>-d</code> é€‰é¡¹åé¢è·Ÿçš„æ˜¯ä½ æƒ³è¦è®¾å®šçš„å®¶ç›®å½•çš„è·¯å¾„ã€‚</p><ul><li>è®°å¾—ï¼Œåˆ›å»ºæ–°ç”¨æˆ·åï¼Œä½ éœ€è¦ä¸ºæ–°ç”¨æˆ·è®¾ç½®å¯†ç ï¼Œè¿™æ ·æ–°ç”¨æˆ·æ‰èƒ½ç™»å½•ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>passwd</code> å‘½ä»¤æ¥è®¾ç½®å¯†ç ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd username</span><br></pre></td></tr></table></figure><p>ä¸è¿‡è¯·æ³¨æ„ï¼Œè¿™äº›æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œæ‰€ä»¥åœ¨å‘½ä»¤å‰å¯èƒ½éœ€è¦åŠ ä¸Š <code>sudo</code>ã€‚</p><p>å¦‚æœä½ å·²ç»åˆ›å»ºäº†ç”¨æˆ·ä½†å¿˜è®°äº†è®¾ç½®å®¶ç›®å½•ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>usermod</code> å‘½ä»¤æ¥ä¿®æ”¹ç”¨æˆ·çš„å®¶ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -d /home/new_directory username</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œ<code>-d</code> é€‰é¡¹åé¢è·Ÿçš„æ˜¯ä½ æƒ³è¦è®¾å®šçš„æ–°çš„å®¶ç›®å½•çš„è·¯å¾„ã€‚</p><p><strong>ä½¿ç”¨<code>/etc/passwd</code>æŸ¥çœ‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">root@penge-virtual-machine:/home<span class="comment"># cat /etc/passwd</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line"><span class="built_in">sync</span>:x:4:65534:<span class="built_in">sync</span>:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">messagebus:x:103:106::/nonexistent:/usr/sbin/nologin</span><br><span class="line">syslog:x:104:110::/home/syslog:/usr/sbin/nologin</span><br><span class="line">_apt:x:105:65534::/nonexistent:/usr/sbin/nologin</span><br><span class="line">tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false</span><br><span class="line">uuidd:x:107:114::/run/uuidd:/usr/sbin/nologin</span><br><span class="line">tcpdump:x:108:115::/nonexistent:/usr/sbin/nologin</span><br><span class="line">avahi-autoipd:x:109:116:Avahi autoip daemon,,,:/var/lib/avahi-autoipd:/usr/sbin/nologin</span><br><span class="line">usbmux:x:110:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin</span><br><span class="line">rtkit:x:111:117:RealtimeKit,,,:/proc:/usr/sbin/nologin</span><br><span class="line">dnsmasq:x:112:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin</span><br><span class="line">cups-pk-helper:x:113:120:user <span class="keyword">for</span> cups-pk-helper service,,,:/home/cups-pk-helper:/usr/sbin/nologin</span><br><span class="line">speech-dispatcher:x:114:29:Speech Dispatcher,,,:/run/speech-dispatcher:/bin/false</span><br><span class="line">avahi:x:115:121:Avahi mDNS daemon,,,:/var/run/avahi-daemon:/usr/sbin/nologin</span><br><span class="line">kernoops:x:116:65534:Kernel Oops Tracking Daemon,,,:/:/usr/sbin/nologin</span><br><span class="line">saned:x:117:123::/var/lib/saned:/usr/sbin/nologin</span><br><span class="line">nm-openvpn:x:118:124:NetworkManager OpenVPN,,,:/var/lib/openvpn/chroot:/usr/sbin/nologin</span><br><span class="line">hplip:x:119:7:HPLIP system user,,,:/run/hplip:/bin/false</span><br><span class="line">whoopsie:x:120:125::/nonexistent:/bin/false</span><br><span class="line">colord:x:121:126:colord colour management daemon,,,:/var/lib/colord:/usr/sbin/nologin</span><br><span class="line">geoclue:x:122:127::/var/lib/geoclue:/usr/sbin/nologin</span><br><span class="line">pulse:x:123:128:PulseAudio daemon,,,:/var/run/pulse:/usr/sbin/nologin</span><br><span class="line">gnome-initial-setup:x:124:65534::/run/gnome-initial-setup/:/bin/false</span><br><span class="line">gdm:x:125:130:Gnome Display Manager:/var/lib/gdm3:/bin/false</span><br><span class="line">sssd:x:126:131:SSSD system user,,,:/var/lib/sss:/usr/sbin/nologin</span><br><span class="line">penge:x:1000:1000:penge,,,:/home/penge:/usr/bin/zsh</span><br><span class="line">systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin</span><br><span class="line">sshd:x:127:65534::/run/sshd:/usr/sbin/nologin</span><br><span class="line">fwupd-refresh:x:128:135:fwupd-refresh user,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">mysql:x:129:137:MySQL Server,,,:/nonexistent:/bin/false</span><br><span class="line"><span class="built_in">test</span>:x:1001:1002::/home/test:/bin/sh</span><br></pre></td></tr></table></figure><p><strong>id test</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@penge-virtual-machine:/home<span class="comment"># id test</span></span><br><span class="line">uid=1001(<span class="built_in">test</span>) gid=1002(<span class="built_in">test</span>) <span class="built_in">groups</span>=1002(<span class="built_in">test</span>)</span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="selector-attr">[-gGnru]</span><span class="selector-attr">[--help]</span><span class="selector-attr">[--version]</span><span class="selector-attr">[ç”¨æˆ·åç§°]</span></span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜</strong>ï¼š</p><ul><li>-g æˆ– --group ã€€æ˜¾ç¤ºç”¨æˆ·æ‰€å±ç¾¤ç»„çš„IDã€‚</li><li>-G æˆ– --groups ã€€æ˜¾ç¤ºç”¨æˆ·æ‰€å±é™„åŠ ç¾¤ç»„çš„IDã€‚</li><li>-n æˆ– --name ã€€æ˜¾ç¤ºç”¨æˆ·ï¼Œæ‰€å±ç¾¤ç»„æˆ–é™„åŠ ç¾¤ç»„çš„åç§°ã€‚</li><li>-r æˆ– --real ã€€æ˜¾ç¤ºå®é™…IDã€‚</li><li>-u æˆ– --user ã€€æ˜¾ç¤ºç”¨æˆ·IDã€‚</li><li>-help ã€€æ˜¾ç¤ºå¸®åŠ©ã€‚</li><li>-version ã€€æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ã€‚</li></ul><h3 id="ç»„ç®¡ç†å‘½ä»¤">ç»„ç®¡ç†å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">groupadd æ–°å»ºç”¨æˆ·ç»„</span><br><span class="line">    groupadd group1</span><br><span class="line">    useradd user1</span><br><span class="line">    usermod -g group1 user1 æŠŠuser1è¿™ä¸ªç”¨æˆ·çš„ç»„æ”¹æˆgroup1</span><br><span class="line">    useradd -g group1 user2 æ–°å»ºç”¨æˆ·user2æ—¶å°±æŠŠå®ƒæ”¾åˆ°group1ç»„ä¸‹</span><br><span class="line">groupdel åˆ é™¤ç”¨æˆ·ç»„    groupdel group1 åˆ é™¤ç»„group1</span><br></pre></td></tr></table></figure><h3 id="ç”¨æˆ·åˆ‡æ¢">ç”¨æˆ·åˆ‡æ¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">su åˆ‡æ¢ç”¨æˆ·</span><br><span class="line">    su - USERNAME ä½¿ç”¨ login shell æ–¹å¼åˆ‡æ¢ç”¨æˆ·</span><br><span class="line">    su USERNAME ä¸å®Œå…¨åˆ‡æ¢ï¼Œæ¯”å¦‚è¿˜æ˜¯åœ¨ /rootä¸‹è€Œä¸ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç”¨æˆ·å®¶ç›®å½•</span><br><span class="line"></span><br><span class="line">sudo ä»¥å…¶ä»–ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤</span><br><span class="line">    visudo è®¾ç½®éœ€è¦ä½¿ç”¨sudoçš„ç”¨æˆ·ï¼ˆç»„ï¼‰ã€‚ä¸‹å›¾è®¾ç½® user3ç”¨æˆ·æ‹¥æœ‰shutdown -cæƒé™ï¼Œéœ€è¦è¾“å…¥ user3è‡ªå·±çš„å¯†ç </span><br></pre></td></tr></table></figure><p><strong>suå’Œsudoçš„åŒºåˆ«</strong></p><p><code>su</code>å’Œ<code>sudo</code>éƒ½æ˜¯Linuxç³»ç»Ÿä¸­ç”¨äºæƒé™ç®¡ç†çš„å‘½ä»¤ï¼Œå®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºä½¿ç”¨æ–¹å¼å’Œæƒé™æ§åˆ¶ï¼š</p><ul><li><code>su</code>å‘½ä»¤ï¼š<code>su</code>æ˜¯â€œSwitch Userâ€çš„ç¼©å†™ï¼Œä¸»è¦ç”¨äºåˆ‡æ¢åˆ°å…¶ä»–ç”¨æˆ·ã€‚å½“ä½ è¾“å…¥<code>su</code>å‘½ä»¤åï¼Œç³»ç»Ÿä¼šæç¤ºä½ è¾“å…¥ç›®æ ‡ç”¨æˆ·çš„å¯†ç ï¼Œè¾“å…¥æ­£ç¡®åï¼Œä½ å°±åˆ‡æ¢åˆ°äº†é‚£ä¸ªç”¨æˆ·ï¼Œæ‹¥æœ‰äº†é‚£ä¸ªç”¨æˆ·çš„å…¨éƒ¨æƒé™ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šç”¨æˆ·åï¼Œé‚£ä¹ˆé»˜è®¤åˆ‡æ¢åˆ°rootç”¨æˆ·ã€‚</li><li><code>sudo</code>å‘½ä»¤ï¼š<code>sudo</code>æ˜¯â€œSuper User DOâ€çš„ç¼©å†™ï¼Œä¸»è¦ç”¨äºä¸´æ—¶è·å–rootæƒé™ã€‚å½“ä½ åœ¨å‘½ä»¤å‰åŠ ä¸Š<code>sudo</code>åï¼Œé‚£ä¸ªå‘½ä»¤å°±ä¼šä»¥rootç”¨æˆ·çš„èº«ä»½è¿è¡Œï¼Œä½†ä¹‹åçš„æ“ä½œè¿˜æ˜¯ä»¥æ™®é€šç”¨æˆ·çš„èº«ä»½è¿›è¡Œã€‚ä½¿ç”¨<code>sudo</code>éœ€è¦è¾“å…¥å½“å‰ç”¨æˆ·çš„å¯†ç ï¼Œå¹¶ä¸”å½“å‰ç”¨æˆ·éœ€è¦åœ¨sudoersæ–‡ä»¶ä¸­ï¼ˆä¸€èˆ¬ä½äº/etc/sudoersï¼‰ã€‚</li></ul><p>æ€»çš„æ¥è¯´ï¼Œ<code>su</code>æ˜¯åˆ‡æ¢åˆ°å…¶ä»–ç”¨æˆ·ï¼Œæ‹¥æœ‰ç›®æ ‡ç”¨æˆ·çš„å…¨éƒ¨æƒé™ï¼›è€Œ<code>sudo</code>åˆ™æ˜¯ä¸´æ—¶è·å–rootæƒé™ï¼Œæ‰§è¡Œå®Œå‘½ä»¤åä»ç„¶ä¿æŒåŸç”¨æˆ·èº«ä»½ã€‚ä½¿ç”¨å“ªä¸ªå‘½ä»¤ä¸»è¦å–å†³äºä½ çš„éœ€æ±‚ï¼Œå¦‚æœä½ éœ€è¦è¿ç»­æ‰§è¡Œå¤šæ¡éœ€è¦rootæƒé™çš„å‘½ä»¤ï¼Œå¯èƒ½ä½¿ç”¨<code>su</code>åˆ‡æ¢åˆ°rootç”¨æˆ·ä¼šæ›´æ–¹ä¾¿ï¼›å¦‚æœä½ åªæ˜¯ä¸´æ—¶éœ€è¦æ‰§è¡Œä¸€æ¡éœ€è¦rootæƒé™çš„å‘½ä»¤ï¼Œé‚£ä¹ˆä½¿ç”¨<code>sudo</code>å¯èƒ½æ›´å®‰å…¨ï¼Œæ›´ç¬¦åˆæƒé™æœ€å°åŒ–çš„åŸåˆ™ã€‚</p><h3 id="ç”¨æˆ·å’Œç”¨æˆ·ç»„çš„é…ç½®æ–‡ä»¶ä»‹ç»">ç”¨æˆ·å’Œç”¨æˆ·ç»„çš„é…ç½®æ–‡ä»¶ä»‹ç»</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/etc/passwd ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼Œ7ä¸ªå­—æ®µ</span><br><span class="line"></span><br><span class="line">user3:x:1003:1003::/home/user3:bin/bash</span><br><span class="line">user3ï¼šç”¨æˆ·åç§°</span><br><span class="line">xï¼šæ˜¯å¦éœ€è¦å¯†ç éªŒè¯ï¼Œxè¡¨ç¤ºéœ€è¦ï¼Œç©ºè¡¨ç¤ºä¸éœ€è¦</span><br><span class="line">1003ï¼šç”¨æˆ·çš„uidï¼Œç”¨æˆ·çš„<span class="built_in">id</span>ä¿¡æ¯ï¼Œå”¯ä¸€è¯†åˆ«ç”¨æˆ·çš„æ ‡è¯†ã€‚rootæ˜¯0ã€‚</span><br><span class="line">1003ï¼šç”¨æˆ·çš„gidï¼Œè¡¨ç¤ºç»„<span class="built_in">id</span>ä¿¡æ¯</span><br><span class="line">ç¬¬äº”ä¸ªå­—æ®µï¼šæ³¨é‡Š</span><br><span class="line">/home/user3ï¼šå®¶ç›®å½•</span><br><span class="line">/bin/bashï¼šç”¨æˆ·ç™»å½•åçš„å‘½ä»¤è§£é‡Šå™¨ã€‚/sbin/nologin è¡¨ç¤ºä¸èƒ½ç™»å½•</span><br><span class="line"></span><br><span class="line">/etc/shadow ä¿å­˜ç”¨æˆ·å’Œç”¨æˆ·å¯†ç ç›¸å…³ä¿¡æ¯çš„</span><br><span class="line">ç¬¬ä¸€ä¸ªå­—æ®µï¼šç”¨æˆ·åç§°</span><br><span class="line">ç¬¬äºŒä¸ªå­—æ®µï¼šç”¨æˆ·åŠ å¯†è¿‡åçš„å¯†ç ï¼ˆçœ‹åˆ°ä¹Ÿæ²¡ç”¨ï¼Œç»è¿‡å¤„ç†ï¼Œå³ä½¿ç›¸åŒçš„å¯†ç ä¹Ÿä¼šæ˜¾ç¤ºä¸åŒï¼‰</span><br><span class="line"></span><br><span class="line">/etc/group ç”¨æˆ·ç»„ç›¸å…³çš„é…ç½®æ–‡ä»¶ï¼Œ4ä¸ªå­—æ®µ</span><br><span class="line">group:x:10:another</span><br><span class="line">groupï¼šç»„çš„åç§°</span><br><span class="line">xï¼šæ˜¯å¦éœ€è¦å¯†ç éªŒè¯</span><br><span class="line">10ï¼šgid</span><br><span class="line">anotherï¼šå…¶ä»–ç»„è®¾ç½®ï¼Œè¯´æ˜anotherè¿™ä¸ªç”¨æˆ·çš„ç¬¬äºŒä¸ªç»„æ˜¯groupæ¯”å¦‚è¾“å…¥ <span class="built_in">id</span> user1uid=1001(user1) gid=1001(group1) ç»„=1001(group1)<span class="built_in">id</span> anotheruid=1002(another) gid=1002(another) ç»„=1003(group)  æŸ¥æ‰¾anotherä¿¡æ¯ï¼Œå‘ç°ä»–çš„ç¬¬äºŒä¸ªç»„æ˜¯group</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶ä¸ç›®å½•æƒé™è¡¨ç¤ºæ–¹æ³•">æ–‡ä»¶ä¸ç›®å½•æƒé™è¡¨ç¤ºæ–¹æ³•</h3><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240509110036508.png" alt="image-20240509110036508"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">æ–‡ä»¶ç±»å‹</span><br><span class="line">-    æ™®é€šæ–‡ä»¶</span><br><span class="line">d   ç›®å½•æ–‡ä»¶</span><br><span class="line">b   å—ç‰¹æ®Šæ–‡ä»¶</span><br><span class="line">c   å­—ç¬¦ç‰¹æ®Šæ–‡ä»¶</span><br><span class="line">l    ç¬¦å·é“¾æ¥</span><br><span class="line">f    å‘½åç®¡é“</span><br><span class="line">s    å¥—æ¥å­—æ–‡ä»¶</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ–‡ä»¶æƒé™çš„è¡¨ç¤ºæ–¹æ³•</span><br><span class="line"></span><br><span class="line">    å­—ç¬¦æƒé™è¡¨ç¤ºæ–¹æ³•</span><br><span class="line">    r    è¯»</span><br><span class="line">    w    å†™</span><br><span class="line">    x    æ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">    æ•°å­—æƒé™çš„è¡¨ç¤ºæ–¹æ³•</span><br><span class="line">    r=4</span><br><span class="line">    w=2</span><br><span class="line">    x=1</span><br><span class="line"></span><br><span class="line">æ–‡ä»¶æƒé™çš„è¡¨ç¤ºæ–¹æ³•</span><br><span class="line">rwxrwxrwx</span><br><span class="line">ç¬¬ä¸€ä¸ªè¡¨ç¤ºæ–‡ä»¶å±ä¸»çš„æƒé™ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºæ–‡ä»¶å±ç»„çš„æƒé™ï¼Œç¬¬ä¸‰ä¸ªè¡¨ç¤ºå…¶ä»–ç”¨æˆ·çš„æƒé™</span><br><span class="line"></span><br><span class="line">åˆ›å»ºæ–°æ–‡ä»¶æœ‰é»˜è®¤æƒé™ï¼Œæ ¹æ®<span class="built_in">umask</span>å€¼è®¡ç®—ï¼Œå±ä¸»å’Œå±ç»„æ ¹æ®å½“å‰è¿›ç¨‹çš„ç”¨æˆ·æ¥è®¾å®š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç›®å½•æƒé™çš„æ ‡è¯†æ–¹æ³•</span><br><span class="line">x    è¿›å…¥ç›®å½•</span><br><span class="line">rx   æ˜¾ç¤ºç›®å½•å†…çš„æ–‡ä»¶å</span><br><span class="line">wx  ä¿®æ”¹ç›®å½•å†…çš„æ–‡ä»¶å</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶æƒé™çš„ä¿®æ”¹æ–¹æ³•å’Œæ•°å­—è¡¨ç¤ºæ–¹æ³•">æ–‡ä»¶æƒé™çš„ä¿®æ”¹æ–¹æ³•å’Œæ•°å­—è¡¨ç¤ºæ–¹æ³•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ä¿®æ”¹æƒé™å‘½ä»¤(æµ‹è¯•çš„æ—¶å€™åˆ«ç”¨rootï¼Œrootä¸å—é™åˆ¶ï¼‰</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span>    ä¿®æ”¹æ–‡ä»¶ã€ç›®å½•æƒé™</span><br><span class="line">    <span class="built_in">chmod</span> u+x /tmp/testfile    uè¡¨ç¤ºå±ä¸»</span><br><span class="line">    <span class="built_in">chmod</span> u=rwx /tmp/testfile  </span><br><span class="line">    <span class="built_in">chmod</span> g-r  /tmp/testfile   gè¡¨ç¤ºå±ç»„</span><br><span class="line">    <span class="built_in">chmod</span> 0-r /tmp/testfile    oè¡¨ç¤ºå…¶ä»–ç”¨æˆ·</span><br><span class="line">    <span class="built_in">chmod</span> a+r /tmp/testfile   aè¡¨ç¤ºæ‰€æœ‰</span><br><span class="line">    <span class="built_in">chmod</span> 755 /tmp/testfileå¦‚æœå±ä¸»æ²¡æœ‰æƒé™ï¼Œæ‰€å±çš„ç»„æœ‰æƒé™ï¼Œä»¥å±ä¸»ä¸ºå‡†ï¼Œè¿˜æ˜¯æ²¡æœ‰æƒé™ã€‚</span><br><span class="line"><span class="built_in">chown</span>    æ›´æ”¹å±ä¸»ã€å±ç»„</span><br><span class="line">    <span class="built_in">chown</span> user1 /test   æŠŠ<span class="built_in">test</span>è¿™ä¸ªç›®å½•çš„å±ä¸»æ”¹æˆuser1</span><br><span class="line">    <span class="built_in">chown</span> :group /test   æŠŠ<span class="built_in">test</span>è¿™ä¸ªç›®å½•çš„å±ç»„ç»™æˆgroup    <span class="built_in">chown</span> user1:group /test   ä¸€èµ·ä¿®æ”¹</span><br><span class="line"><span class="built_in">chgrp</span>    å¯ä»¥å•ç‹¬æ›´æ”¹å±ç»„ã€ä¸å¸¸ç”¨</span><br><span class="line"></span><br><span class="line">linuxä¸€èˆ¬åˆ›å»ºä¸€ä¸ªæ–‡ä»¶é»˜è®¤ä¼šèµ‹äºˆ666æƒé™ï¼Œç„¶åæ ¹æ®ç”¨çš„<span class="built_in">umask</span>å€¼æ¥è®¡ç®—ã€‚</span><br><span class="line">ç”¨æˆ·é»˜è®¤<span class="built_in">umask</span>å€¼ä¸º022ï¼Œæ‰€ä»¥ä¸€èˆ¬æ˜¯ 666-022=644ï¼Œå¯¹åº”rw-r--r--</span><br></pre></td></tr></table></figure><h3 id="ç‰¹æ®Šæƒé™">ç‰¹æ®Šæƒé™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SUID  ç”¨äºäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰§è¡Œå‘½ä»¤æ—¶å–å¾—æ–‡ä»¶å±ä¸»æƒé™</span><br><span class="line">    å¦‚ï¼Œ/usr/bin/passwd</span><br><span class="line"></span><br><span class="line">SGID  ç”¨äºç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºæ–°çš„æ–‡ä»¶å’Œç›®å½•ï¼Œæƒé™è‡ªåŠ¨æ›´æ”¹ä¸ºè¯¥ç›®å½•çš„å±ç»„</span><br><span class="line">    æ–‡ä»¶å…±äº«æ—¶ä½¿ç”¨</span><br><span class="line">SBIT  ç”¨äºç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹æ–°å»ºçš„æ–‡ä»¶å’Œç›®å½•ï¼Œä»…rootå’Œè‡ªå·±å¯ä»¥åˆ é™¤</span><br><span class="line">    å¦‚ /tmp</span><br></pre></td></tr></table></figure><h2 id="ç½‘ç»œç®¡ç†">ç½‘ç»œç®¡ç†</h2><p><strong>ç½‘å¡ä»‹ç»</strong></p><p>ç½‘å¡ï¼Œä¹Ÿè¢«ç§°ä¸ºç½‘ç»œæ¥å£å¡ï¼ˆNetwork Interface Cardï¼ŒNICï¼‰ï¼Œæ˜¯ä¸€ç§ç¡¬ä»¶è®¾å¤‡ï¼Œå®ƒå…è®¸è®¡ç®—æœºé€šè¿‡ç½‘ç»œä¸å…¶ä»–è®¡ç®—æœºè¿›è¡Œè¿æ¥å’Œé€šä¿¡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç½‘å¡è¢«å®‰è£…åœ¨è®¡ç®—æœºæˆ–å…¶ä»–ç½‘ç»œè®¾å¤‡çš„æ‰©å±•æ’æ§½ä¸­ã€‚</p><p>ç½‘å¡çš„ä¸»è¦å·¥ä½œæ˜¯å°†æ•°æ®åŒ…å‘é€å’Œæ¥æ”¶åˆ°ç½‘ç»œä¸Šã€‚å®ƒæŠŠè®¡ç®—æœºä¸­çš„æ•°å­—ä¿¡æ¯è½¬åŒ–ä¸ºå¯ä»¥åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„ä¿¡å·ï¼ŒåŒæ—¶ä¹Ÿèƒ½æŠŠç½‘ç»œä¸Šçš„ä¿¡å·è½¬åŒ–ä¸ºè®¡ç®—æœºå¯ä»¥ç†è§£çš„æ•°å­—ä¿¡æ¯ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºâ€œè°ƒåˆ¶â€å’Œâ€œè§£è°ƒâ€ã€‚</p><p>æ¯ä¸ªç½‘å¡éƒ½æœ‰ä¸€ä¸ªå…¨çƒå”¯ä¸€çš„ç‰©ç†åœ°å€ï¼Œä¹Ÿå«ä½œMACåœ°å€ã€‚è¿™ä¸ªåœ°å€åœ¨ç½‘å¡ç”Ÿäº§æ—¶è¢«å‚å®¶å†™å…¥ï¼Œç”¨äºåœ¨ç½‘ç»œä¸Šå”¯ä¸€æ ‡è¯†è¿™ä¸ªç½‘å¡ã€‚</p><p>ç½‘å¡å¯ä»¥æŒ‰ç…§è¿æ¥æ–¹å¼åˆ†ç±»ï¼Œæœ‰æœ‰çº¿ç½‘å¡å’Œæ— çº¿ç½‘å¡ä¸¤ç§ã€‚æœ‰çº¿ç½‘å¡ä¸€èˆ¬ä½¿ç”¨ä»¥å¤ªç½‘çº¿ç¼†ï¼ˆEthernet Cableï¼‰è¿›è¡Œè¿æ¥ï¼Œè€Œæ— çº¿ç½‘å¡åˆ™ä½¿ç”¨æ— çº¿ä¿¡å·ï¼Œå¦‚Wi-Fiè¿›è¡Œè¿æ¥ã€‚</p><h3 id="ç½‘ç»œçŠ¶æ€æŸ¥çœ‹">ç½‘ç»œçŠ¶æ€æŸ¥çœ‹</h3><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span>-tools VS iproute</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. <span class="built_in">net</span>-tools</span><br><span class="line">    ifconfig</span><br><span class="line">    route</span><br><span class="line">    netstat</span><br><span class="line">    </span><br><span class="line"><span class="number">2</span>. iproute2</span><br><span class="line">    ip</span><br><span class="line">    ss</span><br></pre></td></tr></table></figure><p>ç½‘å¡åç§°</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">ifconfig</span>æŸ¥çœ‹ç½‘å¡åç§°</span><br><span class="line">        Â· <span class="variable">eth0</span> ç¬¬ä¸€å—ç½‘å¡ï¼ˆç½‘ç»œæ¥å£ï¼‰</span><br><span class="line">        Â· ä½ çš„ç¬¬ä¸€ä¸ªç½‘ç»œæ¥å£å¯èƒ½å«åšä¸‹é¢çš„åå­—</span><br><span class="line">            Â· <span class="variable">eno1</span> æ¿è½½ç½‘å¡</span><br><span class="line">            Â· <span class="variable">ens33</span> <span class="variable">PCI</span><span class="operator">-</span><span class="built_in">E</span>ç½‘å¡</span><br><span class="line">            Â· <span class="variable">enp0s3</span> æ— æ³•è·å–ç‰©ç†ä¿¡æ¯çš„ <span class="variable">PCI</span><span class="operator">-</span><span class="built_in">E</span> ç½‘å¡</span><br><span class="line">            Â· <span class="variable">CentOS7</span>ä½¿ç”¨äº†ä¸€è‡´æ€§ç½‘ç»œè®¾å¤‡å‘½åï¼Œä»¥ä¸Šéƒ½ä¸åŒ¹é…åˆ™ä½¿ç”¨<span class="variable">eth0</span></span><br></pre></td></tr></table></figure><p>PCI-Eç½‘å¡ï¼š</p><p>PCI-Eç½‘å¡æ˜¯ä¸€ç§ä½¿ç”¨PCI Expressæ¥å£çš„ç½‘ç»œé€‚é…å™¨ï¼Œå®ƒæ˜¯è®¡ç®—æœºç¡¬ä»¶çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè´Ÿè´£å¤„ç†è®¡ç®—æœºçš„ç½‘ç»œè¿æ¥ã€‚ä»¥ä¸‹æ˜¯å…³äºPCI-Eç½‘å¡çš„ä¸€äº›é‡ç‚¹ä»‹ç»ï¼š</p><ol><li><strong>é«˜é€Ÿæ€§èƒ½</strong>ï¼šPCI Expressæ¥å£ï¼ˆä¹Ÿè¢«ç§°ä¸ºPCI-Eæˆ–PCIeï¼‰æ˜¯ä¸€ç§é«˜é€Ÿç¡¬ä»¶æ¥å£ï¼Œå®ƒæä¾›äº†æ¯”ä¼ ç»Ÿçš„PCIæ¥å£æ›´å¿«çš„æ•°æ®ä¼ è¾“é€Ÿç‡ã€‚è¿™ä½¿å¾—PCI-Eç½‘å¡åœ¨å¤„ç†å¤§é‡æ•°æ®æµæ—¶ï¼Œå¦‚è§†é¢‘æµæˆ–å¤§å‹æ–‡ä»¶ä¼ è¾“ç­‰åœºæ™¯ï¼Œè¡¨ç°å‡ºæ›´å¥½çš„æ€§èƒ½ã€‚</li><li><strong>å‘ä¸‹å…¼å®¹</strong>ï¼šPCI-Eç½‘å¡å¯ä»¥åœ¨æ‰€æœ‰æ”¯æŒPCI-Eæ¥å£çš„ä¸»æ¿ä¸Šä½¿ç”¨ï¼Œæ— è®ºå…¶å®ƒç¡¬ä»¶æ¥å£ç‰ˆæœ¬å¦‚ä½•ã€‚è¿™ä½¿å¾—PCI-Eç½‘å¡åœ¨å¤šç§ç³»ç»Ÿé…ç½®ä¸­å…·æœ‰å¾ˆå¥½çš„å…¼å®¹æ€§ã€‚</li><li><strong>æ˜“äºå‡çº§</strong>ï¼šç”±äºPCI-Eæ¥å£é‡‡ç”¨ä¸²è¡Œè¿æ¥æ–¹å¼ï¼Œå®ƒå¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡å¢åŠ ä¿¡é“æ•°é‡æ¥æå‡å¸¦å®½ï¼Œå› æ­¤ï¼ŒPCI-Eç½‘å¡åœ¨æœªæ¥çš„å‡çº§ä¸­å…·æœ‰å¾ˆå¤§çš„æ½œåŠ›ã€‚</li><li><strong>å¤šç§å½¢å¼</strong>ï¼šPCI-Eç½‘å¡æœ‰å¤šç§å½¢å¼ï¼ŒåŒ…æ‹¬å°å¼æœºç½‘å¡ã€ä¾¿æºå¼ç½‘å¡ã€æ— çº¿ç½‘å¡ç­‰ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒç”¨æˆ·çš„éœ€æ±‚ã€‚</li></ol><p>è¯·æ³¨æ„ï¼Œè™½ç„¶PCI-Eç½‘å¡å…·æœ‰è®¸å¤šä¼˜ç‚¹ï¼Œä½†å®ƒå¯èƒ½ä¸é€‚åˆæ‰€æœ‰çš„åº”ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€äº›åªéœ€è¦åŸºæœ¬ç½‘ç»œè¿æ¥åŠŸèƒ½çš„ç”¨æˆ·ï¼Œæ›´ä¾¿å®œã€æ›´ç®€å•çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆå¯èƒ½æ›´åˆé€‚ã€‚</p><p>ifconfigçœ‹çœ‹</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">eno1</span>: flags=<span class="number">4099</span>&lt;UP,BROADCAST,MULTICAST&gt;  mtu <span class="number">1500</span></span><br><span class="line">        <span class="attribute">ether</span> <span class="number">9</span>c:c2:c4:<span class="number">04</span>:<span class="number">8</span>a:<span class="number">78</span>  txqueuelen <span class="number">1000</span>  (ä»¥å¤ªç½‘)</span><br><span class="line">        <span class="attribute">RX</span> packets <span class="number">0</span>  bytes <span class="number">0</span> (<span class="number">0</span>.<span class="number">0</span> B)</span><br><span class="line">        <span class="attribute">RX</span> errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        <span class="attribute">TX</span> packets <span class="number">0</span>  bytes <span class="number">0</span> (<span class="number">0</span>.<span class="number">0</span> B)</span><br><span class="line">        <span class="attribute">TX</span> errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">eno2</span>: flags=<span class="number">4099</span>&lt;UP,BROADCAST,MULTICAST&gt;  mtu <span class="number">1500</span></span><br><span class="line">        <span class="attribute">ether</span> <span class="number">9</span>c:c2:c4:<span class="number">04</span>:<span class="number">8</span>a:<span class="number">79</span>  txqueuelen <span class="number">1000</span>  (ä»¥å¤ªç½‘)</span><br><span class="line">        <span class="attribute">RX</span> packets <span class="number">0</span>  bytes <span class="number">0</span> (<span class="number">0</span>.<span class="number">0</span> B)</span><br><span class="line">        <span class="attribute">RX</span> errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        <span class="attribute">TX</span> packets <span class="number">0</span>  bytes <span class="number">0</span> (<span class="number">0</span>.<span class="number">0</span> B)</span><br><span class="line">        <span class="attribute">TX</span> errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">eno4</span>: flags=<span class="number">4163</span>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="number">1500</span></span><br><span class="line">        <span class="attribute">inet</span>ã€ç½‘ç»œåœ°å€ã€‘ <span class="number">10.168.157.251</span>  netmaskã€æ©ç ã€‘ <span class="number">255.255.255.0</span>  broadcast <span class="number">10.168.127.255</span></span><br><span class="line">        <span class="attribute">inet6</span> fe80::<span class="number">9</span>ec2:c4ff:fe04:<span class="number">8</span>a7b  prefixlen <span class="number">64</span>  scopeid <span class="number">0</span>x20&lt;link&gt;</span><br><span class="line">        <span class="attribute">ether</span>ã€macåœ°å€ã€‘ <span class="number">9</span>c:c2:c4:<span class="number">04</span>:<span class="number">8</span>a:<span class="number">7</span>b  txqueuelen <span class="number">1000</span>  (ä»¥å¤ªç½‘)</span><br><span class="line">        <span class="attribute">RX</span> packets <span class="number">404748669</span>  bytes <span class="number">62270812330</span> (<span class="number">62</span>.<span class="number">2</span> GB)</span><br><span class="line">        <span class="attribute">RX</span> errors <span class="number">0</span>  dropped <span class="number">45412</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        <span class="attribute">TX</span> packets <span class="number">89401903</span>  bytes <span class="number">29846981462</span> (<span class="number">29</span>.<span class="number">8</span> GB)</span><br><span class="line">        <span class="attribute">TX</span> errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br><span class="line"><span class="attribute">lo</span>: flags=<span class="number">73</span>&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class="number">65536</span></span><br><span class="line">        <span class="attribute">inet</span> <span class="number">127.0.0.1</span>  netmask <span class="number">255.0.0.0</span></span><br><span class="line">        <span class="attribute">inet6</span> ::<span class="number">1</span>  prefixlen <span class="number">128</span>  scopeid <span class="number">0</span>x10&lt;host&gt;</span><br><span class="line">        <span class="attribute">loop</span>  txqueuelen <span class="number">1000</span>  (æœ¬åœ°ç¯å›)</span><br><span class="line">        <span class="attribute">RX</span> packets <span class="number">216531961</span>  bytes <span class="number">57623160675</span> (<span class="number">57</span>.<span class="number">6</span> GB)</span><br><span class="line">        <span class="attribute">RX</span> errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        <span class="attribute">TX</span> packets <span class="number">216531961</span>  bytes <span class="number">57623160675</span> (<span class="number">57</span>.<span class="number">6</span> GB)</span><br><span class="line">        <span class="attribute">TX</span> errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ç½‘å¡å‘½å</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å½“å·¥ä½œä¸­å¤§é‡ç®¡ç†ç½‘å¡ï¼Œæ‰€æœ‰è®¾å¤‡çš„ç½‘å¡æœ€å¥½éƒ½æ˜¯ä»¥ eth0 å‘½åï¼Œè¿™æ ·å¯ä»¥æ‰¹é‡æ“ä½œã€‚</span><br><span class="line">ç½‘ç»œæ¥å£å‘½åä¿®æ”¹</span><br><span class="line">ç½‘å¡å‘½åè§„åˆ™å— biosdevname å’Œ net.ifnames ä¸¤ä¸ªå‚æ•°å½±å“</span><br><span class="line">ç¼–è¾‘ /etc/default/grup æ–‡ä»¶ï¼Œå¢åŠ  <span class="attribute">biosdevname</span>=0 net.<span class="attribute">ifnames</span>=0</span><br><span class="line">æ›´æ–° grub</span><br><span class="line">    # grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line">é‡å¯</span><br><span class="line">    # reboot</span><br><span class="line"></span><br><span class="line">ç»„åˆï¼Œ<span class="attribute">biosdevname</span>=0 net.<span class="attribute">ifnames</span>=0ï¼Œåˆ™ç½‘å¡åä¸º eth0</span><br><span class="line">     <span class="attribute">biosdevname</span>=1 net.<span class="attribute">ifnames</span>=0ï¼Œåˆ™ç½‘å¡åä¸º em1</span><br><span class="line">     <span class="attribute">biosdevname</span>=0 net.<span class="attribute">ifnames</span>=1ï¼Œåˆ™ç½‘å¡åä¸º ens33</span><br></pre></td></tr></table></figure><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mii-tool eth0  æŸ¥çœ‹ç½‘å¡ç‰©ç†è¿æ¥æƒ…å†µ</span><br><span class="line">route -<span class="built_in">n</span> æŸ¥çœ‹ç½‘å…³ï¼ˆè·¯ç”±ï¼‰ï¼Œä½¿ç”¨ -<span class="built_in">n</span> å‚æ•°ä¸è§£æä¸»æœºåï¼ˆæŠŠipè§£ææˆåŸŸåï¼‰</span><br></pre></td></tr></table></figure><p>ç½‘å…³åŸºæœ¬ç†è§£ï¼š<a href="https://zhuanlan.zhihu.com/p/165142303">ä»€ä¹ˆæ˜¯ç½‘å…³ï¼Œç½‘å…³çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</a>ã€é‡Œé¢çš„ä¾‹å­è›®æœ‰è¶£çš„ã€‘</p><p>åŠ¨æ‰‹å®æ“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv$ route -n</span><br><span class="line">å†…æ ¸ IP è·¯ç”±è¡¨</span><br><span class="line">ç›®æ ‡            ç½‘å…³            å­ç½‘æ©ç         æ ‡å¿—  è·ƒç‚¹   å¼•ç”¨  ä½¿ç”¨ æ¥å£</span><br><span class="line">0.0.0.0         10.168.147.10    0.0.0.0         UG    100    0        0 eno4</span><br><span class="line">10.168.147.0    0.0.0.0         255.255.255.0   U     100    0        0 eno4</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 eno4</span><br></pre></td></tr></table></figure><p>ç½‘ç»œé…ç½®å‘½ä»¤</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ifconfig <span class="tag">&lt;<span class="name">æ¥å£</span>&gt;</span> <span class="tag">&lt;<span class="name">IPåœ°å€</span>&gt;</span> [netmask å­ç½‘æ©ç ]      è®¾ç½®ç½‘å¡çš„ipåœ°å€</span><br><span class="line">ifup <span class="tag">&lt;<span class="name">æ¥å£</span>&gt;</span>    å¯ç”¨ç½‘å¡</span><br><span class="line">ifdown <span class="tag">&lt;<span class="name">æ¥å£</span>&gt;</span>    ç¦ç”¨ç½‘å¡</span><br></pre></td></tr></table></figure><p>ç½‘å…³é…ç½®å‘½ä»¤</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æ·»åŠ ç½‘å…³</span><br><span class="line"><span class="keyword">route</span> add <span class="keyword">default</span> gw <span class="variable">&lt;ç½‘å…³ip&gt;</span></span><br><span class="line"><span class="keyword">route</span> add -host <span class="variable">&lt;æŒ‡å®šip&gt;</span> gw <span class="variable">&lt;ç½‘å…³ip&gt;</span></span><br><span class="line"><span class="keyword">route</span> add -net <span class="variable">&lt;æŒ‡å®šç½‘æ®µ&gt;</span> netmask <span class="variable">&lt;å­ç½‘æ©ç &gt;</span> gw <span class="variable">&lt;ç½‘å…³ip&gt;</span></span><br></pre></td></tr></table></figure><p>ç½‘ç»œå‘½ä»¤é›†åˆï¼šipå‘½ä»¤</p><h3 id="ç½‘ç»œæ•…éšœæ’é™¤">ç½‘ç»œæ•…éšœæ’é™¤</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ping æ£€æµ‹æ˜¯å¦è¿æ¥åˆ°ä¸»æœº</span><br><span class="line">    ping www<span class="selector-class">.baidu</span><span class="selector-class">.com</span> </span><br><span class="line">traceroute  è·Ÿè¸ªå½“å‰ä¸»æœºåˆ°ç›®æ ‡ä¸»æœºçš„ç½‘ç»œçŠ¶æ€ï¼Œ-w <span class="number">1</span>è¶…æ—¶æœ€å¤šç­‰<span class="number">1</span>ç§’</span><br><span class="line">    traceroute -w <span class="number">1</span> www<span class="selector-class">.baidu</span><span class="selector-class">.com</span></span><br><span class="line">    </span><br><span class="line">mtr  æ˜¾ç¤ºè‡ªå·±ä¸»æœºçš„ç½‘ç»œçŠ¶æ€</span><br><span class="line"></span><br><span class="line">nslookup  åŸŸåè§£ææˆip</span><br><span class="line">    nslooup www<span class="selector-class">.baidu</span><span class="selector-class">.com</span></span><br><span class="line"></span><br><span class="line">telnet  æ£€æµ‹ç«¯å£</span><br><span class="line">    telnet www<span class="selector-class">.baidu</span><span class="selector-class">.com</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line">tcpdump  ç½‘ç»œæŠ“åŒ…   -<span class="selector-tag">i</span> any æŠ“å–æ‰€æœ‰ç½‘å¡é‡Œçš„æ•°æ®åŒ…ï¼Œ-n æŠŠåŸŸåè§£ææˆ ip ï¼Œport <span class="number">80</span> æŠ“å–æŒ‡å®šç«¯å£  host <span class="number">10.0</span>.<span class="number">0.1</span> æŠ“å–å½“å‰ä¸»æœºåˆ°æŸä¸ªä¸»æœºçš„æ•°æ®åŒ…</span><br><span class="line">    tcpdump -<span class="selector-tag">i</span> any -n port <span class="number">80</span></span><br><span class="line">    tcpdump -<span class="selector-tag">i</span> any -n host <span class="number">10.0</span>.<span class="number">0.1</span></span><br><span class="line">    tcpdump -<span class="selector-tag">i</span> any -n host <span class="number">10.0</span>.<span class="number">0.1</span> and port <span class="number">80</span></span><br><span class="line">    tcpdump -<span class="selector-tag">i</span> any -n host <span class="number">10.0</span>.<span class="number">0.1</span> and port <span class="number">80</span> -w /tmp/filename æ•è·å¹¶ä¸”ä¿å­˜</span><br><span class="line"></span><br><span class="line">netstat ç›‘å¬åœ°å€ -n åŸŸåè½¬æ¢ï¼Œ-t æ˜¾ç¤ºtcp ï¼Œ-<span class="selector-tag">p</span> è¿›ç¨‹ ï¼Œ-l  tcpçŠ¶æ€ listen</span><br><span class="line">    netstat -ntpl</span><br><span class="line"></span><br><span class="line">ss è·Ÿnetstatä¸€æ ·ï¼Œå‚æ•°ä¹Ÿä¸€æ ·ï¼Œæ˜¾ç¤ºçš„æ ¼å¼ä¸ä¸€æ ·</span><br></pre></td></tr></table></figure><p><strong>ping</strong></p><p>Pingæ˜¯ç”¨æ¥æµ‹è¯•ç½‘ç»œè¿æ¥è´¨é‡çš„å·¥å…·ã€‚å®ƒé€šè¿‡å‘é€ICMPï¼ˆInternet Control Message Protocolï¼‰å›æ˜¾è¯·æ±‚æ¶ˆæ¯åˆ°ç›®æ ‡ä¸»æœºï¼Œå¹¶ç­‰å¾…å›æ˜¾åº”ç­”ã€‚é€šè¿‡æµ‹é‡è¿™ä¸ªè¿‡ç¨‹çš„æ—¶é—´ï¼ŒPingå¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£æ•°æ®åŒ…ä»ä¸€å°è®¡ç®—æœºä¼ è¾“åˆ°å¦ä¸€å°è®¡ç®—æœºæ‰€éœ€è¦çš„æ—¶é—´ï¼Œä»è€Œäº†è§£ç½‘ç»œçš„å»¶è¿Ÿæƒ…å†µã€‚æ­¤å¤–ï¼ŒPingè¿˜èƒ½å¸®åŠ©æˆ‘ä»¬æ‰¾å‡ºä¸¢åŒ…çš„é—®é¢˜ã€‚</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv$<span class="built_in"> ping </span>www.baidu.com<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>www.a.shifen.com (183.2.172.42) 56(84) bytes of data.</span><br><span class="line">64 å­—èŠ‚ï¼Œæ¥è‡ª 183.2.172.42 (183.2.172.42): <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=50 æ—¶é—´=32.6 æ¯«ç§’</span><br><span class="line">64 å­—èŠ‚ï¼Œæ¥è‡ª 183.2.172.42 (183.2.172.42): <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=50 æ—¶é—´=33.1 æ¯«ç§’</span><br><span class="line">64 å­—èŠ‚ï¼Œæ¥è‡ª 183.2.172.42 (183.2.172.42): <span class="attribute">icmp_seq</span>=3 <span class="attribute">ttl</span>=50 æ—¶é—´=32.5 æ¯«ç§’</span><br><span class="line">64 å­—èŠ‚ï¼Œæ¥è‡ª 183.2.172.42 (183.2.172.42): <span class="attribute">icmp_seq</span>=4 <span class="attribute">ttl</span>=50 æ—¶é—´=32.8 æ¯«ç§’</span><br><span class="line">64 å­—èŠ‚ï¼Œæ¥è‡ª 183.2.172.42 (183.2.172.42): <span class="attribute">icmp_seq</span>=5 <span class="attribute">ttl</span>=50 æ—¶é—´=32.6 æ¯«ç§’</span><br><span class="line">64 å­—èŠ‚ï¼Œæ¥è‡ª 183.2.172.42 (183.2.172.42): <span class="attribute">icmp_seq</span>=6 <span class="attribute">ttl</span>=50 æ—¶é—´=32.8 æ¯«ç§’</span><br><span class="line">^C</span><br><span class="line">--- www.a.shifen.com<span class="built_in"> ping </span>ç»Ÿè®¡ ---</span><br><span class="line">å·²å‘é€ 6 ä¸ªåŒ…ï¼Œ å·²æ¥æ”¶ 6 ä¸ªåŒ…, 0% åŒ…ä¸¢å¤±, è€—æ—¶ 5008 æ¯«ç§’</span><br><span class="line">rtt min/avg/max/mdev = 32.530/32.750/33.089/0.189 ms</span><br></pre></td></tr></table></figure><p><strong>traceout</strong></p><p>Tracerouteæ˜¯ç”¨æ¥è¿½è¸ªæ•°æ®åŒ…åœ¨ç½‘ç»œä¸Šä»æºä¸»æœºåˆ°ç›®æ ‡ä¸»æœºçš„è·¯å¾„çš„å·¥å…·ã€‚å®ƒé€šè¿‡å‘é€ä¸€ç³»åˆ—çš„ICMPè¯·æ±‚æ¶ˆæ¯ï¼Œå¹¶è®°å½•æ¯ä¸€è·³çš„IPåœ°å€å’Œä¼ è¾“æ—¶é—´ï¼Œä»è€Œæ‰¾å‡ºæ•°æ®åŒ…åœ¨ç½‘ç»œä¸­çš„å®Œæ•´è·¯å¾„ã€‚Tracerouteå¯¹äºè¯Šæ–­ç½‘ç»œä¸­çš„è·¯ç”±é—®é¢˜éå¸¸æœ‰ç”¨ã€‚</p><p><a href="https://zhuanlan.zhihu.com/p/36811672">traceoutåŸç†</a></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv$ traceroute -w <span class="number">1</span> www.baidu.com</span><br><span class="line">traceroute to www.baidu.com (<span class="number">183.2</span>.<span class="number">172.42</span>), <span class="number">30</span> hops max, <span class="number">60</span> byte packets</span><br><span class="line"> <span class="number">1</span>  <span class="number">10.168</span>.<span class="number">157.1</span> (<span class="number">10.168</span>.<span class="number">157.1</span>)  <span class="number">0.264</span> <span class="keyword">ms</span>  <span class="title">0</span>.<span class="number">245</span> <span class="keyword">ms</span>  <span class="title">0</span>.<span class="number">235</span> <span class="keyword">ms</span></span><br><span class="line"> <span class="title">2</span>  * * *</span><br><span class="line"> <span class="number">3</span>  <span class="number">10.168</span>.<span class="number">82.2</span> (<span class="number">10.168</span>.<span class="number">82.2</span>)  <span class="number">1.305</span> <span class="keyword">ms</span>  <span class="title">1</span>.<span class="number">775</span> <span class="keyword">ms</span>  <span class="title">2</span>.<span class="number">248</span> <span class="keyword">ms</span></span><br><span class="line"> <span class="title">4</span>  <span class="number">172.16</span>.<span class="number">255.254</span> (<span class="number">172.16</span>.<span class="number">255.254</span>)  <span class="number">0.897</span> <span class="keyword">ms</span>  <span class="title">1</span>.<span class="number">018</span> <span class="keyword">ms</span>  <span class="title">0</span>.<span class="number">795</span> <span class="keyword">ms</span></span><br><span class="line"> <span class="title">5</span>  <span class="number">113.140</span>.<span class="number">11.1</span> (<span class="number">113.140</span>.<span class="number">11.1</span>)  <span class="number">2.604</span> <span class="keyword">ms</span>  <span class="title">1</span>.<span class="number">501</span> <span class="keyword">ms</span>  <span class="title">1</span>.<span class="number">590</span> <span class="keyword">ms</span></span><br><span class="line"> <span class="title">6</span>  <span class="number">10.224</span>.<span class="number">27.5</span> (<span class="number">10.224</span>.<span class="number">27.5</span>)  <span class="number">1.483</span> <span class="keyword">ms</span> <span class="title">10</span>.<span class="number">224.27</span>.<span class="number">9</span> (<span class="number">10.224</span>.<span class="number">27.9</span>)  <span class="number">1.658</span> <span class="keyword">ms</span>  <span class="title">1</span>.<span class="number">715</span> <span class="keyword">ms</span></span><br><span class="line"> <span class="title">7</span>  <span class="number">1.85</span>.<span class="number">253.45</span> (<span class="number">1.85</span>.<span class="number">253.45</span>)  <span class="number">1.777</span> <span class="keyword">ms</span> <span class="title">1</span>.<span class="number">85.253</span>.<span class="number">53</span> (<span class="number">1.85</span>.<span class="number">253.53</span>)  <span class="number">1.764</span> <span class="keyword">ms</span> <span class="title">*</span></span><br><span class="line"><span class="title"> 8</span>  * <span class="number">202.97</span>.<span class="number">36.109</span> (<span class="number">202.97</span>.<span class="number">36.109</span>)  <span class="number">31.468</span> <span class="keyword">ms</span> <span class="title">202</span>.<span class="number">97.13</span>.<span class="number">253</span> (<span class="number">202.97</span>.<span class="number">13.253</span>)  <span class="number">29.065</span> <span class="keyword">ms</span></span><br><span class="line"> <span class="title">9</span>  <span class="number">113.96</span>.<span class="number">4.74</span> (<span class="number">113.96</span>.<span class="number">4.74</span>)  <span class="number">33.720</span> <span class="keyword">ms</span> <span class="title">* *</span></span><br><span class="line"><span class="title">10</span>  * * *</span><br><span class="line"><span class="number">11</span>  <span class="number">14.29</span>.<span class="number">117.178</span> (<span class="number">14.29</span>.<span class="number">117.178</span>)  <span class="number">31.263</span> <span class="keyword">ms</span> <span class="title">14</span>.<span class="number">29.117</span>.<span class="number">170</span> (<span class="number">14.29</span>.<span class="number">117.170</span>)  <span class="number">39.950</span> <span class="keyword">ms</span>  <span class="title">37</span>.<span class="number">211</span> <span class="keyword">ms</span></span><br><span class="line"><span class="title">12</span>  * * *</span><br><span class="line"><span class="number">13</span>  * * *</span><br><span class="line"><span class="number">14</span>  * * *</span><br><span class="line"><span class="number">15</span>  * * *</span><br></pre></td></tr></table></figure><p><strong>Pingä¸Tracerouteçš„åŒºåˆ«</strong>ï¼š<br>ä¸»è¦åŒºåˆ«åœ¨äºPingä¸»è¦ç”¨äºæµ‹è¯•ç½‘ç»œè¿æ¥çš„è´¨é‡ï¼ˆå¦‚å»¶è¿Ÿå’Œä¸¢åŒ…ï¼‰ï¼Œè€ŒTracerouteä¸»è¦ç”¨äºè¿½è¸ªæ•°æ®åŒ…çš„è·¯å¾„ã€‚Pingåªå‘Šè¯‰ä½ æ•°æ®åŒ…æ˜¯å¦èƒ½å¤Ÿåˆ°è¾¾ç›®æ ‡ä¸»æœºï¼Œä»¥åŠè¿™ä¸ªè¿‡ç¨‹éœ€è¦å¤šé•¿æ—¶é—´ï¼Œä½†å®ƒä¸èƒ½å‘Šè¯‰ä½ æ•°æ®åŒ…åˆ°è¾¾ç›®æ ‡ä¸»æœºçš„å…·ä½“è·¯å¾„ã€‚è€ŒTracerouteåˆ™èƒ½è¯¦ç»†åœ°å±•ç¤ºæ•°æ®åŒ…ä»æºä¸»æœºåˆ°ç›®æ ‡ä¸»æœºçš„æ¯ä¸€è·³è·¯å¾„ï¼Œæœ‰åŠ©äºæˆ‘ä»¬äº†è§£ç½‘ç»œçš„ç»“æ„å’Œæ‰¾å‡ºå¯èƒ½å­˜åœ¨çš„è·¯ç”±é—®é¢˜ã€‚</p><p><strong>mtr</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv</span><span class="variable">$ </span>mtr                                                       <span class="title class_">My</span> traceroute  [v0.<span class="number">93</span>]</span><br><span class="line">sv-<span class="variable constant_">NF5280M5</span> (<span class="number">127.0</span>.<span class="number">0.1</span>)                                                                                     <span class="number">2024</span>-<span class="number">05</span>-10<span class="symbol">T16:</span><span class="number">29</span><span class="symbol">:</span><span class="number">13</span>+0800</span><br><span class="line"><span class="title class_">Keys</span>:  <span class="title class_">Help</span>   <span class="title class_">Display</span> mode   <span class="title class_">Restart</span> statistics   <span class="title class_">Order</span> of fields   quit</span><br><span class="line">                                                                                            <span class="title class_">Packets</span>               <span class="title class_">Pings</span></span><br><span class="line"> <span class="title class_">Host</span>                                                                                     <span class="title class_">Loss</span>%   <span class="title class_">Snt</span>   <span class="title class_">Last</span>   <span class="title class_">Avg</span>  <span class="title class_">Best</span>  <span class="title class_">Wrst</span> <span class="title class_">StDev</span></span><br><span class="line"> <span class="number">1</span>. localhost                                                                              <span class="number">0.0</span>%     <span class="number">9</span>    <span class="number">0.0</span>   <span class="number">0.0</span>   <span class="number">0.0</span>   <span class="number">0.0</span>   <span class="number">0.0</span></span><br></pre></td></tr></table></figure><p><strong>netstat</strong></p><p>netstatæ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„å‘½ä»¤ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£æˆ‘ä»¬çš„ç³»ç»Ÿç½‘ç»œçŠ¶æ€ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›åŸºæœ¬çš„ä½¿ç”¨æ–¹æ³•ï¼š</p><ol><li><strong>æ˜¾ç¤ºç½‘ç»œçŠ¶æ€</strong>ï¼šnetstat å‘½ä»¤å¯ä»¥æ˜¾ç¤ºç½‘ç»œçŠ¶æ€ï¼Œå®ƒé€šå¸¸ç”¨äºé—®é¢˜ç¡®å®šè€Œä¸æ˜¯æ€§èƒ½æµ‹é‡ã€‚ä½†æ˜¯ï¼Œnetstat å‘½ä»¤å¯ç”¨äºç¡®å®šç½‘ç»œä¸Šçš„æµé‡ï¼Œä»¥ç¡®å®šæ€§èƒ½é—®é¢˜æ˜¯å¦æ˜¯ç”±äºç½‘ç»œæ‹¥å¡å¼•èµ·çš„ã€‚åœ¨ netstat å…³äºæ‰€é…ç½®çš„ç½‘ç»œæ¥å£ï¼Œè¯¸å¦‚ä»¥ä¸‹çš„æµé‡å‘½ä»¤æ˜¾ç¤ºä¿¡æ¯ï¼šä¸æ‰€æœ‰socketså…³è”çš„ä¿¡æ¯ã€‚è¯¦æƒ…è¯·å‚è€ƒ<a href="https://zhuanlan.zhihu.com/p/367635200">æ­¤é“¾æ¥</a>ã€‚</li><li><strong>ç½‘ç»œç»Ÿè®¡å·¥å…·</strong>ï¼šnetstat æ˜¯ä¸€ä¸ªç½‘ç»œåˆ†æå·¥å…·ï¼Œç”¨äºæ˜¾ç¤ºç½‘ç»œè¿æ¥ã€è·¯ç”±è¡¨ã€æ¥å£ç»Ÿè®¡ã€ä¼ªè£…è¿æ¥å’Œå¤šæ’­æˆå‘˜èµ„æ ¼ç­‰ä¿¡æ¯ã€‚ç„¶è€Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œä¸€äº›Linuxå‘è¡Œç‰ˆå·²ç»å¼€å§‹ç”¨åƒss, ipè¿™æ ·çš„æ›´ç°ä»£çš„å·¥å…·ä»£æ›¿netstatã€‚è¯¦æƒ…è¯·å‚è€ƒ<a href="https://blog.csdn.net/u012964600/article/details/137612961">æ­¤é“¾æ¥</a>ã€‚</li><li><strong>æ˜¾ç¤ºç«¯å£å’Œç½‘ç»œç»Ÿè®¡æ•°æ®</strong>ï¼šnetstaå‘½ä»¤æ˜¯ä¸€ä¸ªCLIå·¥å…·ï¼Œç”¨äºç½‘ç»œç»Ÿè®¡ã€‚å®ƒæä¾›äº†ç½‘ç»œæ´»åŠ¨çš„æ¦‚è§ˆï¼Œå¹¶æ˜¾ç¤ºå“ªäº›ç«¯å£æ˜¯å¼€æ”¾çš„æˆ–å·²å»ºç«‹è¿æ¥ã€‚netstat å·¥å…·å¯¹äºå‘ç°ç½‘ç»œé—®é¢˜è‡³å…³é‡è¦ã€‚è¯¦æƒ…è¯·å‚è€ƒ<a href="https://phoenixnap.com/kb/netstat-command">æ­¤é“¾æ¥</a>ã€‚</li></ol><p>åœ¨ä½¿ç”¨ netstat å‘½ä»¤æ—¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºå…¶å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½è·å–å®Œæ•´çš„ç½‘ç»œçŠ¶æ€ä¿¡æ¯ã€‚</p><p>ç½‘ç»œç®¡ç†å’Œé…ç½®æ–‡ä»¶</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ç½‘ç»œæœåŠ¡ç®¡ç†ç¨‹åºåˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ SysV å’Œ systemd(centos7)</span><br><span class="line">service network status|start|stop|restart</span><br><span class="line"></span><br><span class="line">ç½‘ç»œé…ç½®æ–‡ä»¶</span><br><span class="line"></span><br><span class="line"><span class="regexp">/etc/</span>sysconfig<span class="regexp">/network-scripts/i</span>fcfg-eth0 ï¼ˆç½‘å¡é…ç½®é¡¹ï¼‰</span><br><span class="line"><span class="regexp">/etc/</span>hosts</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨å‘½ä»¤</p><p>ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„<code>netstat</code>æ“ä½œï¼š</p><ol><li>æ˜¾ç¤ºæ‰€æœ‰æ´»åŠ¨çš„ç½‘ç»œè¿æ¥ï¼š<code>netstat</code>å‘½ä»¤é»˜è®¤å°±å¯ä»¥æ˜¾ç¤ºå½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ç½‘ç»œè¿æ¥ä¿¡æ¯ã€‚</li><li>æ˜¾ç¤ºç›‘å¬çš„æœåŠ¡å™¨å¥—æ¥å­—ï¼š<code>netstat -l</code>å¯ä»¥æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨ç›‘å¬çš„æœåŠ¡å™¨å¥—æ¥å­—ã€‚</li><li>æ˜¾ç¤ºè·¯ç”±è¡¨ï¼š<code>netstat -r</code>å¯ä»¥æ˜¾ç¤ºè·¯ç”±è¡¨ï¼Œè¿™å¯¹äºè¯Šæ–­ç½‘ç»œé—®é¢˜éå¸¸æœ‰ç”¨ã€‚</li><li>æ˜¾ç¤ºæ¯ä¸ªåè®®çš„ç»Ÿè®¡ä¿¡æ¯ï¼š<code>netstat -s</code>å¯ä»¥æ˜¾ç¤ºæ¯ä¸ªç½‘ç»œåè®®çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚TCPã€UDPã€ICMPç­‰ã€‚</li><li>æ˜¾ç¤ºç½‘ç»œæ¥å£çš„ç»Ÿè®¡ä¿¡æ¯ï¼š<code>netstat -i</code>å¯ä»¥æ˜¾ç¤ºæ¯ä¸ªç½‘ç»œæ¥å£çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚å‘é€å’Œæ¥æ”¶çš„æ•°æ®åŒ…æ•°é‡ç­‰ã€‚</li></ol><h3 id="è½¯ä»¶åŒ…ç®¡ç†">è½¯ä»¶åŒ…ç®¡ç†</h3><p><strong>è½¯ä»¶åŒ…ç®¡ç†å™¨</strong></p><p>åŒ…ç®¡ç†å™¨æ˜¯æ–¹ä¾¿è½¯ä»¶å®‰è£…ã€å¸è½½ï¼Œè§£å†³è½¯ä»¶ä¾èµ–å…³ç³»çš„é‡è¦å·¥å…·ã€‚</p><ul><li>CentOS å’Œ RedHat ä½¿ç”¨ yum åŒ…ç®¡ç†å™¨ï¼Œè½¯ä»¶å®‰è£…åŒ…æ ¼å¼ä¸º rpm</li><li>Debianã€Ubuntuä½¿ç”¨ apt åŒ…ç®¡ç†å™¨ï¼Œè½¯ä»¶å®‰è£…åŒ…æ ¼å¼ä¸º deb</li></ul><p><strong>ä½¿ç”¨rpmå‘½ä»¤å®‰è£…è½¯ä»¶åŒ…</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240510193643483.png" alt="image-20240510193643483"></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rpm å‘½ä»¤å¸¸ç”¨å‚æ•°</span><br><span class="line">    -<span class="selector-tag">q</span> æŸ¥è¯¢è½¯ä»¶åŒ…ã€€ã€€ã€€ã€€rpm -qa æŸ¥è¯¢æ‰€æœ‰è½¯ä»¶åŒ…ã€€ã€€ã€€ã€€rpm -<span class="selector-tag">q</span> vim-common æŸ¥è¯¢æŸä¸ªè½¯ä»¶åŒ…</span><br><span class="line">    -<span class="selector-tag">i</span>  å®‰è£…è½¯ä»¶åŒ…ã€€ã€€ã€€ã€€rpm -<span class="selector-tag">i</span> vim-enhanced-<span class="number">7.4</span>.<span class="number">160</span>-<span class="number">5</span><span class="selector-class">.el7</span><span class="selector-class">.x84_64</span><span class="selector-class">.rpm</span>  ï¼ˆè¦å…¨ç§°ï¼‰</span><br><span class="line">    -e å¸è½½è½¯ä»¶åŒ…ã€€ã€€ã€€ã€€rpm -e vim-enhanced   ï¼ˆåªè¦åå­—ï¼Œä¸éœ€è¦ç‰ˆæœ¬å·ç­‰ï¼‰ç”¨ rpm å®‰è£…çš„é—®é¢˜ï¼šå¦‚æœä¸€ä¸ªè½¯ä»¶åŒ…ä¾èµ–å…¶ä»–è½¯ä»¶åŒ…ï¼Œé‚£ä¹ˆå°±ä¼šå®‰è£…å¤±è´¥ã€‚éœ€è¦æ“ä½œè€…è‡ªå·±è§£å†³ä¾èµ–å…³ç³»ã€‚</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨yumåŒ…ç®¡ç†å™¨å®‰è£…è½¯ä»¶åŒ…</strong></p><p>rpm åŒ…çš„é—®é¢˜</p><ul><li>éœ€è¦è‡ªå·±è§£å†³ä¾èµ–å…³ç³»</li><li>è½¯ä»¶åŒ…æ¥æºä¸å¯é </li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">CentOS yumæº</span><br><span class="line">    http:<span class="regexp">//mi</span>rror.centos.org<span class="regexp">/centos/</span><span class="number">7</span>/</span><br><span class="line">å›½å†…é•œåƒ</span><br><span class="line">    https:<span class="regexp">//</span>opsx.alibaba.com/mirror</span><br><span class="line">yum é…ç½®æ–‡ä»¶</span><br><span class="line">    <span class="regexp">/etc/yum</span>.repos.d/CentOS-Base.repo</span><br><span class="line"></span><br><span class="line">å¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">[base]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Base -mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/centos/</span><span class="variable">$releasever</span><span class="regexp">/os/</span><span class="variable">$basearch</span>/</span><br><span class="line">            http:<span class="regexp">//mi</span>rrors.aliyuncs.com<span class="regexp">/centos/</span><span class="variable">$releasever</span><span class="regexp">/os/</span><span class="variable">$basearch</span>/</span><br><span class="line">             http:<span class="regexp">//mi</span>rrors.cloud.aliyuncs.com<span class="regexp">/centos/</span><span class="variable">$releasever</span><span class="regexp">/os/</span><span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/centos/</span>RPM-GPG-KEY-CentOS-<span class="number">7</span></span><br><span class="line"></span><br><span class="line">æˆ–è€…ç›´æ¥ç”¨åˆ«äººå·²ç»å†™å¥½çš„é…ç½®æ–‡ä»¶</span><br><span class="line">wget -O <span class="regexp">/etc/yum</span>.repo.d<span class="regexp">/CentOS-Base.repo http:/</span><span class="regexp">/mirrors.aliyun.com/</span>repo/Centos-<span class="number">7</span>.repoéœ€è¦æ¸…é™¤ç¼“å­˜yum makecache</span><br></pre></td></tr></table></figure><p>yum å‘½ä»¤å¸¸ç”¨é€‰é¡¹</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å¸¸ç”¨é€‰é¡¹</span><br><span class="line"></span><br><span class="line"><span class="keyword">install</span> å®‰è£…è½¯ä»¶åŒ…</span><br><span class="line"><span class="keyword">remove</span> å¸è½½è½¯ä»¶åŒ…</span><br><span class="line"><span class="keyword">list</span> |grouplist æŸ¥çœ‹è½¯ä»¶åŒ…</span><br><span class="line">update å‡çº§è½¯ä»¶åŒ…</span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–æ–¹å¼å®‰è£…">å…¶ä»–æ–¹å¼å®‰è£…</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">äºŒè¿›åˆ¶å®‰è£…</span><br><span class="line">æºä»£ç ç¼–è¯‘å®‰è£…</span><br><span class="line"></span><br><span class="line">wget https:<span class="comment">//openresty.org/download/openresty-1.15.8.1.tar.gz</span></span><br><span class="line">tar zxf openresty-<span class="keyword">VERSION</span>.tar.gz</span><br><span class="line"><span class="keyword">cd</span> openresty-<span class="keyword">VERSION</span>/</span><br><span class="line">./configure --prefix=/usr/<span class="keyword">local</span>/openresty</span><br><span class="line">make -j2   ï¼ˆç”¨2æ ¸ç¼–è¯‘ï¼‰</span><br><span class="line">make isntall</span><br></pre></td></tr></table></figure><h3 id="å‡çº§å†…æ ¸">å‡çº§å†…æ ¸</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">rpm æ ¼å¼å†…æ ¸</span><br><span class="line">    æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬</span><br><span class="line">        uname -r</span><br><span class="line">    å‡çº§å†…æ ¸ç‰ˆæœ¬</span><br><span class="line">        yum install kernel-<span class="number">3.10</span>.<span class="number">0</span>   è¿™ç§æ–¹å¼ä¸€èˆ¬ä¸èƒ½å‡çº§åˆ°æœ€æ–°</span><br><span class="line">        epelè½¯ä»¶ä»“åº“ä¼šæœ‰è¾ƒé«˜çš„è½¯ä»¶ç‰ˆæœ¬ã€‚yum install epel-release -<span class="keyword">y</span></span><br><span class="line">    å‡çº§å·²å®‰è£…çš„å…¶ä»–è½¯ä»¶åŒ…å’Œè¡¥ä¸</span><br><span class="line">        yum <span class="keyword">update</span>    é™¤äº†å‡çº§å†…æ ¸ï¼Œè¿˜ä¼šå‡çº§è½¯ä»¶åŒ…ã€‚æ­£å¸¸ä¸è¦ä½¿ç”¨ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æºä»£ç ç¼–è¯‘å®‰è£…å†…æ ¸</span><br><span class="line">yum install gcc gcc-<span class="keyword">c</span>++ <span class="keyword">make</span> ncurses-devel openssl-devel elfutils-libelf-devel</span><br><span class="line"></span><br><span class="line">ä¸‹è½½å¹¶è§£å‹ç¼©å†…æ ¸</span><br><span class="line">https://www.kernel.org</span><br><span class="line">tar xvf linux-<span class="number">5.1</span>.<span class="number">10</span>.tar.xz -C /usr/src/kernels</span><br><span class="line"></span><br><span class="line">é…ç½®å†…æ ¸ç¼–è¯‘å‚æ•°</span><br><span class="line"><span class="keyword">cd</span> /usr/src/kernels/linux-<span class="number">5.1</span>.<span class="number">10</span>/</span><br><span class="line"><span class="keyword">make</span> menuconfig | allyesconfig | allnoconfig</span><br><span class="line"><span class="keyword">make</span> allyesconfig ï¼ˆæ— è„‘å…¨é€‰ï¼‰</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨å½“å‰ç³»ç»Ÿå†…æ ¸é…ç½®</span><br><span class="line"><span class="keyword">cp</span> /boot/config-kernelversion.platform /usr/src/kernels/linux-<span class="number">5.1</span>.<span class="number">10</span>/.config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹cpu</span><br><span class="line">lscpu</span><br><span class="line"></span><br><span class="line">ç¼–è¯‘</span><br><span class="line"><span class="keyword">make</span> j2 <span class="keyword">all</span></span><br><span class="line"></span><br><span class="line">å®‰è£…å†…æ ¸</span><br><span class="line"><span class="keyword">make</span> modules_install</span><br><span class="line"><span class="keyword">make</span> install</span><br></pre></td></tr></table></figure><p>è¿™ç¯‡æ•™ç¨‹è¯¦ç»†è®°å½•äº†æ¯ä¸ªæ­¥éª¤ï¼š<a href="https://blog.csdn.net/weixin_42888638/article/details/127288997?spm=1001.2014.3001.5501">linuxå†…æ ¸ç¼–è¯‘è®°å½•</a></p><h2 id="è¿›ç¨‹ç®¡ç†">è¿›ç¨‹ç®¡ç†</h2><h3 id="è¿›ç¨‹çš„æ¦‚å¿µä¸è¿›ç¨‹æŸ¥çœ‹">è¿›ç¨‹çš„æ¦‚å¿µä¸è¿›ç¨‹æŸ¥çœ‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">è¿›ç¨‹-è¿è¡Œä¸­çš„ç¨‹åºï¼Œä»ç¨‹åºå¼€å§‹è¿è¡Œåˆ°ç»ˆæ­¢çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ˜¯å¯ç®¡ç†çš„</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹å‘½ä»¤</span><br><span class="line">ps</span><br><span class="line">    -e è¡¨ç¤ºæ‰€æœ‰çš„ç»ˆç«¯è¿è¡Œçš„è¿›ç¨‹</span><br><span class="line">    -f  æ˜¾ç¤ºæ›´å¤šä¿¡æ¯ï¼Œæ¯”å¦‚ UIDã€PPIDï¼ˆçˆ¶è¿›ç¨‹ï¼‰ã€CMDï¼ˆå‘½ä»¤çš„å®Œæ•´è·¯å¾„ï¼‰</span><br><span class="line">    -L  å¤šæ˜¾ç¤º LWP ï¼Œçº¿ç¨‹ä¿¡æ¯</span><br><span class="line">    ps -eLf  å¸¸ç”¨å‘½ä»¤</span><br><span class="line"></span><br><span class="line">pstree  æŸ¥çœ‹è¿›ç¨‹æ ‘</span><br><span class="line">    </span><br><span class="line">top  åŠ¨æ€æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯top -p è¿›ç¨‹å·</span><br><span class="line"></span><br><span class="line">ç»“è®ºï¼š</span><br><span class="line">è¿›ç¨‹ä¹Ÿæ˜¯æ ‘å½¢ç»“æ„</span><br><span class="line">è¿›ç¨‹å’Œæƒé™æœ‰ç€å¯†ä¸å¯åˆ†çš„å…³ç³»</span><br></pre></td></tr></table></figure><p>ps</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv</span><span class="variable">$ </span>ps</span><br><span class="line">    <span class="variable constant_">PID</span> <span class="variable constant_">TTY</span>          <span class="variable constant_">TIME</span> <span class="variable constant_">CMD</span></span><br><span class="line"><span class="number">1221450</span> pts/<span class="number">1</span>    <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">03</span> bash</span><br><span class="line"><span class="number">1247704</span> pts/<span class="number">1</span>    <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> ps</span><br></pre></td></tr></table></figure><p>â€œpts/1â€ æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç»ˆç«¯è®¾å¤‡æ–‡ä»¶ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸€ç§ä¼ªç»ˆç«¯ï¼ˆPseudo-Terminal Slaveï¼‰ã€‚åœ¨è¿™é‡Œï¼Œâ€œptsâ€ æ˜¯ä¼ªç»ˆç«¯çš„ç¼©å†™ï¼Œæ•°å­— â€œ1â€ æ˜¯è¿™ä¸ªä¼ªç»ˆç«¯çš„ç¼–å·ã€‚</p><ul><li><a href="https://linux265.com/course/linux-command-ps.html#:~:text=ps%E5%91%BD%E4%BB%A4%20-%20Linux%E5%91%BD%E4%BB%A4%E5%A4%A7%E5%85%A8%20%7C%20linux%E6%95%99%E7%A8%8B%20ps%E5%91%BD%E4%BB%A4,protoize%E5%91%BD%E4%BB%A4%20pssh%E5%91%BD%E4%BB%A4%20ps%E5%91%BD%E4%BB%A4%E6%98%AF%E2%80%9Cprocess%20status%E2%80%9D%E7%9A%84%E7%BC%A9%E5%86%99%EF%BC%8Cps%E5%91%BD%E4%BB%A4%E7%94%A8%E4%BA%8E%E6%98%BE%E7%A4%BA%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E3%80%82%20%E5%8F%AF%E4%BB%A5%E6%90%AD%E9%85%8Dkill%E6%8C%87%E4%BB%A4%E9%9A%8F%E6%97%B6%E4%B8%AD%E6%96%AD%E3%80%81%E5%88%A0%E9%99%A4%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E7%A8%8B%E5%BA%8F%E3%80%82%20ps%E5%91%BD%E4%BB%A4%E6%98%AF%E6%9C%80%E5%9F%BA%E6%9C%AC%E5%90%8C%E6%97%B6%E4%B9%9F%E6%98%AF%E9%9D%9E%E5%B8%B8%E5%BC%BA%E5%A4%A7%E7%9A%84%E8%BF%9B%E7%A8%8B%E6%9F%A5%E7%9C%8B%E5%91%BD%E4%BB%A4%EF%BC%8C%E4%BD%BF%E7%94%A8%E8%AF%A5%E5%91%BD%E4%BB%A4%E5%8F%AF%E4%BB%A5%E7%A1%AE%E5%AE%9A%E6%9C%89%E5%93%AA%E4%BA%9B%E8%BF%9B%E7%A8%8B%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E5%92%8C%E8%BF%90%E8%A1%8C%E7%9A%84%E7%8A%B6%E6%80%81%E3%80%81%E8%BF%9B%E7%A8%8B%E6%98%AF%E5%90%A6%E7%BB%93%E6%9D%9F%E3%80%81%E8%BF%9B%E7%A8%8B%E6%9C%89%E6%B2%A1%E6%9C%89%E5%83%B5%E6%AD%BB%E3%80%81%E5%93%AA%E4%BA%9B%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8%E4%BA%86%E8%BF%87%E5%A4%9A%E7%9A%84%E8%B5%84%E6%BA%90%E7%AD%89%E7%AD%89%EF%BC%8C%E6%80%BB%E4%B9%8B%E5%A4%A7%E9%83%A8%E5%88%86%E4%BF%A1%E6%81%AF%E9%83%BD%E6%98%AF%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E6%89%A7%E8%A1%8C%E8%AF%A5%E5%91%BD%E4%BB%A4%E5%BE%97%E5%88%B0%E7%9A%84%E3%80%82">pså‘½ä»¤</a></li></ul><p><strong>top</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240510195736332.png" alt="image-20240510195736332"></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€è¡Œ </span><br><span class="line">    <span class="number">34</span><span class="built_in">min</span> è¡¨ç¤ºè¿™å°æœºå™¨å·²ç»å¯åŠ¨<span class="number">34</span>åˆ†é’Ÿæ²¡æœ‰å…³æœºäº†</span><br><span class="line">    <span class="number">2</span>users è¡¨ç¤ºæœ‰<span class="number">2</span>ä¸ªç”¨æˆ·ç™»å½•</span><br><span class="line">    å¹³å‡è´Ÿè½½ï¼š<span class="number">1</span>åˆ†é’Ÿï¼Œ<span class="number">5</span>åˆ†é’Ÿï¼Œ<span class="number">15</span>åˆ†é’Ÿ</span><br><span class="line"></span><br><span class="line">ç¬¬äºŒè¡Œ</span><br><span class="line">    ä¸€å…±è¿è¡Œçš„ä»»åŠ¡ï¼Œå‡ ä¸ªåœ¨running ï¼Œå‡ ä¸ªåœ¨sleeping</span><br><span class="line"></span><br><span class="line">ç¬¬ä¸‰è¡Œï¼ˆå¹³å‡å€¼ï¼ŒæŒ‰ <span class="number">1</span> ä¼šæŠŠæ‰€æœ‰ é€»è¾‘cpu çš„ä½¿ç”¨æƒ…å†µåˆ—å‡ºæ¥ï¼‰</span><br><span class="line">    <span class="number">2.8</span> us  <span class="number">1.8</span> <span class="keyword">sy</span> <span class="number">97.7</span> id <span class="number">0.0</span> <span class="keyword">wa</span></span><br><span class="line">    us è¡¨ç¤ºç”¨æˆ·è®¡ç®—ï¼Œ<span class="keyword">sy</span>è¡¨ç¤ºè¿›ç¨‹ä¹‹é—´çŠ¶æ€äº¤äº’ï¼Œidè¡¨ç¤ºç©ºé—²ï¼Œ<span class="keyword">wa</span>è¡¨ç¤ºç£ç›˜ç­‰å¾…</span><br><span class="line"></span><br><span class="line">ç¬¬å››è¡Œ</span><br><span class="line">    å†…å­˜çŠ¶æ€</span><br><span class="line">ç¬¬äº”è¡Œ</span><br><span class="line">    äº¤æ¢åˆ†åŒºï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰</span><br></pre></td></tr></table></figure><p>è¿›ç¨‹çš„ä¼˜å…ˆçº§è°ƒæ•´</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">è°ƒæ•´ä¼˜å…ˆçº§</span><br><span class="line">    <span class="built_in">nice</span> èŒƒå›´ä» -20 åˆ° 19ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼ŒæŠ¢å èµ„æºå°±è¶Šå¤š</span><br><span class="line">        <span class="built_in">nice</span> -n 10 ./rest.sh  å¯åŠ¨çš„æ—¶å€™è°ƒæ•´ä¸º 10</span><br><span class="line">    renice é‡æ–°è®¾ç½®ä¼˜å…ˆçº§</span><br><span class="line">        renice -n 15 19312  å·²ç»å¤„äºå¯åŠ¨çš„æƒ…å†µä¸‹è¿›è¡Œè°ƒæ•´ã€‚æ ¹æ®è¿›ç¨‹å·</span><br><span class="line">è¿›ç¨‹çš„ä½œä¸šæ§åˆ¶</span><br><span class="line">    &amp;ç¬¦å·ï¼Œåå°è¿è¡Œ</span><br><span class="line">        ./test.sh &amp;</span><br><span class="line">    <span class="built_in">jobs</span> æŠŠå¤„äºåå°è¿è¡Œçš„ç¨‹åºè°ƒåˆ°å‰å°æ˜¾ç¤º</span><br><span class="line">        <span class="built_in">jobs</span> èƒ½å¾—åˆ°ä¸€ä¸ªç¼–å·</span><br><span class="line">        <span class="built_in">fg</span> ç¼–å·ï¼Œå¯ä»¥è°ƒåˆ°å‰å°</span><br><span class="line">    ctrl +zï¼ŒæŠŠå·²ç»å¤„äºå‰å°çš„ç¨‹åºè°ƒåˆ°åå°ï¼ŒçŠ¶æ€ä¼šstop</span><br></pre></td></tr></table></figure><h3 id="è¿›ç¨‹çš„é€šä¿¡æ–¹å¼-ä¿¡å·">è¿›ç¨‹çš„é€šä¿¡æ–¹å¼-ä¿¡å·</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä¿¡å·æ˜¯è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ä¹‹ä¸€ï¼Œå…¸å‹ç”¨æ³•æ˜¯ï¼šç»ˆç«¯ç”¨æˆ·è¾“å…¥ä¸­æ–­å‘½ä»¤ï¼Œé€šè¿‡ä¿¡å·æœºåˆ¶åœæ­¢ä¸€ä¸ªç¨‹åºçš„è¿è¡Œã€‚</span><br><span class="line">ä½¿ç”¨ä¿¡å·çš„å¸¸ç”¨å¿«æ·é”®å’Œå‘½ä»¤</span><br><span class="line"><span class="built_in">kill</span> -l æŸ¥çœ‹æ‰€æœ‰çš„ä¿¡å·</span><br><span class="line">    SIGINT é€šçŸ¥å‰å°è¿›ç¨‹ç»„ç»ˆæ­¢è¿›ç¨‹ ctrl + cï¼Œ2å·ä¿¡å·</span><br><span class="line">    SIGKILL ç«‹å³ç»“æŸç¨‹åºï¼Œä¸èƒ½è¢«é˜»å¡å’Œå¤„ç† <span class="built_in">kill</span> -9 pid ï¼Œ9å·ä¿¡å· </span><br></pre></td></tr></table></figure><h3 id="å®ˆæŠ¤è¿›ç¨‹å’Œç³»ç»Ÿæ—¥å¿—">å®ˆæŠ¤è¿›ç¨‹å’Œç³»ç»Ÿæ—¥å¿—</h3><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å®ˆæŠ¤è¿›ç¨‹ï¼ˆç²¾çµè¿›ç¨‹ï¼‰</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨ nohup ä¸ &amp; ç¬¦å·é…åˆè¿è¡Œä¸€ä¸ªå‘½ä»¤ ï¼ˆnohupè¿›ç¨‹ä¸æ˜¯å®ˆæŠ¤è¿›ç¨‹ï¼‰</span><br><span class="line">    nohup å‘½ä»¤ä½¿è¿›ç¨‹å¿½ç•¥ hangupï¼ˆæŒ‚èµ·ï¼‰ä¿¡å·ã€‚å…³æ‰ç»ˆç«¯è¿™ä¸ªè¿›ç¨‹ä¾ç„¶å¯ä»¥è¿è¡Œï¼Œå¿½ç•¥è¾“å…¥å¹¶ä¸”æŠŠè¾“å‡ºæ‰“å°åˆ° nohup.out</span><br><span class="line">å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰å’Œä¸€èˆ¬è¿›ç¨‹æœ‰ä»€ä¹ˆå·®åˆ«å‘¢ï¼Ÿ</span><br><span class="line">    å¼€æœºè‡ªå¯ï¼Œå®ˆæŠ¤è¿›ç¨‹ä¸éœ€è¦ç»ˆç«¯ï¼Œè¾“å‡ºå¯ä»¥æ‰“å°åˆ°ç‰¹æ®Šçš„æ–‡ä»¶ä¸­ï¼Œè¿›ç¨‹æ‰€å ç”¨çš„ç›®å½•æ˜¯æ ¹ç›®å½•ã€‚<span class="keyword">cd</span> /<span class="keyword">proc</span>/ è¿™ä¸ªç›®å½•æ˜¯å†…å­˜ä¿¡æ¯ï¼Œç›¸åº”çš„è¿›ç¨‹ä¼šæœ‰è¿›ç¨‹å·åŒåçš„ç›®å½•ã€‚</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨<span class="title"> screen</span> å‘½ä»¤ï¼Œè¿›å…¥screenç¯å¢ƒåï¼Œå¦‚æœè¿œç¨‹è¿æ¥æ–­æ‰äº†ï¼Œå¯ä»¥é€šè¿‡screenæ¢å¤å·¥ä½œç°åœº<span class="title"></span></span><br><span class="line"><span class="title">    screen</span> è¿›å…¥<span class="title"> screen</span> ç¯å¢ƒ<span class="title"></span></span><br><span class="line"><span class="title">    ctrl</span> +aç„¶åå†å•ç‹¬æŒ‰dé€€å‡ºï¼ˆdetachedï¼‰screen ç¯å¢ƒ<span class="title"></span></span><br><span class="line"><span class="title">    screen</span> -ls æŸ¥çœ‹<span class="title"> screen</span> çš„ä¼šè¯<span class="title"></span></span><br><span class="line"><span class="title">    screen</span> -r<span class="title"> sessionid</span> æ¢å¤ä¼šè¯ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ /var/logç³»ç»Ÿå¸¸è§„æ—¥å¿—ï¼šmessageså†…æ ¸è¿è¡Œæƒ…å†µï¼šdmesgå®‰å…¨æ—¥å¿—<span class="title">  secureå®šæ—¶ä»»åŠ¡æ—¥å¿—</span> cron</span><br></pre></td></tr></table></figure><h3 id="æœåŠ¡ç®¡ç†å·¥å…·systermctl">æœåŠ¡ç®¡ç†å·¥å…·systermctl</h3><p>æœåŠ¡ï¼ˆæä¾›å¸¸è§åŠŸèƒ½çš„å®ˆæŠ¤è¿›ç¨‹ï¼‰é›†ä¸­ç®¡ç†å·¥å…·</p><ul><li>service</li><li>systemctlï¼ˆcentos7ä»¥åçš„ï¼Œå¯ä»¥çœ‹åšserviceè¿›åŒ–ç‰ˆï¼‰</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">service å¯åŠ¨è„šæœ¬</span><br><span class="line"><span class="built_in">cd</span> /etc/init.d/ ç›®å½•ä¸‹</span><br><span class="line">vim network å¯ä»¥æŸ¥çœ‹networkçš„å¯åŠ¨è„šæœ¬ï¼Œ200å¤šè¡Œï¼Œå®Œå…¨ç”±ç¼–å†™äººå‘˜è‡ªå·±æ§åˆ¶ï¼Œæ¯”è¾ƒå¤æ‚ï¼›</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl å¯åŠ¨è„šæœ¬</span><br><span class="line"><span class="built_in">cd</span> /usr/lib/systemd/system/</span><br><span class="line">vim sshd.service</span><br><span class="line"></span><br><span class="line">åŸæœ‰çš„initï¼Œlinuxçš„1å·è¿›ç¨‹</span><br><span class="line">init 0 å…³æœº ï¼ˆä¸èƒ½ç”¨<span class="built_in">kill</span> -9æ€æ‰è¿™ä¸ªè¿›ç¨‹ï¼Œåªèƒ½0ç»“æŸè¿™ä¸ªè¿›ç¨‹ï¼Œè¿›è€Œå…³æœºï¼‰</span><br><span class="line">init 6 é‡å¯</span><br><span class="line">init  3 å­—ç¬¦ç»ˆç«¯</span><br><span class="line">init 5 å›¾å½¢ç•Œé¢</span><br><span class="line"></span><br><span class="line">systemctl å¸¸è§æ“ä½œ</span><br><span class="line">systemctl status|start|stop|restart|reload|<span class="built_in">enable</span>|<span class="built_in">disable</span> æœåŠ¡åç§°  </span><br><span class="line">1ã€restart å’Œreloadå·®åˆ«ï¼Œreloadä¸åœæœåŠ¡ï¼Œç›´æ¥é‡å¯</span><br><span class="line">2ã€<span class="built_in">enable</span>å¼€æœºå¯åŠ¨ï¼Œ<span class="built_in">disable</span>ä¸å¼€æœºå¯åŠ¨</span><br></pre></td></tr></table></figure><ul><li><a href="https://blog.csdn.net/qq_41308872/article/details/133743091">å®Œå…¨æŒ‡å—ï¼šsystemctlå‘½ä»¤åŠæœåŠ¡ç®¡ç†æŠ€å·§</a></li></ul><p>å¯åŠ¨Docker</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="literal">start</span> docker</span><br></pre></td></tr></table></figure><h3 id="SELinux">SELinux</h3><p>MACï¼ˆå¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼‰å’ŒDACï¼ˆè‡ªä¸»è®¿é—®æ§åˆ¶ï¼‰ã€‚SELinuxå°±æ˜¯ MACï¼Œç”Ÿäº§ç¯å¢ƒä¸å¤ªç”¨ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">æ ¹æ®è¿›ç¨‹pidæŸ¥ç«¯å£</span><br><span class="line"><span class="title">lsof</span> -i |grep pid</span><br><span class="line"></span><br><span class="line">æ ¹æ®ç«¯å£<span class="keyword">port</span>æŸ¥è¿›ç¨‹</span><br><span class="line">lsof -i:<span class="keyword">port</span></span><br><span class="line"></span><br><span class="line">æ ¹æ®è¿›ç¨‹pidæŸ¥ç«¯å£</span><br><span class="line">netstat -nap |grep pid</span><br><span class="line"></span><br><span class="line">æ ¹æ®ç«¯å£<span class="keyword">port</span>æŸ¥è¿›ç¨‹</span><br><span class="line">netstat -nap |grep <span class="keyword">port</span></span><br></pre></td></tr></table></figure><h2 id="å†…å­˜å’Œç£ç›˜ç®¡ç†">å†…å­˜å’Œç£ç›˜ç®¡ç†</h2><h3 id="å†…å­˜å’Œç£ç›˜ä½¿ç”¨ç‡æŸ¥çœ‹">å†…å­˜å’Œç£ç›˜ä½¿ç”¨ç‡æŸ¥çœ‹</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å†…å­˜ä½¿ç”¨ç‡æŸ¥çœ‹</span><br><span class="line">free</span><br><span class="line">    -m  ä»¥å…†çš„æ–¹å¼æ˜¾ç¤º</span><br><span class="line">    -g   ä»¥Gçš„æ–¹å¼æ˜¾ç¤ºï¼Œä½†æ˜¯ä¼šè¢«å››èˆäº”å…¥ã€‚ä¸€èˆ¬ä¸ç”¨</span><br><span class="line"><span class="built_in">top</span></span><br></pre></td></tr></table></figure><p>çœ‹çœ‹ç”µè„‘å…ˆ</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv$ free -m apport.log</span><br><span class="line">              æ€»è®¡         å·²ç”¨        ç©ºé—²      å…±äº«    ç¼“å†²/ç¼“å­˜    å¯ç”¨</span><br><span class="line">å†…å­˜ï¼š      <span class="number"> 64029 </span>     <span class="number"> 20697 </span>      <span class="number"> 2641 </span>       <span class="number"> 789 </span>     <span class="number"> 40690 </span>      41890</span><br><span class="line">äº¤æ¢ï¼š       <span class="number"> 2047 </span>       <span class="number"> 894 </span>       1153</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv$ free</span><br><span class="line">              æ€»è®¡         å·²ç”¨        ç©ºé—²      å…±äº«    ç¼“å†²/ç¼“å­˜    å¯ç”¨</span><br><span class="line">å†…å­˜ï¼š   <span class="number"> 65566072 </span>  <span class="number"> 21394584 </span>   <span class="number"> 2503952 </span>    <span class="number"> 808044 </span>  <span class="number"> 41667536 </span>   42695292</span><br><span class="line">äº¤æ¢ï¼š    <span class="number"> 2097148 </span>    <span class="number"> 916176 </span>    1180972</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv$ free -g</span><br><span class="line">              æ€»è®¡         å·²ç”¨        ç©ºé—²      å…±äº«    ç¼“å†²/ç¼“å­˜    å¯ç”¨</span><br><span class="line">å†…å­˜ï¼š         <span class="number"> 62 </span>        <span class="number"> 20 </span>         <span class="number"> 2 </span>         <span class="number"> 0 </span>        <span class="number"> 39 </span>         40</span><br><span class="line">äº¤æ¢ï¼š          <span class="number"> 1 </span>         <span class="number"> 0 </span>          1</span><br></pre></td></tr></table></figure><p>äº¤æ¢ç©ºé—´ï¼ˆSwap Spaceï¼‰æ˜¯ç¡¬ç›˜ä¸Šçš„ä¸€å—åŒºåŸŸï¼Œå®ƒè¢«æ“ä½œç³»ç»Ÿç”¨ä½œè™šæ‹Ÿå†…å­˜ï¼Œç”¨æ¥ä¸´æ—¶å­˜æ”¾å†…å­˜ä¸­çš„æ•°æ®ã€‚å½“ç³»ç»Ÿçš„ç‰©ç†å†…å­˜ç”¨å®Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†ä¸€äº›ä¸å¸¸ç”¨çš„æ•°æ®ç§»åŠ¨åˆ°äº¤æ¢ç©ºé—´ï¼Œä»è€Œé‡Šæ”¾å‡ºç‰©ç†å†…å­˜ç»™éœ€è¦çš„ç¨‹åºä½¿ç”¨ã€‚</p><p>ä¸ç”¨Swapçš„è¯å°±éšæœºæ€æ‰ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ç£ç›˜ä½¿ç”¨ç‡çš„æŸ¥çœ‹</span><br><span class="line">fdisk</span><br><span class="line">    -l æŸ¥çœ‹</span><br><span class="line">    ç£ç›˜åˆ†åŒºä¸€å—ç¡¬ç›˜æœ€å¤šåˆ†15ä¸ªåˆ†åŒº</span><br></pre></td></tr></table></figure><p>å®æ“</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv$ sudo fdisk -l</span><br><span class="line">[sudo] sv çš„å¯†ç ï¼š</span><br><span class="line">Disk /dev/loop1ï¼š4 KiBï¼Œ4096 å­—èŠ‚ï¼Œ8 ä¸ªæ‰‡åŒº</span><br><span class="line">å•å…ƒï¼šæ‰‡åŒº /<span class="number"> 1 </span>*<span class="number"> 512 </span>=<span class="number"> 512 </span>å­—èŠ‚</span><br><span class="line">æ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ /<span class="number"> 512 </span>å­—èŠ‚</span><br><span class="line">I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ /<span class="number"> 512 </span>å­—èŠ‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/loop2ï¼š6.77 MiBï¼Œ7081984 å­—èŠ‚ï¼Œ13832 ä¸ªæ‰‡åŒº</span><br><span class="line">å•å…ƒï¼šæ‰‡åŒº /<span class="number"> 1 </span>*<span class="number"> 512 </span>=<span class="number"> 512 </span>å­—èŠ‚</span><br><span class="line">æ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ /<span class="number"> 512 </span>å­—èŠ‚</span><br><span class="line">I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ /<span class="number"> 512 </span>å­—èŠ‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/loop3ï¼š40.44 MiBï¼Œ42393600 å­—èŠ‚ï¼Œ82800 ä¸ªæ‰‡åŒº</span><br><span class="line">å•å…ƒï¼šæ‰‡åŒº /<span class="number"> 1 </span>*<span class="number"> 512 </span>=<span class="number"> 512 </span>å­—èŠ‚</span><br><span class="line">æ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ /<span class="number"> 512 </span>å­—èŠ‚</span><br><span class="line">I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ /<span class="number"> 512 </span>å­—èŠ‚</span><br></pre></td></tr></table></figure><blockquote><p>é—®ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦å¯¹ç£ç›˜åˆ†åŒºï¼Ÿ</p></blockquote><p>ç£ç›˜åˆ†åŒºåŸºæœ¬ä¸Šæ˜¯æŠŠä¸€ä¸ªç£ç›˜åˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ªé€»è¾‘ç£ç›˜ã€‚æ¯ä¸ªåˆ†åŒºéƒ½åƒä¸€ä¸ªç‹¬ç«‹çš„ç¡¬ç›˜ä¸€æ ·ï¼Œæœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œç£ç›˜åˆ†åŒºé€šå¸¸è¢«è¡¨ç¤ºä¸ºä¸åŒçš„é©±åŠ¨å™¨ï¼Œå¦‚Cç›˜ã€Dç›˜ç­‰ã€‚å¯¹ç£ç›˜è¿›è¡Œåˆ†åŒºçš„åŸå› ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li><strong>æé«˜ç£ç›˜æ•ˆç‡</strong>ï¼šæ–‡ä»¶ç³»ç»Ÿé€šå¸¸ä¼šåœ¨ç£ç›˜ä¸Šç•™æœ‰ä¸€äº›ç©ºé—´ï¼Œè¿™æ ·å¯ä»¥æé«˜è¯»å†™é€Ÿåº¦ã€‚å¦‚æœä½ åªæœ‰ä¸€ä¸ªå¤§çš„åˆ†åŒºï¼Œé‚£ä¹ˆè¿™ä¸ªç©ºé—´å¯èƒ½å°±ä¼šæµªè´¹å¾ˆå¤šã€‚å¦‚æœä½ æœ‰å¤šä¸ªå°çš„åˆ†åŒºï¼Œé‚£ä¹ˆæ¯ä¸ªåˆ†åŒºçš„ç©ºé—´éƒ½ä¼šæ›´åŠ åˆç†åœ°åˆ©ç”¨ã€‚</li><li><strong>æ•°æ®å®‰å…¨</strong>ï¼šå¦‚æœä½ çš„æ“ä½œç³»ç»Ÿå´©æºƒï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæŸåæ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚å¦‚æœä½ æœ‰å¤šä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆä¸€ä¸ªåˆ†åŒºçš„æŸåä¸ä¼šå½±å“å…¶ä»–åˆ†åŒºã€‚è¿™æ ·ï¼Œä½ çš„æ•°æ®å°±æ›´å®‰å…¨äº†ã€‚</li><li><strong>å¤šæ“ä½œç³»ç»Ÿ</strong>ï¼šå¦‚æœä½ æƒ³åœ¨ä¸€å°è®¡ç®—æœºä¸Šå®‰è£…å¤šä¸ªæ“ä½œç³»ç»Ÿï¼Œé‚£ä¹ˆä½ éœ€è¦ä¸ºæ¯ä¸ªæ“ä½œç³»ç»Ÿåˆ›å»ºä¸€ä¸ªåˆ†åŒºã€‚è¿™æ ·ï¼Œæ¯ä¸ªæ“ä½œç³»ç»Ÿéƒ½å¯ä»¥åœ¨è‡ªå·±çš„åˆ†åŒºä¸Šè¿è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚</li><li><strong>æ–‡ä»¶ç»„ç»‡</strong>ï¼šåˆ†åŒºå¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°ç»„ç»‡æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªåˆ†åŒºä¸Šå­˜å‚¨ç³»ç»Ÿæ–‡ä»¶ï¼Œåœ¨å¦ä¸€ä¸ªåˆ†åŒºä¸Šå­˜å‚¨ä¸ªäººæ–‡ä»¶ã€‚è¿™æ ·ï¼Œå³ä½¿ç³»ç»Ÿåˆ†åŒºå‡ºç°é—®é¢˜ï¼Œä½ çš„ä¸ªäººæ–‡ä»¶ä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚</li></ol><p>ä»¥ä¸Šå°±æ˜¯å¯¹ç£ç›˜è¿›è¡Œåˆ†åŒºçš„ä¸»è¦åŸå› ã€‚</p><p><strong>æ¯ä¸ªç£ç›˜åˆ†åŒºéƒ½å¯ä»¥è¢«æ ¼å¼åŒ–ä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> æ—¢èƒ½å¤Ÿçœ‹åˆ°åˆ†åŒºï¼Œåˆèƒ½å¤Ÿçœ‹åˆ°æŒ‚è½½åˆ°çš„ç›®å½•</span><br><span class="line">    -h äººæ€§åŒ–å¯è¯»</span><br><span class="line">ç³»ç»Ÿä¸­å„ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ</span><br></pre></td></tr></table></figure><p>å®æ“</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(base) sv<span class="variable">@sv</span>-<span class="symbol">NF5280M5:</span>/dev<span class="variable">$ </span>df -h</span><br><span class="line">æ–‡ä»¶ç³»ç»Ÿ        å®¹é‡  å·²ç”¨  å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹</span><br><span class="line">udev             <span class="number">32</span>G     <span class="number">0</span>   <span class="number">32</span>G    <span class="number">0</span>% <span class="regexp">/dev</span></span><br><span class="line"><span class="regexp">tmpfs           6.3G  2.8M  6.3G    1% /run</span></span><br><span class="line"><span class="regexp">/dev/sda</span>2       <span class="number">439</span>G  <span class="number">253</span>G  <span class="number">165</span>G   <span class="number">61</span>% <span class="regexp">/</span></span><br><span class="line"><span class="regexp">tmpfs            32G  396K   32G    1% /dev</span><span class="regexp">/shm</span></span><br><span class="line"><span class="regexp">tmpfs           5.0M  4.0K  5.0M    1% /run</span><span class="regexp">/lock</span></span><br><span class="line"><span class="regexp">tmpfs            32G     0   32G    0% /sys</span><span class="regexp">/fs/cgroup</span></span><br><span class="line"><span class="regexp">/dev/loop</span>1      <span class="number">128</span>K  <span class="number">128</span>K     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/bare</span><span class="regexp">/5</span></span><br><span class="line"><span class="regexp">/dev</span><span class="regexp">/loop4       56M   56M     0  100% /snap</span><span class="regexp">/core18/</span><span class="number">2812</span></span><br><span class="line"><span class="regexp">/dev/loop</span>5       <span class="number">64</span>M   <span class="number">64</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/core</span>20/<span class="number">2182</span></span><br><span class="line"><span class="regexp">/dev/loop</span>6       <span class="number">75</span>M   <span class="number">75</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/core</span>22/<span class="number">1122</span></span><br><span class="line"><span class="regexp">/dev/loop</span>18     <span class="number">350</span>M  <span class="number">350</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/gnome</span>-<span class="number">3</span>-<span class="number">38</span>-<span class="number">2004</span>/<span class="number">140</span></span><br><span class="line"><span class="regexp">/dev/loop</span>17      <span class="number">13</span>M   <span class="number">13</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/snap</span>-store/<span class="number">959</span></span><br><span class="line"><span class="regexp">/dev/loop</span>13     <span class="number">350</span>M  <span class="number">350</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/gnome</span>-<span class="number">3</span>-<span class="number">38</span>-<span class="number">2004</span>/<span class="number">143</span></span><br><span class="line"><span class="regexp">/dev/loop</span>19      <span class="number">92</span>M   <span class="number">92</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/gtk</span>-common-themes/<span class="number">1535</span></span><br><span class="line"><span class="regexp">/dev/loop</span>14     <span class="number">219</span>M  <span class="number">219</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/gnome</span>-<span class="number">3</span>-<span class="number">34</span>-<span class="number">1804</span>/<span class="number">90</span></span><br><span class="line"><span class="regexp">/dev/loop</span>12      <span class="number">82</span>M   <span class="number">82</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/gtk</span>-common-themes/<span class="number">1534</span></span><br><span class="line"><span class="regexp">/dev/loop</span>10     <span class="number">219</span>M  <span class="number">219</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/gnome</span>-<span class="number">3</span>-<span class="number">34</span>-<span class="number">1804</span>/<span class="number">93</span></span><br><span class="line"><span class="regexp">/dev/sda</span>1       <span class="number">511</span>M  <span class="number">6.1</span>M  <span class="number">505</span>M    <span class="number">2</span>% <span class="regexp">/boot/efi</span></span><br><span class="line"><span class="regexp">/dev/sdb</span>2       <span class="number">3.6</span>T  <span class="number">420</span>G  <span class="number">3.0</span>T   <span class="number">13</span>% <span class="regexp">/data</span></span><br><span class="line"><span class="regexp">tmpfs           6.3G   76K  6.3G    1% /run</span><span class="regexp">/user/</span><span class="number">1000</span></span><br><span class="line"><span class="regexp">/dev/loop</span>21      <span class="number">40</span>M   <span class="number">40</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/snapd</span><span class="regexp">/21184</span></span><br><span class="line"><span class="regexp">/dev</span><span class="regexp">/loop2      6.9M  6.9M     0  100% /snap</span><span class="regexp">/ngrok/</span><span class="number">138</span></span><br><span class="line"><span class="regexp">/dev/loop</span>9      <span class="number">505</span>M  <span class="number">505</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/gnome</span>-<span class="number">42</span>-<span class="number">2204</span>/<span class="number">172</span></span><br><span class="line"><span class="regexp">/dev/loop</span>16      <span class="number">13</span>M   <span class="number">13</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/snap</span>-store/<span class="number">1113</span></span><br><span class="line"><span class="regexp">/dev/loop</span>20      <span class="number">64</span>M   <span class="number">64</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/core</span>20/<span class="number">2264</span></span><br><span class="line"><span class="regexp">/dev/loop</span>11     <span class="number">506</span>M  <span class="number">506</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/gnome</span>-<span class="number">42</span>-<span class="number">2204</span>/<span class="number">176</span></span><br><span class="line"><span class="regexp">/dev/loop</span>22     <span class="number">7.0</span>M  <span class="number">7.0</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/ngrok</span><span class="regexp">/148</span></span><br><span class="line"><span class="regexp">/dev</span><span class="regexp">/loop15      75M   75M     0  100% /snap</span><span class="regexp">/core22/</span><span class="number">1380</span></span><br><span class="line"><span class="regexp">/dev/loop</span>8       <span class="number">39</span>M   <span class="number">39</span>M     <span class="number">0</span>  <span class="number">100</span>% <span class="regexp">/snap/snapd</span><span class="regexp">/21465</span></span><br><span class="line"><span class="regexp">/dev</span><span class="regexp">/loop23      56M   56M     0  100% /snap</span><span class="regexp">/core18/</span><span class="number">2823</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œ<code>tmpfs</code>ã€<code>udev</code>å’Œ<code>/dev/sda2</code>éƒ½æ˜¯ä½ çš„ç³»ç»ŸæŒ‚è½½ç‚¹ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><ol><li><p><strong>tmpfs</strong>ï¼štmpfsæ˜¯ä¸€ç§åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå°†ä¸€éƒ¨åˆ†RAMä½œä¸ºä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œå…è®¸ä½ åƒæ“ä½œç£ç›˜åˆ†åŒºä¸€æ ·æ“ä½œå†…å­˜ã€‚å› ä¸ºå®ƒå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥è¯»å†™é€Ÿåº¦éå¸¸å¿«ã€‚ç„¶è€Œï¼Œä¸€æ—¦ç³»ç»Ÿé‡å¯ï¼Œå­˜å‚¨åœ¨tmpfsä¸­çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šä¸¢å¤±ã€‚</p></li><li><p><strong>udev</strong>ï¼šudevæ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŠ¨æ€è®¾å¤‡ç®¡ç†å™¨ï¼Œå®ƒç®¡ç†<code>/dev</code>ç›®å½•ä¸‹çš„è®¾å¤‡èŠ‚ç‚¹ã€‚udevå…è®¸è®¾å¤‡ç®¡ç†å·¥ä½œåœ¨ç”¨æˆ·ç©ºé—´ä¸­å®Œæˆï¼Œæä¾›äº†ä¸€ç§çµæ´»çš„æ–¹å¼æ¥ç®¡ç†è®¾å¤‡èŠ‚ç‚¹ï¼Œå¹¶å…è®¸é€šè¿‡è®¾å¤‡çš„ç‰©ç†å±æ€§æˆ–è€…çƒ­æ’æ‹”äº‹ä»¶æ¥æ”¹å˜è®¾å¤‡çš„é…ç½®ã€‚</p><ul><li><p>udevå°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªåŠ¨æ€è®¾å¤‡ç®¡ç†å™¨ã€‚å½“ä¸€ä¸ªè®¾å¤‡è¢«æ¥å…¥åˆ°ç³»ç»Ÿä¸­ï¼Œudevä¼šæ ¹æ®è®¾å¤‡çš„ç±»å‹å’Œå±æ€§ï¼ŒåŠ¨æ€åœ°åœ¨<code>/dev</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹ï¼Œè¿™æ ·åº”ç”¨ç¨‹åºå°±å¯ä»¥é€šè¿‡è¿™ä¸ªè®¾å¤‡èŠ‚ç‚¹æ¥è®¿é—®è®¾å¤‡ã€‚å½“è®¾å¤‡è¢«ç§»é™¤æ—¶ï¼Œudevä¼šåˆ é™¤å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹ã€‚</p><p>ä¾‹å¦‚ï¼Œå½“ä½ æ’å…¥ä¸€ä¸ªUSBè®¾å¤‡æ—¶ï¼Œudevä¼šåœ¨<code>/dev</code>ä¸‹åˆ›å»ºä¸€ä¸ªåƒæ˜¯<code>sdb1</code>çš„è®¾å¤‡èŠ‚ç‚¹ï¼Œä½ å°±å¯ä»¥é€šè¿‡è¿™ä¸ªè®¾å¤‡èŠ‚ç‚¹æ¥è®¿é—®ä½ çš„USBè®¾å¤‡ã€‚å½“ä½ ç§»é™¤USBè®¾å¤‡æ—¶ï¼Œ<code>/dev/sdb1</code>è¿™ä¸ªè®¾å¤‡èŠ‚ç‚¹å°±ä¼šè¢«åˆ é™¤ã€‚</p></li></ul></li><li><p><strong>/dev/sdaX</strong>ï¼š<code>/dev/sda2</code> å’Œ <code>/dev/sdb2</code> è¿™ä¸¤ä¸ªè®¾å¤‡ã€‚è¿™é‡Œçš„ <code>sda</code> å’Œ <code>sdb</code> åˆ†åˆ«ä»£è¡¨ç³»ç»Ÿä¸­çš„ç¬¬ä¸€å—å’Œç¬¬äºŒå—ç¡¬ç›˜ï¼Œè€Œåé¢çš„æ•°å­— <code>2</code> è¡¨ç¤ºçš„æ˜¯è¿™ä¸ªç¡¬ç›˜ä¸Šçš„ç¬¬äºŒä¸ªåˆ†åŒºã€‚</p></li></ol><p>è‡³äºä¸ºä»€ä¹ˆä½ åœ¨<code>fdisk -l</code>çš„è¾“å‡ºä¸­çœ‹ä¸åˆ°è¿™äº›åˆ†åŒºï¼Œ<strong>è¿™æ˜¯å› ä¸º<code>fdisk</code>åªæ˜¾ç¤ºç‰©ç†ç£ç›˜åˆ†åŒº</strong>ï¼Œè€Œä¸æ˜¾ç¤ºåŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚tmpfsï¼‰æˆ–ç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚udevï¼‰ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>df -h</code>æˆ–<code>mount</code>å‘½ä»¤æ¥æŸ¥çœ‹æ‰€æœ‰çš„æŒ‚è½½ç‚¹å’Œæ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬<code>tmpfs</code>å’Œ<code>udev</code>ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">du</span> ï¼ˆå®é™…å ç”¨çš„ç©ºé—´ï¼‰</span><br><span class="line">    -h äººæ€§åŒ–æ˜¾ç¤º</span><br><span class="line">    -s  åªæ˜¾ç¤ºæ€»è®¡</span><br></pre></td></tr></table></figure><p>æŒ‚è½½ç‚¹å°±æ˜¯è¿™äº›ç‰©ç†è®¾å¤‡åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½ç½®ã€‚å½“ä¸€ä¸ªè®¾å¤‡è¢«&quot;æŒ‚è½½&quot;åˆ°ä¸€ä¸ªæŒ‚è½½ç‚¹æ—¶ï¼Œè¿™ä¸ªè®¾å¤‡çš„å†…å®¹å°±å¯ä»¥é€šè¿‡è®¿é—®è¿™ä¸ªæŒ‚è½½ç‚¹æ¥è®¿é—®äº†ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æ’å…¥ä¸€ä¸ªUSBé©±åŠ¨å™¨ï¼Œç³»ç»Ÿå¯èƒ½ä¼šè‡ªåŠ¨å°†è¿™ä¸ªé©±åŠ¨å™¨æŒ‚è½½åˆ°<code>/media/your_username/usb_drive</code>è¿™ä¸ªç›®å½•ä¸‹ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥é€šè¿‡è®¿é—®è¿™ä¸ªç›®å½•æ¥æŸ¥çœ‹å’Œæ“ä½œè¿™ä¸ªUSBé©±åŠ¨å™¨çš„å†…å®¹ã€‚</p><p><strong>duä¸lsçš„åŒºåˆ«</strong><br><strong>du æ˜¯å®é™…å ç”¨çš„ï¼Œlsç®—ä¸Šç©ºæ´æ•°æ®ã€‚</strong></p><h3 id="å¸¸è§æ–‡ä»¶ç³»ç»Ÿ">å¸¸è§æ–‡ä»¶ç³»ç»Ÿ</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Linux æ”¯æŒå¤šç§æ–‡ä»¶ç³»ç»Ÿï¼Œå¸¸è§çš„æœ‰</span><br><span class="line">ext4ï¼ˆcentos6ï¼‰</span><br><span class="line">xfsï¼ˆcentos7ï¼‰</span><br><span class="line">NTFSï¼ˆéœ€å®‰è£…é¢å¤–è½¯ä»¶ï¼Œ<span class="built_in">window</span>å¸¸ç”¨ï¼Œæœ‰ç‰ˆæƒï¼‰</span><br></pre></td></tr></table></figure><p>ext4æ–‡ä»¶ç³»ç»Ÿ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ext4æ–‡ä»¶ç³»ç»ŸåŸºæœ¬ç»“æ„æ¯”è¾ƒå¤æ‚</span><br><span class="line">è¶…çº§å—</span><br><span class="line">è¶…çº§å—å‰¯æœ¬</span><br><span class="line"><span class="selector-tag">i</span>èŠ‚ç‚¹ï¼ˆinodeï¼‰</span><br><span class="line">æ•°æ®å—ï¼ˆdatablockï¼‰</span><br></pre></td></tr></table></figure><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/LANet</span><span class="variable">$ </span>du -h utils.py</span><br><span class="line"><span class="number">4</span>.0K    utils.py</span><br><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/LANet</span><span class="variable">$ </span>ls -l utils.py</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">3322</span> <span class="number">11</span>æœˆ <span class="number">17</span> <span class="number">15</span><span class="symbol">:</span><span class="number">51</span> utils.py</span><br><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/LANet</span><span class="variable">$ </span>ls -li utils.py</span><br><span class="line"><span class="number">19200499</span> -rw-r--r-- <span class="number">1</span> root root <span class="number">3322</span> <span class="number">11</span>æœˆ <span class="number">17</span> <span class="number">15</span><span class="symbol">:</span><span class="number">51</span> utils.py</span><br></pre></td></tr></table></figure><blockquote><p>ä¸ºç¤¾ä¹ˆvimä¼šæ”¹å˜ièŠ‚ç‚¹ï¼Œechoä¸ä¼šæ”¹å˜ièŠ‚ç‚¹</p></blockquote><p>Vimå’Œechoå‘½ä»¤åœ¨å¤„ç†æ–‡ä»¶æ—¶çš„è¡Œä¸ºç¡®å®æœ‰æ‰€ä¸åŒã€‚</p><p>å½“ä½ ä½¿ç”¨Vimç¼–è¾‘å¹¶ä¿å­˜ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼ŒVimå®é™…ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶æ¥æ›¿ä»£æ—§çš„æ–‡ä»¶ã€‚è¿™ä¸ªæ–°æ–‡ä»¶ä¼šæœ‰ä¸€ä¸ªæ–°çš„ièŠ‚ç‚¹ï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°ièŠ‚ç‚¹çš„æ•°å€¼å‘ç”Ÿäº†å˜åŒ–ã€‚</p><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¦‚æœåœ¨ä¿å­˜æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼ˆæ¯”å¦‚ç£ç›˜ç©ºé—´ä¸è¶³ï¼‰ï¼Œä½ ä»ç„¶å¯ä»¥ä¿ç•™åŸæ¥çš„æ–‡ä»¶ï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ã€‚åŒæ—¶ï¼ŒVimè¿˜ä¼šè®°å½•ä¸‹æ¯æ¬¡ä¿®æ”¹çš„æ—¶é—´å’Œç”¨æˆ·ç­‰ä¿¡æ¯ã€‚</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œechoå‘½ä»¤åˆ™æ›´ç®€å•ã€‚å®ƒç›´æ¥å°†è¾“å‡ºè¿½åŠ åˆ°æ–‡ä»¶ä¸­ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„æ–‡ä»¶ï¼Œå› æ­¤ièŠ‚ç‚¹çš„æ•°å€¼ä¸ä¼šæ”¹å˜ã€‚</p><p>å¦å¤–ï¼Œæ–‡ä»¶çš„æƒé™ä¹Ÿå¯èƒ½å½±å“ièŠ‚ç‚¹çš„å˜åŒ–ã€‚å¦‚æœæ–‡ä»¶æ²¡æœ‰å†™æƒé™ï¼ŒVimåœ¨ä¿å­˜æ—¶ä¼šåˆ›å»ºæ–°çš„æ–‡ä»¶ï¼Œä»è€Œæ”¹å˜ièŠ‚ç‚¹ã€‚å¦‚æœä½ ç»™æ–‡ä»¶æ·»åŠ äº†å†™æƒé™ï¼ˆæ¯”å¦‚ä½¿ç”¨<code>chmod o+w filename</code>å‘½ä»¤ï¼‰ï¼Œåˆ™Vimåœ¨ä¿å­˜æ—¶ä¸ä¼šæ”¹å˜ièŠ‚ç‚¹ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤åœ¨å¤„ç†æ–‡ä»¶æ—¶çš„è¡Œä¸ºå·®å¼‚ï¼Œåæ˜ äº†å®ƒä»¬çš„è®¾è®¡ç†å¿µå’Œä½¿ç”¨åœºæ™¯çš„ä¸åŒã€‚Vimæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå®ƒæä¾›äº†ä¸°å¯Œçš„ç¼–è¾‘åŠŸèƒ½å’Œæ•°æ®ä¿æŠ¤æœºåˆ¶ï¼›è€Œechoæ›´å¤šåœ°è¢«ç”¨æ¥åœ¨è„šæœ¬ä¸­è¾“å‡ºæ–‡æœ¬æˆ–è€…ç®€å•åœ°å‘æ–‡ä»¶ä¸­è¿½åŠ å†…å®¹ã€‚</p><p><strong>rmåªæ˜¯å°†ièŠ‚ç‚¹å’Œæ•°æ®å—æ–­å¼€</strong></p><p>å› æ­¤æœ‰äº†lnå‘½ä»¤ï¼Œçœ‹ä¸ªä¾‹å­ï¼Œç¡¬é“¾æ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">ls</span> -li utils.py</span><br><span class="line">19200499 -rw-r--r-- 1 root root 3322 11æœˆ 17 15:51 utils.py</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">ls</span> -li utils.py</span><br><span class="line">19200499 -rw-r--r-- 1 root root 3322 11æœˆ 17 15:51 utils.py</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">ln</span> utils.py utils1.py</span><br><span class="line"><span class="built_in">ln</span>: æ— æ³•åˆ›å»ºç¡¬é“¾æ¥ <span class="string">&#x27;utils1.py&#x27;</span> =&gt; <span class="string">&#x27;utils.py&#x27;</span>: ä¸å…è®¸çš„æ“ä½œ</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">ls</span> -li utils.py</span><br><span class="line">19200499 -rw-r--r-- 1 root root 3322 11æœˆ 17 15:51 utils.py</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ sudo <span class="built_in">ln</span> utils.py utils1.py</span><br><span class="line">[sudo] sv çš„å¯†ç ï¼š</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">ls</span> -li utils.py</span><br><span class="line">19200499 -rw-r--r-- 2 root root 3322 11æœˆ 17 15:51 utils.py</span><br></pre></td></tr></table></figure><p>è½¯è¿æ¥ï¼šä¸åŒåˆ†åŒº</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/LANet</span><span class="variable">$ </span>ls -li utils.py</span><br><span class="line"><span class="number">19200499</span> -rw-r--r-- <span class="number">1</span> root root <span class="number">3322</span> <span class="number">11</span>æœˆ <span class="number">17</span> <span class="number">15</span><span class="symbol">:</span><span class="number">51</span> utils.py</span><br><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/LANet</span><span class="variable">$ </span>ls -li utils1.py</span><br><span class="line"><span class="number">19200215</span> lrwxrwxrwx <span class="number">1</span> sv sv <span class="number">8</span> <span class="number">5</span>æœˆ  <span class="number">10</span> <span class="number">21</span><span class="symbol">:</span><span class="number">19</span> utils1.py -&gt; utils.py</span><br></pre></td></tr></table></figure><blockquote><p><strong>ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥çš„åŒºåˆ«</strong></p></blockquote><p>ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥ï¼ˆä¹Ÿè¢«ç§°ä¸ºç¬¦å·é“¾æ¥ï¼‰éƒ½æ˜¯Unixå’ŒLinuxæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ¦‚å¿µï¼Œå®ƒä»¬æ˜¯æ–‡ä»¶çš„ä¸¤ç§ä¸åŒç±»å‹çš„é“¾æ¥ã€‚</p><ol><li><strong>ç¡¬é“¾æ¥</strong>ï¼šç¡¬é“¾æ¥æ˜¯ä¸€ä¸ªæŒ‡å‘æ–‡ä»¶çš„ièŠ‚ç‚¹çš„å¼•ç”¨ã€‚ièŠ‚ç‚¹æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­å­˜å‚¨æ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¦‚æ–‡ä»¶å¤§å°ã€åˆ›å»ºæ—¥æœŸç­‰ï¼‰çš„æ•°æ®ç»“æ„ã€‚ç¡¬é“¾æ¥å¯ä»¥çœ‹ä½œæ˜¯åŒä¸€æ–‡ä»¶çš„ä¸åŒåå­—ï¼Œå®ƒä»¬å¯ä»¥ä½äºåŒä¸€æ–‡ä»¶ç³»ç»Ÿçš„ä¸åŒä½ç½®ï¼Œä½†éƒ½æŒ‡å‘åŒä¸€ièŠ‚ç‚¹ã€‚åˆ é™¤ä¸€ä¸ªç¡¬é“¾æ¥ä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ç¡¬é“¾æ¥ï¼Œå› ä¸ºå®ƒä»¬éƒ½ç›´æ¥æŒ‡å‘åŒä¸€ièŠ‚ç‚¹ã€‚ã€å–åˆ«åã€‘</li><li><strong>è½¯é“¾æ¥</strong>ï¼šè½¯é“¾æ¥ï¼ˆæˆ–ç¬¦å·é“¾æ¥ï¼‰åˆ™ç±»ä¼¼äºWindowsä¸­çš„å¿«æ·æ–¹å¼ã€‚å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼ŒåŒ…å«äº†æŒ‡å‘å¦ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„è·¯å¾„ã€‚è½¯é“¾æ¥å¯ä»¥è·¨è¶Šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½†å¦‚æœç›®æ ‡æ–‡ä»¶è¢«åˆ é™¤ï¼Œè½¯é“¾æ¥å°±ä¼šå˜ä¸ºæ— æ•ˆã€‚ã€å­˜è·¯å¾„ã€‘</li></ol><p>ä¸‹é¢æ˜¯å®ƒä»¬ä¹‹é—´çš„ä¸»è¦åŒºåˆ«ï¼š</p><ul><li><strong>å­˜å‚¨æ–¹å¼</strong>ï¼šç¡¬é“¾æ¥æ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ièŠ‚ç‚¹ï¼Œå®ƒä¸åŸæ–‡ä»¶å…±äº«ièŠ‚ç‚¹ï¼Œè€Œè½¯é“¾æ¥æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸­åŒ…å«äº†æŒ‡å‘åŸæ–‡ä»¶çš„è·¯å¾„ã€‚</li><li><strong>è·¨æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼šç¡¬é“¾æ¥ä»…é™äºåœ¨åŒä¸€æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œè€Œè½¯é“¾æ¥å¯ä»¥é“¾æ¥åˆ°å…¶ä»–æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ã€‚</li><li><strong>é“¾æ¥ç›®å½•</strong>ï¼šé€šå¸¸ï¼Œç¡¬é“¾æ¥ä¸èƒ½é“¾æ¥ç›®å½•ï¼Œè€Œè½¯é“¾æ¥å¯ä»¥ã€‚</li><li><strong>åˆ é™¤åŸæ–‡ä»¶</strong>ï¼šå½“åŸæ–‡ä»¶è¢«åˆ é™¤åï¼Œç¡¬é“¾æ¥ä»ç„¶å¯ä»¥è®¿é—®æ–‡ä»¶çš„å†…å®¹ï¼Œè€Œè½¯é“¾æ¥åˆ™ä¼šå¤±æ•ˆã€‚</li></ul><p>è¿™å°±æ˜¯ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥çš„åŸºæœ¬åŒºåˆ«ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©ä½¿ç”¨ç¡¬é“¾æ¥æˆ–è½¯é“¾æ¥ã€‚</p><h3 id="ç£ç›˜åˆ†åŒºå’ŒæŒ‚è½½">ç£ç›˜åˆ†åŒºå’ŒæŒ‚è½½</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">å¸¸ç”¨å‘½ä»¤</span><br><span class="line">fdisk</span><br><span class="line">mkfs</span><br><span class="line">parted</span><br><span class="line">mount</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¸¸è§é…ç½®æ–‡ä»¶</span><br><span class="line">/etc/fstab</span><br><span class="line"></span><br><span class="line">ç”¨fdiskåˆ›å»ºåˆ†åŒºï¼ˆä¸€ä¸ªç¡¬ç›˜è®¾å¤‡å¯ä»¥åˆ›å»ºå¤šä¸ªåˆ†åŒºï¼Œä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªï¼‰</span><br><span class="line">1ï¼šfdisk -l æŸ¥çœ‹æœ‰å‡ ä¸ªç¡¬ç›˜è®¾å¤‡åŠåˆ†åŒº</span><br><span class="line">2ï¼šfdisk /dev/sdc    ï¼ˆæ¯”å¦‚æœ‰è®¾å¤‡sdcï¼Œåˆ™å¯ä»¥é’ˆå¯¹sdcè¿›è¡Œåˆ†åŒºï¼‰</span><br><span class="line">3ï¼šä¹‹å m é”®æ˜¯å¸®åŠ©</span><br><span class="line">4ï¼šn è¡¨ç¤ºæ–°å»ºä¸€ä¸ªåˆ†åŒº</span><br><span class="line">5ï¼šæ–°å»ºåˆ†åŒºæ—¶ï¼Œéœ€è¦é€‰æ‹©ä¸»åˆ†åŒºå’Œæ‰©å±•åˆ†åŒºï¼Œå…¶ä¸­ pè¡¨ç¤ºä¸»åˆ†åŒºï¼Œæœ€å¤šæœ‰4ä¸ªã€‚eè¡¨ç¤ºæ‰©å±•åˆ†åŒºï¼ˆé‡Œé¢å¯ä»¥å»ºç«‹é€»è¾‘åˆ†åŒºï¼‰ã€‚ä¸€èˆ¬æŠŠä¸€å—ç¡¬ç›˜åˆ’åˆ†ä¸ºä¸€ä¸ªä¸»åˆ†åŒºã€‚ä½¿ç”¨æ‰©å±•åˆ†åŒºæ—¶ï¼Œåªèƒ½å»ºç«‹3ä¸ªä¸»åˆ†åŒºã€‚</span><br><span class="line">6ï¼šé€‰æ‹©åŒºåˆ†ç¼–å·1-4</span><br><span class="line">7ï¼šæŒ‡å®šåˆ†åŒºæ‰‡åŒºå¤§å°ï¼Œé»˜è®¤2048</span><br><span class="line">8ï¼šæŒ‡å®šåˆ†åŒºå¤§å°ã€‚é»˜è®¤å…¨éƒ¨ã€‚å¯ä»¥ + 20Gç­‰å¯ä»¥é€‰æ‹©åˆ†åŒºå¤§å°</span><br><span class="line">9ï¼šq è¡¨ç¤ºé€€å‡ºï¼Œåˆ†åŒºä¸ç”Ÿæ•ˆã€‚w è¡¨ç¤ºç”Ÿæ•ˆ</span><br><span class="line"></span><br><span class="line">å»ºç«‹å®Œåˆ†åŒºåï¼Œéœ€è¦å¯¹åˆ†åŒºè¿›è¡Œæ ¼å¼åŒ–ã€‚</span><br><span class="line"></span><br><span class="line">mkfs.ext4  mkfs.xfsç­‰å‘½ä»¤</span><br><span class="line">mkfs.ext4 /dev/sdc1</span><br><span class="line"></span><br><span class="line">ç„¶åè¦è¿›è¡Œæ“ä½œï¼Œlinuxé‡Œéƒ½æ˜¯æ–‡ä»¶çº§åˆ«çš„æ“ä½œï¼Œéœ€è¦æŒ‚è½½åˆ°æŸä¸ªç›®å½•ä¸‹</span><br><span class="line"><span class="built_in">mkdir</span> /mnt/sdc1</span><br><span class="line">mount /dev/sdc1 /mnt/sdc1 æŒ‚è½½ä¸Šå»</span><br><span class="line">å¯¹/mnt/sdc1çš„è¯»å†™å°±ä¼šè½å…¥sdc1è®¾å¤‡ä¸Š</span><br><span class="line"></span><br><span class="line">1ã€ä¸€ä¸ªç¡¬ç›˜</span><br><span class="line">2ã€è¿›è¡Œåˆ†åŒº</span><br><span class="line">3ã€æ ¼å¼åŒ–</span><br><span class="line">4ã€æŒ‚è½½</span><br><span class="line">5ã€å¯¹æŒ‡å®šç›®å½•è¿›è¡Œæ“ä½œ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">éœ€è¦æ³¨æ„çš„äº‹æƒ…ï¼š</span><br><span class="line">å¦‚æœä¸€ä¸ªç¡¬ç›˜å¤§äº 2T ï¼Œä¸èƒ½ä½¿ç”¨ fdisk è¿›è¡Œåˆ†åŒºï¼Œéœ€è¦ä½¿ç”¨ parted</span><br><span class="line">parted /dev/sdd</span><br><span class="line"><span class="built_in">help</span> è·å–å¸®åŠ©</span><br><span class="line"></span><br><span class="line">mount è¿›è¡ŒæŒ‚è½½æ˜¯ä¸´æ—¶çš„ï¼Œä¸æ˜¯å›ºåŒ–çš„</span><br><span class="line">vim /etc/fstab</span><br><span class="line">åœ¨æ–‡ä»¶ä¸­æ–°å¢ä¸‹é¢ä¸€å¥è¯</span><br><span class="line">/dev/sdc1 /mnt/sdc1 ext4 defaultsï¼ˆè¡¨ç¤ºæƒé™ï¼‰0 0</span><br></pre></td></tr></table></figure><ul><li><a href="https://blog.csdn.net/qq_38028248/article/details/115524071">Linuxè™šæ‹Ÿæœºç£ç›˜åˆ†åŒºåˆ›å»ºã€æŒ‚è½½ã€å¸è½½ã€åˆ é™¤</a></li></ul><h3 id="ç³»ç»Ÿç»¼åˆçŠ¶æ€æŸ¥è¯¢">ç³»ç»Ÿç»¼åˆçŠ¶æ€æŸ¥è¯¢</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨ <span class="keyword">sar</span> å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿç»¼åˆçŠ¶æ€</span><br><span class="line">    <span class="keyword">sar</span> -u <span class="number">1</span> <span class="number">10</span> <span class="meta">CPU</span>çš„æŸ¥çœ‹ï¼Œæ¯éš”<span class="number">1</span>ç§’åšé‡‡æ ·ï¼Œé‡‡æ ·<span class="number">10</span>æ¬¡ï¼Œ</span><br><span class="line">    <span class="keyword">sar</span> -r <span class="number">1</span> <span class="number">10</span> çœ‹å†…å­˜</span><br><span class="line">    <span class="keyword">sar</span> -b <span class="number">1</span> <span class="number">10</span> IOçš„æƒ…å†µï¼ˆç£ç›˜è¯»å†™ï¼‰</span><br><span class="line">    <span class="keyword">sar</span> -d <span class="number">1</span> <span class="number">10</span> æŸ¥çœ‹æ¯å—ç£ç›˜çš„è¯»å†™</span><br><span class="line">    <span class="keyword">sar</span> -q <span class="number">1</span> <span class="number">10</span> æŸ¥çœ‹è¿›ç¨‹</span><br><span class="line">ä½¿ç”¨ç¬¬ä¸‰æ–¹å‘½ä»¤æŸ¥çœ‹ç½‘ç»œæµé‡</span><br><span class="line">yum install epel-release</span><br><span class="line">yum install iftop ï¼ˆç½‘ç»œæƒ…å†µï¼‰</span><br><span class="line">iftop -p ï¼ˆé»˜è®¤eth0ï¼‰</span><br></pre></td></tr></table></figure><h2 id="Shell">Shell</h2><h3 id="ä»€ä¹ˆæ˜¯Shell">ä»€ä¹ˆæ˜¯Shell</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">shell</span> æ˜¯å‘½ä»¤è§£é‡Šå™¨ï¼Œç”¨äºè§£é‡Šç”¨æˆ·å¯¹æ“ä½œç³»ç»Ÿçš„æ“ä½œã€‚</span><br><span class="line"></span><br><span class="line"><span class="keyword">shell</span>æœ‰å¾ˆå¤š</span><br><span class="line">    <span class="keyword">cat</span> /etc/shells</span><br><span class="line"></span><br><span class="line">CentOS 7 é»˜è®¤ä½¿ç”¨çš„<span class="keyword">shell</span>æ˜¯bash</span><br></pre></td></tr></table></figure><h3 id="Shellè„šæœ¬">Shellè„šæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UNIXçš„å“²å­¦ï¼šä¸€æ¡å‘½ä»¤åªåšä¸€ä»¶äº‹æƒ…</span><br><span class="line">ä¸ºäº†ç»„åˆå‘½ä»¤å’Œå¤šæ¬¡æ‰§è¡Œå‘½ä»¤ï¼Œä½¿ç”¨è„šæœ¬æ–‡ä»¶æ¥ä¿å­˜éœ€è¦æ‰§è¡Œçš„å‘½ä»¤</span><br><span class="line">èµ‹äºˆè¯¥æ–‡ä»¶æ‰§è¡Œæƒé™ï¼ˆ<span class="built_in">chmod</span> u+rx filenameï¼‰</span><br></pre></td></tr></table></figure><p>Shellå’ŒBashçš„åŒºåˆ«</p><p>Shell å’Œ Bash éƒ½æ˜¯å‘½ä»¤è¡Œç•Œé¢ï¼Œä½†æ˜¯å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¸€äº›ä¸»è¦çš„åŒºåˆ«ã€‚</p><ol><li>Shell æ˜¯ä¸€ä¸ªé€šç”¨æœ¯è¯­ï¼Œç”¨äºæè¿°ä¸€ä¸ªå‘½ä»¤è¡Œè§£é‡Šå™¨ï¼ˆæˆ–è„šæœ¬è§£é‡Šå™¨ï¼‰ã€‚å®ƒæ˜¯ç”¨æˆ·ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„æ¥å£ã€‚åœ¨ Unix å’Œç±» Unix ç³»ç»Ÿï¼ˆå¦‚ Linuxï¼‰ä¸­ï¼Œæœ‰å¤šç§ä¸åŒçš„ shell å¯ä¾›é€‰æ‹©ï¼Œå¦‚ Bourne shellï¼ˆshï¼‰ã€C shellï¼ˆcshï¼‰ã€Korn shellï¼ˆkshï¼‰ç­‰ç­‰ã€‚</li><li>Bashï¼ˆBourne Again SHellï¼‰æ˜¯ Bourne shell çš„æ‰©å±•ï¼Œä¹Ÿæ˜¯ Linux é»˜è®¤çš„ shellã€‚å®ƒå¢åŠ äº†è®¸å¤šç‰¹æ€§ï¼Œå¦‚å‘½ä»¤è¡Œç¼–è¾‘ã€å‘½ä»¤å†å²è®°å½•ç­‰ï¼Œä½¿å¾—ç”¨æˆ·åœ¨ä½¿ç”¨å‘½ä»¤è¡Œæ—¶æ›´åŠ æ–¹ä¾¿ã€‚</li></ol><p>æ‰€ä»¥ï¼Œå¯ä»¥è¯´æ‰€æœ‰çš„ Bash éƒ½æ˜¯ Shellï¼Œä½†å¹¶éæ‰€æœ‰çš„ Shell éƒ½æ˜¯ Bashã€‚å¦‚æœä½ åœ¨ Linux ç³»ç»Ÿä¸­æ‰“å¼€ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œä½ é€šå¸¸ä¼šå¾—åˆ°ä¸€ä¸ª Bash shellã€‚å¦‚æœä½ åœ¨ç¼–å†™ shell è„šæœ¬ï¼Œä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨ Bourne shell è¯­æ³•ï¼ˆè¿™æ ·è„šæœ¬å¯ä»¥åœ¨æ‰€æœ‰çš„ Unix-like ç³»ç»Ÿä¸Šè¿è¡Œï¼‰ï¼Œæˆ–è€…ä½¿ç”¨ Bash è¯­æ³•ï¼ˆè¿™æ ·ä½ å¯ä»¥ä½¿ç”¨ Bash æä¾›çš„é¢å¤–ç‰¹æ€§ï¼Œä½†è„šæœ¬å¯èƒ½æ— æ³•åœ¨åªæœ‰ Bourne shell çš„ç³»ç»Ÿä¸Šè¿è¡Œï¼‰ã€‚</p><p>æ ‡å‡†çš„Shellè„šæœ¬è¦åŒ…å«å“ªäº›å…ƒç´ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Sha-Bang</span><br><span class="line">å‘½ä»¤</span><br><span class="line">â€œ<span class="comment">#â€å·å¼€å¤´çš„æ³¨é‡Š</span></span><br><span class="line"><span class="built_in">chmod</span> u+x filename å¯æ‰§è¡Œæƒé™</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ‰§è¡Œå‘½ä»¤</span><br><span class="line">bash ./filename.sh   ä¼šç”Ÿæˆä¸€ä¸ªå­è¿›ç¨‹ï¼ˆä¸éœ€è¦æ‰§è¡Œæƒé™ï¼‰</span><br><span class="line">./filename.sh   ä¼šç”Ÿæˆä¸€ä¸ªå­è¿›ç¨‹ï¼Œä½¿ç”¨Sha-Bang ï¼ˆéœ€è¦å¯æ‰§è¡Œæƒé™ï¼‰</span><br><span class="line"><span class="built_in">source</span> ./filename.sh  åœ¨å½“å‰è¿›ç¨‹è¿è¡Œ</span><br><span class="line">. filename.sh ï¼ˆç‚¹ä¹‹åä¼šäº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼‰</span><br><span class="line"></span><br><span class="line">æ¯”å¦‚ä¸€ä¸ªè„šæœ¬å¦‚ä¸‹ï¼š</span><br><span class="line"><span class="comment">#! /bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line"></span><br><span class="line">åœ¨/homeç›®å½•ä¸‹è¿è¡Œ</span><br><span class="line">bash ./filename.sh è¿è¡Œï¼Œå­è¿›ç¨‹è¿è¡Œ<span class="built_in">cd</span>ï¼Œç„¶åå­è¿›ç¨‹ç»“æŸï¼Œæ­¤æ—¶<span class="built_in">pwd</span>ï¼Œè¿˜æ˜¯åœ¨ /home è€Œä¸æ˜¯/tmp</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> ./filename.sh æˆ–è€… . filename.sh</span><br><span class="line"></span><br><span class="line">å†…å»ºå‘½ä»¤å’Œå¤–éƒ¨å‘½ä»¤çš„åŒºåˆ«</span><br><span class="line">å†…å»ºå‘½ä»¤ä¸éœ€è¦åˆ›å»ºå­è¿›ç¨‹ï¼Œå†…å»ºå‘½ä»¤æ¯”å¦‚<span class="built_in">source</span></span><br><span class="line">å†…å»ºå‘½ä»¤å¯¹å½“å‰shellç”Ÿæ•ˆ</span><br></pre></td></tr></table></figure><p>Sha-Bang</p><p>ç”¨äºæŒ‡æ˜æ‰§è¡Œè¿™ä¸ªè„šæœ¬æ–‡ä»¶çš„è§£é‡Šå™¨</p><ul><li><a href="https://blog.csdn.net/u012294618/article/details/78427864">é‡Šä¼´ï¼šLinux ä¸Šçš„ Shebang ç¬¦å·(#!)</a></li></ul><h3 id="ç®¡é“ä¸é‡å®šå‘">ç®¡é“ä¸é‡å®šå‘</h3><p><strong>ç®¡é“ä¸ç®¡é“ç¬¦</strong></p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç®¡é“å’Œä¿¡å·ä¸€æ ·ï¼Œä¹Ÿæ˜¯è¿›ç¨‹é€šä¿¡çš„æ–¹å¼ä¹‹ä¸€</span><br><span class="line">åŒ¿åç®¡é“ï¼ˆç®¡é“ç¬¦ï¼‰æ˜¯ Shell å˜æˆç»å¸¸ç”¨åˆ°çš„é€šä¿¡å·¥å…·</span><br><span class="line">ç®¡é“ç¬¦æ˜¯â€œ|<span class="type">â€ï¼Œå°†å‰ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œçš„ç»“æœä¼ é€’ç»™åé¢çš„å‘½ä»¤</span></span><br><span class="line"><span class="type">ps</span> | <span class="type">cat</span></span><br><span class="line">echo <span class="number">123</span> | <span class="type">psecho</span> <span class="number">123</span> |<span class="type">cat</span> |<span class="type">cmd</span> å¯ä»¥è¿ç»­ä½¿ç”¨</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° cat å’Œ ps æ˜¯ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡è¢«è¿æ¥èµ·æ¥ã€‚</p><p><strong>é‡å®šå‘ç¬¦å·</strong></p><p>ç†è§£ç®­å¤´çš„æ–¹å‘å³å¯ã€‚</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ä¸€ä¸ªè¿›ç¨‹é»˜è®¤ä¼šæ‰“å¼€æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€é”™è¯¯è¾“å‡ºä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">è¾“å…¥é‡å®šå‘ç¬¦å· â€œ&lt;â€</span><br><span class="line">read var &lt; <span class="regexp">/path/to</span><span class="regexp">/a/file</span></span><br><span class="line">(base) sv<span class="variable">@sv</span>-<span class="variable constant_">NF5280M5</span><span class="symbol">:/home/sv/LANet</span><span class="variable">$ </span>wc -l  &lt; <span class="regexp">/etc/passwd</span></span><br><span class="line"><span class="number">53</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è¾“å‡ºé‡å®šå‘ç¬¦å·  <span class="string">&quot;&gt;&quot;</span>  <span class="string">&quot;&gt;&gt;&quot;</span>  <span class="string">&quot;2&gt;&quot;</span> <span class="string">&quot;&amp;&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">echo <span class="number">123</span> &gt; <span class="regexp">/path/to</span><span class="regexp">/a/file</span>   æ¸…ç©ºå†è¾“å…¥</span><br><span class="line">echo <span class="number">123</span> &gt;&gt; <span class="regexp">/path/to</span><span class="regexp">/a/file</span>  è¿½åŠ </span><br><span class="line"><span class="number">2</span>&gt; å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰é”™è¯¯åˆ™é‡å®šå‘</span><br><span class="line">&amp;&gt; å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­æ— è®ºæ­£ç¡®é”™è¯¯éƒ½é‡å®šå‘ </span><br><span class="line"></span><br><span class="line">è¾“å…¥å’Œè¾“å‡ºé‡å®šå‘ç»„åˆä½¿ç”¨</span><br><span class="line">cat &gt; <span class="regexp">/path/to</span><span class="regexp">/a/file</span>.sh &lt;&lt; <span class="variable constant_">EOF</span></span><br><span class="line">i am <span class="variable">$USER</span></span><br><span class="line"><span class="variable constant_">EOF</span></span><br><span class="line"></span><br><span class="line">è¿è¡Œä»¥ä¸Šä¸‰å¥è¯ï¼Œä¼šç”Ÿæˆä¸€ä¸ªfile.shæ–‡ä»¶ï¼Œæ–‡ä»¶é‡Œå†…å®¹ä¸ºi am $<span class="variable constant_">USER</span></span><br></pre></td></tr></table></figure><p>è¡¥å……ï¼šecho å‘½ä»¤åœ¨Linuxä¸­ç”¨äºåœ¨æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼ˆé€šå¸¸æ˜¯ç»ˆç«¯æˆ–å±å¹•ï¼‰ä¸Šæ˜¾ç¤ºä¸€è¡Œæ–‡æœ¬</p><p>æ¥çœ‹çœ‹è¿™æ¡å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">cat</span> a.sh</span><br><span class="line"><span class="comment">#! /bin/bash</span></span><br><span class="line"><span class="built_in">cat</span> &gt; ./file.sh &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">i am $USER</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ vim a.sh</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ bash ./a.sh</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">ls</span></span><br><span class="line">a.sh  file.sh  README.md  tmp  train2017.zip  utils1.py  utils.py</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">cat</span> file.sh</span><br><span class="line">i am sv</span><br></pre></td></tr></table></figure><p>GPTè§£é‡Šï¼š</p><p>è¿™æ¡å‘½ä»¤æ˜¯åœ¨ Unix/Linux ç³»ç»Ÿä¸­ä½¿ç”¨çš„ï¼Œç”¨äºå‘æ–‡ä»¶ä¸­å†™å…¥å†…å®¹ã€‚è®©æˆ‘åˆ†è§£ä¸€ä¸‹è¿™æ¡å‘½ä»¤ï¼š</p><ol><li><code>cat &gt; /path/to/a/file.sh</code>: <code>cat</code> æ˜¯ â€œconcatenateâ€ çš„ç¼©å†™ï¼Œé€šå¸¸ç”¨äºè¾“å‡ºä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† <code>&gt;</code> è¿™ä¸ªé‡å®šå‘ç¬¦ï¼Œæ„æ€æ˜¯æŠŠ <code>cat</code> å‘½ä»¤çš„è¾“å‡ºé‡å®šå‘åˆ° <code>/path/to/a/file.sh</code> è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚å¦‚æœæ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œè¿™ä¸ªæ“ä½œä¼šè¦†ç›–åŸæœ‰çš„å†…å®¹ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿™ä¸ªæ“ä½œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚</li><li><code>&lt;&lt; EOF</code>: è¿™æ˜¯ä¸€ä¸ªå«åš â€œhere documentâ€ çš„æŠ€æœ¯ã€‚<code>&lt;&lt;</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é‡å®šå‘ç¬¦ï¼Œæ„æ€æ˜¯æŠŠåé¢çš„å†…å®¹ä½œä¸ºè¾“å…¥ã€‚<code>EOF</code> æ˜¯ä¸€ä¸ªæ ‡å¿—ï¼Œå®ƒå‘Šè¯‰ shellï¼Œè¿™ä¸ªè¾“å…¥ä¼šä¸€ç›´æŒç»­åˆ°é‡åˆ°å¦ä¸€ä¸ª <code>EOF</code> ä¸ºæ­¢ã€‚</li><li><code>i am $USER</code>: è¿™æ˜¯è¦å†™å…¥æ–‡ä»¶çš„å†…å®¹ã€‚<code>$USER</code> æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œä»£è¡¨å½“å‰çš„ç”¨æˆ·åã€‚æ‰€ä»¥è¿™ä¸€è¡Œçš„æ„æ€æ˜¯ â€œæˆ‘æ˜¯ å½“å‰ç”¨æˆ·åâ€ã€‚</li><li><code>EOF</code>: è¿™æ˜¯å‰é¢æåˆ°çš„é‚£ä¸ªç»“æŸæ ‡å¿—ã€‚é‡åˆ°è¿™ä¸ªæ ‡å¿—ï¼Œshell å°±çŸ¥é“è¾“å…¥ç»“æŸäº†ã€‚</li></ol><p>æ‰€ä»¥ï¼Œæ€»çš„æ¥è¯´ï¼Œè¿™æ¡å‘½ä»¤çš„æ„æ€æ˜¯åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ <code>/path/to/a/file.sh</code>ï¼Œå¹¶å‘å…¶ä¸­å†™å…¥ â€œæˆ‘æ˜¯ å½“å‰ç”¨æˆ·åâ€ è¿™æ ·çš„å†…å®¹ã€‚</p><ul><li><a href="https://zhuanlan.zhihu.com/p/638108440">å¦‚ä½•åœ¨Linuxç³»ç»Ÿä¸­ä½¿ç”¨Catå‘½ä»¤ [22ä¸ªå…¸å‹ç¤ºä¾‹]</a></li></ul><h3 id="å˜é‡">å˜é‡</h3><p><strong>å˜é‡çš„èµ‹å€¼</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">å˜é‡åçš„å‘½åè§„åˆ™</span><br><span class="line"></span><br><span class="line">å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿</span><br><span class="line">ä¸ä»¥æ•°å­—å¼€å¤´</span><br><span class="line"></span><br><span class="line">å˜é‡çš„èµ‹å€¼</span><br><span class="line"></span><br><span class="line">ä¸ºå˜é‡èµ‹å€¼çš„è¿‡ç¨‹ä¸­ï¼Œç§°ä¸ºå˜é‡æ›¿æ¢</span><br><span class="line">    å˜é‡å=å˜é‡å€¼</span><br><span class="line">    <span class="attribute">a</span>=123  ï¼ˆä¸å…è®¸å‡ºç°ç©ºæ ¼ï¼Œshellä¼šè®¤ä¸ºå‰é¢ä¸æ˜¯å˜é‡åè€Œæ˜¯ä¸€ä¸ªå‘½ä»¤ï¼Œæ¯”å¦‚reboot =1ï¼‰ï¼Œä¼šé‡å¯</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨letä¸ºå˜é‡èµ‹å€¼</span><br><span class="line">    let <span class="attribute">a</span>=10+20 ï¼ˆå°½é‡å°‘ç”¨ï¼Œæ•ˆç‡å¾ˆä½ï¼‰</span><br><span class="line"></span><br><span class="line">å°†å‘½ä»¤èµ‹å€¼ç»™å˜é‡</span><br><span class="line">    <span class="attribute">l</span>=ls  ï¼ˆç”¨å¤„ä¸å¤§ï¼‰</span><br><span class="line"></span><br><span class="line">å°†å‘½ä»¤ç»“æœèµ‹å€¼ç»™å˜é‡ï¼Œä½¿ç”¨$() æˆ–è€… <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attribute">letc</span>=$(ls -l /etc)</span><br><span class="line">    <span class="attribute">letc</span>=$&#x27;ls /root<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å˜é‡å€¼æœ‰ç©ºæ ¼ç­‰ç‰¹æ®Šå­—ç¬¦å¯ä»¥åŒ…å«åœ¨ &quot;&quot; æˆ– &#x27;</span><span class="string">&#x27; ä¸­</span></span><br><span class="line"><span class="string">    srring1=&#x27;</span>hello bash<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    string2=&quot;hello I&#x27;</span>m name<span class="string">&quot;</span></span><br></pre></td></tr></table></figure><p><strong>å˜é‡å¼•ç”¨åŠä½œç”¨èŒƒå›´</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å˜é‡çš„å¼•ç”¨</span><br><span class="line">    <span class="variable">$&#123;å˜é‡å&#125;</span>ç§°ä½œå¯¹å˜é‡çš„å¼•ç”¨</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$&#123;å˜é‡å&#125;</span> æŸ¥çœ‹å˜é‡çš„å€¼</span><br><span class="line">    <span class="variable">$&#123;å˜é‡å&#125;</span> åœ¨éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥çœç•¥ä¸º $å˜é‡å</span><br><span class="line"></span><br><span class="line">å˜é‡çš„ä½œç”¨èŒƒå›´</span><br><span class="line">    å˜é‡çš„é»˜è®¤ä½œç”¨èŒƒå›´</span><br><span class="line">        å½“å‰çš„shellï¼Œçˆ¶è¿›ç¨‹çš„å˜é‡å¯¹å­è¿›ç¨‹æ— æ•ˆï¼Œå­è¿›ç¨‹çš„å¯¹çˆ¶è¿›ç¨‹ä¹Ÿæ— æ•ˆã€‚</span><br><span class="line">        å¯ä»¥ä½¿ç”¨<span class="built_in">source</span></span><br><span class="line">    å˜é‡çš„å¯¼å‡º</span><br><span class="line">        <span class="built_in">export</span> ï¼Œå­è¿›ç¨‹å¯ä»¥è·å¾—çˆ¶è¿›ç¨‹çš„å˜é‡ï¼ŒåŒæ—¶ï¼Œçˆ¶è¿›ç¨‹ä¹Ÿèƒ½çœ‹åˆ°å­è¿›ç¨‹çš„å˜é‡</span><br><span class="line">        <span class="built_in">export</span> demo_var1=<span class="string">&quot;hello subshell&quot;</span></span><br><span class="line">    å˜é‡çš„åˆ é™¤</span><br><span class="line">        <span class="built_in">unset</span></span><br><span class="line">        <span class="built_in">unset</span> demo_var1</span><br></pre></td></tr></table></figure><p>å˜é‡ä½œç”¨èŒƒå›´</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ bash</span><br><span class="line">To run a <span class="built_in">command</span> as administrator (user <span class="string">&quot;root&quot;</span>), use <span class="string">&quot;sudo &lt;command&gt;&quot;</span>.</span><br><span class="line">See <span class="string">&quot;man sudo_root&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">-------- freesurfer-linux-ubuntu18_x86_64-7.3.2-20220819-6354275 --------</span><br><span class="line">Setting up environment <span class="keyword">for</span> FreeSurfer/FS-FAST (and FSL)</span><br><span class="line">FREESURFER_HOME   /data/home/qulijun/freesurfer</span><br><span class="line">FSFAST_HOME       /data/home/qulijun/freesurfer/fsfast</span><br><span class="line">FSF_OUTPUT_FORMAT nii.gz</span><br><span class="line">SUBJECTS_DIR      /data/home/qulijun/freesurfer/subjects</span><br><span class="line">MNI_DIR           /data/home/qulijun/freesurfer/mni</span><br><span class="line">sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">echo</span> <span class="variable">$a</span></span><br><span class="line"></span><br><span class="line">sv@sv-NF5280M5:/home/sv/LANet$ a=2</span><br><span class="line">sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">echo</span> <span class="variable">$a</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>å˜é‡çš„å¯¼å‡ºï¼šexport ï¼Œå­è¿›ç¨‹å¯ä»¥è·å¾—çˆ¶è¿›ç¨‹çš„å˜é‡ï¼ŒåŒæ—¶ï¼Œçˆ¶è¿›ç¨‹ä¹Ÿèƒ½çœ‹åˆ°å­è¿›ç¨‹çš„å˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">echo</span> <span class="variable">$demo_var1</span></span><br><span class="line">hello subshell</span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ bash</span><br><span class="line">To run a <span class="built_in">command</span> as administrator (user <span class="string">&quot;root&quot;</span>), use <span class="string">&quot;sudo &lt;command&gt;&quot;</span>.</span><br><span class="line">See <span class="string">&quot;man sudo_root&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">-------- freesurfer-linux-ubuntu18_x86_64-7.3.2-20220819-6354275 --------</span><br><span class="line">Setting up environment <span class="keyword">for</span> FreeSurfer/FS-FAST (and FSL)</span><br><span class="line">FREESURFER_HOME   /data/home/qulijun/freesurfer</span><br><span class="line">FSFAST_HOME       /data/home/qulijun/freesurfer/fsfast</span><br><span class="line">FSF_OUTPUT_FORMAT nii.gz</span><br><span class="line">SUBJECTS_DIR      /data/home/qulijun/freesurfer/subjects</span><br><span class="line">MNI_DIR           /data/home/qulijun/freesurfer/mni</span><br><span class="line">sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">echo</span> <span class="variable">$demo_var1</span></span><br><span class="line">hello subshell</span><br><span class="line">sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">(base) sv@sv-NF5280M5:/home/sv/LANet$ <span class="built_in">echo</span> <span class="variable">$demo_var1</span></span><br><span class="line">hello subshell</span><br></pre></td></tr></table></figure><p><strong>ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œé¢„å®šä¹‰å˜é‡ä¸ä½ç½®å˜é‡</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">ç¯å¢ƒå˜é‡ï¼šæ¯ä¸ªShellæ‰“å¼€éƒ½å¯ä»¥è·å¾—åˆ°çš„å˜é‡</span><br><span class="line">    <span class="built_in">set</span> å’Œ <span class="built_in">env</span> å‘½ä»¤</span><br><span class="line">        <span class="built_in">env</span> |  more æŸ¥çœ‹å½“å‰æ‰€æœ‰çš„ç¯å¢ƒå˜é‡</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$&#123;HOME&#125;</span>  æŸ¥çœ‹å•ä¸ªç¯å¢ƒå˜é‡</span><br><span class="line">    <span class="variable">$PATH</span> å½“å‰å‘½ä»¤çš„æœç´¢è·¯å¾„</span><br><span class="line">        æ‰€ä»¥è¦åœ¨<span class="variable">$PATH</span> ä¸­æ–°å¢è·¯å¾„ï¼Œä½¿ç”¨PATH=<span class="variable">$PATH</span>:æ–°åŠ è·¯å¾„ï¼ˆåªå¯¹å½“å‰ç»ˆç«¯ç”Ÿæ•ˆï¼Œå¯¹å­shellç”Ÿæ•ˆï¼‰</span><br><span class="line">    <span class="variable">$PS1</span>  å½“å‰æç¤ºç»ˆç«¯</span><br><span class="line"></span><br><span class="line">é¢„å®šä¹‰å˜é‡</span><br><span class="line">        <span class="built_in">echo</span> $?  $$ <span class="variable">$0</span>ç­‰</span><br><span class="line">        $?   æŒ‡ä¸Šä¸€æ¡å‘½ä»¤æ˜¯å¦æ­£ç¡®æ‰§è¡Œï¼Œ<span class="built_in">echo</span> $?ï¼Œæ­£ç¡®æ‰§è¡Œè¿”å›0ï¼Œé”™è¯¯1</span><br><span class="line">        $$   æ˜¾ç¤ºå½“å‰è¿›ç¨‹ PID</span><br><span class="line">        <span class="variable">$0</span>   æ˜¾ç¤ºå½“å‰è¿›ç¨‹åç§°</span><br><span class="line"></span><br><span class="line">ä½ç½®å˜é‡</span><br><span class="line">    <span class="variable">$1</span> <span class="variable">$2</span> ... <span class="variable">$&#123;10&#125;</span>ï¼Œéœ€è¦æœ‰&#123;&#125;</span><br><span class="line"></span><br><span class="line">æ¯”å¦‚æœ‰è„šæœ¬ test.sh]å¦‚ä¸‹ï¼š</span><br><span class="line"><span class="comment">#! /bin/bash</span></span><br><span class="line">pos1=<span class="variable">$1</span></span><br><span class="line">pos2=<span class="variable">$2</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$pos1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$pos2</span></span><br><span class="line"></span><br><span class="line">æ‰§è¡Œçš„æ—¶å€™ï¼Œ./test.sh -a -l</span><br><span class="line">ä¼šä¼ å‚è¿›å»ï¼Œå¯ä»¥å¯¹è„šæœ¬è¿›è¡Œç®€åŒ–</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">è€ƒè™‘åˆ°<span class="built_in">echo</span> <span class="variable">$2</span> çš„æ—¶å€™ <span class="variable">$2</span> æœ‰å¯èƒ½æ˜¯ç©ºå€¼ã€‚æ‰€ä»¥å†™æˆä¸‹é¢è¿™æ ·</span><br><span class="line">pos1=<span class="variable">$1</span></span><br><span class="line">pos2=<span class="variable">$&#123;2&#125;</span>_</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$pos1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$pos2</span></span><br><span class="line">å¦‚æœæ²¡æœ‰ä¼ å‚ï¼Œåˆ™<span class="variable">$2</span>é»˜è®¤ä¸º_ï¼Œè§„é¿è¯»å…¥çš„å€¼æ˜¯ç©ºå€¼ã€‚ä½†æ˜¯è¿™ä¹ˆå†™ï¼Œå¦‚æœä¼ å‚è¿›å»ï¼Œåé¢ä¼šå¤šä¸€ä¸ª_ï¼Œæ‰€ä»¥å¯ä»¥æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</span><br><span class="line">pos2=<span class="variable">$&#123;2-_&#125;</span></span><br></pre></td></tr></table></figure><p><strong>ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">é…ç½®æ–‡ä»¶</span><br><span class="line">/etc/profile</span><br><span class="line">/etc/profile.d/</span><br><span class="line">~/.bash_profile</span><br><span class="line">~/.bashrc</span><br><span class="line">/etc/bashrc</span><br><span class="line"></span><br><span class="line">æ‰€ä»¥ç»å¸¸åœ¨ /etc/profile ä¸­æ–°å¢ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/new/path</span><br><span class="line">su - åˆ‡æ¢ç”¨æˆ·ä¼šåŠ è½½4ä¸ªæ–‡ä»¶</span><br><span class="line">su åˆ‡æ¢ç”¨æˆ·åªä¼šåŠ è½½~/.bashrcã€/etc/bashrc</span><br></pre></td></tr></table></figure><p>åœ¨ Unix å’Œ Linux ä¸­ï¼Œä»¥ä¸Šè¿™äº›æ–‡ä»¶éƒ½æ˜¯ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œå…·ä½“ä½œç”¨å¦‚ä¸‹ï¼š</p><ol><li><code>/etc/profile</code>ï¼šè¿™æ˜¯ç³»ç»Ÿçš„å…¨å±€é…ç½®æ–‡ä»¶ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æ•ˆã€‚è¯¥æ–‡ä»¶è®¾ç½®äº†ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬ç”¨æˆ·çš„ shell ç¯å¢ƒè®¾ç½®ã€ç¨‹åºè·¯å¾„ç­‰ã€‚</li><li><code>/etc/profile.d/</code>ï¼šè¿™æ˜¯ä¸€ä¸ªç›®å½•ï¼Œé‡Œé¢çš„è„šæœ¬æ–‡ä»¶ä¼šè¢« <code>/etc/profile</code> æ–‡ä»¶åœ¨å¯åŠ¨æ—¶å€™æ‰§è¡Œã€‚è¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„æ¨¡å—åŒ–å’Œç®¡ç†ç³»ç»Ÿç¯å¢ƒå˜é‡ã€‚</li><li><code>~/.bash_profile</code>ï¼šè¿™æ˜¯é’ˆå¯¹å•ä¸ªç”¨æˆ·çš„é…ç½®æ–‡ä»¶ã€‚æ¯å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°±ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚è¿™ä¸ªæ–‡ä»¶é¦–å…ˆæŸ¥æ‰¾ <code>~/.bashrc</code> æ–‡ä»¶ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œå°±åŠ è½½è¯¥æ–‡ä»¶ã€‚</li><li><code>~/.bashrc</code>ï¼šè¿™ä¹Ÿæ˜¯é’ˆå¯¹å•ä¸ªç”¨æˆ·çš„é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯ä¸ <code>~/.bash_profile</code> ä¸åŒçš„æ˜¯ï¼Œ<code>~/.bashrc</code> æ–‡ä»¶åœ¨æ¯æ¬¡æ‰“å¼€æ–°çš„ shell æ—¶éƒ½ä¼šæ‰§è¡Œã€‚è¿™æ„å‘³ç€æ¯æ¬¡æ‰“å¼€æ–°çš„ç»ˆç«¯çª—å£æˆ–æ–°çš„ shell æ—¶ï¼Œéƒ½ä¼šè¯»å–å¹¶æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ã€‚</li><li><code>/etc/bashrc</code>ï¼šè¿™æ˜¯ç³»ç»Ÿçº§åˆ«çš„ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æ•ˆã€‚å½“ bash shell è¢«æ‰“å¼€æ—¶ï¼Œéƒ½ä¼šè¯»å–å¹¶æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ã€‚</li></ol><p>æ€»çš„æ¥è¯´ï¼Œè¿™äº›æ–‡ä»¶éƒ½æ˜¯ç”¨æ¥é…ç½®ç”¨æˆ·çš„ shell ç¯å¢ƒçš„ã€‚å…¶ä¸­ï¼Œ<code>/etc/profile</code> å’Œ <code>/etc/bashrc</code> æ˜¯å…¨å±€çš„ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æ•ˆï¼›è€Œ <code>~/.bash_profile</code> å’Œ <code>~/.bashrc</code> æ˜¯é’ˆå¯¹æ¯ä¸ªç”¨æˆ·çš„ï¼Œåªå¯¹å½“å‰ç”¨æˆ·æœ‰æ•ˆã€‚</p><h3 id="æ•°ç»„">æ•°ç»„</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å®šä¹‰æ•°ç»„</span><br><span class="line">    IPTS=(10.0.0.1 10.0.0.2 10.0.0.3)</span><br><span class="line"></span><br><span class="line">æ˜¾ç¤ºæ•°ç»„çš„æ‰€æœ‰å…ƒç´ </span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$&#123;IPTS[@]&#125;</span></span><br><span class="line"></span><br><span class="line">æ˜¾ç¤ºæ•°ç»„å…ƒç´ ä¸ªæ•°</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$&#123;#IPTS[@]&#125;</span></span><br><span class="line"></span><br><span class="line">æ˜¾ç¤ºæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$&#123;IPTS[0]&#125;</span></span><br></pre></td></tr></table></figure><h3 id="è½¬ä¹‰å’Œå¼•ç”¨">è½¬ä¹‰å’Œå¼•ç”¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ç‰¹æ®Šå­—ç¬¦ï¼šä¸€ä¸ªå­—ç¬¦ä¸ä»…æœ‰å­—é¢æ„ä¹‰ï¼Œè¿˜æœ‰å…ƒæ„ï¼ˆmeta-meaningï¼‰</span><br><span class="line">    <span class="comment"># æ³¨é‡Š</span></span><br><span class="line">    ; åˆ†å·</span><br><span class="line">    \ è½¬ä¹‰ç¬¦å·</span><br><span class="line">    <span class="string">&quot; å’Œ &#x27; å¼•å·</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å•ä¸ªå­—ç¬¦çš„è½¬ä¹‰</span></span><br><span class="line"><span class="string">    \n \r \t å•ä¸ªå­—æ¯çš„è½¬ä¹‰</span></span><br><span class="line"><span class="string">    \$ \&quot;  \\ å•ä¸ªéå­—æ¯çš„è½¬ä¹‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å¼•ç”¨</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot; åŒå¼•å·ï¼Œå¦‚æœé‡Œé¢æœ‰å˜é‡ï¼Œä¼šè¿›è¡Œè§£é‡Š</span></span><br><span class="line"><span class="string">&#x27;&#x27; å•å¼•å·ä¸ä¼šè¿›è¡Œè§£é‡Š</span></span><br><span class="line"><span class="string">` åå¼•å·</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h3 id="è¿ç®—ç¬¦">è¿ç®—ç¬¦</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">èµ‹å€¼è¿ç®—ç¬¦</span><br><span class="line">= èµ‹å€¼è¿ç®—ç¬¦ï¼Œç”¨äºç®—æ•°èµ‹å€¼å’Œå­—ç¬¦ä¸²èµ‹å€¼</span><br><span class="line">ä½¿ç”¨ <span class="built_in">unset</span> å–æ¶ˆä¸ºå˜é‡çš„èµ‹å€¼</span><br><span class="line">= é™¤äº†ä½œä¸ºèµ‹å€¼è¿ç®—ç¬¦è¿˜å¯ä»¥ä½œä¸ºæµ‹è¯•æ“ä½œç¬¦</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç®—æ•°è¿ç®—ç¬¦</span><br><span class="line"></span><br><span class="line">åŸºæœ¬è¿ç®—ç¬¦</span><br><span class="line">+ - * / ** %</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨<span class="built_in">expr</span>è¿›è¡Œè®¡ç®—</span><br><span class="line"><span class="built_in">expr</span> 4 + 5 ï¼ˆè¦æœ‰ç©ºæ ¼ï¼Œåªèƒ½æ”¯æŒæ•´æ•°ï¼‰</span><br><span class="line">num1=`<span class="built_in">expr</span> 4 + 5`</span><br><span class="line"></span><br><span class="line">æ•°å­—å¸¸é‡çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¦‚æœä¸ç”¨ç‰¹æ®Šæ–¹æ³•ï¼Œa=4+5ï¼Œå…¶å®æŠŠ â€œ4+5â€å­—ç¬¦ä¸²èµ‹å€¼ç»™a</span><br><span class="line"><span class="built_in">let</span> â€œå˜é‡å=å˜é‡å€¼â€</span><br><span class="line">å˜é‡å€¼ä½¿ç”¨0å¼€å¤´ä¸ºå…«è¿›åˆ¶ï¼Œ0xå¼€å¤´ä¸ºåå…­è¿›åˆ¶</span><br><span class="line"></span><br><span class="line">åŒåœ†æ‹¬å·æ˜¯<span class="built_in">let</span>å‘½ä»¤çš„ç®€åŒ–</span><br><span class="line">((a=<span class="number">4</span>+<span class="number">5</span>))</span><br><span class="line">((a++))</span><br><span class="line"><span class="built_in">echo</span> $((<span class="number">10</span>+<span class="number">20</span>)ï¼‰</span><br></pre></td></tr></table></figure><h3 id="ç‰¹æ®Šå­—ç¬¦å¤§å…¨">ç‰¹æ®Šå­—ç¬¦å¤§å…¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">å¼•å·</span><br><span class="line">    <span class="string">&#x27; å®Œå…¨å¼•ç”¨</span></span><br><span class="line"><span class="string">    &quot; ä¸å®Œå…¨å¼•ç”¨</span></span><br><span class="line"><span class="string">    ` æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line"><span class="string">æ‹¬å·</span></span><br><span class="line"><span class="string">    () (()) $() åœ†æ‹¬å·</span></span><br><span class="line"><span class="string">        å•ç‹¬ä½¿ç”¨åœ†æ‹¬å·ä¼šäº§ç”Ÿä¸€ä¸ªå­shellï¼ˆxyz=123ï¼‰</span></span><br><span class="line"><span class="string">        æ•°ç»„åˆå§‹åŒ– IPS=(ip1 ip2 ip3)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    [] [[]] æ–¹æ‹¬å·</span></span><br><span class="line"><span class="string">        å•ç‹¬ä½¿ç”¨æ–¹æ‹¬å·æ˜¯æµ‹è¯•ï¼ˆtestï¼‰æˆ–æ•°ç»„å…ƒç´ åŠŸèƒ½</span></span><br><span class="line"><span class="string">        ä¸¤ä¸ªæ–¹æ‹¬å·è¡¨ç¤ºæµ‹è¯•è¡¨è¾¾å¼</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">    &lt;&gt; å°–æ‹¬å· é‡å®šå‘ç¬¦å·</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    &#123;&#125; èŠ±æ‹¬å·</span></span><br><span class="line"><span class="string">        è¾“å‡ºèŒƒå›´ echo&#123;0..9&#125;ï¼Œä¼šè¾“å‡º0-9æ‰€æœ‰æ•°å­—</span></span><br><span class="line"><span class="string">        æ–‡ä»¶å¤åˆ¶ cp -v /etc/passwd /etc/passwd.bak </span></span><br><span class="line"><span class="string">        ç­‰åŒäº cp -v /etc/passwd&#123;,.bak&#125;</span></span><br><span class="line"><span class="string">è¿ç®—å’Œé€»è¾‘ç¬¦å·</span></span><br><span class="line"><span class="string">    +-*/% ç®—æ•°è¿ç®—ç¬¦</span></span><br><span class="line"><span class="string">    &gt;&lt;= æ¯”è¾ƒè¿ç®—ç¬¦</span></span><br><span class="line"><span class="string">    &amp;&amp; || ï¼é€»è¾‘è¿ç®—ç¬¦</span></span><br><span class="line"><span class="string">        (( 5 &gt; 4 &amp;&amp; 6&gt; 5))ï¼Œç„¶åé€šè¿‡ echo $? åˆ¤æ–­</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">è½¬ä¹‰ç¬¦å·</span></span><br><span class="line"><span class="string">    \</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å…¶ä»–ç¬¦å·</span></span><br><span class="line"><span class="string">    # æ³¨é‡Šç¬¦</span></span><br><span class="line"><span class="string">    ;  å‘½ä»¤åˆ†éš”ç¬¦</span></span><br><span class="line"><span class="string">        case è¯­å¥çš„åˆ†éš”ç¬¦è¦è½¬ä¹‰ ;;</span></span><br><span class="line"><span class="string">    ï¼šç©ºæŒ‡ä»¤</span></span><br><span class="line"><span class="string">    .  å’Œsourceå‘½ä»¤ç›¸åŒ</span></span><br><span class="line"><span class="string">    ~  å®¶ç›®å½•</span></span><br><span class="line"><span class="string">    ,  åˆ†éš”ç›®å½•</span></span><br><span class="line"><span class="string">    * é€šé…ç¬¦</span></span><br><span class="line"><span class="string">    ? æ¡ä»¶æµ‹è¯•æˆ–é€šé…ç¬¦</span></span><br><span class="line"><span class="string">    $ å–å€¼ç¬¦å·</span></span><br><span class="line"><span class="string">    | ç®¡é“ç¬¦</span></span><br><span class="line"><span class="string">    &amp; åå°è¿è¡Œ</span></span><br><span class="line"><span class="string">       ç©ºæ ¼</span></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ä¸åˆ¤æ–­">æµ‹è¯•ä¸åˆ¤æ–­</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">é€€å‡ºç¨‹åºå‘½ä»¤</span><br><span class="line">    <span class="built_in">exit</span> åˆ¤æ–­ä¸Šä¸€æ¡å‘½ä»¤æ˜¯å¦æ­£å¸¸ï¼Œ0æˆ–è€…é0</span><br><span class="line">    <span class="built_in">exit</span> 1æˆ–è€…0 è¿”å›10 ç»™shell ï¼Œè¿”å›å€¼é0ä½ä¸æ­£å¸¸é€€å‡º</span><br><span class="line">    $? åˆ¤æ–­å½“å‰shellå‰ä¸€ä¸ªè¿›ç¨‹æ˜¯å¦æ­£å¸¸é€€å‡º</span><br><span class="line"></span><br><span class="line">æµ‹è¯•å‘½ä»¤<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span>å‘½ä»¤ç”¨äºæ£€æŸ¥æ–‡ä»¶æˆ–è€…æ¯”è¾ƒå€¼</span><br><span class="line"><span class="built_in">test</span>å¯ä»¥åšä»¥ä¸‹æµ‹è¯•</span><br><span class="line">    æ–‡ä»¶æµ‹è¯• </span><br><span class="line">    æ•´æ•°æ¯”è¾ƒæµ‹è¯•</span><br><span class="line">    å­—ç¬¦ä¸²æµ‹è¯•</span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span>æµ‹è¯•è¯­å¥å¯ä»¥ç®€åŒ–ä¸º[]ç¬¦å·</span><br><span class="line">    <span class="built_in">test</span> -f /etc/passwd2 åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶ä¸”æ˜¯ä¸ªæ™®é€šæ–‡ä»¶ï¼Œ-eæ˜¯æ–‡ä»¶æˆ–è€…ç›®å½•ï¼Œ-dç›®å½•</span><br><span class="line">    [ -d /etc/ ]</span><br><span class="line">[]ç¬¦å·è¿˜æœ‰æ‰©å±•å†™æ³• [[]] æ”¯æŒ &amp;&amp; || &lt; &gt;</span><br></pre></td></tr></table></figure><p>ifåˆ¤æ–­è¯­å¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">if-then è¯­å¥çš„åŸºæœ¬ç”¨æ³•</span><br><span class="line">    <span class="keyword">if</span> [ æµ‹è¯•æ¡ä»¶æˆç«‹ ] æˆ– å‘½ä»¤è¿”å›å€¼æ˜¯å¦ä¸º0</span><br><span class="line">    <span class="keyword">then</span> æ‰§è¡Œç›¸åº”å‘½ä»¤</span><br><span class="line">    <span class="keyword">fi</span> ç»“æŸ</span><br><span class="line"></span><br><span class="line">if-then-else è¯­å¥å¯ä»¥åœ¨æ¡ä»¶ä¸æˆç«‹æ—¶ä¹Ÿè¿è¡Œç›¸åº”çš„å‘½ä»¤</span><br><span class="line">    <span class="keyword">if</span> [ æµ‹è¯•æ¡ä»¶æˆç«‹ ]</span><br><span class="line">    <span class="keyword">then</span> æ‰§è¡Œç›¸åº”å‘½ä»¤</span><br><span class="line">    <span class="keyword">else</span> æµ‹è¯•æ¡ä»¶ä¸æˆç«‹ï¼Œæ‰§è¡Œç›¸åº”å‘½ä»¤</span><br><span class="line">    <span class="keyword">fi</span> ç»“æŸ</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ æµ‹è¯•æ¡ä»¶æˆç«‹ ]</span><br><span class="line">    <span class="keyword">then</span> æ‰§è¡Œç›¸åº”å‘½ä»¤</span><br><span class="line">    <span class="keyword">elif</span>  [ æµ‹è¯•æ¡ä»¶æˆç«‹ ]</span><br><span class="line">    <span class="keyword">then</span> æ‰§è¡Œç›¸åº”å‘½ä»¤</span><br><span class="line">    <span class="keyword">else</span> æµ‹è¯•æ¡ä»¶ä¸æˆç«‹ï¼Œæ‰§è¡Œç›¸åº”å‘½ä»¤</span><br><span class="line">    <span class="keyword">fi</span> ç»“æŸ</span><br><span class="line"></span><br><span class="line">åµŒå¥— <span class="keyword">if</span> çš„ä½¿ç”¨</span><br><span class="line"><span class="keyword">if</span> æ¡ä»¶æµ‹è¯•ä¸­å¯ä»¥å†åµŒå¥— <span class="keyword">if</span> æ¡ä»¶æµ‹è¯•</span><br><span class="line">    <span class="keyword">if</span> [ æµ‹è¯•æ¡ä»¶æˆç«‹ ]</span><br><span class="line">    <span class="keyword">then</span> æ‰§è¡Œç›¸åº”å‘½ä»¤</span><br><span class="line">        <span class="keyword">if</span> [æµ‹è¯•æ¡ä»¶æˆç«‹]</span><br><span class="line">        <span class="keyword">then</span> æ‰§è¡Œç›¸åº”å‘½ä»¤</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h3 id="caseåˆ†æ”¯">caseåˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> è¯­å¥å’Œ <span class="keyword">select</span> è¯­å¥å¯ä»¥æ„æˆåˆ†æ”¯</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;$å˜é‡&quot;</span> <span class="keyword">in</span></span><br><span class="line">    <span class="string">&quot;æƒ…å†µ1&quot;</span> )</span><br><span class="line">    å‘½ä»¤...;;;</span><br><span class="line">    <span class="string">&quot;æƒ…å†µ2&quot;</span> )</span><br><span class="line">    å‘½ä»¤...;;;</span><br><span class="line">    * )</span><br><span class="line">     å‘½ä»¤...;;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><h3 id="å¾ªç¯">å¾ªç¯</h3><p><strong>forå¾ªç¯</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> å¾ªç¯çš„è¯­æ³•</span><br><span class="line">    <span class="keyword">for</span>  å‚æ•° <span class="keyword">in</span> åˆ—è¡¨</span><br><span class="line">    <span class="keyword">do</span> æ‰§è¡Œçš„å‘½ä»¤</span><br><span class="line">    <span class="keyword">done</span> å°é—­ä¸€ä¸ªå¾ªç¯</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨åå¼•å·æˆ– $() æ–¹å¼æ‰§è¡Œå‘½ä»¤ï¼Œå‘½ä»¤çš„ç»“æœå½“åšåˆ—è¡¨è¿›è¡Œå¤„ç†</span><br><span class="line">åˆ—è¡¨ä¸­åŒ…å«å¤šä¸ªå˜é‡ï¼Œå˜é‡ç”¨ç©ºæ ¼åˆ†éš”</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..9&#125;</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> <span class="string">&#x27;ls *.mp3&#x27;</span></span><br><span class="line">å¯¹æ–‡æœ¬å¤„ç†ï¼Œè¦ä½¿ç”¨æ–‡æœ¬æŸ¥çœ‹å‘½ä»¤å–å‡ºæ–‡æœ¬å†…å®¹</span><br><span class="line">é»˜è®¤é€è¡Œå¤„ç†ï¼Œå¦‚æœæ–‡æœ¬å‡ºç°ç©ºæ ¼ä¼šå½“åšå¤šè¡Œå¤„ç†</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C è¯­è¨€é£æ ¼çš„ <span class="keyword">for</span> å‘½ä»¤</span><br><span class="line"><span class="keyword">for</span>((å˜é‡çš„åˆå§‹åŒ–;å¾ªç¯åˆ¤æ–­æ¡ä»¶;å˜é‡å˜åŒ–))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  å‘½ä»¤</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p><strong>whileå¾ªç¯</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">test</span>æµ‹è¯•æ˜¯å¦æˆç«‹</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    å‘½ä»¤</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">until</span> å¾ªç¯ ä¸<span class="keyword">while</span> å¾ªç¯ç›¸åï¼Œå¾ªç¯æµ‹è¯•ä¸ºå‡æ—¶ï¼Œæ‰§è¡Œå¾ªç¯ï¼Œä¸ºçœŸå®å¾ªç¯åœæ­¢</span><br></pre></td></tr></table></figure><p><strong>breakå’Œcontinue</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">break</span> é€€å‡º</span><br><span class="line"><span class="built_in">continue</span> ç»“æŸæœ¬è½®å¾ªç¯</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨å¾ªç¯å¤„ç†ä½ç½®å‚æ•°</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">å‘½ä»¤è¡Œå‚æ•°å¯ä»¥ä½¿ç”¨ <span class="variable">$1</span> <span class="variable">$2</span> ... <span class="variable">$&#123;10&#125;</span>..<span class="variable">$n</span> è¿›è¡Œè¯»å–</span><br><span class="line"><span class="variable">$0</span> ä»£è¡¨è„šæœ¬åç§°</span><br><span class="line">$* å’Œ <span class="variable">$@</span> ä»£è¡¨æ‰€æœ‰ä½ç½®å‚æ•°</span><br><span class="line"><span class="variable">$#</span> ä»£è¡¨ä½ç½®å‚æ•°çš„æ•°é‡</span><br><span class="line"></span><br><span class="line">æœ‰è„šæœ¬test.shå¦‚ä¸‹ï¼š</span><br><span class="line"><span class="comment">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># help display help help</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pos <span class="keyword">in</span> $*</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$pos</span>&quot;</span> = <span class="string">&quot;help&quot;</span>]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="variable">$pos</span> <span class="variable">$pos</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">è¿è¡Œè¯­å¥ï¼š</span><br><span class="line">bash test.sh a b c <span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> è„šæœ¬å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line"><span class="comment">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$#</span> -ge 1]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;help&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="variable">$1</span> <span class="variable">$1</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">shift</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">shift</span>èƒ½å¤Ÿå‚æ•°å·¦ç§»</span><br><span class="line">è¿è¡Œè¯­å¥ï¼š</span><br><span class="line">bash test.sh a b c <span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="å‡½æ•°">å‡½æ•°</h3><p><strong>è‡ªå®šä¹‰å‡½æ•°</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">å‡½æ•°ç”¨äºâ€œåŒ…å«â€é‡å¤ä½¿ç”¨çš„å‘½ä»¤é›†åˆ</span><br><span class="line"></span><br><span class="line">è‡ªå®šä¹‰å‡½æ•°</span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">fname</span></span>()&#123;</span><br><span class="line">    å‘½ä»¤</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">å‡½æ•°çš„æ‰§è¡Œ</span><br><span class="line">    fname</span><br><span class="line"></span><br><span class="line">å‡½æ•°ä½œç”¨èŒƒå›´çš„å˜é‡</span><br><span class="line"><span class="built_in">local</span> å˜é‡å</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å‡½æ•°çš„å‚æ•°</span><br><span class="line"><span class="variable">$1</span> <span class="variable">$2</span>...<span class="variable">$n</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">checkpid</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> i</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> $* ; <span class="keyword">do</span></span><br><span class="line">        [ -d <span class="string">&quot;/proc/<span class="variable">$i</span>&quot;</span> ] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">æ‰§è¡Œæ—¶</span><br><span class="line">checkpid 1    æˆ–è€… checkpid 1 2</span><br><span class="line"><span class="built_in">echo</span>  $?</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ç³»ç»Ÿè„šæœ¬</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ç³»ç»Ÿè‡ªå»ºäº†å‡½æ•°åº“ï¼Œå¯ä»¥åœ¨è„šæœ¬ä¸­å¼•ç”¨</span><br><span class="line">/etc/init.d/functions</span><br><span class="line"></span><br><span class="line">è‡ªå»ºå‡½æ•°åº“</span><br><span class="line">ä½¿ç”¨ <span class="built_in">source</span> å‡½æ•°è„šæœ¬æ–‡ä»¶â€œå¯¼å…¥â€å‡½æ•°</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/init.d/functions</span><br><span class="line">echo_success</span><br></pre></td></tr></table></figure><h3 id="è„šæœ¬ä¼˜å…ˆçº§æ§åˆ¶">è„šæœ¬ä¼˜å…ˆçº§æ§åˆ¶</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å¯ä»¥ä½¿ç”¨ nice å’Œ renice è°ƒæ•´è„šæœ¬ä¼˜å…ˆçº§</span><br><span class="line">é¿å…å‡ºç°â€œä¸å¯æ§çš„â€æ­»å¾ªç¯</span><br><span class="line">æ­»å¾ªç¯å¯¼è‡´cpuå ç”¨è¿‡é«˜</span><br><span class="line">æ­»å¾ªç¯å¯¼è‡´æ­»æœº</span><br><span class="line"></span><br><span class="line">ulimit -a  å¯ä»¥æŸ¥çœ‹å½“å‰ç»ˆç«¯çš„ä½¿ç”¨é™åˆ¶ï¼Œrootç”¨æˆ·çš„è¯æœ‰äº›é™åˆ¶ä¸ä¼šç”Ÿæ•ˆ</span><br><span class="line"></span><br><span class="line">max <span class="keyword">user</span> <span class="title">processes</span> ç”¨æˆ·çš„æœ€å¤§è¿›ç¨‹æ•°</span><br></pre></td></tr></table></figure><h3 id="è®¡åˆ’ä»»åŠ¡">è®¡åˆ’ä»»åŠ¡</h3><h3 id="æ­£åˆ™è¡¨è¾¾å¼ä¸æ–‡æœ¬æœç´¢">æ­£åˆ™è¡¨è¾¾å¼ä¸æ–‡æœ¬æœç´¢</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">å…ƒå­—ç¬¦</span><br><span class="line"></span><br><span class="line">. åŒ¹é…é™¤æ¢è¡Œç¬¦å¤–çš„ä»»æ„å•ä¸ªå­—ç¬¦</span><br><span class="line">* åŒ¹é…ä»»æ„ä¸€ä¸ªè·Ÿåœ¨å®ƒå‰é¢çš„å­—ç¬¦</span><br><span class="line">[] åŒ¹é…æ–¹æ‹¬å·ä¸­çš„å­—ç¬¦ç±»ä¸­çš„ä»»æ„ä¸€ä¸ª</span><br><span class="line">^ åŒ¹é…å¼€å¤´</span><br><span class="line">$ åŒ¹é…ç»“å°¾</span><br><span class="line">\ è½¬ä¹‰åé¢çš„ç‰¹æ®Šå­—ç¬¦</span><br><span class="line"></span><br><span class="line">æ‰©å±•å…ƒå­—ç¬¦</span><br><span class="line">+ åŒ¹é…å‰é¢çš„æ­£åˆ™è¡¨è¾¾å¼è‡³å°‘å‡ºç°ä¸€æ¬¡</span><br><span class="line">ï¼Ÿ åŒ¹é…å‰é¢çš„æ­£åˆ™è¡¨è¾¾å¼å‡ºç°é›¶æ¬¡æˆ–ä¸€æ¬¡</span><br><span class="line">| åŒ¹é…å®ƒå‰é¢æˆ–åé¢çš„æ­£åˆ™è¡¨è¾¾å¼</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">grep</span> æœç´¢</span><br><span class="line"><span class="keyword">grep</span> test <span class="regexp">/root/</span>test.txt</span><br></pre></td></tr></table></figure><h3 id="æœç´¢æ–‡ä»¶">æœç´¢æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc</span><br><span class="line">find passwd</span><br><span class="line">    -regex åŒºåˆ†å¤§å°å†™</span><br><span class="line">    -iregex ä¸åŒºåˆ†å¤§å°å†™</span><br><span class="line"></span><br><span class="line">find /etc -regex .*wd</span><br><span class="line"></span><br><span class="line">find * txt -<span class="built_in">exec</span> <span class="built_in">rm</span> -v &#123;&#125; \;</span><br></pre></td></tr></table></figure><ul><li><a href="https://zhuanlan.zhihu.com/p/54110864">å¦‚ä½•é«˜æ•ˆåœ°åœ¨ Linux ä¸­æœç´¢æ–‡ä»¶ï¼Ÿ</a></li></ul><h3 id="sedå’Œawkè¡Œç¼–è¾‘å™¨">sedå’Œawkè¡Œç¼–è¾‘å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sed ä¸€èˆ¬ç”¨äºå¯¹æ–‡æœ¬å†…å®¹åšæ›¿æ¢</span><br><span class="line"></span><br><span class="line">    sed <span class="string">&#x27;/user1/s/user1/u1&#x27;</span> /etc/passwd</span><br><span class="line"></span><br><span class="line">awk åŸºæœ¬ç”¨æ³•</span><br><span class="line">awk ä¸€èˆ¬ç”¨äºå¯¹æ–‡æœ¬å†…å®¹è¿›è¡Œç»Ÿè®¡ï¼ŒæŒ‰éœ€è¦çš„æ ¼å¼è¿›è¡Œè¾“å‡º</span><br><span class="line">    <span class="built_in">cut</span> å‘½ä»¤ï¼š<span class="built_in">cut</span> -d:-f 1/etc/passwd</span><br><span class="line">    awk å‘½ä»¤ï¼šawk -F: <span class="string">&#x27;/wd$/&#123;print$1&#125;&#x27;</span> /etc/passwd</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬çœ‹çœ‹å¿«é€Ÿå¯åŠ¨muduoè„šæœ¬çš„ç¼–å†™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash # è¿™è¡Œè¡¨ç¤ºè¿™ä¸ªè„šæœ¬æ–‡ä»¶å°†ç”± bash shell æ¥æ‰§è¡Œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e <span class="comment"># è¿™è¡Œå‘½ä»¤è¡¨ç¤ºå¦‚æœåé¢çš„å‘½ä»¤è¿”å›éé›¶é€€å‡ºçŠ¶æ€ï¼Œåˆ™ç«‹å³é€€å‡ºè„šæœ¬ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹é¢çš„ifè¯­å¥è¡¨ç¤ºå¦‚æœå½“å‰ç›®å½•ä¸‹ä¸å­˜åœ¨åä¸ºbuildçš„æ–‡ä»¶å¤¹ï¼Œåˆ™åˆ›å»ºè¿™ä¸ªæ–‡ä»¶å¤¹ã€‚</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d `<span class="built_in">pwd</span>`/build ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkdir</span> `<span class="built_in">pwd</span>`/build</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf `<span class="built_in">pwd</span>`/build/* <span class="comment"># åˆ é™¤ build æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ¢åˆ° build ç›®å½•ï¼Œç„¶åä½¿ç”¨ CMake ç”Ÿæˆ Makefile å¹¶ä½¿ç”¨ make å‘½ä»¤ç¼–è¯‘é¡¹ç›®ã€‚</span></span><br><span class="line"><span class="built_in">cd</span> `<span class="built_in">pwd</span>`/build &amp;&amp;</span><br><span class="line">    cmake .. &amp;&amp;</span><br><span class="line">    make</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> .. <span class="comment"># åˆ‡æ¢å›é¡¹ç›®çš„æ ¹ç›®å½•ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹é¢çš„ifè¯­å¥è¡¨ç¤ºå¦‚æœ /usr/include/mymuduo æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºè¿™ä¸ªæ–‡ä»¶å¤¹ã€‚</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d /usr/include/mymuduo ]; <span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">mkdir</span> /usr/include/mymuduo</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰ .h æ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬å¤åˆ¶åˆ° /usr/include/mymuduo æ–‡ä»¶å¤¹ã€‚</span></span><br><span class="line"><span class="keyword">for</span> header <span class="keyword">in</span> `<span class="built_in">ls</span> *.h`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cp</span> <span class="variable">$header</span> /usr/include/mymuduo</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> `<span class="built_in">pwd</span>`/lib/libmymuduo.so /usr/lib <span class="comment"># å°† libmymuduo.so æ–‡ä»¶å¤åˆ¶åˆ° /usr/lib æ–‡ä»¶å¤¹ã€‚</span></span><br><span class="line"></span><br><span class="line">ldconfig <span class="comment"># åˆ·æ–°åŠ¨æ€é“¾æ¥åº“ç¼“å­˜</span></span><br></pre></td></tr></table></figure><p>è¿™æ®µè„šæœ¬çš„ä¸»è¦ç›®çš„æ˜¯ç¼–è¯‘ä¸€ä¸ªé¡¹ç›®å¹¶å°†ç”Ÿæˆçš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»Ÿçš„ç›¸åº”ç›®å½•ã€‚</p>]]></content>
    
    
    <summary type="html">Linuxå®æˆ˜æŠ€èƒ½</summary>
    
    
    
    <category term="Linux" scheme="https://penge666.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://penge666.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>æ— é”é˜Ÿåˆ—</title>
    <link href="https://penge666.github.io/posts/9131331a.html"/>
    <id>https://penge666.github.io/posts/9131331a.html</id>
    <published>2024-05-07T12:15:38.000Z</published>
    <updated>2024-05-07T13:19:17.076Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨ä¸Šä¸€ç¯‡åšå®¢ä¸­ï¼Œä»‹ç»äº†é€šè¿‡æŒ‡å®šåŸå­å˜é‡çš„æ“ä½œçš„å†…å­˜é¡ºåº, å®ç°çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚æœ¬æ–‡çœ‹çœ‹åŸå­å˜é‡å’Œå†…å­˜é¡ºåºçš„åº”ç”¨ â€“ æ— é”é˜Ÿåˆ—ï¼ˆLock-Free Queueï¼‰ã€‚æœ¬æ–‡ä»‹ç»å•å†™å•è¯»å’Œå¤šå†™å¤šè¯»çš„æ— é”é˜Ÿåˆ—çš„ç®€å•å®ç°ï¼Œå­¦ä¹ æ— é”é˜Ÿåˆ—è®¾è®¡çš„åŸºæœ¬æ€è·¯ã€‚å¯¹æ— é”é˜Ÿåˆ—æœ‰ä¸ªå…¥é—¨çš„äº†è§£ã€‚</p><h2 id="å•å†™å•è¯»é˜Ÿåˆ—">å•å†™å•è¯»é˜Ÿåˆ—</h2><p>å•å†™å•è¯»çš„é˜Ÿåˆ—æ¯”è¾ƒç®€å•, è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å¾ªç¯é˜Ÿåˆ—å®ç°. å¦‚ä¸‹å›¾æ‰€ç¤º, é˜Ÿåˆ—ç»´æŠ¤ä¸¤ä¸ªæŒ‡é’ˆ <code>head</code> å’Œ <code>tail</code>, åˆ†åˆ«æŒ‡å‘é˜Ÿé¦–å’Œé˜Ÿå°¾. <code>tail</code> å§‹ç»ˆæŒ‡å‘ dummy èŠ‚ç‚¹, è¿™æ · <code>tail == head</code> è¡¨ç¤ºé˜Ÿåˆ—ä¸ºç©º, <code>(tail + 1) % Cap == head</code> è¡¨ç¤ºé˜Ÿåˆ—å·²æ»¡, ä¸ç”¨ç»´æŠ¤ <code>size</code> æˆå‘˜.</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240507202501356.png" alt="image-20240507202501356"></p><p>å…¥é˜Ÿçš„æ—¶å€™ç§»åŠ¨ <code>tail</code> æŒ‡é’ˆ, è€Œå‡ºé˜Ÿçš„æ—¶å€™ç§»åŠ¨ <code>head</code> æŒ‡é’ˆ, ä¸¤ä¸ªæ“ä½œå¹¶æ— å†²çª. ä¸è¿‡, å‡ºé˜Ÿå‰éœ€è¦è¯»å– <code>tail</code> æŒ‡é’ˆ, åˆ¤æ–­ <code>tail != head</code> ç¡®è®¤é˜Ÿåˆ—ä¸ä¸ºç©º; åŒç†å…¥é˜Ÿæ—¶ä¹Ÿè¦åˆ¤æ–­ <code>(tail + 1) % Cap != head</code> ä»¥ç¡®è®¤é˜Ÿåˆ—ä¸æ»¡. ç”±äºå­˜åœ¨å¤šä¸ªçº¿ç¨‹è¯»å†™è¿™ä¸¤ä¸ªæŒ‡é’ˆ, å› æ­¤å®ƒä»¬éƒ½åº”è¯¥æ˜¯åŸå­å˜é‡.</p><p>æ­¤å¤–, ç”±äºä¸¤ä¸ªæ“ä½œåœ¨ä¸åŒçº¿ç¨‹ä¸­æ‰§è¡Œ, æˆ‘ä»¬è¿˜éœ€è€ƒè™‘å†…å­˜é¡ºåº. å¦‚æœåˆå§‹é˜Ÿåˆ—ä¸ºç©º, çº¿ç¨‹ a å…ˆæ‰§è¡Œå…¥é˜Ÿæ“ä½œ, çº¿ç¨‹ b åæ‰§è¡Œå‡ºé˜Ÿæ“ä½œ, åˆ™çº¿ç¨‹ a å…¥é˜Ÿæ“ä½œçš„å†…å®¹è¦å¯¹çº¿ç¨‹ b å¯è§.</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240507202552069.png" alt="image-20240507202552069"></p><p>ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹, éœ€è¦æœ‰ a(2) â€œhappens-beforeâ€ b(3). è€Œ a(3) å’Œ b(2) åˆ†åˆ«ä¿®æ”¹äº†è¯»å–äº† <code>tail</code>, æ‰€ä»¥åº”è¯¥åˆ©ç”¨åŸå­å˜é‡åŒæ­¥, ä½¿å¾— a(3) â€œsynchronizes-withâ€ b(2). å¯ä»¥åœ¨ a(3) å†™å…¥ <code>tail</code> çš„æ“ä½œä¸­ä½¿ç”¨ release, b(2) è¯»å– <code>tail</code> çš„æ“ä½œä¸­ä½¿ç”¨ acquire å®ç°åŒæ­¥.</p><p>åŒç†, å¦‚æœåˆå§‹é˜Ÿåˆ—æ»¡, çº¿ç¨‹ a å…ˆæ‰§è¡Œå‡ºé˜Ÿæ“ä½œ, çº¿ç¨‹ b åæ‰§è¡Œå…¥é˜Ÿæ“ä½œ, åˆ™çº¿ç¨‹ a å‡ºé˜Ÿæ“ä½œçš„ç»“æœè¦å¯¹çº¿ç¨‹ b å¯è§. å‡ºé˜Ÿçš„æ—¶å€™éœ€è¦è°ƒç”¨å‡ºé˜Ÿå…ƒç´ çš„ææ„å‡½æ•°, è¦ä¿è¯å‡ºé˜Ÿå…ƒç´ æ­£å¸¸é”€æ¯åæ‰èƒ½åœ¨é‚£ä¸ªä½ç½®å†™å…¥æ–°å…ƒç´ , å¦åˆ™ä¼šå¯¼è‡´å†…å­˜æŸå. å¯ä»¥åœ¨å‡ºé˜Ÿå†™å…¥ <code>head</code> çš„æ“ä½œä¸­ä½¿ç”¨ release, å…¥é˜Ÿè¯»å– <code>head</code> çš„æ“ä½œä¸­ä½¿ç”¨ acquire å®ç°å‡ºé˜Ÿ â€œsynchronizes-withâ€ å…¥é˜Ÿ.</p><p>ç®€å•æ¥è¯´:</p><p>1.çº¿ç¨‹ a å…ˆæ‰§è¡Œå‡ºé˜Ÿæ“ä½œ, çº¿ç¨‹ b åæ‰§è¡Œå…¥é˜Ÿæ“ä½œ, åˆ™çº¿ç¨‹ a å‡ºé˜Ÿæ“ä½œçš„ç»“æœè¦å¯¹çº¿ç¨‹ b å¯è§.</p><p>2.çº¿ç¨‹ a å…ˆæ‰§è¡Œå…¥é˜Ÿæ“ä½œ, çº¿ç¨‹ b åæ‰§è¡Œå‡ºé˜Ÿæ“ä½œ, åˆ™çº¿ç¨‹ a å…¥é˜Ÿæ“ä½œçš„ç»“æœè¦å¯¹çº¿ç¨‹ b å¯è§.</p><p>ä½¿ç”¨memory_order_acquireå’Œmemory_order_releaseå®ç°çº¿ç¨‹åŒæ­¥ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="type">size_t</span> Cap&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">spsc</span> : <span class="keyword">private</span> allocator&lt;T&gt; &#123;</span><br><span class="line">    T *data;</span><br><span class="line">    atomic&lt;<span class="type">size_t</span>&gt; head&#123;<span class="number">0</span>&#125;, tail&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">spsc</span>(): <span class="built_in">data</span>(allocator&lt;T&gt;::<span class="built_in">allocate</span>(Cap)) &#123;&#125;</span><br><span class="line">    <span class="built_in">spsc</span>(<span class="type">const</span> spsc&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    spsc &amp;<span class="keyword">operator</span>=(<span class="type">const</span> spsc&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    spsc &amp;<span class="keyword">operator</span>=(<span class="type">const</span> spsc&amp;) <span class="keyword">volatile</span> = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">push</span><span class="params">(<span class="type">const</span> T &amp;val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">emplace</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">push</span><span class="params">(T &amp;&amp;val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">emplace</span>(std::<span class="built_in">move</span>(val));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">emplace</span><span class="params">(Args &amp;&amp; ...args)</span> </span>&#123; <span class="comment">// å…¥é˜Ÿæ“ä½œ</span></span><br><span class="line">        <span class="type">size_t</span> t = tail.<span class="built_in">load</span>(memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> ((t + <span class="number">1</span>) % Cap == head.<span class="built_in">load</span>(memory_order_acquire)) <span class="comment">// (1)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        allocator&lt;T&gt;::<span class="built_in">construct</span>(data + t, std::forward&lt;Args&gt;(args)...);</span><br><span class="line">        <span class="comment">// (2)  synchronizes-with (3)</span></span><br><span class="line">        tail.<span class="built_in">store</span>((t + <span class="number">1</span>) % Cap, memory_order_release); <span class="comment">// (2)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">pop</span><span class="params">(T &amp;val)</span> </span>&#123; <span class="comment">// å‡ºé˜Ÿæ“ä½œ</span></span><br><span class="line">        <span class="type">size_t</span> h = head.<span class="built_in">load</span>(memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> (h == tail.<span class="built_in">load</span>(memory_order_acquire)) <span class="comment">// (3)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        val = std::<span class="built_in">move</span>(data[h]);</span><br><span class="line">        allocator&lt;T&gt;::<span class="built_in">destroy</span>(data + h);</span><br><span class="line">        <span class="comment">// (4) synchronizes-with (1)</span></span><br><span class="line">        head.<span class="built_in">store</span>((h + <span class="number">1</span>) % Cap, memory_order_release); <span class="comment">// (4)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ç§å•å†™å•è¯»çš„æ— é”é˜Ÿåˆ—çš„ä¸¤ç§æ“ä½œå¯ä»¥åŒæ—¶æ‰§è¡Œ, ä¸”ä¸¤ç§æ“ä½œéƒ½åªéœ€è¦æ‰§è¡Œç¡®å®šæ•°é‡çš„æŒ‡ä»¤, å› æ­¤æ•°æ® wait-free ç»“æ„, æ€§èƒ½å¾ˆé«˜.</p><p>ç»™å‡ºå®Œæ•´ä»£ç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// type __sync_val_compare_and_swap(type *ptr, type oldval type newval, ...)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="type">size_t</span> Cap&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Queue</span>() : <span class="built_in">data</span>(<span class="keyword">new</span> T[Cap]) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">Queue</span>() &#123; <span class="keyword">delete</span>[] data; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">push</span><span class="params">(<span class="type">const</span> T &amp;val)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> t = tail.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> ((t + <span class="number">1</span>) % Cap == head.<span class="built_in">load</span>(std::memory_order_acquire))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Producer: &quot;</span> &lt;&lt; val &lt;&lt; endl;</span><br><span class="line">        data[t % Cap] = val;</span><br><span class="line">        tail.<span class="built_in">store</span>((t + <span class="number">1</span>) % Cap, std::memory_order_release);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">pop</span><span class="params">(T &amp;val)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> h = head.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> (h == tail.<span class="built_in">load</span>(std::memory_order_acquire))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        val = data[h % Cap];</span><br><span class="line">        head.<span class="built_in">store</span>((h + <span class="number">1</span>) % Cap, std::memory_order_release);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T *data;</span><br><span class="line">    std::atomic&lt;<span class="type">size_t</span>&gt; head&#123;<span class="number">0</span>&#125;, tail&#123;<span class="number">0</span>&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Queue&lt;<span class="type">int</span>, <span class="number">5</span>&gt; q;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (q.<span class="built_in">pop</span>(val))</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Consumer: &quot;</span> &lt;&lt; val &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = <span class="built_in">rand</span>() % <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">if</span> (!q.<span class="built_in">push</span>(num))</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">consumer</span><span class="params">(Consumer)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">producer</span><span class="params">(Producer)</span></span>;</span><br><span class="line">    consumer.<span class="built_in">join</span>();</span><br><span class="line">    producer.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CAS-æ“ä½œ">CAS æ“ä½œ</h2><p><strong>CAS (compare and swap)</strong> æ˜¯ä¸€ç§åŸå­æ“ä½œ, åœ¨ä¸€ä¸ªä¸å¯è¢«ä¸­æ–­çš„è¿‡ç¨‹ä¸­æ‰§è¡Œæ¯”è¾ƒå’Œäº¤æ¢. C++ çš„ <code>std::atomic</code> ä¸­æœ‰ä¸¤ç§ CAS æ“ä½œ, <code>compare_exchange_weak</code> å’Œ <code>compare_exchange_strong</code>ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> std::atomic&lt;T&gt;::<span class="built_in">compare_exchange_weak</span>(T &amp;expected, T desired);</span><br><span class="line"><span class="type">bool</span> std::atomic&lt;T&gt;::<span class="built_in">compare_exchange_strong</span>(T &amp;expected, T desired);</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ç§ CAS æ“ä½œåŸºæœ¬ä¸Šæ˜¯ç›¸åŒçš„:</p><ul><li><p>å¦‚æœåŸå­å˜é‡ä¸ <code>expected</code> ç›¸ç­‰, åˆ™å°†å…¶èµ‹å€¼ä¸º <code>desired</code> å¹¶è¿”å› <code>true</code>;</p></li><li><p>å¦åˆ™ <code>expected</code> èµ‹å€¼æˆåŸå­å˜é‡å½“å‰çš„å€¼å¹¶è¿”å› <code>false</code>.</p></li></ul><p>ä¸‹é¢æ˜¯ <code>compare_exchange_strong</code> çš„ä¸€ä¸ªä¼ªå®ç°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">bool</span> atomic&lt;T&gt;::<span class="built_in">compare_exchange_strong</span>(T &amp;expected, T desired) &#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(m_lock)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (m_val == expected)</span><br><span class="line">        <span class="keyword">return</span> m_val = desired, <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> expected = m_val, <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶å®é™…çš„å®ç°ä¸å¯èƒ½æ˜¯è¿™æ ·çš„.</p><p><code>compare_exchange_weak</code> å’Œ <code>compare_exchange_strong</code> çš„åŒºåˆ«åœ¨äº, <code>compare_exchange_weak</code> æœ‰å¯èƒ½åœ¨å½“å‰å€¼ä¸ <code>expected</code> ç›¸ç­‰æ—¶ä»ç„¶ä¸æ‰§è¡Œäº¤æ¢å¹¶è¿”å› <code>false</code>; <code>compare_exchange_strong</code> åˆ™ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜. weak ç‰ˆæœ¬èƒ½è®©ç¼–è¯‘å™¨åœ¨ä¸€äº›å¹³å°ä¸‹ç”Ÿæˆä¸€äº›æ›´ä¼˜çš„ä»£ç , åœ¨ x86 ä¸‹æ˜¯æ²¡åŒºåˆ«çš„.</p><p><code>compare_exchange_*</code> æ”¯æŒæŒ‡å®šä¸¤ä¸ªå†…å­˜é¡ºåº: æˆåŠŸæ—¶çš„å†…å­˜é¡ºåºå’Œå¤±è´¥æ—¶çš„å†…å­˜é¡ºåº.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">compare_exchange_weak</span><span class="params">(T&amp; expected, T desired,</span></span></span><br><span class="line"><span class="params"><span class="function">                           std::memory_order success,</span></span></span><br><span class="line"><span class="params"><span class="function">                           std::memory_order failure)</span></span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ CAS æ“ä½œå®ç°å¾ˆå¤šæ— é”æ•°æ®ç»“æ„. ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å¦‚ä½•å®ç°å¤šå†™å¤šè¯»çš„é˜Ÿåˆ—.</p><h2 id="å¤šå†™å¤šè¯»é˜Ÿåˆ—">å¤šå†™å¤šè¯»é˜Ÿåˆ—</h2><p>å‰é¢å•è¯»å•å†™èƒ½å¦ç”¨åˆ°æ‰§è¡Œå¤šå†™å¤šè¯»å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥çš„ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> spsc&lt;T, Cap&gt;::<span class="built_in">pop</span>(T &amp;val) &#123;</span><br><span class="line">    <span class="type">size_t</span> h = head.<span class="built_in">load</span>(); <span class="comment">// (1)</span></span><br><span class="line">    <span class="keyword">if</span> (h == tail.<span class="built_in">load</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    val = std::<span class="built_in">move</span>(data[h]); <span class="comment">// (2)</span></span><br><span class="line">    allocator&lt;T&gt;::<span class="built_in">destroy</span>(data + h);</span><br><span class="line">    head.<span class="built_in">store</span>((h + <span class="number">1</span>) % Cap); <span class="comment">// (3)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ a å’Œ b åŒæ—¶è°ƒç”¨ <code>pop</code>, æ‰§è¡Œé¡ºåºæ˜¯ a(1), b(1), b(2) a(2). è¿™ç§æƒ…å†µä¸‹, çº¿ç¨‹ a å’Œçº¿ç¨‹ b éƒ½è¯»åˆ°ç›¸åŒçš„ <code>head</code> æŒ‡é’ˆ, å­˜å‚¨åœ¨å˜é‡ <code>h</code> ä¸­. å½“ a(2) å°è¯•è¯»å– <code>data[h]</code> æ—¶, å…¶ä¸­çš„æ•°æ®å·²ç»åœ¨ b(2) ä¸­è¢« move èµ°äº†. å› æ­¤è¿™æ ·çš„é˜Ÿåˆ—ä¸å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ pop æ“ä½œ.</p><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯2ä¸ªçº¿ç¨‹éƒ½è°ƒç”¨pop,ä½†æ˜¯åªè¦ä¸€ä¸ªdata[h]å¯ç»™val.</p><h3 id="è§£å†³æŠ¢å é—®é¢˜">è§£å†³æŠ¢å é—®é¢˜</h3><p>å¯ä»¥çœ‹åˆ°, æ•´ä¸ª <code>pop</code> å‡½æ•°æ˜¯ä¸€ä¸ªéåŸå­è¿‡ç¨‹, ä¸€æ—¦è¿™ä¸ªè¿‡ç¨‹åˆ«å…¶ä»–çº¿ç¨‹æŠ¢å , å°±ä¼šå‡ºé—®é¢˜. å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢? åœ¨æ— é”æ•°æ®ç»“æ„ä¸­, ä¸€ç§å¸¸ç”¨çš„åšæ³•æ˜¯<strong>ä¸æ–­é‡è¯•</strong>. å…·ä½“çš„åšæ³•æ˜¯, åœ¨éåŸå­è¿‡ç¨‹çš„æœ€åä¸€æ­¥è®¾è®¡ä¸€ä¸ª CAS æ“ä½œ, å¦‚æœè¿‡ç¨‹è¢«å…¶ä»–çº¿ç¨‹æŠ¢å , åˆ™ CAS æ“ä½œå¤±è´¥, å¹¶é‡æ–°æ‰§è¡Œæ•´ä¸ªè¿‡ç¨‹. å¦åˆ™ CAS æ“ä½œæˆåŠŸ, å®Œæˆæ•´ä¸ªè¿‡ç¨‹çš„æœ€åä¸€æ­¥.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> spsc&lt;T, Cap&gt;::<span class="built_in">pop</span>(T &amp;val) &#123;</span><br><span class="line">    <span class="type">size_t</span> h;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        h = head.<span class="built_in">load</span>(); <span class="comment">// (1)</span></span><br><span class="line">        <span class="keyword">if</span> (h == tail.<span class="built_in">load</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        val = data[h]; <span class="comment">// (2)</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!head.<span class="built_in">compare_exchange_strong</span>(h, (h + <span class="number">1</span>) % Cap)); <span class="comment">// (3)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ³¨æ„åˆ°æˆ‘ä»¬ä¸å†ä½¿ç”¨ <code>std::move</code> å’Œ <code>allocator::destroy</code>, è€Œæ˜¯ç›´æ¥å¤åˆ¶, ä½¿å¾—å¾ªç¯ä½“å†…çš„æ“ä½œä¸ä¼šä¿®æ”¹é˜Ÿåˆ—æœ¬èº«. (3) æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„æœ€åä¸€æ­¥, ä¹Ÿæ˜¯å”¯ä¸€ä¼šä¿®æ”¹é˜Ÿåˆ—çš„ä¸€æ­¥, æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª CAS æ“ä½œ. åªæœ‰å½“ <code>head</code> çš„å€¼ç­‰äºç¬¬ (1) æ­¥è·å–çš„å€¼çš„æ—¶å€™, æ‰ä¼šç§»åŠ¨ <code>head</code> æŒ‡é’ˆ, å¹¶ä¸”è¿”å› <code>true</code> è·³å‡ºå¾ªç¯; å¦åˆ™å°±ä¸æ–­é‡è¯•.ã€ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åªèƒ½æœ‰ä¸€ä¸ªpopï¼Œå…¶ä»–çš„éœ€è¦è¿›å…¥å¾ªç¯ç­‰å¾….åˆ©ç”¨CASè¿›è¡Œæš´åŠ›ç¾å­¦ã€‘</p><p>è¿™æ ·å¦‚æœå¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ <code>pop</code>, åˆ™åªæœ‰æˆåŠŸæ‰§è¡Œ (3) çš„çº¿ç¨‹è¢«è§†ä¸ºæˆåŠŸæ‰§è¡Œäº†æ•´ä¸ªè¿‡ç¨‹, å…¶å®ƒçš„çº¿ç¨‹éƒ½ä¼šå› ä¸ºè¢«æŠ¢å , å¯¼è‡´æ‰§è¡Œ (3) çš„æ—¶å€™ <code>head</code> è¢«ä¿®æ”¹, å› è€Œä¸å±€éƒ¨å˜é‡ <code>h</code> ä¸ç›¸ç­‰, å¯¼è‡´ CAS æ“ä½œå¤±è´¥. è¿™æ ·å®ƒä»¬å°±è¦é‡è¯•æ•´ä¸ªè¿‡ç¨‹.</p><p>ç±»ä¼¼çš„æ€è·¯ä¹Ÿå¯ä»¥ç”¨åœ¨ <code>push</code> ä¸Š. çœ‹çœ‹å¦‚æœæˆ‘ä»¬ç”¨åŒæ ·çš„æ–¹å¼ä¿®æ”¹ <code>push</code> ä¼šæ€æ ·:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> spsc&lt;T, Cap&gt;::<span class="built_in">push</span>(<span class="type">const</span> T &amp;val) &#123;</span><br><span class="line">    <span class="type">size_t</span> t;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        t = tail.<span class="built_in">load</span>(); <span class="comment">// (1)</span></span><br><span class="line">        <span class="keyword">if</span> ((t + <span class="number">1</span>) % Cap == head.<span class="built_in">load</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        data[t] = val; <span class="comment">// (2)</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!tail.<span class="built_in">compare_exchange_strong</span>(t, (t + <span class="number">1</span>) % Cap)); <span class="comment">// (3)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ <code>pop</code> æ“ä½œä¸åŒ, <code>push</code> æ“ä½œçš„ç¬¬ (2) æ­¥éœ€è¦å¯¹ <code>data[t]</code> èµ‹å€¼, å¯¼è‡´å¾ªç¯ä½“å†…çš„æ“ä½œä¼šä¿®æ”¹é˜Ÿåˆ—. å‡è®¾ a, b ä¸¤ä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºæ˜¯ a(1), a(2), b(1), b(2), a(3). a å¯ä»¥æˆåŠŸæ‰§è¡Œåˆ° (3), ä½†æ˜¯å…¥é˜Ÿçš„å€¼å´è¢« b(2) è¦†ç›–æ‰äº†.ã€ç®€å•æ¥è¯´ï¼Œå°±æ˜¯2ä¸ªçº¿ç¨‹pushï¼Œä½†æ˜¯å¯èƒ½åè€…çº¿ç¨‹ä¼šè¦†ç›–å‰è€…çº¿ç¨‹çš„å€¼çš„è¿™æ ·çš„é—®é¢˜ã€‘</p><p>æˆ‘ä»¬å°è¯•å°†èµ‹å€¼æ“ä½œ <code>data[t] = val</code> ç§»åˆ°å¾ªç¯çš„å¤–é¢, è¿™æ ·å¾ªç¯ä½“å†…çš„æ“ä½œå°±ä¸ä¼šä¿®æ”¹é˜Ÿåˆ—äº†. å½“å¾ªç¯é€€å‡ºæ—¶, èƒ½ç¡®ä¿ <code>tail</code> å‘åç§»åŠ¨äº†ä¸€æ ¼, ä¸” <code>t</code> æŒ‡å‘ <code>tail</code> ç§»åŠ¨å‰çš„ä½ç½®. è¿™æ ·å¹¶å‘çš„æ—¶å€™å°±ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹è¦†ç›–æˆ‘ä»¬å†™å…¥çš„å€¼.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> spsc&lt;T, Cap&gt;::<span class="built_in">push</span>(<span class="type">const</span> T &amp;val) &#123;</span><br><span class="line">    <span class="type">size_t</span> t;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        t = tail.<span class="built_in">load</span>(); <span class="comment">// (1)</span></span><br><span class="line">        <span class="keyword">if</span> ((t + <span class="number">1</span>) % Cap == head.<span class="built_in">load</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!tail.<span class="built_in">compare_exchange_strong</span>(t, (t + <span class="number">1</span>) % Cap)); <span class="comment">// (2)</span></span><br><span class="line">    data[t] = val; <span class="comment">// (3)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ ·åšçš„é—®é¢˜æ˜¯, æˆ‘ä»¬å…ˆç§»åŠ¨ <code>tail</code> æŒ‡é’ˆå†å¯¹ <code>data[t]</code> èµ‹å€¼, ä¼šå¯¼è‡´ <code>push</code> ä¸ <code>pop</code> å¹¶å‘ä¸æ­£ç¡®. å›é¡¾ä¸‹ <code>pop</code> çš„ä»£ç :</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> spsc&lt;T, Cap&gt;::<span class="built_in">pop</span>(T &amp;val) &#123;</span><br><span class="line">    <span class="type">size_t</span> h;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        h = head.<span class="built_in">load</span>();</span><br><span class="line">        <span class="keyword">if</span> (h == tail.<span class="built_in">load</span>()) <span class="comment">// (4)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        val = data[h]; <span class="comment">// (5)</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!head.<span class="built_in">compare_exchange_strong</span>(h, (h + <span class="number">1</span>) % Cap));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ a å’Œ b. å‡è®¾é˜Ÿåˆ—åˆå§‹ä¸ºç©º</p><ul><li>çº¿ç¨‹ a è°ƒç”¨ <code>push</code> , æ‰§è¡Œ a(1), a(2). <code>tail</code> è¢«æ›´æ–°, ç„¶ååˆ‡æ¢åˆ°çº¿ç¨‹ b</li><li>çº¿ç¨‹ b è°ƒç”¨ <code>pop</code> , æ‰§è¡Œ b(4). å› ä¸º <code>tail</code> è¢«æ›´æ–°, å› æ­¤åˆ¤æ–­é˜Ÿåˆ—ä¸ä¸ºç©º</li><li>æ‰§è¡Œåˆ° b(5), ä¼šè¯»å–åˆ°æ— æ•ˆçš„å€¼</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240507205821012.png" alt="image-20240507205821012"></p><p>ã€ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å½“æ»¡è¶³popæ¡ä»¶ï¼Œä½†æ˜¯æ²¡æœ‰å€¼çš„è¿™æ ·é—®é¢˜ã€‘</p><p>ä¸ºäº†å®ç° <code>push</code> ä¸ <code>pop</code> çš„å¹¶å‘, <code>push</code> å¯¹ <code>data[t]</code> çš„å†™å…¥å¿…é¡» â€œhappens-beforeâ€ <code>pop</code> å¯¹ <code>data[h]</code> çš„è¯»å–. å› æ­¤è¿™å°±è¦æ±‚ <code>push</code> æ“ä½œå…ˆå¯¹ <code>data[t]</code> èµ‹å€¼, å†ç§»åŠ¨ <code>tail</code> æŒ‡é’ˆ. å¯æ˜¯å‰é¢ä¸ºäº†å®ç° <code>push</code> ä¸ <code>push</code> çš„å¹¶å‘æˆ‘ä»¬åˆè®© <code>push</code> æ“ä½œå…ˆç§»åŠ¨ <code>tail</code> å†å¯¹ <code>data[t]</code> èµ‹å€¼. å¦‚ä½•è§£å†³è¿™ä¸€çŸ›ç›¾å‘¢?</p><p>è§£å†³åŠæ³•æ˜¯å¼•å…¥ä¸€ä¸ªæ–°çš„æŒ‡é’ˆ <code>write</code> , ç”¨äº <code>push</code> ä¸ <code>pop</code> åŒæ­¥. å®ƒè¡¨ç¤º <code>push</code> æ“ä½œ<strong>å†™åˆ°äº†å“ªä¸ªä½ç½®</strong>.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="type">size_t</span> Cap&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ring_buffer</span> &#123;</span><br><span class="line">    T data[Cap];</span><br><span class="line">    atomic&lt;<span class="type">size_t</span>&gt; head&#123;<span class="number">0</span>&#125;, tail&#123;<span class="number">0</span>&#125;, write&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ring_buffer</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">ring_buffer</span>(<span class="type">const</span> ring_buffer&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    ring_buffer &amp;<span class="keyword">operator</span>=(<span class="type">const</span> ring_buffer&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    ring_buffer &amp;<span class="keyword">operator</span>=(<span class="type">const</span> ring_buffer&amp;) <span class="keyword">volatile</span> = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">push</span><span class="params">(<span class="type">const</span> T &amp;val)</span> </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> t, w;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            t = tail.<span class="built_in">load</span>();</span><br><span class="line">            <span class="keyword">if</span> ((t + <span class="number">1</span>) % Cap == head.<span class="built_in">load</span>())</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!tail.<span class="built_in">compare_exchange_weak</span>(t, (t + <span class="number">1</span>) % Cap)); <span class="comment">// (1)</span></span><br><span class="line">        data[t] = val; <span class="comment">// (2)</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            w = t;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!write.<span class="built_in">compare_exchange_weak</span>(w, (w + <span class="number">1</span>) % Cap)); <span class="comment">// (3), (3) synchronizes-with (4)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">pop</span><span class="params">(T &amp;val)</span> </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> h;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            h = head.<span class="built_in">load</span>();</span><br><span class="line">            <span class="keyword">if</span> (h == write.<span class="built_in">load</span>()) <span class="comment">// (4) è¯» write çš„å€¼</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            val = data[h]; <span class="comment">// (5)</span></span><br><span class="line">        &#125; <span class="keyword">while</span> (!head.<span class="built_in">compare_exchange_strong</span>(h, (h + <span class="number">1</span>) % Cap));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯æš´åŠ›ï¼Œå¤šåŠ ä¸ªå˜é‡è§£å†³ä¸Šè¿°é—®é¢˜ã€‚</p><p><code>push</code> æ“ä½œçš„åŸºæœ¬æ­¥éª¤æ˜¯:</p><ol><li>ç§»åŠ¨ <code>tail</code>;</li><li>å¯¹ <code>data[t]</code> èµ‹å€¼, <code>t</code> ç­‰äº <code>tail</code> ç§»åŠ¨å‰çš„ä½ç½®;</li><li>ç§»åŠ¨ <code>write</code>. <code>write</code> ç§»åŠ¨åç­‰äº <code>tail</code>.</li></ol><p>è€Œ <code>pop</code> æ“ä½œä½¿ç”¨ <code>write</code> æŒ‡é’ˆåˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å…ƒç´ . å› ä¸ºæœ‰ (3) â€œsynchronizes-withâ€ (4), æ‰€ä»¥ (2) â€œhappens-beforeâ€ (5), <code>pop</code> èƒ½è¯»åˆ° <code>push</code> å†™å…¥çš„å€¼. åœ¨ <code>push</code> å‡½æ•°ä¸­, åªæœ‰åœ¨å½“å‰çš„ <code>write</code> ç­‰äº <code>t</code> æ—¶æ‰å°† <code>write</code> ç§»åŠ¨ä¸€æ ¼, èƒ½ç¡®ä¿æœ€ç»ˆ <code>write</code> ç­‰äº <code>tail</code>.</p><p>è¿™ç§å¤šå†™å¤šè¯»çš„æ— é”é˜Ÿåˆ—çš„ä¸¤ç§æ“ä½œå¯ä»¥åŒæ—¶æ‰§è¡Œ, ä½†æ˜¯æ¯ç§æ“ä½œéƒ½æœ‰å¯èƒ½è¦é‡è¯•, å› æ­¤å±äº lock-free ç»“æ„.</p><h3 id="è€ƒè™‘å†…å­˜é¡ºåº">è€ƒè™‘å†…å­˜é¡ºåº</h3><p>å‰é¢ä¾‹å­ä½¿ç”¨é»˜è®¤çš„å†…å­˜é¡ºåº, ä¹Ÿå°±æ˜¯ memory_order_seq_cst . ä¸ºäº†ä¼˜åŒ–æ€§èƒ½, å¯ä»¥ä½¿ç”¨æ›´å®½æ¾çš„å†…å­˜é¡ºåº. è€Œè¦è€ƒè™‘å†…å­˜é¡ºåº, å°±è¦æ‰¾å‡ºå…¶ä¸­çš„ happens-before çš„å…³ç³».</p><p>å‰é¢åˆ†æäº†, <code>push</code> ä¸­çš„èµ‹å€¼æ“ä½œ <code>data[t] = val</code> è¦ â€œhappens-beforeâ€ <code>pop</code> ä¸­çš„è¯»å–æ“ä½œ <code>val = data[h]</code>, è¿™æ˜¯é€šè¿‡ <code>write</code> åŸå­å˜é‡å®ç°çš„: <code>push</code> ä¸­å¯¹ <code>write</code> çš„ä¿®æ”¹è¦ â€œsynchronizes-withâ€ <code>pop</code> ä¸­å¯¹ <code>write</code> çš„è¯»å–. å› æ­¤ <code>push</code> ä¿®æ”¹ <code>write</code> çš„ CAS æ“ä½œåº”è¯¥ä½¿ç”¨ release, <code>pop</code> è¯»å– <code>write</code> æ—¶åˆ™åº”ä½¿ç”¨ acquire.</p><p>åŒç†, å½“é˜Ÿåˆ—åˆå§‹ä¸ºæ»¡çš„æ—¶å€™, å…ˆè¿è¡Œ <code>pop</code> åœ¨è¿è¡Œ <code>push</code>, è¦ä¿è¯ <code>pop</code> ä¸­çš„è¯»å–æ“ä½œ <code>val = data[h]</code> â€œhappens-beforeâ€ <code>push</code> ä¸­çš„èµ‹å€¼æ“ä½œ <code>data[t] = val</code>. è¿™æ˜¯é€šè¿‡ <code>head</code> åŸå­å˜é‡å®ç°çš„: <code>pop</code> ä¸­å¯¹ <code>head</code> çš„ä¿®æ”¹è¦ â€œsynchronizes-withâ€ <code>push</code> ä¸­å¯¹ <code>head</code> çš„è¯»å–. å› æ­¤ <code>pop</code> ä¿®æ”¹ <code>head</code> çš„ CAS æ“ä½œåº”è¯¥ä½¿ç”¨ release, <code>push</code> è¯»å– <code>head</code> æ—¶åˆ™åº”ä½¿ç”¨ acquire.</p><p>è¿™éƒ¨åˆ†å’Œä¸Šé¢ä¸€æ ·ï¼Œå°±æ˜¯</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> ring_buffer&lt;T, Cap&gt;::<span class="built_in">push</span>(<span class="type">const</span> T &amp;val) &#123;</span><br><span class="line">    <span class="type">size_t</span> t, w;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        t = tail.<span class="built_in">load</span>(memory_order_relaxed); <span class="comment">// (1)</span></span><br><span class="line">        <span class="keyword">if</span> ((t + <span class="number">1</span>) % Cap == head.<span class="built_in">load</span>(memory_order_acquire)) <span class="comment">//(2)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!tail.<span class="built_in">compare_exchange_weak</span>(t, (t + <span class="number">1</span>) % Cap, memory_order_relaxed)); <span class="comment">// (3)</span></span><br><span class="line">    data[t] = val; <span class="comment">// (4), (4) happens-before (8)</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        w = t;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!write.<span class="built_in">compare_exchange_weak</span>(w, (w + <span class="number">1</span>) % Cap,</span><br><span class="line">              memory_order_release, memory_order_relaxed)); <span class="comment">// (5), (5) synchronizes-with (7)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> ring_buffer&lt;T, Cap&gt;::<span class="built_in">pop</span>(T &amp;val) &#123;</span><br><span class="line">    <span class="type">size_t</span> h;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        h = head.<span class="built_in">load</span>(memory_order_relaxed); <span class="comment">// (6)</span></span><br><span class="line">        <span class="keyword">if</span> (h == write.<span class="built_in">load</span>(memory_order_acquire)) <span class="comment">// (7)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        val = data[h]; <span class="comment">// (8), (8) happens-before (4)</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!head.<span class="built_in">compare_exchange_strong</span>(h, (h + <span class="number">1</span>) % Cap,</span><br><span class="line">              memory_order_release, memory_order_relaxed)); <span class="comment">// (9), (9) synchronizes-with (2)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>push</code> ä¸ <code>push</code> å¹¶å‘ç§»åŠ¨ <code>tail</code> æŒ‡é’ˆçš„æ—¶å€™, åªå½±å“åˆ° <code>tail</code> æœ¬èº«. å› æ­¤ (1) å’Œ (3) å¯¹ <code>tail</code> è¯»å†™ä½¿ç”¨ relaxed å°±å¯ä»¥äº†. åŒæ · <code>push</code> ä¸ <code>push</code> å¹¶å‘ç§»åŠ¨ <code>write</code> æŒ‡é’ˆæ—¶, ä¹Ÿä¸éœ€è¦åˆ©ç”¨å®ƒåšåŒæ­¥, å› æ­¤ (5) å¤„çš„åšæ³•æ˜¯</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">write.<span class="built_in">compare_exchange_weak</span>(w, (w + <span class="number">1</span>) % Cap,</span><br><span class="line">                            memory_order_release, memory_order_relaxed)</span><br></pre></td></tr></table></figure><p>æˆåŠŸæ—¶ä½¿ç”¨ release, ä¸ºäº†ä¸ <code>pop</code> åŒæ­¥; è€Œå¤±è´¥æ—¶ä½¿ç”¨ relaxed å°±å¯ä»¥äº†.</p><p>åŒç†, <code>pop</code> ä¸ <code>pop</code> å¹¶å‘ç§»åŠ¨ <code>head</code> æ—¶, ä¹Ÿå½±å“åˆ° <code>head</code> æœ¬èº«. å› æ­¤ (6) è¯»å– <code>head</code> ä½¿ç”¨ relaxed å³å¯. è€Œ (9) å¤„ä¸ºäº†ä¸ <code>push</code> åŒæ­¥, æˆåŠŸæ—¶è¦ä½¿ç”¨ release, å¤±è´¥æ—¶ä½¿ç”¨ relaxed å³å¯.</p><p>æœ€åï¼Œç»™å‡ºå®Œæ•´ä»£ç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// type __sync_val_compare_and_swap(type *ptr, type oldval type newval, ...)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="type">size_t</span> Cap&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Queue</span>() : <span class="built_in">data</span>(<span class="keyword">new</span> T[Cap]) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">Queue</span>() &#123; <span class="keyword">delete</span>[] data; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">push</span><span class="params">(<span class="type">const</span> T &amp;val)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> t, w;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            t = tail.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">            <span class="keyword">if</span> ((t + <span class="number">1</span>) % Cap == head.<span class="built_in">load</span>(std::memory_order_acquire))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!tail.<span class="built_in">compare_exchange_strong</span>(t, (t + <span class="number">1</span>) % Cap, memory_order_relaxed));</span><br><span class="line">        data[t % Cap] = val;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Producer:&quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; data:&quot;</span> &lt;&lt; val &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            w = t;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!write.<span class="built_in">compare_exchange_strong</span>(w, (w + <span class="number">1</span>) % Cap, memory_order_release, memory_order_relaxed));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        T val;</span><br><span class="line">        <span class="type">size_t</span> h;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            h = head.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">            <span class="keyword">if</span> (h == write.<span class="built_in">load</span>(std::memory_order_acquire))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            val = data[h % Cap];</span><br><span class="line">        &#125; <span class="keyword">while</span> (!head.<span class="built_in">compare_exchange_strong</span>(h, (h + <span class="number">1</span>) % Cap,</span><br><span class="line">                                               memory_order_release, memory_order_relaxed));</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Comsumer:&quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; data:&quot;</span> &lt;&lt; val &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T *data;</span><br><span class="line">    std::atomic&lt;<span class="type">size_t</span>&gt; head&#123;<span class="number">0</span>&#125;, tail&#123;<span class="number">0</span>&#125;, write&#123;<span class="number">0</span>&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Queue&lt;<span class="type">int</span>, <span class="number">5</span>&gt; q;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!q.<span class="built_in">pop</span>())</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">10</span>));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = <span class="built_in">rand</span>() % <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">if</span> (!q.<span class="built_in">push</span>(num))</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">10</span>));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;thread&gt; p, c;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p.<span class="built_in">emplace_back</span>(Producer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        c.<span class="built_in">emplace_back</span>(Consumer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;ci : c)</span><br><span class="line">        ci.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;pi : p)</span><br><span class="line">        pi.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¼˜åŠ£åŠ¿">ä¼˜åŠ£åŠ¿</h2><h3 id="ä¼˜åŠ¿">ä¼˜åŠ¿</h3><ul><li>å®ç°ç®€å•, å®¹æ˜“ç†è§£ (ç›¸æ¯”æ›´å¤æ‚çš„é“¾å¼ç»“æ„)</li><li>æ— é”é«˜å¹¶å‘. è™½ç„¶å­˜åœ¨å¾ªç¯é‡è¯•, ä½†æ˜¯è¿™åªä¼šåœ¨ç›¸åŒæ“ä½œå¹¶å‘çš„æ—¶å€™å‡ºç°. push ä¸ä¼šå› ä¸ºä¸ pop å¹¶å‘è€Œé‡è¯•, åä¹‹äº¦ç„¶.</li></ul><h3 id="ç¼ºé™·">ç¼ºé™·</h3><ul><li>è¿™æ ·é˜Ÿåˆ—åªåº”è¯¥å­˜å‚¨æ ‡é‡, ä¸åº”è¯¥å­˜å‚¨å¯¹è±¡ (ä½†æ˜¯å¯ä»¥å­˜å‚¨æŒ‡é’ˆ), åŸå› æœ‰ä¸¤ç‚¹<ul><li>pop ä¸­ä¼šå¾ªç¯æ‰§è¡Œ val = data[h] , å¯¹è±¡çš„æ‹·è´ä¼šæœ‰æ€§èƒ½å¼€é”€</li><li>push ä¸­æ‰§è¡Œ data[t] = val ç±»ä¼¼, å¦‚æœæ‹·è´æ—¶é—´è¿‡é•¿, å¯èƒ½ä¼šå¯¼è‡´å¹¶å‘æ‰§è¡Œ push çš„çº¿ç¨‹ä¸€ç›´ç­‰å¾…</li><li>å¦‚æœ push ä¸­ data[t] = val æŠ›å‡ºäº†å¼‚å¸¸, å¯èƒ½ä¼šå¯¼è‡´å¹¶å‘æ‰§è¡Œ push çš„çº¿ç¨‹æ­»é”</li></ul></li><li>ä¸èƒ½å­˜å‚¨æ™ºèƒ½æŒ‡é’ˆ. å› ä¸ºå‡ºé˜Ÿåå¯¹è±¡ä»ç„¶åœ¨ data æ•°ç»„é‡Œ, å¹¶æ²¡æœ‰é”€æ¯.</li><li>å®¹é‡æ˜¯å›ºå®šçš„, ä¸èƒ½åŠ¨æ€æ‰©å®¹.</li></ul><p>å…¶ä¸­ï¼Œç®€å•çš„æ˜¯ç›´æ¥ä½¿ç”¨booståº“ä¸­çš„<code>boost::lockfree::queue</code>ã€‚è¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ— é”é˜Ÿåˆ—ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚</p><p>æœ¬æ–‡å­¦ä¹ è‡ªï¼š<a href="https://luyuhuang.tech/2022/10/30/lock-free-queue.html#cas-%E6%93%8D%E4%BD%9C">C++ å®ç°æ— é”é˜Ÿåˆ—</a></p>]]></content>
    
    
    <summary type="html">Lock-Free Queue</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>Cppå†…å­˜é¡ºåº</title>
    <link href="https://penge666.github.io/posts/4c8902bb.html"/>
    <id>https://penge666.github.io/posts/4c8902bb.html</id>
    <published>2024-05-07T03:31:55.000Z</published>
    <updated>2024-05-07T13:27:13.984Z</updated>
    
    <content type="html"><![CDATA[<p>C++11 å°†å¤šçº¿ç¨‹çº³å…¥äº†æ ‡å‡†. ä¸€æ—¦æ¶‰åŠåˆ°å¤šçº¿ç¨‹, å°±éœ€è¦è€ƒè™‘<strong>å¹¶å‘</strong>, <strong>æ•°æ®ç«äº‰ (date race)</strong>, <strong>çº¿ç¨‹åŒæ­¥</strong>ç­‰é—®é¢˜, ä¸ºæ­¤ C++ æä¾›äº†äº’æ–¥é” <code>std::mutex</code>, åŸå­å˜é‡ <code>std::atomic</code> ç­‰æ ‡å‡†åº“ã€‚</p><p>æŠŠåšå®¢ä¸­çš„ä¾‹å­ç†è§£æ¸…æ¥šã€‚</p><h2 id="1-åŸå­å˜é‡">1. åŸå­å˜é‡</h2><p>æˆ‘ä»¬ä¸èƒ½åœ¨ä¸¤ä¸ªçº¿ç¨‹ä¸­åŒæ—¶è®¿é—®ä¿®æ”¹ä¸€ä¸ªå˜é‡, è¿™ä¼šå¯¼è‡´æ•°æ®ç«äº‰çš„é—®é¢˜. ç¨‹åºçš„ç»“æœæ˜¯æœªå®šä¹‰çš„. ä»å®ç°ä¸Šæ¥è¯´, æˆ‘ä»¬ä¸èƒ½ä¿è¯è¯»å†™æ“ä½œæ˜¯åŸå­çš„, ä¾‹å¦‚ 32 ä½æœºå™¨ä¸Š, ä¿®æ”¹ä¸€ä¸ª 64 ä½å˜é‡å¯èƒ½éœ€è¦ä¸¤æ¡æŒ‡ä»¤; æˆ–è€…å˜é‡æœ‰å¯èƒ½åªæ˜¯åœ¨å¯„å­˜å™¨é‡Œ, å¯¹å…¶çš„ä¿®æ”¹è¦åœ¨ç¨åæ‰ä¼šå†™å…¥å†…å­˜. è§£å†³æ•°æ®ç«äº‰çš„æ–¹å¼é™¤äº†ä½¿ç”¨ <code>std::mutex</code> åŠ é”, è¿˜å¯ä»¥ä½¿ç”¨åŸå­å˜é‡.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">int</span>&gt; a&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    a = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; a &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­å±•ç¤ºäº†åŸå­å˜é‡æœ€ç®€å•çš„ç”¨æ³•. ä½¿ç”¨åŸå­å˜é‡ä¸ç”¨æ‹…å¿ƒæ•°æ®ç«äº‰, å¯¹å®ƒçš„æ“ä½œéƒ½æ˜¯åŸå­çš„. <strong>é™¤æ­¤ä¹‹å¤–, åŸå­å˜é‡çš„æ“ä½œå¯ä»¥æŒ‡å®šå†…å­˜é¡ºåº, å¸®åŠ©æˆ‘ä»¬å®ç°çº¿ç¨‹åŒæ­¥, è¿™ä¹Ÿæ˜¯æœ¬æ–‡çš„é‡ç‚¹</strong>. ä¸Šé¢çš„ä»£ç ä¸­, çº¿ç¨‹ 1 å°†å€¼å†™å…¥åŸå­å˜é‡ <code>a</code>, çº¿ç¨‹ 2 åˆ™è¯»å– <code>a</code> ä¸­çš„å€¼. è¿™ä¾¿æ˜¯åŸå­å˜é‡æœ€åŸºç¡€çš„ä¸¤ç§æ“ä½œã€‚</p><h3 id="1-1-åŸå­å˜é‡çš„æ“ä½œ">1.1 åŸå­å˜é‡çš„æ“ä½œ</h3><p>å¯¹åŸå­å˜é‡çš„æ“ä½œå¯ä»¥åˆ†ä¸ºä¸‰ç§</p><ol><li>store. å°†ä¸€ä¸ªå€¼å­˜åˆ°åŸå­å˜é‡ä¸­.</li><li>load. è¯»å–åŸå­å˜é‡ä¸­çš„å€¼.</li><li>read-modify-write (RMW). åŸå­åœ°æ‰§è¡Œè¯»å–, ä¿®æ”¹å’Œå†™å…¥. å¦‚è‡ªå¢æ“ä½œ <code>fetch_add</code>, äº¤æ¢æ“ä½œ <code>exchange</code> (è¿”å›å˜é‡å½“å‰çš„å€¼å¹¶å†™å…¥æŒ‡å®šå€¼) ç­‰.</li></ol><p>æ¯ä¸ªåŸå­æ“ä½œéƒ½éœ€è¦æŒ‡å®šä¸€ä¸ª<strong>å†…å­˜é¡ºåº (memory order)</strong>. ä¸åŒçš„å†…å­˜é¡ºåºæœ‰ä¸åŒçš„è¯­ä¹‰, ä¼šå®ç°ä¸åŒçš„é¡ºåºæ¨¡å‹ (order model), æ€§èƒ½ä¹Ÿå„ä¸ç›¸åŒ. C++ ä¸­æœ‰å…­ç§å†…å­˜é¡ºåº</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">memory_order</span> &#123;</span><br><span class="line">    memory_order_relaxed,</span><br><span class="line">    memory_order_consume,</span><br><span class="line">    memory_order_acquire,</span><br><span class="line">    memory_order_release,</span><br><span class="line">    memory_order_acq_rel,</span><br><span class="line">    memory_order_seq_cst,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>è¿™å…­ç§å†…å­˜é¡ºåºç›¸äº’ç»„åˆå¯ä»¥å®ç°ä¸‰ç§é¡ºåºæ¨¡å‹ (ordering model)</strong></p><ul><li><strong>Sequencial consistent ordering. å®ç°åŒæ­¥, ä¸”ä¿è¯å…¨å±€é¡ºåºä¸€è‡´ (single total order) çš„æ¨¡å‹. æ˜¯ä¸€è‡´æ€§æœ€å¼ºçš„æ¨¡å‹, ä¹Ÿæ˜¯é»˜è®¤çš„é¡ºåºæ¨¡å‹.</strong></li><li><strong>Acquire-release ordering. å®ç°åŒæ­¥, ä½†ä¸ä¿è¯ä¿è¯å…¨å±€é¡ºåºä¸€è‡´çš„æ¨¡å‹.</strong></li><li><strong>Relaxed ordering. ä¸èƒ½å®ç°åŒæ­¥, åªä¿è¯åŸå­æ€§çš„æ¨¡å‹.</strong></li></ul><p>ç¨åæˆ‘ä»¬ä¼šè¯¦ç»†è®¨è®ºè¿™å…­ç§å†…å­˜é¡ºåº. <code>atomic::store</code> å’Œ <code>atomic::load</code> å‡½æ•°éƒ½æœ‰ä¸€ä¸ªå†…å­˜é¡ºåºçš„å‚æ•°, é»˜è®¤ä¸º <code>memory_order_seq_cst</code>. å®ƒä»¬çš„å£°æ˜å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">store</span><span class="params">(T desired, std::memory_order order = std::memory_order_seq_cst)</span></span>;</span><br><span class="line"><span class="function">T <span class="title">load</span><span class="params">(std::memory_order order = std::memory_order_seq_cst)</span> <span class="type">const</span></span>;</span><br></pre></td></tr></table></figure><p>æ­¤å¤– <code>std::atomic</code> é‡è½½äº†è¿ç®—ç¬¦, æˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨æ™®é€šå˜é‡ä¸€æ ·è¯»å†™åŸå­å˜é‡. ä¾‹å¦‚ä¸Šé¢ä»£ç ä¸­ä¸¤ä¸ªçº¿ç¨‹çš„è¯»å†™æ“ä½œåˆ†åˆ«è°ƒç”¨çš„æ˜¯ <code>std::atomic&lt;int&gt;::operator=(int)</code> å’Œ <code>std::atomic&lt;int&gt;::operator int()</code>. æ­¤æ—¶ä¼šä½¿ç”¨é»˜è®¤çš„å†…å­˜é¡ºåº, ä¹Ÿå°±æ˜¯ <code>memory_order_seq_cst</code>ã€‚</p><h2 id="2-åŸºç¡€æ¦‚å¿µ">2. åŸºç¡€æ¦‚å¿µ</h2><p>åœ¨å¼€å§‹è®²è¿™å…­ç§å†…å­˜é¡ºåºä¹‹å‰, æœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹å‡ ä¸ªæœ€åŸºç¡€çš„æ¦‚å¿µ.</p><h3 id="2-1-ä¿®æ”¹é¡ºåº-Modification-orders">2.1 ä¿®æ”¹é¡ºåº (Modification orders)</h3><p>å¯¹ä¸€ä¸ªåŸå­å˜é‡çš„æ‰€æœ‰ä¿®æ”¹æ“ä½œæ€»æ˜¯å­˜åœ¨ä¸€å®šçš„å…ˆåé¡ºåº, ä¸”æ‰€æœ‰çº¿ç¨‹éƒ½è®¤å¯è¿™ä¸ªé¡ºåº, å³ä½¿è¿™äº›ä¿®æ”¹æ“ä½œæ˜¯åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œçš„. è¿™ä¸ªæ‰€æœ‰çº¿ç¨‹ä¸€è‡´åŒæ„çš„é¡ºåºå°±ç§°ä¸º<strong>ä¿®æ”¹é¡ºåº (modification order)</strong>. è¿™æ„å‘³ç€</p><ul><li>ä¸¤ä¸ªä¿®æ”¹æ“ä½œä¸å¯èƒ½åŒæ—¶è¿›è¡Œ, ä¸€å®šå­˜åœ¨ä¸€ä¸ªå…ˆåé¡ºåº. è¿™å¾ˆå®¹æ˜“ç†è§£, å› ä¸ºè¿™æ˜¯åŸå­æ“ä½œå¿…é¡»ä¿è¯çš„, å¦åˆ™å°±æœ‰æ•°æ®ç«äº‰çš„é—®é¢˜.</li><li>å³ä½¿æ¯æ¬¡è¿è¡Œçš„ä¿®æ”¹é¡ºåºå¯èƒ½éƒ½ä¸åŒ, ä½†æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„ä¿®æ”¹é¡ºåºæ€»æ˜¯ä¸€è‡´çš„. å¦‚æœçº¿ç¨‹ a çœ‹åˆ°åŸå­å˜é‡ x ç”± 1 å˜æˆ 2, é‚£ä¹ˆçº¿ç¨‹ b å°±ä¸å¯èƒ½çœ‹åˆ° x ç”± 2 å˜æˆ 1.</li></ul><p>æ— è®ºä½¿ç”¨å“ªç§å†…å­˜é¡ºåº, åŸå­å˜é‡çš„æ“ä½œæ€»èƒ½æ»¡è¶³ä¿®æ”¹é¡ºåºä¸€è‡´æ€§, å³ä½¿æ˜¯æœ€æ¾æ•£çš„ <code>memory_order_relaxed</code>. æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">int</span>&gt; a&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i += <span class="number">2</span>)</span><br><span class="line">        a.<span class="built_in">store</span>(i, std::memory_order_relaxed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">10</span>; i += <span class="number">2</span>)</span><br><span class="line">        a.<span class="built_in">store</span>(i, std::memory_order_relaxed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread3</span><span class="params">(vector&lt;<span class="type">int</span>&gt; *v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i)</span><br><span class="line">        v-&gt;<span class="built_in">push_back</span>(a.<span class="built_in">load</span>(std::memory_order_relaxed));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread4</span><span class="params">(vector&lt;<span class="type">int</span>&gt; *v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i)</span><br><span class="line">        v-&gt;<span class="built_in">push_back</span>(a.<span class="built_in">load</span>(std::memory_order_relaxed));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; v3, v4;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(thread1)</span>, <span class="title">t2</span><span class="params">(thread2)</span>, <span class="title">t3</span><span class="params">(thread3, &amp;v3)</span>, <span class="title">t4</span><span class="params">(thread4, &amp;v4)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>(), t2.<span class="built_in">join</span>(), t3.<span class="built_in">join</span>(), t4.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i : v3) cout &lt;&lt; i &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i : v4) cout &lt;&lt; i &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç åˆ›å»ºäº† 4 ä¸ªçº¿ç¨‹. <code>thread1</code> å’Œ <code>thread2</code> åˆ†åˆ«å°†å¶æ•°å’Œå¥‡æ•°ä¾æ¬¡å†™å…¥åŸå­å˜é‡ <code>a</code>, <code>thread3</code> å’Œ <code>thread4</code> åˆ™è¯»å–å®ƒä»¬. æœ€åè¾“å‡º <code>thread3</code> å’Œ <code>thread4</code> æ¯æ¬¡è¯»å–åˆ°çš„å€¼. ç¨‹åºè¿è¡Œçš„ç»“æœå¯èƒ½æ˜¯è¿™æ ·çš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./test-modification-order</span><br><span class="line"><span class="number">1</span> <span class="number">8</span> <span class="number">7</span> <span class="number">7</span> <span class="number">7</span> <span class="number">9</span> <span class="number">9</span> <span class="number">9</span> <span class="number">9</span> <span class="number">9</span></span><br><span class="line"><span class="number">0</span> <span class="number">2</span> <span class="number">8</span> <span class="number">8</span> <span class="number">8</span> <span class="number">7</span> <span class="number">9</span> <span class="number">9</span> <span class="number">9</span> <span class="number">9</span></span><br><span class="line"></span><br><span class="line">$ ./test-modification-order</span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">5</span> <span class="number">6</span> <span class="number">9</span> <span class="number">9</span> <span class="number">9</span> <span class="number">8</span> <span class="number">8</span> <span class="number">8</span></span><br><span class="line"><span class="number">1</span> <span class="number">3</span> <span class="number">2</span> <span class="number">5</span> <span class="number">9</span> <span class="number">8</span> <span class="number">8</span> <span class="number">8</span> <span class="number">8</span> <span class="number">8</span></span><br></pre></td></tr></table></figure><p>è™½ç„¶æ¯æ¬¡è¿è¡Œçš„ä¿®æ”¹é¡ºåºä¸åŒ, å„ä¸ªçº¿ç¨‹ä¹Ÿä¸å¤ªå¯èƒ½çœ‹åˆ°æ¯æ¬¡ä¿®æ”¹çš„ç»“æœ, ä½†æ˜¯å®ƒä»¬çœ‹åˆ°çš„ä¿®æ”¹é¡ºåºæ˜¯ä¸€è‡´çš„. ä¾‹å¦‚ <code>thread3</code> çœ‹åˆ° 8 å…ˆäº 9, <code>thread4</code> ä¹Ÿä¼šçœ‹åˆ° 8 å…ˆäº 9, åä¹‹äº¦ç„¶.</p><h3 id="2-2-Happens-before">2.2 Happens-before</h3><p><strong>Happens-before</strong> æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µ. å¦‚æœæ“ä½œ a â€œhappens-beforeâ€ æ“ä½œ b, åˆ™æ“ä½œ a çš„ç»“æœå¯¹äºæ“ä½œ b å¯è§. happens-before çš„å…³ç³»å¯ä»¥å»ºç«‹åœ¨ç”¨ä¸€ä¸ªçº¿ç¨‹çš„ä¸¤ä¸ªæ“ä½œä¹‹é—´, ä¹Ÿå¯ä»¥å»ºç«‹åœ¨ä¸åŒçš„çº¿ç¨‹çš„ä¸¤ä¸ªæ“ä½œä¹‹é—´.</p><h4 id="2-2-1-å•çº¿ç¨‹çš„æƒ…å†µ-sequenced-before">2.2.1 å•çº¿ç¨‹çš„æƒ…å†µ: sequenced-before</h4><p>å•çº¿ç¨‹çš„æƒ…å†µå¾ˆå®¹æ˜“ç†è§£. å‡½æ•°çš„è¯­å¥æŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œ, å‰é¢çš„è¯­å¥å…ˆæ‰§è¡Œ, åé¢çš„åæ‰§è¡Œ. æ­£å¼åœ°è¯´, å‰é¢çš„è¯­å¥æ€»æ˜¯ <strong>â€œsequenced-beforeâ€</strong> åé¢çš„è¯­å¥. æ˜¾ç„¶, æ ¹æ®å®šä¹‰, sequenced-before å…·æœ‰ä¼ é€’æ€§:</p><ul><li>å¦‚æœæ“ä½œ a â€œsequenced-beforeâ€ æ“ä½œ k, ä¸”æ“ä½œ k â€œsequenced-beforeâ€ æ“ä½œ b, åˆ™æ“ä½œ a â€œsequenced-beforeâ€ æ“ä½œ b.</li></ul><p>Sequenced-before å¯ä»¥ç›´æ¥æ„æˆ happens-before çš„å…³ç³». å¦‚æœæ“ä½œ a â€œsequenced-beforeâ€ æ“ä½œ b, åˆ™æ“ä½œ a â€œhappens-beforeâ€ æ“ä½œ b. ä¾‹å¦‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">42</span>; <span class="comment">// (1)</span></span><br><span class="line">cout &lt;&lt; a &lt;&lt; endl; <span class="comment">// (2)</span></span><br></pre></td></tr></table></figure><p>è¯­å¥ (1) åœ¨è¯­å¥ (2) çš„å‰é¢, å› æ­¤è¯­å¥ (1) â€œsequenced-beforeâ€ è¯­å¥ (2), ä¹Ÿå°±æ˜¯ (1) â€œhappens-beforeâ€ è¯­å¥ (2). æ‰€ä»¥ (2) å¯ä»¥æ‰“å°å‡º (1) èµ‹å€¼çš„ç»“æœ.</p><h4 id="2-2-2-å¤šçº¿ç¨‹çš„æƒ…å†µ-synchronizes-with-å’Œ-inter-thread-happens-before">2.2.2 å¤šçº¿ç¨‹çš„æƒ…å†µ: synchronizes-with å’Œ inter-thread happens-before</h4><p>å¤šçº¿ç¨‹çš„æƒ…å†µå°±ç¨å¾®å¤æ‚äº›. ä¸€èˆ¬æ¥è¯´å¤šçº¿ç¨‹éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„, å¦‚æœæ²¡æœ‰æ­£ç¡®çš„åŒæ­¥æ“ä½œ, å°±æ— æ³•ä¿è¯ä¸¤ä¸ªæ“ä½œä¹‹é—´æœ‰ happens-before çš„å…³ç³». å¦‚æœæˆ‘ä»¬é€šè¿‡ä¸€äº›æ‰‹æ®µ, è®©ä¸åŒçº¿ç¨‹çš„ä¸¤ä¸ªæ“ä½œåŒæ­¥, æˆ‘ä»¬ç§°è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´æœ‰ <strong>synchronizes-with</strong> çš„å…³ç³». ç¨åæˆ‘ä»¬ä¼šè¯¦ç»†è®¨è®ºå¦‚ä½•ç»„åˆä½¿ç”¨ 6 ç§å†…å­˜é¡ºåº, è®©ä¸¤ä¸ªæ“ä½œè¾¾æˆ synchronizes-with çš„å…³ç³».</p><p>å¦‚æœçº¿ç¨‹ 1 ä¸­çš„æ“ä½œ a â€œsynchronizes-withâ€ çº¿ç¨‹ 2 ä¸­çš„æ“ä½œ b, åˆ™æ“ä½œ a <strong>â€œinter-thread happens-beforeâ€</strong> æ“ä½œ b. æ­¤å¤– synchronizes-with è¿˜å¯ä»¥ â€œåæ¥â€ ä¸€ä¸ª sequenced-before å…³ç³»ç»„åˆæˆ inter-thread happens-before çš„å…³ç³»:</p><ul><li>å¦‚æœæ“ä½œ a â€œsynchronizes-withâ€ æ“ä½œ k, ä¸”æ“ä½œ k â€œsequenced-beforeâ€ æ“ä½œ b, åˆ™æ“ä½œ a â€œinter-thread happens-beforeâ€ æ“ä½œ b.</li></ul><p>Inter-thread happens-before å…³ç³»åˆ™å¯ä»¥ â€œå‰æ¥â€ ä¸€ä¸ª sequenced-before å…³ç³»ä»¥å»¶ä¼¸å®ƒçš„èŒƒå›´; è€Œä¸” inter-thread happens-before å…³ç³»å…·æœ‰ä¼ é€’æ€§:</p><ul><li>å¦‚æœæ“ä½œ a â€œsequenced-beforeâ€ æ“ä½œ k, ä¸”æ“ä½œ k â€œinter-thread happens-beforeâ€ æ“ä½œ b, åˆ™æ“ä½œ a â€œinter-thread happens-beforeâ€ æ“ä½œ b.</li><li>å¦‚æœæ“ä½œ a â€œinter-thread happens-beforeâ€ æ“ä½œ k, ä¸”æ“ä½œ k â€œinter-thread happens-beforeâ€ æ“ä½œ b, åˆ™æ“ä½œ a â€œinter-thread happens-beforeâ€ æ“ä½œ b.</li></ul><p>æ­£å¦‚å®ƒçš„åå­—æš—ç¤ºçš„, å¦‚æœæ“ä½œ a â€œinter-thread happens-beforeâ€ æ“ä½œ b, åˆ™æ“ä½œ a â€œhappens-beforeâ€ æ“ä½œ b. ä¸‹å›¾å±•ç¤ºäº†è¿™å‡ ä¸ªæ¦‚å¿µä¹‹é—´çš„å…³ç³»:</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240507143104191.png" alt=""></p><p>æ³¨æ„, è™½ç„¶ sequenced-before å’Œ inter-thread happens-before éƒ½æœ‰ä¼ é€’æ€§, ä½†æ˜¯ <strong>happens-before æ²¡æœ‰ä¼ é€’æ€§</strong>. åé¢æˆ‘ä»¬ä¼šåœ¨ 3.5 èŠ‚ä¸­çœ‹åˆ°è¿™ä¸ªæ€§è´¨çš„é‡è¦æ€§, ä»¥åŠ C++ ä¸ºä»€ä¹ˆè¦å®šä¹‰è¿™ä¹ˆå¤šæ¦‚å¿µ.</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­. å‡è®¾ä¸‹é¢çš„ä»£ç ä¸­ <code>unlock()</code> æ“ä½œ â€œsynchronizes-withâ€ <code>lock()</code> æ“ä½œ.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    a += <span class="number">1</span> <span class="comment">// (1)</span></span><br><span class="line">    <span class="built_in">unlock</span>(); <span class="comment">// (2)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">lock</span>(); <span class="comment">// (3)</span></span><br><span class="line">    cout &lt;&lt; a &lt;&lt; endl; <span class="comment">// (4)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ç›´åˆ° <code>thread1</code> æ‰§è¡Œåˆ° (2) ä¹‹å‰, <code>thread2</code> éƒ½ä¼šé˜»å¡åœ¨ (3) å¤„çš„ <code>lock()</code> ä¸­. é‚£ä¹ˆå¯ä»¥æ¨å¯¼å‡º:</p><ul><li>æ ¹æ®è¯­å¥é¡ºåº, æœ‰ (1) â€œsequenced-beforeâ€ (2) ä¸” (3) â€œsequenced-beforeâ€ (4);</li><li>å› ä¸º (2) â€œsynchronizes-withâ€ (3) ä¸” (3) â€œsequenced-beforeâ€ (4), æ‰€ä»¥ (2) â€œinter-thread happens-beforeâ€ (4);</li><li>å› ä¸º (1) â€œsequenced-beforeâ€ (2) ä¸” (2) â€œinter-thread happens-beforeâ€ (4), æ‰€ä»¥ (1) â€œinter-thread happens-beforeâ€ (4); æ‰€ä»¥ (1) â€œhappens-beforeâ€ (4).</li></ul><p>å› æ­¤ (4) å¯ä»¥è¯»åˆ° (1) å¯¹å˜é‡ <code>a</code> çš„ä¿®æ”¹.</p><h3 id="2-3-Happens-before-ä¸ä»£è¡¨æŒ‡ä»¤å®é™…çš„æ‰§è¡Œé¡ºåº">2.3 Happens-before ä¸ä»£è¡¨æŒ‡ä»¤å®é™…çš„æ‰§è¡Œé¡ºåº</h3><p>éœ€è¦è¯´æ˜çš„æ˜¯, happens-before æ˜¯ C++ è¯­ä¹‰å±‚é¢çš„æ¦‚å¿µ, å®ƒå¹¶ä¸ä»£è¡¨æŒ‡ä»¤åœ¨ CPU ä¸­å®é™…çš„æ‰§è¡Œé¡ºåº. ä¸ºäº†ä¼˜åŒ–æ€§èƒ½, ç¼–è¯‘å™¨ä¼šåœ¨ä¸ç ´åè¯­ä¹‰çš„å‰æä¸‹å¯¹æŒ‡ä»¤é‡æ’. ä¾‹å¦‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> a, b;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    a++;</span><br><span class="line">    b++;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶æœ‰ <code>a++;</code> â€œhappens-beforeâ€ <code>b++;</code>, ä½†ç¼–è¯‘å™¨å®é™…ç”Ÿæˆçš„æŒ‡ä»¤å¯èƒ½æ˜¯å…ˆåŠ è½½ <code>a</code>, <code>b</code> ä¸¤ä¸ªå˜é‡åˆ°å¯„å­˜å™¨, æ¥ç€åˆ†åˆ«æ‰§è¡Œ â€œåŠ ä¸€â€ æ“ä½œ, ç„¶åå†æ‰§è¡Œ <code>a + b</code>, æœ€åæ‰å°†è‡ªå¢çš„ç»“æœå†™å…¥å†…å­˜.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add():</span><br><span class="line">    movl    a(%rip), %eax   # å°†å˜é‡ a åŠ è½½åˆ°å¯„å­˜å™¨</span><br><span class="line">    movl    b(%rip), %ecx   # å°†å˜é‡ b åŠ è½½åˆ°å¯„å­˜å™¨</span><br><span class="line">    addl    $1, %eax        # a çš„å€¼åŠ ä¸€</span><br><span class="line">    leal    1(%rcx), %edx   # b çš„å€¼åŠ ä¸€</span><br><span class="line">    movl    %eax, a(%rip)   # å°† a åŠ ä¸€çš„ç»“æœå†™å…¥å†…å­˜</span><br><span class="line">    addl    %edx, %eax      # a + b</span><br><span class="line">    movl    %edx, b(%rip)   # å°† b åŠ ä¸€çš„ç»“æœå†™å…¥å†…å­˜</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å±•ç¤ºäº† x86-64 ä¸‹çš„ä¸€ç§å¯èƒ½çš„ç¼–è¯‘ç»“æœ. å¯ä»¥çœ‹åˆ° C++ çš„ä¸€æ¡è¯­å¥å¯èƒ½äº§ç”Ÿå¤šæ¡æŒ‡ä»¤, è¿™äº›æŒ‡ä»¤éƒ½æ˜¯äº¤é”™æ‰§è¡Œçš„. å…¶å®ç¼–è¯‘å™¨ç”šè‡³è¿˜æœ‰å¯èƒ½å…ˆè‡ªå¢ <code>b</code> å†è‡ªå¢ <code>a</code>. è¿™æ ·çš„é‡æ’å¹¶ä¸ä¼šå½±å“è¯­ä¹‰, ä¸¤ä¸ªè‡ªå¢æ“ä½œçš„ç»“æœä»ç„¶å¯¹ <code>return a + b;</code> å¯è§.</p><h2 id="3-å†…å­˜é¡ºåº">3. å†…å­˜é¡ºåº</h2><p>å‰é¢æˆ‘ä»¬æåˆ° C++ çš„å…­ç§å†…å­˜é¡ºåºç›¸äº’ç»„åˆå¯ä»¥å®ç°ä¸‰ç§é¡ºåºæ¨¡å‹. ç°åœ¨æˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹å¦‚ä½•ä½¿ç”¨è¿™å…­ç§å†…å­˜é¡ºåº, ä»¥åŠæ€æ ·çš„ç»„åˆå¯ä»¥å®ç° synchronizes-with çš„å…³ç³».</p><h3 id="3-1-memory-order-seq-cst">3.1 memory_order_seq_cst</h3><p><code>memory_order_seq_cst</code> å¯ä»¥ç”¨äº store, load å’Œ read-modify-write æ“ä½œ, å®ç° sequencial consistent çš„é¡ºåºæ¨¡å‹. åœ¨è¿™ä¸ªæ¨¡å‹ä¸‹, æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ‰€æœ‰æ“ä½œéƒ½æœ‰ä¸€ä¸ªä¸€è‡´çš„é¡ºåº, å³ä½¿è¿™äº›æ“ä½œå¯èƒ½é’ˆå¯¹ä¸åŒçš„å˜é‡, è¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹. 2.1 èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº†ä¿®æ”¹é¡ºåº (modification order), å³å•ä¸€å˜é‡çš„ä¿®æ”¹é¡ºåºåœ¨æ‰€æœ‰çº¿ç¨‹çœ‹æ¥éƒ½æ˜¯ä¸€è‡´çš„. Sequencial consistent åˆ™å°†è¿™ç§ä¸€è‡´æ€§æ‰©å±•åˆ°äº†æ‰€æœ‰å˜é‡. ä¾‹å¦‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">bool</span>&gt; x&#123;<span class="literal">false</span>&#125;, y&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    x.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_seq_cst); <span class="comment">// (1)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    y.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_seq_cst); <span class="comment">// (2)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>thread1</code> å’Œ <code>thread2</code> åˆ†åˆ«ä¿®æ”¹åŸå­å˜é‡ <code>x</code> å’Œ <code>y</code>. è¿è¡Œè¿‡ç¨‹ä¸­, æœ‰å¯èƒ½å…ˆæ‰§è¡Œ (1) å†æ‰§è¡Œ (2), ä¹Ÿæœ‰å¯èƒ½å…ˆæ‰§è¡Œ (2) åæ‰§è¡Œ (1). ä½†æ— è®ºå¦‚ä½•, æ‰€æœ‰çº¿ç¨‹ä¸­çœ‹åˆ°çš„é¡ºåºéƒ½æ˜¯ä¸€è‡´çš„. å› æ­¤å¦‚æœæˆ‘ä»¬è¿™æ ·æµ‹è¯•è¿™æ®µä»£ç :</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">int</span>&gt; z&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_x_then_y</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!x.<span class="built_in">load</span>(std::memory_order_seq_cst)); <span class="comment">// (3)</span></span><br><span class="line">    <span class="keyword">if</span> (y.<span class="built_in">load</span>(std::memory_order_seq_cst)) ++z; <span class="comment">// (4)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_y_then_x</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!y.<span class="built_in">load</span>(std::memory_order_seq_cst)); <span class="comment">// (5)</span></span><br><span class="line">    <span class="keyword">if</span> (x.<span class="built_in">load</span>(std::memory_order_seq_cst)) ++z; <span class="comment">// (6)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">a</span><span class="params">(thread1)</span>, <span class="title">b</span><span class="params">(thread2)</span>, <span class="title">c</span><span class="params">(read_x_then_y)</span>, <span class="title">d</span><span class="params">(read_y_then_x)</span></span>;</span><br><span class="line">    a.<span class="built_in">join</span>(), b.<span class="built_in">join</span>(), c.<span class="built_in">join</span>(), d.<span class="built_in">join</span>();</span><br><span class="line">    <span class="built_in">assert</span>(z.<span class="built_in">load</span>() != <span class="number">0</span>); <span class="comment">// (7)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(7) å¤„çš„æ–­è¨€æ°¸è¿œä¸ä¼šå¤±è´¥. <strong>å› ä¸º <code>x</code> å’Œ <code>y</code> çš„ä¿®æ”¹é¡ºåºæ˜¯å…¨å±€ä¸€è‡´çš„, å¦‚æœå…ˆæ‰§è¡Œ (1) åæ‰§è¡Œ (2), åˆ™ <code>read_y_then_x</code> ä¸­å¾ªç¯ (5) é€€å‡ºæ—¶, èƒ½ä¿è¯ <code>y</code> ä¸º <code>true</code>, æ­¤æ—¶ <code>x</code> ä¹Ÿå¿…ç„¶ä¸º <code>true</code>, å› æ­¤ (6) ä¼šè¢«æ‰§è¡Œ; åŒç†, å¦‚æœå…ˆæ‰§è¡Œ (2) åæ‰§è¡Œ (1), åˆ™å¾ªç¯ (3) é€€å‡ºæ—¶ <code>y</code> ä¹Ÿå¿…ç„¶ä¸º <code>true</code>, å› æ­¤ (4) ä¼šè¢«æ‰§è¡Œ. æ— è®ºå¦‚ä½•, <code>z</code> æœ€ç»ˆéƒ½ä¸ä¼šç­‰äº 0.</strong></p><p>Sequencial consistent å¯ä»¥å®ç° synchronizes-with çš„å…³ç³». å¦‚æœä¸€ä¸ª <code>memory_order_seq_cst</code> çš„ load æ“ä½œåœ¨æŸä¸ªåŸå­å˜é‡ä¸Šè¯»åˆ°äº†ä¸€ä¸ª <code>memory_order_seq_cst</code> çš„ store æ“ä½œåœ¨è¿™ä¸ªåŸå­å˜é‡ä¸­å†™å…¥çš„å€¼, åˆ™ store æ“ä½œ â€œsynchronizes-withâ€ load æ“ä½œ. åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, æœ‰ (1) â€œsynchronizes-withâ€ (3) å’Œ (2) â€œsynchronizes-withâ€ (5).</p><p>å®ç° sequencial consistent æ¨¡å‹æœ‰ä¸€å®šçš„å¼€é”€. ç°ä»£ CPU é€šå¸¸æœ‰å¤šæ ¸, æ¯ä¸ªæ ¸å¿ƒè¿˜æœ‰è‡ªå·±çš„ç¼“å­˜. ä¸ºäº†åšåˆ°<strong>å…¨å±€é¡ºåºä¸€è‡´</strong>, æ¯æ¬¡å†™å…¥æ“ä½œéƒ½å¿…é¡»åŒæ­¥ç»™å…¶ä»–æ ¸å¿ƒ. ä¸ºäº†å‡å°‘æ€§èƒ½å¼€é”€, å¦‚æœä¸éœ€è¦å…¨å±€é¡ºåºä¸€è‡´, æˆ‘ä»¬åº”è¯¥è€ƒè™‘ä½¿ç”¨æ›´åŠ å®½æ¾çš„é¡ºåºæ¨¡å‹.</p><h3 id="3-2-memory-order-relaxed">3.2 memory_order_relaxed</h3><p><code>memory_order_relaxed</code> å¯ä»¥ç”¨äº store, load å’Œ read-modify-write æ“ä½œ, å®ç° relaxed çš„é¡ºåºæ¨¡å‹. è¿™ç§æ¨¡å‹ä¸‹, åªèƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§å’Œä¿®æ”¹é¡ºåº (modification order) ä¸€è‡´æ€§, æ— æ³•å®ç° synchronizes-with çš„å…³ç³». ä¾‹å¦‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">bool</span>&gt; x&#123;<span class="literal">false</span>&#125;, y&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    x.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_relaxed); <span class="comment">// (1)</span></span><br><span class="line">    y.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_relaxed); <span class="comment">// (2)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>thread1</code> å¯¹ä¸åŒçš„å˜é‡æ‰§è¡Œ store æ“ä½œ. é‚£ä¹ˆåœ¨æŸäº›çº¿ç¨‹çœ‹æ¥, æœ‰å¯èƒ½æ˜¯ <code>x</code> å…ˆå˜ä¸º <code>true</code>, y åå˜ä¸º <code>true</code>; å¦ä¸€äº›çº¿ç¨‹çœ‹æ¥, åˆæœ‰å¯èƒ½æ˜¯ <code>y</code> å…ˆå˜ä¸º <code>true</code>, <code>x</code> åå˜ä¸º <code>true</code>. å¦‚æœè¿™æ ·æµ‹è¯•è¿™æ®µä»£ç :</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!y.<span class="built_in">load</span>(std::memory_order_relaxed)); <span class="comment">// (3)</span></span><br><span class="line">    <span class="built_in">assert</span>(x.<span class="built_in">load</span>()); <span class="comment">// (4)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>(4) å¤„çš„æ–­è¨€å°±æœ‰å¯èƒ½å¤±è´¥. å› ä¸º (2) ä¸ (3) ä¹‹é—´æ²¡æœ‰ synchronizes-with çš„å…³ç³», æ‰€ä»¥å°±ä¸èƒ½ä¿è¯ (1) â€œhappens-beforeâ€ (4). å› æ­¤ (4) å°±æœ‰å¯èƒ½è¯»åˆ° <code>false</code>.</strong> è‡³äº relaxed é¡ºåºæ¨¡å‹èƒ½ä¿è¯çš„ä¿®æ”¹é¡ºåºä¸€è‡´æ€§çš„ä¾‹å­, 2.1 èŠ‚ä¸­å·²ç»è®¨è®ºè¿‡äº†, è¿™é‡Œå°±ä¸å¤šèµ˜è¿°äº†.</p><p>Relaxed é¡ºåºæ¨¡å‹çš„å¼€é”€å¾ˆå°. åœ¨ x86 æ¶æ„ä¸‹, <code>memory_order_relaxed</code> çš„æ“ä½œä¸ä¼šäº§ç”Ÿä»»ä½•å…¶ä»–çš„æŒ‡ä»¤, åªä¼šå½±å“ç¼–è¯‘å™¨ä¼˜åŒ–, ç¡®ä¿æ“ä½œæ˜¯åŸå­çš„. Relaxed æ¨¡å‹å¯ä»¥ç”¨åœ¨ä¸€äº›ä¸éœ€è¦çº¿ç¨‹åŒæ­¥çš„åœºæ™¯, ä½†æ˜¯ä½¿ç”¨æ—¶è¦å°å¿ƒ. ä¾‹å¦‚ <code>std::shared_ptr</code> å¢åŠ å¼•ç”¨è®¡æ•°æ—¶ç”¨çš„å°±æ˜¯ <code>memory_order_relaxed</code>, å› ä¸ºä¸éœ€è¦åŒæ­¥; ä½†æ˜¯å‡å°åº”ç”¨è®¡æ•°ä¸èƒ½ç”¨å®ƒ, å› ä¸ºéœ€è¦ä¸ææ„æ“ä½œåŒæ­¥.</p><h3 id="3-3-Acquire-release">3.3 Acquire-release</h3><p>åœ¨ acquire-release æ¨¡å‹ä¸­, ä¼šä½¿ç”¨ <code>memory_order_acquire</code>, <code>memory_order_release</code> å’Œ <code>memory_order_acq_rel</code> è¿™ä¸‰ç§å†…å­˜é¡ºåº. å®ƒä»¬çš„ç”¨æ³•å…·ä½“æ˜¯è¿™æ ·çš„:</p><ul><li><p>å¯¹åŸå­å˜é‡çš„ load å¯ä»¥ä½¿ç”¨ <code>memory_order_acquire</code> å†…å­˜é¡ºåº. è¿™ç§°ä¸º <strong>acquire æ“ä½œ</strong>.</p></li><li><p>å¯¹åŸå­å˜é‡çš„ store å¯ä»¥ä½¿ç”¨ <code>memory_order_release</code> å†…å­˜é¡ºåº. è¿™ç§°ä¸º <strong>release æ“ä½œ</strong>.</p></li><li><p>read-modify-write æ“ä½œå³è¯» (load) åˆå†™ (store), å®ƒå¯ä»¥ä½¿ç”¨ <code>memory_order_acquire</code>, <code>memory_order_release</code> å’Œ <code>memory_order_acq_rel</code>:</p><ul><li>å¦‚æœä½¿ç”¨ <code>memory_order_acquire</code>, åˆ™ä½œä¸º acquire æ“ä½œ;</li><li>å¦‚æœä½¿ç”¨ <code>memory_order_release</code>, åˆ™ä½œä¸º release æ“ä½œ;</li><li>å¦‚æœä½¿ç”¨ <code>memory_order_acq_rel</code>, åˆ™åŒæ—¶ä¸ºä¸¤è€….</li></ul></li></ul><p>Acquire-release å¯ä»¥å®ç° synchronizes-with çš„å…³ç³». å¦‚æœä¸€ä¸ª acquire æ“ä½œåœ¨åŒä¸€ä¸ªåŸå­å˜é‡ä¸Šè¯»å–åˆ°äº†ä¸€ä¸ª release æ“ä½œå†™å…¥çš„å€¼, åˆ™è¿™ä¸ª release æ“ä½œ â€œsynchronizes-withâ€ è¿™ä¸ª acquire æ“ä½œ. æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">bool</span>&gt; x&#123;<span class="literal">false</span>&#125;, y&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    x.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_relaxed); <span class="comment">// (1)</span></span><br><span class="line">    y.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_release); <span class="comment">// (2)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!y.<span class="built_in">load</span>(std::memory_order_acquire)); <span class="comment">// (3)</span></span><br><span class="line">    <span class="built_in">assert</span>(x.<span class="built_in">load</span>(std::memory_order_relaxed)); <span class="comment">// (4)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, è¯­å¥ (2) ä½¿ç”¨ <code>memory_order_release</code> åœ¨ <code>y</code> ä¸­å†™å…¥ <code>true</code>, è¯­å¥ (3) ä¸­ä½¿ç”¨ <code>memory_order_acquire</code> ä» <code>y</code> ä¸­è¯»å–å€¼. å¾ªç¯ (3) é€€å‡ºæ—¶, å®ƒå·²ç»è¯»å–åˆ°äº† <code>y</code> çš„å€¼ä¸º <code>true</code>, ä¹Ÿå°±æ˜¯è¯»å–åˆ°äº†æ“ä½œ (2) ä¸­å†™å…¥çš„å€¼. å› æ­¤æœ‰ (2) â€œsynchronizes-withâ€ (3). æ ¹æ® 2.2 èŠ‚ä»‹ç»çš„è§„åˆ™æˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡º:</p><ul><li>å› ä¸º (2) â€œsynchronizes-withâ€ (3) ä¸” (3) â€œsequenced-beforeâ€ (4), æ‰€ä»¥ (2) â€œinter-thread happens-beforeâ€ (4);</li><li>å› ä¸º (1) â€œsequenced-beforeâ€ (2) ä¸” (2) â€œinter-thread happens-beforeâ€ (4), æ‰€ä»¥ (1) â€œinter-thread happens-beforeâ€ (4);</li></ul><p>æ‰€ä»¥ (1) â€œhappens-beforeâ€ (4). å› æ­¤ (4) èƒ½è¯»å–åˆ° (1) ä¸­å†™å…¥çš„å€¼, æ–­è¨€æ°¸è¿œä¸ä¼šå¤±è´¥. å³ä½¿ (1) å’Œ (4) ç”¨çš„æ˜¯ <code>memory_order_relaxed</code>.</p><p>3.1 èŠ‚æˆ‘ä»¬æåˆ° sequencial consistent æ¨¡å‹å¯ä»¥å®ç° synchronizes-with å…³ç³». äº‹å®ä¸Š, å†…å­˜é¡ºåºä¸º <code>memory_order_seq_cst</code> çš„ load æ“ä½œå’Œ store æ“ä½œå¯ä»¥åˆ†åˆ«è§†ä¸º acquire æ“ä½œå’Œ release æ“ä½œ. å› æ­¤å¯¹äºä¸¤ä¸ªæŒ‡å®šäº† <code>memory_order_seq_cst</code> çš„ store æ“ä½œå’Œ load æ“ä½œ, å¦‚æœåè€…è¯»åˆ°äº†å‰è€…å†™å…¥çš„å€¼, åˆ™å‰è€… â€œsynchronizes-withâ€ åè€….</p><p>ä¸ºäº†å®ç° synchronizes-with å…³ç³», acquire æ“ä½œå’Œ release æ“ä½œåº”è¯¥æˆå¯¹å‡ºç°. å¦‚æœ <code>memory_order_acquire</code> çš„ load è¯»åˆ°äº† <code>memory_order_relaxed</code> çš„ store å†™å…¥çš„å€¼, æˆ–è€… <code>memory_order_relaxed</code> çš„ load è¯»åˆ°äº† <code>memory_order_release</code> çš„ store å†™å…¥çš„å€¼, éƒ½ä¸èƒ½å®ç° synchronizes-with çš„å…³ç³».</p><p><strong>è™½ç„¶ sequencial consistent æ¨¡å‹èƒ½å¤Ÿåƒ acquire-release ä¸€æ ·å®ç°åŒæ­¥, ä½†æ˜¯åè¿‡æ¥ acquire-release æ¨¡å‹ä¸èƒ½åƒ sequencial consistent ä¸€æ ·æä¾›å…¨å±€é¡ºåºä¸€è‡´æ€§.</strong> å¦‚æœå°† 3.1 èŠ‚çš„ä¾‹å­ä¸­çš„ <code>memory_order_seq_cst</code> æ¢æˆ <code>memory_order_acquire</code> å’Œ <code>memory_order_release</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    x.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_release); <span class="comment">// (1)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    y.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_release); <span class="comment">// (2)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_x_then_y</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!x.<span class="built_in">load</span>(std::memory_order_acquire)); <span class="comment">// (3)</span></span><br><span class="line">    <span class="keyword">if</span> (y.<span class="built_in">load</span>(std::memory_order_acquire)) ++z; <span class="comment">// (4)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_y_then_x</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!y.<span class="built_in">load</span>(std::memory_order_acquire)); <span class="comment">// (5)</span></span><br><span class="line">    <span class="keyword">if</span> (x.<span class="built_in">load</span>(std::memory_order_acquire)) ++z; <span class="comment">// (6)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ™æœ€ç»ˆä¸èƒ½ä¿è¯ <code>z</code> ä¸ä¸º 0. <strong>åœ¨åŒä¸€æ¬¡è¿è¡Œä¸­, <code>read_x_then_y</code> æœ‰å¯èƒ½çœ‹åˆ°å…ˆ (1) å (2), è€Œ <code>read_y_then_x</code> æœ‰å¯èƒ½çœ‹åˆ°å…ˆ (2) å (1). è¿™æ ·æœ‰å¯èƒ½ (4) å’Œ (6) çš„ load çš„ç»“æœéƒ½ä¸º <code>false</code>, å¯¼è‡´æœ€å <code>z</code> ä»ç„¶ä¸º 0.</strong></p><p>Acquire-release çš„å¼€é”€æ¯” sequencial consistent å°. åœ¨ x86 æ¶æ„ä¸‹, <code>memory_order_acquire</code> å’Œ <code>memory_order_release</code> çš„æ“ä½œä¸ä¼šäº§ç”Ÿä»»ä½•å…¶ä»–çš„æŒ‡ä»¤, åªä¼šå½±å“ç¼–è¯‘å™¨çš„ä¼˜åŒ–: ä»»ä½•æŒ‡ä»¤éƒ½ä¸èƒ½é‡æ’åˆ° acquire æ“ä½œçš„å‰é¢, ä¸”ä¸èƒ½é‡æ’åˆ° release æ“ä½œçš„åé¢; å¦åˆ™ä¼šè¿å acquire-release çš„è¯­ä¹‰. å› æ­¤å¾ˆå¤šéœ€è¦å®ç° synchronizes-with å…³ç³»çš„åœºæ™¯éƒ½ä¼šä½¿ç”¨ acquire-release.</p><h3 id="3-4-Release-sequences">3.4* Release sequences</h3><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬çœ‹åˆ°çš„, æ— è®ºæ˜¯ sequencial consistent è¿˜æ˜¯ acquire-release, <strong>è¦æƒ³å®ç° synchronizes-with çš„å…³ç³», acquire æ“ä½œå¿…é¡»åœ¨åŒä¸€ä¸ªåŸå­å˜é‡ä¸Šè¯»åˆ° release æ“ä½œçš„å†™å…¥çš„å€¼. å¦‚æœ acquire æ“ä½œæ²¡æœ‰è¯»åˆ° release æ“ä½œå†™å…¥çš„å€¼, é‚£ä¹ˆå®ƒä¿©ä¹‹é—´é€šå¸¸æ²¡æœ‰ synchronizes-with çš„å…³ç³»</strong>. ä¾‹å¦‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">int</span>&gt; x&#123;<span class="number">0</span>&#125;, y&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    x.<span class="built_in">store</span>(<span class="number">1</span>, std::memory_order_relaxed); <span class="comment">// (1)</span></span><br><span class="line">    y.<span class="built_in">store</span>(<span class="number">1</span>, std::memory_order_release); <span class="comment">// (2)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    y.<span class="built_in">store</span>(<span class="number">2</span>, std::memory_order_release); <span class="comment">// (3)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!y.<span class="built_in">load</span>(std::memory_order_acquire)); <span class="comment">// (4)</span></span><br><span class="line">    <span class="built_in">assert</span>(x.<span class="built_in">load</span>(std::memory_order_relaxed) == <span class="number">1</span>); <span class="comment">// (5)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ä¸­, åªè¦ <code>y</code> çš„å€¼é 0 å¾ªç¯ (4) å°±ä¼šé€€å‡º. å½“å®ƒé€€å‡ºæ—¶, æœ‰å¯èƒ½è¯»åˆ° (2) å†™å…¥çš„å€¼, ä¹Ÿæœ‰å¯èƒ½è¯»åˆ° (3) å†™å…¥çš„å€¼. å¦‚æœæ˜¯åè€…, åˆ™åªèƒ½ä¿è¯ (3) â€œsynchronizes-withâ€ (4), ä¸èƒ½ä¿è¯ä¸ (2) ä¸ (4) ä¹‹é—´æœ‰åŒæ­¥å…³ç³». å› æ­¤ (5) å¤„çš„æ–­è¨€å°±æœ‰å¯èƒ½å¤±è´¥.</p><p>ä½†å¹¶ä¸æ˜¯åªæœ‰åœ¨ acquire æ“ä½œè¯»å–åˆ° release æ“ä½œå†™å…¥çš„å€¼æ—¶æ‰èƒ½æ„æˆ synchronizes-with å…³ç³». ä¸ºäº†è¯´è¿™ç§æƒ…å†µ, æˆ‘ä»¬éœ€è¦å¼•å…¥ <strong>release sequence</strong> è¿™ä¸ªæ¦‚å¿µ.</p><p>é’ˆå¯¹ä¸€ä¸ªåŸå­å˜é‡ M çš„ release æ“ä½œ A å®Œæˆå, æ¥ä¸‹æ¥ M ä¸Šå¯èƒ½è¿˜ä¼šæœ‰ä¸€è¿ä¸²çš„å…¶ä»–æ“ä½œ. <strong>å¦‚æœè¿™ä¸€è¿ä¸²æ“ä½œæ˜¯ç”±</strong></p><ul><li><strong>åŒä¸€çº¿ç¨‹ä¸Šçš„å†™æ“ä½œ, æˆ–è€…</strong></li><li><strong>ä»»æ„çº¿ç¨‹ä¸Šçš„ read-modify-write æ“ä½œ</strong></li></ul><p>è¿™ä¸¤ç§æ„æˆçš„, åˆ™ç§°è¿™ä¸€è¿ä¸²çš„æ“ä½œä¸º<strong>ä»¥ release æ“ä½œ A ä¸ºé¦–çš„ release sequence</strong>. è¿™é‡Œçš„å†™æ“ä½œå’Œ read-modify-write æ“ä½œå¯ä»¥ä½¿ç”¨ä»»æ„å†…å­˜é¡ºåº.</p><p>å¦‚æœä¸€ä¸ª acquire æ“ä½œåœ¨åŒä¸€ä¸ªåŸå­å˜é‡ä¸Šè¯»åˆ°äº†ä¸€ä¸ª release æ“ä½œå†™å…¥çš„å€¼, æˆ–è€…è¯»åˆ°äº†ä»¥è¿™ä¸ª release æ“ä½œä¸ºé¦–çš„ release sequence å†™å…¥çš„å€¼, é‚£ä¹ˆè¿™ä¸ª release æ“ä½œ â€œsynchronizes-withâ€ è¿™ä¸ª acquire æ“ä½œ. æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="type">int</span>&gt; data;</span><br><span class="line">std::atomic&lt;<span class="type">int</span>&gt; flag&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    data.<span class="built_in">push_back</span>(<span class="number">42</span>); <span class="comment">// (1)</span></span><br><span class="line">    flag.<span class="built_in">store</span>(<span class="number">1</span>, std::memory_order_release); <span class="comment">// (2)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> expected = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (!flag.<span class="built_in">compare_exchange_strong</span>(expected, <span class="number">2</span>, std::memory_order_relaxed)) <span class="comment">// (3)</span></span><br><span class="line">        expected = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (flag.<span class="built_in">load</span>(std::memory_order_acquire) &lt; <span class="number">2</span>); <span class="comment">// (4)</span></span><br><span class="line">    <span class="built_in">assert</span>(data.<span class="built_in">at</span>(<span class="number">0</span>) == <span class="number">42</span>); <span class="comment">// (5)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ä¸­, (3) å¤„çš„ <code>compare_exchange_strong</code> æ˜¯ä¸€ç§ read-modify-write æ“ä½œ, å®ƒåˆ¤æ–­åŸå­å˜é‡çš„å€¼æ˜¯å¦ä¸æœŸæœ›çš„å€¼ (ç¬¬ä¸€ä¸ªå‚æ•°) ç›¸ç­‰, å¦‚æœç›¸ç­‰åˆ™å°†åŸå­å˜é‡è®¾ç½®æˆç›®æ ‡å€¼ (ç¬¬äºŒä¸ªå‚æ•°) å¹¶è¿”å› <code>true</code>, å¦åˆ™å°†ç¬¬ä¸€ä¸ªå‚æ•° (å¼•ç”¨ä¼ é€’) è®¾ç½®æˆåŸå­å˜é‡å½“å‰å€¼å¹¶è¿”å› <code>false</code>. æ“ä½œ (3) ä¼šä¸€ç›´å¾ªç¯æ£€æŸ¥, å½“ <code>flag</code> å½“å€¼ä¸º 1 æ—¶, å°†å…¶æ›¿æ¢æˆ 2. æ‰€ä»¥ (3) å±äº (2) çš„ release sequence. è€Œå¾ªç¯ (4) é€€å‡ºæ—¶, å®ƒå·²ç»è¯»åˆ°äº† (3) å†™å…¥çš„å€¼, ä¹Ÿå°±æ˜¯ release æ“ä½œ (2) ä¸ºé¦–çš„ release sequence å†™å…¥çš„å€¼. æ‰€ä»¥æœ‰ (2) â€œsynchronizes-withâ€ (4). å› æ­¤ (1) â€œhappens-beforeâ€ (5), (5) å¤„çš„æ–­è¨€ä¸ä¼šå¤±è´¥.</p><p>æ³¨æ„ (3) å¤„çš„ <code>compare_exchange_strong</code> çš„å†…å­˜é¡ºåºæ˜¯ <code>memory_order_relaxed</code>, æ‰€ä»¥ (2) ä¸ (3) å¹¶ä¸æ„æˆ synchronizes-with çš„å…³ç³». ä¹Ÿå°±æ˜¯è¯´, å½“å¾ªç¯ (3) é€€å‡ºæ—¶, å¹¶ä¸èƒ½ä¿è¯ <code>thread2</code> èƒ½è¯»åˆ° <code>data.at(0)</code> ä¸º 42. ä½†æ˜¯ (3) å±äº (2) çš„ release sequence, å½“ (4) ä»¥ <code>memory_order_acquire</code> çš„å†…å­˜é¡ºåºè¯»åˆ° (2) çš„ release sequence å†™å…¥çš„å€¼æ—¶, å¯ä»¥ä¸ (2) æ„æˆ synchronizes-with çš„å…³ç³».</p><h3 id="3-5-memory-order-consume">3.5* memory_order_consume</h3><p><code>memory_order_consume</code> å…¶å®æ˜¯ acquire-release æ¨¡å‹çš„ä¸€éƒ¨åˆ†, ä½†æ˜¯å®ƒæ¯”è¾ƒç‰¹æ®Š, å®ƒæ¶‰åŠåˆ°æ•°æ®é—´ç›¸äº’ä¾èµ–çš„å…³ç³». ä¸ºæ­¤æˆ‘ä»¬åˆè¦æå‡ºä¸¤ä¸ªæ–°æ¦‚å¿µ: <strong>carries dependency</strong> å’Œ <strong>dependency-ordered before</strong>.</p><p>å¦‚æœæ“ä½œ a â€œsequenced-beforeâ€ b, ä¸” b ä¾èµ– a çš„æ•°æ®, åˆ™ a â€œcarries a dependency intoâ€ b. ä¸€èˆ¬æ¥è¯´, å¦‚æœ a çš„å€¼ç”¨ä½œ b çš„ä¸€ä¸ªæ“ä½œæ•°, æˆ–è€… b è¯»å–åˆ°äº† a å†™å…¥çš„å€¼, éƒ½å¯ä»¥ç§°ä¸º b ä¾èµ–äº a. ä¾‹å¦‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p++;  <span class="comment">// (1)</span></span><br><span class="line">i++;  <span class="comment">// (2)</span></span><br><span class="line">p[i]; <span class="comment">// (3)</span></span><br></pre></td></tr></table></figure><p>æœ‰ (1) â€œsequenced-beforeâ€ (2) â€œsequenced-beforeâ€ (3); (1) å’Œ (2) çš„å€¼ä½œä¸º (3) çš„ä¸‹æ ‡è¿ç®—ç¬¦ <code>[]</code> çš„æ“ä½œæ•°, æ‰€ä»¥æœ‰ (1) â€œcarries a dependency intoâ€ (3) å’Œ (2) â€œcarries a dependency intoâ€ (3). ä½†æ˜¯ (1) å’Œ (2) å¹¶æ²¡æœ‰ç›¸äº’ä¾èµ–, å®ƒä»¬ä¹‹é—´æ²¡æœ‰ carries dependency çš„å…³ç³». ç±»ä¼¼äº sequenced-before, carries dependency å…³ç³»å…·æœ‰ä¼ é€’æ€§.</p><p><code>memory_order_consume</code> å¯ä»¥ç”¨äº load æ“ä½œ. ä½¿ç”¨ <code>memory_order_consume</code> çš„ load ç§°ä¸º consume æ“ä½œ. å¦‚æœä¸€ä¸ª consume æ“ä½œåœ¨åŒä¸€ä¸ªåŸå­å˜é‡ä¸Šè¯»åˆ°äº†ä¸€ä¸ª release æ“ä½œå†™å…¥çš„å€¼, æˆ–ä»¥å…¶ä¸ºé¦–çš„ release sequence å†™å…¥çš„å€¼, åˆ™è¿™ä¸ª release æ“ä½œ â€œdependency-ordered beforeâ€ è¿™ä¸ª consume æ“ä½œ.</p><p>Dependency-ordered before å¯ä»¥ â€œåæ¥â€ ä¸€ä¸ª carries dependency çš„å…³ç³»ä»¥å»¶ä¼¸å®ƒçš„èŒƒå›´: å¦‚æœ a â€œdependency-ordered beforeâ€ k ä¸” k â€œcarries a dependency intoâ€ b, åˆ™ a â€œdependency-ordered beforeâ€ b. Dependency-ordered before å¯ä»¥ç›´æ¥æ„æˆ inter-thread happens-before çš„å…³ç³»: å¦‚æœ a â€œdependency-ordered beforeâ€ b åˆ™ a â€œinter-thread happens-beforeâ€ b.</p><p>æ¦‚å¿µå¾ˆå¤æ‚, ä½†æ˜¯åŸºæœ¬æ€è·¯æ˜¯:</p><ul><li>release æ“ä½œå’Œ acquire æ“ä½œæ„æˆçš„ synchronizes-with å¯ä»¥åæ¥ sequenced-before æ„æˆ inter-thread happens-before çš„å…³ç³»;</li><li>release æ“ä½œå’Œ consume æ“ä½œæ„æˆçš„ dependency-ordered before åˆ™åªèƒ½åæ¥ carries dependency æ„æˆ inter-thread happens-before çš„å…³ç³».</li><li>æ— è®º inter-thread happens-before æ˜¯æ€ä¹ˆæ„æˆçš„, éƒ½å¯ä»¥å‰æ¥ sequenced-before ä»¥å»¶ä¼¸å…¶èŒƒå›´.</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240507150744160.png" alt="image-20240507150744160"></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;std::string*&gt; ptr;</span><br><span class="line"><span class="type">int</span> data;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::string* p  = <span class="keyword">new</span> std::<span class="built_in">string</span>(<span class="string">&quot;Hello&quot;</span>); <span class="comment">// (1)</span></span><br><span class="line">    data = <span class="number">42</span>; <span class="comment">// (2)</span></span><br><span class="line">    ptr.<span class="built_in">store</span>(p, std::memory_order_release); <span class="comment">// (3)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::string* p2;</span><br><span class="line">    <span class="keyword">while</span> (!(p2 = ptr.<span class="built_in">load</span>(std::memory_order_consume))); <span class="comment">// (4)</span></span><br><span class="line">    <span class="built_in">assert</span>(*p2 == <span class="string">&quot;Hello&quot;</span>); <span class="comment">// (5)</span></span><br><span class="line">    <span class="built_in">assert</span>(data == <span class="number">42</span>); <span class="comment">// (6)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(4) å¤„çš„å¾ªç¯é€€å‡ºæ—¶, consume æ“ä½œ (4) è¯»å–åˆ° release æ“ä½œ (3) å†™å…¥çš„å€¼, å› æ­¤ (3) â€œdependency-ordered beforeâ€ (4). ç”±æ­¤å¯ä»¥æ¨å¯¼å‡º:</p><ul><li><code>p2</code> çš„å€¼ä½œä¸º (5) çš„æ“ä½œæ•°, å› æ­¤ (4) â€œcarries a dependency intoâ€ (5);</li><li>å› ä¸º (3) â€œdependency-ordered beforeâ€ (4) ä¸” (4) â€œcarries a dependency intoâ€ (5), æ‰€ä»¥ (3) â€œinter-thread happens-beforeâ€ (5);</li><li>å› ä¸º (1) â€œsequenced-beforeâ€ (3) ä¸” (3) â€œinter-thread happens-beforeâ€ (5), æ‰€ä»¥ (1) â€œinter-thread happens-beforeâ€ (5);</li></ul><p>æ‰€ä»¥ (1) â€œhappens-beforeâ€ (5). å› æ­¤ (5) å¯ä»¥è¯»åˆ° (1) å†™å…¥çš„å€¼, æ–­è¨€ (5) ä¸ä¼šå¤±è´¥. ä½†æ˜¯æ“ä½œ (6) å¹¶ä¸ä¾èµ–äº (4), æ‰€ä»¥ (3) å’Œ (6) ä¹‹é—´æ²¡æœ‰ inter-thread happens-before çš„å…³ç³», å› æ­¤æ–­è¨€ (6) å°±æœ‰å¯èƒ½å¤±è´¥. å›æƒ³ 2.2 èŠ‚å¼ºè°ƒè¿‡çš„, happens-before æ²¡æœ‰ä¼ é€’æ€§. æ‰€ä»¥ä¸èƒ½è¯´å› ä¸º (3) â€œhappens-beforeâ€ (4) ä¸” (4) â€œhappens-beforeâ€ (6) æ‰€ä»¥ (2) â€œhappens-beforeâ€ (6).</p><p>ä¸ acquire-release ç±»ä¼¼, åœ¨ x86 ä¸‹ä½¿ç”¨ <code>memory_order_consume</code> çš„æ“ä½œä¸ä¼šäº§ç”Ÿä»»ä½•å…¶ä»–çš„æŒ‡ä»¤, åªä¼šå½±å“ç¼–è¯‘å™¨ä¼˜åŒ–. ä¸ consume æ“ä½œæœ‰ä¾èµ–å…³ç³»çš„æŒ‡ä»¤éƒ½ä¸ä¼šé‡æ’åˆ° consume æ“ä½œå‰é¢. å®ƒå¯¹é‡æ’çš„é™åˆ¶æ¯” acquire å®½æ¾äº›, acquire è¦æ±‚æ‰€æœ‰çš„æŒ‡ä»¤éƒ½ä¸èƒ½é‡æ’åˆ°å®ƒçš„å‰é¢, è€Œ consume åªè¦æ±‚æœ‰ä¾èµ–å…³ç³»çš„æŒ‡ä»¤ä¸èƒ½é‡æ’åˆ°å®ƒçš„å‰é¢. å› æ­¤åœ¨æŸäº›æƒ…å†µä¸‹, consume çš„æ€§èƒ½å¯èƒ½ä¼šé«˜ä¸€äº›.</p><h2 id="4-ä¾‹å­">4. ä¾‹å­</h2><blockquote><p><strong>è‡ªæ—‹é”</strong></p></blockquote><p>åœ¨ä¸€äº›åœºæ™¯ä¸‹, å¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆçŸ­, æˆ‘ä»¬ä¼šé€‰æ‹©è‡ªæ—‹é”, ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€. é”ä¸€èˆ¬ç”¨æ¥ä¿æŠ¤ä¸´ç•Œæ•°æ®çš„è¯»å†™, æˆ‘ä»¬å¸Œæœ›åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–åˆ°é”, ä¸”è·å–åˆ°é”å, è¢«é”ä¿æŠ¤çš„æ•°æ®æ€»æ˜¯æœ€æ–°çš„. å‰è€…é€šè¿‡åŸå­æ“ä½œå³å¯ä¿è¯, è€Œåè€…å°±éœ€è¦è€ƒè™‘å†…å­˜é¡ºåºäº†.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">std::deque&lt;<span class="type">int</span>&gt; queue;</span><br><span class="line">spinlock mu;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="keyword">while</span> ((val = <span class="built_in">read_from_remote</span>())) &#123;</span><br><span class="line">        mu.<span class="built_in">lock</span>(); <span class="comment">// (1)</span></span><br><span class="line">        queue.<span class="built_in">push_back</span>(val); <span class="comment">// (2)</span></span><br><span class="line">        mu.<span class="built_in">unlock</span>(); <span class="comment">// (3)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        mu.<span class="built_in">lock</span>(); <span class="comment">// (4)</span></span><br><span class="line">        cout &lt;&lt; queue.<span class="built_in">front</span>() &lt;&lt; endl;</span><br><span class="line">        queue.<span class="built_in">pop_front</span>(); <span class="comment">// (5)</span></span><br><span class="line">        mu.<span class="built_in">unlock</span>(); <span class="comment">// (6)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘è¿è¡Œ, <code>thread1</code> å¾€é˜Ÿåˆ—é‡Œå†™å…¥æ•°æ®, <code>thread2</code> ä»é˜Ÿåˆ—é‡Œè¯»å‡ºæ•°æ®. å…¥é˜Ÿæ“ä½œ (2) å¯èƒ½éœ€è¦å¤åˆ¶æ•°æ®, ç§»åŠ¨æŒ‡é’ˆ, ç”šè‡³ resize é˜Ÿåˆ—, å› æ­¤æˆ‘ä»¬è¦ä¿è¯è·å–åˆ°é”æ—¶, è¿™äº›æ“ä½œçš„ç»“æœå®Œå…¨å¯è§. å‡ºé˜Ÿæ“ä½œä¹Ÿæ˜¯åŒç†. æ‰€ä»¥è‡ªæ—‹é”è¦ä¿è¯ unlock æ“ä½œ â€œsynchronizes-withâ€ lock æ“ä½œ, ä¿è¯é”ä¿æŠ¤çš„æ•°æ®æ˜¯å®Œæ•´çš„.</p><p>æˆ‘ä»¬å¯ä»¥ç”¨ acquire-release æ¨¡å‹å®ç°è‡ªæ—‹é”. ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">spinlock</span> &#123;</span><br><span class="line">    std::atomic&lt;<span class="type">bool</span>&gt; flag&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (flag.<span class="built_in">exchange</span>(<span class="literal">true</span>, std::memory_order_acquire)); <span class="comment">// (1)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        flag.<span class="built_in">store</span>(<span class="literal">false</span>, std::memory_order_release); <span class="comment">// (2)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å®ç°ä¸­, (1) å¤„åŠ é”ç”¨åˆ°çš„ <code>exchange</code> æ˜¯ä¸€ç§ read-modify-write æ“ä½œ, å®ƒå°†ç›®æ ‡å€¼ (ç¬¬ä¸€ä¸ªå‚æ•°) å†™å…¥åŸå­å˜é‡, å¹¶è¿”å›å†™å…¥å‰çš„å€¼. åœ¨è¿™ä¸ªå®ç°ä¸­, é”è¢«å ç”¨æ—¶ <code>flag</code> ä¸º <code>true</code>. å¦‚æœé”è¢«å ç”¨, (1) å¤„çš„ exchange æ“ä½œä¼šä¸€ç›´è¿”å› <code>true</code>, çº¿ç¨‹é˜»å¡åœ¨å¾ªç¯ä¸­; ç›´åˆ°é”è¢«é‡Šæ”¾, <code>flag</code> ä¸º <code>false</code>, exchange æ“ä½œå°† <code>flag</code> é‡æ–°ç½®ä¸º <code>true</code> ä»¥æŠ¢å é”, å¹¶ä¸”è¿”å›å…¶åŸæ¥çš„å€¼ <code>false</code>, å¾ªç¯é€€å‡º, åŠ é”æˆåŠŸ. è§£é”åˆ™å¾ˆç®€å•, å°† <code>flag</code> ç½®ä¸º <code>false</code> å³å¯.</p><p>ç”±äºè§£é”æ“ä½œä½¿ç”¨ <code>memory_order_release</code> ä¸”åŠ é”æ“ä½œä½¿ç”¨ <code>memory_order_acquire</code>, æ‰€ä»¥èƒ½ä¿è¯åŠ é”æˆåŠŸæ—¶ä¸ä¸Šä¸€æ¬¡è§£é”æ“ä½œæ„æˆ â€œsynchronizes-withâ€ çš„å…³ç³», ä¹Ÿå°±æ˜¯ unlock æ“ä½œ â€œsynchronizes-withâ€ lock æ“ä½œ.</p><p>åŠ é”æ—¶çš„ exchange æ“ä½œæ˜¯ä¸€ä¸ª read-modify-write æ“ä½œ, å®ƒæ—¢è¯»åˆå†™. å½“å®ƒä½¿ç”¨ <code>memory_order_acquire</code> æ—¶, åªèƒ½ä¿è¯å®ƒè¯»çš„éƒ¨åˆ†æ˜¯ä¸€ä¸ª acquire æ“ä½œ. å¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹æŠ¢å åŒä¸€ä¸ªé”</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spinlock mu;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// some operations</span></span><br><span class="line">    mu.<span class="built_in">lock</span>(); <span class="comment">// (1)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mu.<span class="built_in">lock</span>(); <span class="comment">// (2)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(1) å’Œ (2) ä¹‹é—´æ²¡æœ‰ä»»ä½•åŒæ­¥å…³ç³», å‡è®¾å…ˆæ‰§è¡Œæ“ä½œ (1) åæ‰§è¡Œæ“ä½œ (2), é‚£ä¹ˆ <code>thread1</code> ä¸­ (1) ä¹‹å‰çš„æ“ä½œç»“æœä¸ä¸€å®šå¯¹ <code>thread2</code> å¯è§. ä½†èƒ½ç¡®å®šçš„æ˜¯, åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¾—åˆ°é”, è¿™æ˜¯ç”±åŸå­å˜é‡çš„ä¿®æ”¹é¡ºåº (modification order) æ‰€ä¿è¯çš„. è¦ä¹ˆ <code>thread1</code> å…ˆå°† <code>flag</code> ç½®ä¸º <code>true</code>, è¦ä¹ˆ <code>thread2</code> å…ˆå°† <code>flag</code> ç½®ä¸º <code>true</code>, è¿™ä¸ªé¡ºåºæ˜¯å…¨å±€ä¸€è‡´çš„.</p><h2 id="5-æ€»ç»“">5. æ€»ç»“</h2><p>æ€»ç»“ä¸€ä¸‹è¿™å‡ ç§å†…å­˜é¡ºåºæ¨¡å‹:</p><ul><li><code>memory_order_relaxed</code>: æœ€å®½æ¾çš„å†…å­˜é¡ºåº, åªä¿è¯æ“ä½œçš„<strong>åŸå­æ€§</strong>å’Œ<strong>ä¿®æ”¹é¡ºåº (modification order)</strong>.</li><li><code>memory_order_acquire</code>, <code>memory_order_release</code> å’Œ <code>memory_order_acq_rel</code>: å®ç° <strong>acquire æ“ä½œ</strong>å’Œ <strong>release æ“ä½œ</strong>, å¦‚æœ acquire æ“ä½œè¯»åˆ°äº† release æ“ä½œå†™å…¥çš„å€¼, æˆ–å…¶ release sequence å†™å…¥çš„å€¼, åˆ™æ„æˆ <strong>synchronizes-with å…³ç³»</strong>, è¿›è€Œå¯ä»¥æ¨å¯¼å‡º <strong>happens-before çš„å…³ç³»</strong>.</li><li><code>memory_order_consume</code>: å®ç° <strong>consume æ“ä½œ</strong>, èƒ½å®ç°æ•°æ®ä¾èµ–ç›¸å…³çš„åŒæ­¥å…³ç³». å¦‚æœ consume æ“ä½œè¯»åˆ°äº† release æ“ä½œå†™å…¥çš„å€¼, æˆ–å…¶ release sequence å†™å…¥çš„å€¼, åˆ™æ„æˆ <strong>dependency-ordered before çš„å…³ç³»</strong>, å¯¹äºæœ‰æ•°æ®ä¾èµ–çš„æ“ä½œå¯ä»¥è¿›è€Œæ¨å¯¼å‡º <strong>happens-before çš„å…³ç³»</strong>.</li><li><code>memory_order_seq_cst</code>: åŠ å¼ºç‰ˆçš„ acquire-release æ¨¡å‹, é™¤äº†å¯ä»¥å®ç° <strong>synchronizes-with å…³ç³»</strong>, è¿˜ä¿è¯<strong>å…¨å±€é¡ºåºä¸€è‡´</strong>.</li></ul><h2 id="6-èµ„æ–™">6. èµ„æ–™</h2><ul><li><a href="https://nj.gitbooks.io/c/content/">ã€ŠC++å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹</a></li><li><a href="https://www.zhihu.com/question/24301047">å†…å­˜æ¨¡å‹</a></li></ul><p>æœ¬æ–‡è½¬è½½è‡ªï¼š<a href="https://luyuhuang.tech/2022/06/25/cpp-memory-order.html#%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F">è°ˆè°ˆ C++ ä¸­çš„å†…å­˜é¡ºåº (Memory Order)</a></p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://blog.51cto.com/quantfabric/2588193">C++æ€§èƒ½ä¼˜åŒ–ï¼ˆåä¸‰ï¼‰â€”â€”æ— é”é˜Ÿåˆ—</a></li><li><a href="%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97%E7%9A%84%E5%87%A0%E7%A7%8D%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%85%B6%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94">æ— é”é˜Ÿåˆ—çš„å‡ ç§å®ç°åŠå…¶æ€§èƒ½å¯¹æ¯”</a></li><li><a href="https://blog.csdn.net/xin_hen/article/details/108142403">C++11å®ç°åŸºäºå¾ªç¯æ•°ç»„çš„æ— é”é˜Ÿåˆ—LockFreeArrayQueue</a></li><li><a href="https://zhuanlan.zhihu.com/p/638443455">æ­ç§˜C++æ— é”é˜Ÿåˆ—çš„å‡ ç§å®ç°åŠæ€§èƒ½å¯¹æ¯”</a></li><li><a href="https://zhuanlan.zhihu.com/p/678154776">C++æ€§èƒ½ä¼˜åŒ–â€”â€”æ— é”é˜Ÿåˆ—çš„åŸç†ä¸å®ç°</a></li></ul>]]></content>
    
    
    <summary type="html">Memory Order</summary>
    
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>CMakeå¿«é€Ÿä¸Šæ‰‹</title>
    <link href="https://penge666.github.io/posts/48ea1a6e.html"/>
    <id>https://penge666.github.io/posts/48ea1a6e.html</id>
    <published>2024-05-06T14:38:59.000Z</published>
    <updated>2024-05-06T15:23:10.443Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>CMake ä¸å†ä½¿ä½ åœ¨æ„å»ºé¡¹ç›®æ—¶éƒé—·åœ°æƒ³è‡ªæ€äº†ã€‚</p><p>æ’æ›²ï¼šä¹‹å‰åœ¨ç ”ç©¶æ‰€åšé¡¹ç›®çš„æ—¶å€™ï¼Œåˆ˜æ€»æ€»æ˜¯æš´åŠ›çš„ä½¿ç”¨shè„šæœ¬ç¼–è¯‘[ç‹—å¤´ä¿å‘½ä¸€æ³¢]ï¼Œç‹ ç‹ çš„æš´åŠ›ç¾å­¦ã€‚ä½†æ˜¯ï¼Œè¿™å¯¹å†™labçš„æˆ‘æœ‰ç‚¹éš¾æ³µï¼Œäºæ˜¯ä¹ï¼Œå…¨ç»™é‡å†™CMakeLists.txtæ–‡ä»¶çš„å½¢å¼ç¼–è¯‘ã€‚</p><p>å¥½äº†ï¼ŒåŸºæœ¬æ–‡ä»¶çš„CMakeList.txtå­¦ä¹ æ¸…æ¥šåï¼Œå°±åº”è¯¥å­¦ä¹ å®é™…é¡¹ç›®ä¸­CMakeLists.txtæ˜¯å¦‚ä½•è§„èŒƒä¹¦å†™ï¼Œåˆ°å®è·µä¸­å­¦ä¹ ã€‚</p><h2 id="ä»‹ç»">ä»‹ç»</h2><h3 id="è·¨å¹³å°è®¾è®¡åŸç†">è·¨å¹³å°è®¾è®¡åŸç†</h3><p>åœ¨å¤§å‹C/C++é¡¹ç›®ä¸­ï¼Œè·¨å¹³å°è®¾è®¡æ˜¯ä¸€ä¸ªé‡è¦çš„è€ƒè™‘å› ç´ ã€‚è·¨å¹³å°è®¾è®¡çš„ç›®æ ‡æ˜¯ä½¿å¾—æºä»£ç èƒ½å¤Ÿåœ¨å¤šç§æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶æ¶æ„ä¸Šç¼–è¯‘å’Œè¿è¡Œï¼Œè€Œæ— éœ€è¿›è¡Œå¤§é‡çš„ä¿®æ”¹ã€‚è¿™æ ·å¯ä»¥å¤§å¤§æé«˜ä»£ç çš„å¯ç§»æ¤æ€§å’Œå¤ç”¨æ€§ï¼Œé™ä½ç»´æŠ¤æˆæœ¬ã€‚</p><p>CMakeï¼ˆCross-platform Makeï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„ã€è·¨å¹³å°çš„è‡ªåŠ¨åŒ–å»ºæ„ç³»ç»Ÿï¼Œå®ƒå…è®¸å¼€å‘è€…ç¼–å†™ä¸€ä»½é€šç”¨çš„CMakeList.txtæ–‡ä»¶æ¥æ§åˆ¶ç¼–è¯‘è¿‡ç¨‹ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ç‰¹å®šå¹³å°ä¸‹çš„ç¼–è¯‘é…ç½®ï¼Œä»è€Œå®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„è·¨å¹³å°ç¼–è¯‘ã€‚</p><p>CMakeæ”¯æŒå¤šç§ç¼–è¯‘å™¨ï¼ŒåŒ…æ‹¬GCCï¼ŒClangï¼ŒVisual Studioç­‰ï¼Œå¹¶ä¸”å¯ä»¥ç”Ÿæˆå„ç§ç±»å‹çš„é¡¹ç›®æ–‡ä»¶ï¼Œå¦‚Makefileï¼ŒNinjaï¼ŒVisual Studioè§£å†³æ–¹æ¡ˆç­‰ã€‚è¿™ä½¿å¾—CMakeæˆä¸ºäº†è·¨å¹³å°C/C++é¡¹ç›®çš„é¦–é€‰æ„å»ºå·¥å…·ã€‚</p><p>åœ¨CMakeä¸­ï¼Œè·¨å¹³å°è®¾è®¡çš„å®ç°ä¸»è¦ä¾èµ–äºä»¥ä¸‹å‡ ä¸ªåŸç†ï¼š</p><ol><li><strong>æŠ½è±¡å±‚</strong>ï¼šCMakeä¸ºå„ç§æ“ä½œç³»ç»Ÿå’Œç¼–è¯‘å™¨æä¾›äº†ä¸€å¥—æŠ½è±¡å±‚ï¼Œå¼€å‘è€…åªéœ€è¦å…³æ³¨æºä»£ç å’Œä¾èµ–åº“ï¼Œè€Œæ— éœ€å…³å¿ƒå…·ä½“çš„ç¼–è¯‘å™¨å’Œæ“ä½œç³»ç»Ÿã€‚è¿™æ˜¯é€šè¿‡åœ¨CMakeList.txtæ–‡ä»¶ä¸­è®¾ç½®ç›®æ ‡ï¼ˆtargetï¼‰å’Œå±æ€§ï¼ˆpropertyï¼‰æ¥å®ç°çš„ã€‚</li><li><strong>æ¨¡å—ç³»ç»Ÿ</strong>ï¼šCMakeæä¾›äº†ä¸€å¥—æ¨¡å—ç³»ç»Ÿï¼Œç”¨äºæŸ¥æ‰¾åº“å’ŒåŒ…ï¼Œæ£€æŸ¥ç¼–è¯‘å™¨å’Œç³»ç»Ÿç‰¹æ€§ï¼Œä»¥åŠç®¡ç†æµ‹è¯•ç­‰ã€‚è¿™äº›æ¨¡å—å¤§å¤§ç®€åŒ–äº†è·¨å¹³å°å¼€å‘çš„å¤æ‚æ€§ã€‚</li><li><strong>ç”Ÿæˆå™¨</strong>ï¼šCMakeé€šè¿‡ç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰å°†CMakeList.txtæ–‡ä»¶è½¬æ¢ä¸ºç‰¹å®šå¹³å°ä¸‹çš„æ„å»ºæ–‡ä»¶ã€‚ç”Ÿæˆå™¨æ ¹æ®ç›®æ ‡ç³»ç»Ÿçš„ç‰¹æ€§ï¼Œè‡ªåŠ¨å¤„ç†å¹³å°ç›¸å…³çš„ç¼–è¯‘å’Œé“¾æ¥é—®é¢˜ã€‚</li><li><strong>å˜é‡å’Œæ¡ä»¶</strong>ï¼šCMakeæ”¯æŒå˜é‡å’Œæ¡ä»¶è¯­å¥ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥æ ¹æ®ä¸åŒçš„å¹³å°å’Œç¼–è¯‘å™¨ï¼Œé€‰æ‹©ä¸åŒçš„æºæ–‡ä»¶å’Œç¼–è¯‘é€‰é¡¹ã€‚</li></ol><p>ä»¥ä¸Šå°±æ˜¯CMakeå®ç°è·¨å¹³å°è®¾è®¡çš„åŸºæœ¬åŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†æ·±å…¥æ¢è®¨CMakeåœ¨è·¨å¹³å°è®¾è®¡ä¸­çš„åº”ç”¨ã€‚</p><h3 id="è·¨å¹³å°è®¾è®¡">è·¨å¹³å°è®¾è®¡</h3><p>åœ¨å¤§å‹C/C++é¡¹ç›®ä¸­ï¼Œè·¨å¹³å°è®¾è®¡æ˜¯å¿…ä¸å¯å°‘çš„ä¸€ç¯ã€‚è¿™ä¸»è¦æ¶‰åŠåˆ°å¦‚ä½•ä½¿ç”¨CMakeæ¥é…ç½®å’Œç®¡ç†ä¸åŒå¹³å°çš„ç¼–è¯‘ç¯å¢ƒã€‚</p><p><strong>CMakeçš„è·¨å¹³å°ç‰¹æ€§</strong></p><p>CMakeæœ¬èº«å°±æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„æ„å»ºå·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨Windowsã€Linuxã€Macç­‰å¤šç§æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œã€‚CMakeé€šè¿‡ç”Ÿæˆå¹³å°ç›¸å…³çš„æ„å»ºæ–‡ä»¶ï¼ˆå¦‚Unixçš„Makefileï¼ŒWindowsçš„nmakeæ–‡ä»¶æˆ–Visual Studioé¡¹ç›®æ–‡ä»¶ç­‰ï¼‰æ¥å®ç°è·¨å¹³å°æ„å»ºã€‚è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€å¥—CMakeæ„å»ºè„šæœ¬ï¼Œç„¶ååœ¨ä¸åŒçš„å¹³å°ä¸Šç”Ÿæˆç›¸åº”çš„æ„å»ºæ–‡ä»¶ï¼Œä»è€Œå®ç°è·¨å¹³å°æ„å»ºã€‚</p><p><strong>ä½¿ç”¨CMakeè¿›è¡Œè·¨ç¼–è¯‘</strong></p><p>è·¨ç¼–è¯‘æ˜¯æŒ‡åœ¨ä¸€ä¸ªå¹³å°ä¸Šç”Ÿæˆå¦ä¸€ä¸ªå¹³å°çš„å¯æ‰§è¡Œä»£ç ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨Linuxå¹³å°ä¸Šç¼–è¯‘å‡ºè¿è¡Œåœ¨åµŒå…¥å¼è®¾å¤‡ä¸Šçš„ARMæ¶æ„çš„ä»£ç ã€‚CMakeæ”¯æŒè·¨ç¼–è¯‘ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®CMakeçš„å·¥å…·é“¾æ–‡ä»¶ï¼ˆToolchain Fileï¼‰æ¥æŒ‡å®šäº¤å‰ç¼–è¯‘å™¨å’Œç›¸å…³çš„ç¼–è¯‘é€‰é¡¹ã€‚</p><p>åœ¨CMakeçš„å·¥å…·é“¾æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®å¦‚ä¸‹å˜é‡ï¼š</p><ul><li><code>CMAKE_SYSTEM_NAME</code>ï¼šç›®æ ‡ç³»ç»Ÿçš„åç§°ï¼Œå¦‚Linuxã€Windowsã€Androidç­‰ã€‚</li><li><code>CMAKE_SYSTEM_PROCESSOR</code>ï¼šç›®æ ‡ç³»ç»Ÿçš„å¤„ç†å™¨æ¶æ„ï¼Œå¦‚x86ã€armç­‰ã€‚</li><li><code>CMAKE_C_COMPILER</code>ã€<code>CMAKE_CXX_COMPILER</code>ï¼šCå’ŒC++çš„äº¤å‰ç¼–è¯‘å™¨çš„è·¯å¾„ã€‚</li><li><code>CMAKE_FIND_ROOT_PATH</code>ï¼šåœ¨æŸ¥æ‰¾åº“å’Œå¤´æ–‡ä»¶æ—¶ï¼ŒCMakeåº”è¯¥æŸ¥æ‰¾çš„è·¯å¾„ã€‚</li></ul><p>é€šè¿‡è®¾ç½®è¿™äº›å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥å‘Šè¯‰CMakeæˆ‘ä»¬è¦ç¼–è¯‘çš„ç›®æ ‡å¹³å°æ˜¯ä»€ä¹ˆï¼Œä»¥åŠåº”è¯¥ä½¿ç”¨å“ªäº›å·¥å…·è¿›è¡Œç¼–è¯‘ã€‚</p><p><strong>å¤„ç†å¹³å°ç›¸å…³çš„ä»£ç </strong></p><p>åœ¨å¤§å‹C/C++é¡¹ç›®ä¸­ï¼Œé€šå¸¸ä¼šæœ‰ä¸€äº›å¹³å°ç›¸å…³çš„ä»£ç ã€‚ä¾‹å¦‚ï¼ŒWindowså¹³å°å’ŒLinuxå¹³å°çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ä¸åŒçš„ï¼Œå¤„ç†æ–‡ä»¶è·¯å¾„çš„æ–¹å¼ä¹Ÿæ˜¯ä¸åŒçš„ã€‚æˆ‘ä»¬éœ€è¦åœ¨CMakeæ„å»ºè„šæœ¬ä¸­æ£€æµ‹ç›®æ ‡å¹³å°ï¼Œç„¶åæ ¹æ®ç›®æ ‡å¹³å°æ¥å†³å®šç¼–è¯‘å“ªäº›æºæ–‡ä»¶ã€‚</p><p>CMakeæä¾›äº†<code>if</code>å‘½ä»¤æ¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>CMAKE_SYSTEM_NAME</code>å˜é‡æ¥åˆ¤æ–­ç›®æ ‡å¹³å°ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(CMAKE_SYSTEM_NAME <span class="keyword">STREQUAL</span> <span class="string">&quot;Linux&quot;</span>)</span><br><span class="line">    <span class="comment"># ç¼–è¯‘Linuxå¹³å°çš„æºæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">add_library</span>(mylib linux_specific_code.c)</span><br><span class="line"><span class="keyword">elseif</span>(CMAKE_SYSTEM_NAME <span class="keyword">STREQUAL</span> <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">    <span class="comment"># ç¼–è¯‘Windowså¹³å°çš„æºæ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯è·¨å¹³å°è®¾è®¡çš„æµç¨‹å›¾ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240506230531403.png" alt="image-20240506230531403"></p><p>åœ¨å¤§å‹C/C++é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°è·¨å¹³å°è®¾è®¡ã€‚è¿™ä¸»è¦æ¶‰åŠåˆ°å¦‚ä½•ä½¿ç”¨CMakeæ¥é…ç½®å’Œç®¡ç†ä¸åŒå¹³å°çš„ç¼–è¯‘ç¯å¢ƒã€‚CMakeæœ¬èº«å°±æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„æ„å»ºå·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨Windowsã€Linuxã€Macç­‰å¤šç§æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œã€‚CMakeé€šè¿‡ç”Ÿæˆå¹³å°ç›¸å…³çš„æ„å»ºæ–‡ä»¶ï¼ˆå¦‚Unixçš„Makefileï¼ŒWindowsçš„nmakeæ–‡ä»¶æˆ–Visual Studioé¡¹ç›®æ–‡ä»¶ç­‰ï¼‰æ¥å®ç°è·¨å¹³å°æ„å»ºã€‚</p><p>è·¨ç¼–è¯‘æ˜¯æŒ‡åœ¨ä¸€ä¸ªå¹³å°ä¸Šç”Ÿæˆå¦ä¸€ä¸ªå¹³å°çš„å¯æ‰§è¡Œä»£ç ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨Linuxå¹³å°ä¸Šç¼–è¯‘å‡ºè¿è¡Œåœ¨åµŒå…¥å¼è®¾å¤‡ä¸Šçš„ARMæ¶æ„çš„ä»£ç ã€‚CMakeæ”¯æŒè·¨ç¼–è¯‘ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®CMakeçš„å·¥å…·é“¾æ–‡ä»¶ï¼ˆToolchain Fileï¼‰æ¥æŒ‡å®šäº¤å‰ç¼–è¯‘å™¨å’Œç›¸å…³çš„ç¼–è¯‘é€‰é¡¹ã€‚</p><p>åœ¨å¤§å‹C/C++é¡¹ç›®ä¸­ï¼Œé€šå¸¸ä¼šæœ‰ä¸€äº›å¹³å°ç›¸å…³çš„ä»£ç ã€‚ä¾‹å¦‚ï¼ŒWindowså¹³å°å’ŒLinuxå¹³å°çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ä¸åŒçš„ï¼Œå¤„ç†æ–‡ä»¶è·¯å¾„çš„æ–¹å¼ä¹Ÿæ˜¯ä¸åŒçš„ã€‚æˆ‘ä»¬éœ€è¦åœ¨CMakeæ„å»ºè„šæœ¬ä¸­æ£€æµ‹ç›®æ ‡å¹³å°ï¼Œç„¶åæ ¹æ®ç›®æ ‡å¹³å°æ¥å†³å®šç¼–è¯‘å“ªäº›æºæ–‡ä»¶ã€‚CMakeæä¾›äº†<code>if</code>å‘½ä»¤æ¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>CMAKE_SYSTEM_NAME</code>å˜é‡æ¥åˆ¤æ–­ç›®æ ‡å¹³å°ã€‚</p><h3 id="è·¨å¹³å°è®¾è®¡æ¡ˆä¾‹">è·¨å¹³å°è®¾è®¡æ¡ˆä¾‹</h3><p>åœ¨å®è·µä¸­ï¼Œè·¨å¹³å°è®¾è®¡æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œéœ€è¦è€ƒè™‘åˆ°å„ç§å› ç´ ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å®è·µå’Œæ¡ˆä¾‹ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£è·¨å¹³å°è®¾è®¡çš„è¿‡ç¨‹å’ŒæŒ‘æˆ˜ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240506230621696.png" alt="image-20240506230621696"></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å¹³å°å·®å¼‚ï¼ˆUnderstanding Platform Differencesï¼‰ã€‚ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶å¹³å°æœ‰ä¸åŒçš„ç‰¹æ€§å’Œé™åˆ¶ã€‚ä¾‹å¦‚ï¼ŒWindowså’ŒLinuxåœ¨æ–‡ä»¶ç³»ç»Ÿã€çº¿ç¨‹ç®¡ç†å’Œç½‘ç»œç¼–ç¨‹ç­‰æ–¹é¢æœ‰æ˜¾è‘—çš„å·®å¼‚ã€‚ç†è§£è¿™äº›å·®å¼‚æ˜¯è®¾è®¡è·¨å¹³å°åº”ç”¨çš„ç¬¬ä¸€æ­¥ã€‚</p><p>å…¶æ¬¡ï¼Œé€‰æ‹©åˆé€‚çš„å·¥å…·å’Œåº“ï¼ˆChoosing Appropriate Tools and Librariesï¼‰ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚æœ‰äº›å·¥å…·å’Œåº“æ˜¯è·¨å¹³å°çš„ï¼Œå¯ä»¥åœ¨å¤šç§æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶å¹³å°ä¸Šè¿è¡Œã€‚ä¾‹å¦‚ï¼ŒCMakeå°±æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„æ„å»ºå·¥å…·ï¼Œå¯ä»¥åœ¨Windowsã€Linuxå’ŒMacOSä¸Šä½¿ç”¨ã€‚ä½¿ç”¨è¿™äº›å·¥å…·å’Œåº“å¯ä»¥å¤§å¤§ç®€åŒ–è·¨å¹³å°è®¾è®¡çš„å¤æ‚æ€§ã€‚</p><p>ç„¶åï¼Œç¼–å†™å¯ç§»æ¤çš„ä»£ç ï¼ˆWriting Portable Codeï¼‰æ˜¯å¦ä¸€ä¸ªå…³é”®æ­¥éª¤ã€‚å¯ç§»æ¤çš„ä»£ç æ˜¯æŒ‡å¯ä»¥åœ¨å¤šç§å¹³å°ä¸Šç¼–è¯‘å’Œè¿è¡Œçš„ä»£ç ã€‚ä¸ºäº†å®ç°ä»£ç çš„å¯ç§»æ¤æ€§ï¼Œæˆ‘ä»¬éœ€è¦é¿å…ä½¿ç”¨ç‰¹å®šå¹³å°çš„ç‰¹æ€§å’ŒAPIï¼Œæˆ–è€…ä½¿ç”¨é¢„å¤„ç†å™¨æŒ‡ä»¤æ¥å¤„ç†å¹³å°å·®å¼‚ã€‚</p><p>æœ€åï¼Œè¿›è¡Œå…¨é¢çš„æµ‹è¯•ï¼ˆComprehensive Testingï¼‰æ˜¯ç¡®ä¿è·¨å¹³å°åº”ç”¨æ­£ç¡®è¿è¡Œçš„é‡è¦æ­¥éª¤ã€‚æˆ‘ä»¬éœ€è¦åœ¨æ‰€æœ‰ç›®æ ‡å¹³å°ä¸Šæµ‹è¯•åº”ç”¨ï¼Œç¡®ä¿å®ƒåœ¨å„ç§ç¯å¢ƒä¸­éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚</p><p>ä»¥ä¸Šå°±æ˜¯è·¨å¹³å°è®¾è®¡çš„ä¸€äº›åŸºæœ¬æ­¥éª¤å’Œå®è·µã€‚åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦è€ƒè™‘åˆ°å…¶ä»–çš„å› ç´ ï¼Œå¦‚æ€§èƒ½ã€å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒç­‰ã€‚ä½†æ˜¯ï¼Œåªè¦æˆ‘ä»¬éµå¾ªè¿™äº›åŸºæœ¬åŸåˆ™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¾è®¡å‡ºé«˜è´¨é‡çš„è·¨å¹³å°åº”ç”¨ã€‚</p><h2 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h2><h3 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</h3><p><strong>1. æŒ‡å®š cmake çš„æœ€å°ç‰ˆæœ¬</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cmake_minimum_required</span>(VERSION <span class="number">3.4</span>.<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>è¿™è¡Œå‘½ä»¤æ˜¯å¯é€‰çš„ï¼Œå½“ç„¶å¯ä»¥ä¸å†™è¿™å¥è¯ï¼Œä½†åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œå¦‚æœ CMakeLists.txt æ–‡ä»¶ä¸­ä½¿ç”¨äº†ä¸€äº›é«˜ç‰ˆæœ¬ cmake ç‰¹æœ‰çš„ä¸€äº›å‘½ä»¤çš„æ—¶å€™ï¼Œå°±éœ€è¦åŠ ä¸Šè¿™æ ·ä¸€è¡Œï¼Œæé†’ç”¨æˆ·å‡çº§åˆ°è¯¥ç‰ˆæœ¬ä¹‹åå†æ‰§è¡Œ cmakeã€‚</p><p><strong>2. è®¾ç½®é¡¹ç›®åç§°</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">project</span>(demo)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä½†æœ€å¥½éƒ½åŠ ä¸Šã€‚å®ƒä¼šå¼•å…¥ä¸¤ä¸ªå˜é‡ demo_BINARY_DIR å’Œ demo_SOURCE_DIRï¼ŒåŒæ—¶ï¼Œcmake è‡ªåŠ¨å®šä¹‰äº†ä¸¤ä¸ªç­‰ä»·çš„å˜é‡ PROJECT_BINARY_DIR å’Œ PROJECT_SOURCE_DIRã€‚</p><p><strong>3. è®¾ç½®ç¼–è¯‘ç±»å‹</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add_executable</span>(demo demo.cpp) # ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line"><span class="built_in">add_library</span>(common STATIC util.cpp) # ç”Ÿæˆé™æ€åº“</span><br><span class="line"><span class="built_in">add_library</span>(common SHARED util.cpp) # ç”ŸæˆåŠ¨æ€åº“æˆ–å…±äº«åº“</span><br></pre></td></tr></table></figure><p>add_library é»˜è®¤ç”Ÿæˆæ˜¯é™æ€åº“ï¼Œé€šè¿‡ä»¥ä¸Šå‘½ä»¤ç”Ÿæˆæ–‡ä»¶åå­—ï¼Œ</p><ul><li>åœ¨ Linux ä¸‹æ˜¯ï¼š<br>demo<br>libcommon.a<br><a href="http://libcommon.so">libcommon.so</a></li><li>åœ¨ Windows ä¸‹æ˜¯ï¼š<br>demo.exe<br>common.lib<br>common.dll</li></ul><p><strong>4. æŒ‡å®šç¼–è¯‘åŒ…å«çš„æºæ–‡ä»¶</strong></p><p>4.1 æ˜ç¡®æŒ‡å®šåŒ…å«å“ªäº›æºæ–‡ä»¶</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add_library</span>(demo demo.cpp test.cpp util.cpp)</span><br></pre></td></tr></table></figure><p>4.2 æœç´¢æ‰€æœ‰çš„ cpp æ–‡ä»¶</p><p>aux_source_directory(dir VAR) å‘ç°ä¸€ä¸ªç›®å½•ä¸‹æ‰€æœ‰çš„æºä»£ç æ–‡ä»¶å¹¶å°†åˆ—è¡¨å­˜å‚¨åœ¨ä¸€ä¸ªå˜é‡ä¸­ã€‚</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">aux_source_directory</span>(. SRC_LIST) # æœç´¢å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰<span class="selector-class">.cpp</span>æ–‡ä»¶</span><br><span class="line"><span class="built_in">add_library</span>(demo $&#123;SRC_LIST&#125;)</span><br></pre></td></tr></table></figure><p>4.3 è‡ªå®šä¹‰æœç´¢è§„åˆ™</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">file</span>(GLOB SRC_LIST &quot;*.cpp&quot; &quot;protocol/*.cpp&quot;)</span><br><span class="line"><span class="built_in">add_library</span>(demo $&#123;SRC_LIST&#125;)</span><br><span class="line"># æˆ–è€…</span><br><span class="line"><span class="built_in">file</span>(GLOB SRC_LIST &quot;*.cpp&quot;)</span><br><span class="line"><span class="built_in">file</span>(GLOB SRC_PROTOCOL_LIST &quot;protocol/*.cpp&quot;)</span><br><span class="line"><span class="built_in">add_library</span>(demo $&#123;SRC_LIST&#125; $&#123;SRC_PROTOCOL_LIST&#125;)</span><br><span class="line"># æˆ–è€…</span><br><span class="line"><span class="built_in">file</span>(GLOB_RECURSE SRC_LIST &quot;*.cpp&quot;) #é€’å½’æœç´¢</span><br><span class="line"><span class="built_in">FILE</span>(GLOB SRC_PROTOCOL RELATIVE &quot;protocol&quot; &quot;*.cpp&quot;) # ç›¸å¯¹protocolç›®å½•ä¸‹æœç´¢</span><br><span class="line"><span class="built_in">add_library</span>(demo $&#123;SRC_LIST&#125; $&#123;SRC_PROTOCOL_LIST&#125;)</span><br><span class="line"># æˆ–è€…</span><br><span class="line"><span class="built_in">aux_source_directory</span>(. SRC_LIST)</span><br><span class="line"><span class="built_in">aux_source_directory</span>(protocol SRC_PROTOCOL_LIST)</span><br><span class="line"><span class="built_in">add_library</span>(demo $&#123;SRC_LIST&#125; $&#123;SRC_PROTOCOL_LIST&#125;)</span><br></pre></td></tr></table></figure><p><strong>5. æŸ¥æ‰¾æŒ‡å®šçš„åº“æ–‡ä»¶</strong></p><p>find_library(VAR name path)æŸ¥æ‰¾åˆ°æŒ‡å®šçš„é¢„ç¼–è¯‘åº“ï¼Œå¹¶å°†å®ƒçš„è·¯å¾„å­˜å‚¨åœ¨å˜é‡ä¸­ã€‚<br>é»˜è®¤çš„æœç´¢è·¯å¾„ä¸º cmake åŒ…å«çš„ç³»ç»Ÿåº“ï¼Œå› æ­¤å¦‚æœæ˜¯ NDK çš„å…¬å…±åº“åªéœ€è¦æŒ‡å®šåº“çš„ name å³å¯ã€‚</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">find_library( <span class="comment"># Sets the name of the path variable.</span></span><br><span class="line">              <span class="keyword">log</span>-lib</span><br><span class="line"> </span><br><span class="line">              <span class="comment"># Specifies the name of the NDK library that</span></span><br><span class="line">              <span class="comment"># you want CMake to locate.</span></span><br><span class="line">              <span class="keyword">log</span> )</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„å‘½ä»¤è¿˜æœ‰ find_file()ã€find_path()ã€find_program()ã€find_package()ã€‚</p><p><strong>6. è®¾ç½®åŒ…å«çš„ç›®å½•</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">include_directories</span>(</span><br><span class="line">    $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span><br><span class="line">    $&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span><br><span class="line">    $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/include</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Linux ä¸‹è¿˜å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è®¾ç½®åŒ…å«çš„ç›®å½•</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span>(CMAKE_CXX_FLAGS &quot;$&#123;CMAKE_CXX_FLAGS&#125; -I$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&quot;)</span><br></pre></td></tr></table></figure><p><strong>7. è®¾ç½®é“¾æ¥åº“æœç´¢ç›®å½•</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">link_directories</span>(</span><br><span class="line">    $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/libs</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Linux ä¸‹è¿˜å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è®¾ç½®åŒ…å«çš„ç›®å½•</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; -L$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/libs&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>8. è®¾ç½® target éœ€è¦é“¾æ¥çš„åº“</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">target_link_libraries</span>( # ç›®æ ‡åº“</span><br><span class="line">                       demo</span><br><span class="line"> </span><br><span class="line">                       # ç›®æ ‡åº“éœ€è¦é“¾æ¥çš„åº“</span><br><span class="line">                       # log-lib æ˜¯ä¸Šé¢ find_library æŒ‡å®šçš„å˜é‡å</span><br><span class="line">                       $&#123;log-lib&#125; )</span><br></pre></td></tr></table></figure><p>åœ¨ Windows ä¸‹ï¼Œç³»ç»Ÿä¼šæ ¹æ®é“¾æ¥åº“ç›®å½•ï¼Œæœç´¢xxx.lib æ–‡ä»¶ï¼ŒLinux ä¸‹ä¼šæœç´¢ <a href="http://xxx.so">xxx.so</a> æˆ–è€… xxx.a æ–‡ä»¶ï¼Œå¦‚æœéƒ½å­˜åœ¨ä¼šä¼˜å…ˆé“¾æ¥åŠ¨æ€åº“ï¼ˆso åç¼€ï¼‰ã€‚</p><p>8.1 æŒ‡å®šé“¾æ¥åŠ¨æ€åº“æˆ–é™æ€åº“</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">target_link_libraries</span>(demo libface.a) # é“¾æ¥libface.<span class="function">a</span></span><br><span class="line"><span class="function"><span class="title">target_link_libraries</span><span class="params">(demo libface.so)</span> # é“¾æ¥libface.so</span></span><br></pre></td></tr></table></figure><p>8.2 æŒ‡å®šå…¨è·¯å¾„</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">target_link_libraries</span>(demo $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/libs/libface.a)</span><br><span class="line"><span class="built_in">target_link_libraries</span>(demo $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/libs/libface.so)</span><br></pre></td></tr></table></figure><p>8.3 æŒ‡å®šé“¾æ¥å¤šä¸ªåº“</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">target_link_libraries</span>(demo</span><br><span class="line">    $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/libs/libface.a</span><br><span class="line">    boost_system.a</span><br><span class="line">    boost_thread</span><br><span class="line">    pthread)</span><br></pre></td></tr></table></figure><p><strong>9. è®¾ç½®å˜é‡</strong></p><p>9.1 set ç›´æ¥è®¾ç½®å˜é‡çš„å€¼</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span>(SRC_LIST main.cpp test.cpp)</span><br><span class="line"><span class="built_in">add_executable</span>(demo $&#123;SRC_LIST&#125;)</span><br></pre></td></tr></table></figure><p>9.2 set è¿½åŠ è®¾ç½®å˜é‡çš„å€¼</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span>(SRC_LIST main.cpp)</span><br><span class="line"><span class="built_in">set</span>(SRC_LIST $&#123;SRC_LIST&#125; test.cpp)</span><br><span class="line"><span class="built_in">add_executable</span>(demo $&#123;SRC_LIST&#125;)</span><br></pre></td></tr></table></figure><p>9.3 list è¿½åŠ æˆ–è€…åˆ é™¤å˜é‡çš„å€¼</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span>(SRC_LIST main.cpp)</span><br><span class="line"><span class="built_in">list</span>(APPEND SRC_LIST test.cpp)</span><br><span class="line"><span class="built_in">list</span>(REMOVE_ITEM SRC_LIST main.cpp)</span><br><span class="line"><span class="built_in">add_executable</span>(demo $&#123;SRC_LIST&#125;)</span><br></pre></td></tr></table></figure><p><strong>10. æ¡ä»¶æ§åˆ¶</strong></p><p>10.1 ifâ€¦elseifâ€¦elseâ€¦endif</p><p>é€»è¾‘åˆ¤æ–­å’Œæ¯”è¾ƒï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (expression)ï¼šexpression ä¸ä¸ºç©ºï¼ˆ<span class="number">0</span>,N,NO,OFF,FALSE,NOTFOUNDï¼‰æ—¶ä¸ºçœŸ</span><br><span class="line">if (not exp)ï¼šä¸ä¸Šé¢ç›¸å</span><br><span class="line">if (var1 AND var2)</span><br><span class="line">if (var1 OR var2)</span><br><span class="line">if (COMMAND cmd)ï¼šå¦‚æœ cmd ç¡®å®æ˜¯å‘½ä»¤å¹¶å¯è°ƒç”¨ä¸ºçœŸ</span><br><span class="line">if (EXISTS dir) if (EXISTS file)ï¼šå¦‚æœç›®å½•æˆ–æ–‡ä»¶å­˜åœ¨ä¸ºçœŸ</span><br><span class="line">if (file1 IS_NEWER_THAN file2)ï¼šå½“ file1 æ¯” file2 æ–°ï¼Œæˆ– file1/file2 ä¸­æœ‰ä¸€ä¸ªä¸å­˜åœ¨æ—¶ä¸ºçœŸï¼Œæ–‡ä»¶åéœ€ä½¿ç”¨å…¨è·¯å¾„</span><br><span class="line">if (IS_DIRECTORY dir)ï¼šå½“ dir æ˜¯ç›®å½•æ—¶ä¸ºçœŸ</span><br><span class="line">if (DEFINED var)ï¼šå¦‚æœå˜é‡è¢«å®šä¹‰ä¸ºçœŸ</span><br><span class="line">if (var MATCHES regex)ï¼šç»™å®šçš„å˜é‡æˆ–è€…å­—ç¬¦ä¸²èƒ½å¤ŸåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ regex æ—¶ä¸ºçœŸï¼Œæ­¤å¤„ <span class="selector-tag">var</span> å¯ä»¥ç”¨ <span class="selector-tag">var</span> åï¼Œä¹Ÿå¯ä»¥ç”¨ $&#123;<span class="selector-tag">var</span>&#125;</span><br><span class="line">if (string MATCHES regex)</span><br></pre></td></tr></table></figure><p>æ•°å­—æ¯”è¾ƒï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (variable LESS number)ï¼šLESS å°äº</span><br><span class="line">if (string LESS number)</span><br><span class="line">if (variable GREATER number)ï¼šGREATER å¤§äº</span><br><span class="line">if (string GREATER number)</span><br><span class="line">if (variable EQUAL number)ï¼šEQUAL ç­‰äº</span><br><span class="line">if (string EQUAL number)</span><br></pre></td></tr></table></figure><p>å­—æ¯è¡¨é¡ºåºæ¯”è¾ƒï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (variable STRLESS string)</span><br><span class="line">if (string STRLESS string)</span><br><span class="line">if (variable STRGREATER string)</span><br><span class="line">if (string STRGREATER string)</span><br><span class="line">if (variable STREQUAL string)</span><br><span class="line">if (string STREQUAL string)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">if(MSVC)</span><br><span class="line">    set(LINK_LIBS common)</span><br><span class="line">else()</span><br><span class="line">    set(boost_thread boost_log.a boost_system.a)</span><br><span class="line">endif()</span><br><span class="line">target_link_libraries(demo $&#123;LINK_LIBS&#125;)</span><br><span class="line"># æˆ–è€…</span><br><span class="line">if(UNIX)</span><br><span class="line">    set(CMAKE_CXX_FLAGS &quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++11 -fpermissive -g&quot;)</span><br><span class="line">else()</span><br><span class="line">    add_definitions(-D_SCL_SECURE_NO_WARNINGS</span><br><span class="line">    D_CRT_SECURE_NO_WARNINGS</span><br><span class="line">    -D_WIN32_WINNT=0x601</span><br><span class="line">    -D_WINSOCK_DEPRECATED_NO_WARNINGS)</span><br><span class="line">endif()</span><br><span class="line"> </span><br><span class="line">if($&#123;CMAKE_BUILD_TYPE&#125; MATCHES &quot;debug&quot;)</span><br><span class="line">    ...</span><br><span class="line">else()</span><br><span class="line">    ...</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure><p>10.2 whileâ€¦endwhile</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">while</span>(condition)</span><br><span class="line">    ...</span><br><span class="line"><span class="built_in">endwhile</span>()</span><br></pre></td></tr></table></figure><p>10.3 foreachâ€¦endforeach</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">foreach</span>(loop_var RANGE start stop [step])</span><br><span class="line">    ...</span><br><span class="line"><span class="built_in">endforeach</span>(loop_var)</span><br></pre></td></tr></table></figure><p>start è¡¨ç¤ºèµ·å§‹æ•°ï¼Œstop è¡¨ç¤ºç»ˆæ­¢æ•°ï¼Œstep è¡¨ç¤ºæ­¥é•¿ï¼Œç¤ºä¾‹ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">foreach</span>(i RANGE <span class="number">1</span> <span class="number">9</span> <span class="number">2</span>)</span><br><span class="line">    <span class="built_in">message</span>($&#123;i&#125;)</span><br><span class="line"><span class="built_in">endforeach</span>(i)</span><br><span class="line"># è¾“å‡ºï¼š<span class="number">13579</span></span><br></pre></td></tr></table></figure><p><strong>11. æ‰“å°ä¿¡æ¯</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">message</span>($&#123;PROJECT_SOURCE_DIR&#125;)</span><br><span class="line"><span class="built_in">message</span>(&quot;build with debug mode&quot;)</span><br><span class="line"><span class="built_in">message</span>(WARNING &quot;this is warnning message&quot;)</span><br><span class="line"><span class="built_in">message</span>(FATAL_ERROR &quot;this build has many error&quot;) # FATAL_ERROR ä¼šå¯¼è‡´ç¼–è¯‘å¤±è´¥</span><br></pre></td></tr></table></figure><p><strong>12. åŒ…å«å…¶å®ƒ cmake æ–‡ä»¶</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">include</span>(./common.cmake) # æŒ‡å®šåŒ…å«æ–‡ä»¶çš„å…¨è·¯å¾„</span><br><span class="line"><span class="built_in">include</span>(def) # åœ¨æœç´¢è·¯å¾„ä¸­æœç´¢def<span class="selector-class">.cmake</span>æ–‡ä»¶</span><br><span class="line"><span class="built_in">set</span>(CMAKE_MODULE_PATH $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/cmake) # è®¾ç½®includeçš„æœç´¢è·¯å¾„</span><br></pre></td></tr></table></figure><h3 id="å¸¸ç”¨ä¿¡æ¯">å¸¸ç”¨ä¿¡æ¯</h3><p><strong>1.é¢„å®šä¹‰å˜é‡</strong></p><ul><li>PROJECT_SOURCE_DIRï¼šå·¥ç¨‹çš„æ ¹ç›®å½•</li><li>PROJECT_BINARY_DIRï¼šè¿è¡Œ cmake å‘½ä»¤çš„ç›®å½•ï¼Œé€šå¸¸æ˜¯ ${PROJECT_SOURCE_DIR}/build</li><li>PROJECT_NAMEï¼šè¿”å›é€šè¿‡ project å‘½ä»¤å®šä¹‰çš„é¡¹ç›®åç§°</li><li>CMAKE_CURRENT_SOURCE_DIRï¼šå½“å‰å¤„ç†çš„ CMakeLists.txt æ‰€åœ¨çš„è·¯å¾„</li><li>CMAKE_CURRENT_BINARY_DIRï¼štarget ç¼–è¯‘ç›®å½•</li><li>CMAKE_CURRENT_LIST_DIRï¼šCMakeLists.txt çš„å®Œæ•´è·¯å¾„</li><li>CMAKE_CURRENT_LIST_LINEï¼šå½“å‰æ‰€åœ¨çš„è¡Œ</li><li>CMAKE_MODULE_PATHï¼šå®šä¹‰è‡ªå·±çš„ cmake æ¨¡å—æ‰€åœ¨çš„è·¯å¾„ï¼ŒSET(CMAKE_MODULE_PATH</li><li>${PROJECT_SOURCE_DIR}/cmake)ï¼Œç„¶åå¯ä»¥ç”¨INCLUDEå‘½ä»¤æ¥è°ƒç”¨è‡ªå·±çš„æ¨¡å—</li><li>EXECUTABLE_OUTPUT_PATHï¼šé‡æ–°å®šä¹‰ç›®æ ‡äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„å­˜æ”¾ä½ç½®</li><li>LIBRARY_OUTPUT_PATHï¼šé‡æ–°å®šä¹‰ç›®æ ‡é“¾æ¥åº“æ–‡ä»¶çš„å­˜æ”¾ä½ç½®</li></ul><p><strong>2. ç¯å¢ƒå˜é‡</strong></p><p>ä½¿ç”¨ç¯å¢ƒå˜é‡</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ENV</span>&#123;Name&#125;</span><br></pre></td></tr></table></figure><p>å†™å…¥ç¯å¢ƒå˜é‡</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(ENV&#123;Name&#125; <span class="keyword">value</span>) <span class="meta"># è¿™é‡Œæ²¡æœ‰â€œ$â€ç¬¦å·</span></span><br></pre></td></tr></table></figure><p>3.ç³»ç»Ÿä¿¡æ¯</p><ul><li>CMAKE_MAJOR_VERSIONï¼šcmake ä¸»ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ 3.4.1 ä¸­çš„ 3</li><li>CMAKE_MINOR_VERSIONï¼šcmake æ¬¡ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ 3.4.1 ä¸­çš„ 4</li><li>CMAKE_PATCH_VERSIONï¼šcmake è¡¥ä¸ç­‰çº§ï¼Œæ¯”å¦‚ 3.4.1 ä¸­çš„ 1</li><li>CMAKE_SYSTEMï¼šç³»ç»Ÿåç§°ï¼Œæ¯”å¦‚ Linux-Â­2.6.22Â­</li><li>CMAKE_SYSTEM_NAMEï¼šä¸åŒ…å«ç‰ˆæœ¬çš„ç³»ç»Ÿåï¼Œæ¯”å¦‚ LinuxÂ­</li><li>CMAKE_SYSTEM_VERSIONï¼šç³»ç»Ÿç‰ˆæœ¬ï¼Œæ¯”å¦‚ 2.6.22</li><li>CMAKE_SYSTEM_PROCESSORï¼šå¤„ç†å™¨åç§°ï¼Œæ¯”å¦‚ i686</li><li>UNIXï¼šåœ¨æ‰€æœ‰çš„ç±» UNIX å¹³å°ä¸‹è¯¥å€¼ä¸º TRUEï¼ŒåŒ…æ‹¬ OS X å’Œ cygwin</li><li>WIN32ï¼šåœ¨æ‰€æœ‰çš„ win32 å¹³å°ä¸‹è¯¥å€¼ä¸º TRUEï¼ŒåŒ…æ‹¬ cygwin</li></ul><p>4.ä¸»è¦å¼€å…³é€‰é¡¹</p><ul><li>BUILD_SHARED_LIBSï¼šè¿™ä¸ªå¼€å…³ç”¨æ¥æ§åˆ¶é»˜è®¤çš„åº“ç¼–è¯‘æ–¹å¼ï¼Œå¦‚æœä¸è¿›è¡Œè®¾ç½®ï¼Œä½¿ç”¨ add_library åˆæ²¡æœ‰æŒ‡å®šåº“ç±»å‹çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ç¼–è¯‘ç”Ÿæˆçš„åº“éƒ½æ˜¯é™æ€åº“ã€‚å¦‚æœ set(BUILD_SHARED_LIBS ON) åï¼Œé»˜è®¤ç”Ÿæˆçš„ä¸ºåŠ¨æ€åº“</li><li>CMAKE_C_FLAGSï¼šè®¾ç½® C ç¼–è¯‘é€‰é¡¹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡ä»¤ add_definitions() æ·»åŠ </li><li>CMAKE_CXX_FLAGSï¼šè®¾ç½® C++ ç¼–è¯‘é€‰é¡¹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡ä»¤ add_definitions() æ·»åŠ </li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_definitions</span>(-DENABLE_DEBUG -DABC) <span class="comment"># å‚æ•°ä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”</span></span><br></pre></td></tr></table></figure><h2 id="å®æˆ˜">å®æˆ˜</h2><p>åœ¨å®è·µä¹‹å‰ï¼Œå…ˆçœ‹ä»½å»å¹´å†™çš„CMakeList.txtï¼Œæˆªå–éƒ¨åˆ†ã€‚</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># æ‰“å°CMakeæ¨¡å—è·¯å¾„</span><br><span class="line"><span class="built_in">message</span>(&quot;CMake module path: $&#123;CMAKE_MODULE_PATH&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># è®¾ç½®CMakeçš„æœ€ä½ç‰ˆæœ¬è¦æ±‚ä¸º<span class="number">2.8</span></span><br><span class="line"><span class="built_in">cmake_minimum_required</span>( VERSION <span class="number">2.8</span> )</span><br><span class="line"></span><br><span class="line"># è®¾ç½®C++ç¼–è¯‘å™¨çš„æ ‡å¿—ï¼Œå¯ç”¨C++<span class="number">11</span>æ ‡å‡†</span><br><span class="line"><span class="built_in">SET</span>(CMAKE_CXX_FLAGS &quot;-std=c++<span class="number">11</span>&quot;)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ ç¼–è¯‘é€‰é¡¹ï¼Œå¯ç”¨-Wformatè­¦å‘Š</span><br><span class="line"><span class="built_in">add_compile_options</span>(-Wformat)</span><br><span class="line"></span><br><span class="line"># è®¾ç½®é¡¹ç›®åç§°ä¸º&quot;task&quot;</span><br><span class="line"><span class="built_in">project</span>(task)</span><br><span class="line"></span><br><span class="line"># è®¾ç½®OpenCVçš„è·¯å¾„ï¼Œå¹¶æŸ¥æ‰¾OpenCVåº“</span><br><span class="line"><span class="built_in">set</span>(OpenCV_DIR &quot;/usr/local/include/opencv2&quot;)</span><br><span class="line"><span class="built_in">find_package</span>( OpenCV <span class="number">2</span>  REQUIRED )</span><br><span class="line"></span><br><span class="line"># å°†OpenCVçš„å¤´æ–‡ä»¶ç›®å½•æ·»åŠ åˆ°åŒ…å«ç›®å½•ä¸­</span><br><span class="line"><span class="built_in">include_directories</span>($&#123;OpenCV_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"># æŸ¥æ‰¾libtiffåº“ï¼Œå¹¶å°†å…¶å¤´æ–‡ä»¶ç›®å½•æ·»åŠ åˆ°åŒ…å«ç›®å½•ä¸­</span><br><span class="line"><span class="built_in">find_package</span>(TIFF REQUIRED)</span><br><span class="line"><span class="built_in">include_directories</span>($&#123;TIFF_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"># è®¾ç½®libgdalåº“çš„è·¯å¾„ï¼Œå¹¶å°†å…¶å¤´æ–‡ä»¶ç›®å½•æ·»åŠ åˆ°åŒ…å«ç›®å½•ä¸­</span><br><span class="line"><span class="built_in">set</span>(LIBGDAL_INCLUDE_DIR &quot;/usr/local/include&quot;)</span><br><span class="line"><span class="built_in">set</span>(LIBGDAL_LIBRARY &quot;/usr/local/lib64/libgdal.so&quot;)</span><br><span class="line"><span class="built_in">include_directories</span>($&#123;LIBGDAL_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"># å°†libgdalåº“æ·»åŠ åˆ°é“¾æ¥åº“ä¸­</span><br><span class="line"><span class="built_in">link_libraries</span>($&#123;LIBGDAL_LIBRARY&#125;)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ ä¸€ä¸ªåä¸º&quot;task&quot;çš„å¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡ï¼Œè®¾ç½®å…¶æºæ–‡ä»¶</span><br><span class="line"><span class="built_in">add_executable</span>( </span><br><span class="line">    task </span><br><span class="line">    src/main.cpp</span><br><span class="line">    include/XmlParse/tinyxml.cpp</span><br><span class="line">    include/XmlParse/tinyxmlparser.cpp</span><br><span class="line">    include/XmlParse/tinyxmlerror.cpp</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># å°†OpenCVåº“ã€libtiffåº“å’Œlibrawåº“æ·»åŠ åˆ°&quot;task&quot;ç›®æ ‡çš„é“¾æ¥åº“ä¸­</span><br><span class="line"><span class="built_in">target_link_libraries</span>(task  $&#123;OpenCV_LIBS&#125; $&#123;TIFF_LIBRARIES&#125; $&#123;LIBRAW_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"># å°†pthreadåº“æ·»åŠ åˆ°&quot;task&quot;ç›®æ ‡çš„é“¾æ¥åº“ä¸­</span><br><span class="line"><span class="built_in">target_link_libraries</span>(task  -lpthread)</span><br><span class="line"></span><br><span class="line"># å°†openmpåº“æ·»åŠ åˆ°&quot;task&quot;ç›®æ ‡çš„é“¾æ¥åº“ä¸­</span><br><span class="line"><span class="built_in">target_link_libraries</span>(task  -fopenmp)</span><br></pre></td></tr></table></figure><h3 id="å•ä¸ªæºæ–‡ä»¶">å•ä¸ªæºæ–‡ä»¶</h3><p>(æºä»£ç æ‰€åœ¨ç›®å½•ï¼šDemo1)</p><p>å‡è®¾ç°åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­åªæœ‰ä¸€ä¸ªæºæ–‡ä»¶<a href="https://link.zhihu.com/?target=http%3A//main.cc">http://main.cc</a>ï¼Œè¯¥ç¨‹åºçš„ç”¨é€”æ˜¯è®¡ç®—ä¸€ä¸ªæ•°çš„æŒ‡æ•°å¹‚ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * power - Calculate the power of number.</span><br><span class="line"> * @param base: Base value.</span><br><span class="line"> * @param exponent: Exponent value.</span><br><span class="line"> *</span><br><span class="line"> * @return base raised to the power exponent.</span><br><span class="line"> */</span><br><span class="line">double power(double base, int exponent)</span><br><span class="line">&#123;</span><br><span class="line">    int result = base;</span><br><span class="line">    int i;</span><br><span class="line"></span><br><span class="line">    if (exponent == 0) &#123;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    for(i = 1; i &lt; exponent; ++i)&#123;</span><br><span class="line">        result = result * base;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    if (argc &lt; 3)&#123;</span><br><span class="line">        printf(&quot;Usage: %s base exponent \n&quot;, argv[0]);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    double base = atof(argv[1]);</span><br><span class="line">    int exponent = atoi(argv[2]);</span><br><span class="line">    double result = power(base, exponent);</span><br><span class="line">    printf(&quot;%g ^ %d is %g\n&quot;, base, exponent, result);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆç¼–å†™ CMakeLists.txt æ–‡ä»¶ï¼Œå¹¶ä¿å­˜åœ¨ä¸<a href="https://link.zhihu.com/?target=http%3A//mian.cc">http://mian.cc</a>æºæ–‡ä»¶åŒä¸ªç›®å½•ä¸‹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># CMake æœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span><br><span class="line">cmake_minimum_required (VERSION 2.8)</span><br><span class="line"></span><br><span class="line"># é¡¹ç›®ä¿¡æ¯</span><br><span class="line">project (Demo1)</span><br><span class="line"></span><br><span class="line"># æŒ‡å®šç”Ÿæˆç›®æ ‡</span><br><span class="line">add_executable(Demo main.cc)</span><br></pre></td></tr></table></figure><p>CMakeLists.txt çš„è¯­æ³•æ¯”è¾ƒç®€å•ï¼Œç”±å‘½ä»¤ã€æ³¨é‡Šå’Œç©ºæ ¼ç»„æˆï¼Œå…¶ä¸­å‘½ä»¤æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ã€‚ç¬¦å· <code>#</code> åé¢çš„å†…å®¹è¢«è®¤ä¸ºæ˜¯æ³¨é‡Šã€‚å‘½ä»¤ç”±å‘½ä»¤åç§°ã€å°æ‹¬å·å’Œå‚æ•°ç»„æˆï¼Œå‚æ•°ä¹‹é—´ä½¿ç”¨ç©ºæ ¼è¿›è¡Œé—´éš”ã€‚</p><p>å¯¹äºä¸Šé¢çš„ CMakeLists.txt æ–‡ä»¶ï¼Œä¾æ¬¡å‡ºç°äº†å‡ ä¸ªå‘½ä»¤ï¼š</p><ol><li><code>cmake_minimum_required</code>ï¼šæŒ‡å®šè¿è¡Œæ­¤é…ç½®æ–‡ä»¶æ‰€éœ€çš„ CMake çš„æœ€ä½ç‰ˆæœ¬ï¼›</li><li><code>project</code>ï¼šå‚æ•°å€¼æ˜¯ <code>Demo1</code>ï¼Œè¯¥å‘½ä»¤è¡¨ç¤ºé¡¹ç›®çš„åç§°æ˜¯ <code>Demo1</code> ã€‚</li><li><code>add_executable</code>ï¼š å°†åä¸º <a href="http://main.cc">main.cc</a> çš„æºæ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªåç§°ä¸º Demo çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li></ol><p>ä¹‹åï¼Œåœ¨å½“å‰ç›®å½•æ‰§è¡Œ<code>cmake .</code>ï¼Œå¾—åˆ° Makefile åå†ä½¿ç”¨<code>make</code>å‘½ä»¤ç¼–è¯‘å¾—åˆ° Demo1 å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><h3 id="å¤šä¸ªæºæ–‡ä»¶">å¤šä¸ªæºæ–‡ä»¶</h3><p>(æºä»£ç æ‰€åœ¨ç›®å½•Demo2)</p><p>ä¸Šé¢çš„ä¾‹å­åªæœ‰å•ä¸ªæºæ–‡ä»¶ã€‚ç°åœ¨å‡å¦‚æŠŠ<code>power</code>å‡½æ•°å•ç‹¬å†™è¿›ä¸€ä¸ªåä¸º<code>MathFunctions.c</code>çš„æºæ–‡ä»¶é‡Œï¼Œä½¿å¾—è¿™ä¸ªå·¥ç¨‹å˜æˆå¦‚ä¸‹çš„å½¢å¼ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/Demo2</span><br><span class="line">    |</span><br><span class="line">    +--- main.cc</span><br><span class="line">    |</span><br><span class="line">    +--- MathFunctions.cc</span><br><span class="line">    |</span><br><span class="line">    +--- MathFunctions.h</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼ŒCMakeLists.txt å¯ä»¥æ”¹æˆå¦‚ä¸‹çš„å½¢å¼ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># CMake æœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span><br><span class="line">cmake_minimum_required (VERSION 2.8)</span><br><span class="line"></span><br><span class="line"># é¡¹ç›®ä¿¡æ¯</span><br><span class="line">project (Demo2)</span><br><span class="line"></span><br><span class="line"># æŒ‡å®šç”Ÿæˆç›®æ ‡</span><br><span class="line">add_executable(Demo main.cc MathFunctions.cc)</span><br></pre></td></tr></table></figure><p>å”¯ä¸€çš„æ”¹åŠ¨åªæ˜¯åœ¨<code>add_executable</code>å‘½ä»¤ä¸­å¢åŠ äº†ä¸€ä¸ª<code>MathFunctions.cc</code>æºæ–‡ä»¶ã€‚è¿™æ ·å†™å½“ç„¶æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæºæ–‡ä»¶å¾ˆå¤šï¼ŒæŠŠæ‰€æœ‰æºæ–‡ä»¶çš„åå­—éƒ½åŠ è¿›å»å°†æ˜¯ä¸€ä»¶çƒ¦äººçš„å·¥ä½œã€‚æ›´çœäº‹çš„æ–¹æ³•æ˜¯ä½¿ç”¨<code>aux_source_directory</code>å‘½ä»¤ï¼Œè¯¥å‘½ä»¤ä¼šæŸ¥æ‰¾æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶ï¼Œç„¶åå°†ç»“æœå­˜è¿›æŒ‡å®šå˜é‡åã€‚å…¶è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aux_source_directory(&lt;dir&gt; &lt;variable&gt;)</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œå¯ä»¥ä¿®æ”¹ CMakeLists.txt å¦‚ä¸‹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># CMake æœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span><br><span class="line">cmake_minimum_required (VERSION 2.8)</span><br><span class="line"></span><br><span class="line"># é¡¹ç›®ä¿¡æ¯</span><br><span class="line">project (Demo2)</span><br><span class="line"></span><br><span class="line"># æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶</span><br><span class="line"># å¹¶å°†åç§°ä¿å­˜åˆ° DIR_SRCS å˜é‡</span><br><span class="line">aux_source_directory(. DIR_SRCS)</span><br><span class="line"></span><br><span class="line"># æŒ‡å®šç”Ÿæˆç›®æ ‡</span><br><span class="line">add_executable(Demo $&#123;DIR_SRCS&#125;)</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼ŒCMake ä¼šå°†å½“å‰ç›®å½•æ‰€æœ‰æºæ–‡ä»¶çš„æ–‡ä»¶åèµ‹å€¼ç»™å˜é‡<code>DIR_SRCS</code>ï¼Œå†æŒ‡ç¤ºå˜é‡<code>DIR_SRCS</code>ä¸­çš„æºæ–‡ä»¶éœ€è¦ç¼–è¯‘æˆä¸€ä¸ªåç§°ä¸º Demo çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><h3 id="å¤šä¸ªç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶">å¤šä¸ªç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶</h3><p>(æºä»£ç æ‰€åœ¨ç›®å½•Demo3)</p><p>ç°åœ¨è¿›ä¸€æ­¥å°† MathFunctions.h å’Œ<a href="https://link.zhihu.com/?target=http%3A//MathFunctions.cc">http://MathFunctions.cc</a>æ–‡ä»¶ç§»åŠ¨åˆ° math ç›®å½•ä¸‹ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./Demo3</span><br><span class="line">    |</span><br><span class="line">    +--- main.cc</span><br><span class="line">    |</span><br><span class="line">    +--- math/</span><br><span class="line">          |</span><br><span class="line">          +--- MathFunctions.cc</span><br><span class="line">          |</span><br><span class="line">          +--- MathFunctions.h</span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™ç§æƒ…å†µï¼Œéœ€è¦åˆ†åˆ«åœ¨é¡¹ç›®æ ¹ç›®å½• Demo3 å’Œ math ç›®å½•é‡Œå„ç¼–å†™ä¸€ä¸ª CMakeLists.txt æ–‡ä»¶ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°† math ç›®å½•é‡Œçš„æ–‡ä»¶ç¼–è¯‘æˆé™æ€åº“å†ç”± main å‡½æ•°è°ƒç”¨ã€‚</p><p>æ ¹ç›®å½•ä¸­çš„ CMakeLists.txt ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># CMake æœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span><br><span class="line">cmake_minimum_required (VERSION 2.8)</span><br><span class="line"></span><br><span class="line"># é¡¹ç›®ä¿¡æ¯</span><br><span class="line">project (Demo3)</span><br><span class="line"></span><br><span class="line"># æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶</span><br><span class="line"># å¹¶å°†åç§°ä¿å­˜åˆ° DIR_SRCS å˜é‡</span><br><span class="line">aux_source_directory(. DIR_SRCS)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ  math å­ç›®å½•</span><br><span class="line">add_subdirectory(math)</span><br><span class="line"></span><br><span class="line"># æŒ‡å®šç”Ÿæˆç›®æ ‡ </span><br><span class="line">add_executable(Demo $&#123;DIR_SRCS&#125;)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ é“¾æ¥åº“</span><br><span class="line">target_link_libraries(Demo MathFunctions)</span><br></pre></td></tr></table></figure><p>è¯¥æ–‡ä»¶æ·»åŠ äº†ä¸‹é¢çš„å†…å®¹: ç¬¬3è¡Œï¼Œä½¿ç”¨å‘½ä»¤ <code>add_subdirectory</code> æŒ‡æ˜æœ¬é¡¹ç›®åŒ…å«ä¸€ä¸ªå­ç›®å½• mathï¼Œè¿™æ · math ç›®å½•ä¸‹çš„ CMakeLists.txt æ–‡ä»¶å’Œæºä»£ç ä¹Ÿä¼šè¢«å¤„ç† ã€‚ç¬¬6è¡Œï¼Œä½¿ç”¨å‘½ä»¤ <code>target_link_libraries</code> æŒ‡æ˜å¯æ‰§è¡Œæ–‡ä»¶ main éœ€è¦è¿æ¥ä¸€ä¸ªåä¸º MathFunctions çš„é“¾æ¥åº“ ã€‚</p><p>å­ç›®å½•ä¸­çš„ CMakeLists.txtï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶</span><br><span class="line"># å¹¶å°†åç§°ä¿å­˜åˆ° DIR_LIB_SRCS å˜é‡</span><br><span class="line">aux_source_directory(. DIR_LIB_SRCS)</span><br><span class="line"></span><br><span class="line"># ç”Ÿæˆé“¾æ¥åº“</span><br><span class="line">add_library (MathFunctions $&#123;DIR_LIB_SRCS&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥æ–‡ä»¶ä¸­ä½¿ç”¨å‘½ä»¤<code>add_library</code>å°† src ç›®å½•ä¸­çš„æºæ–‡ä»¶ç¼–è¯‘ä¸ºé™æ€é“¾æ¥åº“ã€‚</p><h2 id="èµ„æ–™">èµ„æ–™</h2><ul><li><a href="https://gavinliu6.github.io/CMake-Practice-zh-CN/#/acquaintance">cmakeå®æˆ˜</a></li><li><a href="https://zhuanlan.zhihu.com/p/661284252">CMakeæ„å»ºå¤§å‹C_C++é¡¹ç›®ï¼šè·¨å¹³å°è®¾è®¡ä¸é«˜çº§åº”ç”¨</a></li><li><a href="https://blog.csdn.net/afei__/article/details/81201039">CMakeLists.txt è¯­æ³•ä»‹ç»ä¸å®ä¾‹æ¼”ç»ƒ</a></li></ul>]]></content>
    
    
    <summary type="html">CMakeå¿«é€Ÿä¸Šæ‰‹</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</title>
    <link href="https://penge666.github.io/posts/161dcf21.html"/>
    <id>https://penge666.github.io/posts/161dcf21.html</id>
    <published>2024-05-06T13:47:26.000Z</published>
    <updated>2024-05-06T13:49:06.703Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªä»“åº“ä¸»è®°å½•äº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼ä¸­ç»å…¸çš„æ¡ˆä¾‹ã€‚</p><h1 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</h1><p>å®Œæ•´ä»£ç è§ä»“åº“ï¼š<a href="https://github.com/Penge666/Producer-Consumer-Pattern">https://github.com/Penge666/Producer-Consumer-Pattern</a></p><p><strong>1.CPUè½®è¯¢ç­‰å¾…ç‰ˆå•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…ï¼š</strong>ï¼ˆbasic.cppï¼‰</p><p>è¯¥ç‰ˆæœ¬ä½¿ç”¨äº†ç®€å•çš„è½®è¯¢æœºåˆ¶ï¼Œç”Ÿäº§è€…ä¸æ–­åœ°æ£€æŸ¥æ¶ˆè´¹è€…æ˜¯å¦å·²ç»æ¶ˆè´¹å®Œæ•°æ®ã€‚è¿™ç§æ¨¡å¼ç®€å•ç›´æ¥ï¼Œä½†æ•ˆç‡è¾ƒä½ï¼Œå› ä¸ºç”Ÿäº§è€…åœ¨æ²¡æœ‰æ•°æ®æ—¶ä»ç„¶åœ¨å¿™ç­‰å¾…ã€‚</p><p><strong>å®ç°</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">           data_ = <span class="built_in">rand</span>() % <span class="number">100</span>;</span><br><span class="line">           cout &lt;&lt; <span class="string">&quot;ç”Ÿäº§data:&quot;</span> &lt;&lt; data_ &lt;&lt; endl;</span><br><span class="line">           ready_ = <span class="literal">true</span>;</span><br><span class="line">           lock.<span class="built_in">unlock</span>();</span><br><span class="line">           <span class="keyword">while</span> (ready_)</span><br><span class="line">           &#123;</span><br><span class="line">               this_thread::<span class="built_in">sleep_for</span>(chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">Producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">while</span> (!ready_)</span><br><span class="line">           &#123;</span><br><span class="line">               this_thread::<span class="built_in">sleep_for</span>(chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">           cout &lt;&lt; <span class="string">&quot;æ¶ˆè´¹data:&quot;</span> &lt;&lt; data_ &lt;&lt; endl;</span><br><span class="line">           ready_ = <span class="literal">false</span>;</span><br><span class="line">           lock.<span class="built_in">unlock</span>();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><strong>2.ç­‰å¾…é€šçŸ¥ç‰ˆå•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…ï¼š</strong>ï¼ˆsingle.cppï¼‰</p><p>è¯¥ç‰ˆæœ¬å¼•å…¥äº†ç­‰å¾…é€šçŸ¥æœºåˆ¶ï¼Œç”Ÿäº§è€…åœ¨æ²¡æœ‰æ•°æ®æ—¶ä¼šç­‰å¾…æ¶ˆè´¹è€…çš„é€šçŸ¥ã€‚è¿™ç§æ¨¡å¼é¿å…äº†å¿™ç­‰å¾…ï¼Œæé«˜äº†æ•ˆç‡ï¼ŒåŒæ—¶å‡å°‘äº†èµ„æºæ¶ˆè€—ã€‚</p><p><strong>å®ç°</strong></p><p>åœ¨è¿™ä¸ªç‰ˆæœ¬æˆ‘ä»¬å€ŸåŠ©condition_variableï¼Œå®Œæˆå¤šçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ“ä½œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::condition_variable cv_;</span><br><span class="line"><span class="type">bool</span> ready_&#123;<span class="literal">false</span>&#125;;</span><br></pre></td></tr></table></figure><p>ç”Ÿäº§è€…ä¼šä¸æ–­ç”Ÿæˆä¸€ä¸ªéšæœºæ•°å¹¶å°†å…¶å­˜å‚¨åœ¨ data<em> å˜é‡ä¸­ï¼Œç„¶åå°† ready</em> æ ‡å¿—è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºæœ‰å¯ç”¨çš„æ•°æ®ã€‚æ¥ç€ï¼Œå®ƒé€šçŸ¥ç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç„¶åè‡ªå·±ç­‰å¾…æ¶ˆè´¹è€…çº¿ç¨‹å¤„ç†å®Œæ•°æ®ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv_.<span class="built_in">wait</span>(ul, [<span class="keyword">this</span>]() &#123; <span class="keyword">return</span> !ready_; &#125;);</span><br></pre></td></tr></table></figure><p>æ¶ˆè´¹è€…å°†ä¼šåœ¨ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ç­‰å¾…ç”Ÿäº§è€…é€šçŸ¥æ•°æ®çš„å¯ç”¨æ€§ã€‚å½“ ready<em> æ ‡å¿—ä¸º true æ—¶ï¼Œå®ƒä¼šä» data</em> å˜é‡ä¸­è·å–æ•°æ®å¹¶è¿›è¡Œå¤„ç†ï¼Œç„¶åå°† ready_ æ ‡å¿—è®¾ç½®ä¸º falseï¼Œè¡¨ç¤ºæ•°æ®å·²ç»è¢«æ¶ˆè´¹ã€‚æ¥ç€ï¼Œå®ƒé€šçŸ¥ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç„¶åè‡ªå·±ç­‰å¾…ç”Ÿäº§è€…çº¿ç¨‹ç”Ÿæˆæ–°çš„æ•°æ®ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv_.<span class="built_in">wait</span>(ul, [<span class="keyword">this</span>]() &#123; <span class="keyword">return</span> ready_; &#125;);</span><br></pre></td></tr></table></figure><p><strong>3.ç­‰å¾…é€šçŸ¥ç‰ˆå•ç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…ï¼š</strong>ï¼ˆmutiple.cppï¼‰</p><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œå¼•å…¥äº†å¤šä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒä»¬å…±äº«ç”Ÿäº§è€…çš„æ•°æ®ã€‚ç”Ÿäº§è€…åœ¨äº§ç”Ÿæ•°æ®åï¼Œé€šçŸ¥æ‰€æœ‰æ¶ˆè´¹è€…è¿›è¡Œå¤„ç†ã€‚</p><p><strong>å®ç°</strong></p><p>å‰é¢çš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯å•ç”Ÿäº§ï¼Œå•ä¸ªæ¶ˆè´¹è€…ï¼Œå¦‚ä½•åšåˆ°å¤šä¸ªæ¶ˆè´¹è€…æŠ¢å æ¶ˆè´¹ï¼Ÿ</p><p>æ­¤æ—¶éœ€è¦å¼•å…¥é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å°†ä»»åŠ¡ä¸¢åˆ°é˜Ÿåˆ—ä¸­å»ï¼Œéšåå¤šä¸ªæ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹å³å¯ï¼Œä¸ä¸Šè¿°ç­‰å¾…æ¡ä»¶ä¸åŒç‚¹åœ¨äºé˜Ÿåˆ—çš„çŠ¶æ€ã€‚</p><p>å¯¹äºç”Ÿäº§è€…ï¼šå¦‚æœé˜Ÿåˆ—å¤§å°æœªè¾¾åˆ° max<em>queue_size</em> çš„é™åˆ¶ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ç”Ÿäº§è€…çº¿ç¨‹å°†ç­‰å¾…æ¶ˆè´¹è€…çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–èµ°ä¸€äº›æ•°æ®ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv_.<span class="built_in">wait</span>(ul, [<span class="keyword">this</span>]() &#123; <span class="keyword">return</span> queue_.<span class="built_in">size</span>() &lt; max_queue_size_; &#125;); </span><br></pre></td></tr></table></figure><p>å¯¹äºæ¶ˆè´¹è€…ï¼šé˜Ÿåˆ—æœ‰æ•°æ®å°±æ¶ˆè´¹ï¼Œå¦åˆ™ç­‰å¾…ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv_.<span class="built_in">wait</span>(ul, [<span class="keyword">this</span>]() &#123; <span class="keyword">return</span> !queue_.<span class="built_in">empty</span>(); &#125;);</span><br></pre></td></tr></table></figure><p><strong>4.ç­‰å¾…é€šçŸ¥ç‰ˆå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…ï¼š</strong>ï¼ˆmutiple_mutiple.cppï¼‰</p><p>è¿™ä¸ªç‰ˆæœ¬æ”¯æŒå¤šä¸ªç”Ÿäº§è€…å’Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…ä¹‹é—´å’Œæ¶ˆè´¹è€…ä¹‹é—´å…±äº«æ•°æ®ã€‚ç”Ÿäº§è€…åœ¨äº§ç”Ÿæ•°æ®åï¼Œé€šçŸ¥æ‰€æœ‰æ¶ˆè´¹è€…è¿›è¡Œå¤„ç†ã€‚</p><p><strong>å®ç°</strong></p><p>å¯¹äºè¿™ä¸ªç‰ˆæœ¬æ¯”è¾ƒç®€å•ï¼ŒåŸºäºç¬¬ä¸‰ä¸ªç‰ˆæœ¬ç»§ç»­ä¼˜åŒ–ï¼Œåˆ›å»ºnä¸ªç”Ÿäº§è€…çº¿ç¨‹å³å¯ã€‚</p><p><strong>5.å•ç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…å¹¶è¡Œç‰ˆï¼š</strong>ï¼ˆmutiple_sync.cppï¼‰</p><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œå¼•å…¥äº†å¹¶è¡Œå¤„ç†æœºåˆ¶ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥åŒæ—¶å¤„ç†æ•°æ®ã€‚ç”Ÿäº§è€…äº§ç”Ÿæ•°æ®åï¼Œå¤šä¸ªæ¶ˆè´¹è€…å¹¶è¡Œå¤„ç†ï¼Œæé«˜äº†æ•´ä½“å¤„ç†é€Ÿåº¦ã€‚</p><p><strong>å®ç°</strong></p><p>å¯¹äºä»¥ä¸Šç‰ˆæœ¬æœ‰ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜ï¼Œå½“ç”Ÿäº§è€…ç”Ÿäº§çš„æ•°æ®åˆ°è¾¾ä¸Šé™æ—¶ï¼Œæ¶ˆè´¹è€…æ­¤æ—¶åœ¨æ¶ˆè´¹ï¼Œè€Œç”Ÿäº§è€…å¹¶æ²¡æœ‰åŠ¨èµ·æ¥ï¼Œå®ƒåœ¨ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹å®Œæ‰èƒ½è¿›è¡Œï¼Œå¦‚ä½•è®©ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…åŒæ—¶è¿è½¬å‘¢ï¼Ÿ</p><p>æ”¹è¿›ç‚¹åœ¨äºä½¿ç”¨å¤šä¸ªcvï¼Œæ¥å›åˆ‡æ¢é€šçŸ¥ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::condition_variable cv_producer_;</span><br><span class="line">std::condition_variable cv_consumer_;</span><br></pre></td></tr></table></figure><p><strong>6.å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…å¹¶è¡Œç‰ˆï¼š</strong>ï¼ˆmutiple_mutiple_sync.cppï¼‰</p><p>è¿™ä¸ªç‰ˆæœ¬æ”¯æŒå¤šä¸ªç”Ÿäº§è€…å’Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œå¹¶ä¸”å…è®¸å¹¶è¡Œå¤„ç†ã€‚å¤šä¸ªç”Ÿäº§è€…å¹¶è¡Œäº§ç”Ÿæ•°æ®ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å¹¶è¡Œå¤„ç†æ•°æ®ï¼Œæé«˜äº†æ•´ä½“å¹¶å‘èƒ½åŠ›ã€‚</p><p><strong>å®ç°</strong></p><p>åŸºäº5è¿›è¡Œæ”¹é€ ï¼Œæ”¯æŒå¤šä¸ªç”Ÿäº§è€…å³å¯ã€‚</p><p><strong>7.æ”¯æŒLambdaå›è°ƒçš„ä¼˜é›…åœæ­¢ç‰ˆï¼š</strong>ï¼ˆmutiple_mutiple_stop.cppï¼‰</p><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œå¼•å…¥äº†Lambdaå›è°ƒå‡½æ•°ï¼Œç”¨äºä¼˜é›…åœ°åœæ­¢å¹¶å‘å¤„ç†ã€‚å¯ä»¥é€šè¿‡è°ƒç”¨å›è°ƒå‡½æ•°æ¥åœæ­¢ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¤„ç†ï¼Œå¹¶è¿›è¡Œæ¸…ç†å·¥ä½œã€‚</p><p><strong>å®ç°</strong></p><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åŠ å›è°ƒå‡½æ•°</p><p>æœ€åè¿è¡Œã€æ¯”è¾ƒç®€æœ´~ã€‘</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++  mutiple_mutiple_stop.cpp -o mutiple_mutiple_stop -lpthread</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡å­—å­¦ä¹ è‡ªï¼š<a href="https://github.com/LHCyGan/Concurrent_Programming">https://github.com/LHCyGan/Concurrent_Programming</a></p>]]></content>
    
    
    <summary type="html">Producer-Consumer Pattern</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>Mutex</title>
    <link href="https://penge666.github.io/posts/c07087b4.html"/>
    <id>https://penge666.github.io/posts/c07087b4.html</id>
    <published>2024-05-06T11:45:59.000Z</published>
    <updated>2024-05-06T12:06:06.111Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>äº’æ–¥é”åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ç»å¸¸ç¢°åˆ°ï¼Œå› æ­¤å¯¹å…¶éœ€è¦æœ‰ä¸ªæ›´åŠ æ·±å…¥çš„ç†è§£ã€‚è¿™ç¯‡åšå®¢å°†ä½¿ç”¨ä¿¡å·é‡å®ç°çš„äº’æ–¥é”ã€‚</p><p>ç®€æ˜“äº’æ–¥é”ï¼ˆSimpleMutexï¼‰æ˜¯ä¸€ä¸ªåŸºäºåŸå­å˜é‡å’Œä¿¡å·é‡çš„äº’æ–¥é”å®ç°ï¼Œç”¨äºä¿æŠ¤å¹¶ç®¡ç†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å…±äº«èµ„æºè®¿é—®ã€‚å®ƒæä¾›äº†ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹å¼æ¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹å¹¶å‘è®¿é—®æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®å—ä¿æŠ¤çš„èµ„æºï¼Œä»è€Œé¿å…æ•°æ®ç«äº‰å’Œä¸ä¸€è‡´æ€§ã€‚åŸºäº POSIX æ ‡å‡†çš„ä¿¡å·é‡åº“å®ç°ï¼ŒåŒ…å« Catch2 å•å…ƒæµ‹è¯•ï¼Œé™„å¸¦äº†åŸºäº Catch2 æ¡†æ¶çš„å•å…ƒæµ‹è¯•ï¼Œç”¨äºéªŒè¯äº’æ–¥é”çš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ï¼Œä½¿ç”¨bazelç¼–è¯‘ï¼Œgoogleç¼–ç è§„èŒƒã€‚</p><p>å…¶ä¸­æ¶‰åŠC++çŸ¥è¯†ï¼ˆRAIIã€ä¿¡å·é‡ã€lock_guardã€çº¿ç¨‹å®‰å…¨ç¼–ç¨‹ï¼‰</p><h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h2><blockquote><p><strong>ä¿¡å·é‡API</strong></p></blockquote><ul><li><p>ä¿¡å·é‡çš„ç±»å‹ï¼š<code>sem_t</code></p></li><li><p><code>int sem_init(sem_t *sem, int pshared, unsigned int value);</code></p><ul><li>åŠŸèƒ½ï¼šåˆå§‹åŒ–ä¿¡å·é‡</li><li>å‚æ•°<ul><li><code>sem</code>ï¼šä¿¡å·é‡å˜é‡çš„åœ°å€</li><li><code>pshared</code>ï¼š0 ç”¨åœ¨çº¿ç¨‹é—´ ï¼Œé0 ç”¨åœ¨è¿›ç¨‹é—´</li><li><code>value </code>ï¼šä¿¡å·é‡ä¸­çš„å€¼ï¼Œä»£è¡¨å®¹å™¨å¤§å°</li></ul></li></ul></li><li><p><code>int sem_destroy(sem_t *sem);</code></p></li><li><p>åŠŸèƒ½ï¼šé‡Šæ”¾èµ„æº</p></li><li><p><code>int sem_wait(sem_t *sem);</code></p></li><li><p>åŠŸèƒ½ï¼šå¯¹ä¿¡å·é‡åŠ é”ï¼Œè°ƒç”¨ä¸€æ¬¡å¯¹ä¿¡å·é‡çš„å€¼-1ï¼Œå¦‚æœå€¼ä¸º0ï¼Œå°±é˜»å¡</p></li><li><p><code>int sem_trywait(sem_t *sem);</code></p></li><li><p><code>int sem_timedwait(sem_t *sem, const struct timespec *abs_timeout);</code></p></li><li><p>int sem_post(sem_t *sem);</p><ul><li>åŠŸèƒ½ï¼šå¯¹ä¿¡å·é‡è§£é”ï¼Œè°ƒç”¨ä¸€æ¬¡å¯¹ä¿¡å·é‡çš„å€¼+1</li></ul></li><li><p><code>int sem_getvalue(sem_t *sem, int *sval);</code></p></li></ul><h2 id="æ ¸å¿ƒé€»è¾‘">æ ¸å¿ƒé€»è¾‘</h2><blockquote><p><strong>Semaphoreç±»</strong></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Semaphore</span>(<span class="type">int</span> init_count = <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">assert</span>(init_count &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;sema_, <span class="number">0</span>, init_count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">wait</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        rc = <span class="built_in">sem_wait</span>(&amp;sema_);</span><br><span class="line">    &#125; <span class="keyword">while</span> (rc == <span class="number">1</span> &amp;&amp; errno == EINTR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;sema_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”è¾ƒæ ¸å¿ƒå°±æ˜¯ä»¥ä¸Šå‡½æ•°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä¿¡å·é‡åˆå§‹åŒ–è®¾ç½®æˆ0æ˜¯å› ä¸ºåªå¤„ç†éœ€è¦ç­‰å¾…çš„çº¿ç¨‹ã€‚</p><p>å½“éœ€è¦ç­‰å¾…çš„çº¿ç¨‹è¿›å…¥åˆ°waitå‡½æ•°ä¸­ï¼Œsem_waitå‡½æ•°å°†æ£€æŸ¥semaæ˜¯å¦å¤§äº0ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ç­‰å¾…ï¼Œç­‰å¾…æ—¶è¯¥çº¿ç¨‹ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“å…¶ä»–çº¿ç¨‹è°ƒç”¨postå¢å¼ºsemçš„å€¼çš„æ—¶å€™,å³å¤§äº0çš„æ—¶å€™ï¼Œçº¿ç¨‹å°†è§£é™¤é˜»å¡ï¼Œ è§£é™¤é˜»å¡åsemå€¼ä¼šå‡å»1ã€‚</p><p>sem_post åˆ™æ˜¯ ç”¨æ¥å¢åŠ ä¿¡å·é‡çš„å€¼ã€‚</p><blockquote><p><strong>SimpleMutex ç±»</strong></p></blockquote><p><strong>lock() å’Œ unlock()</strong></p><p>SimpleMutex ç±»åŒ…å«ä¸€ä¸ªåä¸º count_ çš„ std::atomic å˜é‡å’Œä¸€ä¸ªåä¸º sema_ çš„ Semaphore å¯¹è±¡ã€‚</p><p>åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œcount_ è¢«åˆå§‹åŒ–ä¸º 0ã€‚</p><ul><li>lock() å‡½æ•°ç”¨äºè·å–äº’æ–¥é”ã€‚å®ƒä½¿ç”¨ fetch_add æ“ä½œå’Œ std::memory_order_acquire å‚æ•°å¯¹ count_ è¿›è¡ŒåŸå­å¢åŠ ï¼Œå¹¶è·å–é”ã€‚ å¦‚æœåœ¨å¢åŠ ä¹‹å‰ count_ çš„å€¼å¤§äº 0ï¼Œè¯´æ˜äº’æ–¥é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°è°ƒç”¨ sema_.wait() æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ä¿¡å·é‡è¢«å‘ä¿¡å·ï¼Œè¡¨ç¤ºäº’æ–¥é”å¯ç”¨ã€‚</li><li>unlock() å‡½æ•°ç”¨äºé‡Šæ”¾äº’æ–¥é”ã€‚å®ƒä½¿ç”¨ fetch_sub æ“ä½œå’Œ std::memory_order_release å‚æ•°å¯¹ count_ è¿›è¡ŒåŸå­å‡å°‘ï¼Œå¹¶é‡Šæ”¾é”ã€‚ å¦‚æœå‡å°‘ä¹‹å‰çš„ count_ å€¼ä»å¤§äº 1ï¼Œè¯´æ˜å…¶ä»–çº¿ç¨‹æ­£åœ¨ç­‰å¾…äº’æ–¥é”ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°è°ƒç”¨ sema_.signal() å‘ä¿¡å·ç»™ä¿¡å·é‡ï¼Œå…è®¸ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹è·å–äº’æ–¥é”ã€‚</li></ul><p>é€šè¿‡ç»“åˆåŸå­å˜é‡ count_ å’Œä¿¡å·é‡ sema_ï¼Œè¯¥å®ç°ç¡®ä¿ç­‰å¾…è·å–äº’æ–¥é”çš„çº¿ç¨‹èƒ½å¤Ÿé«˜æ•ˆåœ°é˜»å¡ï¼Œç›´åˆ°å½“å‰æŒæœ‰è€…é‡Šæ”¾é”ã€‚</p><p>Note:</p><h2 id="ä»£ç ">ä»£ç </h2><p>ä»£ç ä»“åº“ï¼š<a href="https://github.com/Penge666/Mutex.git">https://github.com/Penge666/Mutex.git</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ src/mutex/test.cpp -std=c++11 -Ithird/catch2/ -o <span class="built_in">test</span> -lpthread</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./test</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">åŸºäºä¿¡å·é‡å®ç°çš„äº’æ–¥é”</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>muduoç½‘ç»œåº“</title>
    <link href="https://penge666.github.io/posts/d0543761.html"/>
    <id>https://penge666.github.io/posts/d0543761.html</id>
    <published>2024-05-03T05:14:14.000Z</published>
    <updated>2024-05-04T03:42:31.416Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ç½‘ç»œç¼–ç¨‹æ˜¯ä¸€ä¸ªæ¯”è¾ƒéš¾ç çš„æ¨¡å—ï¼Œä¹Ÿæ˜¯ç›¸å¯¹å…¶ä»–ç¼–ç¨‹è¿›é˜¶çš„æ¨¡å—ï¼Œç‰¹åˆ«æ˜¯å„ç§å›è°ƒå‡½æ•°çš„ç†è§£è°ƒç”¨ä»¥åŠå…¶ä¸­ä¼šé‡åˆ°å„å¼å„æ ·éš¾ä»¥è§£å†³çš„Bugã€‚</p><p>å€Ÿç€å­¦ä¹ é™ˆç¡•å¤§ç¥muduoåº“çš„æœºä¼šé˜…è¯»äº†è¿™æœ¬ç»å…¸çš„ç½‘ç»œç¼–ç¨‹æ•™æã€ŠLinuxå¤šçº¿ç¨‹æœåŠ¡ç«¯ç¼–ç¨‹ã€‹ï¼Œè¿™æœ¬ä¹Ÿæ˜¯è¿™å­¦æœŸä¸€ç›´æƒ³å­¦ä¹ çš„ä¸€æœ¬ä¹¦ï¼ŒPSï¼šå°±åƒç ”ä¸€ä¸‹ä¸€ç›´æƒ³å­¦ä¹ Mit6.824ä¸€æ ·ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240502214205866.png" alt="image-20240502214205866"></p><p>å¼€å§‹æ•´ä½“éƒ¨åˆ†ï¼</p><p>muduoç½‘ç»œåº“æ˜¯Multi-Reactoræ¶æ„ï¼Œå…·ä½“å¯ä»¥åˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>ç½‘ç»œç›¸å…³æ¨¡å—ï¼šå¦‚Socketã€InetAddressã€TcpConnectionã€Acceptorã€TcpServerç­‰</li><li>äº‹ä»¶å¾ªç¯ç›¸å…³æ¨¡å—ï¼šå¦‚EventLoopã€Channelã€Pollerã€EPollPollerç­‰</li><li>çº¿ç¨‹ç›¸å…³æ¨¡å—ï¼šå¦‚Threadã€EventLoopThreadã€EventLoopThreadPoolç­‰</li><li>åŸºç¡€æ¨¡å—ï¼šå¦‚ç”¨æˆ·æ€ç¼“å†²åŒºBufferã€æ—¶é—´æˆ³Timestampã€æ—¥å¿—ç±»Loggerç­‰</li></ul><p>æœ¬æ–‡å‚è€ƒè‡ªï¼š</p><ul><li><a href="https://zhuanlan.zhihu.com/p/495016351">ä¸‡å­—é•¿æ–‡æ¢³ç†Muduoåº“æ ¸å¿ƒä»£ç åŠä¼˜ç§€ç¼–ç¨‹ç»†èŠ‚æ€æƒ³å‰–æ</a></li><li><a href="https://www.cnblogs.com/S1mpleBug/p/16712003.html#231-%E5%85%A8%E5%B1%80%E6%A6%82%E8%A7%88pollerchannel%E5%92%8Ceventloop%E5%9C%A8%E6%95%B4%E4%B8%AAmulti-reactor%E9%80%9A%E4%BF%A1%E6%9E%B6%E6%9E%84%E4%B8%AD%E7%9A%84%E8%A7%92%E8%89%B2">é•¿æ–‡æ¢³ç†muduoç½‘ç»œåº“æ ¸å¿ƒä»£ç ã€å‰–æä¼˜ç§€ç¼–ç¨‹ç»†èŠ‚</a></li><li><a href="https://www.cnblogs.com/fortunely/p/15998209.html">muduoç¬”è®°</a></li></ul><h2 id="åŸç†ç¯‡">åŸç†ç¯‡</h2><h3 id="Multi-Reactor">Multi-Reactor</h3><p>Muduoåº“æ˜¯åŸºäºReactoræ¨¡å¼å®ç°çš„TCPç½‘ç»œç¼–ç¨‹åº“ã€‚</p><p>Multi-Reactoræ¨¡å‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240502220126199.png" alt="image-20240502220126199"></p><h3 id="äº‹ä»¶å¾ªç¯æ¨¡å—">äº‹ä»¶å¾ªç¯æ¨¡å—</h3><p>muduoåº“åŸºäºä¸‰ä¸ªå…³é”®ç»„ä»¶æ¥å®ç°ä¸€ä¸ªreactorï¼Œè¿™ä¸ªreactorå¯ä»¥æŒç»­åœ°ç›‘å¬ä¸€ç»„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰ï¼Œå¹¶æ ¹æ®æ¯ä¸ªfdä¸Šå‘ç”Ÿçš„äº‹ä»¶æ¥è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚è¿™ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶åŒ…æ‹¬Channelç±»ã€Poller/EpollPollerç±»ä»¥åŠEventLoopç±»ã€‚</p><p>å¯ä»¥å…ˆçœ‹ä¸‹æ•´ä½“çš„æ¶æ„ï¼Œå…ˆæœ‰ä¸ªæ•´ä½“çš„äº†è§£ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240502224744115.png" alt="image-20240502224744115"></p><h4 id="Channelç±»">Channelç±»</h4><blockquote><p><strong>æ¦‚è¿°</strong></p></blockquote><p>åœ¨TCPç½‘ç»œç¼–ç¨‹ä¸­ï¼Œè¦æƒ³ä½¿ç”¨IOå¤šè·¯å¤ç”¨æ¥ç›‘å¬æŸä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰ï¼Œéœ€è¦é€šè¿‡epoll_ctlå°†è¿™ä¸ªfdåŠå…¶å…³å¿ƒçš„äº‹ä»¶æ³¨å†Œåˆ°IOå¤šè·¯å¤ç”¨æ¨¡å—ï¼ˆä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºäº‹ä»¶ç›‘å¬å™¨ï¼‰ä¸Šã€‚å½“äº‹ä»¶ç›‘å¬å™¨æ£€æµ‹åˆ°è¯¥fdå‘ç”Ÿäº†æŸä¸ªäº‹ä»¶æ—¶ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªåŒ…å«å‘ç”Ÿäº‹ä»¶çš„fdé›†åˆï¼Œä»¥åŠæ¯ä¸ªfdéƒ½å‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶ã€‚</p><p>Channelç±»å°±æ˜¯è¿™æ ·ä¸€ä¸ªå°è£…ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰ï¼Œè¿™ä¸ªfdå…³å¿ƒçš„äº‹ä»¶ï¼Œä»¥åŠäº‹ä»¶ç›‘å¬å™¨å®é™…æ£€æµ‹åˆ°çš„äº‹ä»¶ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒChannelç±»è¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œå…è®¸ä½ è®¾ç½®è¿™ä¸ªfdçš„å…³å¿ƒçš„äº‹ä»¶ï¼Œå°†è¿™ä¸ªfdåŠå…¶å…³å¿ƒçš„äº‹ä»¶æ³¨å†Œåˆ°äº‹ä»¶ç›‘å¬å™¨ä¸­æˆ–è€…ä»äº‹ä»¶ç›‘å¬å™¨ä¸­ç§»é™¤ï¼Œä»¥åŠä¿å­˜è¿™ä¸ªfdçš„æ¯ç§äº‹ä»¶æ‰€å¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚</p><blockquote><p><strong>æˆå‘˜å˜é‡</strong></p></blockquote><ul><li>int fd_ï¼šChannelå¯¹è±¡å…³å¿ƒçš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li>int events_ï¼šfdæ„Ÿå…´è¶£çš„äº‹ä»¶ç±»å‹é›†åˆã€‚</li><li>int revents_ï¼šä»£è¡¨äº‹ä»¶ç›‘å¬å™¨å®é™…ç›‘å¬åˆ°è¯¥fdå‘ç”Ÿçš„äº‹ä»¶ç±»å‹é›†åˆã€‚å½“äº‹ä»¶ç›‘å¬å™¨ç›‘å¬åˆ°ä¸€ä¸ªfdå‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶ï¼Œé€šè¿‡Channel::set_revents()å‡½æ•°æ¥è®¾ç½®reventså€¼ã€‚</li><li>EventLoop* loopï¼šè¡¨ç¤ºå½“å‰çš„Channelæ˜¯åœ¨å“ªä¸ªloopä¸­ã€‚</li><li>read_callback_ ã€write_callback_ã€close_callback_ã€error_callback_ï¼šè¿™äº›æ˜¯std::functionç±»å‹ï¼Œä»£è¡¨ç€è¿™ä¸ªChannelä¸ºè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¿å­˜çš„å„äº‹ä»¶ç±»å‹å‘ç”Ÿæ—¶çš„å¤„ç†å‡½æ•°ã€‚æ¯”å¦‚è¿™ä¸ªfdå‘ç”Ÿäº†å¯è¯»äº‹ä»¶ï¼Œéœ€è¦æ‰§è¡Œå¯è¯»äº‹ä»¶å¤„ç†å‡½æ•°ï¼ŒChannelç±»éƒ½æ›¿ä½ ä¿ç®¡å¥½äº†è¿™äº›å¯è°ƒç”¨å‡½æ•°ã€‚</li></ul><blockquote><p><strong>æˆå‘˜å‡½æ•°</strong></p></blockquote><p>æˆå‘˜å‡½æ•°çš„è®¾è®¡æ˜¯æ ¹æ®æˆå‘˜å˜é‡å’Œè¿™ä¸ªç±»çš„åŠŸèƒ½è®¾è®¡ï¼Œåœ¨è®¾è®¡ä¹‹å‰æˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥å…ˆæƒ³æƒ³ä½œè€…ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ã€‚</p><ul><li><p>å‘Channelå¯¹è±¡æ³¨å†Œå„ç±»äº‹ä»¶çš„å¤„ç†å‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setReadCallback</span><span class="params">(ReadEventCallback cb)</span> </span>&#123;read_callback_ = std::<span class="built_in">move</span>(cb);&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setWriteCallback</span><span class="params">(Eventcallback cb)</span> </span>&#123;write_callback_ = std::<span class="built_in">move</span>(cb);&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setCloseCallback</span><span class="params">(EventCallback cb)</span> </span>&#123;close_callback_ = std::<span class="built_in">move</span>(cb);&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setErrorCallback</span><span class="params">(EventCallback cb)</span> </span>&#123;error_callback_ = std::<span class="built_in">move</span>(cb);&#125; </span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯äº‹ä»¶ç›‘å¬å™¨ç›‘å¬åˆ°æè¿°ç¬¦å‘ç”Ÿçš„äº‹ä»¶çš„æ—¶å€™ï¼Œç›¸åº”çš„å¤„ç†å‡½æ•°æ¥å¤„ç†ã€‚å¤„ç†å‡½æ•°ä¿å­˜åœ¨Channelç±»ä¸­ï¼Œè¿™æ ·è°ƒç”¨ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ã€‚ç¬¬äºŒç‚¹æ‰€ç¤ºã€‚</p></li><li><p>æ ¹æ®polleré€šçŸ¥çš„channelå‘ç”Ÿçš„å…·ä½“äº‹ä»¶ï¼Œ ç”±channelè´Ÿè´£è°ƒç”¨å…·ä½“çš„å›è°ƒæ“ä½œ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Channel::handleEventWithGuard</span><span class="params">(Timestamp receiveTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;channel handleEvent revents:%d\n&quot;</span>, revents_);</span><br><span class="line">    <span class="keyword">if</span> ((revents_ &amp; EPOLLHUP) &amp;&amp; !(revents_ &amp; EPOLLIN))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (closeCallback_)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">closeCallback_</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“è°ƒç”¨epoll_wait()åï¼Œå¯ä»¥å¾—çŸ¥äº‹ä»¶ç›‘å¬å™¨ä¸Šå“ªäº›Channelï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰å‘ç”Ÿäº†å“ªäº›äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿåè‡ªç„¶å°±è¦è°ƒç”¨è¿™äº›Channelå¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚</p></li><li><p>å°†è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å®é™…å‘ç”Ÿçš„äº‹ä»¶å°è£…è¿›è¿™ä¸ªChannelä¸­</p>  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">set_revents</span><span class="params">(<span class="type">int</span> revt)</span> </span>&#123;revents_ = revt;&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯åœ¨EPollPoller::fillActiveChannelsè°ƒç”¨ï¼Œå³è·å–æ´»è·ƒçš„è¿æ¥çš„æ—¶å€™è®¾ç½®ç»™Channelã€‚</p></li><li><p>å°†Channelä¸­çš„æ–‡ä»¶æè¿°ç¬¦åŠå…¶æ„Ÿå…´è¶£äº‹ä»¶æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ä¸Šæˆ–ä»äº‹ä»¶ç›‘å¬å™¨ä¸Šç§»é™¤</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®å®Œæˆåä¼šè·Ÿæ–°epollä¸­çš„fdä¸ºå½“å‰éœ€è¦ç›‘å¬[è®¾ç½®]çš„äº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">enableReading</span><span class="params">()</span> </span>&#123;events_ |= kReadEvent; <span class="built_in">upadte</span>();&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">disableReading</span><span class="params">()</span> </span>&#123;events_ &amp;= ~kReadEvent; <span class="built_in">update</span>();&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">enableWriting</span><span class="params">()</span> </span>&#123;events_ |= kWriteEvent; <span class="built_in">update</span>();&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">disableWriting</span><span class="params">()</span> </span>&#123;events_ &amp;= ~kWriteEvent; <span class="built_in">update</span>();&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">disableAll</span><span class="params">()</span> </span>&#123;events_ |= kNonEvent; <span class="built_in">update</span>();&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">void Channel::update()</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    // é€šè¿‡channelæ‰€å±çš„EventLoopï¼Œè°ƒç”¨pollerçš„ç›¸åº”æ–¹æ³•ï¼Œæ³¨å†Œfdçš„eventsäº‹ä»¶</span></span><br><span class="line"><span class="comment">    loop_-&gt;updateChannel(this);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªupdateçš„è°ƒç”¨è¿‡ç¨‹æ˜¯Channel=&gt;EventLoop=&gt;Pollerã€‚updateæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨äº†epoll_ctl()ã€‚</p></li></ul><h4 id="EpollPollerç±»">EpollPollerç±»</h4><blockquote><p><strong>æ¦‚è¿°</strong></p></blockquote><p>è´Ÿè´£ç›‘å¬æ–‡ä»¶æè¿°ç¬¦äº‹ä»¶æ˜¯å¦è§¦å‘ä»¥åŠè¿”å›å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ä»¥åŠå…·ä½“äº‹ä»¶çš„æ¨¡å—å°±æ˜¯Pollerã€‚ä¸€ä¸ªPollerå¯¹è±¡å¯¹åº”ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ã€‚å…¶ä¸­ï¼Œ1ä¸ªreactorä¸­æœ‰1ä¸ªPollerï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰å¤šå°‘reactorå°±æœ‰å¤šå°‘Pollerã€‚</p><p>ç›®å‰ï¼Œé¡¹ç›®ä¸­muduoåº“åªæ”¯æŒepollã€‚</p><p>Polleræ˜¯ä¸ªæŠ½è±¡è™šç±»ï¼Œç”±EpollPollerå’ŒPollPollerç»§æ‰¿å®ç°ï¼Œä¸ç›‘å¬æ–‡ä»¶æè¿°ç¬¦å’Œè¿”å›ç›‘å¬ç»“æœçš„å…·ä½“æ–¹æ³•ä¹ŸåŸºæœ¬ä¸Šæ˜¯åœ¨è¿™ä¸¤ä¸ªæ´¾ç”Ÿç±»ä¸­å®ç°ã€‚EpollPollerå°±æ˜¯å°è£…äº†ç”¨epollæ–¹æ³•å®ç°çš„ä¸äº‹ä»¶ç›‘å¬æœ‰å…³çš„å„ç§æ–¹æ³•ï¼ŒPollPollerå°±æ˜¯å°è£…äº†pollæ–¹æ³•å®ç°çš„ä¸äº‹ä»¶ç›‘å¬æœ‰å…³çš„å„ç§æ–¹æ³•ã€‚</p><blockquote><p><strong>æˆå‘˜å˜é‡</strong></p></blockquote><p>è¿™é‡Œå°†Poller/EpollPolleræˆå‘˜å˜é‡æ”¾åœ¨ä¸€èµ·ã€‚</p><ul><li>epollfd_ï¼šç”¨epoll_createæ–¹æ³•è¿”å›çš„epollå¥æŸ„ã€‚</li><li>channels_ï¼šè¿™ä¸ªå˜é‡æ˜¯std::unordered_map&lt;int, Channel*&gt;ç±»å‹ï¼Œè´Ÿè´£è®°å½• æ–‡ä»¶æè¿°ç¬¦ â€”&gt; Channelçš„æ˜ å°„ï¼Œä¹Ÿå¸®å¿™ä¿ç®¡æ‰€æœ‰æ³¨å†Œåœ¨è¿™ä¸ªPollerä¸Šçš„Channelã€‚</li><li>ownerLoop_ï¼šè¡¨ç¤ºå½“å‰epollfdåœ¨å“ªä¸ªloopã€‚</li></ul><blockquote><p><strong>æˆå‘˜å‡½æ•°</strong></p></blockquote><ul><li><p>è·å–ç›‘å¬å‘ç”Ÿäº‹ä»¶çš„æè¿°ç¬¦çš„Channelé›†åˆ</p><p>æ ¸å¿ƒæ˜¯ä»¥ä¸‹2ä¸ªå‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TimeStamp <span class="title">poll</span><span class="params">(<span class="type">int</span> timeoutMs, ChannelList *activeChannels)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fillActiveChannels</span><span class="params">(<span class="type">int</span> numEvents, ChannelList *activeChannels)</span></span></span><br></pre></td></tr></table></figure><p>å…·ä½“ä»£ç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Timestamp <span class="title">EPollPoller::poll</span><span class="params">(<span class="type">int</span> timeoutMs, ChannelList *activeChannels)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// events_æ¯æ¬¡ä¼ å…¥éƒ½æ˜¯åˆå§‹åŒ–è¿‡çš„ï¼Œä¹Ÿå°±è¯´é‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œç­‰å¾…epoll_waitè·å–æ•°æ®ã€‚</span></span><br><span class="line">    <span class="type">int</span> numEvents = ::<span class="built_in">epoll_wait</span>(epollfd_, &amp;*events_.<span class="built_in">begin</span>(), <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(events_.<span class="built_in">size</span>()), timeoutMs);</span><br><span class="line">    <span class="built_in">fillActiveChannels</span>(numEvents, activeChannels);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¡«å†™æ´»è·ƒçš„è¿æ¥</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EPollPoller::fillActiveChannels</span><span class="params">(<span class="type">int</span> numEvents, ChannelList *activeChannels)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; numEvents; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        Channel *channel = <span class="built_in">static_cast</span>&lt;Channel *&gt;(events_[i].data.ptr);</span><br><span class="line">        channel-&gt;<span class="built_in">set_revents</span>(events_[i].events);</span><br><span class="line">        activeChannels-&gt;<span class="built_in">push_back</span>(channel); <span class="comment">// EventLoopå°±æ‹¿åˆ°äº†å®ƒçš„pollerç»™å®ƒè¿”å›çš„æ‰€æœ‰å‘ç”Ÿäº‹ä»¶çš„channelåˆ—è¡¨äº†</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼šfillActiveChannelsä¸­éå†numEventsä¸ºä»€ä¹ˆå°±èƒ½å¾—åˆ°channelå¯¹è±¡ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºåœ¨å°†EPollPoller::updateä¸­ï¼ˆä¹Ÿå°±æ˜¯åœ¨å°†æ–‡ä»¶æè¿°ç¬¦äº¤ç»™epollç›‘å¬çš„æ—¶å€™ï¼Œå°†channelå¯¹è±¡ä¹Ÿæ”¾è¿›å»ä¾¿äºä¼ é€’æ–¹ä¾¿åæœŸä½¿ç”¨ï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> <span class="title class_">epoll_data</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *ptr;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="type">uint32_t</span> u32;</span><br><span class="line">  <span class="type">uint64_t</span> u64;</span><br><span class="line">&#125; <span class="type">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> events;<span class="comment">/* Epoll events */</span></span><br><span class="line">  <span class="type">epoll_data_t</span> data;<span class="comment">/* User data variable */</span></span><br><span class="line">&#125; __EPOLL_PACKED;</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ–°æ–‡ä»¶æè¿°ç¬¦ç›‘å¬çš„äº‹ä»¶</p>  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">updateChannel</span><span class="params">(Channel *channel)</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">removeChannel</span><span class="params">(Channel *channel)</span> <span class="keyword">override</span></span>;</span><br></pre></td></tr></table></figure>  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…³ç³»ï¼šchannel update remove =&gt; EventLoop updateChannel removeChannel =&gt; Poller updateChannel removeChannel</span></span><br><span class="line"><span class="comment">// update</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EPollPoller::updateChannel</span><span class="params">(Channel *channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> index = channel-&gt;<span class="built_in">index</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == kNew || index == kDeleted)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (index == kNew)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> fd = channel-&gt;<span class="built_in">fd</span>();</span><br><span class="line">            channels_[fd] = channel;</span><br><span class="line">        &#125;</span><br><span class="line">        channel-&gt;<span class="built_in">set_index</span>(kAdded);</span><br><span class="line">        <span class="built_in">update</span>(EPOLL_CTL_ADD, channel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// channelå·²ç»åœ¨pollerä¸Šæ³¨å†Œè¿‡äº†</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ›´æ–°channelé€šé“ epoll_ctl add/mod/del</span></span><br><span class="line"><span class="type">void</span> EPollPoller::<span class="built_in">update</span>(<span class="type">int</span> operation, Channel *channel)</span><br><span class="line">&#123;</span><br><span class="line">    epoll_event event;</span><br><span class="line">    <span class="built_in">bzero</span>(&amp;event, <span class="keyword">sizeof</span> event);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = channel-&gt;<span class="built_in">fd</span>();</span><br><span class="line"></span><br><span class="line">    event.events = channel-&gt;<span class="built_in">events</span>();</span><br><span class="line">    event.data.fd = fd;</span><br><span class="line">    event.data.ptr = channel;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">epoll_ctl</span>(epollfd_, operation, fd, &amp;event) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°çš„ä»£ç æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œè°ƒç”¨updateChannelå…¶ä¸­å†è°ƒç”¨updateã€‚æœ¬è´¨è¿˜æ˜¯è°ƒç”¨epoll_ctlï¼Œåªä¸è¿‡å±‚å±‚å°è£…é€‚åˆæ¡†æ¶ã€‚</p></li></ul><h4 id="EventLoopç±»">EventLoopç±»</h4><p>EventLoopç±»å°±æ˜¯å°†Channelç±»å’ŒEpollPollerç±»è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</p><p>EventLoopå°±æ˜¯è´Ÿè´£å®ç°**â€œå¾ªç¯â€<strong>ï¼Œè´Ÿè´£é©±åŠ¨</strong>â€œå¾ªç¯â€**çš„é‡è¦æ¨¡å—ã€‚</p><p>è¿™é‡Œå¾ªç¯ä¹Ÿå°±æ˜¯whileå¾ªç¯ä¸æ–­æ£€æµ‹æ˜¯å¦å­˜åœ¨ç›‘å¬äº‹ä»¶çš„å‘ç”Ÿï¼Œç„¶åä½¿ç”¨ä¼ å…¥çš„å›è°ƒå‡½æ•°å¤„ç†å¯¹åº”çš„äº‹ä»¶ã€‚</p><p>å¯ä»¥çœ‹ä¸‹ä¸‹é¢è¿™å¼ å›¾</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240502224744115.png" alt="image-20240502224744115"></p><ul><li><p>å¼€å¯äº‹ä»¶å¾ªç¯</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    looping_ = <span class="literal">true</span>;</span><br><span class="line">    quit_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!quit_)</span><br><span class="line">    &#123;</span><br><span class="line">        activeChannels_.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="comment">// ç›‘å¬ä¸¤ç±»fd   ä¸€ç§æ˜¯clientçš„fdï¼Œä¸€ç§wakeupfd</span></span><br><span class="line">        pollReturnTime_ = poller_-&gt;<span class="built_in">poll</span>(kPollTimeMs, &amp;activeChannels_);</span><br><span class="line">        <span class="keyword">for</span> (Channel *channel : activeChannels_)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Pollerç›‘å¬å“ªäº›channelå‘ç”Ÿäº‹ä»¶äº†ï¼Œç„¶åä¸ŠæŠ¥ç»™EventLoopï¼Œé€šçŸ¥channelå¤„ç†ç›¸åº”çš„äº‹ä»¶</span></span><br><span class="line">            channel-&gt;<span class="built_in">handleEvent</span>(pollReturnTime_);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œå½“å‰EventLoopäº‹ä»¶å¾ªç¯éœ€è¦å¤„ç†çš„å›è°ƒæ“ä½œ</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * IOçº¿ç¨‹ mainLoop accept fdã€Š=channel subloop</span></span><br><span class="line"><span class="comment">         * mainLoop äº‹å…ˆæ³¨å†Œä¸€ä¸ªå›è°ƒcbï¼ˆéœ€è¦subloopæ¥æ‰§è¡Œï¼‰    wakeup subloopåï¼Œæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•ï¼Œæ‰§è¡Œä¹‹å‰mainloopæ³¨å†Œçš„cbæ“ä½œ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">doPendingFunctors</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    looping_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//--------------------æ‰§è¡Œå›è°ƒ----------------------</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::doPendingFunctors</span><span class="params">()</span> <span class="comment">// æ‰§è¡Œå›è°ƒ</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;Functor&gt; functors;</span><br><span class="line">    callingPendingFunctors_ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        functors.<span class="built_in">swap</span>(pendingFunctors_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> Functor &amp;functor : functors)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">functor</span>(); <span class="comment">// æ‰§è¡Œå½“å‰loopéœ€è¦æ‰§è¡Œçš„å›è°ƒæ“ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    callingPendingFunctors_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ï¼Œåˆšå¼€å§‹çš„æ—¶å€™å¯¹åº”ä¸ºä»€ä¹ˆè¿˜ä¼šæ‰§è¡ŒdoPendingFunctorsæœ‰ç‚¹è¿·æƒ‘ï¼Ÿè¿™é‡Œç»™å‡ºæˆ‘çš„ç†è§£ï¼šç”¨äºloopä¹‹é—´é€šä¿¡ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šmainloopè¦å°†å®¢æˆ·ç«¯äº¤ç»™ä¸€ä¸ªloopå¤„ç†è¯·æ±‚ã€‚</p></li><li><p>å­loopå”¤é†’</p><p>æ¥ç€ä¸Šé¢çš„é—®é¢˜ï¼Œå½“ä¸»loopè¦å°†è¿æ¥çš„å®¢æˆ·ç«¯äº¤ç»™ä¸€ä¸ªsubloopå­loopç›‘å¬å¤„ç†ï¼Œä½†æ˜¯å­loopæ€ä¹ˆå”¤é†’å‘¢ï¼Ÿ</p><p>è¿™é‡Œmuduoåº“æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªwakeupæè¿°ç¬¦ï¼Œä¸“é—¨ç”¨äºå”¤é†’æè¿°ç¬¦ï¼ŒåŠ å…¥åˆ°epollä¸­ç›‘å¬ã€‚é‚£ä¹ˆå¯¹äºå”¤é†’å­loopçš„æ–¹æ³•åªç”¨å¾€wakeupå†™å…¥å³å¯ï¼Œå½“epollç›‘å¬åˆ°å†™äº‹ä»¶çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨wakeupä¹‹å‰è®¾ç½®çš„äº‹ä»¶å‘ç”Ÿå¤„ç†å‡½æ•°è¿›è¡Œå¤„ç†ï¼ˆä¹Ÿå°±å°†å†™äº‹ä»¶å†™å…¥çš„è¯»å‡ºæ¥ï¼‰ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::handleRead</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> one = <span class="number">1</span>;</span><br><span class="line">    <span class="type">ssize_t</span> n = <span class="built_in">read</span>(wakeupFd_, &amp;one, <span class="keyword">sizeof</span> one);</span><br><span class="line">    <span class="keyword">if</span> (n != <span class="keyword">sizeof</span> one)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;EventLoop::handleRead() reads %lu bytes instead of 8&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æ¥å”¤é†’loopæ‰€åœ¨çš„çº¿ç¨‹çš„  å‘wakeupfd_å†™ä¸€ä¸ªæ•°æ®ï¼ŒwakeupChannelå°±å‘ç”Ÿè¯»äº‹ä»¶ï¼Œå½“å‰loopçº¿ç¨‹å°±ä¼šè¢«å”¤é†’</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> one = <span class="number">1</span>;</span><br><span class="line">    <span class="type">ssize_t</span> n = <span class="built_in">write</span>(wakeupFd_, &amp;one, <span class="keyword">sizeof</span> one);</span><br><span class="line">    <span class="keyword">if</span> (n != <span class="keyword">sizeof</span> one)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;EventLoop::wakeup() writes %lu bytes instead of 8 \n&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å½“å¤šçº¿ç¨‹çš„æƒ…å†µå¦‚ä½•æ­£ç¡®è°ƒç”¨å‡½æ•°å‘¢ï¼Ÿ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::quit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    quit_ = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯åœ¨å…¶å®ƒçº¿ç¨‹ä¸­ï¼Œè°ƒç”¨çš„quit   åœ¨ä¸€ä¸ªsubloop(woker)ä¸­ï¼Œè°ƒç”¨äº†mainLoop(IO)çš„quit</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isInLoopThread</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">wakeup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åœ¨å½“å‰loopä¸­æ‰§è¡Œcb</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::runInLoop</span><span class="params">(Functor cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isInLoopThread</span>()) <span class="comment">// åœ¨å½“å‰çš„loopçº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œcb</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cb</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// åœ¨éå½“å‰loopçº¿ç¨‹ä¸­æ‰§è¡Œcb , å°±éœ€è¦å”¤é†’loopæ‰€åœ¨çº¿ç¨‹ï¼Œæ‰§è¡Œcb</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">queueInLoop</span>(cb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>ç®€å•æ¥è¯´ï¼Œ1.loopåœ¨è‡ªå·±çš„çº¿ç¨‹ä¸­è°ƒç”¨quit  2.åœ¨éloopçš„çº¿ç¨‹ä¸­ï¼Œè°ƒç”¨loopçš„quitã€‚</p><ul><li><p>å°æ³¨æ„ç‚¹Â·</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨å½“å‰loopä¸­æ‰§è¡Œcb</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::runInLoop</span><span class="params">(Functor cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isInLoopThread</span>()) <span class="comment">// åœ¨å½“å‰çš„loopçº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œcb</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cb</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// åœ¨éå½“å‰loopçº¿ç¨‹ä¸­æ‰§è¡Œcb , å°±éœ€è¦å”¤é†’loopæ‰€åœ¨çº¿ç¨‹ï¼Œæ‰§è¡Œcb</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">queueInLoop</span>(cb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æŠŠcbæ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œå”¤é†’loopæ‰€åœ¨çš„çº¿ç¨‹ï¼Œæ‰§è¡Œcb</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::queueInLoop</span><span class="params">(Functor cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        pendingFunctors_.<span class="built_in">emplace_back</span>(cb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å”¤é†’ç›¸åº”çš„ï¼Œéœ€è¦æ‰§è¡Œä¸Šé¢å›è°ƒæ“ä½œçš„loopçš„çº¿ç¨‹äº†</span></span><br><span class="line">    <span class="comment">// || callingPendingFunctors_çš„æ„æ€æ˜¯ï¼šå½“å‰loopæ­£åœ¨æ‰§è¡Œå›è°ƒï¼Œä½†æ˜¯loopåˆæœ‰äº†æ–°çš„å›è°ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isInLoopThread</span>() || callingPendingFunctors_)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">wakeup</span>(); <span class="comment">// å”¤é†’loopæ‰€åœ¨çº¿ç¨‹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å½“å‰çš„çº¿ç¨‹ç›´æ¥æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œä½†æ˜¯å¦‚æœä¸åœ¨çš„å°±éœ€è¦å”¤é†’ä¸‹ã€‚</p><p>è¿™é‡Œ2ä¸ªæ³¨æ„ç‚¹ï¼š</p><p>1.æ€ä¹ˆåˆ¤æ–­çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Ÿ</p><p>isInLoopThread() const { return threadId_ ==  CurrentThread::tid(); }</p><p>muduoåº“è®¾è®¡ä¸­ä½¿ç”¨äº†è¿™æ¡è¯­å¥åˆ¤æ–­ã€‚æˆ‘ä»¬åªè¦ä½¿ç”¨è¿™ä¸ªå‡½æ•°è¿›è¡Œåˆ¤æ–­ã€‚ã€è¿™ä¸ªæ·±å…¥çš„è¯æœ‰ç‚¹æŠ½è±¡ã€‘</p><p>2.(!isInLoopThread() || callingPendingFunctors_)</p><p>å¦‚æœä¸åœ¨å½“å‰çº¿ç¨‹ï¼Œå”¤é†’æ¯”è¾ƒå¥½ç†è§£ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µéœ€è¦å”¤é†’æ˜¯æ­£åœ¨æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå¦‚æœä¸å”¤é†’ï¼Œé‚£ä¹ˆè¿™ä¸ªå›è°ƒå‡½æ•°å°±ä¸çŸ¥é“è¦ä»€ä¹ˆæ—¶å€™æ‰èƒ½æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½ä¸æ‰§è¡Œã€‚å› æ­¤éœ€è¦å”¤é†’ä¸€ä¸‹ã€‚</p></li><li><p>å…¶ä»–</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EventLoopçš„æ–¹æ³• =ã€‹ Pollerçš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::updateChannel</span><span class="params">(Channel *channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    poller_-&gt;<span class="built_in">updateChannel</span>(channel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::removeChannel</span><span class="params">(Channel *channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    poller_-&gt;<span class="built_in">removeChannel</span>(channel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EventLoop::hasChannel</span><span class="params">(Channel *channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> poller_-&gt;<span class="built_in">hasChannel</span>(channel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç‚¹åœ¨Channelè°ƒç”¨è¿‡ç¨‹ä¸­å·²ç»è¯´æ˜ã€‚</p></li></ul><h3 id="çº¿ç¨‹æ¨¡å—">çº¿ç¨‹æ¨¡å—</h3><p>è¿™éƒ¨åˆ†ä½“ç°äº†One loop one threadçš„æ€æƒ³ï¼Œä¹Ÿæ˜¯muduoçš„æ ¸å¿ƒï¼</p><h4 id="Threadç±»">Threadç±»</h4><p>Threadç±»ä¸»è¦æ˜¯åˆ›å»ºçº¿ç¨‹ï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Thread</span> : noncopyable</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> ThreadFunc = std::function&lt;<span class="built_in">void</span>()&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Thread</span><span class="params">(ThreadFunc, <span class="type">const</span> std::string &amp;name = std::string())</span></span>;</span><br><span class="line">    ~<span class="built_in">Thread</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">join</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">started</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> started_; &#125;</span><br><span class="line">    <span class="function"><span class="type">pid_t</span> <span class="title">tid</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> tid_; &#125;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string &amp;<span class="title">name</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> name_; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">numCreated</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> numCreated_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setDefaultName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> started_;</span><br><span class="line">    <span class="type">bool</span> joined_;</span><br><span class="line">    std::shared_ptr&lt;std::thread&gt; thread_;</span><br><span class="line">    <span class="type">pid_t</span> tid_;</span><br><span class="line">    ThreadFunc func_;</span><br><span class="line">    std::string name_;</span><br><span class="line">    <span class="type">static</span> std::atomic_int numCreated_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="EventLoopThreadç±»">EventLoopThreadç±»</h4><p>è¿™ä¸ªç±»ä½“ç°äº†One loop one threadçš„æ€æƒ³ï¼Œå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£ä¸€ä¸ªloopå¾ªç¯ã€‚</p><p>è¿™ä¸ªç±»ä¸»è¦çš„å·¥ä½œæ˜¯å°†eventloopå’Œthreadå°è£…ï¼Œæ­£å¥½ä¸€ä¸ªloopä¸€ä¸ªçº¿ç¨‹ã€‚</p><blockquote><p><strong>æˆå‘˜å‡½æ•°</strong></p></blockquote><ul><li>EventLoop *loop_ï¼šå¯¹åº”çš„loopã€‚</li><li>_ bool exiting_ï¼šæ˜¯å¦é€€å‡ºã€‚</li><li>Thread thread_ï¼šçº¿ç¨‹ç±»ã€‚</li><li>std::mutex mutex_ï¼šäº’æ–¥é”ã€‚</li><li><em>std::condition_variable cond</em>ï¼šæ¡ä»¶å˜é‡ã€‚</li><li>ThreadInitCallback callback_ï¼šçº¿ç¨‹åˆå§‹åŒ–å›è°ƒå‡½æ•°ã€‚</li></ul><blockquote><p><strong>æˆå‘˜å‡½æ•°</strong></p></blockquote><ul><li>å¼€å¯loop</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EventLoop *<span class="title">EventLoopThread::startLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    thread_.<span class="built_in">start</span>(); <span class="comment">// å¯åŠ¨åº•å±‚çš„æ–°çº¿ç¨‹</span></span><br><span class="line"></span><br><span class="line">    EventLoop *loop = <span class="literal">nullptr</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        <span class="keyword">while</span> (loop_ == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cond_.<span class="built_in">wait</span>(lock);</span><br><span class="line">        &#125;</span><br><span class="line">        loop = loop_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> loop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼Œå®åœ¨å•ç‹¬çš„æ–°çº¿ç¨‹é‡Œé¢è¿è¡Œçš„</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoopThread::threadFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="comment">// åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„eventloopï¼Œå’Œä¸Šé¢çš„çº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œone loop per thread</span></span><br><span class="line">    EventLoop loop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callback_)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">callback_</span>(&amp;loop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        loop_ = &amp;loop;</span><br><span class="line">        cond_.<span class="built_in">notify_one</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    loop.<span class="built_in">loop</span>(); <span class="comment">// EventLoop loop  =&gt; Poller.poll</span></span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">    loop_ = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯åˆ›å»ºloopï¼Œç„¶åçº¿ç¨‹ä¸­ä¸æ–­çš„loopå¾ªç¯ã€‚</p><h4 id="EventLoopPoolThreadç±»">EventLoopPoolThreadç±»</h4><p>eventloopæ± ï¼Œä»æœ€å¼€å§‹çš„æ¶æ„å›¾å°±å¯ä»¥çŸ¥é“ï¼Œmuduoæœ‰ä¸»Loopå’Œè‹¥å¹²ä¸ªå­loopã€‚è¿™äº›loopå°±æ˜¯è¿™ä¸ªç±»äº§ç”Ÿçš„ã€‚</p><blockquote><p><strong>æˆå‘˜å˜é‡</strong></p></blockquote><ul><li>EventLoop *baseLoop_ï¼šè¿™æ˜¯ä¸»EventLoopï¼Œé€šå¸¸åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œã€‚</li><li><em>std::string name</em>ï¼š EventLoopThreadPoolçš„åç§°ã€‚</li><li>bool started _ ï¼šè¡¨ç¤ºEventLoopThreadPoolæ˜¯å¦å·²ç»å¯åŠ¨ã€‚</li><li>int numThreads _ ï¼š çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡ã€‚</li><li>int next _ ï¼š ä¸‹ä¸€ä¸ªè¦è¢«å¤„ç†çš„çº¿ç¨‹çš„ç´¢å¼•ã€‚</li><li>std::vector&lt; std::unique_ptr&lt; EventLoopThread&gt; &gt; threads_ï¼š å­˜å‚¨çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹çš„å®¹å™¨ï¼Œä½¿ç”¨unique_ptrç®¡ç†æ¯ä¸ªçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚</li><li>_std::vector&lt;EventLoop *&gt; loopsï¼š å­˜å‚¨æ‰€æœ‰EventLoopçš„æŒ‡é’ˆçš„å®¹å™¨ï¼Œç”¨äºåˆ†å‘ä»»åŠ¡ã€‚</li></ul><blockquote><p><strong>æˆå‘˜å‡½æ•°</strong></p></blockquote><ul><li><p>å¯åŠ¨çº¿ç¨‹æ± ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªEventLoopã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoopThreadPool::start</span><span class="params">(<span class="type">const</span> ThreadInitCallback &amp;cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    started_ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; numThreads_; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> buf[name_.<span class="built_in">size</span>() + <span class="number">32</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span> buf, <span class="string">&quot;%s%d&quot;</span>, name_.<span class="built_in">c_str</span>(), i);</span><br><span class="line">        EventLoopThread *t = <span class="keyword">new</span> <span class="built_in">EventLoopThread</span>(cb, buf);</span><br><span class="line">        threads_.<span class="built_in">push_back</span>(std::<span class="built_in">unique_ptr</span>&lt;EventLoopThread&gt;(t));</span><br><span class="line">        loops_.<span class="built_in">push_back</span>(t-&gt;<span class="built_in">startLoop</span>()); <span class="comment">// åº•å±‚åˆ›å»ºçº¿ç¨‹ï¼Œç»‘å®šä¸€ä¸ªæ–°çš„EventLoopï¼Œå¹¶è¿”å›è¯¥loopçš„åœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ•´ä¸ªæœåŠ¡ç«¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿è¡Œç€baseloop</span></span><br><span class="line">    <span class="keyword">if</span> (numThreads_ == <span class="number">0</span> &amp;&amp; cb)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cb</span>(baseLoop_);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¸»Loop_é»˜è®¤ä»¥è½®è¯¢çš„æ–¹å¼åˆ†é…channelç»™å­loopï¼Œé€šè¿‡è½®è¯¢æŒ‘é€‰å‡ºä¸€ä¸ªå­loop</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EventLoop* <span class="title">EventLoopThreadPool::getNextLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EventLoop *loop = baseLoop_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!loops_.<span class="built_in">empty</span>()) <span class="comment">// é€šè¿‡è½®è¯¢è·å–ä¸‹ä¸€ä¸ªå¤„ç†äº‹ä»¶çš„loop</span></span><br><span class="line">    &#123;</span><br><span class="line">        loop = loops_[next_];</span><br><span class="line">        ++next_;</span><br><span class="line">        <span class="keyword">if</span> (next_ &gt;= loops_.<span class="built_in">size</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            next_ = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç½‘ç»œæ¨¡å—">ç½‘ç»œæ¨¡å—</h3><h4 id="Acceptorç±»">Acceptorç±»</h4><blockquote><p><strong>æ¦‚è¿°</strong></p></blockquote><p>Accetporå°è£…äº†æœåŠ¡å™¨ä¸“é—¨ç”¨äºç›‘å¬æ˜¯å¦æœ‰å®¢æˆ·ç«¯è¿æ¥çš„å¥—æ¥å­—fdä»¥åŠç›¸å…³å¤„ç†æ–¹æ³•ã€‚ä¸»è¦æ˜¯å¯¹å…¶ä»–ç±»çš„æ–¹æ³•è°ƒç”¨è¿›è¡Œå°è£…ã€‚</p><blockquote><p><strong>æˆå‘˜å˜é‡</strong></p></blockquote><ul><li>acceptSocket_ï¼šè¿™ä¸ªæ˜¯æœåŠ¡å™¨ç›‘å¬å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li>acceptChannel_ï¼šè¿™æ˜¯ä¸ªChannelç±»ï¼ŒæŠŠacceptSocket _ åŠå…¶æ„Ÿå…´è¶£äº‹ä»¶å’Œäº‹ä»¶å¯¹åº”çš„å¤„ç†å‡½æ•°éƒ½å°è£…è¿›å»ã€‚</li><li>EventLoop *loopï¼šç›‘å¬å¥—æ¥å­—çš„fdç”±å“ªä¸ªEventLoopè´Ÿè´£å¾ªç¯ç›‘å¬ä»¥åŠå¤„ç†ç›¸åº”äº‹ä»¶ï¼Œå…¶å®è¿™ä¸ªEventLoopå°±æ˜¯main EventLoopã€‚</li><li>newConnectionCallback_: TcpServeræ„é€ å‡½æ•°ä¸­å°†TcpServer::newConnection( )å‡½æ•°æ³¨å†Œç»™äº†è¿™ä¸ªæˆå‘˜å˜é‡ã€‚è¿™ä¸ªTcpServer::newConnectionå‡½æ•°çš„åŠŸèƒ½æ˜¯å…¬å¹³çš„é€‰æ‹©ä¸€ä¸ªsubEventLoopï¼Œå¹¶æŠŠå·²ç»æ¥å—çš„è¿æ¥åˆ†å‘ç»™è¿™ä¸ªsubEventLoopã€‚</li></ul><blockquote><p><strong>æˆå‘˜å‡½æ•°</strong></p></blockquote><ul><li><p>å¼€å¯é“¾æ¥ç›‘å¬</p><p>listen( )ï¼šè¯¥å‡½æ•°åº•å±‚è°ƒç”¨äº†linuxçš„å‡½æ•°listen( )ï¼Œå¼€å¯å¯¹acceptSocket _ çš„ç›‘å¬åŒæ—¶å°†acceptChannelåŠå…¶æ„Ÿå…´è¶£äº‹ä»¶ï¼ˆå¯è¯»äº‹ä»¶ï¼‰æ³¨å†Œåˆ°main EventLoop çš„äº‹ä»¶ç›‘å¬å™¨ä¸Šã€‚æ¢è¨€ä¹‹å°±æ˜¯è®©main EventLoopäº‹ä»¶ç›‘å¬å™¨å»ç›‘å¬acceptSocket_ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Acceptor::listen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    listenning_ = <span class="literal">true</span>;</span><br><span class="line">    acceptSocket_.<span class="built_in">listen</span>(); <span class="comment">// listen</span></span><br><span class="line">    acceptChannel_.<span class="built_in">enableReading</span>(); <span class="comment">// acceptChannel_ =&gt; Poller</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¤„ç†æ–°ç”¨æˆ·è¿æ¥</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Acceptor::<span class="built_in">Acceptor</span>(EventLoop *loop, <span class="type">const</span> InetAddress &amp;listenAddr, <span class="type">bool</span> reuseport)</span><br><span class="line">    : <span class="built_in">loop_</span>(loop)</span><br><span class="line">    , <span class="built_in">acceptSocket_</span>(<span class="built_in">createNonblocking</span>()) <span class="comment">// socket</span></span><br><span class="line">    , <span class="built_in">acceptChannel_</span>(loop, acceptSocket_.<span class="built_in">fd</span>())</span><br><span class="line">    , <span class="built_in">listenning_</span>(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    acceptSocket_.<span class="built_in">setReuseAddr</span>(<span class="literal">true</span>);</span><br><span class="line">    acceptSocket_.<span class="built_in">setReusePort</span>(<span class="literal">true</span>);</span><br><span class="line">    acceptSocket_.<span class="built_in">bindAddress</span>(listenAddr); <span class="comment">// bind</span></span><br><span class="line">    <span class="comment">// TcpServer::start() Acceptor.listen  æœ‰æ–°ç”¨æˆ·çš„è¿æ¥ï¼Œè¦æ‰§è¡Œä¸€ä¸ªå›è°ƒï¼ˆconnfd=ã€‹channel=ã€‹subloopï¼‰</span></span><br><span class="line">    <span class="comment">// baseLoop =&gt; acceptChannel_(listenfd) =&gt; </span></span><br><span class="line">    acceptChannel_.<span class="built_in">setReadCallback</span>(std::<span class="built_in">bind</span>(&amp;Acceptor::handleRead, <span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// listenfdæœ‰äº‹ä»¶å‘ç”Ÿäº†ï¼Œå°±æ˜¯æœ‰æ–°ç”¨æˆ·è¿æ¥äº†</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Acceptor::handleRead</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    InetAddress peerAddr;</span><br><span class="line">    <span class="type">int</span> connfd = acceptSocket_.<span class="built_in">accept</span>(&amp;peerAddr);</span><br><span class="line">    <span class="keyword">if</span> (connfd &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (newConnectionCallback_)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">newConnectionCallback_</span>(connfd, peerAddr); <span class="comment">// è½®è¯¢æ‰¾åˆ°subLoopï¼Œå”¤é†’ï¼Œåˆ†å‘å½“å‰çš„æ–°å®¢æˆ·ç«¯çš„Channel</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ::<span class="built_in">close</span>(connfd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handleRead( )ï¼šè¿™æ˜¯ä¸€ä¸ªç§æœ‰æˆå‘˜æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¦æ³¨å†Œåˆ°acceptChannel_ ä¸Šçš„ï¼Œåœ¨æ„é€ acceptå¯¹è±¡çš„æ—¶å€™è®¾ç½®ç»™acceptchannelå¯¹è±¡ï¼Œ åŒæ—¶handleRead( )æ–¹æ³•å†…éƒ¨è¿˜è°ƒç”¨äº†æˆå‘˜å˜é‡newConnectionCallback_ä¿å­˜çš„å‡½æ•°ã€‚å½“main EventLoopç›‘å¬åˆ°acceptChannel _ ä¸Šå‘ç”Ÿäº†å¯è¯»äº‹ä»¶æ—¶ï¼ˆæ–°ç”¨æˆ·è¿æ¥äº‹ä»¶ï¼‰ï¼Œå°±æ˜¯è°ƒç”¨è¿™ä¸ªhandleRead( )æ–¹æ³•ã€‚</p></li></ul><h4 id="Bufferç±»">Bufferç±»</h4><blockquote><p><strong>æ¦‚è¿°</strong></p></blockquote><p>Bufferç±»å…¶å®æ˜¯å°è£…äº†ä¸€ä¸ªç”¨æˆ·ç¼“å†²åŒºï¼Œä»¥åŠå‘è¿™ä¸ªç¼“å†²åŒºå†™æ•°æ®è¯»æ•°æ®ç­‰ä¸€ç³»åˆ—æ§åˆ¶æ–¹æ³•ã€‚</p><blockquote><p><strong>ç®—æ³•</strong></p></blockquote><p>è¿™å¼ å›¾å·²ç»å¯ä»¥å¾ˆå¥½çš„è¯´æ˜è¿™ä¸ªç±»çš„å…·ä½“åŠŸèƒ½ã€‚</p><p>å¯ä»¥å’ŒCS144 TCPåè®®ä¸­çš„bufferè¿›è¡Œæ¯”å¯¹ä¸‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240502231632156.png" alt="image-20240502231632156"></p><blockquote><p><strong>æˆå‘˜æ–¹æ³•</strong></p></blockquote><ul><li>ssize_t Buffer::readFd(int fd, int* saveErrno);ï¼šå®¢æˆ·ç«¯å‘æ¥æ•°æ®ï¼ŒreadFdä»è¯¥TCPæ¥æ”¶ç¼“å†²åŒºä¸­å°†æ•°æ®è¯»å‡ºæ¥å¹¶æ”¾åˆ°Bufferä¸­ã€‚</li><li>ssize_t Buffer::writeFd(int fd, int* saveErrno);ï¼šæœåŠ¡ç«¯è¦å‘è¿™æ¡TCPè¿æ¥å‘é€æ•°æ®ï¼Œé€šè¿‡è¯¥æ–¹æ³•å°†Bufferä¸­çš„æ•°æ®æ‹·è´åˆ°TCPå‘é€ç¼“å†²åŒºä¸­ã€‚</li></ul><p>å·§å¦™çš„è®¾è®¡ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»fdä¸Šè¯»å–æ•°æ®  Pollerå·¥ä½œåœ¨LTæ¨¡å¼</span></span><br><span class="line"><span class="comment"> * Bufferç¼“å†²åŒºæ˜¯æœ‰å¤§å°çš„ï¼ ä½†æ˜¯ä»fdä¸Šè¯»æ•°æ®çš„æ—¶å€™ï¼Œå´ä¸çŸ¥é“tcpæ•°æ®æœ€ç»ˆçš„å¤§å°</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">Buffer::readFd</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span>* saveErrno)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> extrabuf[<span class="number">65536</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">// æ ˆä¸Šçš„å†…å­˜ç©ºé—´  64K</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">iovec</span> vec[<span class="number">2</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> writable = <span class="built_in">writableBytes</span>(); <span class="comment">// è¿™æ˜¯Bufferåº•å±‚ç¼“å†²åŒºå‰©ä½™çš„å¯å†™ç©ºé—´å¤§å°</span></span><br><span class="line">    vec[<span class="number">0</span>].iov_base = <span class="built_in">begin</span>() + writerIndex_;</span><br><span class="line">    vec[<span class="number">0</span>].iov_len = writable;</span><br><span class="line"></span><br><span class="line">    vec[<span class="number">1</span>].iov_base = extrabuf;</span><br><span class="line">    vec[<span class="number">1</span>].iov_len = <span class="keyword">sizeof</span> extrabuf;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> iovcnt = (writable &lt; <span class="keyword">sizeof</span> extrabuf) ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">ssize_t</span> n = ::<span class="built_in">readv</span>(fd, vec, iovcnt);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *saveErrno = errno;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt;= writable) <span class="comment">// Bufferçš„å¯å†™ç¼“å†²åŒºå·²ç»å¤Ÿå­˜å‚¨è¯»å‡ºæ¥çš„æ•°æ®äº†</span></span><br><span class="line">    &#123;</span><br><span class="line">        writerIndex_ += n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// extrabufé‡Œé¢ä¹Ÿå†™å…¥äº†æ•°æ® </span></span><br><span class="line">    &#123;</span><br><span class="line">        writerIndex_ = buffer_.<span class="built_in">size</span>();</span><br><span class="line">        <span class="built_in">append</span>(extrabuf, n - writable);  <span class="comment">// writerIndex_å¼€å§‹å†™ n - writableå¤§å°çš„æ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£é‡Šï¼šå¯ä»¥è®©ç”¨æˆ·ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰TCPæ¥æ”¶ç¼“å†²åŒºçš„æ‰€æœ‰æ•°æ®å…¨éƒ¨éƒ½è¯»å‡ºæ¥å¹¶æ”¾åˆ°ç”¨æˆ·è‡ªå®šä¹‰çš„ç¼“å†²åŒºBufferä¸­ã€‚ç”¨æˆ·è‡ªå®šä¹‰ç¼“å†²åŒºBufferæ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œæˆ‘ä»¬ä¸€å¼€å§‹ä¸çŸ¥é“TCPæ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®é‡æœ‰å¤šå°‘ï¼Œå¦‚æœä¸€æ¬¡æ€§è¯»å‡ºæ¥ä¼šä¸ä¼šå¯¼è‡´Bufferè£…ä¸ä¸‹è€Œæº¢å‡ºã€‚æ‰€ä»¥åœ¨readFd( )å‡½æ•°ä¸­ä¼šåœ¨æ ˆä¸Šåˆ›å»ºä¸€ä¸ªä¸´æ—¶ç©ºé—´extrabufï¼Œç„¶åä½¿ç”¨readvçš„åˆ†æ•£è¯»ç‰¹æ€§ï¼Œå°†TCPç¼“å†²åŒºä¸­çš„æ•°æ®å…ˆæ‹·è´åˆ°Bufferä¸­ï¼Œå¦‚æœBufferå®¹é‡ä¸å¤Ÿï¼Œå°±æŠŠå‰©ä½™çš„æ•°æ®éƒ½æ‹·è´åˆ°extrabufä¸­ï¼Œç„¶åå†è°ƒæ•´Bufferçš„å®¹é‡(åŠ¨æ€æ‰©å®¹)ï¼Œå†æŠŠextrabufçš„æ•°æ®æ‹·è´åˆ°Bufferä¸­ã€‚å½“è¿™ä¸ªå‡½æ•°ç»“æŸåï¼Œextrabufä¹Ÿä¼šè¢«é‡Šæ”¾ã€‚å¦å¤–extrabufæ˜¯åœ¨æ ˆä¸Šå¼€è¾Ÿçš„ç©ºé—´ï¼Œé€Ÿåº¦æ¯”åœ¨å †ä¸Šå¼€è¾Ÿè¿˜è¦å¿«ã€‚</p><h4 id="TcpConnection-TcpServerç±»">TcpConnection/TcpServerç±»</h4><p>è¿™ä¸ªç±»æ˜¯é›†å¤§æˆçš„ç±»ï¼Œéœ€è¦æ¸…æ¥šçš„çŸ¥é“å…·ä½“çš„å›è°ƒå‡½æ•°çš„è°ƒç”¨ã€‚</p><p>TCPç½‘ç»œç¼–ç¨‹çš„æœ¬è´¨æ˜¯å¤„ç†ä¸‹é¢è¿™å‡ ä¸ªäº‹ä»¶ï¼š</p><ul><li>è¿æ¥çš„å»ºç«‹ã€‚</li><li>è¿æ¥çš„æ–­å¼€ã€‚ï¼ˆåŒ…æ‹¬ä¸»åŠ¨æ–­å¼€å’Œè¢«åŠ¨æ–­å¼€ï¼‰</li><li>æ¶ˆæ¯åˆ°è¾¾ï¼Œå®¢æˆ·ç«¯è¿æ¥æ–‡ä»¶æè¿°ç¬¦å¯è¯»ã€‚</li><li>æ¶ˆæ¯å‘é€ï¼Œå‘å®¢æˆ·ç«¯è¿æ¥æ–‡ä»¶æè¿°ç¬¦å†™æ•°æ®ã€‚</li></ul><p>å…ˆæ¥çœ‹çœ‹æ•´ä½“çš„å›¾ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240503110725342.png" alt=""></p><h5 id="ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mymuduo/TcpServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mymuduo/Logger.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EchoServer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">EchoServer</span>(EventLoop *loop,</span><br><span class="line">            <span class="type">const</span> InetAddress &amp;addr, </span><br><span class="line">            <span class="type">const</span> std::string &amp;name)</span><br><span class="line">        : <span class="built_in">server_</span>(loop, addr, name)</span><br><span class="line">        , <span class="built_in">loop_</span>(loop)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æ³¨å†Œå›è°ƒå‡½æ•°</span></span><br><span class="line">        server_.<span class="built_in">setConnectionCallback</span>(</span><br><span class="line">            std::<span class="built_in">bind</span>(&amp;EchoServer::onConnection, <span class="keyword">this</span>, std::placeholders::_1)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        server_.<span class="built_in">setMessageCallback</span>(</span><br><span class="line">            std::<span class="built_in">bind</span>(&amp;EchoServer::onMessage, <span class="keyword">this</span>,</span><br><span class="line">                std::placeholders::_1, std::placeholders::_2, std::placeholders::_3)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®åˆé€‚çš„loopçº¿ç¨‹æ•°é‡ loopthread</span></span><br><span class="line">        server_.<span class="built_in">setThreadNum</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        server_.<span class="built_in">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// è¿æ¥å»ºç«‹æˆ–è€…æ–­å¼€çš„å›è°ƒ</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (conn-&gt;<span class="built_in">connected</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Connection UP : %s&quot;</span>, conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>().<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Connection DOWN : %s&quot;</span>, conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>().<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯è¯»å†™äº‹ä»¶å›è°ƒ</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                Buffer *buf,</span></span></span><br><span class="line"><span class="params"><span class="function">                Timestamp time)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::string msg = buf-&gt;<span class="built_in">retrieveAllAsString</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(msg);</span><br><span class="line">        conn-&gt;<span class="built_in">shutdown</span>(); <span class="comment">// å†™ç«¯   EPOLLHUP =ã€‹ closeCallback_</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EventLoop *loop_;</span><br><span class="line">    TcpServer server_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EventLoop loop;</span><br><span class="line">    <span class="function">InetAddress <span class="title">addr</span><span class="params">(<span class="number">8000</span>)</span></span>;</span><br><span class="line">    <span class="function">EchoServer <span class="title">server</span><span class="params">(&amp;loop, addr, <span class="string">&quot;EchoServer-01&quot;</span>)</span></span>; <span class="comment">// Acceptor non-blocking listenfd  create bind </span></span><br><span class="line">    server.<span class="built_in">start</span>(); <span class="comment">// listen  loopthread  listenfd =&gt; acceptChannel =&gt; mainLoop =&gt;</span></span><br><span class="line">    loop.<span class="built_in">loop</span>(); <span class="comment">// å¯åŠ¨mainLoopçš„åº•å±‚Poller</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Noteï¼šusing TcpConnectionPtr = std::shared_ptr&lt; TcpConnection &gt; ;</p><h5 id="è¿æ¥å»ºç«‹">è¿æ¥å»ºç«‹</h5><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240503105422549.png" alt="image-20240503105422549"></p><p>å¤§ä½“çš„æ•´ä¸ªæµç¨‹å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><ul><li><p>TcpServer::TcpServer()<br>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªTcpServerå¯¹è±¡ï¼Œå³æ‰§è¡Œä»£ç TcpServer server(&amp;loop, listenAddr);è°ƒç”¨äº†TcpServerçš„æ„é€ å‡½æ•°ï¼ŒTcpServeræ„é€ å‡½æ•°æœ€ä¸»è¦çš„å°±æ˜¯ç±»çš„å†…éƒ¨å®ä¾‹åŒ–äº†ä¸€ä¸ªAcceptorå¯¹è±¡ï¼Œå¹¶å¾€è¿™ä¸ªAcceptorå¯¹è±¡æ³¨å†Œäº†ä¸€ä¸ªå›è°ƒå‡½æ•°TcpServer::newConnection()ã€‚</p></li><li><p>Acceptor::Acceptor()<br>å½“æˆ‘ä»¬åœ¨TcpServeræ„é€ å‡½æ•°å®ä¾‹åŒ–Acceptorå¯¹è±¡æ—¶ï¼ŒAcceptorçš„æ„é€ å‡½æ•°ä¸­å®ä¾‹åŒ–äº†ä¸€ä¸ªChannelå¯¹è±¡ï¼Œå³acceptChannel _ ï¼Œè¯¥Channelå¯¹è±¡å°è£…äº†æœåŠ¡å™¨ç›‘å¬å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼ˆå°šæœªæ³¨å†Œåˆ°main EventLoopçš„äº‹ä»¶ç›‘å¬å™¨ä¸Šï¼‰ã€‚æ¥ç€Acceptoræ„é€ å‡½æ•°å°†Acceptor::handleRead()æ–¹æ³•æ³¨å†Œè¿›acceptChannel_ ä¸­ï¼Œè¿™ä¹Ÿæ„å‘³ç€ï¼Œæ—¥åå¦‚æœäº‹ä»¶ç›‘å¬å™¨ç›‘å¬åˆ°acceptChannel_å‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œå°†ä¼šè°ƒç”¨Acceptor::handleRead()å‡½æ•°ã€‚</p><p>è‡³æ­¤ï¼ŒTcpServerå¯¹è±¡åˆ›å»ºå®Œæ¯•ï¼Œç”¨æˆ·è°ƒç”¨TcpServer::start()æ–¹æ³•ï¼Œå¼€å¯TcpServerã€‚ä¸»è¦å°±æ˜¯è°ƒç”¨Acceptor::listen()å‡½æ•°ï¼ˆåº•å±‚æ˜¯è°ƒç”¨äº†linuxçš„å‡½æ•°listen()ï¼‰ç›‘å¬æœåŠ¡å™¨å¥—æ¥å­—ï¼Œä»¥åŠå°†acceptChannel_æ³¨å†Œåˆ°main EventLoopçš„äº‹ä»¶ç›‘å¬å™¨ä¸Šç›‘å¬å®ƒçš„å¯è¯»äº‹ä»¶ï¼ˆæ–°ç”¨æˆ·è¿æ¥äº‹ä»¶ï¼‰æ¥ç€ç”¨æˆ·è°ƒç”¨loop.loop()ï¼Œå³è°ƒç”¨äº†EventLoop::loop()å‡½æ•°ï¼Œè¯¥å‡½æ•°å°±ä¼šå¾ªç¯çš„è·å–äº‹ä»¶ç›‘å¬å™¨çš„ç›‘å¬ç»“æœï¼Œå¹¶ä¸”æ ¹æ®ç›‘å¬ç»“æœè°ƒç”¨æ³¨å†Œåœ¨äº‹ä»¶ç›‘å¬å™¨ä¸Šçš„Channelå¯¹è±¡çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚</p></li><li><p>Acceptor::handleRead()<br>å½“ç¨‹åºå¦‚æœæ‰§è¡Œåˆ°äº†è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œè¯´æ˜acceptChannel_ å‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œç¨‹åºå¤„ç†æ–°å®¢æˆ·è¿æ¥è¯·æ±‚ã€‚è¯¥å‡½æ•°é¦–å…ˆè°ƒç”¨äº†Linuxçš„å‡½æ•°accept()æ¥å—æ–°å®¢æˆ·è¿æ¥ã€‚æ¥ç€è°ƒç”¨äº†TcpServer::newConnection()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯åœ¨æ­¥éª¤1ä¸­æ³¨å†Œç»™Acceptorå¹¶ç”±æˆå‘˜å˜é‡newConnectionCallback_ä¿å­˜ã€‚</p></li><li><p>TcpServer::newConnection()<br>è¯¥å‡½æ•°çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯å°†å»ºç«‹å¥½çš„è¿æ¥è¿›è¡Œå°è£…ï¼ˆå°è£…æˆTcpConnectionå¯¹è±¡ï¼‰ï¼Œå¹¶ä½¿ç”¨é€‰æ‹©ç®—æ³•å…¬å¹³çš„é€‰æ‹©ä¸€ä¸ªsub EventLoopï¼Œå¹¶è°ƒç”¨TcpConnection::connectEstablished()å°†TcpConnection::channel_æ³¨å†Œåˆ°åˆšåˆšé€‰æ‹©çš„sub EventLoopä¸Šã€‚</p></li></ul><h5 id="æ¶ˆæ¯å¤„ç†">æ¶ˆæ¯å¤„ç†</h5><p>SubEventLoopä¸­çš„EventLoop::loop()å‡½æ•°å†…éƒ¨ä¼š<strong>å¾ªç¯çš„æ‰§è¡Œ</strong>ä¸Šå›¾ä¸­çš„æ­¥éª¤1å’Œæ­¥éª¤2ã€‚æ­¥éª¤1å°±æ˜¯è°ƒç”¨Poller::poll()æ–¹æ³•è·å–äº‹ä»¶ç›‘å¬ç»“æœï¼Œè¿™ä¸ªäº‹ä»¶ç›‘å¬ç»“æœæ˜¯ä¸€ä¸ªChannelé›†åˆï¼Œæ¯ä¸€ä¸ªChannelå°è£…ç€ [ä¸€ä¸ªfd] åŠ [fdæ„Ÿå…´è¶£çš„äº‹ä»¶] å’Œ [äº‹ä»¶ç›‘å¬å™¨ç›‘å¬åˆ°è¯¥fdå®é™…å‘ç”Ÿçš„äº‹ä»¶]ã€‚æ­¥éª¤2å°±æ˜¯è°ƒç”¨æ¯ä¸€ä¸ªChannelçš„Channel::HandlerEventæ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šæ ¹æ®æ¯ä¸€ä¸ªChannelçš„æ„Ÿå…´è¶£äº‹ä»¶ä»¥åŠå®é™…å‘ç”Ÿçš„äº‹ä»¶è°ƒç”¨æå‰æ³¨å†Œåœ¨Channelå†…çš„å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼ˆreadCallback_ã€writeCallback_ã€closeCallback_ã€errorCallback _  )ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240503105957775.png" alt="image-20240503105957775"></p><blockquote><p><strong>æ¶ˆæ¯è¯»å–</strong></p></blockquote><p>readCallback_ä¿å­˜çš„å‡½æ•°å…¶å®æ˜¯TcpConnection::handleRead( )ï¼Œ<strong>æ¶ˆæ¯è¯»å–çš„å¤„ç†é€»è¾‘ä¹Ÿå°±æ˜¯ç”±è¿™ä¸ªå‡½æ•°æä¾›çš„</strong>ï¼Œæˆ‘ä»¬ç¨å¾®å‰–æä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> savedErrno = <span class="number">0</span>; </span><br><span class="line">    <span class="type">ssize_t</span> n = inputBuffer_.<span class="built_in">readFd</span>(channel_-&gt;<span class="built_in">fd</span>(), &amp;savedErrno);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; <span class="number">0</span>) <span class="comment">//ä»fdè¯»åˆ°äº†æ•°æ®ï¼Œå¹¶ä¸”æ”¾åœ¨äº†inputBuffer_ä¸Š</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">messageCallback_</span>(<span class="built_in">shared_from_this</span>(), &amp;inputBuffer_, receiveTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(n == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">handleClose</span>();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        errno = savedErrno;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;TcpConnection::handleRead&quot;</span>);</span><br><span class="line">        <span class="built_in">handleError</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TcpConnection::handleRead( )å‡½æ•°é¦–å…ˆè°ƒç”¨Buffer_.readFd(channel_-&gt;fd(), &amp;saveErrno)ï¼Œè¯¥å‡½æ•°åº•å±‚è°ƒç”¨Linuxçš„å‡½æ•°readv( )ï¼Œå°†Tcpæ¥æ”¶ç¼“å†²åŒºæ•°æ®æ‹·è´åˆ°ç”¨æˆ·å®šä¹‰çš„ç¼“å†²åŒºä¸­ï¼ˆinputBuffer_ï¼‰ã€‚å¦‚æœåœ¨è¯»å–æ‹·è´çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆé”™è¯¯ï¼Œè¿™ä¸ªé”™è¯¯ä¿¡æ¯å°±ä¼šä¿å­˜åœ¨savedErrnoä¸­ã€‚</p><ul><li>å½“readFd( )è¿”å›å€¼å¤§äº0ï¼Œè¯´æ˜ä»æ¥æ”¶ç¼“å†²åŒºä¸­è¯»å–åˆ°äº†æ•°æ®ï¼Œé‚£ä¹ˆä¼šæ¥ç€è°ƒç”¨messageCallback_ä¸­ä¿å­˜çš„ç”¨æˆ·è‡ªå®šä¹‰çš„è¯»å–æ¶ˆæ¯åçš„å¤„ç†å‡½æ•°ã€‚</li><li>readFd( )è¿”å›å€¼ç­‰äº0ï¼Œè¯´æ˜å®¢æˆ·ç«¯è¿æ¥å…³é—­ï¼Œè¿™æ—¶å€™åº”è¯¥è°ƒç”¨TcpConnection::handleClose( )æ¥å¤„ç†è¿æ¥å…³é—­äº‹ä»¶</li><li>readFd( )è¿”å›å€¼ç­‰äº-1ï¼Œè¯´æ˜å‘ç”Ÿäº†é”™è¯¯ï¼Œè°ƒç”¨TcpConnection::handleError( )æ¥å¤„ç†savedErrnoçš„é”™è¯¯äº‹ä»¶ã€‚Moduoåº“åªæ”¯æŒLTæ¨¡å¼ï¼Œæ‰€ä»¥è¯»äº‹ä»¶ä¸ä¼šå‡ºç°EAGAINçš„é”™è¯¯ï¼Œæ‰€ä»¥ä¸€æ—¦å‡ºç°é”™è¯¯ï¼Œè¯´æ˜è‚¯å®šæ˜¯æ¯”è¾ƒä¸å¥½çš„éæ­£å¸¸é”™è¯¯äº†ã€‚è€ŒEAGAINé”™è¯¯åªä¸è¿‡æ˜¯éé˜»å¡IOè°ƒç”¨æ—¶çš„ä¸€ç§å¸¸è§é”™è¯¯è€Œå·²ã€‚</li></ul><blockquote><p><strong>æ¶ˆæ¯å‘é€</strong></p></blockquote><p>å½“ç”¨æˆ·è°ƒç”¨äº†TcpConnetion::send(buf)å‡½æ•°æ—¶ï¼Œç›¸å½“äºè¦æ±‚muduoåº“æŠŠæ•°æ®bufå‘é€ç»™è¯¥Tcpè¿æ¥çš„å®¢æˆ·ç«¯ã€‚æ­¤æ—¶è¯¥TcpConnectionæ³¨å†Œåœ¨äº‹ä»¶ç›‘å¬å™¨ä¸Šçš„æ„Ÿå…´è¶£äº‹ä»¶ä¸­æ˜¯æ²¡æœ‰å¯å†™äº‹ä»¶çš„ã€‚TcpConnection::send(buf)å‡½æ•°å†…éƒ¨å…¶å®æ˜¯è°ƒç”¨äº†Linuxçš„å‡½æ•°write( )</p><p>å¦‚æœTCPå‘é€ç¼“å†²åŒºå†…ä¸èƒ½ä¸€æ¬¡æ€§å®¹çº³bufï¼š</p><ul><li>è¿™æ—¶å€™write( )å‡½æ•°bufæ•°æ®å°½å¯èƒ½åœ°æ‹·è´åˆ°TCPå‘é€ç¼“å†²åŒºä¸­ï¼Œå¹¶ä¸”å°†errnoè®¾ç½®ä¸ºEWOULDBLOCKã€‚</li><li>å‰©ä½™æœªæ‹·è´åˆ°TCPå‘é€ç¼“å†²åŒºä¸­çš„bufæ•°æ®ä¼šè¢«å­˜æ”¾åœ¨TcpConnection::outputBuffer_ä¸­ã€‚å¹¶ä¸”å‘äº‹ä»¶ç›‘å¬å™¨ä¸Šæ³¨å†Œè¯¥TcpConnection::channel_çš„å¯å†™äº‹ä»¶ã€‚</li><li>äº‹ä»¶ç›‘å¬å™¨ç›‘å¬åˆ°è¯¥Tcpè¿æ¥å¯å†™äº‹ä»¶ï¼Œå°±ä¼šè°ƒç”¨TcpConnection::handleWrite( )å‡½æ•°æŠŠTcpConnection::outputBuffer_ä¸­å‰©ä½™çš„æ•°æ®å‘é€å‡ºå»ã€‚_<ul><li>åœ¨TcpConnection::handleWrite( )å‡½æ•°ä¸­ï¼Œé€šè¿‡è°ƒç”¨Buffer::writeFd()å‡½æ•°å°†outputBuffer_çš„æ•°æ®å†™å…¥åˆ°Tcpå‘é€ç¼“å†²åŒºï¼Œå¦‚æœTcpå‘é€ç¼“å†²åŒºèƒ½å®¹çº³å…¨éƒ¨å‰©ä½™çš„æœªå‘é€æ•°æ®ï¼Œé‚£æœ€å¥½ä¸è¿‡äº†ã€‚å¦‚æœTcpå‘é€ç¼“å†²åŒºä¾æ—§æ²¡æ³•å®¹çº³å‰©ä½™çš„æœªå‘é€æ•°æ®ï¼Œé‚£å°±å°½å¯èƒ½åœ°å°†æ•°æ®æ‹·è´åˆ°Tcpå‘é€ç¼“å†²åŒºä¸­ï¼Œç»§ç»­ä¿æŒå¯å†™äº‹ä»¶çš„ç›‘å¬ã€‚</li></ul></li><li>å½“æ•°æ®å…¨éƒ¨æ‹·è´åˆ°Tcpå‘é€ç¼“å†²åŒºä¹‹åï¼Œå°±ä¼šè°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„ã€å†™å®Œåçš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‘ï¼Œå¹¶ä¸”ç§»é™¤è¯¥TcpConnectionåœ¨äº‹ä»¶ç›‘å¬å™¨ä¸Šçš„å¯å†™äº‹ä»¶ã€‚ï¼ˆç§»é™¤å¯å†™äº‹ä»¶æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ï¼Œä¸ä¼šè®©epoll_wait() æ¯«æ— æ„ä¹‰çš„é¢‘ç¹è§¦å‘å¯å†™äº‹ä»¶ã€‚å› ä¸ºå¤§å¤šæ•°æ—¶å€™æ˜¯æ²¡æœ‰æ•°æ®éœ€è¦å‘é€çš„ï¼Œé¢‘ç¹è§¦å‘å¯å†™äº‹ä»¶ä½†åˆæ²¡æœ‰æ•°æ®å¯å†™ã€‚ï¼‰</li></ul><p><strong>TcpConnection::sendå’ŒTcpConnection::handleWriteçš„åŒºåˆ«ï¼š</strong></p><ul><li>sendInLoop çš„ç›®çš„æ˜¯å°è¯•ç«‹å³å°†æ•°æ®å†™å…¥å†…æ ¸ç©ºé—´ã€‚å¦‚æœä¸€æ¬¡å°±èƒ½å†™å®Œï¼Œé‚£ä¹ˆå°±æ²¡é—®é¢˜ã€‚ä½†å¦‚æœå†™å…¥æ“ä½œè¢«é˜»å¡ï¼Œæˆ–è€…åªå†™å…¥äº†éƒ¨åˆ†æ•°æ®ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„æ•°æ®å°±ä¼šè¢«æ”¾åˆ° outputBuffer_ ä¸­ï¼Œç„¶åé€šè¿‡æ³¨å†Œå†™äº‹ä»¶ enableWriting()ï¼Œåœ¨æœ‰ç©ºé—´å¯å†™çš„æ—¶å€™ï¼Œå†ç»§ç»­å†™å…¥å‰©ä¸‹çš„æ•°æ®ã€‚è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨é€šå¸¸æ˜¯åœ¨åº”ç”¨ç¨‹åºæƒ³è¦å‘é€æ•°æ®çš„æ—¶å€™ã€‚</li><li>handleWrite åˆ™æ˜¯åœ¨å†…æ ¸é€šçŸ¥åº”ç”¨ç¨‹åºå¯ä»¥å†™å…¥æ•°æ®çš„æ—¶å€™è°ƒç”¨çš„ï¼Œå³å½“å¥—æ¥å­—çš„å‘é€ç¼“å†²åŒºæœ‰è¶³å¤Ÿçš„ç©ºé—´å¯ä»¥æ¥æ”¶æ›´å¤šæ•°æ®æ—¶ã€‚è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯å°½å¯èƒ½åœ°å°† outputBuffer_ ä¸­çš„æ•°æ®å†™å…¥åˆ°å†…æ ¸ç©ºé—´ï¼Œç›´åˆ°å†™å…¥å…¨éƒ¨æ•°æ®æˆ–è€…å†…æ ¸ç©ºé—´æ— æ³•æ¥æ”¶æ›´å¤šæ•°æ®ä¸ºæ­¢ã€‚ç„¶åï¼Œå¦‚æœ outputBuffer_ ä¸­çš„æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œé‚£ä¹ˆå°±å–æ¶ˆå¯¹å†™äº‹ä»¶çš„å…³æ³¨ disableWriting()ï¼Œå› ä¸ºæ­¤æ—¶ä¸éœ€è¦å†å†™æ•°æ®äº†ã€‚</li><li>æ€»çš„æ¥è¯´ï¼ŒsendInLoop æ˜¯åº”ç”¨ç¨‹åºä¸»åŠ¨å‘é€æ•°æ®ï¼ŒhandleWrite æ˜¯åœ¨æ”¶åˆ°å†…æ ¸çš„å¯å†™é€šçŸ¥åå°è¯•å†™å…¥æ•°æ®ã€‚è¿™ä¸¤ä¸ªå‡½æ•°å…±åŒå®ç°äº†æ•°æ®çš„å¼‚æ­¥å†™å…¥ï¼šsendInLoop è´Ÿè´£å°†åº”ç”¨ç¨‹åºçš„æ•°æ®æ”¾å…¥ outputBuffer_ ï¼Œå¹¶å°è¯•å†™å…¥å†…æ ¸ï¼›handleWrite è´Ÿè´£åœ¨å†…æ ¸å‡†å¤‡å¥½æ¥æ”¶æ•°æ®æ—¶ï¼Œå°† outputBuffer_ ä¸­çš„æ•°æ®å†™å…¥å†…æ ¸ã€‚</li></ul><p>åœ¨é˜…è¯»æºç çš„æ—¶å€™ï¼Œæœ‰ä¸ªç–‘é—®ï¼Ÿä¹Ÿå°±æ˜¯ä¹‹å‰åœ¨å­¦ä¹ bufferè®¾è®¡çš„æ—¶å€™ï¼Œbufferæ—¢æ”¯æŒå†™ä¹Ÿæ”¯æŒè¯»ï¼Œè€Œä¸”ç¼“å†²åŒºçš„è®¾è®¡å°±æœ‰readerIndex_ å’ŒwriterIndex_ï¼Œé‚£ä¸ºä»€ä¹ˆä¹‹åTcpConnnectionä¸­åˆæ”¾2ä¸ªç¼“å†²åŒºbufferå‘¢ï¼Ÿ</p><p>GPTå›ç­”ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åœ¨muduoç½‘ç»œåº“ä¸­ï¼Œæ¥æ”¶æ•°æ®çš„ç¼“å†²åŒºinputBuffer_å’Œå‘é€æ•°æ®çš„ç¼“å†²åŒºoutputBuffer_ éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œæ¥æ”¶å’Œå‘é€æ•°æ®çš„æ“ä½œé€šå¸¸æ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬å¯ä»¥åœ¨ä¸åŒçš„æ—¶é—´ã€ä»¥ä¸åŒçš„é€Ÿåº¦å‘ç”Ÿï¼Œå› æ­¤ï¼Œå®ƒä»¬éœ€è¦å„è‡ªçš„ç¼“å†²åŒºæ¥ç»´æŠ¤å®ƒä»¬çš„çŠ¶æ€ã€‚</span><br><span class="line"></span><br><span class="line">å…·ä½“æ¥è¯´ï¼ŒinputBuffer_è¢«ç”¨æ¥å­˜å‚¨ä»ç½‘ç»œä¸­æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œç›´åˆ°åº”ç”¨ç¨‹åºå‡†å¤‡å¥½å¤„ç†è¿™äº›æ•°æ®ä¸ºæ­¢ã€‚åŒæ ·ï¼ŒoutputBuffer_ è¢«ç”¨æ¥å­˜å‚¨åº”ç”¨ç¨‹åºå‡†å¤‡å‘é€åˆ°ç½‘ç»œä¸­çš„æ•°æ®ï¼Œç›´åˆ°è¿™äº›æ•°æ®è¢«å®é™…å‘é€ä¸ºæ­¢ã€‚</span><br><span class="line"></span><br><span class="line">è™½ç„¶ä½ æåˆ°çš„ä¸€ä¸ªç¼“å†²åŒºå¯ä»¥å¤„ç†è¯»å†™æ“ä½œï¼Œä½†è¿™åªé€‚ç”¨äºå•ä¸€çš„è¯»å†™æ“ä½œã€‚åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œæ¥æ”¶å’Œå‘é€æ•°æ®çš„æ“ä½œæ˜¯åˆ†ç¦»çš„ï¼Œå¹¶ä¸”ç»å¸¸éœ€è¦åœ¨ä¸åŒçš„æ—¶é—´è¿›è¡Œã€‚å› æ­¤ï¼Œä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„ç¼“å†²åŒºå¯ä»¥ä½¿å¾—æ¥æ”¶å’Œå‘é€æ•°æ®çš„æ“ä½œæ›´åŠ çµæ´»å’Œé«˜æ•ˆã€‚</span><br></pre></td></tr></table></figure><h5 id="è¿æ¥æ–­å¼€">è¿æ¥æ–­å¼€</h5><blockquote><p><strong>è¿æ¥è¢«åŠ¨æ–­å¼€</strong></p></blockquote><p>æœåŠ¡ç«¯TcpConnection::handleRead()ä¸­æ„ŸçŸ¥åˆ°å®¢æˆ·ç«¯æŠŠè¿æ¥æ–­å¼€äº†ã€‚<br>TcpConnection::handleRead( )å‡½æ•°å†…éƒ¨è°ƒç”¨äº†Linuxçš„å‡½æ•°readv( )ï¼Œå½“readv( )è¿”å›0çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯å°±çŸ¥é“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥äº†ã€‚ç„¶åå°±æ¥ç€è°ƒç”¨TcpConnection::handleClose( )ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240503111746345.png" alt="image-20240503111746345"></p><ol><li>åœ¨æ‰§è¡ŒTcpConnection::handle_Close()çš„æ—¶å€™ï¼Œè¯¥å‡½æ•°è¿˜æ˜¯åœ¨SubEventLoopçº¿ç¨‹ä¸­è¿è¡Œçš„ï¼Œæ¥ç€è°ƒç”¨closeCallback_(connPtr)å›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¿å­˜çš„å…¶å®æ˜¯TcpServer::removeConnection( )å‡½æ•°</li><li>TcpServer::removeConnection( )å‡½æ•°è°ƒç”¨äº†remvoveConnectionInLoop( )å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„è¿è¡Œæ˜¯åœ¨MainEventLoopçº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè¿™é‡Œæ¶‰åŠåˆ°çº¿ç¨‹åˆ‡æ¢æŠ€æœ¯ã€‚</li><li>removeConnectionInLoop( )å‡½æ•°ï¼šTcpServerå¯¹è±¡ä¸­æœ‰ä¸€ä¸ªconnections_ æˆå‘˜å˜é‡ï¼Œè¿™æ˜¯ä¸€ä¸ªunordered_mapï¼Œè´Ÿè´£ä¿å­˜ã€string --&gt; TcpConnectionã€‘çš„æ˜ å°„ï¼Œå…¶å®å°±æ˜¯ä¿å­˜ç€Tcpè¿æ¥çš„åå­—åˆ°TcpConnectionå¯¹è±¡çš„æ˜ å°„ã€‚å› ä¸ºè¿™ä¸ªTcpè¿æ¥è¦å…³é—­äº†ï¼Œæ‰€ä»¥ä¹Ÿè¦æŠŠè¿™ä¸ªTcpConnectionå¯¹è±¡ä»connections_ä¸­åˆ æ‰ã€‚ç„¶åå†è°ƒç”¨TcpConnection::connectDestroyedå‡½æ•°ã€‚<br>å¦å¤–ä¸ºä»€ä¹ˆremoveConnectionInLoop()è¦åœ¨MainEventLoopä¸­è¿è¡Œï¼Œå› ä¸ºè¯¥å‡½æ•°ä¸»è¦æ˜¯ä»TcpServerå¯¹è±¡ä¸­åˆ é™¤æŸæ¡æ•°æ®ã€‚è€ŒTcpServerå¯¹è±¡æ˜¯å±äºMainEventLoopçš„ã€‚è¿™ä¹Ÿæ˜¯è´¯å½»äº†One Loop Per Threadçš„ç†å¿µã€‚</li><li>TcpConnection::connectDestroyed( )å‡½æ•°çš„æ‰§è¡Œæ˜¯åˆè·³å›åˆ°äº†subEventLoopçº¿ç¨‹ä¸­ã€‚è¯¥å‡½æ•°å°±æ˜¯å°†Tcpè¿æ¥çš„ç›‘å¬æè¿°ç¬¦ä»äº‹ä»¶ç›‘å¬å™¨ä¸­ç§»é™¤ã€‚å¦å¤–SubEventLoopä¸­çš„Pollerç±»å¯¹è±¡è¿˜ä¿å­˜ç€è¿™æ¡Tcpè¿æ¥çš„channel_ï¼Œæ‰€ä»¥è°ƒç”¨channel_.remove( )å°†è¿™ä¸ªTcpè¿æ¥çš„channelå¯¹è±¡ä»Pollerå†…çš„æ•°æ®ç»“æ„ä¸­åˆ é™¤ã€‚</li></ol><blockquote><p><strong>è¿æ¥ä¸»åŠ¨æ–­å¼€</strong></p></blockquote><p>æœåŠ¡å™¨ä¸»åŠ¨å…³é—­å¯¼è‡´è¿æ¥æ–­å¼€ã€‚å½“æœåŠ¡å™¨ä¸»åŠ¨å…³é—­æ—¶ï¼Œè°ƒç”¨TcpServer::~TcpServer()ææ„å‡½æ•°ã€‚</p><p>è¿™é‡Œåœ¨æç¤ºä¸€ä¸‹EventLoop::runInLoop()å‡½æ•°çš„æ„ä¹‰ï¼Œå‡å¦‚ä½ æœ‰ä¸€ä¸ªEventLoopå¯¹è±¡ loop_ï¼Œå½“ä½ è°ƒç”¨äº†loop_-&gt;runInLoop(function)å‡½æ•°æ—¶ï¼Œè¿™ä¸ªfunctionå‡½æ•°çš„æ‰§è¡Œä¼šåœ¨è¿™ä¸ªloop_ç»‘å®šçš„çº¿ç¨‹ä¸Šè¿è¡Œï¼<br>æ‰€ä»¥æˆ‘ä»¬ç”»äº†ä¸‹é¢è¿™å¹…å›¾ï¼Œåœ¨åˆ›å»ºTcpConnectionå¯¹è±¡æ—¶ï¼ŒAcceptoréƒ½è¦å°†è¿™ä¸ªå¯¹è±¡åˆ†å‘ç»™ä¸€ä¸ªSubEventLoopæ¥ç®¡ç†ã€‚è¿™ä¸ªTcpConnectionå¯¹è±¡çš„ä¸€åˆ‡å‡½æ•°æ‰§è¡Œéƒ½è¦åœ¨å…¶ç®¡ç†çš„SubEventLoopçº¿ç¨‹ä¸­è¿è¡Œã€‚å†ä¸€æ¬¡è´¯å½»One Loop Per Threadçš„è®¾è®¡æ¨¡å¼ã€‚æ¯”å¦‚è¦æƒ³å½»åº•åˆ é™¤ä¸€ä¸ªTcpConnectionå¯¹è±¡ï¼Œå°±å¿…é¡»è¦è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„connecDestroyed()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ‰§è¡Œå®Œåæ‰èƒ½é‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„å †å†…å­˜ã€‚æ¯ä¸ªTcpConnectionå¯¹è±¡çš„connectDestroyed()æ–¹æ³•éƒ½å¿…é¡»åœ¨è¿™ä¸ªTcpConnectionå¯¹è±¡æ‰€å±çš„SubEventLoopç»‘å®šçš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240503110725342.png" alt=""></p><p>æ‰€æœ‰ä¸Šé¢çš„TcpServer::~TcpServer()å‡½æ•°å°±æ˜¯å¹²è¿™äº‹å„¿çš„ï¼Œä¸æ–­å¾ªç¯çš„è®©è¿™ä¸ªTcpConnectionå¯¹è±¡æ‰€å±çš„SubEventLoopçº¿ç¨‹æ‰§è¡ŒTcpConnection::connectDestroyed()å‡½æ•°ï¼ŒåŒæ—¶åœ¨MainEventLoopçš„TcpServer::~TcpServer()å‡½æ•°ä¸­è°ƒç”¨item.second.reset()é‡Šæ”¾ä¿ç®¡TcpConnectionå¯¹è±¡çš„å…±äº«æ™ºèƒ½æŒ‡é’ˆï¼Œä»¥è¾¾åˆ°é‡Šæ”¾TcpConnectionå¯¹è±¡çš„å †å†…å­˜ç©ºé—´çš„ç›®çš„ã€‚<br>ä½†æ˜¯è¿™é‡Œé¢å…¶å®æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼ŒTcpConnection::connectDestroyed()å‡½æ•°çš„æ‰§è¡Œä»¥åŠè¿™ä¸ªTcpConnectionå¯¹è±¡çš„å †å†…å­˜é‡Šæ”¾æ“ä½œä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼Œæ‰€ä»¥è¦è€ƒè™‘æ€ä¹ˆä¿è¯ä¸€ä¸ªTcpConnectinoå¯¹è±¡çš„å †å†…å­˜é‡Šæ”¾æ“ä½œæ˜¯åœ¨TcpConnection::connectDestroyed()è°ƒç”¨å®Œåã€‚<br>è¿™ä¸ªææ„å‡½æ•°å·§å¦™åˆ©ç”¨äº†å…±äº«æ™ºèƒ½æŒ‡é’ˆçš„ç‰¹ç‚¹ï¼Œå½“æ²¡æœ‰å…±äº«æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªTcpConnectionå¯¹è±¡æ—¶ï¼ˆå¼•ç”¨è®¡æ•°ä¸º0ï¼‰ï¼Œè¿™ä¸ªTcpConnectionå¯¹è±¡å°±ä¼šè¢«ææ„åˆ é™¤ï¼ˆå †å†…å­˜é‡Šæ”¾ï¼‰ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">TcpServer::~<span class="built_in">TcpServer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//connectionsç±»å‹ä¸ºstd::unordered_map&lt;std::string, TcpConnectionPtr&gt;;</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;item : connections_)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">TcpConnectionPtr <span class="title">conn</span><span class="params">(item.second)</span></span>;</span><br><span class="line">        item.second.<span class="built_in">reset</span>(); </span><br><span class="line">        conn-&gt;<span class="built_in">getLoop</span>()-&gt;<span class="built_in">runInLoop</span>(<span class="built_in">bind</span>(&amp;TcpConnection::connectDestroyed, conn));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆTcpServer::connections_æ˜¯ä¸€ä¸ªunordered_map&lt;string, TcpConnectionPtr&gt;ï¼Œå…¶ä¸­TcpConnectionPtrçš„å«ä¹‰æ˜¯æŒ‡å‘TcpConnectionçš„shared_ptrã€‚</li><li>åœ¨ä¸€å¼€å§‹ï¼Œæ¯ä¸€ä¸ªTcpConnectionå¯¹è±¡éƒ½è¢«ä¸€ä¸ªå…±äº«æ™ºèƒ½æŒ‡é’ˆTcpConnetionPtræŒæœ‰ï¼Œå½“æ‰§è¡Œäº†TcpConnectionPtr conn(item.second)æ—¶ï¼Œè¿™ä¸ªTcpConnetionå¯¹è±¡å°±è¢«connå’Œè¿™ä¸ªitem.secondå…±åŒæŒæœ‰ï¼Œä½†æ˜¯è¿™ä¸ªconnçš„ç”Ÿå­˜å‘¨æœŸå¾ˆçŸ­ï¼Œåªè¦ç¦»å¼€äº†å½“å‰çš„è¿™ä¸€æ¬¡forå¾ªç¯ï¼Œconnå°±ä¼šè¢«é‡Šæ”¾ã€‚</li><li>ç´§æ¥ç€è°ƒç”¨item.second.reset()é‡Šæ”¾æ‰TcpServerä¸­ä¿å­˜çš„è¯¥TcpConnectinoå¯¹è±¡çš„æ™ºèƒ½æŒ‡é’ˆã€‚æ­¤æ—¶åœ¨å½“å‰æƒ…å†µä¸‹ï¼Œåªå‰©ä¸‹connè¿˜æŒæœ‰è¿™ä¸ªTcpConnectionå¯¹è±¡ï¼Œå› æ­¤å½“å‰TcpConnectionå¯¹è±¡è¿˜ä¸ä¼šè¢«ææ„ã€‚</li><li>æ¥ç€è°ƒç”¨äº†conn-&gt;getLoop()-&gt;runInLoop(bind(&amp;TcpConnection::connectDestroyed, conn));<br>è¿™å¥è¯çš„å«ä¹‰æ˜¯è®©SubEventLoopçº¿ç¨‹å»æ‰§è¡ŒTcpConnection::connectDestroyed()å‡½æ•°ã€‚å½“ä½ æŠŠè¿™ä¸ªconnçš„æˆå‘˜å‡½æ•°ä¼ è¿›å»çš„æ—¶å€™ï¼Œconnæ‰€æŒ‡å‘çš„èµ„æºçš„å¼•ç”¨è®¡æ•°ä¼šåŠ 1ã€‚å› ä¸ºä¼ ç»™runInLoopçš„ä¸åªæœ‰å‡½æ•°ï¼Œè¿˜æœ‰è¿™ä¸ªå‡½æ•°æ‰€å±çš„å¯¹è±¡connã€‚</li><li>SubEventLoopçº¿ç¨‹å¼€å§‹è¿è¡ŒTcpConnection::connectDestroyed()</li><li>MainEventLoopçº¿ç¨‹å½“å‰è¿™ä¸€è½®forå¾ªç¯è·‘å®Œï¼Œå…±äº«æ™ºèƒ½æŒ‡é’ˆconnç¦»å¼€ä»£ç å—ï¼Œå› æ­¤è¢«ææ„ï¼Œä½†æ˜¯TcpConnectionå¯¹è±¡è¿˜ä¸ä¼šè¢«é‡Šæ”¾ï¼Œå› ä¸ºè¿˜æœ‰ä¸€ä¸ªå…±äº«æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªTcpConnectionå¯¹è±¡ï¼Œè€Œä¸”è¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆåœ¨TcpConnection::connectDestroyed()ä¸­ï¼Œåªä¸è¿‡è¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆä½ çœ‹ä¸åˆ°ï¼Œå®ƒåœ¨è¿™ä¸ªå‡½æ•°ä¸­æ˜¯ä¸€ä¸ªéšå¼çš„thisçš„å­˜åœ¨ã€‚å½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œåï¼Œæ™ºèƒ½æŒ‡é’ˆå°±çœŸçš„è¢«é‡Šæ”¾äº†ã€‚åˆ°æ­¤ï¼Œå°±æ²¡æœ‰ä»»ä½•æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªTcpConnectionå¯¹è±¡äº†ã€‚TcpConnectionå¯¹è±¡å°±å½»åº•è¢«ææ„åˆ é™¤äº†ã€‚</li></ul>]]></content>
    
    
    <summary type="html">æ·±å…¥å‰–æmuduoç½‘ç»œåº“</summary>
    
    
    
    <category term="ç½‘ç»œç¼–ç¨‹" scheme="https://penge666.github.io/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
    <category term="ç½‘ç»œç¼–ç¨‹" scheme="https://penge666.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>æ—¶é—´å‡½æ•°</title>
    <link href="https://penge666.github.io/posts/83c8f10.html"/>
    <id>https://penge666.github.io/posts/83c8f10.html</id>
    <published>2024-04-30T09:05:22.000Z</published>
    <updated>2024-04-30T11:17:17.549Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨C++æ—¥å¿—ç³»ç»Ÿä¸­ï¼Œæ‰“å°æ—¶é—´æ˜¯å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ“ä½œã€‚</p><p>åœ¨ Linux C è¯­è¨€ç¼–ç¨‹ä¸­ï¼Œæœ‰ä¸¤ç§æ—¶é—´è¡¨ç¤ºæ–¹å¼ï¼š</p><ul><li><p>ä¸€ç§æ˜¯æ—¥å†æ—¶é—´ï¼ˆcalendar timeï¼‰ï¼Œç”¨äºè¡¨ç¤ºè‡ªçºªå…ƒï¼ˆEpochï¼‰ä»¥æ¥çš„ç§’æ•°ï¼Œä»–å¯ä»¥è½¬æ¢æˆæˆ‘ä»¬æ—¥å¸¸çœ‹åˆ°çš„æ—¶é—´ã€‚</p></li><li><p>ä¸€ç§æ˜¯å¤„ç†å™¨æ—¶é—´ï¼ˆprocessor timeï¼‰ï¼Œç”¨äºè¡¨ç¤ºç¨‹åºåœ¨ CPU ä¸Šæ‰§è¡Œçš„æ—¶é—´ã€‚æœ¬æ–‡ä¸»è¦å…³æ³¨æ—¥å†æ—¶é—´çš„å¤„ç†ã€‚</p></li></ul><blockquote><p><strong>æ—¶é—´æˆ³çš„æ¦‚å¿µ</strong></p></blockquote><p>æ—¶é—´æˆ³æ˜¯ä¸€ç§ç”¨æ•°å­—è¡¨ç¤ºæ—¶é—´çš„æ–¹å¼ã€‚å®ƒæ˜¯ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼Œè®°å½•äº†æŸä¸ªç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶çš„æ—¶é—´å’Œæ—¥æœŸã€‚</p><p>ä½ å¯ä»¥æŠŠæ—¶é—´æˆ³çœ‹ä½œä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„æ•°å­—æ ‡è®°ï¼Œè¡¨ç¤ºäº†æŸä¸ªæ—¶åˆ»çš„æ—¶é—´ã€‚è¿™ä¸ªæ•°å­—é€šå¸¸æ˜¯ä»æŸä¸ªå‚è€ƒç‚¹ï¼ˆé€šå¸¸æ˜¯çºªå…ƒï¼‰å¼€å§‹ä¸æ–­å¢åŠ çš„ã€‚</p><p>æ—¶é—´æˆ³å¯ä»¥ç²¾ç¡®åˆ°ç§’ã€æ¯«ç§’ç”šè‡³æ›´å°çš„å•ä½ï¼Œå–å†³äºä½¿ç”¨çš„ç³»ç»Ÿå’Œç¼–ç¨‹è¯­è¨€ã€‚ä½¿ç”¨æ—¶é—´æˆ³ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å¯¹äº‹ä»¶æŒ‰ç…§æ—¶é—´é¡ºåºè¿›è¡Œæ’åºå’Œæ¯”è¾ƒï¼Œè€Œä¸ç”¨æ‹…å¿ƒæ—¥æœŸæ ¼å¼ã€æ—¶åŒºç­‰å¤æ‚çš„é—®é¢˜ã€‚</p><p>æ—¶é—´æˆ³åœ¨è®¡ç®—æœºç§‘å­¦å’Œè½¯ä»¶å¼€å‘ä¸­éå¸¸æœ‰ç”¨ã€‚å®ƒå¯ä»¥ç”¨æ¥è®°å½•äº‹ä»¶å‘ç”Ÿçš„é¡ºåºã€è®¡ç®—æ—¶é—´å·®ã€åˆ›å»ºæ—¶é—´æˆ³åºåˆ—ã€åšæ•°æ®åˆ†æç­‰ç­‰ã€‚è®¸å¤šæ“ä½œç³»ç»Ÿå’Œç¼–ç¨‹è¯­è¨€éƒ½æä¾›äº†ç”¨äºè·å–å’Œå¤„ç†æ—¶é—´æˆ³çš„å‡½æ•°å’Œå·¥å…·ï¼Œä½¿æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°ä½¿ç”¨å®ƒä»¬ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œ<strong>æ—¶é—´æˆ³å°±æ˜¯ç”¨æ•°å­—æ¥è¡¨ç¤ºç‰¹å®šæ—¶åˆ»çš„æ—¶é—´å’Œæ—¥æœŸï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨è®¡ç®—æœºä¸­å¤„ç†å’Œæ¯”è¾ƒæ—¶é—´</strong>ã€‚</p><h2 id="æ—¶é—´å‡½æ•°">æ—¶é—´å‡½æ•°</h2><h3 id="time">time()</h3><p>time()å‡½æ•°æ˜¯ C å’Œ C++ ä¸­æœ€åŸºæœ¬çš„æ—¶é—´å‡½æ•°ï¼Œå®ƒè¿”å›è‡ª 1970 å¹´ 1 æœˆ 1 æ—¥èµ·çš„ç§’æ•°ã€‚å…¶å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">time_t</span> <span class="title">time</span><span class="params">(<span class="type">time_t</span> *tloc)</span></span>;</span><br></pre></td></tr></table></figure><p>å‚æ•°çš„ä½œç”¨ï¼š</p><ul><li>å½“å‚æ•°ä¸ºNULLæ—¶ï¼štime_tè¿™ä¸ªæ•´å‹å€¼é€šè¿‡è¿”å›å€¼è¿”å›ã€‚</li><li>å½“å‚æ•°ä¸ä¸ºNULLæ—¶ï¼štime_tæˆ‘ä»¬éœ€è¦çš„è¿™ä¸ªæ•´å‹å€¼é€šè¿‡å‚æ•°æŒ‡é’ˆå¾—åˆ°ã€‚</li></ul><p>time_tç±»å‹</p><ul><li><strong>time_t</strong>æ˜¯ä¸€ä¸ªç”¨äºè¡¨ç¤ºæ—¶é—´çš„æ•°æ®ç±»å‹ï¼Œå®ƒåœ¨ C è¯­è¨€ä¸­å¹¿æ³›ä½¿ç”¨ã€‚å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ä¸ªæ•´æ•°ç±»å‹ï¼Œ<strong>ç”¨äºå­˜å‚¨æ—¶é—´æˆ³</strong>ã€‚</li></ul><p>ä½¿ç”¨ç¤ºä¾‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">time_t</span> current_time;</span><br><span class="line">    <span class="built_in">time</span>(&amp;current_time);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å½“å‰æ—¶é—´ä¸º: %lld\n&quot;</span>, (<span class="type">long</span> <span class="type">long</span>)current_time);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¹Ÿæ˜¯å¯ä»¥çš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">time_t</span> current_time;</span><br><span class="line">    current_time=<span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å½“å‰æ—¶é—´ä¸º: %lld\n&quot;</span>, (<span class="type">long</span> <span class="type">long</span>)current_time);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="gettimeofday">gettimeofday()</h3><p>gettimeofday() è¿™ä¸ªå‡½æ•°åœ¨ Unix å’Œ Linux ç³»ç»Ÿä¸­å¸¸ç”¨ï¼Œå®ƒå¯ä»¥è·å–åˆ°å¾®ç§’çº§åˆ«çš„æ—¶é—´ï¼Œæ›´åŠ ç²¾ç¡®ã€‚</p><p>å‡½æ•°åŸå‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">gettimeofday</span><span class="params">(<span class="keyword">struct</span> timeval *tv, <span class="keyword">struct</span> timezone *tz)</span></span>;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">gettimeofday</span>(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;tv_sec: %d\n&quot;</span>, tv.tv_sec);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;tv_usec: %d\n&quot;</span>, tv.tv_usec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="localtime">localtime()</h3><p>localtime() å‡½æ•°çš„åŠŸèƒ½æ˜¯å°† time_t ç±»å‹çš„æ—¶é—´è½¬æ¢ä¸ºä¸€ä¸ª tm ç»“æ„ä½“ç±»å‹çš„æ—¶é—´ã€‚</p><p>localtime() å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">tm</span>* <span class="built_in">localtime</span>(<span class="type">const</span> <span class="type">time_t</span>* timer);</span><br></pre></td></tr></table></figure><ul><li>å‚æ•°</li></ul><p>timerï¼šè¦è½¬æ¢çš„æ—¶é—´ã€‚</p><ul><li>è¿”å›å€¼</li></ul><p>è¿”å›ä¸€ä¸ªæŒ‡å‘ tm ç»“æ„ä½“å˜é‡çš„æŒ‡é’ˆï¼Œè¯¥å˜é‡å­˜å‚¨äº†å½“å‰æ—¶é—´çš„å„ä¸ªç»„æˆéƒ¨åˆ†ã€‚</p><p>tmç»“æ„ä½“</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">tm</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> tm_sec;   <span class="comment">/* Seconds (0-60) */</span></span><br><span class="line">    <span class="type">int</span> tm_min;   <span class="comment">/* Minutes (0-59) */</span></span><br><span class="line">    <span class="type">int</span> tm_hour;  <span class="comment">/* Hours (0-23) */</span></span><br><span class="line">    <span class="type">int</span> tm_mday;  <span class="comment">/* Day of the month (1-31) */</span></span><br><span class="line">    <span class="type">int</span> tm_mon;   <span class="comment">/* Month (0-11) */</span></span><br><span class="line">    <span class="type">int</span> tm_year;  <span class="comment">/* Year - 1900 */</span></span><br><span class="line">    <span class="type">int</span> tm_wday;  <span class="comment">/* Day of the week (0-6, Sunday = 0) */</span></span><br><span class="line">    <span class="type">int</span> tm_yday;  <span class="comment">/* Day in the year (0-365, 1 Jan = 0) */</span></span><br><span class="line">    <span class="type">int</span> tm_isdst; <span class="comment">/* Daylight saving time */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">time_t</span> current_time;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">tm</span>* local_time;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">  current_time = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´ç»“æ„ä½“</span></span><br><span class="line">  local_time = <span class="built_in">localtime</span>(&amp;current_time);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥æ˜¯å¦è½¬æ¢æˆåŠŸ</span></span><br><span class="line">  <span class="keyword">if</span> (local_time != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%04d-%02d-%02d %02d:%02d:%02d\n&quot;</span>,</span><br><span class="line">             local_time-&gt;tm_year + <span class="number">1900</span>, <span class="comment">// å¹´ä»½</span></span><br><span class="line">             local_time-&gt;tm_mon + <span class="number">1</span>,     <span class="comment">// æœˆä»½</span></span><br><span class="line">             local_time-&gt;tm_mday,        <span class="comment">// æ—¥</span></span><br><span class="line">             local_time-&gt;tm_hour,        <span class="comment">// å°æ—¶</span></span><br><span class="line">             local_time-&gt;tm_min,         <span class="comment">// åˆ†é’Ÿ</span></span><br><span class="line">             local_time-&gt;tm_sec          <span class="comment">// ç§’</span></span><br><span class="line">      );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;æ—¶é—´è½¬æ¢å¤±è´¥\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2024-04-30 18:54:30</span><br></pre></td></tr></table></figure><p><strong>Note:</strong></p><p>localtimeå‡½æ•°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚åœ¨å¤šçº¿ç¨‹åº”ç”¨é‡Œé¢ï¼Œåº”è¯¥ç”¨localtime_rå‡½æ•°æ›¿ä»£localtimeå‡½æ•°ï¼Œå› ä¸ºlocaltime_ræ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><h3 id="gmtime">gmtime()</h3><p>ç±»ä¼¼ localtime()ï¼Œä½†è¿”å›çš„æ˜¯æ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line">    std::<span class="type">time_t</span> current_time = std::<span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ gmtime è½¬æ¢ä¸ºæ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´</span></span><br><span class="line">    std::tm* gm_time = std::<span class="built_in">gmtime</span>(&amp;current_time);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡ºæ—¶é—´</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;UTC time: &quot;</span> &lt;&lt; gm_time-&gt;tm_hour &lt;&lt; <span class="string">&quot;:&quot;</span></span><br><span class="line">              &lt;&lt; gm_time-&gt;tm_min &lt;&lt; <span class="string">&quot;:&quot;</span></span><br><span class="line">              &lt;&lt; gm_time-&gt;tm_sec &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="strftime">strftime()</h3><p>strftime() å‡½æ•°çš„ä½œç”¨æ˜¯æŒ‰ç…§æŒ‡å®šçš„æ ¼å¼å°†æ—¶é—´ç»“æ„ä½“è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p><p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">strftime</span><span class="params">(<span class="type">char</span> *s, <span class="type">size_t</span> maxsize, <span class="type">const</span> <span class="type">char</span> *format, <span class="type">const</span> <span class="keyword">struct</span> tm *timeptr)</span></span>;</span><br></pre></td></tr></table></figure><p>strftimeå‚æ•°è§£æï¼š</p><ul><li><p>sï¼šä¸€ä¸ªæŒ‡å‘å­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²ã€‚è¿™ä¸ªå­—ç¬¦æ•°ç»„å¿…é¡»å…·æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥å­˜å‚¨ç”Ÿæˆçš„å­—ç¬¦ä¸²ã€‚</p></li><li><p>maxsizeï¼šè¡¨ç¤ºå­˜å‚¨æ—¶é—´å­—ç¬¦ä¸²çš„å­—ç¬¦æ•°ç»„çš„æœ€å¤§é•¿åº¦ã€‚è¿™æ˜¯ä¸ºäº†é¿å…æº¢å‡ºã€‚</p></li><li><p>formatï¼šä¸€ä¸ªæŒ‡å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œç”¨äºå®šä¹‰æ—¶é—´å­—ç¬¦ä¸²çš„è¾“å‡ºæ ¼å¼ã€‚æ ¼å¼å­—ç¬¦ä¸²åŒ…å«ç‰¹å®šçš„æ ¼å¼å ä½ç¬¦ï¼Œå¦‚ %Y è¡¨ç¤ºå¹´ä»½ï¼Œ%m è¡¨ç¤ºæœˆä»½ç­‰ã€‚</p></li><li><p>timeptrï¼šä¸€ä¸ªæŒ‡å‘ struct tm ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå…¶ä¸­åŒ…å«äº†è¦æ ¼å¼åŒ–çš„æ—¶é—´ä¿¡æ¯ã€‚è¿™ä¸ªç»“æ„ä½“å­˜å‚¨äº†å¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’ç­‰æ—¶é—´å­—æ®µçš„å€¼ã€‚</p></li></ul><p>strftimeè¿”å›å€¼è§£æ</p><ul><li>å‡½æ•° strftime() çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª size_t ç±»å‹çš„æ•´æ•°ï¼Œè¡¨ç¤ºæˆåŠŸå†™å…¥ç›®æ ‡å­—ç¬¦ä¸² s çš„å­—ç¬¦æ•°ï¼ˆä¸åŒ…æ‹¬æœ«å°¾çš„ç©ºå­—ç¬¦ï¼‰ã€‚</li></ul><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">time_t</span> current_time;</span><br><span class="line">    <span class="built_in">time</span>(&amp;current_time);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> *<span class="type">local_t</span> = <span class="built_in">localtime</span>(&amp;current_time);</span><br><span class="line">    <span class="type">char</span> time_str[<span class="number">64</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">strftime</span>(time_str, <span class="built_in">sizeof</span>(time_str), <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, <span class="type">local_t</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å½“å‰æ—¶é—´ä¸º: %s\n&quot;</span>, time_str);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å½“å‰æ—¶é—´ä¸º: 2024-04-30 19:05:43</span><br></pre></td></tr></table></figure><h3 id="chronoåº“">chronoåº“</h3><p>è¿™æ˜¯ C++11 ä¸­å¼•å…¥çš„æ–°çš„æ—¶é—´åº“ï¼Œå¯ä»¥æ–¹ä¾¿åœ°è·å–é«˜ç²¾åº¦æ—¶é—´ï¼Œå¹¶è¿›è¡Œæ—¶é—´çš„ç®—æœ¯è¿ç®—ã€‚</p><ul><li><a href="https://zhuanlan.zhihu.com/p/679451085">C++ std::chronoåº“ä½¿ç”¨æŒ‡å— (å®ç°C++ è·å–æ—¥æœŸ,æ—¶é—´æˆ³,è®¡æ—¶ç­‰åŠŸèƒ½)</a></li><li><a href="https://zhuanlan.zhihu.com/p/662738124">å†ä¹Ÿä¸è¢«æ—¶é—´æŸç¼šï¼šC++ stdchronoæ—¶é—´åº“å…¨é¢è§£æ</a></li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="https://developer.aliyun.com/article/1350147">Linux Cè¯­è¨€ä¹‹æ—¶é—´å‡½æ•°ç²¾è®²</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/679451085">C++ std::chronoåº“ä½¿ç”¨æŒ‡å— (å®ç°C++ è·å–æ—¥æœŸ,æ—¶é—´æˆ³,è®¡æ—¶ç­‰åŠŸèƒ½)</a></p></li></ul>]]></content>
    
    
    <summary type="html">èµ°è¿›æ—¶é—´å‡½æ•°çš„ä¸–ç•Œ</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
  </entry>
  
  <entry>
    <title>LinuxæƒŠç¾¤æ•ˆåº”</title>
    <link href="https://penge666.github.io/posts/e5c92e8d.html"/>
    <id>https://penge666.github.io/posts/e5c92e8d.html</id>
    <published>2024-04-30T02:36:29.000Z</published>
    <updated>2024-04-30T03:08:41.685Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ¬åšå®¢ä¸»è¦ä»‹ç»ä»€ä¹ˆæ˜¯æƒŠç¾¤ï¼ŒæƒŠç¾¤åœ¨çº¿ç¨‹å’Œè¿›ç¨‹ä¸­çš„å…·ä½“è¡¨ç°ï¼ŒæƒŠç¾¤çš„ç³»ç»Ÿæ¶ˆè€—å’ŒæƒŠç¾¤çš„å¤„ç†æ–¹æ³•ã€‚</p><h2 id="ä»‹ç»">ä»‹ç»</h2><p>æƒŠç¾¤æ•ˆåº”ä¹Ÿæœ‰äººå«åšé›·é¸£ç¾¤ä½“æ•ˆåº”ï¼Œä¸è¿‡å«ä»€ä¹ˆï¼Œç®€è¨€ä¹‹ï¼ŒæƒŠç¾¤ç°è±¡å°±æ˜¯å¤šè¿›ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰åœ¨åŒæ—¶é˜»å¡ç­‰å¾…åŒä¸€ä¸ªäº‹ä»¶çš„æ—¶å€™ï¼ˆä¼‘çœ çŠ¶æ€ï¼‰ï¼Œå¦‚æœç­‰å¾…çš„è¿™ä¸ªäº‹ä»¶å‘ç”Ÿï¼Œé‚£ä¹ˆä»–å°±ä¼šå”¤é†’ç­‰å¾…çš„æ‰€æœ‰è¿›ç¨‹ï¼ˆæˆ–è€…çº¿ç¨‹ï¼‰ï¼Œä½†æ˜¯æœ€ç»ˆå´åªå¯èƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰è·å¾—è¿™ä¸ªæ—¶é—´çš„â€œæ§åˆ¶æƒâ€ï¼Œå¯¹è¯¥äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œè€Œå…¶ä»–è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰è·å–â€œæ§åˆ¶æƒâ€å¤±è´¥ï¼Œåªèƒ½é‡æ–°è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè¿™ç§ç°è±¡å’Œæ€§èƒ½æµªè´¹å°±å«åšæƒŠç¾¤ã€‚</p><p>è¿™é‡Œæ‰“ä¸ªæœ‰è¶£çš„æ¯”æ–¹ï¼Œå°±åƒåœ¨å­¦æ ¡çš„æ¹–é‡Œé¢ç”¨é¢åŒ…ğŸå–‚å¤©é¹…ï¼Œå½“ä½ å¾€ä¸€ç¾¤å¤©é¹…ä¸­é—´æ‰”ä¸€æ’®é¢åŒ…ğŸï¼Œæ‰€æœ‰çš„å¤©é¹…å„è‡ªéƒ½è¢«æƒŠåŠ¨å‰æ¥æŠ¢å¤ºè¿™å¯å£çš„é£Ÿç‰©ï¼Œä½†æ˜¯æœ€ç»ˆæ³¨å®šåªæœ‰ä¸€ä¸ªå¤©é¹…æŠ¢åˆ°é£Ÿç‰©ï¼Œæ²¡æœ‰æŠ¢åˆ°çš„å¤©é¹…åªå¥½å›å»ç»§ç»­ç­‰å¾…ã€‚</p><blockquote><p><strong>æƒŠç¾¤æ•ˆåº”å­˜åœ¨çš„é—®é¢˜</strong></p></blockquote><p>ï¼ˆ1ï¼‰ç³»ç»Ÿå¯¹ç”¨æˆ·è¿›ç¨‹/çº¿ç¨‹é¢‘ç¹åœ°åšæ— æ•ˆçš„è°ƒåº¦ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ç³»ç»Ÿæ€§èƒ½å¤§æ‰“æŠ˜æ‰£ã€‚</p><p>ï¼ˆ2ï¼‰ä¸ºäº†ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¾—åˆ°èµ„æºï¼Œç”¨æˆ·å¿…é¡»å¯¹èµ„æºæ“ä½œè¿›è¡ŒåŠ é”ä¿æŠ¤ï¼Œè¿›ä¸€æ­¥åŠ å¤§äº†ç³»ç»Ÿå¼€é”€ã€‚</p><h2 id="æƒŠç¾¤æ•ˆåº”ç¤ºä¾‹">æƒŠç¾¤æ•ˆåº”ç¤ºä¾‹</h2><h3 id="accept">accept</h3><p>åœºæ™¯ï¼šä¸»è¿›ç¨‹åˆ›å»ºäº†socketã€bindã€listenä¹‹åï¼Œfork()å‡ºæ¥å¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªå­è¿›ç¨‹éƒ½å¼€å§‹å¾ªç¯å¤„ç†ï¼ˆacceptï¼‰è¿™ä¸ªlisten_fdã€‚æ¯ä¸ªè¿›ç¨‹éƒ½é˜»å¡åœ¨acceptä¸Šï¼Œå½“ä¸€ä¸ªæ–°çš„è¿æ¥åˆ°æ¥æ—¶å€™ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼šè¢«å”¤é†’ï¼Œä½†æ˜¯å…¶ä¸­åªæœ‰ä¸€ä¸ªè¿›ç¨‹ä¼šæ¥å—æˆåŠŸï¼Œå…¶ä½™çš†å¤±è´¥ï¼Œé‡æ–°ä¼‘çœ ã€‚</p><p>main.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROCESS_NUM 10</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> connfd;</span><br><span class="line">    <span class="type">int</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuff[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serveraddr;</span><br><span class="line">    serveraddr.sin_family = AF_INET;</span><br><span class="line">    serveraddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    serveraddr.sin_port = <span class="built_in">htons</span>(<span class="number">1234</span>);</span><br><span class="line">    <span class="built_in">bind</span>(fd, (<span class="keyword">struct</span> sockaddr *)&amp;serveraddr, <span class="built_in">sizeof</span>(serveraddr));</span><br><span class="line">    <span class="built_in">listen</span>(fd, <span class="number">1024</span>);</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PROCESS_NUM; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                connfd = <span class="built_in">accept</span>(fd, (<span class="keyword">struct</span> sockaddr *)<span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (connfd == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">snprintf</span>(sendbuff, <span class="built_in">sizeof</span>(sendbuff), <span class="string">&quot;æ¥æ”¶åˆ°acceptäº‹ä»¶çš„è¿›ç¨‹PID = %d\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">send</span>(connfd, sendbuff, <span class="built_in">strlen</span>(sendbuff) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;process %d accept success\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">                    <span class="built_in">close</span>(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;process %d accept a connection failed: %s\n&quot;</span>, <span class="built_in">getpid</span>(), <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    <span class="built_in">close</span>(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// int status;</span></span><br><span class="line">    <span class="built_in">wait</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/test î‚° g++ main.cpp -o main -pthread</span><br><span class="line">penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/test î‚° strace -f ./main</span><br></pre></td></tr></table></figure><ul><li><a href="https://zhuanlan.zhihu.com/p/180053751">Linuxç¥å™¨straceçš„ä½¿ç”¨æ–¹æ³•åŠå®è·µ</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[pid 171338] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171338] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171338] accept(3, NULL, NULLstrace: Process 171339 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171339</span><br><span class="line">[pid 171339] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171339] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171339] accept(3, NULL, NULLstrace: Process 171340 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171340</span><br><span class="line">[pid 171340] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171340] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171340] accept(3, NULL, NULLstrace: Process 171341 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171341</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171341] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">strace: Process 171342 attached</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171342</span><br><span class="line">[pid 171341] accept(3, NULL, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid 171342] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171342] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171342] accept(3, NULL, NULLstrace: Process 171343 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171343</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171343] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">[pid 171343] accept(3, NULL, NULLstrace: Process 171344 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171344</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171344] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">[pid 171344] accept(3, NULL, NULLstrace: Process 171345 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171345</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171345] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">strace: Process 171346 attached</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171346</span><br><span class="line">[pid 171345] accept(3, NULL, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171346] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">[pid 171346] accept(3, NULL, NULLstrace: Process 171347 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171347</span><br><span class="line">[pid 171347] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] wait4(-1,  &lt;unfinished ...&gt;</span><br><span class="line">[pid 171347] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171347] accept(3, NULL, NULL &lt;unfinished ...&gt;</span><br></pre></td></tr></table></figure><p>ä¹‹åï¼Œåœ¨å¯ç”¨ä¸€ä¸ªç»ˆç«¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 127.0.0.1 1234</span><br></pre></td></tr></table></figure><p>çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[pid 172089] fstat(1, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0x9), ...&#125;) = 0</span><br><span class="line">[pid 172089] brk(NULL)                  = 0x55f621f04000</span><br><span class="line">[pid 172089] brk(0x55f621f25000)        = 0x55f621f25000</span><br><span class="line">[pid 172089] write(1, <span class="string">&quot;process 172089 accept a connecti&quot;</span>..., 51process 172089 accept a connection failed: Success</span><br><span class="line">) = 51</span><br><span class="line">[pid 172089] close(4)                   = 0</span><br><span class="line">[pid 172089] accept(3, NULL, NULL^C &lt;unfinished ...&gt;</span><br><span class="line">[pid 172098] &lt;... accept resumed&gt;)      = ? ERESTARTSYS (To be restarted <span class="keyword">if</span> SA_RESTART is <span class="built_in">set</span>)</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾å½“telnetè¿æ¥çš„æ—¶å€™åªæœ‰ä¸€ä¸ªè¿›ç¨‹acceptæˆåŠŸï¼Œä¹Ÿå°±è¯´æ˜äº†è¿™é‡Œå¹¶æ²¡æœ‰å‘ç”ŸæƒŠç¾¤ã€‚</p><p>å…¶å®åœ¨linux2.6ç‰ˆæœ¬ä»¥åï¼Œlinuxå†…æ ¸å·²ç»è§£å†³äº†acceptï¼ˆï¼‰å‡½æ•°çš„â€œæƒŠç¾¤â€ç°è±¡ï¼Œå¤§æ¦‚çš„å¤„ç†æ–¹å¼å°±æ˜¯ï¼Œå½“å†…æ ¸æ¥æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·è¿æ¥åï¼Œåªä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰,æ‰€ä»¥å¦‚æœæœåŠ¡å™¨é‡‡ç”¨accepté˜»å¡è°ƒç”¨æ–¹å¼ï¼Œåœ¨æœ€æ–°çš„linuxç³»ç»Ÿä¸­å·²ç»æ²¡æœ‰â€œæƒŠç¾¤æ•ˆåº”â€äº†</p><h3 id="epoll">epoll</h3><p>åœºæ™¯ï¼šå¦‚æœå¤šä¸ªè¿›ç¨‹/çº¿ç¨‹é˜»å¡åœ¨ç›‘å¬åŒä¸€ä¸ªç›‘å¬socket fdçš„epoll_waitä¸Šï¼Œå½“æœ‰ä¸€ä¸ªæ–°çš„è¿æ¥åˆ°æ¥æ—¶ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼šè¢«å”¤é†’ã€‚</p><p>ä¸»è¿›ç¨‹åˆ›å»ºsocketï¼Œbindï¼Œlistenåï¼Œå°†è¯¥socketåŠ å…¥åˆ°epollä¸­ï¼Œç„¶åforkå‡ºå¤šä¸ªå­è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½é˜»å¡åœ¨epoll_waitä¸Šï¼Œå¦‚æœæœ‰äº‹ä»¶åˆ°æ¥ï¼Œåˆ™åˆ¤æ–­è¯¥äº‹ä»¶æ˜¯å¦æ˜¯è¯¥socketä¸Šçš„äº‹ä»¶å¦‚æœæ˜¯ï¼Œè¯´æ˜æœ‰æ–°çš„è¿æ¥åˆ°æ¥äº†ï¼Œåˆ™è¿›è¡Œæ¥å—æ“ä½œã€‚ä¸ºäº†ç®€åŒ–å¤„ç†ï¼Œå¿½ç•¥åç»­çš„è¯»å†™ä»¥åŠå¯¹æ¥å—è¿”å›çš„æ–°çš„å¥—æ¥å­—çš„å¤„ç†ï¼Œç›´æ¥æ–­å¼€è¿æ¥ã€‚<br>main.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROCESS_NUM 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXEVENTS 64</span></span><br><span class="line"><span class="comment">// socketåˆ›å»ºå’Œç»‘å®š</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sock_creat_bind</span><span class="params">(<span class="type">char</span> *port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> sock_fd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serveraddr;</span><br><span class="line">    serveraddr.sin_family = AF_INET;</span><br><span class="line">    serveraddr.sin_port = <span class="built_in">htons</span>(<span class="built_in">atoi</span>(port));</span><br><span class="line">    serveraddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bind</span>(sock_fd, (<span class="keyword">struct</span> sockaddr *)&amp;serveraddr, <span class="built_in">sizeof</span>(serveraddr));</span><br><span class="line">    <span class="keyword">return</span> sock_fd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆ©ç”¨fcntlè®¾ç½®æ–‡ä»¶æˆ–è€…å‡½æ•°è°ƒç”¨çš„çŠ¶æ€æ ‡å¿—</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">make_nonblocking</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> val = <span class="built_in">fcntl</span>(fd, F_GETFL);</span><br><span class="line">    val |= O_NONBLOCK;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(fd, F_SETFL, val) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;fcntl set&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> sock_fd, epoll_fd;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> event;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> *events;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: [port] %s&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((sock_fd = <span class="built_in">sock_creat_bind</span>(argv[<span class="number">1</span>])) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket and bind&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">make_nonblocking</span>(sock_fd) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;make non blocking&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(sock_fd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((epoll_fd = <span class="built_in">epoll_create</span>(MAXEVENTS)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;epoll_create&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    event.data.fd = sock_fd;</span><br><span class="line">    event.events = EPOLLIN;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epoll_fd, EPOLL_CTL_ADD, sock_fd, &amp;event) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;epoll_ctl&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*buffer where events are returned*/</span></span><br><span class="line">    events = <span class="built_in">static_cast</span>&lt;epoll_event *&gt;(<span class="built_in">calloc</span>(MAXEVENTS, <span class="built_in">sizeof</span>(event)));</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PROCESS_NUM; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int</span> num, j;</span><br><span class="line">                num = <span class="built_in">epoll_wait</span>(epoll_fd, events, MAXEVENTS, <span class="number">-1</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;process %d returnt from epoll_wait\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">                <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; ++i)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((events[i].events &amp; EPOLLERR) || (events[i].events &amp; EPOLLHUP) || (!(events[i].events &amp; EPOLLIN)))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;epoll error\n&quot;</span>);</span><br><span class="line">                        <span class="built_in">close</span>(events[i].data.fd);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (sock_fd == events[i].data.fd)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// æ”¶åˆ°å…³äºç›‘å¬å¥—æ¥å­—çš„é€šçŸ¥ï¼Œæ„å‘³ç€ä¸€ç›’æˆ–è€…å¤šä¸ªä¼ å…¥è¿æ¥</span></span><br><span class="line">                        <span class="keyword">struct</span> sockaddr in_addr;</span><br><span class="line">                        <span class="type">socklen_t</span> in_len = <span class="built_in">sizeof</span>(in_addr);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">accept</span>(sock_fd, &amp;in_addr, &amp;in_len) &lt; <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;process %d accept failed!\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;process %d accept successful!\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">wait</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(events);</span><br><span class="line">    <span class="built_in">close</span>(sock_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> âœ˜ penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/test î‚° ./main 1234  </span><br><span class="line">process 173413 returnt from epoll_wait</span><br><span class="line">process 173412 returnt from epoll_wait</span><br><span class="line">process 173411 returnt from epoll_wait</span><br><span class="line">process 173410 returnt from epoll_wait</span><br><span class="line">process 173409 returnt from epoll_wait</span><br><span class="line">process 173408 returnt from epoll_wait</span><br><span class="line">process 173407 returnt from epoll_wait</span><br><span class="line">process 173406 returnt from epoll_wait</span><br><span class="line">process 173405 returnt from epoll_wait</span><br><span class="line">process 173404 returnt from epoll_wait</span><br><span class="line">process 173407 accept successful!</span><br><span class="line">process 173409 accept failed!</span><br><span class="line">process 173410 accept failed!</span><br><span class="line">process 173411 accept failed!</span><br><span class="line">process 173412 accept failed!</span><br><span class="line">process 173406 accept failed!</span><br><span class="line">process 173404 accept failed!</span><br><span class="line">process 173413 accept failed!</span><br><span class="line">process 173405 accept failed!</span><br><span class="line">process 173408 accept failed!</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œå‘ç”Ÿäº†æƒŠç¾¤æ•ˆåº”ã€‚</p><blockquote><p>æ€ä¹ˆåˆ¤æ–­å‘ç”Ÿäº†æƒŠç¾¤å‘¢ï¼Ÿ</p></blockquote><p>æˆ‘ä»¬æ ¹æ®straceçš„è¿”å›ä¿¡æ¯å¯ä»¥ç¡®å®š:</p><p>(1) ç³»ç»Ÿåªä¼šè®©ä¸€ä¸ªè¿›ç¨‹çœŸæ­£çš„æ¥å—è¿™ä¸ªè¿æ¥ï¼Œè€Œå‰©ä½™çš„è¿›ç¨‹ä¼šè·å¾—ä¸€ä¸ªEAGAINä¿¡å·ã€‚</p><p>(2ï¼‰é€šè¿‡è¿”å›ç»“æœå’Œè¿›ç¨‹æ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨åˆ¤æ–­ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆå†…æ ¸å¤„ç†äº†acceptçš„æƒŠç¾¤ï¼Œå´ä¸å¤„ç†epoll_waitçš„æƒŠç¾¤å‘¢ï¼Ÿ</p></blockquote><p>acceptç¡®å®åº”è¯¥åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨æˆåŠŸï¼Œå†…æ ¸å¾ˆæ¸…æ¥šè¿™ä¸€ç‚¹ã€‚ä½†epollä¸ä¸€æ ·ï¼Œä»–ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé™¤äº†å¯èƒ½åç»­è¢«acceptè°ƒç”¨å¤–ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯å…¶ä»–ç½‘ç»œIOäº‹ä»¶çš„ï¼Œè€Œå…¶ä»–IOäº‹ä»¶æ˜¯å¦åªèƒ½ç”±ä¸€ä¸ªè¿›ç¨‹å¤„ç†ï¼Œæ˜¯ä¸ä¸€å®šçš„ï¼Œå†…æ ¸ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹ï¼Œè¿™æ˜¯ä¸€ä¸ªç”±ç”¨æˆ·å†³å®šçš„äº‹æƒ…ï¼Œä¾‹å¦‚å¯èƒ½ä¸€ä¸ªæ–‡ä»¶ä¼šç”±å¤šä¸ªè¿›ç¨‹æ¥è¯»å†™ã€‚æ‰€ä»¥ï¼Œå¯¹epollçš„æƒŠç¾¤ï¼Œå†…æ ¸åˆ™ä¸äºˆå¤„ç†ã€‚</p><h2 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</h2><p>è§£å†³æ–¹å¼ä¸€å…±æœ‰ä¸‰ç§</p><ol><li>accept_mutexï¼ˆåº”ç”¨å±‚çš„è§£å†³æ–¹æ¡ˆï¼‰</li><li>EPOLLEXCLUSIVEï¼ˆå†…æ ¸å±‚çš„è§£å†³æ–¹æ¡ˆï¼‰</li><li>SO_REUSEPORTï¼ˆå†…æ ¸å±‚çš„è§£å†³æ–¹æ¡ˆï¼‰</li></ol><h3 id="accept-mutex">accept_mutex</h3><p>çœ‹åˆ° mutex å¯èƒ½ä½ å°±çŸ¥é“äº†ï¼Œé”å˜›ï¼è¿™ä¹Ÿæ˜¯å¯¹äºé«˜å¹¶å‘å¤„ç†çš„ â€åŸºæ“â€œ é‡äº‹ä¸å†³åŠ é”ï¼Œæ²¡é”™ï¼ŒåŠ é”è‚¯å®šèƒ½è§£å†³é—®é¢˜ã€‚</p><p>æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹è¿™éƒ¨åˆ†çš„<a href="https://github.com/nginx/nginx/blob/b489ba83e9be446923facfe1a2fe392be3095d1f/src/event/ngx_event_accept.c#L328">ä»£ç å®ç°</a>ã€‚</p><h3 id="EPOLLEXCLUSIVE">EPOLLEXCLUSIVE</h3><p>EPOLLEXCLUSIVE æ˜¯ 2016 å¹´ 4.5+ å†…æ ¸æ–°æ·»åŠ çš„ä¸€ä¸ª epoll çš„æ ‡è¯†ã€‚å®ƒé™ä½äº†å¤šä¸ªè¿›ç¨‹/çº¿ç¨‹é€šè¿‡ epoll_ctl æ·»åŠ å…±äº« fd å¼•å‘çš„æƒŠç¾¤æ¦‚ç‡ï¼Œä½¿å¾—ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåªå”¤é†’ä¸€ä¸ªæ­£åœ¨ epoll_wait é˜»å¡ç­‰å¾…å”¤é†’çš„è¿›ç¨‹ï¼ˆè€Œä¸æ˜¯å…¨éƒ¨å”¤é†’ï¼‰ã€‚</p><p>å…³é”®æ˜¯ï¼šæ¯æ¬¡å†…æ ¸åªå”¤é†’ä¸€ä¸ªç¡çœ çš„è¿›ç¨‹å¤„ç†èµ„æºã€‚</p><h3 id="SO-REUSEPORT">SO_REUSEPORT</h3><p>Linuxå†…æ ¸çš„3.9ç‰ˆæœ¬å¸¦æ¥äº†SO_REUSEPORTç‰¹æ€§ï¼Œè¯¥ç‰¹æ€§æ”¯æŒå¤šä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹ç»‘å®šåˆ°åŒä¸€ç«¯å£ï¼Œæé«˜æœåŠ¡å™¨ç¨‹åºçš„æ€§èƒ½ï¼Œå…è®¸å¤šä¸ªå¥—æ¥å­—bind()ä»¥åŠlisten()åŒä¸€ä¸ªTCPæˆ–UDPç«¯å£ï¼Œå¹¶ä¸”åœ¨å†…æ ¸å±‚é¢å®ç°è´Ÿè½½å‡è¡¡ã€‚</p><ul><li>åœ¨æœªå¼€å¯SO_REUSEPORTçš„æ—¶å€™ï¼Œç”±ä¸€ä¸ªç›‘å¬socketå°†æ–°æ¥æ”¶çš„è¿æ¥è¯·æ±‚äº¤ç»™å„ä¸ªå·¥ä½œè€…å¤„ç†ï¼Œçœ‹å›¾ç¤ºï¼š<ul><li><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240430110045200.png" alt="image-20240430110045200"></li></ul></li><li>åœ¨ä½¿ç”¨SO_REUSEPORTåï¼Œå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶ç›‘å¬åŒä¸€ä¸ªIPï¼šç«¯å£ï¼Œç„¶åç”±å†…æ ¸å†³å®šå°†æ–°é“¾æ¥å‘é€ç»™å“ªä¸ªè¿›ç¨‹ï¼Œæ˜¾ç„¶ä¼šé™ä½æ¯ä¸ªå·¥äººæ¥æ”¶æ–°é“¾æ¥æ—¶é”ç«äº‰ã€‚<ul><li><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240430110103466.png" alt="image-20240430110103466"></li></ul></li></ul><blockquote><p><strong>SO_REUSEPORTè§£å†³äº†ä»€ä¹ˆé—®é¢˜</strong></p></blockquote><p>ï¼ˆ1ï¼‰å…è®¸å¤šä¸ªå¥—æ¥å­—bind()/listen()åŒä¸€ä¸ªtcp/udpç«¯å£ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æœåŠ¡å™¨å¥—æ¥å­—ï¼Œåœ¨æœåŠ¡å™¨å¥—æ¥å­—ä¸Šæ²¡æœ‰é”çš„ç«äº‰ã€‚</p><p>ï¼ˆ2ï¼‰å†…æ ¸å±‚é¢å®ç°è´Ÿè½½å‡è¡¡</p><p>ï¼ˆ3ï¼‰å®‰å…¨å±‚é¢ï¼Œç›‘å¬åŒä¸€ä¸ªç«¯å£çš„å¥—æ¥å­—åªèƒ½ä½äºåŒä¸€ä¸ªç”¨æˆ·ä¸‹é¢ã€‚</p><p>ï¼ˆ4ï¼‰å¤„ç†æ–°å»ºè¿æ¥æ—¶ï¼ŒæŸ¥æ‰¾listenerçš„æ—¶å€™ï¼Œèƒ½å¤Ÿæ”¯æŒåœ¨ç›‘å¬ç›¸åŒIPå’Œç«¯å£çš„å¤šä¸ªsockä¹‹é—´å‡è¡¡é€‰æ‹©ã€‚</p><blockquote><p><strong>å½“ä¸€ä¸ªè¿æ¥åˆ°æ¥çš„æ—¶å€™ï¼Œç³»ç»Ÿåˆ°åº•æ˜¯æ€ä¹ˆå†³å®šé‚£ä¸ªå¥—æ¥å­—æ¥å¤„ç†å®ƒï¼Ÿ</strong></p></blockquote><p>å¯¹äºä¸åŒå†…æ ¸ï¼Œå­˜åœ¨ä¸¤ç§æ¨¡å¼ï¼Œè¿™ä¸¤ç§æ¨¡å¼å¹¶ä¸å…±å­˜ï¼Œä¸€ç§å«åšçƒ­å¤‡ä»½æ¨¡å¼ï¼Œå¦ä¸€ç§å«åšè´Ÿè½½å‡è¡¡æ¨¡å¼ï¼Œ3.9å†…æ ¸ä»¥åï¼Œå…¨éƒ¨æ”¹ä¸ºè´Ÿè½½å‡è¡¡æ¨¡å¼ã€‚</p><ul><li>çƒ­å¤‡ä»½æ¨¡å¼ï¼šä¸€èˆ¬è€Œè¨€ï¼Œä¼šå°†æ‰€æœ‰çš„reuseportåŒä¸€ä¸ªIPåœ°å€/ç«¯å£çš„å¥—æ¥å­—æŒ‚åœ¨ä¸€ä¸ªé“¾è¡¨ä¸Šï¼Œå–ç¬¬ä¸€ä¸ªå³å¯ï¼Œå·¥ä½œçš„åªæœ‰ä¸€ä¸ªï¼Œå…¶ä»–çš„ä½œä¸ºå¤‡ä»½å­˜åœ¨ï¼Œå¦‚æœè¯¥å¥—æ¥å­—æŒ‚äº†ï¼Œå®ƒä¼šè¢«ä»é“¾è¡¨åˆ é™¤ï¼Œç„¶åç¬¬äºŒä¸ªä¾¿ä¼šæˆä¸ºç¬¬ä¸€ä¸ªã€‚</li><li>è´Ÿè½½å‡è¡¡æ¨¡å¼ï¼šå’Œçƒ­å¤‡ä»½æ¨¡å¼ä¸€æ ·ï¼Œæ‰€æœ‰reuseportåŒä¸€ä¸ªIPåœ°å€/ç«¯å£çš„å¥—æ¥å­—ä¼šæŒ‚åœ¨ä¸€ä¸ªé“¾è¡¨ä¸Šï¼Œä½ ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¿™æ ·ä¼šæ›´åŠ æ–¹ä¾¿ï¼Œå½“æœ‰è¿æ¥åˆ°æ¥æ—¶ï¼Œç”¨æ•°æ®åŒ…çš„æºIP/æºç«¯å£ä½œä¸ºä¸€ä¸ªHASHå‡½æ•°çš„è¾“å…¥ï¼Œå°†ç»“æœå¯¹reuseportå¥—æ¥å­—æ•°é‡å–æ¨¡ï¼Œå¾—åˆ°ä¸€ä¸ªç´¢å¼•ï¼Œè¯¥ç´¢å¼•æŒ‡ç¤ºçš„æ•°ç»„ä½ç½®å¯¹åº”çš„å¥—æ¥å­—ä¾¿æ˜¯å·¥ä½œå¥—æ¥å­—ã€‚è¿™æ ·å°±å¯ä»¥è¾¾åˆ°è´Ÿè½½å‡è¡¡çš„ç›®çš„ï¼Œä»è€Œé™ä½æŸä¸ªæœåŠ¡çš„å‹åŠ›ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/666017070">Nginx æ˜¯å¦‚ä½•è§£å†³æƒŠç¾¤æ•ˆåº”çš„ï¼Ÿ</a></li><li><a href="https://blog.csdn.net/lyztyycode/article/details/78648798">LinuxæƒŠç¾¤æ•ˆåº”è¯¦è§£</a></li></ul>]]></content>
    
    
    <summary type="html">ä¸€ç¯‡è®©æˆ‘æƒ³èµ·åœ¨å­¦æ ¡å–‚å¤©é¹…çš„æ•…äº‹</summary>
    
    
    
    <category term="Cpp" scheme="https://penge666.github.io/categories/Cpp/"/>
    
    
    <category term="Cpp" scheme="https://penge666.github.io/tags/Cpp/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://penge666.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="Linux" scheme="https://penge666.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>HTTPå­¦ä¹ ç¬”è®°</title>
    <link href="https://penge666.github.io/posts/f5ef6bcf.html"/>
    <id>https://penge666.github.io/posts/f5ef6bcf.html</id>
    <published>2024-04-29T14:56:09.000Z</published>
    <updated>2024-05-15T12:36:31.831Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ—¶åŠ¿é€ è‹±é›„ï¼Œè‹±é›„äº¦é€ æ—¶åŠ¿</strong></p><p>å¥½æ–‡æ”¶é›†</p><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP">HTTP</a></li></ul><p>å…¨å±€è®¤è¯†</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240514215632960.png" alt="image-20240514215632960"></p><h2 id="HTTP">HTTP</h2><h3 id="HTTPå‘å±•å²">HTTPå‘å±•å²</h3><ul><li><p>HTTP åè®®å§‹äºä¸‰åå¹´å‰è’‚å§†Â·ä¼¯çº³æ–¯ - æçš„ä¸€ç¯‡è®ºæ–‡ï¼›</p><p>è®ºæ–‡ä¸­ä»–ç¡®ç«‹äº†ä¸‰é¡¹å…³é”®æŠ€æœ¯</p><ul><li>URIï¼šå³ç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼Œä½œä¸ºäº’è”ç½‘ä¸Šèµ„æºçš„å”¯ä¸€èº«ä»½ï¼›</li><li>HTMLï¼šå³è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼Œæè¿°è¶…æ–‡æœ¬æ–‡æ¡£ï¼›</li><li>HTTPï¼šå³è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œç”¨æ¥ä¼ è¾“è¶…æ–‡æœ¬ï¼›</li></ul></li><li><p>HTTP/0.9 æ˜¯ä¸ªç®€å•çš„æ–‡æœ¬åè®®ï¼Œåªèƒ½è·å–æ–‡æœ¬èµ„æºï¼›</p><p>è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /mypage.html</span><br></pre></td></tr></table></figure><p>å“åº”</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ HTML é¡µé¢</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></li><li><p>HTTP/1.0 ç¡®ç«‹äº†å¤§éƒ¨åˆ†ç°åœ¨ä½¿ç”¨çš„æŠ€æœ¯ï¼Œä½†å®ƒä¸æ˜¯æ­£å¼æ ‡å‡†ï¼›</p><ul><li>å¢åŠ äº† HEADã€POST ç­‰æ–°æ–¹æ³•ï¼›</li><li>å¢åŠ äº†å“åº”çŠ¶æ€ç ï¼Œæ ‡è®°å¯èƒ½çš„é”™è¯¯åŸå› ï¼›</li><li>å¼•å…¥äº†åè®®ç‰ˆæœ¬å·æ¦‚å¿µï¼›</li><li>å¼•å…¥äº† HTTP Headerï¼ˆå¤´éƒ¨ï¼‰çš„æ¦‚å¿µï¼Œè®© HTTP å¤„ç†è¯·æ±‚å’Œå“åº”æ›´åŠ çµæ´»ï¼›</li><li>ä¼ è¾“çš„æ•°æ®ä¸å†ä»…é™äºæ–‡æœ¬ã€‚</li></ul></li><li><p>HTTP/1.1 æ˜¯ç›®å‰äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¹¿æ³›çš„åè®®ï¼ŒåŠŸèƒ½ä¹Ÿéå¸¸å®Œå–„ï¼›</p><ul><li>å¢åŠ äº† PUTã€DELETE ç­‰æ–°çš„æ–¹æ³•ï¼›</li><li>å¢åŠ äº†ç¼“å­˜ç®¡ç†å’Œæ§åˆ¶ï¼›</li><li>æ˜ç¡®äº†è¿æ¥ç®¡ç†ï¼Œå…è®¸æŒä¹…è¿æ¥ï¼›</li><li>å…è®¸å“åº”æ•°æ®åˆ†å—ï¼ˆchunkedï¼‰ï¼Œåˆ©äºä¼ è¾“å¤§æ–‡ä»¶ï¼›</li><li>å¼ºåˆ¶è¦æ±‚ Host å¤´ï¼Œè®©äº’è”ç½‘ä¸»æœºæ‰˜ç®¡æˆä¸ºå¯èƒ½ã€‚</li></ul></li><li><p>HTTP/2 åŸºäº Google çš„ SPDY åè®®ï¼Œæ³¨é‡æ€§èƒ½æ”¹å–„ï¼Œä½†è¿˜æœªæ™®åŠï¼›</p><ul><li>äºŒè¿›åˆ¶åè®®ï¼Œä¸å†æ˜¯çº¯æ–‡æœ¬ï¼›</li><li>å¯å‘èµ·å¤šä¸ªè¯·æ±‚ï¼ŒåºŸå¼ƒäº† 1.1 é‡Œçš„ç®¡é“ï¼›</li><li>ä½¿ç”¨ä¸“ç”¨ç®—æ³•å‹ç¼©å¤´éƒ¨ï¼Œå‡å°‘æ•°æ®ä¼ è¾“é‡ï¼›</li><li>å…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼›</li><li>å¢å¼ºäº†å®‰å…¨æ€§ï¼Œâ€œäº‹å®ä¸Šâ€è¦æ±‚åŠ å¯†é€šä¿¡ã€‚</li></ul></li><li><p>HTTP/3 åŸºäº Google çš„ QUIC åè®®ï¼Œæ˜¯å°†æ¥çš„å‘å±•æ–¹å‘ã€‚</p></li></ul><h3 id="ç®€å•è¯´ä¸€ä¸‹HTTP">ç®€å•è¯´ä¸€ä¸‹HTTP</h3><p>ï¼ˆ1ï¼‰<strong>HTTP</strong>ï¼š<strong>è¶…â½‚æœ¬ä¼ è¾“åè®®ï¼ˆHyperText Transfer Protocolï¼‰ï¼Œ<strong>ç”¨äºè¶…æ–‡æœ¬ä¼ è¾“ï¼Œä½¿ç”¨</strong>TCP</strong>ã€‚</p><p>ï¼ˆ2ï¼‰<strong>è¶…æ–‡æœ¬</strong>ï¼šå³<strong>è¶…è¶Šäº†æ™®é€šæ–‡æœ¬çš„æ–‡æœ¬</strong>ï¼Œå®ƒæ˜¯â½‚å­—ã€å›¾â½šã€è§†é¢‘ç­‰çš„æ··åˆä½“ï¼Œå…·å¤‡<strong>è¶…é“¾æ¥</strong>ï¼Œèƒ½ä»â¼€ä¸ªè¶…â½‚æœ¬è·³è½¬åˆ°å¦å¤–â¼€ä¸ªè¶…â½‚æœ¬ã€‚</p><p>ï¼ˆ3ï¼‰<strong>HTMLï¼šè¶…æ–‡æœ¬æ ‡è®°è¯­è¨€</strong>ï¼Œæ˜¯ä¸€ç§æ ‡è¯†æ€§çš„è¯­è¨€ã€‚<strong>HTML æ–‡æœ¬æ˜¯ç”± HTML å‘½ä»¤ç»„æˆçš„æè¿°æ€§æ–‡æœ¬ï¼Œæ˜¯æœ€å¸¸è§çš„è¶…æ–‡æœ¬</strong>ã€‚</p><p>ï¼ˆ4ï¼‰<strong>URL</strong>ï¼šHTTPä½¿ç”¨<strong>ç»Ÿä¸€èµ„æºå®šä½ç¬¦</strong>ï¼ˆURLï¼‰æ¥æ ‡è¯†ä¸å®šä½æœåŠ¡å™¨ä¸Šçš„èµ„æºï¼Œå¦‚å¸¸è§çš„ç½‘å€ã€‚</p><p>ï¼ˆ5ï¼‰ <strong>æµè§ˆå™¨</strong>ï¼šæµè§ˆå™¨ï¼ˆWeb Broserï¼‰ï¼Œæ˜¯æ£€ç´¢ã€æŸ¥çœ‹äº’è”ç½‘ä¸Šç½‘é¡µèµ„æºçš„åº”ç”¨ç¨‹åºï¼Œæ˜¯ä½¿ç”¨ HTTP åè®®çš„<strong>ä¸»è¦è½½ä½“</strong>ã€‚</p><p>ï¼ˆ6ï¼‰<strong>HTTP åè®®ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡</strong>ã€‚ç”¨æˆ·åœ¨å®¢æˆ·ç«¯ä½¿ç”¨æµè§ˆå™¨ï¼Œé€šè¿‡ç‚¹å‡»è¶…é“¾æ¥æˆ–è€…è¾“å…¥URLæ¥è·å–HTTPæœåŠ¡å™¨ä¸Šçš„èµ„æºï¼Œè¿™äº›èµ„æºé€šè¿‡HTTPåè®®ä¼ é€ç»™å®¢æˆ·ç«¯ã€‚</p><p><strong>ç‰¹ç‚¹</strong></p><ol><li>HTTP æ˜¯çµæ´»å¯æ‰©å±•çš„ï¼Œå¯ä»¥ä»»æ„æ·»åŠ å¤´å­—æ®µå®ç°ä»»æ„åŠŸèƒ½ï¼›</li><li>HTTP æ˜¯å¯é ä¼ è¾“åè®®ï¼ŒåŸºäº TCP/IP åè®®â€œå°½é‡â€ä¿è¯æ•°æ®çš„é€è¾¾ï¼›</li><li>HTTP æ˜¯åº”ç”¨å±‚åè®®ï¼Œæ¯” FTPã€SSH ç­‰æ›´é€šç”¨åŠŸèƒ½æ›´å¤šï¼Œèƒ½å¤Ÿä¼ è¾“ä»»æ„æ•°æ®ï¼›</li><li>HTTP ä½¿ç”¨äº†è¯·æ±‚ - åº”ç­”æ¨¡å¼ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¢«åŠ¨å›å¤è¯·æ±‚ï¼›</li><li>HTTP æ˜¯æœ‰è¿æ¥æ— çŠ¶æ€ï¼Œé¡ºåºå‘åŒ…é¡ºåºæ”¶åŒ…ï¼ŒæŒ‰ç…§æ”¶å‘çš„é¡ºåºç®¡ç†æŠ¥æ–‡ã€‚</li></ol><p><strong>è§£é‡Šæ— çŠ¶æ€</strong></p><p>é€šä¿—è§£é‡Š</p><p>Firstï¼Œæµè§ˆå™¨å‘äº†ä¸€ä¸ªè¯·æ±‚ï¼Œè¯´â€œæˆ‘æ˜¯å°æ˜ï¼Œè¯·ç»™æˆ‘ A æ–‡ä»¶ã€‚â€ï¼ŒæœåŠ¡å™¨æ”¶åˆ°æŠ¥æ–‡åå°±ä¼šæ£€æŸ¥ä¸€ä¸‹æƒé™ï¼Œçœ‹å°æ˜ç¡®å®å¯ä»¥è®¿é—® A æ–‡ä»¶ï¼Œäºæ˜¯æŠŠæ–‡ä»¶å‘å›ç»™æµè§ˆå™¨ã€‚</p><p>Secondï¼Œæµè§ˆå™¨è¿˜æƒ³è¦ B æ–‡ä»¶ï¼Œç”±äºæ— çŠ¶æ€ï¼ŒæœåŠ¡å™¨ä¸ä¼šè®°å½•åˆšæ‰çš„è¯·æ±‚çŠ¶æ€ï¼Œä¸çŸ¥é“ç¬¬äºŒä¸ªè¯·æ±‚å’Œç¬¬ä¸€ä¸ªè¯·æ±‚æ˜¯åŒä¸€ä¸ªæµè§ˆå™¨å‘æ¥çš„ï¼Œæ‰€ä»¥æµè§ˆå™¨å¿…é¡»è¿˜å¾—é‡å¤ä¸€æ¬¡è‡ªå·±çš„èº«ä»½æ‰è¡Œï¼šâ€œæˆ‘æ˜¯åˆšæ‰çš„å°æ˜ï¼Œè¯·å†ç»™æˆ‘ B æ–‡ä»¶ã€‚</p><h3 id="URIå’ŒURLçš„åŒºåˆ«">URIå’ŒURLçš„åŒºåˆ«</h3><p>(1) <strong>URIï¼šç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼ˆuniform resource identifierï¼‰ï¼Œç”¨æ¥åœ¨Webä¸Šæ ‡è¯†ä¸€ä¸ªèµ„æº</strong>ã€‚Webä¸Šçš„å¯ç”¨èµ„æºï¼Œå¦‚HTMLæ–‡æ¡£ã€å›¾åƒã€è§†é¢‘ç‰‡æ®µã€ç¨‹åºç­‰éƒ½æ˜¯ç”¨URIæ¥å®šä½çš„ã€‚</p><p>(2) <strong>URLï¼šç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼ˆuniform resource locatorï¼‰ï¼Œå®ƒæ˜¯ä¸€ç§å…·ä½“çš„URI</strong>ï¼Œå³URLå¯ä»¥ç”¨æ¥<strong>æ ‡è¯†ä¸€ä¸ªèµ„æº</strong>ï¼Œè€Œä¸”è¿˜æŒ‡æ˜äº†å¦‚ä½•<strong>å®šä½è¿™ä¸ªèµ„æº</strong>ã€‚URLä¸€èˆ¬ç”±ä¸‰éƒ¨ç»„æˆï¼š</p><ul><li><p><strong>åè®®(æˆ–ç§°ä¸ºæœåŠ¡æ–¹å¼)</strong></p></li><li><p><strong>å­˜æœ‰è¯¥èµ„æºçš„ä¸»æœºIPåœ°å€(æœ‰æ—¶ä¹ŸåŒ…æ‹¬ç«¯å£å·)</strong></p></li><li><p><strong>ä¸»æœºèµ„æºçš„å…·ä½“åœ°å€ã€‚å¦‚ç›®å½•å’Œæ–‡ä»¶åç­‰</strong>ã€‚</p></li></ul><p>è¡¥å……ï¼šURNï¼šUniform Resource Nameï¼Œç»Ÿä¸€èµ„æºåç§°ã€‚</p><p>è®°ä½ï¼š</p><p>URL ä¸€å®šæ˜¯ URI<br>URL + URN å°±æ˜¯ URI</p><ul><li><a href="https://xie.infoq.cn/article/16baba28f0df19d70d00d4604">https://xie.infoq.cn/article/16baba28f0df19d70d00d4604</a></li></ul><h3 id="HTTP-æŠ¥æ–‡å’Œç»„æˆæ ¼å¼">HTTP æŠ¥æ–‡å’Œç»„æˆæ ¼å¼</h3><p>(1) HTTP æŠ¥æ–‡ä¸»è¦ç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆï¼š</p><p>â‘ ã€€<strong>èµ·å§‹è¡Œï¼ˆstart lineï¼‰ï¼š<strong>æè¿°è¯·æ±‚æˆ–å“åº”çš„</strong>åŸºæœ¬ä¿¡æ¯</strong>ï¼›</p><p>â‘¡ã€€<strong>å¤´éƒ¨å­—æ®µï¼ˆheaderï¼‰ï¼š<strong>ä½¿ç”¨ key-value å½¢å¼</strong>æ›´è¯¦ç»†åœ°è¯´æ˜æŠ¥æ–‡</strong>ï¼›</p><p>â‘¢ã€€<strong>æ¶ˆæ¯æ­£æ–‡ï¼ˆentityï¼‰</strong>ï¼šå®é™…ä¼ è¾“çš„æ•°æ®ï¼Œå®ƒä¸ä¸€å®šæ˜¯çº¯æ–‡æœ¬ï¼Œå¯ä»¥æ˜¯å›¾ç‰‡ã€è§†é¢‘ç­‰äºŒè¿›åˆ¶æ•°æ®ã€‚</p><p>(2) å…¶ä¸­<strong>èµ·å§‹è¡Œå’Œå¤´éƒ¨å­—æ®µ</strong>å¹¶ç§°ä¸º<strong>è¯·æ±‚å¤´æˆ–è€…å“åº”å¤´</strong>ï¼Œç»Ÿç§°ä¸º <strong>Heade</strong>rï¼›<strong>æ¶ˆæ¯æ­£æ–‡</strong>ä¹Ÿå«åšå®ä½“ï¼Œç§°ä¸º <strong>body</strong>ã€‚</p><p>(3) <strong>HTTP åè®®è§„å®šæ¯æ¬¡å‘é€çš„æŠ¥æ–‡å¿…é¡»è¦æœ‰ Headerï¼Œä½†æ˜¯å¯ä»¥æ²¡æœ‰ body</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´å¤´éƒ¨ä¿¡æ¯æ˜¯å¿…é¡»çš„ï¼Œå®ä½“ä¿¡æ¯å¯ä»¥æ²¡æœ‰ã€‚<strong>è€Œä¸”åœ¨ Header å’Œ body ä¹‹é—´å¿…é¡»è¦æœ‰ä¸€ä¸ªç©ºè¡Œï¼ˆCRLFï¼‰ã€‚</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515105317326.png" alt="image-20240515105317326"></p><p>(4) HTTPæœ‰ä¸¤ç§æŠ¥æ–‡ï¼š<strong>è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡</strong></p><p>è¯·æ±‚æŠ¥æ–‡</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515105526308.png" alt="image-20240515105526308"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1     </span><br><span class="line">Host: www.baidu.com</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">sec-ch-ua: <span class="string">&quot; Not A;Brand&quot;</span>;v=<span class="string">&quot;99&quot;</span>, <span class="string">&quot;Chromium&quot;</span>;v=<span class="string">&quot;96&quot;</span>, <span class="string">&quot;Google Chrome&quot;</span>;v=<span class="string">&quot;96&quot;</span></span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">sec-ch-ua-platform: <span class="string">&quot;macOS&quot;</span></span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Sec-Fetch-Site: none</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Cookie: BIDUPSID=8B0207CE0B6364E5934651E84F17999B; PSTM=1619707475; </span><br></pre></td></tr></table></figure><ol><li><strong>GET / HTTP/1.1</strong>ï¼šè¿™æ˜¯è¯·æ±‚è¡Œï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å¸Œæœ›ä½¿ç”¨HTTP/1.1åè®®ï¼Œé€šè¿‡GETæ–¹æ³•è·å–æœåŠ¡å™¨æ ¹ç›®å½•(â€œ/â€)çš„èµ„æºã€‚</li><li><strong>Host: <a href="https://www.baidu.com/">www.baidu.com</a></strong>ï¼šè¿™æ˜¯è¯·æ±‚å¤´çš„ä¸€éƒ¨åˆ†ï¼ŒæŒ‡å®šäº†è¯·æ±‚çš„ç›®æ ‡æœåŠ¡å™¨çš„ä¸»æœºåã€‚</li><li><strong>Connection: keep-alive</strong>ï¼šè¿™è¡¨ç¤ºå®¢æˆ·ç«¯å¸Œæœ›æœåŠ¡å™¨ä¿æŒè¿æ¥ï¼Œä»¥ä¾¿åç»­è¯·æ±‚å¯ä»¥å¤ç”¨è¿™ä¸ªè¿æ¥ã€‚</li><li><strong>Cache-Control: max-age=0</strong>ï¼šè¿™æ˜¯å‘Šè¯‰æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯ä¸æ¥å—è¶…è¿‡0ç§’çš„å“åº”ã€‚ã€è®¾ç½®ç¼“å­˜ç”¨çš„ã€‘</li><li><strong>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</strong>ï¼šè¿™è¡¨ç¤ºå®¢æˆ·ç«¯èƒ½æ¥å—çš„å“åº”ç±»å‹ã€‚</li><li><strong>Accept-Encoding: gzip, deflate, br</strong>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯å¯ä»¥æ¥å—çš„ç¼–ç ç±»å‹ã€‚</li><li><strong>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</strong>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯æ¥å—çš„è¯­è¨€ç±»å‹ã€‚</li><li><strong>Cookie: BIDUPSID=8B0207CE0B6364E5934651E84F17999B; PSTM=1619707475</strong>ï¼šå®¢æˆ·ç«¯å­˜å‚¨çš„cookieä¿¡æ¯ã€‚</li></ol><p>å“åº”æŠ¥æ–‡</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515105542984.png" alt="image-20240515105542984"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Bdpagetype: 1</span><br><span class="line">Bdqid: 0xfb0d743100040ad2</span><br><span class="line">Cache-Control: private</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Type: text/html;charset=utf-8</span><br><span class="line">Date: Fri, 24 Dec 2021 08:20:44 GMT</span><br><span class="line">Expires: Fri, 24 Dec 2021 08:20:44 GMT</span><br><span class="line">Server: BWS/1.1</span><br><span class="line">Set-Cookie: BDSVRTM=17; path=/</span><br><span class="line">Set-Cookie: BD_HOME=1; path=/</span><br><span class="line">Set-Cookie: H_PS_PSSID=35635_34439_35104_35628_35488_35436_35456_34584_35491_35584_35586_34873_35317_26350_35610_35562; path=/; domain=.baidu.com</span><br><span class="line">Strict-Transport-Security: max-age=172800</span><br><span class="line">Traceid: 1640334044050133761018090243032019634898</span><br><span class="line">X-Frame-Options: sameorigin</span><br><span class="line">X-Ua-Compatible: IE=Edge,chrome=1</span><br><span class="line">Transfer-Encoding: chunked</span><br></pre></td></tr></table></figure><ul><li><strong>Cache-Control: private</strong>ï¼šâ€œprivateâ€è¡¨ç¤ºç¼“å­˜åªèƒ½åœ¨å®¢æˆ·ç«¯ä¿å­˜ï¼Œæ˜¯ç”¨æˆ·â€œç§æœ‰â€çš„ï¼Œä¸èƒ½æ”¾åœ¨ä»£ç†ä¸Šä¸åˆ«äººå…±äº«ã€‚è€Œâ€œpublicâ€çš„æ„æ€å°±æ˜¯ç¼“å­˜å®Œå…¨å¼€æ”¾ï¼Œè°éƒ½å¯ä»¥å­˜ï¼Œè°éƒ½å¯ä»¥ç”¨ã€‚</li></ul><h3 id="å¸¸è§çš„HTTPè¯·æ±‚æ–¹æ³•">å¸¸è§çš„HTTPè¯·æ±‚æ–¹æ³•</h3><p><strong>å¿…é¡»æ˜¯å¤§å†™çš„å½¢å¼</strong></p><p>(1) <strong>HTTPè¯·æ±‚æ–¹æ³•æ˜¯è¯·æ±‚æŠ¥æ–‡çš„è¯·æ±‚è¡Œçš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œå†³å®šæ­¤æ¬¡è¯·æ±‚çš„ç±»å‹</strong>ã€‚</p><p>(2) HTTP1.0 å®šä¹‰äº†ä¸‰ç§è¯·æ±‚æ–¹æ³•ï¼š <strong>GET, POST å’Œ HEADæ–¹æ³•</strong>ã€‚</p><p>(3) HTTP1.1 æ–°å¢äº†å…­ç§è¯·æ±‚æ–¹æ³•ï¼š<strong>OPTIONSã€PUTã€PATCHã€DELETEã€TRACE å’Œ CONNECT æ–¹æ³•</strong>ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515105937803.png" alt="image-20240515105937803"></p><h3 id="è¯·æ±‚æ–¹æ³•ä¸­çš„å®‰å…¨ä¸å¹‚ç­‰">è¯·æ±‚æ–¹æ³•ä¸­çš„å®‰å…¨ä¸å¹‚ç­‰</h3><p>å®‰å…¨ï¼šä¸ä¼šå¯¹æœåŠ¡å™¨ä¸Šçš„èµ„æºé€ æˆå®è´¨çš„ä¿®æ”¹ã€‚ã€GETå’ŒHEADã€‘</p><p>å¹‚ç­‰ï¼šå¤šæ¬¡æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œç»“æœä¹Ÿéƒ½æ˜¯ç›¸åŒçš„ã€‚</p><p>GET å’Œ HEAD æ—¢æ˜¯å®‰å…¨çš„ä¹Ÿæ˜¯å¹‚ç­‰çš„ï¼ŒDELETE å¯ä»¥å¤šæ¬¡åˆ é™¤åŒä¸€ä¸ªèµ„æºï¼Œæ•ˆæœéƒ½æ˜¯â€œèµ„æºä¸å­˜åœ¨â€ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å¹‚ç­‰çš„ã€‚</p><p>Noteï¼šPUTæ˜¯å¹‚ç­‰ï¼ŒPOST ä¸æ˜¯ã€‚</p><p>POST æ˜¯â€œæ–°å¢æˆ–æäº¤æ•°æ®â€ï¼Œå¤šæ¬¡æäº¤æ•°æ®ä¼šåˆ›å»ºå¤šä¸ªèµ„æºï¼Œæ‰€ä»¥ä¸æ˜¯å¹‚ç­‰çš„ï¼›è€Œ PUT æ˜¯â€œæ›¿æ¢æˆ–æ›´æ–°æ•°æ®â€ï¼Œå¤šæ¬¡æ›´æ–°ä¸€ä¸ªèµ„æºï¼Œèµ„æºè¿˜æ˜¯ä¼šç¬¬ä¸€æ¬¡æ›´æ–°çš„çŠ¶æ€ï¼Œæ‰€ä»¥æ˜¯å¹‚ç­‰çš„ã€‚</p><h3 id="å¸¸è§çš„HTTPçŠ¶æ€ç ">å¸¸è§çš„HTTPçŠ¶æ€ç </h3><p>(1) <strong>çŠ¶æ€ç ç”±ä¸‰ä½æ•°å­—ç»„æˆï¼Œç¬¬ä¸€ä¸ªæ•°å­—å®šä¹‰äº†å“åº”çš„ç±»åˆ«ï¼Œå…±åˆ†äº”ç§ç±»åˆ«</strong>:</p><p>â‘ ã€€<strong>1xxï¼šæŒ‡ç¤ºä¿¡æ¯</strong> â€“ è¡¨ç¤ºè¯·æ±‚å·²æ¥æ”¶ï¼Œç»§ç»­ä¸‹ä¸€æ­¥å¤„ç†</p><p>â‘¡ã€€<strong>2xxï¼šæˆåŠŸ</strong> â€“ è¡¨ç¤ºè¯·æ±‚å·²æˆåŠŸå¤„ç†</p><p>â‘¢ã€€<strong>3xxï¼šé‡å®šå‘</strong>  â€“  è¡¨ç¤ºéœ€è¦æ›´æ”¹è¯·æ±‚å¯¹è±¡</p><p>â‘£ã€€<strong>4xxï¼šå®¢æˆ·ç«¯é”™è¯¯</strong> â€“ è¯·æ±‚æœ‰é”™è¯¯</p><p>â‘¤ã€€<strong>5xxï¼šæœåŠ¡å™¨ç«¯é”™è¯¯</strong> â€“ æœåŠ¡å™¨æœªèƒ½å®ç°åˆæ³•çš„è¯·æ±‚</p><p>(2) ä¸‹é¢æ¥è¯´ä¸€äº›æ¯”è¾ƒå¸¸è§çš„çŠ¶æ€ç </p><p>â‘ ã€€<strong>ã€Œ100 Continueã€</strong>ï¼šåˆå§‹çš„è¯·æ±‚å·²ç»æ¥å—ï¼Œ<strong>å®¢æˆ·åº”å½“ç»§ç»­å‘é€è¯·æ±‚çš„å…¶ä½™éƒ¨åˆ†</strong></p><p>â‘¡ã€€<strong>ã€Œ200 OKã€</strong>ï¼š è¡¨ç¤º<strong>â¼€åˆ‡æ­£å¸¸</strong>ã€‚</p><p>â‘¢ã€€<strong>ã€Œ204 No Contentã€</strong>ï¼šä¹Ÿæ˜¯å¸¸è§çš„æˆåŠŸçŠ¶æ€ç ï¼Œ<strong>ä½†å“åº”å¤´æ²¡æœ‰ body æ•°æ®</strong>ã€‚</p><p>â‘£ã€€<strong>ã€Œ206 Partial Contentã€</strong>ï¼š<strong>åº”ç”¨äº HTTP åˆ†å—ä¸‹è½½æˆ–æ–­ç‚¹ç»­ä¼ </strong>ï¼Œè¡¨ç¤ºå“åº”è¿”å›çš„ body æ•°æ®å¹¶ä¸æ˜¯èµ„æºçš„å…¨éƒ¨ï¼Œâ½½æ˜¯å…¶ä¸­çš„â¼€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœåŠ¡å™¨å¤„ç†æˆåŠŸçš„çŠ¶æ€ã€‚</p><p>â‘¤ã€€<strong>ã€Œ301 Moved Permanentlyã€</strong>ï¼š<strong>è¡¨ç¤ºæ°¸ä¹…é‡å®šå‘</strong>ï¼Œè¯´æ˜èµ„æºä¸å­˜åœ¨äº†ï¼Œéœ€â½¤æ–°çš„URLè®¿é—®ã€‚</p><p>â‘¥ã€€<strong>ã€Œ302 Foundã€</strong>ï¼š<strong>è¡¨ç¤ºä¸´æ—¶é‡å®šå‘</strong>ï¼Œè¯´æ˜èµ„æºè¿˜åœ¨ï¼Œä½†æš‚æ—¶è¦ç”¨å¦â¼€ä¸ªURLæ¥è®¿é—®ã€‚</p><p>â‘¦ã€€<strong>ã€Œ304 Not Modifiedã€</strong>ï¼š<strong>ä¸å…·æœ‰è·³è½¬çš„å«ä¹‰</strong>ï¼Œè¡¨ç¤ºèµ„æºæœªä¿®æ”¹ï¼Œ<strong>é‡å®šå‘å·²å­˜åœ¨çš„ç¼“å†²â½‚ä»¶</strong>ï¼Œä¹Ÿç§°ç¼“å­˜é‡å®šå‘ï¼Œâ½¤äºç¼“å­˜æ§åˆ¶ã€‚</p><p>â‘§ã€€<strong>ã€Œ400 Bad Requestã€</strong>ï¼š<strong>è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„æŠ¥â½‚æœ‰é”™è¯¯</strong>ï¼Œä½†åªæ˜¯ä¸ªç¬¼ç»Ÿçš„é”™è¯¯ã€‚</p><p>â‘¨ã€€<strong>ã€Œ401 Unauthorizedã€</strong>ï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºå‘é€çš„<strong>è¯·æ±‚éœ€è¦æœ‰è®¤è¯ä¿¡æ¯</strong></p><p>â‘©ã€€<strong>ã€Œ403 Forbiddenã€</strong>ï¼šè¡¨ç¤º<strong>æœåŠ¡å™¨ç¦â½Œè®¿é—®èµ„æº</strong>ï¼Œå¹¶ä¸æ˜¯å®¢æˆ·ç«¯çš„è¯·æ±‚å‡ºé”™ã€‚</p><p>â‘ªã€€<strong>ã€Œ404 Not Foundã€</strong>ï¼šè¡¨ç¤º<strong>è¯·æ±‚çš„èµ„æºåœ¨æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨æˆ–æœªæ‰¾åˆ°</strong>ã€‚</p><p>â‘«ã€€<strong>ã€Œ500 Internal Server Errorã€</strong>ï¼šä¸ 400 ç±»å‹ï¼Œæ˜¯ä¸ªç¬¼ç»Ÿé€šâ½¤çš„é”™è¯¯ç ï¼ŒæœåŠ¡å™¨å‘â½£äº†ä»€ä¹ˆé”™è¯¯ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ã€‚</p><p>â‘¬ã€€<strong>ã€Œ501 Not Implementedã€</strong>ï¼šè¡¨ç¤º<strong>å®¢æˆ·ç«¯è¯·æ±‚çš„åŠŸèƒ½è¿˜ä¸â½€æŒ</strong>ï¼Œç±»ä¼¼â€œå³å°†å¼€ä¸šï¼Œæ•¬è¯·æœŸå¾…â€çš„æ„æ€ã€‚</p><p>â‘­ã€€<strong>ã€Œ502 Bad Gatewayã€</strong>ï¼š<strong>é€šå¸¸æ˜¯æœåŠ¡å™¨ä½œä¸ºç½‘å…³æˆ–ä»£ç†æ—¶è¿”å›çš„é”™è¯¯ç </strong>ï¼Œè¡¨ç¤ºæœåŠ¡å™¨â¾ƒèº«â¼¯ä½œæ­£å¸¸ï¼Œè®¿é—®åç«¯æœåŠ¡å™¨å‘â½£äº†é”™è¯¯ã€‚</p><p>â‘®ã€€<strong>ã€Œ503 Service Unavailableã€</strong>ï¼š<strong>è¡¨ç¤ºæœåŠ¡å™¨å½“å‰å¾ˆå¿™</strong>ï¼Œæš‚æ—¶â½†æ³•å“åº”æœåŠ¡å™¨ï¼Œç±»ä¼¼â€œâ½¹ç»œæœåŠ¡æ­£å¿™ï¼Œè¯·ç¨åé‡è¯•â€çš„æ„æ€ã€‚</p><h3 id="HTTPé•¿è¿æ¥å’ŒçŸ­è¿æ¥">HTTPé•¿è¿æ¥å’ŒçŸ­è¿æ¥</h3><p>(1) <strong>åœ¨HTTP/1.0ä¸­é»˜è®¤ä½¿ç”¨çŸ­è¿æ¥</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ¯è¿›è¡Œä¸€æ¬¡HTTPæ“ä½œï¼Œå°±å»ºç«‹ä¸€æ¬¡TCPè¿æ¥ï¼Œä»»åŠ¡ç»“æŸå°±ä¸­æ–­TCPè¿æ¥ã€‚</p><p>(2) <strong>ä»HTTP/1.1èµ·ï¼Œé»˜è®¤ä½¿ç”¨é•¿è¿æ¥</strong>ï¼Œåªè¦å®¢æˆ·ç«¯æœåŠ¡ç«¯ä»»æ„ä¸€ç«¯æ²¡æœ‰æ˜ç¡®æå‡ºæ–­å¼€TCPè¿æ¥ï¼Œå°±ä¸€ç›´ä¿æŒè¿æ¥ã€‚</p><p>å¤´éƒ¨å­—æ ·ï¼š<strong>Connection: keep-alive</strong></p><h3 id="è½¬å‘å’Œé‡å®šå‘">è½¬å‘å’Œé‡å®šå‘</h3><ul><li><a href="https://blog.csdn.net/m0_45899013/article/details/106928429#:~:text=%E9%87%8D%E5%AE%9A%E5%90%91%20%28Redirect%29%E5%B0%B1%E6%98%AF%E9%80%9A%E8%BF%87%E5%90%84%E7%A7%8D%E6%96%B9%E6%B3%95,%E5%B0%86%E5%90%84%E7%A7%8D%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E9%87%8D%E6%96%B0%E5%AE%9A%E4%B8%AA%E6%96%B9%E5%90%91%E8%BD%AC%E5%88%B0%E5%85%B6%E5%AE%83%E4%BD%8D%E7%BD%AE%20%EF%BC%88%E5%A6%82%EF%BC%9A%E7%BD%91%E9%A1%B5%E9%87%8D%E5%AE%9A%E5%90%91%E3%80%81%E5%9F%9F%E5%90%8D%E7%9A%84%E9%87%8D%E5%AE%9A%E5%90%91%E3%80%81%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9%E7%9A%84%E5%8F%98%E5%8C%96%E4%B9%9F%E6%98%AF%E5%AF%B9%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%96%87%E7%BB%8F%E7%94%B1%E8%B7%AF%E5%BE%84%E7%9A%84%E4%B8%80%E7%A7%8D%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%89%E3%80%82">è½¬å‘å’Œé‡å®šå‘ï¼ˆå®Œæ•´ç†è§£åŠæ€»ç»“ï¼‰</a></li><li><a href="https://zhuanlan.zhihu.com/p/604721025">é¢è¯•å®˜ï¼šè¯·æ±‚è½¬å‘å’Œè¯·æ±‚é‡å®šå‘æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</a></li></ul><h3 id="è¯´è¯´Cookieå’ŒSession">è¯´è¯´Cookieå’ŒSession</h3><p>(1) <strong>Cookie</strong>ï¼š</p><p>â‘ ã€€ç”±äº<strong>HTTPæ˜¯æ— çŠ¶æ€çš„</strong>ï¼ŒæœåŠ¡å™¨ä¸ä¼šå»è®°å¿†å®¢æˆ·ç«¯çš„çŠ¶æ€ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–çš„èµ„æºæ¥è®°å½•çŠ¶æ€ä¿¡æ¯ï¼Œè¿™èƒ½<strong>å‡è½»æœåŠ¡å™¨çš„è´Ÿæ‹…ï¼Œèƒ½å¤ŸæŠŠæ›´å¤šçš„ CPU å’Œå†…å­˜â½¤æ¥å¯¹å¤–æä¾›æœåŠ¡</strong>ã€‚</p><p>â‘¡ã€€<strong>ä½†ä¹Ÿå› ä¸ºæ— çŠ¶æ€ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è®°å¿†èƒ½â¼’ï¼Œå®ƒåœ¨å®Œæˆæœ‰å…³è”æ€§çš„æ“ä½œæ—¶ä¼šâ¾®å¸¸éº»çƒ¦</strong>ã€‚ä¾‹å¦‚ç™»å½•-&gt;æ·»åŠ è´­ç‰©â»‹-&gt;ä¸‹å•-&gt;ç»“ç®—-&gt;â½€ä»˜ï¼Œè¿™äº›æ“ä½œéƒ½è¦çŸ¥é“â½¤æˆ·çš„èº«ä»½æ‰â¾ã€‚ä½†æœåŠ¡å™¨ä¸çŸ¥é“è¿™äº›è¯·æ±‚æ˜¯æœ‰å…³è”çš„ï¼Œæ¯æ¬¡éƒ½è¦é—®â¼€éèº«ä»½ä¿¡æ¯ã€‚</p><p>â‘¢ã€€<strong>ä¸ºäº†è§£å†³æ— çŠ¶æ€å¼•èµ·çš„é—®é¢˜ï¼Œå¼•å…¥äº†cookieæœºåˆ¶</strong>ã€‚Cookie æ˜¯åœ¨å®¢æˆ·ç«¯ç¬¬â¼€æ¬¡è¯·æ±‚åï¼ŒæœåŠ¡å™¨å“åº”æŠ¥æ–‡ä½¿ç”¨ Set-Cookie å­—æ®µå‘é€â€œkey=valueâ€å½¢å¼çš„ Cookie å€¼å‘é€åˆ°ç”¨æˆ·æµè§ˆå™¨å¹¶ä¿å­˜åœ¨æœ¬åœ°çš„ä¸€å°å—æ•°æ®ã€‚å®ƒä¼šåœ¨æµè§ˆå™¨ä¹‹åå‘åŒä¸€æœåŠ¡å™¨å†æ¬¡å‘èµ·è¯·æ±‚æ—¶è¢«æºå¸¦ä¸Šï¼Œç”¨äºå‘ŠçŸ¥æœåŠ¡ç«¯ä¸¤ä¸ªè¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€å®¢æˆ·ç«¯ã€‚ä¸ºäº†ä¿æŠ¤ Cookieï¼Œè¿˜è¦ç»™å®ƒè®¾ç½®æœ‰æ•ˆæœŸã€ä½œç”¨åŸŸç­‰å±æ€§ï¼Œå¸¸ç”¨çš„æœ‰ Max-Ageã€Expiresã€Domainã€HttpOnly ç­‰ï¼›</p><p>â‘£ã€€<strong>Cookieçš„ç”¨é€”</strong>ï¼šä¼šè¯çŠ¶æ€ç®¡ç†ã€ç”¨æˆ·ä¸ªæ€§åŒ–è®¾ç½®ã€æµè§ˆå™¨è¡Œä¸ºè·Ÿè¸ªã€‚</p><p>â‘¤ã€€<strong>Cookieçš„ç¼ºç‚¹</strong>ï¼šæ¯æ¬¡è¯·æ±‚éƒ½ä¼šéœ€è¦æºå¸¦Cookie æ•°æ®ï¼Œå› æ­¤ä¼šå¸¦æ¥<strong>é¢å¤–çš„æ€§èƒ½å¼€é”€</strong>ã€‚Cookieå­˜æ”¾åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œå®¹æ˜“è¢«ç¯¡æ”¹ï¼Œ<strong>ä¸å¤Ÿå®‰å…¨</strong>ã€‚</p><p>(2) <strong>Session</strong>ï¼š</p><p>â‘ ã€€<strong>Sessionå’ŒCookieç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯</strong>ã€‚</p><p>â‘¡ã€€<strong>Session å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œé€šå¸¸å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…å†…å­˜ä¸­</strong>ã€‚</p><p>â‘¢ã€€<strong>Sessionä»¥é”®å€¼å¯¹çš„æ–¹å¼è¿›è¡Œå­˜å‚¨</strong>ï¼Œç”¨æˆ·ä¿¡æ¯å­˜å‚¨äºSessionï¼Œä½¿ç”¨Session IDæ ‡è¯†ã€‚</p><p>â‘£ã€€<strong>åœ¨å®¢æˆ·ç«¯ç™»å½•å®Œæˆä¹‹åï¼ŒæœåŠ¡å™¨ä¼šåˆ›å»ºå¯¹åº”çš„sessionå­˜å‚¨ç”¨æˆ·ä¿¡æ¯</strong>ï¼Œç„¶åæŠŠSession ID å‘é€ç»™å®¢æˆ·ç«¯è¿›è¡Œä¿å­˜ã€‚å®¢æˆ·ç«¯åç»­è®¿é—®æœåŠ¡å™¨æ—¶ä¼šå¸¦ç€Session IDï¼ŒæœåŠ¡å™¨æ‹¿åˆ° Session IDä¹‹åï¼Œåˆ™ä¼šåœ¨ç›¸åº”çš„æ•°æ®ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°å¯¹åº”çš„ session å°±å¯ä»¥ç¡®è®¤ç”¨æˆ·ä¿¡æ¯ã€‚</p><p>â‘¤ã€€<strong>Sessionçš„ç¼ºç‚¹</strong>ï¼šæ‰€æœ‰ç”¨æˆ·çš„æ•°æ®éƒ½å­˜æ”¾åœ¨æœåŠ¡å™¨ï¼Œå®¹æ˜“é€ æˆæœåŠ¡å™¨å‹åŠ›è¿‡å¤§ã€‚</p><h3 id="Cookieå’ŒSessionçš„åŒºåˆ«">Cookieå’ŒSessionçš„åŒºåˆ«</h3><p>(1) <strong>å­˜å‚¨ä½ç½®</strong>ï¼šCookieå­˜æ”¾åœ¨å®¢æˆ·ç«¯ï¼ŒSessionå­˜æ”¾åœ¨æœåŠ¡ç«¯ã€‚</p><p>(2) <strong>å®‰å…¨æ€§</strong>ï¼šCookieå­˜æ”¾åœ¨å®¢æˆ·ç«¯ï¼Œå®¹æ˜“è¢«ç¯¡æ”¹ï¼ŒSessionå­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œæ•°æ®æ¯”è¾ƒå®‰å…¨ã€‚</p><p>(3) <strong>å­˜å‚¨ç±»å‹</strong>ï¼šCookieåªèƒ½å­˜æ”¾å­—ç¬¦ä¸²ï¼ŒSessionå¯å­˜æ”¾å„ç§æ•°æ®ç±»å‹ã€‚</p><p>(4) <strong>ç©ºé—´é™åˆ¶</strong>ï¼šCookieå¤§å°å—é™äºæµè§ˆå™¨ï¼Œsessionå¤§å°å—é™äºç³»ç»Ÿå†…å­˜æˆ–è€…æ•°æ®åº“å¤§å°ã€‚</p><h3 id="Cookieå’ŒSessionçš„é€‚åº”åœºæ™¯">Cookieå’ŒSessionçš„é€‚åº”åœºæ™¯</h3><p>(1) Cookieåªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼ŒSessionåˆ™å¯ä»¥å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œå› æ­¤<strong>åœ¨è€ƒè™‘æ•°æ®å¤æ‚æ€§æ—¶é¦–é€‰ Session</strong>ã€‚</p><p>(2) Cookie å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­ï¼Œå®¹æ˜“è¢«æ¶æ„æŸ¥çœ‹ã€‚Sessionå­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œå­˜å‚¨çš„æ•°æ®æ¯”è¾ƒå®‰å…¨ã€‚å› æ­¤<strong>è€ƒè™‘æ•°æ®å®‰å…¨æ€§æ—¶é¦–é€‰Session</strong>ã€‚</p><p>(3) å¯¹äºå¤§å‹ç½‘ç«™ï¼Œå¦‚æœç”¨æˆ·æ‰€æœ‰çš„ä¿¡æ¯éƒ½å­˜å‚¨åœ¨ Session ä¸­ï¼Œé‚£ä¹ˆå¼€é”€æ˜¯éå¸¸å¤§çš„ï¼Œå› æ­¤<strong>ä¸å»ºè®®å°†æ‰€æœ‰çš„ç”¨æˆ·ä¿¡æ¯éƒ½å­˜å‚¨åˆ° Session ä¸­ï¼Œåº”è¯¥æ˜¯ä¸¤è€…æ··ç”¨</strong>ã€‚</p><h3 id="è°ˆè°ˆä»£ç†">è°ˆè°ˆä»£ç†</h3><p>ä»£ç†å°±æ˜¯å¤šäº†ä¸ªä¸­é—´äººã€‚</p><p><strong>ä½œç”¨</strong></p><ul><li><strong>å¥åº·æ£€æŸ¥</strong>ï¼šä½¿ç”¨â€œå¿ƒè·³â€ç­‰æœºåˆ¶ç›‘æ§åç«¯æœåŠ¡å™¨ï¼Œå‘ç°æœ‰æ•…éšœå°±åŠæ—¶â€œè¸¢å‡ºâ€é›†ç¾¤ï¼Œä¿è¯æœåŠ¡é«˜å¯ç”¨ï¼›</li><li><strong>å®‰å…¨é˜²æŠ¤</strong>ï¼šä¿æŠ¤è¢«ä»£ç†çš„åç«¯æœåŠ¡å™¨ï¼Œé™åˆ¶ IP åœ°å€æˆ–æµé‡ï¼ŒæŠµå¾¡ç½‘ç»œæ”»å‡»å’Œè¿‡è½½ï¼›</li><li><strong>åŠ å¯†å¸è½½</strong>ï¼šå¯¹å¤–ç½‘ä½¿ç”¨ SSL/TLS åŠ å¯†é€šä¿¡è®¤è¯ï¼Œè€Œåœ¨å®‰å…¨çš„å†…ç½‘ä¸åŠ å¯†ï¼Œæ¶ˆé™¤åŠ è§£å¯†æˆæœ¬ï¼›</li><li><strong>æ•°æ®è¿‡æ»¤</strong>ï¼šæ‹¦æˆªä¸Šä¸‹è¡Œçš„æ•°æ®ï¼Œä»»æ„æŒ‡å®šç­–ç•¥ä¿®æ”¹è¯·æ±‚æˆ–è€…å“åº”ï¼›</li><li><strong>å†…å®¹ç¼“å­˜</strong>ï¼šæš‚å­˜ã€å¤ç”¨æœåŠ¡å™¨å“åº”</li></ul><p>ä»£ç†æœåŠ¡å™¨éœ€è¦ä½¿ç”¨å­—æ®µâ€œViaâ€æ ‡è®°è‡ªå·±çš„èº«ä»½ï¼Œå¤šä¸ªä»£ç†ä¼šå½¢æˆä¸€ä¸ªåˆ—è¡¨ï¼›</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515163313460.png" alt="image-20240515163313460"></p><p>å¦‚æœæƒ³è¦çŸ¥é“å®¢æˆ·ç«¯çš„çœŸå® IP åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨å­—æ®µâ€œX-Forwarded-Forâ€å’Œâ€œX-Real-IPâ€ã€‚</p><h3 id="URLé•¿åº¦é™åˆ¶">URLé•¿åº¦é™åˆ¶</h3><p>(1) <strong>å®é™…ä¸ŠHTTPåè®®æ²¡æœ‰å¯¹ä¼ è¾“çš„æ•°æ®å¤§å°è¿›è¡Œé™åˆ¶ï¼Œä¹Ÿæ²¡æœ‰å¯¹URLé•¿åº¦è¿›è¡Œé™åˆ¶</strong>ã€‚</p><p>(2) å¯¹ URL é™åˆ¶çš„å¤§å¤šæ˜¯<strong>æµè§ˆå™¨å’ŒæœåŠ¡å™¨</strong>ã€‚å› ä¸ºå¤„ç†é•¿URLè¦æ¶ˆè€—æ¯”è¾ƒå¤šçš„èµ„æºï¼Œä¸ºäº†è€ƒè™‘æ€§èƒ½å’Œå®‰å…¨ï¼Œä¸¤è€…ä¼šå¯¹URLé•¿åº¦åŠ é™åˆ¶ã€‚</p><h3 id="ä¸€ä¸ª-TCP-è¿æ¥ä¸­å¤šä¸ªHTTP-è¯·æ±‚å¯ä»¥åŒæ—¶å‘é€å—">ä¸€ä¸ª TCP è¿æ¥ä¸­å¤šä¸ªHTTP è¯·æ±‚å¯ä»¥åŒæ—¶å‘é€å—</h3><p>(1) <strong>HTTP1.0</strong>ä¸æ”¯æŒã€‚</p><p>(2) <strong>HTTP1.1</strong>å¯ä»¥å‘é€å¤šä¸ªHTTPè¯·æ±‚ï¼Œä½†æ— æ³•åšåˆ°åŒæ—¶å‘é€ä¸åŒæ—¶å“åº”ã€‚</p><p>(3) <strong>HTTP2.0</strong>å®Œå…¨æ”¯æŒã€‚</p><h3 id="æµè§ˆå™¨å¯¹åŒä¸€åŸŸåå»ºç«‹çš„TCP-è¿æ¥æ•°çš„é™åˆ¶">æµè§ˆå™¨å¯¹åŒä¸€åŸŸåå»ºç«‹çš„TCP è¿æ¥æ•°çš„é™åˆ¶</h3><p>(1) æœ‰ã€‚<strong>Chrome æœ€å¤šå…è®¸å¯¹åŒä¸€ä¸ª Host å»ºç«‹å…­ä¸ª TCP è¿æ¥</strong>ã€‚ä¸åŒçš„æµè§ˆå™¨æœ‰ä¸€äº›åŒºåˆ«ã€‚</p><p>(2) **å»ºç«‹å¤šä¸ªTCPè¿æ¥çš„æ“ä½œå¸¸å‘ç”Ÿåœ¨HTTP1.1ï¼Œ**å› ä¸ºä¸æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œèµ„æºåªèƒ½é¡ºåºåŠ è½½ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç”¨æˆ·ä½“éªŒä¸ä½³ï¼Œå› æ­¤å¸¸ä¼šå¤šå¼€å‡ ä¸ªTCPè¿æ¥æå‡ä¼ è¾“é€Ÿåº¦ã€‚</p><h2 id="HTTPS">HTTPS</h2><h3 id="SSL-TLSåè®®">SSL/TLSåè®®</h3><p>(1) <strong>HTTP ç”±äºæ˜¯æ˜â½‚ä¼ è¾“</strong>ï¼Œæ„å‘³ç€åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„ä¿¡æ¯ï¼Œå¯¹å¤–éƒ¨æ˜¯å®Œå…¨å¯è§çš„ï¼Œå› æ­¤æŠ€æœ¯äººå‘˜å¯ä»¥å¾ˆæ–¹ä¾¿è¿›è¡ŒæŠ“åŒ…è¯»å–æ•°æ®ï¼Œä¸ºæˆ‘ä»¬è°ƒè¯•â¼¯ä½œå¸¦äº†æâ¼¤çš„ä¾¿åˆ©æ€§ã€‚</p><p>(2) æ˜æ–‡ä¼ è¾“æ‰€å¸¦æ¥çš„ç¼ºé™·å°±æ˜¯<strong>ä¸å®‰å…¨</strong>ã€‚åœ¨æ•°æ®å®‰å…¨ä¸Šå­˜åœ¨ä»¥ä¸‹ä¸‰ä¸ªâ»›é™©ï¼š</p><p>â‘ ã€€ä½¿ç”¨æ˜æ–‡è¿›è¡Œé€šä¿¡ï¼Œå†…å®¹å¯èƒ½ä¼šè¢«<strong>çªƒå¬</strong>ï¼›</p><p>â‘¡ã€€ä¸éªŒè¯é€šä¿¡æ–¹çš„èº«ä»½ï¼Œé€šä¿¡æ–¹çš„èº«ä»½æœ‰å¯èƒ½é­é‡<strong>ä¼ªè£…</strong>ï¼›</p><p>â‘¢ã€€æ— æ³•è¯æ˜æŠ¥æ–‡çš„å®Œæ•´æ€§ï¼ŒæŠ¥æ–‡æœ‰å¯èƒ½é­<strong>ç¯¡æ”¹</strong>ã€‚</p><p>(3) ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<strong>åœ¨HTTP ä¸ TCP å±‚ä¹‹é—´åŠ â¼Šäº† SSL/TLS åè®®</strong>ã€‚åé¢å¸¸å°†HTTPä¸SSL/TLSåˆå¹¶ç§°ä¸ºHTTPSã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515173423396.png" alt="image-20240515173423396"></p><p>(4) <strong>SSLï¼šä»£è¡¨å®‰å…¨å¥—æ¥å­—å±‚ï¼ˆSecure Sockets Layerï¼‰</strong>ã€‚å®ƒæ˜¯ä¸€ç§ç”¨äºåŠ å¯†å’ŒéªŒè¯åº”ç”¨ç¨‹åºï¼ˆå¦‚æµè§ˆå™¨ï¼‰å’ŒWebæœåŠ¡å™¨ä¹‹é—´ä¼ è¾“çš„æ•°æ®çš„ä¸€ä¸ª<strong>ç‰¹æ®Šåº”ç”¨å±‚</strong>ã€‚</p><p>(5) <strong>TLSï¼šSSLå±‚æ‰€ç”¨çš„åè®®(SSL å‘å±•åˆ° v3 å°†å…¶æ”¹åä¸ºTLSï¼Œä¼ è¾“å±‚å®‰å…¨ï¼ŒTransport Layer Security)</strong>ï¼Œæ˜¯ç”¨æ¥è®¤è¯ç”¨æˆ·å’ŒæœåŠ¡ï¼ŒåŠ å¯†æ•°æ®ï¼Œç»´æŠ¤æ•°æ®çš„å®Œæ•´æ€§çš„åº”ç”¨å±‚åè®®ã€‚</p><p>è¡¥å……ï¼šOpenSSLï¼šå®ƒæ˜¯ä¸€ä¸ªè‘—åçš„å¼€æºå¯†ç å­¦ç¨‹åºåº“å’Œå·¥å…·åŒ…ï¼Œå‡ ä¹æ”¯æŒæ‰€æœ‰å…¬å¼€çš„åŠ å¯†ç®—æ³•å’Œåè®®ã€‚</p><h3 id="HTTPSæ˜¯ä»€ä¹ˆ">HTTPSæ˜¯ä»€ä¹ˆ</h3><p><strong>HTTPS å¹¶ä¸æ˜¯æ–°åè®®ï¼Œè€Œæ˜¯è®© HTTP å…ˆå’Œ SSLé€šä¿¡ï¼Œå†ç”± SSL å’Œ TCP é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯è¯´ HTTPS ä½¿ç”¨äº†éš§é“è¿›è¡Œé€šä¿¡</strong>ã€‚é€šè¿‡ä½¿ç”¨ SSLï¼ŒHTTPS å…·æœ‰äº†<strong>åŠ å¯†ï¼ˆé˜²çªƒå¬ï¼‰ã€è®¤è¯ï¼ˆé˜²ä¼ªè£…ï¼‰å’Œå®Œæ•´æ€§ä¿æŠ¤ï¼ˆé˜²ç¯¡æ”¹ï¼‰</strong>ã€‚</p><h3 id="åŠ å¯†æ˜¯ä»€ä¹ˆ">åŠ å¯†æ˜¯ä»€ä¹ˆ</h3><p><strong>åŠ å¯†å°±æ˜¯å¯¹æ˜æ–‡æ•°æ®æŒ‰æŸç§ç‰¹æ®Šç®—æ³•è¿›è¡Œå¤„ç†ï¼Œä½¿å…¶æˆä¸ºä¸å¯è¯»çš„ä¸€æ®µä»£ç </strong>ï¼Œè¿™æ®µä»£ç è¢«ç§°ä¸º**â€œå¯†æ–‡â€œ<strong>ã€‚å¯†æ–‡å¯ä»¥é€šè¿‡</strong>â€å¯†é’¥â€œ**è§£å¯†ï¼Œè¿˜åŸå‡ºåŸæ¥çš„æ˜æ–‡ã€‚é€šè¿‡è¿™ç§æ–¹æ³•å¯ä»¥ä¿æŠ¤æ•°æ®ï¼Œä¸è¢«éæ³•çªƒå–å’Œé˜…è¯»ã€‚</p><h3 id="å¯†é’¥çš„ç±»å‹">å¯†é’¥çš„ç±»å‹</h3><p>(1) <strong>å¯¹ç§°å¯†é’¥</strong>ï¼šç”±ä¸€ç»„ç›¸åŒçš„å¯†é’¥å¯¹ç»„æˆï¼Œ<strong>åŠ å¯†å’Œè§£å¯†ä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥</strong>ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515185517217.png" alt="image-20240515185517217"></p><p>(2) <strong>éå¯¹ç§°å¯†é’¥</strong>ï¼šç”±ä¸€ç»„ä¸åŒçš„å¯†é’¥å¯¹ç»„æˆï¼Œ<strong>åŠ å¯†ä¸è§£å¯†å¿…é¡»ä½¿ç”¨ä¸åŒçš„å¯†é’¥</strong>ï¼Œè¿™ä¸¤ä¸ªå¯†é’¥åˆ†åˆ«å«åš<strong>å…¬é’¥å’Œç§é’¥</strong>ã€‚å…¬é’¥æ˜¯å¯ä»¥å…¬å¼€ç»™æ‰€æœ‰äººçš„ï¼Œè€Œç§é’¥éœ€è¦è‡ªå·±ä¿å¯†çš„ã€‚<strong>ä½¿ç”¨å…¬é’¥åŠ å¯†çš„æ•°æ®åªæœ‰ä½¿ç”¨ç§é’¥æ‰èƒ½è§£å¼€ã€‚ä½¿ç”¨ç§é’¥åŠ å¯†çš„æ•°æ®åªæœ‰ä½¿ç”¨å…¬é’¥æ‰èƒ½è§£å¼€ã€‚</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515185539396.png" alt="image-20240515185539396"></p><p>(3) å®é™…ä¸Šç§é’¥ä¸æ˜¯ç”¨æ¥åŠ å¯†çš„ï¼Œä»–æ˜¯ä¸€ç§<strong>ç­¾åæ‰‹æ®µ</strong>ï¼Œå‡†ç¡®çš„è¯´æ³•åº”è¯¥æ˜¯ <strong>ã€Œç§é’¥ç­¾åï¼Œå…¬é’¥éªŒç­¾ã€</strong>ï¼Œä¸€èˆ¬æ‰€è¯´çš„éå¯¹ç§°å¯†é’¥æŒ‡çš„æ˜¯<strong>å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†</strong>ã€‚</p><h3 id="åˆ©ç”¨å¯†é’¥ç»™æ•°æ®åŠ å¯†">åˆ©ç”¨å¯†é’¥ç»™æ•°æ®åŠ å¯†</h3><p>(1) <strong>å¯¹ç§°å¯†é’¥åŠ å¯†</strong>ï¼šä½¿ç”¨å¯¹ç§°å¯†é’¥æ¥åŠ å¯†å’Œè§£å¯†æ•°æ®ã€æœåŠ¡å™¨å’Œç½‘ç«™æŒæœ‰åŒä¸€æŠŠé’¥åŒ™ã€‘</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515185708745.png" alt="image-20240515185708745"></p><p>â‘ ã€€<strong>ä¼˜ç‚¹</strong>ï¼šæ•°æ®åŠ å¯†å’Œè§£å¯†çš„è¿ç®—é€Ÿåº¦å¿«</p><p>â‘¡ã€€<strong>ç¼ºç‚¹</strong>ï¼šé€šä¿¡åŒæ–¹åœ¨äº¤æ¢å¯†é’¥æ—¶å¿…é¡»æ˜æ–‡é€šä¿¡ï¼Œæ— æ³•å®‰å…¨åœ°å°†å¯†é’¥ä¼ è¾“ç»™å¯¹æ–¹</p><p>(2) <strong>éå¯¹ç§°å¯†é’¥åŠ å¯†</strong>ï¼šä½¿ç”¨éå¯¹ç§°å¯†é’¥æ¥åŠ å¯†å’Œè§£å¯†æ•°æ®ï¼Œç”¨å…¬é’¥è¿›è¡ŒåŠ å¯†ï¼Œå†ç”¨å¯†é’¥è¿›è¡Œè§£å¯†ã€‚</p><p>ã€æœåŠ¡å™¨åŸå…ˆæŒæœ‰å…¬é’¥å’Œç§é’¥ï¼Œç°åœ¨å°†å…¬é’¥ç»™ä½ ï¼Œç„¶åä½ ç”¨å…¬é’¥åŠ å¯†å‘ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å†ç”¨ç§é’¥è§£å¼€ä½ å‘çš„å†…å®¹ã€‘</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515185722653.png" alt="image-20240515185722653"></p><p>â‘ ã€€<strong>ä¼˜ç‚¹</strong>ï¼šç”±äºå…¬é’¥çš„å…¬å¼€æ€§ï¼Œå¯ä»¥å®‰å…¨åœ°å°†å¯†é’¥ä¼ è¾“ç»™å¯¹æ–¹ã€‚</p><p>â‘¡ã€€<strong>ç¼ºç‚¹</strong>ï¼šæ•°æ®åŠ å¯†å’Œè§£å¯†çš„è¿ç®—é€Ÿåº¦æ…¢ã€‚</p><p>(3) éå¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†éƒ½æœ‰ä¸€ä¸ªå…±åŒç¼ºç‚¹ï¼Œ<strong>å®ƒä»¬åªèƒ½ä¿è¯é€šä¿¡çš„å†…å®¹ä¸ä¼šæ³„æ¼ï¼Œå³â€œé˜²çªƒå¬â€ï¼Œå´æ²¡èƒ½è§£å†³â€œä¼ªè£…â€å’Œâ€œç¯¡æ”¹â€</strong>ï¼Œä¸èƒ½ä¿è¯é€šä¿¡æ–¹çš„èº«ä»½æœ‰æ•ˆæ€§ã€‚</p><h3 id="HTTPSé‡‡ç”¨çš„æ˜¯å¯¹ç§°å¯†é’¥åŠ å¯†è¿˜æ˜¯éå¯¹ç§°å¯†é’¥åŠ å¯†ï¼Ÿ">HTTPSé‡‡ç”¨çš„æ˜¯å¯¹ç§°å¯†é’¥åŠ å¯†è¿˜æ˜¯éå¯¹ç§°å¯†é’¥åŠ å¯†ï¼Ÿ</h3><p>HTTPSé‡‡ç”¨äº†<strong>æ··åˆåŠ å¯†</strong>ï¼Œè¿™ç§åŠ å¯†æ–¹å¼ç»“åˆäº†å¯¹ç§°å¯†é’¥åŠ å¯†å’Œéå¯¹ç§°å¯†é’¥åŠ å¯†å„è‡ªçš„ä¼˜ç‚¹ï¼Œ<strong>ä¿è¯å®‰å…¨æ€§çš„å‰æä¸‹è®©åŠ å¯†è§£å¯†é€Ÿåº¦å˜å¿«</strong>ã€‚</p><p>(1) é¦–å…ˆä½¿ç”¨ä¸€ç»„éå¯¹ç§°å¯†é’¥æ¥åŠ å¯†ä¼ è¾“ä¸€ç»„å¯¹ç§°å¯†é’¥ï¼Œæ¥ä¿è¯ä¼ è¾“è¿‡ç¨‹çš„<strong>å®‰å…¨æ€§</strong>ã€‚</p><p>(2) é€šä¿¡åŒæ–¹å†ä½¿ç”¨å¯¹ç§°å¯†é’¥æ¥åŠ å¯†é€šä¿¡è¿‡ç¨‹ä¸­çš„æ•°æ®ï¼Œæ¥ä¿è¯é€šä¿¡è¿‡ç¨‹çš„<strong>æ•ˆç‡</strong>ã€‚</p><p>(3) <strong>æ··åˆåŠ å¯†åªä¿è¯â€œé˜²çªƒå¬â€ï¼Œæƒ³è§£å†³â€œä¼ªè£…â€å’Œâ€œç¯¡æ”¹â€éœ€ä½¿ç”¨â€œç­¾åâ€ä¸â€œæ•°å­—ç­¾åâ€</strong>ã€‚</p><ol><li>Clientå‘èµ·è¯·æ±‚ï¼ˆç«¯å£443)ã€Serverä¸­æœ‰å…¬é’¥å’Œç§é’¥,åªå‘é€å…¬é’¥ã€‘</li><li>Serverè¿”å›å…¬é’¥è¯ä¹¦ç»™Client</li><li>ClientéªŒè¯è¯ä¹¦</li><li>Clientç”Ÿæˆå¯¹ç§°å¯†é’¥ï¼Œç”¨å…¬é’¥åŠ å¯†åå‘ç»™Server</li><li>Serverä½¿ç”¨ç§é’¥è§£å¯†ï¼Œå¾—åˆ°å¯¹ç§°å¯†é’¥</li><li>C/SåŒæ–¹ä½¿ç”¨å¯¹ç§°å¯†é’¥:</li></ol><ul><li>åŠ å¯†æ˜æ–‡å¹¶å‘é€</li><li>è§£å¯†å¯†æ–‡å¾—åˆ°æ˜æ–‡</li></ul><h3 id="ç­¾å">ç­¾å</h3><p>(1) <strong>ç­¾åæ˜¯ä¸€ç§èº«ä»½è®¤è¯æœºåˆ¶</strong>ï¼Œå®ƒä¿è¯äº†æ¯ä¸€ä¸ªé€šä¿¡æ–¹éƒ½æ‹¥æœ‰è‡ªå·±çš„ä¸“å±æ ‡ç­¾ï¼Œå…¶ä»–äººéš¾ä»¥ä¼ªé€ ï¼Œè€Œä¸”å…¶ä»–äººèƒ½å¤ŸéªŒè¯è¿™ä¸ªæ ‡ç­¾ï¼Œç¡®è®¤å®ƒç¡®å®å±äºæŸä¸€ä¸ªé€šä¿¡æ–¹ã€‚</p><p>(2) ç­¾åæœºåˆ¶çš„å®ç°å¯ä»¥ç”¨éå¯¹ç§°å¯†é’¥è§£å†³ï¼Œæˆ‘ä»¬å¯ä»¥<strong>ç”¨ç§é’¥è¿›è¡Œç­¾åï¼Œå†ç”¨å…¬é’¥è¿›è¡ŒéªŒç­¾</strong>ã€‚</p><p>(3) <strong>åœ¨é€šä¿¡ä¹‹å‰ï¼Œå‘é€æ–¹åˆ©ç”¨ç§é’¥å¯¹é€šä¿¡å†…å®¹åŠ å¯†ç”Ÿæˆç­¾åï¼Œå°†ç­¾åè¿åŒé€šä¿¡å†…å®¹ä¸€åŒå‘é€ï¼Œå¯¹æ–¹å¯åˆ©ç”¨å…¬é’¥è§£å¯†è¯¥ç­¾åï¼Œç¡®ä¿ç­¾åçš„æ­£ç¡®æ€§</strong>ã€‚</p><p>(4) ç”±äº<strong>ç§é’¥çš„ä¿å¯†æ€§</strong>ï¼Œå…¶ä»–äººæ— æ³•ä¼ªè£…ã€‚åˆç”±äº<strong>å…¬é’¥çš„å…¬å¼€æ€§</strong>ï¼Œä»»ä½•ä¸€ä¸ªäººéƒ½å¯ä»¥é€šè¿‡å…¬é’¥è§£å¼€ç§é’¥åŠ å¯†çš„æ•°æ®æ¥è¿›è¡Œèº«ä»½éªŒè¯ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515193813500.png" alt="image-20240515193813500"></p><p>ç¼ºç‚¹</p><p>ç­¾åæ˜¯åˆ©ç”¨éå¯¹ç§°å¯†é’¥çš„åŠ å¯†è§£å¯†æ¥å®ç°çš„ï¼Œè€Œéå¯¹ç§°å¯†é’¥çš„åŠ å¯†è§£å¯†ä¾èµ–äºå¤æ‚çš„æ•°å­¦è¿ç®—ï¼Œå½“æ•°æ®é‡å¤§çš„æ—¶å€™ï¼Œè®¡ç®—ç­¾åä¼šéå¸¸è€—æ—¶ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œå¼•å…¥äº†<strong>æ‘˜è¦å’Œæ•°å­—ç­¾å</strong>ã€‚</p><h3 id="æ‘˜è¦">æ‘˜è¦</h3><p>(1) <strong>ä¸€æ®µä¿¡æ¯ï¼Œç»è¿‡æ‘˜è¦ç®—æ³•å¤„ç†è€Œå¾—åˆ°çš„ä¸€ä¸²å®šé•¿çš„å“ˆå¸Œå€¼ï¼Œå°±æ˜¯æ‘˜è¦(dijest)ã€‚</strong></p><p>(2) ä¿¡æ¯å¯ä»¥æ˜¯ä»»æ„é•¿åº¦ï¼Œè€Œæ‘˜è¦æ˜¯å®šé•¿ï¼Œ<strong>æ‘˜è¦ç®—æ³•å°†æ— é™é•¿çš„æ•°æ®æ˜ å°„æˆæœ‰é™é•¿çš„æ•°æ®ã€‚</strong></p><p>(3) æ‘˜è¦æ˜¯ä¸å¯é€†è½¬çš„ï¼Œå®ƒ<strong>ä¸å­˜åœ¨è§£å¯†ï¼Œä»æ‘˜è¦åæ¨åŸä¿¡æ¯ä¹Ÿå¾ˆéš¾ã€‚</strong></p><p>(4) <strong>åŸæ•°æ®å¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè®¡ç®—å‡ºæ¥çš„æ‘˜è¦ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ã€‚å¦‚æœä¸¤ä¸ªæ•°æ®ç®—å‡ºæ¥çš„æ‘˜è¦æ˜¯ä¸€æ ·çš„ï¼Œè¯´æ˜ä¸¤ä¸ªæ•°æ®æ˜¯å®Œå…¨ç›¸åŒã€‚</strong></p><h3 id="æ•°å­—ç­¾å">æ•°å­—ç­¾å</h3><p>(1) <strong>æ•°å­—ç­¾åéœ€è¦å…ˆå¯¹é€šä¿¡æ•°æ®ç”Ÿæˆæ‘˜è¦ï¼Œå†å¯¹æ‘˜è¦è¿›è¡Œç­¾åè¿ç®—ï¼Œå¾—åˆ°çš„ç­¾åå³æ•°å­—ç­¾åã€‚</strong></p><p>(2) åœ¨é€šä¿¡æ—¶ï¼Œå‘é€æ–¹å…ˆç”Ÿæˆæ•°å­—ç­¾åï¼Œå°†æ•°å­—ç­¾åè¿åŒé€šä¿¡å†…å®¹ä¸€åŒå‘é€ï¼Œå¯¹æ–¹å¯åˆ©ç”¨å…¬é’¥è§£å¯†è¯¥æ•°å­—ç­¾åï¼Œå¾—åˆ°ä¸€æ®µæ‘˜è¦ã€‚ï¼ˆ<strong>å¦‚æœå…¬é’¥è§£å¯†å¤±è´¥ï¼Œè¯´æ˜å¯¹æ–¹èº«ä»½è¢«â€œä¼ªè£…â€</strong>ï¼‰</p><p>(3) ç¬¬äºŒæ­¥åˆ™å¯¹é€šä¿¡å†…å®¹ä½¿ç”¨æ‘˜è¦ç®—æ³•ç”Ÿæˆæ‘˜è¦ï¼ˆå‰ææ˜¯æ‘˜è¦ç®—æ³•å…¬å¼€ï¼‰ï¼Œä¸ä¸Šä¸€æ®µæ‘˜è¦è¿›è¡Œæ¯”å¯¹çœ‹æ˜¯å¦ä¸€è‡´ï¼Œ<strong>å¯éªŒè¯å†…å®¹æ˜¯å¦è¢«â€œç¯¡æ”¹â€</strong>ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515195505420.png" alt="image-20240515195505420"></p><p>ã€å¯ä»¥ç†è§£ï¼šå°±æ˜¯å¯¹åŸæ¥çš„æ–‡ä»¶è¿›è¡Œç±»ä¼¼md5ç®—æ³•å¾—åˆ°ä¸€ä¸²å­—ç¬¦ä¸²åç”¨ç§é’¥ç­¾åï¼Œå°†å‰é¢åçš„æ–‡ä»¶å’Œç­¾åå‘ç»™å¯¹æ–¹ï¼Œå¯¹æ–¹ç”¨å…¬é’¥è·å–md5ç®—æ³•ï¼Œä¸åŸæ–‡ä¿¡æ¯ï¼ˆè‡ªå·±è¿›è¡Œè¿ç®—ï¼‰ä¸€éï¼ŒæŸ¥çœ‹æ˜¯å¦ç›¸ç­‰ã€‘</p><h3 id="æ•°å­—ç­¾åå’Œç­¾åçš„ä¸åŒ">æ•°å­—ç­¾åå’Œç­¾åçš„ä¸åŒ</h3><p>(1) <strong>ç­¾å</strong>ï¼šç›´æ¥å¯¹é€šä¿¡æ•°æ®åˆ©ç”¨ç§é’¥ç”Ÿæˆç­¾åã€‚</p><p>(2) <strong>æ•°å­—ç­¾å</strong>ï¼šå…ˆå¯¹é€šä¿¡æ•°æ®ç”Ÿæˆæ‘˜è¦ï¼Œå†å¯¹æ‘˜è¦åˆ©ç”¨ç§é’¥ç”Ÿæˆç­¾åã€‚</p><h3 id="åˆ©ç”¨æ··åˆåŠ å¯†å’Œæ•°å­—ç­¾åæ˜¯å¦å……åˆ†ä¿è¯äº†é€šä¿¡å®‰å…¨">åˆ©ç”¨æ··åˆåŠ å¯†å’Œæ•°å­—ç­¾åæ˜¯å¦å……åˆ†ä¿è¯äº†é€šä¿¡å®‰å…¨</h3><p>(1) åˆ©ç”¨<strong>æ··åˆåŠ å¯†</strong>ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ä¼ è¾“ï¼Œå…·å¤‡**â€œé˜²çªƒå¬â€**ã€‚</p><p>(2) åˆ©ç”¨<strong>æ•°å­—ç­¾å</strong>ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯å¯¹æ–¹èº«ä»½å’Œæ¯”å¯¹æ•°æ®å®Œæ•´æ€§ï¼Œå…·å¤‡**â€œé˜²ç¯¡æ”¹â€å’Œâ€œé˜²ä¼ªè£…â€**ã€‚</p><p>(3) æ··åˆåŠ å¯†å’Œæ•°å­—ç­¾åä»–ä»¬éƒ½åˆ©ç”¨äº†<strong>éå¯¹ç§°å¯†é’¥åŠ å¯†æŠ€æœ¯</strong>ï¼Œé‚£ä¹ˆå°±å¿…é¡»ä¿è¯ä¸€ä¸ªå‰æï¼š<strong>æŸä¸ªé€šä¿¡æ–¹çš„å…¬é’¥èƒ½å¤Ÿé€šè¿‡ç½‘ç»œå®‰å…¨åœ°ä¼ è¾“ç»™å¯¹æ–¹ï¼Œè€Œä¸ä¼šè¢«å…¶ä»–äººç¯¡æ”¹æˆ–ä¼ªè£…</strong>ã€‚</p><p>(4) å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨ä¼ è¾“å…¬é’¥è¿™ä¸€æ­¥æ²¡èƒ½åšåˆ°â€œé˜²ç¯¡æ”¹â€å’Œâ€œé˜²ä¼ªè£…â€ï¼Œå¯¼è‡´åç»­çš„é€šä¿¡å‡å¤±è´¥ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240515200009081.png" alt="image-20240515200009081"></p><p>(5) ä¸Šé¢æåˆ°ï¼Œ<strong>æ•°å­—ç­¾åå¯ä»¥ä¿è¯â€œé˜²ç¯¡æ”¹â€å’Œâ€œä»¿ä¼ªè£…â€ï¼Œä½†æ•°å­—ç­¾åå‰ææ˜¯å®‰å…¨åœ°æŠŠå…¬é’¥ä¼ è¾“ç»™å¯¹æ–¹ï¼Œè¿™å°±å¯¼è‡´äº†æ­»é”</strong>ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†**â€œæ•°å­—è¯ä¹¦â€å’Œç¬¬ä¸‰æ–¹æœºæ„â€œCAâ€**ã€‚</p><h3 id="CAæ˜¯ä»€ä¹ˆ">CAæ˜¯ä»€ä¹ˆ</h3><p>**æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ï¼ˆCAï¼ŒCertificate Authorityï¼‰ï¼Œ<strong>æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åŒæ–¹éƒ½å¯ä¿¡èµ–çš„ç¬¬ä¸‰æ–¹æœºæ„ï¼Œå®ƒå…·å¤‡é¢å¸ƒ</strong>â€œæ•°å­—è¯ä¹¦â€**çš„èŒèƒ½ã€‚</p><h3 id="æ•°å­—è¯ä¹¦æ˜¯ä»€ä¹ˆ">æ•°å­—è¯ä¹¦æ˜¯ä»€ä¹ˆ</h3><p>(1) <strong>æ•°å­—è¯ä¹¦æ˜¯ä¸€ä¸ªæ ‡å¿—é€šä¿¡æ–¹èº«ä»½ä¿¡æ¯çš„æ•°å­—è®¤è¯ï¼Œäººä»¬å¯ä»¥åœ¨ç½‘ä¸Šç”¨å®ƒæ¥è¯†åˆ«å¯¹æ–¹èº«ä»½ã€‚</strong></p><p>(2) <strong>æ•°å­—è¯ä¹¦çš„åˆ¶ä½œæµç¨‹ï¼š<strong>æŸä¸€ä¸ªé€šä¿¡æ–¹å‘â€œCAâ€æå‡ºè¯ä¹¦ç”³è¯·ï¼Œâ€œCAâ€ä¼šå°†</strong>è¯ä¹¦çš„é¢å¸ƒæœºæ„ã€è¯ä¹¦æœ‰æ•ˆæœŸã€è¯ä¹¦æŒæœ‰è€…çš„å…¬é’¥ã€è¯ä¹¦æŒæœ‰è€…èº«ä»½</strong>ç­‰ä¿¡æ¯ç”¨**â€œCAâ€çš„ç§é’¥**è¿›è¡Œç­¾åè¿ç®—ï¼Œç”Ÿæˆç­¾åã€‚ä¹‹åå†å°†ç­¾åå’Œè¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨ä¸€èµ·ï¼Œè¿™å°±æ˜¯â€œæ•°å­—è¯ä¹¦â€ã€‚</p><p>(3) **æ•°å­—è¯ä¹¦çš„ä½¿ç”¨æµç¨‹ï¼š**æŸä¸€ä¸ªé€šä¿¡æ–¹å‘â€œCAâ€ç”³è¯·ä¸€ä¸ªæ•°å­—è¯ä¹¦ï¼Œç„¶åå°†è¯¥è¯ä¹¦å‘é€ç»™é€šä¿¡å¯¹è±¡ï¼Œå¯¹æ–¹è·å–è¯ä¹¦ååˆ©ç”¨â€œCAâ€çš„å…¬é’¥è¿›è¡ŒéªŒç­¾ï¼ŒéªŒè¯é€šè¿‡å³å¯è¯æ˜å¯¹æ–¹èº«ä»½ï¼Œå¹¶ä¸”è·å–å¯¹æ–¹çš„å…¬é’¥ï¼Œä¹‹åå°±å¯ä»¥åˆ©ç”¨å¯¹æ–¹å…¬é’¥æ¥è¿›è¡Œæ··åˆåŠ å¯†å’Œæ•°å­—ç­¾åï¼Œç¡®ä¿æ¥ä¸‹æ¥é€šä¿¡è¿‡ç¨‹çš„å®‰å…¨ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œè®¡ç®—æœºä¸­æ²¡æœ‰ä»€ä¹ˆä¸œè¥¿æ˜¯åŠ ä¸€å±‚ä¸èƒ½è§£å†³çš„ï¼Œå¦‚æœä¸èƒ½è§£å†³ï¼Œå°±åŠ 2å±‚ã€‚</p><h3 id="æ•°å­—è¯ä¹¦çš„å¯é æ€§ä¿è¯">æ•°å­—è¯ä¹¦çš„å¯é æ€§ä¿è¯</h3><p>æ•°å­—è¯ä¹¦éœ€è¦ç”±â€œCAâ€é¢å¸ƒï¼Œä¸ºäº†è¯æ˜â€œCAâ€æ˜¯åˆæ³•çš„ä¸”å…¶æ•°å­—è¯ä¹¦æ˜¯å¯é çš„ï¼Œåœ¨å„ä¸ªâ€œCAâ€ä¹‹é—´è®¾ç«‹äº†å±‚çº§å…³ç³»ï¼Œ**ä¸‹å±‚â€œCAâ€çš„æ•°å­—è¯ä¹¦æ˜¯éœ€è¦ä¸Šå±‚â€œCAâ€ç­¾åçš„ï¼Œ**è€Œæœ€ä¸Šå±‚çš„æ ¹â€œCAâ€çš„æ•°å­—è¯ä¹¦ï¼ˆæ ¹è¯ä¹¦ï¼‰æ˜¯è‡ªç­¾çš„ï¼Œ<strong>æ ¹è¯ä¹¦ç”±æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨é¢„è£…åœ¨è®¡ç®—æœºå†…éƒ¨çš„</strong>ã€‚</p><h3 id="æ•°å­—ç­¾åå’Œæ•°å­—è¯ä¹¦çš„åŒºåˆ«">æ•°å­—ç­¾åå’Œæ•°å­—è¯ä¹¦çš„åŒºåˆ«</h3><p>(1) <strong>æ•°å­—è¯ä¹¦æœ¬èº«å°±åŒ…å«äº†æ•°å­—ç­¾å</strong>ï¼Œæ•°å­—è¯ä¹¦å°†ä¸€äº›é‡è¦æ•°æ®å’Œå¯¹åº”çš„æ•°å­—ç­¾åè¿›è¡Œæ‰“åŒ…ã€‚</p><p>(2) <strong>æ•°å­—ç­¾åå¯ç”±ä»»ä½•ä¸€æ–¹åˆ¶ä½œï¼Œæ•°å­—è¯ä¹¦åªèƒ½ç”±CAé¢å¸ƒã€‚</strong></p><h3 id="æ•°å­—è¯ä¹¦çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒCAçš„å…¬é’¥èƒ½å¦è¢«ä¼ªé€ ">æ•°å­—è¯ä¹¦çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒCAçš„å…¬é’¥èƒ½å¦è¢«ä¼ªé€ </h3><p>(1) **å¤§éƒ¨åˆ†ä¸»æœºå†…éƒ¨éƒ½é¢„å…ˆå®‰è£…äº†æ ¹è¯ä¹¦ï¼Œ**é‡Œé¢è®°å½•äº†å¯ä¿¡èµ–çš„CAæœºæ„ä¿¡æ¯åŠå…¶å…¬é’¥ã€‚</p><p>(2) å³ä½¿æ ¹è¯ä¹¦æ— æ³•ä½¿ç”¨ï¼Œ<strong>æ¥å—æ–¹ä¹Ÿå¯è¿›è¡Œç½‘ä¸ŠæŸ¥è¯¢å¯¹æ¯”ï¼Œåˆ¤æ–­CAå…¬é’¥çš„çœŸå®æ€§</strong>ã€‚</p><h3 id="è¯´è¯´HTTPSçš„é€šä¿¡è¿‡ç¨‹">è¯´è¯´HTTPSçš„é€šä¿¡è¿‡ç¨‹</h3><p>(1) <strong>HTTPSä½¿ç”¨äº†æ··åˆåŠ å¯†+æ•°å­—ç­¾å+æ•°å­—è¯ä¹¦çš„æœºåˆ¶ã€‚</strong></p><p>(2) **æ··åˆåŠ å¯†ï¼š**åœ¨é€šä¿¡æ­£å¼å¼€å§‹å‰ï¼Œå…ˆä½¿ç”¨ä¸€ç»„éå¯¹ç§°å¯†é’¥æ¥åŠ å¯†ä¼ è¾“ä¸€ç»„å¯¹ç§°å¯†é’¥ï¼Œè¿™æ ·åŒæ–¹å°±è·å¾—äº†ä¸€ç»„ç›¸åŒçš„å¯¹ç§°å¯†é’¥ï¼Œä¹‹åçš„é€šä¿¡è¿‡ç¨‹éƒ½ä½¿ç”¨å¯¹ç§°å¯†é’¥æ¥åŠ å¯†ä¼ è¾“æ•°æ®ï¼Œç¡®ä¿æ•°æ®çš„æœºå¯†æ€§ï¼Œ<strong>å®ç°â€œé˜²çªƒå¬â€ï¼ŒåŒæ—¶è¿˜å…·æœ‰è¾ƒé«˜çš„åŠ å¯†è§£å¯†æ•ˆç‡ã€‚</strong>ã€é˜²æ­¢è¢«ä¸­é—´äººçœ‹åˆ°ã€‘</p><p>(3) <strong>æ•°å­—ç­¾åï¼š<strong>åœ¨é€šä¿¡æ—¶ï¼Œå…ˆå¯¹é€šä¿¡æ•°æ®ç”Ÿæˆæ•°å­—ç­¾åï¼Œå‘é€æ•°æ®æ—¶è¿åŒæ•°å­—ç­¾åä¸€åŒå‘é€ã€‚å¯¹æ–¹å¯åˆ©ç”¨å…¬é’¥éªŒè¯è¯¥æ•°å­—ç­¾åï¼Œå¾—åˆ°ä¸€æ®µæ‘˜è¦ã€‚ä¹‹åå¯¹æ–¹ä¹Ÿå¯ä»¥å¯¹é€šä¿¡å†…å®¹ä½¿ç”¨æ‘˜è¦ç®—æ³•ç”Ÿæˆæ‘˜è¦ï¼Œå¯¹æ¯”ä¸Šä¸€æ­¥éªŒç­¾å¾—åˆ°çš„æ‘˜è¦ï¼Œçœ‹æ˜¯å¦ç›¸åŒï¼Œé€šè¿‡è¿™ä¸€æ­¥å¯ä»¥å®ç°</strong>â€œé˜²ä¼ªè£…â€å’Œâ€œé˜²ç¯¡æ”¹â€ã€‚</strong>ã€é˜²æ­¢ä¿¡æ¯å’Œå‘ä¹‹å‰çš„ä¸ä¸€æ ·ã€‘</p><p>(4) **æ•°å­—è¯ä¹¦ï¼šä¸ºäº†ç¡®ä¿å…¬é’¥å®‰å…¨æ€§ï¼Œ**å…ˆç”±æŸä¸€é€šä¿¡æ–¹å‘â€œCAâ€ç”³è¯·æ•°å­—è¯ä¹¦ï¼Œé€šä¿¡æ–¹è·å¾—æ•°å­—è¯ä¹¦åå‘é€ç»™é€šä¿¡å¯¹è±¡ï¼Œå¯¹æ–¹è·å–è¯ä¹¦ååˆ©ç”¨â€œCAâ€çš„å…¬é’¥è¿›è¡ŒéªŒç­¾ï¼Œ<strong>éªŒè¯é€šè¿‡å³å¯è¯æ˜å¯¹æ–¹èº«ä»½ï¼Œå¹¶ä¸”è·å–å¯¹æ–¹çš„å…¬é’¥ï¼Œä¹‹åçš„é€šä¿¡å°±å¯ä»¥åˆ©ç”¨è¯¥å…¬é’¥å®Œæˆâ€œæ··åˆåŠ å¯†â€å’Œâ€œæ•°å­—ç­¾åâ€</strong>ã€é˜²æ­¢æ˜¯å¯¹æ–¹å‘çš„ã€‘</p><h3 id="HTTPSå’ŒHTTPçš„åŒºåˆ«">HTTPSå’ŒHTTPçš„åŒºåˆ«</h3><p>(1) HTTPSé‡‡ç”¨äº†æ··åˆåŠ å¯†+æ•°å­—ç­¾å+æ•°å­—è¯ä¹¦ï¼Œ<strong>å®‰å…¨æ€§æ›´é«˜ã€‚</strong></p><p>(2) HTTPSåè®®éœ€è¦åˆ°â€œCAâ€ç”³è¯·æ•°å­—è¯ä¹¦ï¼Œä¸€èˆ¬å…è´¹è¯ä¹¦è¾ƒå°‘ï¼Œå› è€Œ<strong>éœ€è¦ä¸€å®šè´¹ç”¨ã€‚</strong></p><p>(3) HTTPå’ŒHTTPSä½¿ç”¨çš„ç«¯å£ä¸ä¸€æ ·ï¼Œ<strong>å‰è€…æ˜¯80ï¼Œåè€…æ˜¯443ã€‚</strong></p><h3 id="HTTPå„ç‰ˆæœ¬çš„ç‰¹ç‚¹">HTTPå„ç‰ˆæœ¬çš„ç‰¹ç‚¹</h3><p>(1) <strong>HTTP1.0</strong>:</p><p>â‘ ã€€<strong>ç®€å•ã€å¿«é€Ÿã€çµæ´»</strong></p><p>â‘¡ã€€<strong>çŸ­è¿æ¥ï¼šçŸ­è¿æ¥çš„å«ä¹‰æ˜¯é™åˆ¶æ¯æ¬¡è¿æ¥åªå¤„ç†ä¸€ä¸ªè¯·æ±‚</strong>ã€‚æœåŠ¡å™¨å¤„ç†å®Œå®¢æˆ·çš„ä¸€æ¬¡è¯·æ±‚åå°±ä¼šæ–­å¼€è¿æ¥ï¼Œè¿™ç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œèƒ½èŠ‚çœæœåŠ¡å™¨çš„èµ„æºæ¶ˆè€—ã€‚</p><p>â‘¢ã€€<strong>æ— çŠ¶æ€ï¼šæ— çŠ¶æ€æ˜¯æŒ‡åè®®å¯¹äºäº‹åŠ¡å¤„ç†æ²¡æœ‰è®°å¿†èƒ½åŠ›</strong>ï¼Œå®¢æˆ·ç«¯å‘é€HTTPè¯·æ±‚åï¼ŒæœåŠ¡å™¨æ ¹æ®è¯·æ±‚å“åº”æ•°æ®ï¼Œä½†å®ƒä¸ä¼šè®°å½•å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œæ— æ³•åˆ¤æ–­æŸæ¬¡è¯·æ±‚ä¸ä¸Šä¸€æ¬¡è¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€å®¢æˆ·ç«¯ã€‚</p><p>(2) <strong>HTTP1.1</strong>ï¼š</p><p>â‘ ã€€<strong>é•¿è¿æ¥</strong>ï¼šé»˜è®¤æŒä¹…è¿æ¥ï¼Œ<strong>åªè¦å®¢æˆ·ç«¯æœåŠ¡ç«¯ä»»æ„ä¸€ç«¯æ²¡æœ‰æ˜ç¡®æå‡ºæ–­å¼€TCPè¿æ¥ï¼Œå°±ä¸€ç›´ä¿æŒè¿æ¥</strong>ï¼Œå¯ä»¥å‘é€å¤šæ¬¡HTTPè¯·æ±‚ ã€‚</p><p>â‘¡ã€€<strong>ç®¡çº¿åŒ–</strong>ï¼šå®¢æˆ·ç«¯å¯ä»¥å‘å‡ºå¤šä¸ªHTTPè¯·æ±‚ï¼Œ<strong>åªè¦å‰ä¸€ä¸ªè¯·æ±‚å‘é€å‡ºå»ä¹‹åå°±å¯ä»¥ç»§ç»­å‘é€ç¬¬äºŒä¸ªè¯·æ±‚</strong>ï¼Œè€Œä¸ç”¨ä¸€ä¸ªä¸ªç­‰å¾…å“åº”ä¹‹åå†å‘é€ï¼Œä½†æ˜¯æœåŠ¡å™¨åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œåç»­åˆ°è¾¾çš„HTTPè¯·æ±‚éœ€è¦æ’é˜Ÿç­‰å¾…ã€‚</p><p>â‘¢ã€€<strong>æ–­ç‚¹ç»­ä¼ </strong>ï¼šå°±æ˜¯å¯ä»¥å°†ä¸€ä¸ªå¤§æ•°æ®ï¼Œåˆ†æ®µä¼ è¾“ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ…¢æ…¢æ˜¾ç¤ºã€‚</p><p>(3) <strong>HTTP2.0</strong>ï¼š</p><p>â‘ ã€€<strong>äºŒè¿›åˆ¶ç¼–ç </strong>ï¼šHTTP2.0é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼è€Œéæ–‡æœ¬æ ¼å¼</p><p>â‘¡ã€€<strong>å¤šè·¯å¤ç”¨</strong>ï¼šHTTP2.0æ˜¯å®Œå…¨å¤šè·¯å¤ç”¨çš„ï¼Œ<strong>å®¢æˆ·ç«¯å¯ä»¥åŒæ—¶å‘é€å¤šä¸ªHTTPè¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥åŒæ—¶è¿›è¡Œå¤„ç†</strong>ï¼Œä¸ç”¨è¿›è¡Œæ’é˜Ÿã€‚</p><p>â‘¢ã€€<strong>æŠ¥å¤´å‹ç¼©</strong>ï¼šHTTP2.0ä½¿ç”¨æŠ¥å¤´å‹ç¼©ï¼Œé™ä½äº†å¤´éƒ¨å¼€é”€</p><p>â‘£ã€€<strong>æ¨é€ç¼“å­˜</strong>ï¼šæœåŠ¡ç«¯å¯ä»¥åœ¨å‘é€é¡µé¢HTMLæ—¶ä¸»åŠ¨æ¨é€å…¶å®ƒèµ„æºï¼Œè€Œä¸ç”¨ç­‰åˆ°æµè§ˆå™¨è§£æåˆ°ç›¸åº”ä½ç½®ï¼Œå‘èµ·è¯·æ±‚å†å“åº”ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://suqingyu.com/2023/09/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%EF%BC%88HTTP%EF%BC%89%E7%AC%94%E8%AE%B0%E4%B8%8E%E6%80%BB%E7%BB%93/#%E5%89%8D%E6%8F%90%E5%9F%BA%E7%A1%80">è®¡ç®—æœºç½‘ç»œï¼ˆHTTPï¼‰ç¬”è®°ä¸æ€»ç»“|</a></li></ul>]]></content>
    
    
    <summary type="html">HTTPåè®®</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>TCPåè®®</title>
    <link href="https://penge666.github.io/posts/51aeee82.html"/>
    <id>https://penge666.github.io/posts/51aeee82.html</id>
    <published>2024-04-27T08:57:46.000Z</published>
    <updated>2024-04-27T13:16:30.422Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>è®¡ç®—æœºç½‘ç»œåŸºç¡€ï¼Œæ˜¯ä¸€åè®¡ç®—æœºå­¦ç”Ÿå¿…é¡»ç‰¢ç‰¢æŒæ¡çš„åŸºæœ¬åŠŸã€‚</p><p>è¿™é‡Œå®‰åˆ©ä¸‹æ–¯å¦ç¦å¤§å­¦å¼€è®¾çš„CS144è¯¾ç¨‹ï¼Œç»™æƒ³è¿›ä¸€æ­¥äº†è§£TCPåè®®å…·ä½“å®ç°çš„å°ä¼™ä¼´ã€‚</p><p>è¯¾ç¨‹ğŸ”—ï¼š<a href="https://cs144.github.io/">https://cs144.github.io/</a></p><p>è¿™é—¨è¯¾å°†å¸¦ä½ ä»0åˆ°1å®ç°ä¸€ä¸ªå±äºè‡ªå·±çš„èƒ½åœ¨ç½‘ç»œä¸Šé€šä¿¡çš„ TCP/IP åè®®æ ˆã€‚</p><p>å¥½äº†ï¼Œå¼€å§‹åŸºæœ¬çš„çŸ¥è¯†ç‚¹æ¢³ç†~</p><h2 id="TCPå’ŒUDPçš„åŒºåˆ«">TCPå’ŒUDPçš„åŒºåˆ«</h2><p><strong>UDPå¤´éƒ¨</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427173840722.png" alt="image-20240427173840722"></p><p>å­—æ®µå«ä¹‰</p><ul><li><p>ç«¯å£ï¼šé•¿åº¦16ä½ï¼ŒæŒ‡å®šå‘é€æ–¹æ‰€ä½¿ç”¨çš„ç«¯å£å·ï¼Œè‹¥ä¸éœ€è¦å¯¹æ–¹å›å‘æ¶ˆæ¯ï¼Œåˆ™å¯å…¨ç½®ä¸º0ã€‚</p></li><li><p>ç›®çš„ç«¯å£ï¼šé•¿åº¦16ä½ï¼ŒæŒ‡å®šæ¥æ”¶æ–¹æ‰€ä½¿ç”¨çš„ç«¯å£å·ã€‚</p></li><li><p>UDPæ€»é•¿åº¦ï¼šé•¿åº¦16ä½ï¼ŒæŒ‡å®šäº†UDPæ•°æ®æŠ¥çš„æ€»é•¿åº¦ã€‚</p></li><li><p>æ ¡éªŒå’Œï¼šé•¿åº¦16ä½ï¼Œç”¨äºUDPçš„å·®é”™æ£€æµ‹ï¼Œé˜²æ­¢UDPæŠ¥æ–‡å‡ºé”™ï¼ŒåŒæ—¶ä¼ªé¦–éƒ¨å‚ä¸è®¡ç®—ï¼Œé¿å…UDPç”¨æˆ·æ•°æ®æŠ¥ä¼ é€åˆ°é”™è¯¯çš„ç›®çš„åœ°ã€‚UDPçš„é¦–éƒ¨ï¼Œæ•°æ®éƒ¨åˆ†ï¼Œä¼ªé¦–éƒ¨éƒ½ä¼šå‚ä¸æ£€éªŒå’Œçš„è®¡ç®—ï¼Œå„å­—æ®µæ˜¯æŒ‰ç…§16æ¯”ç‰¹ä¸ºå•ä½è¿›è¡Œè®¡ç®—çš„ï¼Œå› æ­¤æ•°æ®éƒ¨åˆ†æ˜¯è¦ä¿è¯æ˜¯16æ¯”ç‰¹çš„å€æ•°ï¼Œä¸å¤Ÿç”¨0å¡«å……ã€‚</p></li></ul><p><strong>TCPå¤´éƒ¨</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427173903612.png" alt="image-20240427173903612"></p><p>å­—æ®µå«ä¹‰</p><ul><li><p>16ä½ç«¯å£å·ï¼šæºç«¯å£å·ï¼Œä¸»æœºè¯¥æŠ¥æ–‡æ®µæ˜¯æ¥è‡ªå“ªé‡Œï¼›ç›®æ ‡ç«¯å£å·ï¼Œè¦ä¼ ç»™å“ªä¸ªä¸Šå±‚åè®®æˆ–åº”ç”¨ç¨‹åºã€‚</p></li><li><p>32ä½åºå·ï¼šä¸€æ¬¡TCPé€šä¿¡ï¼ˆä»TCPè¿æ¥å»ºç«‹åˆ°æ–­å¼€ï¼‰è¿‡ç¨‹ä¸­æŸä¸€ä¸ªä¼ è¾“æ–¹å‘ä¸Šçš„å­—èŠ‚æµçš„æ¯ä¸ªå­—èŠ‚çš„ç¼–å·ã€‚</p></li><li><p>32ä½ç¡®è®¤å·ï¼šç”¨ä½œå¯¹å¦ä¸€æ–¹å‘é€çš„tcpæŠ¥æ–‡æ®µçš„å“åº”ã€‚å…¶å€¼æ˜¯æ”¶åˆ°çš„TCPæŠ¥æ–‡æ®µçš„åºå·å€¼åŠ 1ã€‚</p></li><li><p>4ä½å¤´éƒ¨é•¿åº¦ï¼šè¡¨ç¤ºtcpå¤´éƒ¨æœ‰å¤šå°‘ä¸ª32bitå­—ï¼ˆ4å­—èŠ‚ï¼‰ã€‚å› ä¸º4ä½æœ€å¤§èƒ½æ ‡è¯†15ï¼Œæ‰€ä»¥TCPå¤´éƒ¨æœ€é•¿æ˜¯60å­—èŠ‚ã€‚</p></li><li><p>6ä½æ ‡å¿—ä½ï¼šURG(ç´§æ€¥æŒ‡é’ˆæ˜¯å¦æœ‰æ•ˆ)ï¼ŒACkï¼ˆè¡¨ç¤ºç¡®è®¤å·æ˜¯å¦æœ‰æ•ˆï¼‰ï¼ŒPSHï¼ˆç¼“å†²åŒºå°šæœªå¡«æ»¡ï¼‰ï¼ŒRSTï¼ˆè¡¨ç¤ºè¦æ±‚å¯¹æ–¹é‡æ–°å»ºç«‹è¿æ¥ï¼‰ï¼ŒSYNï¼ˆå»ºç«‹è¿æ¥æ¶ˆæ¯æ ‡å¿—æ¥ï¼‰ï¼ŒFINï¼ˆè¡¨ç¤ºå‘ŠçŸ¥å¯¹æ–¹æœ¬ç«¯è¦å…³é—­è¿æ¥äº†ï¼‰ã€‚</p></li><li><p>16ä½çª—å£å¤§å°ï¼šæ˜¯TCPæµé‡æ§åˆ¶çš„ä¸€ä¸ªæ‰‹æ®µã€‚è¿™é‡Œè¯´çš„çª—å£ï¼ŒæŒ‡çš„æ˜¯æ¥æ”¶é€šå‘Šçª—å£ã€‚å®ƒå‘Šè¯‰å¯¹æ–¹æœ¬ç«¯çš„TCPæ¥æ”¶ç¼“å†²åŒºè¿˜èƒ½å®¹çº³å¤šå°‘å­—èŠ‚çš„æ•°æ®ï¼Œè¿™æ ·å¯¹æ–¹å°±å¯ä»¥æ§åˆ¶å‘é€æ•°æ®çš„é€Ÿåº¦ã€‚</p></li><li><p>16ä½æ ¡éªŒå’Œï¼šç”±å‘é€ç«¯å¡«å……ï¼Œæ¥æ”¶ç«¯å¯¹TCPæŠ¥æ–‡æ®µæ‰§è¡ŒCRCç®—æ³•ä»¥æ£€éªŒTCPæŠ¥æ–‡æ®µåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦æŸåã€‚æ³¨æ„ï¼Œè¿™ä¸ªæ ¡éªŒä¸ä»…åŒ…æ‹¬TCPå¤´éƒ¨ï¼Œä¹ŸåŒ…æ‹¬æ•°æ®éƒ¨åˆ†ã€‚è¿™ä¹Ÿæ˜¯TCPå¯é ä¼ è¾“çš„ä¸€ä¸ªé‡è¦ä¿éšœã€‚</p></li><li><p>16ä½ç´§æ€¥æŒ‡é’ˆï¼šä¸€ä¸ªæ­£çš„åç§»é‡ã€‚å®ƒå’Œåºå·å­—æ®µçš„å€¼ç›¸åŠ è¡¨ç¤ºæœ€åä¸€ä¸ªç´§æ€¥æ•°æ®çš„ä¸‹ä¸€å­—èŠ‚çš„åºå·ã€‚å› æ­¤ï¼Œç¡®åˆ‡åœ°è¯´ï¼Œè¿™ä¸ªå­—æ®µæ˜¯ç´§æ€¥æŒ‡é’ˆç›¸å¯¹å½“å‰åºå·çš„åç§»ï¼Œä¸å¦¨ç§°ä¹‹ä¸ºç´§æ€¥åç§»ã€‚TCPçš„ç´§æ€¥æŒ‡é’ˆæ˜¯å‘é€ç«¯å‘æ¥æ”¶ç«¯å‘é€ç´§æ€¥æ•°æ®çš„æ–¹æ³•ã€‚</p></li></ul><p><strong>åŒºåˆ«</strong></p><ul><li><p>TCP<strong>é¢å‘è¿æ¥</strong>ï¼›UDPæ˜¯æ— è¿æ¥çš„ï¼Œå³å‘é€æ•°æ®ä¹‹å‰ä¸éœ€è¦å»ºç«‹è¿æ¥ã€‚</p></li><li><p>TCPæä¾›<strong>å¯é çš„æœåŠ¡</strong>ï¼›UDPä¸ä¿è¯å¯é äº¤ä»˜ã€‚</p></li><li><p>TCP<strong>é¢å‘å­—èŠ‚æµ</strong>ï¼ŒæŠŠæ•°æ®çœ‹æˆä¸€è¿ä¸²æ— ç»“æ„çš„å­—èŠ‚æµï¼›UDPæ˜¯é¢å‘æŠ¥æ–‡çš„ã€‚</p></li><li><p>TCPæœ‰<strong>æ‹¥å¡æ§åˆ¶</strong>ï¼›UDPæ²¡æœ‰æ‹¥å¡æ§åˆ¶ï¼Œå› æ­¤ç½‘ç»œå‡ºç°æ‹¥å¡ä¸ä¼šä½¿æºä¸»æœºçš„å‘é€é€Ÿç‡é™ä½ï¼ˆå¯¹å®æ—¶åº”ç”¨å¾ˆæœ‰ç”¨ï¼Œå¦‚å®æ—¶è§†é¢‘ä¼šè®®ç­‰ï¼‰ã€‚</p></li><li><p>æ¯ä¸€æ¡TCPè¿æ¥åªèƒ½æ˜¯<strong>ç‚¹åˆ°ç‚¹</strong>çš„ï¼›UDPæ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šçš„é€šä¿¡æ–¹å¼ã€‚</p></li><li><p>TCPé¦–éƒ¨å¼€é”€20å­—èŠ‚ï¼›UDPçš„é¦–éƒ¨å¼€é”€å°ï¼Œåªæœ‰8ä¸ªå­—èŠ‚ã€‚</p></li></ul><p><strong>å¸¸è§çš„åº”ç”¨åè®®</strong></p><p>åŸºäºTCPçš„åº”ç”¨å±‚åè®®æœ‰ï¼šHTTPã€FTPã€SMTPã€TELNETã€SSH</p><ul><li><strong>HTTP</strong>ï¼šHyperText Transfer Protocolï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰ï¼Œé»˜è®¤ç«¯å£80</li><li><strong>FTP</strong>: File Transfer Protocol (æ–‡ä»¶ä¼ è¾“åè®®), é»˜è®¤ç«¯å£(20ç”¨äºä¼ è¾“æ•°æ®ï¼Œ21ç”¨äºä¼ è¾“æ§åˆ¶ä¿¡æ¯)</li><li><strong>SMTP</strong>: Simple Mail Transfer Protocol (ç®€å•é‚®ä»¶ä¼ è¾“åè®®) ,é»˜è®¤ç«¯å£25</li><li><strong>TELNET</strong>: Teletype over the Network (ç½‘ç»œç”µä¼ ), é»˜è®¤ç«¯å£23</li><li><strong>SSH</strong>ï¼šSecure Shellï¼ˆå®‰å…¨å¤–å£³åè®®ï¼‰ï¼Œé»˜è®¤ç«¯å£ 22</li></ul><p>åŸºäºUDPçš„åº”ç”¨å±‚åè®®ï¼šDNSã€TFTPã€SNMP</p><ul><li><strong>DNS</strong> : Domain Name Service (åŸŸåæœåŠ¡),é»˜è®¤ç«¯å£ 53</li><li><strong>TFTP</strong>: Trivial File Transfer Protocol (ç®€å•æ–‡ä»¶ä¼ è¾“åè®®)ï¼Œé»˜è®¤ç«¯å£69</li><li><strong>SNMP</strong>ï¼šSimple Network Management Protocolï¼ˆç®€å•ç½‘ç»œç®¡ç†åè®®ï¼‰ï¼Œé€šè¿‡UDPç«¯å£161æ¥æ”¶ï¼Œåªæœ‰Trapä¿¡æ¯é‡‡ç”¨UDPç«¯å£162ã€‚</li></ul><blockquote><p><strong>TCPæ˜¯å¦‚ä½•ç¡®ä¿å¯é æ€§çš„å‘¢ï¼Ÿ</strong></p></blockquote><ul><li>é¦–å…ˆï¼ŒTCPçš„è¿æ¥æ˜¯åŸºäº<strong>ä¸‰æ¬¡æ¡æ‰‹</strong>ï¼Œè€Œæ–­å¼€åˆ™æ˜¯åŸºäº<strong>å››æ¬¡æŒ¥æ‰‹</strong>ã€‚ç¡®ä¿è¿æ¥å’Œæ–­å¼€çš„å¯é æ€§ã€‚</li><li>å…¶æ¬¡ï¼ŒTCPçš„å¯é æ€§ï¼Œè¿˜ä½“ç°åœ¨<strong>æœ‰çŠ¶æ€</strong>;TCPä¼šè®°å½•å“ªäº›æ•°æ®å‘é€äº†ï¼Œå“ªäº›æ•°æ®è¢«æ¥æ”¶äº†ï¼Œå“ªäº›æ²¡æœ‰è¢«æ¥å—ï¼Œå¹¶ä¸”ä¿è¯æ•°æ®åŒ…æŒ‰åºåˆ°è¾¾ï¼Œä¿è¯æ•°æ®ä¼ è¾“ä¸å‡ºå·®é”™ã€‚</li><li>å†æ¬¡ï¼ŒTCPçš„å¯é æ€§ï¼Œè¿˜ä½“ç°åœ¨<strong>å¯æ§åˆ¶</strong>ã€‚å®ƒæœ‰æ•°æ®åŒ…æ ¡éªŒã€ACKåº”ç­”ã€<strong>è¶…æ—¶é‡ä¼ (å‘é€æ–¹)</strong>ã€å¤±åºæ•°æ®é‡ä¼ ï¼ˆæ¥æ”¶æ–¹ï¼‰ã€ä¸¢å¼ƒé‡å¤æ•°æ®ã€æµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£ï¼‰å’Œæ‹¥å¡æ§åˆ¶ç­‰æœºåˆ¶ã€‚</li></ul><h2 id="TCPçš„ä¸‰æ¬¡æ¡æ‰‹">TCPçš„ä¸‰æ¬¡æ¡æ‰‹</h2><p>å‡è®¾å‘é€ç«¯ä¸ºå®¢æˆ·ç«¯ï¼Œæ¥æ”¶ç«¯ä¸ºæœåŠ¡ç«¯ã€‚</p><p>å¼€å§‹æ—¶å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„çŠ¶æ€éƒ½æ˜¯<code>CLOSED</code></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427171700576.png" alt="image-20240427171700576"></p><ul><li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·å»ºç«‹è¿æ¥è¯·æ±‚ï¼Œå®¢æˆ·ç«¯ä¼šéšæœºç”Ÿæˆä¸€ä¸ªèµ·å§‹åºåˆ—å·xï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€çš„å­—æ®µä¸­åŒ…å«æ ‡å¿—ä½<code>SYN=1</code>ï¼Œåºåˆ—å·<code>seq=x</code>ã€‚ç¬¬ä¸€æ¬¡æ¡æ‰‹å‰å®¢æˆ·ç«¯çš„çŠ¶æ€ä¸º<code>CLOSE</code>ï¼Œç¬¬ä¸€æ¬¡æ¡æ‰‹åå®¢æˆ·ç«¯çš„çŠ¶æ€ä¸º<code>SYN-SENT</code>ã€‚æ­¤æ—¶æœåŠ¡ç«¯çš„çŠ¶æ€ä¸º<code>LISTEN</code>ã€‚</li><li>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡ç«¯åœ¨æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„æŠ¥æ–‡åï¼Œä¼šéšæœºç”Ÿæˆä¸€ä¸ªæœåŠ¡ç«¯çš„èµ·å§‹åºåˆ—å·yï¼Œç„¶åç»™å®¢æˆ·ç«¯å›å¤ä¸€æ®µæŠ¥æ–‡ï¼Œå…¶ä¸­åŒ…æ‹¬æ ‡å¿—ä½<code>SYN=1</code>ï¼Œ<code>ACK=1</code>ï¼Œåºåˆ—å·<code>seq=y</code>ï¼Œç¡®è®¤å·<code>ack=x+1</code>ã€‚ç¬¬äºŒæ¬¡æ¡æ‰‹å‰æœåŠ¡ç«¯çš„çŠ¶æ€ä¸º<code>LISTEN</code>ï¼Œç¬¬äºŒæ¬¡æ¡æ‰‹åæœåŠ¡ç«¯çš„çŠ¶æ€ä¸º<code>SYN-RCVD</code>ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯çš„çŠ¶æ€ä¸º<code>SYN-SENT</code>ã€‚ï¼ˆå…¶ä¸­<code>SYN=1</code>è¡¨ç¤ºè¦å’Œå®¢æˆ·ç«¯å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œ<code>ACK=1</code>è¡¨ç¤ºç¡®è®¤åºå·æœ‰æ•ˆï¼‰ã€‚</li><li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯å‘æ¥çš„æŠ¥æ–‡åï¼Œä¼šå†å‘æœåŠ¡ç«¯å‘é€æŠ¥æ–‡ï¼Œå…¶ä¸­åŒ…å«æ ‡å¿—ä½<code>ACK=1</code>ï¼Œåºåˆ—å·<code>seq=x+1</code>ï¼Œç¡®è®¤å·<code>ack=y+1</code>ã€‚ç¬¬ä¸‰æ¬¡æ¡æ‰‹å‰å®¢æˆ·ç«¯çš„çŠ¶æ€ä¸º<code>SYN-SENT</code>ï¼Œç¬¬ä¸‰æ¬¡æ¡æ‰‹åå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„çŠ¶æ€éƒ½ä¸º<code>ESTABLISHED</code>ã€‚<strong>æ­¤æ—¶è¿æ¥å»ºç«‹å®Œæˆã€‚</strong></li></ul><blockquote><p><strong>ä¸¤æ¬¡æ¡æ‰‹å¯ä»¥å—ï¼Ÿ</strong></p></blockquote><p>é˜²æ­¢é‡å¤è¿æ¥</p><ul><li>ä¸‰æ¬¡æ¡æ‰‹çš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†é˜²æ­¢æ—§çš„é‡å¤è¿æ¥å¼•èµ·è¿æ¥æ··ä¹±é—®é¢˜ã€‚</li><li>æ¯”å¦‚åœ¨ç½‘ç»œçŠ¶å†µæ¯”è¾ƒå¤æ‚æˆ–è€…ç½‘ç»œçŠ¶å†µæ¯”è¾ƒå·®çš„æƒ…å†µä¸‹ï¼Œå‘é€æ–¹å¯èƒ½ä¼šè¿ç»­å‘é€å¤šæ¬¡å»ºç«‹è¿æ¥çš„è¯·æ±‚ã€‚</li><li>å¦‚æœ TCP æ¡æ‰‹çš„æ¬¡æ•°åªæœ‰ä¸¤æ¬¡ï¼Œé‚£ä¹ˆæ¥æ”¶æ–¹åªèƒ½é€‰æ‹©æ¥å—è¯·æ±‚æˆ–è€…æ‹’ç»æ¥å—è¯·æ±‚ï¼Œä½†å®ƒå¹¶ä¸æ¸…æ¥šè¿™æ¬¡çš„è¯·æ±‚æ˜¯æ­£å¸¸çš„è¯·æ±‚ï¼Œè¿˜æ˜¯ç”±äºç½‘ç»œç¯å¢ƒé—®é¢˜è€Œå¯¼è‡´çš„è¿‡æœŸè¯·æ±‚ï¼Œå¦‚æœæ˜¯è¿‡æœŸè¯·æ±‚çš„è¯å°±ä¼šé€ æˆé”™è¯¯çš„è¿æ¥ã€‚</li><li>æ‰€ä»¥å¦‚æœ TCP æ˜¯ä¸‰æ¬¡æ¡æ‰‹çš„è¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°æœåŠ¡å™¨ç«¯ SEQ+1 çš„æ¶ˆæ¯ä¹‹åï¼Œå°±å¯ä»¥åˆ¤æ–­å½“å‰çš„è¿æ¥æ˜¯å¦ä¸ºå†å²è¿æ¥ï¼Œå¦‚æœåˆ¤æ–­ä¸ºå†å²è¿æ¥çš„è¯å°±ä¼šå‘é€ç»ˆæ­¢æŠ¥æ–‡ï¼ˆRSTï¼‰ç»™æœåŠ¡å™¨ç«¯ç»ˆæ­¢è¿æ¥ï¼›å¦‚æœåˆ¤æ–­å½“å‰è¿æ¥ä¸æ˜¯å†å²è¿æ¥çš„è¯å°±ä¼šå‘é€æŒ‡ä»¤ç»™æœåŠ¡å™¨ç«¯æ¥å»ºç«‹è¿æ¥ã€‚</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427172057128.png" alt="image-20240427172057128"></p><h2 id="TCPçš„å››æ¬¡æŒ¥æ‰‹">TCPçš„å››æ¬¡æŒ¥æ‰‹</h2><p>å®¢æˆ·ç«¯Aå‘å®Œæ•°æ®ï¼Œè¦å…³é—­è¿æ¥ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427172134551.png" alt="image-20240427172134551"></p><ol><li>Açš„åº”ç”¨è¿›ç¨‹å…ˆå‘å…¶TCPå‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼ˆ<code>FIN=1ï¼Œseq=u</code>ï¼‰ï¼Œå¹¶åœæ­¢å†å‘é€æ•°æ®ï¼Œä¸»åŠ¨å…³é—­TCPè¿æ¥ï¼Œè¿›å…¥<code>FIN-WAIT-1</code>ï¼ˆç»ˆæ­¢ç­‰å¾…1ï¼‰çŠ¶æ€ï¼Œç­‰å¾…Bçš„ç¡®è®¤ã€‚</li><li>Bæ”¶åˆ°è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåå³å‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ˆ<code>ACK=1ï¼Œack=u+1ï¼Œseq=v</code>ï¼‰ï¼ŒBè¿›å…¥<code>CLOSE-WAIT</code>ï¼ˆå…³é—­ç­‰å¾…ï¼‰çŠ¶æ€ï¼Œæ­¤æ—¶çš„TCPå¤„äºåŠå…³é—­çŠ¶æ€ï¼ŒAåˆ°Bçš„è¿æ¥é‡Šæ”¾ã€‚</li><li>Aæ”¶åˆ°Bçš„ç¡®è®¤åï¼Œè¿›å…¥<code>FIN-WAIT-2</code>ï¼ˆç»ˆæ­¢ç­‰å¾…2ï¼‰çŠ¶æ€ï¼Œç­‰å¾…Bå‘å‡ºçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µã€‚</li><li>Bå‘é€å®Œæ•°æ®ï¼Œå°±ä¼šå‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼ˆ<code>FIN=1ï¼ŒACK=1ï¼Œseq=wï¼Œack=u+1</code>ï¼‰ï¼ŒBè¿›å…¥<code>LAST-ACK</code>ï¼ˆæœ€åç¡®è®¤ï¼‰çŠ¶æ€ï¼Œç­‰å¾…Açš„ç¡®è®¤ã€‚</li><li>Aæ”¶åˆ°Bçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåï¼Œå¯¹æ­¤å‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ˆ<code>ACK=1ï¼Œseq=u+1ï¼Œack=w+1</code>ï¼‰ï¼ŒAè¿›å…¥<code>TIME-WAIT</code>ï¼ˆæ—¶é—´ç­‰å¾…ï¼‰çŠ¶æ€ã€‚æ­¤æ—¶TCPæœªé‡Šæ”¾æ‰ï¼Œéœ€è¦ç»è¿‡æ—¶é—´ç­‰å¾…è®¡æ—¶å™¨è®¾ç½®çš„æ—¶é—´<code>2MSL</code>ï¼ˆæœ€å¤§æŠ¥æ–‡æ®µç”Ÿå­˜æ—¶é—´ï¼‰åï¼ŒAæ‰è¿›å…¥<code>CLOSED</code>çŠ¶æ€ã€‚Bæ”¶åˆ°Aå‘å‡ºçš„ç¡®è®¤æŠ¥æ–‡æ®µåå…³é—­è¿æ¥ï¼Œè‹¥æ²¡æ”¶åˆ°Aå‘å‡ºçš„ç¡®è®¤æŠ¥æ–‡æ®µï¼ŒBå°±ä¼šé‡ä¼ è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µã€‚</li></ol><blockquote><p><strong>ä»€ä¹ˆTIME_WAITçŠ¶æ€ï¼Ÿ</strong></p></blockquote><p>TIME-WAITçŠ¶æ€æŒ‡çš„æ˜¯ç¬¬å››æ¬¡æŒ¥æ‰‹åï¼Œä¸»åŠ¨ä¸­æ–­è¿æ¥æ–¹æ‰€å¤„çš„çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œä¸»åŠ¨æ–¹å°šæœªå®Œå…¨å…³é—­TCPè¿æ¥ï¼Œç«¯å£ä¸å¯å¤ç”¨ã€‚</p><blockquote><p><strong>ä¸ºä»€ä¹ˆTIME-WAITçŠ¶æ€éœ€è¦ç­‰å¾…2MSL?</strong></p></blockquote><ul><li><strong>ä¿è¯Aå‘é€çš„æœ€åä¸€ä¸ªACKæŠ¥æ–‡æ®µèƒ½å¤Ÿåˆ°è¾¾B</strong>ã€‚è¿™ä¸ª<code>ACK</code>æŠ¥æ–‡æ®µæœ‰å¯èƒ½ä¸¢å¤±ï¼ŒBæ”¶ä¸åˆ°è¿™ä¸ªç¡®è®¤æŠ¥æ–‡ï¼Œå°±ä¼šè¶…æ—¶é‡ä¼ è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼Œç„¶åAå¯ä»¥åœ¨<code>2MSL</code>æ—¶é—´å†…æ”¶åˆ°è¿™ä¸ªé‡ä¼ çš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼Œæ¥ç€Aé‡ä¼ ä¸€æ¬¡ç¡®è®¤ï¼Œé‡æ–°å¯åŠ¨2MSLè®¡æ—¶å™¨ï¼Œæœ€åAå’ŒBéƒ½è¿›å…¥åˆ°<code>CLOSED</code>çŠ¶æ€ï¼Œè‹¥Aåœ¨<code>TIME-WAIT</code>çŠ¶æ€ä¸ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè€Œæ˜¯å‘é€å®ŒACKæŠ¥æ–‡æ®µåç«‹å³é‡Šæ”¾è¿æ¥ï¼Œåˆ™æ— æ³•æ”¶åˆ°Bé‡ä¼ çš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼Œæ‰€ä»¥ä¸ä¼šå†å‘é€ä¸€æ¬¡ç¡®è®¤æŠ¥æ–‡æ®µï¼ŒBå°±æ— æ³•æ­£å¸¸è¿›å…¥åˆ°<code>CLOSED</code>çŠ¶æ€ã€‚</li><li><strong>é˜²æ­¢å·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µå‡ºç°åœ¨æœ¬è¿æ¥ä¸­</strong>ã€‚Aåœ¨å‘é€å®Œæœ€åä¸€ä¸ª<code>ACK</code>æŠ¥æ–‡æ®µåï¼Œå†ç»è¿‡2MSLï¼Œå°±å¯ä»¥ä½¿è¿™ä¸ªè¿æ¥æ‰€äº§ç”Ÿçš„æ‰€æœ‰æŠ¥æ–‡æ®µéƒ½ä»ç½‘ç»œä¸­æ¶ˆå¤±ï¼Œä½¿ä¸‹ä¸€ä¸ªæ–°çš„è¿æ¥ä¸­ä¸ä¼šå‡ºç°æ—§çš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µã€‚</li></ul><h2 id="TCPçš„çŠ¶æ€è½¬æ¢å›¾">TCPçš„çŠ¶æ€è½¬æ¢å›¾</h2><p>çŠ¶æ€è½¬æ¢å›¾å‡ ä¹å‡ºç°åœ¨æ¯ä¸€æœ¬æœ‰å…³TCPçš„æ•™æä¸­ï¼Œå¯è°“æ˜¯ç»å…¸ä¸­çš„ç»å…¸ã€‚</p><p>TCPé€šä¿¡è¿‡ç¨‹åŒ…æ‹¬ä¸‰ä¸ªæ­¥éª¤ï¼šå»ºç«‹TCPè¿æ¥é€šé“ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰ã€æ•°æ®ä¼ è¾“ã€æ–­å¼€TCPè¿æ¥é€šé“ï¼ˆå››æ¬¡æŒ¥æ‰‹ï¼‰</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427171057056.png" alt="image-20240427171057056"></p><p>è€Œæ•´ä¸ªè¿‡ç¨‹å¯ä»¥è¡¨ç¤ºæˆ<strong>TCPçŠ¶æ€çŠ¶æ€è½¬æ¢å›¾</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427171502114.png" alt="image-20240427171502114"></p><p>è¯¦ç»†å­¦ä¹ è¿™ç¯‡å†…å®¹ï¼š<a href="https://www.coonote.com/tcpip/tcpip-tutorial.html">TCP/IP æ•™ç¨‹</a></p><h2 id="TCPçš„æ»‘åŠ¨çª—å£æœºåˆ¶">TCPçš„æ»‘åŠ¨çª—å£æœºåˆ¶</h2><p>TCP åˆ©ç”¨æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶ã€‚</p><p>æµé‡æ§åˆ¶æ˜¯ä¸ºäº†æ§åˆ¶å‘é€æ–¹å‘é€é€Ÿç‡ï¼Œä¿è¯æ¥æ”¶æ–¹æ¥å¾—åŠæ¥æ”¶ã€‚ TCPä¼šè¯çš„åŒæ–¹éƒ½å„è‡ªç»´æŠ¤ä¸€ä¸ªå‘é€çª—å£å’Œä¸€ä¸ªæ¥æ”¶çª—å£ã€‚æ¥æ”¶çª—å£å¤§å°å–å†³äºåº”ç”¨ã€ç³»ç»Ÿã€ç¡¬ä»¶çš„é™åˆ¶ã€‚å‘é€çª—å£åˆ™å–å†³äºå¯¹ç«¯é€šå‘Šçš„æ¥æ”¶çª—å£ã€‚æ¥æ”¶æ–¹å‘é€çš„ç¡®è®¤æŠ¥æ–‡ä¸­çš„windowå­—æ®µå¯ä»¥ç”¨æ¥æ§åˆ¶å‘é€æ–¹çª—å£å¤§å°ï¼Œä»è€Œå½±å“å‘é€æ–¹çš„å‘é€é€Ÿç‡ã€‚å°†æ¥æ”¶æ–¹çš„ç¡®è®¤æŠ¥æ–‡windowå­—æ®µè®¾ç½®ä¸º 0ï¼Œåˆ™å‘é€æ–¹ä¸èƒ½å‘é€æ•°æ®ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427172810673.png" alt="image-20240427172810673"></p><p>TCPå¤´åŒ…å«windowå­—æ®µï¼Œ16bitä½ï¼Œå®ƒä»£è¡¨çš„æ˜¯çª—å£çš„å­—èŠ‚å®¹é‡ï¼Œæœ€å¤§ä¸º65535ã€‚è¿™ä¸ªå­—æ®µæ˜¯æ¥æ”¶ç«¯å‘Šè¯‰å‘é€ç«¯è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºå¯ä»¥æ¥æ”¶æ•°æ®ã€‚äºæ˜¯å‘é€ç«¯å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›æ¥å‘é€æ•°æ®ï¼Œè€Œä¸ä¼šå¯¼è‡´æ¥æ”¶ç«¯å¤„ç†ä¸è¿‡æ¥ã€‚æ¥æ”¶çª—å£çš„å¤§å°æ˜¯çº¦ç­‰äºå‘é€çª—å£çš„å¤§å°ã€‚</p><h2 id="TCPæ‹¥å¡æ§åˆ¶">TCPæ‹¥å¡æ§åˆ¶</h2><p>é˜²æ­¢è¿‡å¤šçš„æ•°æ®æ³¨å…¥åˆ°ç½‘ç»œä¸­ã€‚ å‡ ç§æ‹¥å¡æ§åˆ¶æ–¹æ³•ï¼šæ…¢å¼€å§‹( slow-start )ã€æ‹¥å¡é¿å…( congestion avoidance )ã€å¿«é‡ä¼ ( fast retransmit )å’Œå¿«æ¢å¤( fast recovery )ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427173017396.png" alt="image-20240427173017396"></p><p><strong>æ…¢å¼€å§‹</strong></p><p>æŠŠæ‹¥å¡çª—å£ cwnd è®¾ç½®ä¸ºä¸€ä¸ªæœ€å¤§æŠ¥æ–‡æ®µMSSçš„æ•°å€¼ã€‚è€Œåœ¨æ¯æ”¶åˆ°ä¸€ä¸ªå¯¹æ–°çš„æŠ¥æ–‡æ®µçš„ç¡®è®¤åï¼ŒæŠŠæ‹¥å¡çª—å£å¢åŠ è‡³å¤šä¸€ä¸ªMSSçš„æ•°å€¼ã€‚æ¯ç»è¿‡ä¸€ä¸ªä¼ è¾“è½®æ¬¡ï¼Œæ‹¥å¡çª—å£ cwnd å°±åŠ å€ã€‚ ä¸ºäº†é˜²æ­¢æ‹¥å¡çª—å£cwndå¢é•¿è¿‡å¤§å¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œè¿˜éœ€è¦è®¾ç½®ä¸€ä¸ªæ…¢å¼€å§‹é—¨é™ssthreshçŠ¶æ€å˜é‡ã€‚</p><p>å½“ cwnd &lt; ssthresh æ—¶ï¼Œä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ã€‚</p><p>å½“ cwnd &gt; ssthresh æ—¶ï¼Œåœæ­¢ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•è€Œæ”¹ç”¨æ‹¥å¡é¿å…ç®—æ³•ã€‚</p><p>å½“ cwnd = ssthresh æ—¶ï¼Œæ—¢å¯ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ï¼Œä¹Ÿå¯ä½¿ç”¨æ‹¥å¡æ§åˆ¶é¿å…ç®—æ³•ã€‚</p><p><strong>æ‹¥å¡é¿å…</strong></p><p>è®©æ‹¥å¡çª—å£cwndç¼“æ…¢åœ°å¢å¤§ï¼Œæ¯ç»è¿‡ä¸€ä¸ªå¾€è¿”æ—¶é—´RTTå°±æŠŠå‘é€æ–¹çš„æ‹¥å¡çª—å£cwndåŠ 1ï¼Œè€Œä¸æ˜¯åŠ å€ã€‚è¿™æ ·æ‹¥å¡çª—å£cwndæŒ‰çº¿æ€§è§„å¾‹ç¼“æ…¢å¢é•¿ã€‚</p><p>æ— è®ºåœ¨æ…¢å¼€å§‹é˜¶æ®µè¿˜æ˜¯åœ¨æ‹¥å¡é¿å…é˜¶æ®µï¼Œåªè¦å‘é€æ–¹åˆ¤æ–­ç½‘ç»œå‡ºç°æ‹¥å¡ï¼ˆå…¶æ ¹æ®å°±æ˜¯æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼‰ï¼Œå°±è¦æŠŠæ…¢å¼€å§‹é—¨é™ssthreshè®¾ç½®ä¸ºå‡ºç°æ‹¥å¡æ—¶çš„å‘é€ æ–¹çª—å£å€¼çš„ä¸€åŠï¼ˆä½†ä¸èƒ½å°äº2ï¼‰ã€‚ç„¶åæŠŠæ‹¥å¡çª—å£cwndé‡æ–°è®¾ç½®ä¸º1ï¼Œæ‰§è¡Œæ…¢å¼€å§‹ç®—æ³•ã€‚è¿™æ ·åšçš„ç›®çš„å°±æ˜¯è¦è¿…é€Ÿå‡å°‘ä¸»æœºå‘é€åˆ°ç½‘ç»œä¸­çš„åˆ†ç»„æ•°ï¼Œä½¿å¾—å‘ç”Ÿ æ‹¥å¡çš„è·¯ç”±å™¨æœ‰è¶³å¤Ÿæ—¶é—´æŠŠé˜Ÿåˆ—ä¸­ç§¯å‹çš„åˆ†ç»„å¤„ç†å®Œæ¯•ã€‚</p><p><strong>å¿«é‡ä¼ </strong></p><p>æœ‰æ—¶ä¸ªåˆ«æŠ¥æ–‡æ®µä¼šåœ¨ç½‘ç»œä¸­ä¸¢å¤±ï¼Œä½†å®é™…ä¸Šç½‘ç»œå¹¶æœªå‘ç”Ÿæ‹¥å¡ã€‚å¦‚æœå‘é€æ–¹è¿Ÿè¿Ÿæ”¶ä¸åˆ°ç¡®è®¤ï¼Œå°±ä¼šäº§ç”Ÿè¶…æ—¶ï¼Œå°±ä¼šè¯¯è®¤ä¸ºç½‘ç»œå‘ç”Ÿäº†æ‹¥å¡ã€‚è¿™å°±å¯¼è‡´å‘é€æ–¹é”™è¯¯åœ°å¯åŠ¨æ…¢å¼€å§‹ï¼ŒæŠŠæ‹¥å¡çª—å£cwndåˆè®¾ç½®ä¸º1ï¼Œå› è€Œé™ä½äº†ä¼ è¾“æ•ˆç‡ã€‚</p><p>å¿«é‡ä¼ ç®—æ³•å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚å¿«é‡ä¼ ç®—æ³•é¦–å…ˆè¦æ±‚æ¥æ”¶æ–¹æ¯æ”¶åˆ°ä¸€ä¸ªå¤±åºçš„æŠ¥æ–‡æ®µåå°±ç«‹å³å‘å‡ºé‡å¤ç¡®è®¤ï¼Œä½¿å‘é€æ–¹åŠæ—©çŸ¥é“æœ‰æŠ¥æ–‡æ®µæ²¡æœ‰åˆ°è¾¾å¯¹æ–¹ã€‚</p><p>å‘é€æ–¹åªè¦ä¸€è¿æ”¶åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤å°±åº”å½“ç«‹å³é‡ä¼ å¯¹æ–¹å°šæœªæ”¶åˆ°çš„æŠ¥æ–‡æ®µï¼Œè€Œä¸å¿…ç»§ç»­ç­‰å¾…é‡ä¼ è®¡æ—¶å™¨åˆ°æœŸã€‚ç”±äºå‘é€æ–¹å°½æ—©é‡ä¼ æœªè¢«ç¡®è®¤çš„æŠ¥æ–‡æ®µï¼Œå› æ­¤é‡‡ç”¨å¿«é‡ä¼ åå¯ä»¥ä½¿æ•´ä¸ªç½‘ç»œååé‡æé«˜çº¦20%ã€‚</p><p><strong>å¿«æ¢å¤</strong></p><p>å½“å‘é€æ–¹è¿ç»­æ”¶åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤ï¼Œå°±ä¼šæŠŠæ…¢å¼€å§‹é—¨é™ssthreshå‡åŠï¼Œæ¥ç€æŠŠcwndå€¼è®¾ç½®ä¸ºæ…¢å¼€å§‹é—¨é™ssthreshå‡åŠåçš„æ•°å€¼ï¼Œç„¶åå¼€å§‹æ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•ï¼Œä½¿æ‹¥å¡çª—å£ç¼“æ…¢åœ°çº¿æ€§å¢å¤§ã€‚</p><p>åœ¨é‡‡ç”¨å¿«æ¢å¤ç®—æ³•æ—¶ï¼Œæ…¢å¼€å§‹ç®—æ³•åªæ˜¯åœ¨TCPè¿æ¥å»ºç«‹æ—¶å’Œç½‘ç»œå‡ºç°è¶…æ—¶æ—¶æ‰ä½¿ç”¨ã€‚ é‡‡ç”¨è¿™æ ·çš„æ‹¥å¡æ§åˆ¶æ–¹æ³•ä½¿å¾—TCPçš„æ€§èƒ½æœ‰æ˜æ˜¾çš„æ”¹è¿›ã€‚</p><h2 id="å…¶ä»–">å…¶ä»–</h2><h3 id="ç²˜åŒ…">ç²˜åŒ…</h3><p>ç²˜åŒ…æŒ‡TCPåè®®ä¸­ï¼Œå‘é€æ–¹å‘é€çš„è‹¥å¹²åŒ…æ•°æ®åˆ°æ¥æ”¶æ–¹æ¥æ”¶æ—¶ç²˜æˆä¸€åŒ…ï¼Œä»æ¥æ”¶ç¼“å†²åŒºçœ‹ï¼Œåä¸€åŒ…æ•°æ®çš„å¤´ç´§æ¥ç€å‰ä¸€åŒ…æ•°æ®çš„å°¾ã€‚</p><p><strong>Note</strong>:åªæœ‰UDPåè®®ä¸å­˜åœ¨ç²˜åŒ…ã€‚è¿™æ˜¯ç”±äºUDPæœ‰æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œï¼Œä¸ä¼šå‘ç”Ÿç²˜åŒ…æ‹†åŒ…é—®é¢˜ã€‚</p><p>å› ä¸ºTCPæ˜¯é¢å‘æµï¼Œæ²¡æœ‰è¾¹ç•Œï¼Œè€Œæ“ä½œç³»ç»Ÿåœ¨å‘é€TCPæ•°æ®æ—¶ï¼Œä¼šé€šè¿‡ç¼“å†²åŒºæ¥è¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚ç¼“å†²åŒºä¸º1024ä¸ªå­—èŠ‚å¤§å°ã€‚</p><ul><li><p>å¦‚æœä¸€æ¬¡è¯·æ±‚å‘é€çš„æ•°æ®é‡æ¯”è¾ƒå°ï¼Œæ²¡è¾¾åˆ°ç¼“å†²åŒºå¤§å°ï¼ŒTCPåˆ™ä¼šå°†å¤šä¸ªè¯·æ±‚åˆå¹¶ä¸ºåŒä¸€ä¸ªè¯·æ±‚è¿›è¡Œå‘é€ï¼Œè¿™å°±å½¢æˆäº†ç²˜åŒ…é—®é¢˜ã€‚</p></li><li><p>å¦‚æœä¸€æ¬¡è¯·æ±‚å‘é€çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œè¶…è¿‡äº†ç¼“å†²åŒºå¤§å°ï¼ŒTCPå°±ä¼šå°†å…¶æ‹†åˆ†ä¸ºå¤šæ¬¡å‘é€ï¼Œè¿™å°±æ˜¯æ‹†åŒ…ã€‚</p></li></ul><p>ç²˜åŒ…å’Œæ‹†åŒ…ç¤ºæ„å›¾ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427173217720.png" alt="image-20240427173217720"></p><p>ä¸Šå›¾ä¸­æ¼”ç¤ºäº†ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ul><li>æ­£å¸¸çš„ç†æƒ³æƒ…å†µï¼Œä¸¤ä¸ªåŒ…æ°å¥½æ»¡è¶³TCPç¼“å†²åŒºçš„å¤§å°æˆ–è¾¾åˆ°TCPç­‰å¾…æ—¶é•¿ï¼Œåˆ†åˆ«å‘é€ä¸¤ä¸ªåŒ…ï¼›</li><li>ç²˜åŒ…ï¼šä¸¤ä¸ªåŒ…è¾ƒå°ï¼Œé—´éš”æ—¶é—´çŸ­ï¼Œå‘ç”Ÿç²˜åŒ…ï¼Œåˆå¹¶æˆä¸€ä¸ªåŒ…å‘é€ï¼›</li><li>æ‹†åŒ…ï¼šä¸€ä¸ªåŒ…è¿‡å¤§ï¼Œè¶…è¿‡ç¼“å­˜åŒºå¤§å°ï¼Œæ‹†åˆ†æˆä¸¤ä¸ªæˆ–å¤šä¸ªåŒ…å‘é€ï¼›</li><li>æ‹†åŒ…å’Œç²˜åŒ…ï¼šPacket1è¿‡å¤§ï¼Œè¿›è¡Œäº†æ‹†åŒ…å¤„ç†ï¼Œè€Œæ‹†å‡ºå»çš„ä¸€éƒ¨åˆ†åˆä¸Packet2è¿›è¡Œç²˜åŒ…å¤„ç†ã€‚</li></ul><p><strong>è§£å†³åŠæ³•</strong>ï¼š</p><ul><li>å‘é€ç«¯å°†æ¯ä¸ªåŒ…éƒ½å°è£…æˆå›ºå®šçš„é•¿åº¦ï¼Œæ¯”å¦‚100å­—èŠ‚å¤§å°ã€‚å¦‚æœä¸è¶³100å­—èŠ‚å¯é€šè¿‡è¡¥0æˆ–ç©ºç­‰è¿›è¡Œå¡«å……åˆ°æŒ‡å®šé•¿åº¦ï¼›</li><li>å‘é€ç«¯åœ¨æ¯ä¸ªåŒ…çš„æœ«å°¾ä½¿ç”¨å›ºå®šçš„åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚\r\nã€‚å¦‚æœå‘ç”Ÿæ‹†åŒ…éœ€ç­‰å¾…å¤šä¸ªåŒ…å‘é€è¿‡æ¥ä¹‹åå†æ‰¾åˆ°å…¶ä¸­çš„\r\nè¿›è¡Œåˆå¹¶ï¼›ä¾‹å¦‚ï¼ŒFTPåè®®ï¼›</li><li>å°†æ¶ˆæ¯åˆ†ä¸ºå¤´éƒ¨å’Œæ¶ˆæ¯ä½“ï¼Œå¤´éƒ¨ä¸­ä¿å­˜æ•´ä¸ªæ¶ˆæ¯çš„é•¿åº¦ï¼Œåªæœ‰è¯»å–åˆ°è¶³å¤Ÿé•¿åº¦çš„æ¶ˆæ¯ä¹‹åæ‰ç®—æ˜¯è¯»åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼›</li><li>é€šè¿‡è‡ªå®šä¹‰åè®®è¿›è¡Œç²˜åŒ…å’Œæ‹†åŒ…çš„å¤„ç†ã€‚</li></ul><h3 id="SYN-floodæ”»å‡»">SYN-floodæ”»å‡»</h3><p>SYN æ´ªæ³›æ”»å‡» (SYN flood attack)</p><p>åŸç†</p><ul><li>åˆ©ç”¨ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹æ¼æ´</li><li>å¤§é‡å‘é€ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼ˆå‡IP)çš„æŠ¥æ–‡</li><li>æ”»å‡»æ–¹å¿½ç•¥ç¬¬äºŒæ¬¡æ¡æ‰‹çš„æŠ¥æ–‡</li><li>è¢«æ”»å‡»æ–¹å¤šä¸ªTCPè¿æ¥å¤„äº(SYNC-RCVD)é˜¶æ®µï¼Œè€—è´¹å¤§é‡èµ„æº</li><li>æœ€ç»ˆå› ä¸ºèµ„æºè€—å°½ï¼Œæ‹’ç»æœåŠ¡(DoS)</li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://joytsing.cn/posts/42952/#toc-heading-2">TCPåè®®ä¸­ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹</a></li><li><a href="https://www.coonote.com/tcpip/tcpip-tutorial.html">TCP/IP æ•™ç¨‹</a></li><li><a href="https://zhuanlan.zhihu.com/p/356225028">é¢è¯•é¢˜ï¼šèŠèŠTCPçš„ç²˜åŒ…ã€æ‹†åŒ…ä»¥åŠè§£å†³æ–¹æ¡ˆ</a></li></ul>]]></content>
    
    
    <summary type="html">é€šä¿—æ˜“æ‡‚ç†è§£TCPåè®®</summary>
    
    
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://penge666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://penge666.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>HTTPé˜Ÿå¤´é˜»å¡</title>
    <link href="https://penge666.github.io/posts/9b06a28b.html"/>
    <id>https://penge666.github.io/posts/9b06a28b.html</id>
    <published>2024-04-27T05:20:46.000Z</published>
    <updated>2024-04-27T13:17:14.272Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªï¼š<a href="https://calendar.perfplanet.com/2020/head-of-line-blocking-in-quic-and-http-3-the-details/">Head-of-Line Blocking in QUIC and HTTP/3: The Details</a></p><p>æ‚¨å¯èƒ½å·²ç»å¬è¯´ï¼Œç»è¿‡4å¹´çš„å·¥ä½œï¼Œæ–°çš„ HTTP/3 å’Œ QUIC åè®®ç»ˆäºæ¥è¿‘æ­£å¼æ ‡å‡†åŒ–ã€‚é¢„è§ˆç‰ˆç°åœ¨å¯ä»¥åœ¨æœåŠ¡å™¨å’Œæµè§ˆå™¨ä¸­è¿›è¡Œæµ‹è¯•ã€‚</p><p>ä¸ HTTP/2 ç›¸æ¯”ï¼ŒHTTP/3 æœ‰å¾ˆå¤§çš„æ€§èƒ½æ”¹è¿›ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºå®ƒå°†åº•å±‚ä¼ è¾“åè®®ä» TCP æ”¹ä¸ºåŸºäº UDP çš„ QUICã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥äº†è§£å…¶ä¸­çš„ä¸€é¡¹æ”¹è¿›ï¼Œå³<strong>æ¶ˆé™¤é˜Ÿå¤´é˜»å¡</strong>ï¼ˆHead-of-Line blocking, ç®€å†™ï¼šHOL blockingï¼‰é—®é¢˜ã€‚è¿™å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºæˆ‘è¯»è¿‡å¾ˆå¤šå…³äºè¿™å®é™…ä¸Šæ„å‘³ç€ä»€ä¹ˆä»¥åŠå®ƒåœ¨ç°å®ä¸­æœ‰å¤šå¤§å¸®åŠ©çš„è¯¯è§£ã€‚è§£å†³é˜Ÿå¤´é˜»å¡ä¹Ÿæ˜¯ HTTP/3 å’Œ QUIC ä»¥åŠ HTTP/2 èƒŒåçš„ä¸»è¦åŠ¨æœºä¹‹ä¸€ï¼Œå› æ­¤å®ƒä¹Ÿä¸ºåè®®æ¼”è¿›çš„åŸå› æä¾›äº†ä¸€ä¸ªæå¥½çš„è§†è§’ã€‚</p><p>æˆ‘å°†é¦–å…ˆä»‹ç»é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œç„¶ååœ¨æ•´ä¸ª HTTP å†å²ä¸­è·Ÿè¸ªå®ƒçš„ä¸åŒå½¢å¼ã€‚æˆ‘ä»¬è¿˜å°†ç ”ç©¶å®ƒå¦‚ä½•ä¸å…¶ä»–ç³»ç»Ÿäº¤äº’ï¼Œå¦‚ä¼˜å…ˆçº§å’Œæ‹¥å¡æ§åˆ¶ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¸®åŠ©äººä»¬å¯¹ HTTP/3 çš„æ€§èƒ½æ”¹è¿›åšå‡ºæ­£ç¡®çš„åˆ¤æ–­ï¼Œè€Œè¿™ï¼ˆå‰§é€ï¼‰å¯èƒ½ä¸åƒè¥é”€ææ–™ä¸­æ‰€è¯´çš„é‚£æ ·ä»¤äººæƒŠè®¶ã€‚</p><p><strong>ç›®å½•ï¼š</strong></p><ol><li>ä»€ä¹ˆæ˜¯é˜Ÿå¤´é˜»å¡ï¼Ÿ</li><li>HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡</li><li>HTTP/2ï¼ˆåŸºäº TCPï¼‰çš„é˜Ÿå¤´é˜»å¡</li><li>HTTP/3ï¼ˆåŸºäº QUICï¼‰çš„é˜Ÿå¤´é˜»å¡</li><li>æ€»ç»“ä¸ç»“è®º</li></ol><p><strong>å½©è›‹å†…å®¹ï¼š</strong></p><ul><li>å½©è›‹ï¼šHTTP/1.1 ç®¡é“</li><li>å½©è›‹ï¼šTLS é˜Ÿå¤´é˜»å¡</li><li>å½©è›‹ï¼šä¼ è¾“æ‹¥å µæ§åˆ¶</li><li>å½©è›‹ï¼šå¤šè·¯å¤ç”¨æ˜¯å¦é‡è¦ï¼Ÿ</li></ul><h2 id="ä»€ä¹ˆæ˜¯é˜Ÿå¤´é˜»å¡ï¼ˆHead-of-Line-blockingï¼‰ï¼Ÿ">ä»€ä¹ˆæ˜¯é˜Ÿå¤´é˜»å¡ï¼ˆ<strong>Head-of-Line blocking</strong>ï¼‰ï¼Ÿ</h2><p>å¾ˆéš¾ç»™ä½ ä¸€ä¸ªå•ä¸€çš„é˜Ÿå¤´é˜»å¡ï¼ˆHOL blockingï¼‰çš„æŠ€æœ¯å®šä¹‰ï¼Œå› ä¸ºè¿™ç¯‡åšå®¢æ–‡ç« å•ç‹¬æè¿°äº†å®ƒçš„å››ä¸ªä¸åŒå˜ä½“ã€‚ç„¶è€Œï¼Œä¸€ä¸ªç®€å•çš„å®šä¹‰æ˜¯ï¼š</p><blockquote><p>å½“å•ä¸ªï¼ˆæ…¢ï¼‰å¯¹è±¡é˜»æ­¢å…¶ä»–/åç»­çš„å¯¹è±¡å‰è¿›æ—¶</p></blockquote><p>ç°å®ç”Ÿæ´»ä¸­ä¸€ä¸ªå¾ˆå¥½çš„æ¯”å–»å°±æ˜¯åªæœ‰ä¸€ä¸ªæ”¶é“¶å°çš„æ‚è´§åº—ã€‚ä¸€ä¸ªé¡¾å®¢ä¹°äº†å¾ˆå¤šä¸œè¥¿ï¼Œæœ€åä¼šè€½è¯¯æ’åœ¨ä»–åé¢çš„äººï¼Œå› ä¸ºé¡¾å®¢æ˜¯ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFirst In, First Outï¼‰çš„æ–¹å¼æœåŠ¡çš„ã€‚å¦ä¸€ä¸ªä¾‹å­æ˜¯åªæœ‰å•è¡Œé“çš„é«˜é€Ÿå…¬è·¯ã€‚åœ¨è¿™æ¡è·¯ä¸Šå‘ç”Ÿä¸€èµ·è½¦ç¥¸ï¼Œå¯èƒ½ä¼šä½¿æ•´ä¸ªé€šé“å µå¡å¾ˆé•¿ä¸€æ®µæ—¶é—´ã€‚å› æ­¤ï¼Œå³ä½¿æ˜¯åœ¨â€œå¤´éƒ¨ï¼ˆheadï¼‰â€ä¸€ä¸ªå•ä¸€çš„é—®é¢˜å¯ä»¥â€œé˜»å¡ï¼ˆblockï¼‰â€æ•´æ¡â€œçº¿ï¼ˆlineï¼‰â€ã€‚</p><p>è¿™ä¸ªæ¦‚å¿µä¸€ç›´æ˜¯æœ€éš¾è§£å†³çš„ Web æ€§èƒ½é—®é¢˜ä¹‹ä¸€ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬ä» HTTP/1.1 å¼€å§‹è®²èµ·ã€‚</p><h2 id="HTTP-1-1-çš„é˜Ÿå¤´é˜»å¡">HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡</h2><p>HTTP/1.1æ˜¯ä¸€ç§æ›´ç®€å•çš„åè®®ã€‚ä¸€ä¸ªåè®®ä»ç„¶å¯ä»¥åŸºäºæ–‡æœ¬å¹¶åœ¨ç½‘ç»œä¸Šå¯è¯»çš„æ—¶ä»£ã€‚å¦‚ä¸‹å›¾1æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132357401.png" alt="image-20240427132357401"></p><center>å›¾1ï¼šæœåŠ¡å™¨ HTTP/1.1 å“åº” script.js</center><p>åœ¨æœ¬ä¾‹ä¸­ï¼Œæµè§ˆå™¨åŸºäº HTTP/1.1ä¸Š è¯·æ±‚ç®€å•çš„<code>script.js</code>æ–‡ä»¶ï¼ˆç»¿è‰²ï¼‰ï¼Œå›¾1æ˜¾ç¤ºäº†æœåŠ¡å™¨å¯¹è¯¥è¯·æ±‚çš„å“åº”ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ° HTTP æ–¹é¢æœ¬èº«å¾ˆç®€å•ï¼šå®ƒåªæ˜¯åœ¨æ˜æ–‡æ–‡ä»¶å†…å®¹æˆ–â€œæœ‰æ•ˆè·è½½â€ï¼ˆpayloadï¼‰å‰é¢ç›´æ¥æ·»åŠ ä¸€äº›æ–‡æœ¬â€œheadersâ€ï¼ˆçº¢è‰²ï¼‰ã€‚ç„¶åï¼Œå¤´ï¼ˆHeadersï¼‰+ æœ‰æ•ˆè·è½½ï¼ˆpayloadï¼‰è¢«ä¼ é€’åˆ°åº•å±‚ TCPï¼ˆæ©™è‰²ï¼‰ï¼Œä»¥ä¾¿çœŸå®ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬ä¸èƒ½å°†æ•´ä¸ªæ–‡ä»¶æ”¾å…¥ä¸€ä¸ª TCP åŒ…ä¸­ï¼Œå¹¶ä¸”å¿…é¡»å°†å®ƒåˆ†æˆä¸¤éƒ¨åˆ†ã€‚</p><p><em>æ³¨æ„ï¼šå®é™…ä¸Šï¼Œå½“ä½¿ç”¨ HTTPS æ—¶ï¼ŒHTTP å’Œ TCP ä¹‹é—´æœ‰å¦ä¸€ä¸ªå®‰å…¨å±‚ï¼Œé€šå¸¸ä½¿ç”¨ TLS åè®®ã€‚ä¸è¿‡ï¼Œä¸ºäº†æ¸…æ™°èµ·è§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œçœç•¥äº†è¿™ä¸€ç‚¹ã€‚æˆ‘åœ¨ç»“å°¾åŠ å…¥äº†ä¸€ä¸ªé¢å¤–çš„å½©è›‹éƒ¨åˆ†ï¼Œè¯¦ç»†è¯´æ˜äº† TLS ç‰¹å®šçš„é˜Ÿå¤´é˜»å¡å˜ä½“ä»¥åŠ QUIC å¦‚ä½•é¿å…å®ƒã€‚é˜…è¯»å®Œæ­£æ–‡åï¼Œè¯·éšæ„é˜…è¯»å®ƒï¼ˆä»¥åŠå…¶ä»–çš„å½©è›‹éƒ¨åˆ†ï¼‰ã€‚</em></p><p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å½“æµè§ˆå™¨ä¹Ÿè¯·æ±‚<code>style.css</code>æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¦‚å›¾2ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132410754.png" alt="image-20240427132410754"></p><center>å›¾2ï¼šæœåŠ¡å™¨ HTTP/1.1 å“åº” script.js å’Œ sytle.css</center><p>åœ¨æœ¬ä¾‹ä¸­ï¼Œå½“<code>script.js</code>çš„å“åº”ä¼ è¾“ä¹‹åï¼Œæˆ‘ä»¬å‘é€<code>style.css</code>ï¼ˆç´«è‰²ï¼‰ã€‚<code>style.css</code>çš„å¤´éƒ¨ï¼ˆheadersï¼‰å’Œå†…å®¹åªæ˜¯é™„åŠ åœ¨ JavaScriptï¼ˆJSï¼‰æ–‡ä»¶ä¹‹åã€‚æ¥æ”¶è€…ä½¿ç”¨<strong>Content-Length</strong> header æ¥çŸ¥é“æ¯ä¸ªå“åº”çš„ç»“æŸä½ç½®å’Œå¦ä¸€ä¸ªå“åº”çš„å¼€å§‹ä½ç½®ï¼ˆåœ¨æˆ‘ä»¬çš„ç®€åŒ–ç¤ºä¾‹ä¸­ï¼Œ<code>script.js</code>æ˜¯1000å­—èŠ‚ï¼Œè€Œ<code>style.css</code>åªæœ‰600å­—èŠ‚ï¼‰ã€‚</p><p>åœ¨è¿™ä¸ªåŒ…å«ä¸¤ä¸ªå°æ–‡ä»¶çš„ç®€å•ç¤ºä¾‹ä¸­ï¼Œæ‰€æœ‰è¿™äº›ä¼¼ä¹éƒ½å¾ˆåˆç†ã€‚ä½†æ˜¯ï¼Œå‡è®¾ JS æ–‡ä»¶æ¯” CSS å¤§å¾—å¤šï¼ˆæ¯”å¦‚è¯´ 1MB è€Œä¸æ˜¯ 1KBï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨ä¸‹è½½æ•´ä¸ªJSæ–‡ä»¶ä¹‹å‰ï¼ŒCSS å¿…é¡»ç­‰å¾…ï¼Œå°½ç®¡å®ƒè¦å°å¾—å¤šï¼Œå…¶å®å¯ä»¥æ›´æ—©åœ°è§£æ/ä½¿ç”¨ã€‚æ›´ç›´æ¥åœ°å°†å…¶å¯è§†åŒ–ï¼Œä½¿ç”¨æ•°å­— 1 è¡¨ç¤º<code>large_script.js</code>å’Œ 2 è¡¨ç¤º<code>style.css</code>ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11111111111111111111111111111111111111122</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªé˜Ÿå¤´é˜»å¡é—®é¢˜çš„ä¾‹å­ï¼ç°åœ¨ä½ å¯èƒ½ä¼šæƒ³ï¼šè¿™å¾ˆå®¹æ˜“è§£å†³ï¼åªéœ€è®©æµè§ˆå™¨åœ¨JSæ–‡ä»¶ä¹‹å‰è¯·æ±‚CSSæ–‡ä»¶ï¼ç„¶è€Œï¼Œè‡³å…³é‡è¦çš„æ˜¯ï¼Œæµè§ˆå™¨æ— æ³•é¢„å…ˆçŸ¥é“è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„å“ªä¸€ä¸ªåœ¨è¯·æ±‚æ—¶ä¼šæˆä¸ºæ›´å¤§çš„æ–‡ä»¶ã€‚è¿™æ˜¯å› ä¸ºæ²¡æœ‰åŠæ³•åœ¨HTMLä¸­æŒ‡æ˜æ–‡ä»¶æœ‰å¤šå¤§ï¼ˆç±»ä¼¼è¿™æ ·çš„ä¸œè¥¿å¾ˆä¸é”™ï¼ŒHTMLå·¥ä½œç»„ï¼š<code>&lt;img src=&quot;thisisfine.jpg&quot; size=&quot;15000&quot; /&gt;</code>ï¼‰ã€‚</p><p>è¿™ä¸ªé—®é¢˜çš„â€œçœŸæ­£â€è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨<strong>å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰</strong>ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥å°†æ¯ä¸ªæ–‡ä»¶çš„æœ‰æ•ˆè·è½½ï¼ˆheaderï¼‰åˆ†æˆæ›´å°çš„ç‰‡ï¼ˆpiecesï¼‰æˆ–â€œå—â€ï¼ˆchunksï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ç½‘ç»œä¸Šæ··åˆæˆ–â€œäº¤é”™â€ï¼ˆinterleaveï¼‰è¿™äº›å—ï¼šä¸º JS å‘é€ä¸€ä¸ªå—ï¼Œä¸º CSS å‘é€ä¸€ä¸ªå—ï¼Œç„¶åå†å‘é€å¦ä¸€ä¸ªç”¨äº JSï¼Œç­‰ç­‰ï¼Œç›´åˆ°æ–‡ä»¶è¢«ä¸‹è½½ä¸ºæ­¢ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œè¾ƒå°çš„CSSæ–‡ä»¶å°†æ›´æ—©åœ°ä¸‹è½½ï¼ˆå¹¶ä¸”å¯ç”¨ï¼‰ï¼ŒåŒæ—¶åªå°†è¾ƒå¤§çš„JSæ–‡ä»¶å»¶è¿Ÿä¸€ç‚¹ã€‚ç”¨æ•°å­—å½¢è±¡åŒ–æˆ‘ä»¬ä¼šå¾—åˆ°ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">12121111111111111111111111111111111111111</span><br></pre></td></tr></table></figure><p>ç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œç”±äºåè®®å­˜åœ¨ä¸€äº›åŸºç¡€çš„é™åˆ¶ï¼Œè¿™ç§å¤šè·¯å¤ç”¨åœ¨ HTTP/1.1 ä¸­æ˜¯ä¸å¯èƒ½çš„ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ç»§ç»­æŸ¥çœ‹å¤§èµ„æºå¯¹å°èµ„æºï¼ˆlarge-vs-smallï¼‰åœºæ™¯ï¼Œå› ä¸ºå®ƒå·²ç»åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­æ˜¾ç¤ºäº†ä¸¤ä¸ªè¾ƒå°çš„æ–‡ä»¶ã€‚å¦‚å›¾3ï¼Œæˆ‘ä»¬åªä¸ºä¸¤ä¸ªèµ„æºäº¤é”™4ä¸ªå—ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427211652242.png" alt="image-20240427211652242"></p><center>å›¾3ï¼šæœåŠ¡å™¨ HTTP/1.1 å¤šè·¯å¤ç”¨ script.js å’Œ style.css</center><p>è¿™é‡Œçš„ä¸»è¦é—®é¢˜æ˜¯ HTTP/1.1 æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬åè®®ï¼Œå®ƒåªåœ¨æœ‰æ•ˆè·è½½ï¼ˆpayloadï¼‰çš„å‰é¢é™„åŠ å¤´ï¼ˆheadersï¼‰ã€‚å®ƒä¸ä¼šè¿›ä¸€æ­¥åŒºåˆ†å•ä¸ªï¼ˆå¤§å—ï¼‰èµ„æºä¸å…¶ä»–èµ„æºã€‚è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜è¿™ä¸€ç‚¹ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•äº†å®ƒä¼šå‘ç”Ÿä»€ä¹ˆã€‚åœ¨å›¾3ä¸­ï¼Œæµè§ˆå™¨å¼€å§‹åˆ†æ<code>script.js</code>å¹¶æœŸæœ›åé¢æœ‰1000ä¸ªå­—èŠ‚ï¼ˆContent-Lengthï¼‰çš„æœ‰æ•ˆè·è½½ã€‚ä½†æ˜¯ï¼Œå®ƒåªæ¥æ”¶450ä¸ª JS å­—èŠ‚ï¼ˆç¬¬ä¸€ä¸ªå—ï¼‰ï¼Œç„¶åå¼€å§‹è¯»å–<code>sytle.css</code>çš„å¤´éƒ¨ã€‚å®ƒæœ€ç»ˆå°† CSS å¤´éƒ¨å’Œç¬¬ä¸€ä¸ª CSS å—è§£é‡Šä¸ºJSçš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ–‡ä»¶çš„æœ‰æ•ˆè·è½½å’Œå¤´éƒ½æ˜¯çº¯æ–‡æœ¬ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå®ƒåœ¨è¯»å–1000ä¸ªå­—èŠ‚ååœæ­¢ï¼Œç›´åˆ°ç¬¬äºŒä¸ª<code>script.js</code>å—çš„ä¸€åŠã€‚æ­¤æ—¶ï¼Œå®ƒçœ‹ä¸åˆ°æœ‰æ•ˆçš„æ–°æŠ¥å¤´ï¼Œå¿…é¡»åˆ é™¤ TCP æ•°æ®åŒ…3ï¼ˆpacket 3ï¼‰çš„å…¶ä½™éƒ¨åˆ†ã€‚ç„¶åæµè§ˆå™¨ä¼ é€’å®ƒè®¤ä¸ºçš„å†…å®¹<code>script.js</code>åˆ°JSè§£æå™¨ï¼Œå®ƒå¤±è´¥äº†å› ä¸ºä¸æ˜¯æœ‰æ•ˆçš„ JavaScriptï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">first</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>; &#125;</span><br><span class="line"><span class="variable constant_">HTTP</span>/<span class="number">1.1</span> <span class="number">200</span> <span class="variable constant_">OK</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Length</span>: <span class="number">600</span></span><br><span class="line"></span><br><span class="line">.<span class="property">h1</span> &#123; font-<span class="attr">size</span>: 4em; &#125;</span><br><span class="line">func</span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œæ‚¨å¯ä»¥è¯´æœ‰ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆï¼šè®©æµè§ˆå™¨æŸ¥æ‰¾<code>HTTP/1.1 &#123;statusCode&#125; &#123;statusString&#125;\n</code>æ¨¡å¼æ¥æŸ¥çœ‹æ–°çš„å¤´å—ä½•æ—¶å¼€å§‹ã€‚è¿™å¯èƒ½é€‚ç”¨äº TCP æ•°æ®åŒ…2ï¼ˆpacket 2ï¼‰ï¼Œä½†åœ¨æ•°æ®åŒ…3ï¼ˆpacket 3ï¼‰ä¸­ä¼šå¤±è´¥ï¼šæµè§ˆå™¨å¦‚ä½•çŸ¥é“ç»¿è‰²çš„<code>script.js</code>å—åœ¨å“ªé‡Œç»“æŸå’Œç´«è‰²<code>style.css</code>å—ä»å“ªé‡Œå¼€å§‹ï¼Ÿ</p><p>è¿™æ˜¯ HTTP/1.1 åè®®è®¾è®¡æ–¹å¼çš„ä¸€ä¸ªåŸºç¡€é™åˆ¶ã€‚å¦‚æœæ‚¨åªæœ‰ä¸€ä¸ª HTTP/1.1 è¿æ¥ï¼Œé‚£ä¹ˆåœ¨æ‚¨åˆ‡æ¢åˆ°å‘é€æ–°èµ„æºä¹‹å‰ï¼Œå¿…é¡»<strong>å®Œæ•´åœ°</strong>ä¼ è¾“èµ„æºå“åº”ã€‚å¦‚æœå‰é¢çš„èµ„æºåˆ›å»ºç¼“æ…¢ï¼ˆä¾‹å¦‚ï¼Œä»æ•°æ®åº“æŸ¥è¯¢åŠ¨æ€ç”Ÿæˆçš„<code>index.html</code>ï¼‰æˆ–è€…ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœå‰é¢çš„èµ„æºå¾ˆå¤§ã€‚è¿™äº›é—®é¢˜å¯èƒ½ä¼šå¼•èµ·é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚</p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæµè§ˆå™¨å¼€å§‹ä¸º HTTP/1.1 ä¸Šçš„æ¯ä¸ªé¡µé¢åŠ è½½<a href="https://link.zhihu.com/?target=http%3A//www.stevesouders.com/blog/2008/03/20/roundup-on-parallel-connections/">æ‰“å¼€å¤šä¸ªå¹¶è¡Œ TCP è¿æ¥</a>ï¼ˆé€šå¸¸ä¸º6ä¸ªï¼‰ã€‚è¿™æ ·ï¼Œè¯·æ±‚å¯ä»¥åˆ†å¸ƒåœ¨è¿™äº›å•ç‹¬çš„è¿æ¥ä¸Šï¼Œå¹¶ä¸”ä¸å†æœ‰é˜Ÿå¤´é˜»å¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤éæ¯é¡µæœ‰è¶…è¿‡6ä¸ªèµ„æºâ€¦è¿™å½“ç„¶æ˜¯å¾ˆå¸¸è§çš„ã€‚è¿™å°±æ˜¯åœ¨å¤šä¸ªåŸŸåä¸Šâ€œåˆ†ç‰‡â€ï¼ˆshardingï¼‰èµ„æºçš„å®è·µ(<a href="https://link.zhihu.com/?target=http%3A//img.mysite.com/">img.mysite.com</a>, <a href="http://static.mysite.com">static.mysite.com</a>, ç­‰ï¼‰å’Œ CDN çš„ç”±æ¥ã€‚ç”±äºæ¯ä¸ªå•ç‹¬çš„åŸŸåæœ‰6ä¸ªè¿æ¥ï¼Œæµè§ˆå™¨å°†ä¸ºæ¯ä¸ªé¡µé¢åŠ è½½æ€»å…±æ‰“å¼€ 30-ish ä¸ª TCP è¿æ¥ã€‚è¿™æ˜¯å¯è¡Œçš„ï¼Œä½†æœ‰ç›¸å½“å¤§çš„å¼€é”€ï¼šå»ºç«‹ä¸€ä¸ªæ–°çš„ TCP è¿æ¥å¯èƒ½æ˜¯æ˜‚è´µçš„ï¼ˆä¾‹å¦‚åœ¨æœåŠ¡å™¨ä¸Šçš„çŠ¶æ€å’Œå†…å­˜æ–¹é¢ï¼Œä»¥åŠè®¾ç½® TLS åŠ å¯†çš„è®¡ç®—ï¼‰ï¼Œå¹¶ä¸”éœ€è¦æ¶ˆè€—ä¸€äº›æ—¶é—´ï¼ˆç‰¹åˆ«æ˜¯å¯¹äº HTTPS è¿æ¥ï¼Œå› ä¸º TLS éœ€è¦è‡ªå·±çš„æ¡æ‰‹ï¼‰ã€‚</p><p>ç”±äºè¿™ä¸ªé—®é¢˜ä¸èƒ½ç”¨ HTTP/1.1 è§£å†³ï¼Œè€Œä¸”å¹¶è¡Œ TCP è¿æ¥çš„è¡¥ä¸è§£å†³æ–¹æ¡ˆä¹Ÿä¸èƒ½éšç€æ—¶é—´çš„æ¨ç§»æ‰©å±•å¾—å¤ªå¥½ï¼Œå¾ˆæ˜æ˜¾éœ€è¦ä¸€ç§å…¨æ–°çš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯åæ¥çš„ HTTP/2ã€‚</p><p><em>æ³¨æ„ï¼šé˜…è¯»æœ¬æ–‡çš„è€å“¥å¯èƒ½ä¼šè¡¨ç¤ºæƒ³çŸ¥é“ HTTP/1.1 ç®¡é“ï¼ˆpipeliningï¼‰ã€‚æˆ‘å†³å®šä¸åœ¨è¿™é‡Œè®¨è®ºè¿™ä¸€ç‚¹ï¼Œä»¥ä¿æŒæ•´ä¸ªæ•…äº‹çš„æµç•…æ€§ï¼Œä½†å¯¹æ›´æ·±å…¥çš„æŠ€æœ¯æ„Ÿå…´è¶£çš„äººå¯ä»¥é˜…è¯»ç»“å°¾çš„å½©è›‹éƒ¨åˆ†ã€‚</em></p><h2 id="HTTP-2ï¼ˆåŸºäº-TCPï¼‰çš„é˜Ÿå¤´é˜»å¡"><strong>HTTP/2ï¼ˆåŸºäº TCPï¼‰çš„é˜Ÿå¤´é˜»å¡</strong></h2><p>é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ã€‚HTTP/1.1 æœ‰ä¸€ä¸ªé˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œä¸€ä¸ªå¤§çš„æˆ–æ…¢çš„å“åº”ä¼šå»¶è¿Ÿåé¢çš„å…¶ä»–å“åº”ã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºåè®®æœ¬è´¨ä¸Šæ˜¯çº¯æ–‡æœ¬çš„ï¼Œåœ¨èµ„æºå—ï¼ˆresource chunksï¼‰ä¹‹é—´ä¸ä½¿ç”¨åˆ†éš”ç¬¦ã€‚ä½œä¸ºä¸€ç§è§£å†³åŠæ³•ï¼Œæµè§ˆå™¨æ‰“å¼€è®¸å¤šå¹¶è¡ŒTCPè¿æ¥ï¼Œè¿™æ—¢ä¸é«˜æ•ˆï¼Œä¹Ÿä¸å¯æ‰©å±•ã€‚</p><p>å› æ­¤ï¼ŒHTTP/2 çš„ç›®æ ‡éå¸¸æ˜ç¡®ï¼š<strong>æˆ‘ä»¬èƒ½å¤Ÿå›åˆ°å•ä¸ª TCP è¿æ¥ï¼Œè§£å†³é˜Ÿå¤´é˜»å¡é—®é¢˜</strong>ã€‚æ¢ä¸€ç§è¯´æ³•ï¼šæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ­£ç¡®åœ°å¤ç”¨èµ„æºå—ï¼ˆresource chunksï¼‰ã€‚è¿™åœ¨ HTTP/1.1 ä¸­æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºæ²¡æœ‰åŠæ³•åˆ†è¾¨ä¸€ä¸ªå—å±äºå“ªä¸ªèµ„æºï¼Œæˆ–è€…å®ƒåœ¨å“ªé‡Œç»“æŸï¼Œå¦ä¸€ä¸ªå—ä»å“ªé‡Œå¼€å§‹ã€‚HTTP/2 éå¸¸ä¼˜é›…åœ°è§£å†³äº†è¿™ä¸€é—®é¢˜ï¼Œå®ƒåœ¨èµ„æºå—ä¹‹å‰æ·»åŠ äº†<strong>å¸§ï¼ˆframesï¼‰</strong>ã€‚å¦‚å›¾4æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132443159.png" alt="image-20240427132443159"></p><center>å›¾4ï¼šHTTP/1.1 vs HTTP/2 å“åº” script.js</center><p>HTTP/2 åœ¨æ¯ä¸ªå—å‰é¢æ”¾ç½®ä¸€ä¸ªæ‰€è°“çš„æ•°æ®å¸§ï¼ˆDATA frameï¼‰ã€‚è¿™äº›æ•°æ®å¸§ä¸»è¦åŒ…å«ä¸¤ä¸ªå…³é”®çš„å…ƒæ•°æ®ã€‚é¦–å…ˆï¼šä¸‹é¢çš„å—å±äºå“ªä¸ªèµ„æºã€‚æ¯ä¸ªèµ„æºçš„â€œå­—èŠ‚æµï¼ˆbytestreamï¼‰â€éƒ½è¢«åˆ†é…äº†ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—ï¼Œå³<strong>æµidï¼ˆstream idï¼‰</strong>ã€‚ç¬¬äºŒï¼šå—çš„å¤§å°æ˜¯å¤šå°‘ã€‚åè®®è¿˜æœ‰è®¸å¤šå…¶ä»–å¸§ç±»å‹ï¼Œå›¾5ä¹Ÿæ˜¾ç¤ºäº†å¤´éƒ¨å¸§ï¼ˆHEADERS frameï¼‰ã€‚è¿™å†æ¬¡ä½¿ç”¨æµidï¼ˆstream idï¼‰æ¥æŒ‡å‡ºè¿™äº›å¤´ï¼ˆheadersï¼‰å±äºå“ªä¸ªå“åº”ï¼Œè¿™æ ·ç”šè‡³å¯ä»¥å°†å¤´ï¼ˆheadersï¼‰ä»å®ƒä»¬çš„å®é™…å“åº”æ•°æ®ä¸­åˆ†ç¦»å‡ºæ¥ã€‚</p><p>ä½¿ç”¨è¿™äº›å¸§ï¼ŒHTTP/2 ç¡®å®å…è®¸åœ¨ä¸€ä¸ªè¿æ¥ä¸Šæ­£ç¡®åœ°å¤ç”¨å¤šä¸ªèµ„æºï¼Œå‚è§å›¾5ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132510915.png" alt="image-20240427132510915"></p><center>å›¾5ï¼šHTTP/2 å¤šè·¯å¤ç”¨å“åº” script.js å’Œ style.css</center><p>ä¸å›¾3ä¸­çš„ç¤ºä¾‹ä¸åŒï¼Œæµè§ˆå™¨ç°åœ¨å¯ä»¥å®Œç¾åœ°å¤„ç†è¿™ç§æƒ…å†µã€‚å®ƒé¦–å…ˆå¤„ç†<code>script.js</code>çš„å¤´éƒ¨å¸§ï¼ˆHEADERS frameï¼‰ï¼Œç„¶åæ˜¯ç¬¬ä¸€ä¸ªJSå—çš„æ•°æ®å¸§ï¼ˆDATA frameï¼‰ã€‚ä»æ•°æ®å¸§ï¼ˆDATA frameï¼‰ä¸­åŒ…å«çš„å—é•¿åº¦æ¥çœ‹ï¼Œæµè§ˆå™¨çŸ¥é“å®ƒåªå»¶ä¼¸åˆ° TCP æ•°æ®åŒ…1çš„æœ«å°¾ï¼Œå¹¶ä¸”éœ€è¦ä» TCP æ•°æ®åŒ…2å¼€å§‹å¯»æ‰¾ä¸€ä¸ªå…¨æ–°çš„å¸§ã€‚åœ¨é‚£é‡Œå®ƒç¡®å®æ‰¾åˆ°äº†<code>style.css</code>çš„å¤´ï¼ˆHEADERSï¼‰ï¼Œ ä¸‹ä¸€ä¸ªæ•°æ®å¸§ï¼ˆDATA frameï¼‰å«æœ‰ä¸ç¬¬ä¸€ä¸ªæ•°æ®å¸§ï¼ˆ1ï¼‰ä¸åŒçš„æµ idï¼ˆ2ï¼‰ï¼Œå› æ­¤æµè§ˆå™¨çŸ¥é“è¿™å±äºä¸åŒçš„èµ„æºã€‚åŒæ ·çš„æƒ…å†µä¹Ÿé€‚ç”¨äº TCP æ•°æ®åŒ…3ï¼Œå…¶ä¸­æ•°æ®å¸§ï¼ˆDATA frameï¼‰æµ id ç”¨äºå°†å“åº”å—â€œè§£å¤ç”¨â€ï¼ˆde-multiplexï¼‰åˆ°æ­£ç¡®çš„èµ„æºâ€œæµâ€ï¼ˆstreamsï¼‰ã€‚</p><p>å› æ­¤ï¼Œé€šè¿‡â€œframingâ€å•ä¸ªæ¶ˆæ¯ï¼ŒHTTP/2 æ¯” HTTP/1.1 æ›´åŠ çµæ´»ã€‚å®ƒå…è®¸åœ¨å•ä¸ª TCP è¿æ¥ä¸Šé€šè¿‡äº¤é”™æ’åˆ—å—æ¥å¤šè·¯ä¼ è¾“å¤šä¸ªèµ„æºã€‚å®ƒè¿˜è§£å†³äº†ç¬¬ä¸€ä¸ªèµ„æºç¼“æ…¢æ—¶çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼šè€Œä¸å¿…ç­‰å¾…æŸ¥è¯¢æ•°æ®åº“ç”Ÿæˆçš„<code>index.html</code>ï¼ŒæœåŠ¡å™¨å¯ä»¥åœ¨ç­‰å¾…<code>index.html</code>æ—¶å¼€å§‹å‘é€å…¶ä»–èµ„æºã€‚</p><p>HTTP/2 çš„æ–¹å¼ä¸€ä¸ªé‡è¦ç»“æœæ˜¯ï¼Œæˆ‘ä»¬çªç„¶éœ€è¦ä¸€ç§æ–¹æ³•è®©æµè§ˆå™¨ä¸æœåŠ¡å™¨é€šä¿¡ï¼Œå•ä¸ªè¿æ¥çš„å¸¦å®½å¦‚ä½•è·¨èµ„æºåˆ†å¸ƒï¼ˆdistributedï¼‰ã€‚æ¢ä¸€ç§è¯´æ³•ï¼šèµ„æºå—åº”è¯¥å¦‚ä½•â€œè°ƒåº¦ï¼ˆscheduledï¼‰â€æˆ–äº¤é”™ï¼ˆinterleavedï¼‰ã€‚å¦‚æœæˆ‘ä»¬å†æ¬¡ç”¨ 1 å’Œ 2 æ¥è¡¨ç¤ºï¼Œæˆ‘ä»¬ä¼šå‘ç°å¯¹äº HTTP/1.1ï¼Œå”¯ä¸€çš„é€‰é¡¹æ˜¯11112222ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºé¡ºåºçš„ï¼ˆsequentialï¼‰ï¼‰ã€‚ç„¶è€Œï¼Œ HTTP/2 æœ‰æ›´å¤šçš„è‡ªç”±ï¼š</p><ul><li>å…¬å¹³å¤šè·¯å¤ç”¨ï¼ˆä¾‹å¦‚ä¸¤ä¸ªæ¸è¿›çš„ JPEGsï¼‰ï¼š12121212</li><li>åŠ æƒå¤šè·¯å¤ç”¨ï¼ˆ2æ˜¯1çš„ä¸¤å€ï¼‰ï¼š22122122121</li><li>åå‘é¡ºåºè°ƒåº¦ï¼ˆä¾‹å¦‚2æ˜¯å¯†é’¥æœåŠ¡å™¨æ¨é€çš„èµ„æºï¼‰ï¼š22221111</li><li>éƒ¨åˆ†è°ƒåº¦ï¼ˆæµ1è¢«ä¸­æ­¢ä¸”æœªå®Œæ•´å‘é€ï¼‰ï¼š112222</li></ul><p>ä½¿ç”¨å“ªç§æ–¹æ³•æ˜¯ç”± HTTP/2 ä¸­æ‰€è°“çš„â€œä¼˜å…ˆçº§ï¼ˆprioritizationï¼‰â€ç³»ç»Ÿé©±åŠ¨çš„ï¼Œæ‰€é€‰æ‹©çš„æ–¹æ³•å¯¹Web æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚ç„¶è€Œï¼Œè¿™æœ¬èº«å°±æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„è¯é¢˜ï¼Œä½ ä¸éœ€è¦åœ¨æ¥ä¸‹æ¥çš„åšå®¢æ–‡ç« ä¸­ç†è§£å®ƒï¼Œæ‰€ä»¥æˆ‘ä¸æŠŠå®ƒæ”¾åœ¨è¿™é‡Œè®²äº†ã€‚</p><p>æˆ‘æƒ³æ‚¨ä¼šåŒæ„ï¼Œé€šè¿‡ HTTP/2 çš„å¸§ï¼ˆframesï¼‰åŠå…¶ä¼˜å…ˆçº§è®¾ç½®ï¼Œå®ƒç¡®å®è§£å†³äº† HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚è¿™æ„å‘³ç€æˆ‘åœ¨è¿™é‡Œçš„å·¥ä½œå®Œæˆäº†ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å›å®¶äº†ã€‚å¯¹å—ï¼Ÿå¥½å§ï¼Œæ²¡é‚£ä¹ˆç®€å•ã€‚æˆ‘ä»¬å·²ç»è§£å†³äº† HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡ï¼Œæ˜¯çš„ï¼Œä½†æ˜¯ TCP çš„é˜Ÿå¤´é˜»å¡å‘¢ï¼Ÿ</p><h2 id="TCP-é˜Ÿå¤´é˜»å¡">TCP é˜Ÿå¤´é˜»å¡</h2><p>äº‹å®è¯æ˜ï¼ŒHTTP/2 åªè§£å†³äº† HTTP çº§åˆ«çš„é˜Ÿå¤´é˜»å¡ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸ºâ€œåº”ç”¨å±‚â€é˜Ÿå¤´é˜»å¡ã€‚ç„¶è€Œï¼Œåœ¨å…¸å‹çš„ç½‘ç»œæ¨¡å‹ä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘ä¸‹é¢çš„å…¶ä»–å±‚ã€‚æ‚¨å¯ä»¥åœ¨å›¾6ä¸­æ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132530740.png" alt="image-20240427132530740"></p><center>å›¾6ï¼šå…¸å‹ç½‘ç»œæ¨¡å‹ä¸­çš„å‡ ä¸ªåè®®å±‚</center><p>HTTP ä½äºé¡¶å±‚ï¼Œä½†é¦–å…ˆç”±å®‰å…¨å±‚çš„ TLS æ”¯æŒï¼ˆè¯·å‚é˜…â€œå½©è›‹ TLSâ€éƒ¨åˆ†ï¼‰ï¼Œç„¶åæ¥ç€å†ç”±ä¼ è¾“å±‚çš„ TCP ä¼ è¾“ã€‚è¿™äº›åè®®ä¸­çš„æ¯ä¸€å±‚éƒ½ç”¨ä¸€äº›å…ƒæ•°æ®åŒ…è£…æ¥è‡ªå…¶ä¸Šä¸€å±‚çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ HTTP(S) æ•°æ®ä¸­é¢„å…ˆåŠ ä¸Š TCP åŒ…å¤´ï¼ˆpacket headerï¼‰ï¼Œç„¶åå°†å…¶æ”¾å…¥ IP åŒ…ç­‰ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åè®®ä¹‹é—´å®ç°ç›¸å¯¹ç®€æ´çš„åˆ†ç¦»ã€‚è¿™åè¿‡æ¥åˆæœ‰åˆ©äºå®ƒä»¬çš„å¯é‡ç”¨æ€§ï¼šåƒ TCP è¿™æ ·çš„ä¼ è¾“å±‚åè®®ä¸å¿…å…³å¿ƒå®ƒæ­£åœ¨ä¼ è¾“ä»€ä¹ˆç±»å‹çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ HTTPï¼Œä¹Ÿå¯ä»¥æ˜¯ FTPï¼Œä¹Ÿå¯ä»¥æ˜¯ SSHï¼Œè°çŸ¥é“å‘¢ï¼‰ï¼Œè€Œä¸” IP å¯¹äº TCP å’Œ UDP éƒ½èƒ½å¾ˆå¥½åœ°å·¥ä½œã€‚</p><p>ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°†å¤šä¸ª HTTP/2 èµ„æºå¤šè·¯ä¼ è¾“åˆ°ä¸€ä¸ª TCP è¿æ¥ä¸Šï¼Œè¿™ç¡®å®ä¼šäº§ç”Ÿé‡è¦çš„åæœã€‚å¦‚å›¾7ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132541483.png" alt="image-20240427132541483"></p><center>å›¾7ï¼šHTTP/2 å’Œ TCP åœ¨é€è§†å›¾ä¸Šçš„å·®å¼‚</center><p>è™½ç„¶æˆ‘ä»¬å’Œæµè§ˆå™¨éƒ½çŸ¥é“æˆ‘ä»¬æ­£åœ¨è·å– JavaScript å’Œ CSS æ–‡ä»¶ï¼Œä½† HTTP/2 ä¸éœ€è¦çŸ¥é“è¿™ä¸€ç‚¹ã€‚å®ƒåªçŸ¥é“å®ƒåœ¨ä½¿ç”¨æ¥è‡ªä¸åŒèµ„æºæµ id ï¼ˆstream idï¼‰çš„å—ã€‚ç„¶è€Œï¼Œ**TCP ç”šè‡³ä¸çŸ¥é“å®ƒåœ¨ä¼ è¾“ HTTPï¼**TCP æ‰€çŸ¥é“çš„å°±æ˜¯å®ƒè¢«èµ‹äºˆäº†ä¸€ç³»åˆ—å­—èŠ‚ï¼Œå®ƒå¿…é¡»ä»ä¸€å°è®¡ç®—æœºä¼ è¾“å¦ä¸€å°è®¡ç®—æœºã€‚ä¸ºæ­¤ï¼Œå®ƒä½¿ç”¨ç‰¹å®šæœ€å¤§å¤§å°ï¼ˆmaximum sizeï¼‰çš„æ•°æ®åŒ…ï¼Œé€šå¸¸å¤§çº¦ä¸º1450å­—èŠ‚ã€‚æ¯ä¸ªæ•°æ®åŒ…åªè·Ÿè¸ªå®ƒæºå¸¦çš„æ•°æ®çš„é‚£ä¸€éƒ¨åˆ†ï¼ˆå­—èŠ‚èŒƒå›´ï¼‰ï¼Œè¿™æ ·åŸå§‹æ•°æ®å°±å¯ä»¥æŒ‰ç…§æ­£ç¡®çš„é¡ºåºé‡å»ºã€‚</p><p>æ¢è¨€ä¹‹ï¼Œè¿™ä¸¤ä¸ªå±‚ä¹‹é—´çš„é€è§†å›¾æ˜¯ä¸åŒ¹é…çš„ï¼šHTTP/2 å¯ä»¥çœ‹åˆ°å¤šä¸ªç‹¬ç«‹çš„èµ„æºå­—èŠ‚æµï¼ˆbytestreamï¼‰ï¼Œè€Œ TCP åªçœ‹åˆ°ä¸€ä¸ªä¸é€æ˜çš„å­—èŠ‚æµï¼ˆbytestreamsï¼‰ã€‚å›¾7çš„TCPæ•°æ®åŒ…3å°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼šTCP åªçŸ¥é“å®ƒæ­£åœ¨ä¼ è¾“çš„ä»»ä½•å†…å®¹çš„å­—èŠ‚ 750 åˆ°å­—èŠ‚1 599ã€‚å¦ä¸€æ–¹é¢ï¼ŒHTTP/2 çŸ¥é“æ•°æ®åŒ…3ä¸­å®é™…ä¸Šæœ‰ä¸¤ä¸ªç‹¬ç«‹èµ„æºçš„ä¸¤ä¸ªå—ã€‚<em>ï¼ˆæ³¨æ„ï¼šå®é™…ä¸Šï¼Œæ¯ä¸ª HTTP/2 å¸§ï¼ˆå¦‚ DATA å’Œ HEADERSï¼‰çš„å¤§å°ä¹Ÿæœ‰å‡ ä¸ªå­—èŠ‚ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘æ²¡æœ‰è®¡ç®—é¢å¤–çš„å¼€é”€æˆ–è¿™é‡Œçš„ HEADERS å¸§ï¼Œä»¥ä½¿æ•°å­—æ›´ç›´è§‚ã€‚ï¼‰</em></p><p>æ‰€æœ‰è¿™äº›çœ‹èµ·æ¥éƒ½æ˜¯ä¸å¿…è¦çš„ç»†èŠ‚ï¼Œç›´åˆ°ä½ æ„è¯†åˆ°äº’è”ç½‘æ˜¯ä¸€ä¸ªæ ¹æœ¬ä¸å¯é çš„ç½‘ç»œã€‚åœ¨ä»ä¸€ä¸ªç«¯ç‚¹åˆ°å¦ä¸€ä¸ªç«¯ç‚¹çš„ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œæ•°æ®åŒ…ä¼šä¸¢å¤±å’Œå»¶è¿Ÿã€‚TCP çš„å¯é æ€§æ­£æ˜¯å…¶æœ€å—æ¬¢è¿çš„åŸå› ä¹‹ä¸€ã€‚å®ƒåªéœ€é‡<strong>æ–°ä¼ è¾“ä¸¢å¤±æ•°æ®åŒ…çš„å‰¯æœ¬</strong>å°±å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ç†è§£ä¼ è¾“å±‚æ˜¯å¦‚ä½•å¯¼è‡´é˜Ÿå¤´é˜»å¡çš„ã€‚å†æ¬¡æ€è€ƒä¸‹å›¾7å¹¶é—®è‡ªå·±ï¼šå¦‚æœ TCP æ•°æ®åŒ…2åœ¨ç½‘ç»œä¸­ä¸¢å¤±ï¼Œä½†æ•°æ®åŒ…1å’Œæ•°æ®åŒ…3å·²ç»åˆ°è¾¾ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿè¯·è®°ä½ï¼ŒTCPå¹¶ä¸çŸ¥é“å®ƒæ­£åœ¨æ‰¿è½½ HTTP/2ï¼ŒåªçŸ¥é“å®ƒéœ€è¦æŒ‰é¡ºåºä¼ é€’æ•°æ®ã€‚å› æ­¤ï¼Œå®ƒçŸ¥é“æ•°æ®åŒ…1çš„å†…å®¹å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¹¶å°†è¿™äº›å†…å®¹ä¼ é€’ç»™æµè§ˆå™¨ã€‚ç„¶è€Œï¼Œå®ƒå‘ç°æ•°æ®åŒ…1ä¸­çš„å­—èŠ‚å’Œæ•°æ®åŒ…3ä¸­çš„å­—èŠ‚ï¼ˆæ”¾æ•°æ®åŒ…2 çš„åœ°æ–¹ï¼‰ä¹‹é—´å­˜åœ¨é—´éš™ï¼Œå› æ­¤è¿˜ä¸èƒ½å°†æ•°æ®åŒ…3ä¼ é€’ç»™æµè§ˆå™¨ã€‚TCP å°†æ•°æ®åŒ…3ä¿å­˜åœ¨å…¶æ¥æ”¶ç¼“å†²åŒºï¼ˆreceive bufferï¼‰ä¸­ï¼Œç›´åˆ°å®ƒæ¥æ”¶åˆ°æ•°æ®åŒ…2çš„é‡ä¼ å‰¯æœ¬ï¼ˆè¿™è‡³å°‘éœ€è¦å¾€è¿”æœåŠ¡å™¨ä¸€æ¬¡ï¼‰ï¼Œä¹‹åå®ƒå¯ä»¥æŒ‰ç…§æ­£ç¡®çš„é¡ºåºå°†è¿™ä¸¤ä¸ªæ•°æ®åŒ…éƒ½ä¼ é€’ç»™æµè§ˆå™¨ã€‚æ¢ä¸ªè¯´æ³•ï¼š<strong>ä¸¢å¤±çš„æ•°æ®åŒ…2 é˜Ÿå¤´é˜»å¡ï¼ˆHOL blockingï¼‰æ•°æ®åŒ…3ï¼</strong></p><p>æ‚¨å¯èƒ½ä¸æ¸…æ¥šä¸ºä»€ä¹ˆè¿™æ˜¯ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°ç ”ç©¶å›¾7ä¸­ HTTP å±‚çš„ TCP åŒ…ä¸­çš„å®é™…å†…å®¹ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTCP æ•°æ®åŒ…2åªæºå¸¦æµid 2ï¼ˆCSSæ–‡ä»¶ï¼‰çš„æ•°æ®ï¼Œæ•°æ®åŒ…3åŒæ—¶æºå¸¦æµ1ï¼ˆJSæ–‡ä»¶ï¼‰å’Œæµ2çš„æ•°æ®ã€‚åœ¨ HTTP çº§åˆ«ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸¤ä¸ªæµæ˜¯ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”ç”±æ•°æ®å¸§ï¼ˆDATA frameï¼‰æ¸…æ¥šåœ°æè¿°å‡ºæ¥ã€‚å› æ­¤ï¼Œç†è®ºä¸Šæˆ‘ä»¬å¯ä»¥å®Œç¾åœ°å°†æ•°æ®åŒ…3ä¼ é€’ç»™æµè§ˆå™¨ï¼Œè€Œä¸å¿…ç­‰å¾…æ•°æ®åŒ…2åˆ°è¾¾ã€‚æµè§ˆå™¨å°†çœ‹åˆ°æµidä¸º1çš„æ•°æ®å¸§ï¼Œå¹¶ä¸”èƒ½å¤Ÿç›´æ¥ä½¿ç”¨å®ƒã€‚åªæœ‰æµ2å¿…é¡»è¢«æŒ‚èµ·ï¼Œç­‰å¾…æ•°æ®åŒ…2çš„é‡æ–°ä¼ è¾“ã€‚è¿™å°†æ¯”æˆ‘ä»¬ä» TCP çš„æ–¹å¼ä¸­å¾—åˆ°çš„æ•ˆç‡æ›´é«˜ï¼ŒTCP çš„æ–¹å¼æœ€ç»ˆä¼šé˜»å¡æµ1å’Œæµ2ã€‚</p><p>å¦ä¸€ä¸ªä¾‹å­æ˜¯æ•°æ®åŒ…1ä¸¢å¤±ï¼Œä½†æ˜¯æ¥æ”¶åˆ°2å’Œ3çš„æƒ…å†µã€‚TCPå°†å†æ¬¡é˜»æ­¢æ•°æ®åŒ…2å’Œ3ï¼Œç­‰å¾…1ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨HTTP/2çº§åˆ«ï¼Œæµ2çš„æ•°æ®ï¼ˆCSSæ–‡ä»¶ï¼‰å®Œå…¨å­˜åœ¨äºæ•°æ®åŒ…2å’Œ3ä¸­ï¼Œä¸å¿…ç­‰å¾…æ•°æ®åŒ…1çš„é‡æ–°ä¼ è¾“ã€‚æµè§ˆå™¨æœ¬å¯ä»¥å®Œç¾åœ°è§£æ/å¤„ç†/ä½¿ç”¨ CSS æ–‡ä»¶ï¼Œä½†å´è¢«å›°åœ¨ç­‰å¾… JS æ–‡ä»¶çš„é‡æ–°ä¼ è¾“ã€‚</p><p>æ€»ä¹‹ï¼ŒTCP ä¸çŸ¥é“ HTTP/2 çš„ç‹¬ç«‹æµï¼ˆstreamsï¼‰è¿™ä¸€äº‹å®æ„å‘³ç€ <strong>TCP å±‚é˜Ÿå¤´é˜»å¡ï¼ˆç”±äºä¸¢å¤±æˆ–å»¶è¿Ÿçš„æ•°æ®åŒ…ï¼‰ä¹Ÿæœ€ç»ˆå¯¼è‡´ HTTP é˜Ÿå¤´é˜»å¡ï¼</strong></p><p>ç°åœ¨ï¼Œæ‚¨å¯èƒ½ä¼šé—®è‡ªå·±ï¼šé‚£é‡ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœæˆ‘ä»¬ä»ç„¶æœ‰ TCP é˜Ÿå¤´é˜»å¡ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨HTTP/2 å‘¢ï¼Ÿå¥½å§ï¼Œä¸»è¦åŸå› æ˜¯è™½ç„¶æ•°æ®åŒ…ä¸¢å¤±ç¡®å®å‘ç”Ÿåœ¨ç½‘ç»œä¸Šï¼Œä½†è¿˜æ˜¯æ¯”è¾ƒå°‘è§çš„ã€‚ç‰¹åˆ«æ˜¯åœ¨æœ‰çº¿ç½‘ç»œä¸­ï¼ŒåŒ…ä¸¢å¤±ç‡åªæœ‰ 0.01%ã€‚å³ä½¿æ˜¯åœ¨æœ€å·®çš„èœ‚çªç½‘ç»œä¸Šï¼Œåœ¨ç°å®ä¸­ï¼Œæ‚¨ä¹Ÿå¾ˆå°‘çœ‹åˆ°ä¸¢åŒ…ç‡é«˜äº2%ã€‚è¿™ä¸æ•°æ®åŒ…ä¸¢å¤±å’ŒæŠ–åŠ¨ï¼ˆç½‘ç»œä¸­çš„å»¶è¿Ÿå˜åŒ–ï¼‰é€šå¸¸æ˜¯<strong>çªå‘æ€§</strong>çš„è¿™ä¸€äº‹å®ç»“åˆåœ¨ä¸€èµ·çš„ã€‚åŒ…ä¸¢å¤±ç‡ä¸º2%å¹¶ä¸æ„å‘³ç€æ¯100ä¸ªåŒ…ä¸­æ€»æ˜¯æœ‰2ä¸ªåŒ…ä¸¢å¤±ï¼ˆä¾‹å¦‚æ•°æ®åŒ… 42 å’Œ 96ï¼‰ã€‚å®é™…ä¸Šï¼Œå¯èƒ½æ›´åƒæ˜¯åœ¨æ€»å…±500ä¸ªåŒ…ä¸­ä¸¢å¤±10ä¸ª<strong>è¿ç»­çš„</strong>åŒ…ï¼ˆä¾‹å¦‚æ•°æ®åŒ…255åˆ°265ï¼‰ã€‚è¿™æ˜¯å› ä¸ºæ•°æ®åŒ…ä¸¢å¤±é€šå¸¸æ˜¯ç”±ç½‘ç»œè·¯å¾„ä¸­çš„è·¯ç”±å™¨å†…å­˜ç¼“å†²åŒºæš‚æ—¶æº¢å‡ºå¼•èµ·çš„ï¼Œè¿™äº›ç¼“å†²åŒºå¼€å§‹ä¸¢å¼ƒæ— æ³•å­˜å‚¨çš„æ•°æ®åŒ…ã€‚ä¸è¿‡ï¼Œç»†èŠ‚åœ¨è¿™é‡Œå¹¶ä¸é‡è¦ã€‚é‡è¦çš„æ˜¯ï¼šæ˜¯çš„ï¼ŒTCP é˜Ÿå¤´é˜»å¡æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œä½†æ˜¯å®ƒå¯¹ Web æ€§èƒ½çš„å½±å“è¦æ¯”HTTP/1.1 é˜Ÿå¤´é˜»å¡å°å¾—å¤šï¼ŒHTTP/1.1 é˜Ÿå¤´é˜»å¡å‡ ä¹å¯ä»¥ä¿è¯æ¯æ¬¡éƒ½ä¼šé‡åˆ°å®ƒï¼Œè€Œä¸”å®ƒä¹Ÿä¼šå—åˆ° TCP é˜Ÿå¤´é˜»å¡çš„å½±å“ï¼</p><p>ç„¶è€Œï¼Œå½“æ¯”è¾ƒå•ä¸ªè¿æ¥ä¸Šçš„ HTTP/2 å’Œå•ä¸ªè¿æ¥ä¸Šçš„ HTTP/1.1 æ—¶ï¼Œè¿™ä¸ªåŸºæœ¬ä¸Šæ˜¯çœŸçš„ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€çœ‹åˆ°çš„ï¼Œå®é™…ä¸Šå®ƒå¹¶ä¸æ˜¯è¿™æ ·å·¥ä½œçš„ï¼Œå› ä¸º HTTP/1.1 é€šå¸¸ä¼šæ‰“å¼€å¤šä¸ªè¿æ¥ã€‚è¿™ä½¿å¾— HTTP/1.1 ä¸ä»…åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡è½»äº† HTTP çº§åˆ«ï¼Œè€Œä¸”å‡è½»äº† TCP çº§åˆ«çš„é˜Ÿå¤´é˜»å¡ã€‚å› æ­¤ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå•ä¸ªè¿æ¥ä¸Šçš„ HTTP/2 å¾ˆéš¾æ¯”6ä¸ªè¿æ¥ä¸Šçš„ HTTP/1.1 å¿«ï¼Œç”šè‡³ä¸ HTTP/1.1 ä¸€æ ·å¿«ã€‚è¿™ä¸»è¦æ˜¯ç”±äº TCP çš„**â€œæ‹¥å¡æ§åˆ¶â€ï¼ˆcongestion controlï¼‰**æœºåˆ¶ã€‚ç„¶è€Œï¼Œè¿™æ˜¯å¦ä¸€ä¸ªéå¸¸æ·±å…¥çš„è¯é¢˜ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬è®¨è®ºé˜Ÿå¤´é˜»å¡ï¼ˆHOL blockingï¼‰çš„æ ¸å¿ƒï¼Œæ‰€ä»¥æˆ‘æŠŠå®ƒç§»åˆ°äº†æœ«å°¾çš„å¦ä¸€ä¸ªå½©è›‹éƒ¨åˆ†ã€‚</p><p>æ€»ä¹‹ï¼Œäº‹å®ä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼ˆä¹Ÿè®¸å‡ºä¹æ„æ–™ï¼‰ï¼Œ<strong>HTTP/2 ç›®å‰éƒ¨ç½²åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¸­ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹é€šå¸¸ä¸ HTTP/1.1 ä¸€æ ·å¿«æˆ–ç•¥å¿«</strong>ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™éƒ¨åˆ†æ˜¯å› ä¸ºç½‘ç«™åœ¨ä¼˜åŒ– HTTP/2 æ–¹é¢åšå¾—æ›´å¥½ï¼Œéƒ¨åˆ†åŸå› æ˜¯æµè§ˆå™¨ä»ç„¶ç»å¸¸æ‰“å¼€å¤šä¸ªå¹¶è¡Œ HTTP/2 è¿æ¥ï¼Œä»è€Œä½¿ä¸¤è€…å…¼å¾—ã€‚</p><p>ç„¶è€Œï¼Œä¹Ÿæœ‰ä¸€äº›æƒ…å†µï¼ˆç‰¹åˆ«æ˜¯åœ¨æ•°æ®åŒ…ä¸¢å¤±ç‡è¾ƒé«˜çš„ä½é€Ÿç½‘ç»œä¸Šï¼‰ï¼Œ6ä¸ªè¿æ¥çš„ HTTP/1.1 ä»ç„¶æ¯”ä¸€ä¸ªè¿æ¥çš„ HTTP/2 æ›´ä¸ºå‡ºè‰²ï¼Œè¿™é€šå¸¸æ˜¯ç”±äº TCP çº§åˆ«çš„é˜Ÿå¤´é˜»å¡é—®é¢˜é€ æˆçš„ã€‚æ­£æ˜¯è¿™ä¸ªäº‹å®æå¤§åœ°æ¨åŠ¨äº†æ–°çš„ QUIC ä¼ è¾“åè®®çš„å¼€å‘ï¼Œä»¥å–ä»£ TCPã€‚</p><h2 id="HTTP-3ï¼ˆåŸºäº-QUICï¼‰çš„é˜Ÿå¤´é˜»å¡">HTTP/3ï¼ˆåŸºäº QUICï¼‰çš„é˜Ÿå¤´é˜»å¡</h2><p>åœ¨é‚£ä¹‹åï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å¼€å§‹è°ˆè®ºæ–°çš„ä¸œè¥¿äº†ï¼ä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹æˆ‘ä»¬ç›®å‰æ‰€å­¦åˆ°çš„ï¼š</p><ul><li>HTTP/1.1 æœ‰é˜Ÿå¤´é˜»å¡ï¼Œå› ä¸ºå®ƒéœ€è¦å®Œæ•´åœ°å‘é€å“åº”ï¼Œå¹¶ä¸”ä¸èƒ½å¤šè·¯å¤ç”¨å®ƒä»¬</li><li>HTTP/2 é€šè¿‡å¼•å…¥â€œå¸§â€ï¼ˆframesï¼‰æ ‡è¯†æ¯ä¸ªèµ„æºå—å±äºå“ªä¸ªâ€œæµâ€ï¼ˆstreamï¼‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜</li><li>ç„¶è€Œï¼ŒTCP ä¸çŸ¥é“è¿™äº›å•ç‹¬çš„â€œæµâ€ï¼ˆstreamsï¼‰ï¼Œåªæ˜¯æŠŠæ‰€æœ‰çš„ä¸œè¥¿çœ‹ä½œä¸€ä¸ªå¤§æµï¼ˆ1 big streamï¼‰</li><li>å¦‚æœä¸€ä¸ª TCP åŒ…ä¸¢å¤±ï¼Œæ‰€æœ‰åç»­çš„åŒ…éƒ½éœ€è¦ç­‰å¾…å®ƒçš„é‡ä¼ ï¼Œå³ä½¿å®ƒä»¬åŒ…å«æ¥è‡ªä¸åŒæµçš„æ— å…³è”æ•°æ®ã€‚TCP å…·æœ‰ä¼ è¾“å±‚é˜Ÿå¤´é˜»å¡ã€‚</li></ul><p>æˆ‘æ•¢è‚¯å®šä½ ç°åœ¨å¯ä»¥é¢„æµ‹æˆ‘ä»¬å¦‚ä½•è§£å†³ TCP çš„é—®é¢˜ï¼Œå¯¹å§ï¼Ÿæ¯•ç«Ÿï¼Œè§£å†³æ–¹æ¡ˆå¾ˆç®€å•ï¼šæˆ‘ä»¬â€œåªæ˜¯â€éœ€è¦<strong>è®©ä¼ è¾“å±‚çŸ¥é“ä¸åŒçš„ã€ç‹¬ç«‹çš„æµ</strong>ï¼è¿™æ ·ï¼Œå¦‚æœä¸€ä¸ªæµçš„æ•°æ®ä¸¢å¤±ï¼Œä¼ è¾“å±‚æœ¬èº«å°±çŸ¥é“å®ƒä¸éœ€è¦é˜»å¡å…¶ä»–æµã€‚</p><p>å°½ç®¡è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ¦‚å¿µç®€å•ï¼Œä½†åœ¨ç°å®ä¸­å´å¾ˆéš¾å®ç°ã€‚ç”±äºå„ç§åŸå› ï¼Œä¸å¯èƒ½æ”¹å˜ TCP æœ¬èº«ä½¿å…¶å…·æœ‰æµæ„è¯†ï¼ˆstream-awareï¼‰ã€‚é€‰æ‹©çš„æ›¿ä»£æ–¹æ³•æ˜¯ä»¥ QUIC çš„å½¢å¼å®ç°ä¸€ä¸ªå…¨æ–°çš„ä¼ è¾“å±‚åè®®ã€‚ä¸ºäº†ä½¿ QUIC ç°å®ä¸­å¯ä»¥éƒ¨ç½²åœ¨å› ç‰¹ç½‘ä¸Šï¼Œå®ƒè¿è¡Œåœ¨ä¸å¯é çš„ UDP åè®®ä¹‹ä¸Šã€‚ç„¶è€Œï¼Œéå¸¸é‡è¦çš„æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€ QUIC æœ¬èº«ä¹Ÿæ˜¯ä¸å¯é çš„ï¼åœ¨è®¸å¤šæ–¹é¢ï¼ŒQUIC åº”è¯¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ª TCP 2.0ã€‚å®ƒåŒ…æ‹¬ TCP çš„æ‰€æœ‰ç‰¹æ€§ï¼ˆå¯é æ€§ã€æ‹¥å¡æ§åˆ¶ã€æµé‡æ§åˆ¶ã€æ’åºç­‰ï¼‰çš„æœ€ä½³ç‰ˆæœ¬ï¼Œä»¥åŠæ›´å¤šå…¶ä»–ç‰¹æ€§ã€‚QUICè¿˜å®Œå…¨é›†æˆäº†TLSï¼ˆå‚è§å›¾6ï¼‰ï¼Œå¹¶ä¸”ä¸å…è®¸æœªåŠ å¯†çš„è¿æ¥ã€‚å› ä¸º QUIC ä¸ TCP å¦‚æ­¤ä¸åŒï¼Œè¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ä»…ä»…åœ¨å…¶ä¸Šè¿è¡Œ HTTP/2ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåˆ›å»ºäº† HTTP/3ï¼ˆç¨åæˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼‰ã€‚è¿™ç¯‡åšæ–‡å·²ç»è¶³å¤Ÿé•¿äº†ï¼Œä¸éœ€è¦æ›´è¯¦ç»†åœ°è®¨è®ºQUICï¼Œå› æ­¤æˆ‘å°†åªå…³æ³¨æˆ‘ä»¬éœ€è¦äº†è§£å½“å‰é˜Ÿå¤´é˜»å¡è®¨è®ºçš„å‡ ä¸ªéƒ¨åˆ†ã€‚å¦‚å›¾8æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132618174.png" alt="image-20240427132618174"></p><center>å›¾8ï¼šHTTP/1.1 vs HTTP/2 vs HTTP/3 å“åº” script.js</center><p>æˆ‘ä»¬è§‚å¯Ÿåˆ°ï¼Œè®© QUIC çŸ¥é“ä¸åŒçš„æµï¼ˆstreamsï¼‰æ˜¯éå¸¸ç®€å•çš„ã€‚QUIC å—åˆ° HTTP/2 å¸§æ–¹å¼ï¼ˆframing-approachï¼‰çš„å¯å‘ï¼Œè¿˜æ·»åŠ äº†è‡ªå·±çš„å¸§ï¼ˆframesï¼‰ï¼›åœ¨æœ¬ä¾‹ä¸­æ˜¯æµå¸§ï¼ˆSTREAM frameï¼‰ã€‚æµidï¼ˆstream idï¼‰ä»¥å‰åœ¨ HTTP/2 çš„æ•°æ®å¸§ï¼ˆDATA frameï¼‰ä¸­ï¼Œç°åœ¨è¢«<strong>ä¸‹ç§»åˆ°ä¼ è¾“å±‚çš„ QUIC æµå¸§ï¼ˆSTREAM frameï¼‰ä¸­</strong>ã€‚è¿™ä¹Ÿè¯´æ˜äº†å¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨ QUICï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ HTTP çš„åŸå› ä¹‹ä¸€ï¼šå¦‚æœæˆ‘ä»¬åªåœ¨ QUIC ä¹‹ä¸Šè¿è¡Œ HTTP/2ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æœ‰ä¸¤ä¸ªï¼ˆå¯èƒ½å†²çªçš„ï¼‰â€œæµå±‚â€ï¼ˆstream layersï¼‰ã€‚ç›¸åï¼ŒHTTP/3 ä» HTTP å±‚åˆ é™¤äº†æµçš„æ¦‚å¿µï¼ˆå®ƒçš„æ•°æ®å¸§ï¼ˆDATA framesï¼‰æ²¡æœ‰æµidï¼‰ï¼Œè€Œæ˜¯é‡æ–°ä½¿ç”¨åº•å±‚çš„ QUIC æµã€‚</p><p><em>æ³¨æ„ï¼šè¿™å¹¶ä¸æ„å‘³ç€ QUIC çªç„¶çŸ¥é“ JS æˆ– CSS æ–‡ä»¶ï¼Œç”šè‡³çŸ¥é“å®ƒæ­£åœ¨ä¼ è¾“ HTTPï¼›å’Œ TCP ä¸€æ ·ï¼ŒQUIC åº”è¯¥æ˜¯ä¸€ä¸ªé€šç”¨çš„ã€å¯é‡ç”¨çš„åè®®ã€‚å®ƒåªçŸ¥é“æœ‰ç‹¬ç«‹çš„æµï¼ˆstreamsï¼‰ï¼Œå®ƒå¯ä»¥å•ç‹¬å¤„ç†ï¼Œè€Œä¸å¿…çŸ¥é“å®ƒä»¬åˆ°åº•æ˜¯ä»€ä¹ˆã€‚</em></p><p>ç°åœ¨æˆ‘ä»¬äº†è§£äº†QUICçš„æµå¸§ï¼ˆSTREAM framesï¼‰ï¼Œä¹Ÿå¾ˆå®¹æ˜“çœ‹å‡ºå®ƒä»¬å¦‚ä½•å¸®åŠ©è§£å†³å›¾9ä¸­çš„ä¼ è¾“å±‚é˜Ÿå¤´é˜»å¡ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132627615.png" alt="image-20240427132627615"></p><center>å›¾9ï¼šTCP å’Œ QUIC åœ¨é€è§†å›¾ä¸Šçš„å·®å¼‚</center><p>ä¸ HTTP/2 çš„æ•°æ®å¸§ï¼ˆDATA framesï¼‰éå¸¸ç›¸ä¼¼ï¼Œ<strong>QUIC çš„æµå¸§ï¼ˆSTREAM framesï¼‰åˆ†åˆ«è·Ÿè¸ªæ¯ä¸ªæµçš„å­—èŠ‚èŒƒå›´</strong>ã€‚è¿™ä¸ TCP ä¸åŒï¼ŒTCP åªæ˜¯å°†æ‰€æœ‰æµæ•°æ®é™„åŠ åˆ°ä¸€ä¸ªå¤§ blob ä¸­ã€‚åƒä»¥å‰ä¸€æ ·ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚æœ QUIC æ•°æ®åŒ…2ä¸¢å¤±ï¼Œè€Œ 1 å’Œ 3 åˆ°è¾¾ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ä¸ TCP ç±»ä¼¼ï¼Œæ•°æ®åŒ…1ä¸­æµ1ï¼ˆstream 1ï¼‰çš„æ•°æ®å¯ä»¥ç›´æ¥ä¼ é€’åˆ°æµè§ˆå™¨ã€‚ç„¶è€Œï¼Œå¯¹äºæ•°æ®åŒ…3ï¼ŒQUIC å¯ä»¥æ¯” TCP æ›´èªæ˜ã€‚å®ƒæŸ¥çœ‹æµ1çš„å­—èŠ‚èŒƒå›´ï¼Œå‘ç°è¿™ä¸ªæµå¸§ï¼ˆSTREAM frameï¼‰å®Œå…¨éµå¾ªæµid 1çš„ç¬¬ä¸€ä¸ªæµå¸§ STREAM frameï¼ˆå­—èŠ‚ 450 è·Ÿåœ¨å­—èŠ‚ 449 ä¹‹åï¼Œå› æ­¤æ•°æ®ä¸­æ²¡æœ‰å­—èŠ‚é—´éš™ï¼‰ã€‚å®ƒå¯ä»¥ç«‹å³å°†è¿™äº›æ•°æ®æä¾›ç»™æµè§ˆå™¨è¿›è¡Œå¤„ç†ã€‚ç„¶è€Œï¼Œå¯¹äºæµid 2ï¼ŒQUICç¡®å®çœ‹åˆ°äº†ä¸€ä¸ªç¼ºå£ï¼ˆå®ƒè¿˜æ²¡æœ‰æ¥æ”¶åˆ°å­—èŠ‚0-299ï¼Œè¿™äº›å­—èŠ‚åœ¨ä¸¢å¤±çš„ QUIC æ•°æ®åŒ…2ä¸­ï¼‰ã€‚å®ƒå°†ä¿å­˜è¯¥æµå¸§ï¼ˆSTREAM frameï¼‰ï¼Œç›´åˆ° QUIC æ•°æ®åŒ…2çš„é‡ä¼ ï¼ˆretransmissionï¼‰åˆ°è¾¾ã€‚å†æ¬¡å°†å…¶ä¸ TCP è¿›è¡Œå¯¹æ¯”ï¼Œåè€…ä¹Ÿå°†æ•°æ®æµ1çš„æ•°æ®ä¿ç•™åœ¨æ•°æ®åŒ…3ä¸­ï¼</p><p>ç±»ä¼¼çš„æƒ…å†µå‘ç”Ÿåœ¨å¦ä¸€ç§æƒ…å½¢ä¸‹ï¼Œæ•°æ®åŒ…1ä¸¢å¤±ï¼Œä½†2å’Œ3åˆ°è¾¾ã€‚QUIC çŸ¥é“å®ƒå·²ç»æ¥æ”¶åˆ°æµ2ï¼ˆstream 2ï¼‰çš„æ‰€æœ‰é¢„æœŸæ•°æ®ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™æµè§ˆå™¨ï¼Œåªä¿ç•™æµ1ï¼ˆstream 1ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­ï¼ŒQUIC ç¡®å®è§£å†³äº† TCP çš„é˜Ÿå¤´é˜»å¡ï¼</p><p>ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼æœ‰å‡ ä¸ªé‡è¦çš„åæœã€‚æœ€æœ‰å½±å“çš„æ˜¯ <strong>QUIC æ•°æ®å¯èƒ½ä¸å†ä»¥ä¸å‘é€æ—¶å®Œå…¨ç›¸åŒçš„é¡ºåºå‘é€åˆ°æµè§ˆå™¨</strong>ã€‚å¯¹äº TCPï¼Œå¦‚æœæ‚¨å‘é€æ•°æ®åŒ…1ã€2å’Œ3ï¼Œå®ƒä»¬çš„å†…å®¹å°†ä»¥å®Œå…¨ç›¸åŒçš„é¡ºåºå‘é€åˆ°æµè§ˆå™¨ï¼ˆè¿™å°±æ˜¯å¯¼è‡´é˜Ÿå¤´é˜»å¡çš„ç¬¬ä¸€ä¸ªåŸå› ï¼‰ã€‚ç„¶è€Œï¼Œå¯¹äº QUICï¼Œåœ¨ä¸Šé¢çš„ç¬¬äºŒä¸ªç¤ºä¾‹ä¸­ï¼Œåœ¨æ•°æ®åŒ…1ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨é¦–å…ˆçœ‹åˆ°æ•°æ®åŒ…2çš„å†…å®¹ï¼Œç„¶åæ˜¯æ•°æ®åŒ…3çš„æœ€åä¸€éƒ¨åˆ†ï¼Œç„¶åæ˜¯æ•°æ®åŒ…1çš„ï¼ˆé‡ä¼ ï¼‰ï¼Œç„¶åæ˜¯æ•°æ®åŒ…3çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚æ¢è¨€ä¹‹ï¼š<strong>QUIC åœ¨å•ä¸ªèµ„æºæµä¸­ä¿ç•™äº†é¡ºåºï¼Œä½†ä¸å†è·¨å•ä¸ªæµï¼ˆindividual streamsï¼‰è¿›è¡Œæ’åº</strong>ã€‚</p><p>è¿™æ˜¯éœ€è¦ HTTP/3 çš„ç¬¬äºŒä¸ªä¹Ÿæ˜¯æœ€é‡è¦çš„åŸå› ï¼Œå› ä¸ºäº‹å®è¯æ˜ï¼ŒHTTP/2 ä¸­çš„å‡ ä¸ªç³»ç»Ÿéå¸¸ä¸¥é‡åœ°ä¾èµ–äº TCP è·¨æµï¼ˆacross streamsï¼‰çš„å®Œå…¨ç¡®å®šæ€§æ’åºã€‚ä¾‹å¦‚ï¼ŒHTTP/2 çš„ä¼˜å…ˆçº§ç³»ç»Ÿé€šè¿‡ä¼ è¾“æ›´æ”¹æ ‘æ•°æ®ç»“æ„ï¼ˆtree data structure ï¼‰å¸ƒå±€çš„æ“ä½œï¼ˆä¾‹å¦‚ï¼Œå°†èµ„æº5æ·»åŠ ä¸ºèµ„æº6çš„å­çº§ï¼‰å·¥ä½œçš„ã€‚å¦‚æœè¿™äº›æ“ä½œåº”ç”¨çš„é¡ºåºä¸å‘é€é¡ºåºä¸åŒï¼ˆç°åœ¨é€šè¿‡ QUIC æ˜¯å¯èƒ½å‡ºç°çš„ï¼‰ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ä¼˜å…ˆçº§çŠ¶æ€å¯èƒ½ä¸åŒã€‚HTTP/2 çš„å¤´å‹ç¼©ç³»ç»Ÿ HPACK ä¹Ÿä¼šå‘ç”Ÿç±»ä¼¼çš„æƒ…å†µã€‚ç†è§£è¿™é‡Œçš„ç»†èŠ‚å¹¶ä¸é‡è¦ï¼Œåªéœ€è¦å¾—å‡ºç»“è®ºï¼šè¦è®©è¿™äº› HTTP/2 ç³»ç»Ÿç›´æ¥åº”ç”¨ QUIC æ˜¯éå¸¸å›°éš¾çš„ã€‚å› æ­¤ï¼Œ<strong>å¯¹äº HTTP/3ï¼Œæœ‰äº›ç³»ç»Ÿä½¿ç”¨å®Œå…¨ä¸åŒçš„æ–¹æ³•</strong>ã€‚ä¾‹å¦‚ï¼ŒQPACK æ˜¯ HTTP/3 çš„ HPACK ç‰ˆæœ¬ï¼Œå®ƒå…è®¸åœ¨æ½œåœ¨çš„é˜Ÿå¤´é˜»å¡å’Œå‹ç¼©æ€§èƒ½ä¹‹é—´è¿›è¡Œè‡ªæˆ‘é€‰æ‹©çš„æƒè¡¡ã€‚HTTP/2 çš„ä¼˜å…ˆçº§ç³»ç»Ÿç”šè‡³è¢«å®Œå…¨åˆ é™¤ï¼Œå¾ˆå¯èƒ½ä¼šè¢« HTTP/3 çš„ç®€åŒ–ç‰ˆæœ¬æ‰€å–ä»£ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å› ä¸ºï¼Œä¸ TCP ä¸åŒï¼ŒQUIC ä¸èƒ½å®Œå…¨ä¿è¯é¦–å…ˆå‘é€çš„æ•°æ®ä¹Ÿä¼šé¦–å…ˆè¢«æ¥æ”¶ã€‚</p><p>æ‰€ä»¥ï¼Œæ‰€æœ‰ QUIC å’Œé‡æ–°è®¾æƒ³ HTTP ç‰ˆæœ¬çš„è¿™äº›å·¥ä½œéƒ½æ˜¯ä¸ºäº†æ¶ˆé™¤ä¼ è¾“å±‚é˜Ÿå¤´é˜»å¡ã€‚æˆ‘å½“ç„¶å¸Œæœ›è¿™æ˜¯å€¼å¾—çš„â€¦</p><h2 id="QUIC-å’Œ-HTTP-3-çœŸçš„å®Œå…¨æ¶ˆé™¤äº†é˜Ÿå¤´é˜»å¡ï¼Ÿ">QUIC å’Œ HTTP/3 çœŸçš„å®Œå…¨æ¶ˆé™¤äº†é˜Ÿå¤´é˜»å¡ï¼Ÿ</h2><p>å¦‚æœä½ å…è®¸æˆ‘è¯´ä¸€ç‚¹ä¸å¥½çš„è¯ï¼Œæˆ‘æƒ³å¼•ç”¨è‡ªå·±å‡ ä¸ªæ®µè½å‰çš„è¯ï¼š</p><blockquote><p>QUICåœ¨å•ä¸ªèµ„æºæµä¸­ä¿ç•™æ’åº</p></blockquote><p>ä½ æƒ³æƒ³ï¼Œè¿™å¾ˆç¬¦åˆé€»è¾‘ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯è¿™æ ·è¯´çš„ï¼šå¦‚æœä½ æœ‰ä¸€ä¸ª JavaScript æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶éœ€è¦é‡æ–°ç»„è£…ï¼ˆre-assembledï¼‰ï¼Œå°±åƒå®ƒæ˜¯ç”±å¼€å‘äººå‘˜åˆ›å»ºçš„ä¸€æ ·ï¼ˆæˆ–è€…ï¼Œè€å®è¯´ï¼Œé€šè¿‡ webpackï¼‰ï¼Œå¦åˆ™ä»£ç å°†æ— æ³•å·¥ä½œã€‚ä»»ä½•ç±»å‹çš„æ–‡ä»¶éƒ½æ˜¯ä¸€æ ·çš„ï¼šæŠŠå›¾ç‰‡éšæœºåœ°æ”¾åœ¨ä¸€èµ·æ„å‘³ç€ä½ é˜¿å§¨å¯„æ¥çš„ä¸€äº›å¥‡æ€ªçš„ç”µå­åœ£è¯å¡ï¼ˆç”šè‡³æ›´å¥‡æ€ªçš„ï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œ<strong>å³ä½¿åœ¨QUICä¸­ï¼Œæˆ‘ä»¬ä»ç„¶æœ‰ä¸€ç§é˜Ÿå¤´é˜»å¡çš„å½¢å¼</strong>ï¼šå¦‚æœåœ¨å•ä¸ªæµä¸­æœ‰ä¸€ä¸ªå­—èŠ‚é—´éš™ï¼Œé‚£ä¹ˆæµçš„åé¢éƒ¨åˆ†ä»ç„¶ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è¿™ä¸ªé—´éš™è¢«å¡«æ»¡ã€‚</p><p>è¿™æœ‰ä¸€ä¸ªå…³é”®çš„å«ä¹‰ï¼šQUIC çš„é˜Ÿå¤´é˜»å¡ç§»é™¤åªæœ‰åœ¨<strong>å¤šä¸ªèµ„æºæµåŒæ—¶æ´»åŠ¨æ—¶</strong>æ‰æœ‰æ•ˆã€‚è¿™æ ·ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæµä¸Šæœ‰åŒ…ä¸¢å¤±ï¼Œå…¶ä»–æµä»ç„¶å¯ä»¥ç»§ç»­ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šé¢å›¾9çš„ä¾‹å­ä¸­çœ‹åˆ°çš„ã€‚ç„¶è€Œï¼Œå¦‚æœåœ¨æŸä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæµåœ¨æ´»åŠ¨ï¼Œä»»ä½•ä¸¢åŒ…éƒ½ä¼šå½±å“åˆ°è¿™æ¡å­¤ç‹¬çš„æµï¼Œæˆ‘ä»¬ä»ç„¶ä¼šè¢«é˜»å¡ï¼Œå³ä½¿åœ¨ QUICã€‚æ‰€ä»¥ï¼ŒçœŸæ­£çš„é—®é¢˜æ˜¯ï¼š<strong>æˆ‘ä»¬ä¼šç»å¸¸æœ‰å¤šä¸ªå¹¶å‘æµï¼ˆsimultaneous streamsï¼‰å—ï¼Ÿ</strong></p><p>æ­£å¦‚å¯¹ HTTP/2 æ‰€è§£é‡Šçš„ï¼Œè¿™æ˜¯å¯ä»¥é€šè¿‡ä½¿ç”¨é€‚å½“çš„èµ„æºè°ƒåº¦å™¨/å¤šè·¯å¤ç”¨æ–¹æ³•æ¥é…ç½®çš„ã€‚æµ1å’Œæµ2å¯ä»¥è¢«å‘é€ 1122ã€2121ã€1221 ç­‰ï¼Œå¹¶ä¸”æµè§ˆå™¨å¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§ç³»ç»ŸæŒ‡å®šå®ƒå¸Œæœ›æœåŠ¡å™¨éµå¾ªçš„æ–¹æ¡ˆï¼ˆå¯¹äº HTTP/3 ä»ç„¶å¦‚æ­¤ï¼‰ã€‚æ‰€ä»¥æµè§ˆå™¨å¯ä»¥è¯´ï¼šå˜¿ï¼æˆ‘æ³¨æ„åˆ°è¿™ä¸ªè¿æ¥æœ‰ä¸¥é‡çš„æ•°æ®åŒ…ä¸¢å¤±ã€‚æˆ‘å°†è®©æœåŠ¡å™¨ä»¥ 121212 æ¨¡å¼è€Œä¸æ˜¯ 111222 å‘æˆ‘å‘é€èµ„æºã€‚è¿™æ ·ï¼Œå¦‚æœ1çš„ä¸€ä¸ªæ•°æ®åŒ…ä¸¢å¤±ï¼Œ2ä»ç„¶å¯ä»¥ç»§ç»­å·¥ä½œã€‚ç„¶è€Œï¼Œè¿™ç§æ¨¡å¼çš„é—®é¢˜æ˜¯ï¼Œ<strong>121212 æ¨¡å¼ï¼ˆæˆ–è€…ç±»ä¼¼çš„ï¼‰å¯¹èµ„æºåŠ è½½æ€§èƒ½é€šå¸¸ä¸æ˜¯æœ€ä¼˜çš„ã€‚</strong></p><p>è¿™æ˜¯å¦ä¸€ä¸ªå¤æ‚çš„è¯é¢˜ï¼Œæˆ‘ç°åœ¨ä¸æƒ³å¤ªæ·±å…¥ã€‚ä½†æ˜¯ï¼Œé€šè¿‡æˆ‘ä»¬çš„ JS å’Œ CSS æ–‡ä»¶çš„ç®€å•ç¤ºä¾‹ï¼ŒåŸºæœ¬æ¦‚å¿µå¾ˆå®¹æ˜“ç†è§£ã€‚æ­£å¦‚æ‚¨å¯èƒ½çŸ¥é“çš„é‚£æ ·ï¼Œæµè§ˆå™¨éœ€è¦æ¥æ”¶æ•´ä¸ª JS æˆ– CSS æ–‡ä»¶ï¼Œç„¶åæ‰èƒ½å®é™…æ‰§è¡Œ/åº”ç”¨å®ƒï¼ˆè™½ç„¶æœ‰äº›æµè§ˆå™¨å·²ç»å¯ä»¥å¼€å§‹ç¼–è¯‘/è§£æéƒ¨åˆ†ä¸‹è½½çš„æ–‡ä»¶ï¼Œä½†å®ƒä»¬ä»ç„¶éœ€è¦ç­‰å¾…å®ƒä»¬å®Œæ•´åæ‰èƒ½å®é™…ä½¿ç”¨å®ƒä»¬ï¼‰ã€‚ä½†æ˜¯ï¼Œå¤§é‡å¤šè·¯å¤ç”¨è¿™äº›æ–‡ä»¶çš„èµ„æºå—æœ€ç»ˆä¼šå»¶è¿Ÿå®ƒä»¬ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨å¤šè·¯å¤ç”¨ï¼ˆè¾ƒæ…¢ï¼‰ï¼š</span><br><span class="line">---------------------------</span><br><span class="line">                              æµ1ï¼ˆStream 1ï¼‰åªæœ‰åˆ°è¿™é‡Œæ‰èƒ½ä½¿ç”¨</span><br><span class="line">                              â–¼</span><br><span class="line">12121212121212121212121212121212</span><br><span class="line">                               â–²</span><br><span class="line">                               æµ2ï¼ˆStream 2ï¼‰åœ¨è¿™é‡Œä¸‹è½½å®Œæ¯•</span><br><span class="line"></span><br><span class="line">æœªä½¿ç”¨å¤šè·¯å¤ç”¨/é¡ºåºï¼ˆæµ1ï¼ˆStream 1ï¼‰æ›´å¿«ï¼‰ï¼š</span><br><span class="line">------------------------------------------------------</span><br><span class="line">                 æµ1ï¼ˆStream 1ï¼‰åœ¨è¿™é‡Œä¸‹è½½å®Œæ¯•ï¼Œå¯ä»¥æ›´æ—©åœ°ä½¿ç”¨</span><br><span class="line">                 â–¼   </span><br><span class="line">11111111111111111122222222222222</span><br><span class="line">                               â–²</span><br><span class="line">                               æµ2ï¼ˆStream 2ï¼‰è¿˜æ˜¯åœ¨è¿™é‡Œä¸‹è½½å®Œæ¯•</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œè¿™ä¸ªè¯é¢˜æœ‰å¾ˆå¤šç»†å¾®å·®åˆ«ï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨å¤šè·¯å¤ç”¨æ–¹æ³•æ›´å¿«çš„æƒ…å†µï¼ˆä¾‹å¦‚ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæ–‡ä»¶æ¯”å¦ä¸€ä¸ªæ–‡ä»¶å°å¾—å¤šï¼Œæ­£å¦‚æœ¬æ–‡å‰é¢è®¨è®ºçš„é‚£æ ·ï¼‰ã€‚ç„¶è€Œï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºå¤§å¤šæ•°é¡µé¢å’Œå¤§å¤šæ•°èµ„æºç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥è¯´é¡ºåºæ–¹æ³•æœ€æœ‰æ•ˆã€‚</p><p>ç°åœ¨ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå¯¹äºæœ€ä½³æ€§èƒ½ï¼Œæˆ‘ä»¬æœ‰<strong>ä¸¤ä¸ªç›¸äº’å†²çªçš„æ€§èƒ½ä¼˜åŒ–å»ºè®®</strong>ï¼š</p><ol><li>ä» QUIC çš„é˜Ÿå¤´é˜»å¡ç§»é™¤ä¸­è·åˆ©ï¼šå¤šè·¯å¤ç”¨å‘é€èµ„æºï¼ˆ12121212ï¼‰</li><li>ä¸ºäº†ç¡®ä¿æµè§ˆå™¨èƒ½å¤Ÿå°½å¿«å¤„ç†æ ¸å¿ƒèµ„æºï¼šæŒ‰é¡ºåºå‘é€èµ„æºï¼ˆ11112222ï¼‰</li></ol><p>é‚£ä¹ˆï¼Œå“ªä¸€ä¸ªæ˜¯æ­£ç¡®çš„ï¼Ÿæˆ–è€…è‡³å°‘ï¼šå“ªä¸€ä¸ªåº”è¯¥ä¼˜å…ˆäºå¦ä¸€ä¸ªï¼Ÿå¯æ‚²çš„æ˜¯ï¼Œç›®å‰æˆ‘è¿˜ä¸èƒ½ç»™ä½ ä¸€ä¸ªæ˜ç¡®çš„ç­”æ¡ˆï¼Œå› ä¸ºè¿™æ˜¯æˆ‘æ­£åœ¨ç ”ç©¶çš„ä¸€ä¸ªä¸»é¢˜ã€‚è¿™ä¹‹æ‰€ä»¥å›°éš¾ï¼Œä¸»è¦æ˜¯å› ä¸º<strong>æ•°æ®åŒ…ä¸¢å¤±æ¨¡å¼å¾ˆéš¾é¢„æµ‹</strong>ã€‚</p><p>æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢è®¨è®ºè¿‡çš„ï¼ŒåŒ…ä¸¢å¤±é€šå¸¸æ˜¯çªå‘æ€§çš„å’Œåˆ†ç»„çš„ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¸Šé¢ 12121212 çš„ä¾‹å­å·²ç»è¿‡äºç®€åŒ–äº†ã€‚å›¾10ç»™å‡ºäº†ä¸€ä¸ªæ›´çœŸå®çš„æ¦‚è¿°ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å‡è®¾åœ¨ä¸‹è½½2ä¸ªæµï¼ˆç»¿è‰²å’Œç´«è‰²ï¼‰æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª8ä¸ªä¸¢å¤±åŒ…çš„çªå‘äº‹ä»¶ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132717355.png" alt="image-20240427132717355"></p><center>å›¾10ï¼šHTTP/3 over QUIC æµå¤šè·¯å¤ç”¨å¯¹é˜²æ­¢é˜Ÿå¤´é˜»å¡çš„å½±å“ã€‚æ¯ä¸ªçŸ©å½¢æ˜¯ä¸€ä¸ªå•ç‹¬çš„QUICåŒ…ï¼Œä¸ºä¸€ä¸ªæµä¼ è¾“æ•°æ®ã€‚çº¢å‰è¡¨ç¤ºä¸¢å¤±çš„åŒ…ã€‚</center><p>åœ¨å›¾10çš„é¡¶éƒ¨ç¬¬ä¸€è¡Œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ˆé€šå¸¸ï¼‰å¯¹èµ„æºåŠ è½½æ€§èƒ½æ›´å¥½çš„é¡ºåºæƒ…å†µã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ° QUIC å¯¹æ¶ˆé™¤é˜Ÿå¤´é˜»å¡ç¡®å®æ²¡æœ‰é‚£ä¹ˆå¤§çš„å¸®åŠ©ï¼šåœ¨ä¸¢åŒ…ä¹‹åæ”¶åˆ°çš„ç»¿åŒ…ä¸èƒ½è¢«æµè§ˆå™¨å¤„ç†ï¼Œå› ä¸ºå®ƒä»¬å±äºç»å†ä¸¢åŒ…çš„åŒä¸€ä¸ªæµã€‚ç¬¬äºŒä¸ªï¼ˆç´«è‰²ï¼‰æµçš„æ•°æ®å°šæœªæ”¶åˆ°ï¼Œå› æ­¤æ— æ³•å¤„ç†ã€‚</p><p>è¿™ä¸ä¸­é—´ä¸€è¡Œä¸åŒï¼Œä¸­é—´ä¸€è¡Œï¼ˆå¶ç„¶ï¼ï¼‰ä¸¢å¤±çš„8ä¸ªæ•°æ®åŒ…éƒ½æ¥è‡ªç»¿è‰²æµã€‚è¿™æ„å‘³ç€æµè§ˆå™¨å¯ä»¥å¤„ç†æœ€åæ”¶åˆ°çš„ç´«è‰²æ•°æ®åŒ…ã€‚ç„¶è€Œï¼Œæ­£å¦‚å‰é¢æ‰€è®¨è®ºçš„ï¼Œå¦‚æœæµè§ˆå™¨æ˜¯ JS æˆ– CSS æ–‡ä»¶ï¼Œå¦‚æœæœ‰æ›´å¤šçš„ç´«è‰²æ•°æ®å‡ºç°ï¼Œæµè§ˆå™¨å¯èƒ½ä¸ä¼šä»ä¸­å—ç›Šå¤ªå¤šã€‚å› æ­¤ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä» QUIC çš„é˜Ÿå¤´é˜»å¡ç§»é™¤ä¸­è·å¾—äº†ä¸€äº›å¥½å¤„ï¼ˆå› ä¸ºç´«è‰²æ²¡æœ‰è¢«ç»¿è‰²é˜»æ­¢ï¼‰ï¼Œä½†æ˜¯å¯èƒ½ä¼šç‰ºç‰²æ•´ä½“èµ„æºåŠ è½½æ€§èƒ½ï¼ˆå› ä¸ºå¤šè·¯å¤ç”¨ä¼šå¯¼è‡´æ–‡ä»¶ç¨åå®Œæˆï¼‰ã€‚</p><p>æœ€ä¸‹é¢ä¸€è¡Œå‡ ä¹æ˜¯æœ€ç³Ÿç³•çš„æƒ…å†µã€‚8ä¸ªä¸¢å¤±çš„æ•°æ®åŒ…åˆ†å¸ƒåœ¨ä¸¤ä¸ªæµä¸­ã€‚è¿™æ„å‘³ç€è¿™ä¸¤ä¸ªæµç°åœ¨éƒ½è¢«é˜Ÿå¤´é˜»å¡äº†ï¼šä¸æ˜¯å› ä¸ºå®ƒä»¬åƒTCPé‚£æ ·åœ¨ç­‰å¾…å¯¹æ–¹ï¼Œè€Œæ˜¯å› ä¸ºæ¯ä¸ªæµä»ç„¶éœ€è¦è‡ªå·±æ’åºã€‚</p><p><em>æ³¨æ„ï¼šè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•° QUIC å®ç°å¾ˆå°‘åŒæ—¶åˆ›å»ºåŒ…å«æ¥è‡ªå¤šä¸ªæµï¼ˆstreamsï¼‰çš„æ•°æ®åŒ…ï¼ˆpacketsï¼‰çš„åŸå› ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªæ•°æ®åŒ…ä¸¢å¤±ï¼Œåˆ™ä¼šç«‹å³å¯¼è‡´å•ä¸ªæ•°æ®åŒ…ä¸­æ‰€æœ‰æµçš„é˜Ÿå¤´é˜»å¡ï¼</em></p><p>å› æ­¤ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯èƒ½å­˜åœ¨æŸç§æœ€ä½³ä½ç½®ï¼ˆä¸­é—´ä¸€è¡Œï¼‰ï¼Œåœ¨è¿™é‡Œï¼Œ<strong>é˜Ÿå¤´é˜»å¡é¢„é˜²å’Œèµ„æºåŠ è½½æ€§èƒ½ä¹‹é—´çš„æƒè¡¡å¯èƒ½æ˜¯å€¼å¾—çš„</strong>ã€‚ç„¶è€Œï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€è¯´ï¼Œä¸¢åŒ…æ¨¡å¼å¾ˆéš¾é¢„æµ‹ã€‚ä¸ä¼šæ€»æ˜¯8ä¸ªæ•°æ®åŒ…ã€‚å®ƒä»¬ä¸ä¼šæ€»æ˜¯ä¸€æ ·çš„8ä¸ªæ•°æ®åŒ…ã€‚å¦‚æœæˆ‘ä»¬æé”™äº†ï¼Œä¸¢å¤±çš„æ•°æ®åŒ…åªå‘å·¦ç§»åŠ¨äº†ä¸€ä¸ªï¼Œæˆ‘ä»¬çªç„¶ä¹Ÿå°‘äº†ä¸€ä¸ªç´«è‰²çš„åŒ…ï¼Œè¿™åŸºæœ¬ä¸Šä½¿æˆ‘ä»¬é™çº§åˆ°ä¸æœ€ä¸‹é¢ä¸€è¡Œç›¸ä¼¼çš„ä½ç½®â€¦</p><p>æˆ‘æƒ³ä½ ä¼šåŒæ„æˆ‘çš„è§‚ç‚¹ï¼Œé‚£å¬èµ·æ¥å¾ˆå¤æ‚ï¼Œç”šè‡³å¯èƒ½å¤ªå¤æ‚äº†ã€‚å³ä¾¿å¦‚æ­¤ï¼Œé—®é¢˜æ˜¯è¿™ä¼šæœ‰å¤šå¤§å¸®åŠ©ã€‚å¦‚å‰æ‰€è¿°ï¼ŒåŒ…ä¸¢å¤±åœ¨è®¸å¤šç½‘ç»œç±»å‹ä¸­é€šå¸¸æ¯”è¾ƒå°‘è§ï¼Œå¯èƒ½ï¼ˆä¹Ÿè®¸ï¼Ÿï¼‰å¤ªç½•è§äº†ï¼Œçœ‹ä¸åˆ° QUIC ç§»é™¤é˜Ÿå¤´é˜»å¡çš„å½±å“ã€‚å¦ä¸€æ–¹é¢ï¼Œå·²ç»æœ‰å¾ˆå¥½çš„æ–‡æ¡£è¯æ˜æ— è®ºæ‚¨ä½¿ç”¨çš„æ˜¯ HTTP/2 è¿˜æ˜¯ HTTP/3ï¼Œæ¯ä¸ªèµ„æºçš„æ•°æ®åŒ…ï¼ˆå›¾10çš„æœ€åä¸€è¡Œï¼‰å¯¹èµ„æºåŠ è½½æ€§èƒ½éƒ½æ˜¯ç›¸å½“ä¸åˆ©çš„ã€‚</p><p>å› æ­¤ï¼Œæœ‰äººå¯èƒ½ä¼šè¯´ï¼Œè™½ç„¶ QUIC å’Œ HTTP/3 ä¸å†å—åˆ°åº”ç”¨å±‚æˆ–ä¼ è¾“å±‚é˜Ÿå¤´é˜»å¡çš„å½±å“ï¼Œä½†è¿™åœ¨ç°å®ä¸­å¯èƒ½å¹¶ä¸é‡è¦ã€‚æˆ‘ä¸èƒ½ç¡®å®šè¿™ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å®Œå…¨å®Œæˆ QUIC å’Œ HTTP/3 çš„å®ç°ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ²¡æœ‰æœ€åçš„åº¦é‡ï¼ˆmeasurementsï¼‰ã€‚ç„¶è€Œï¼Œæˆ‘ä¸ªäººçš„ç›´è§‰ï¼ˆè¿™æ˜¯ç”±æˆ‘çš„å‡ ä¸ªæ—©æœŸå®éªŒçš„ç»“æœæ”¯æŒçš„ï¼‰è¯´ï¼Œ<strong>QUIC æ¶ˆé™¤é˜Ÿå¤´é˜»å¡å¯èƒ½å®é™…ä¸Šå¯¹ Web æ€§èƒ½æ²¡æœ‰å¤ªå¤§å¸®åŠ©</strong>ï¼Œå› ä¸ºç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›ä¸ºäº†èµ„æºåŠ è½½æ€§èƒ½è€Œå¯¹è®¸å¤šæµè¿›è¡Œå¤šè·¯å¤ç”¨ã€‚è€Œä¸”ï¼Œå¦‚æœä½ çœŸçš„æƒ³è®©å®ƒå·¥ä½œå¾—å¾ˆå¥½ï¼Œä½ å°±å¿…é¡»éå¸¸å·§å¦™åœ°è°ƒæ•´ä½ çš„å¤šè·¯å¤ç”¨æ–¹å¼æ¥é€‚åº”è¿æ¥ç±»å‹ï¼Œå› ä¸ºä½ ç»å¯¹ä¸æƒ³åœ¨åŒ…ä¸¢å¤±éå¸¸ä½çš„å¿«é€Ÿç½‘ç»œä¸Šè¿›è¡Œå¤§é‡çš„å¤šè·¯å¤ç”¨ï¼ˆå› ä¸ºå®ƒä»¬æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šé­å—å¤ªå¤šçš„é˜Ÿå¤´é˜»å¡ï¼‰ã€‚å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘ä¸è®¤ä¸ºä¼šå‘ç”Ÿè¿™ç§äº‹ã€‚</p><p><em>æ³¨æ„ï¼šåœ¨è¿™é‡Œï¼Œåœ¨ç»“å°¾ï¼Œä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°æˆ‘çš„æ•…äº‹æœ‰ç‚¹ä¸ä¸€è‡´ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘è¯´ HTTP/1.1 çš„é—®é¢˜æ˜¯å®ƒä¸å…è®¸å¤šè·¯å¤ç”¨ã€‚æœ€åï¼Œæˆ‘è¯´å¤šè·¯å¤ç”¨åœ¨ç°å®ä¸­å¹¶ä¸é‚£ä¹ˆé‡è¦ã€‚ä¸ºäº†å¸®åŠ©è§£å†³è¿™ä¸ªæ˜æ˜¾çš„çŸ›ç›¾ï¼Œæˆ‘æ·»åŠ äº†å¦ä¸€ä¸ªé¢å¤–çš„å½©è›‹éƒ¨åˆ†</em></p><h2 id="æ€»ç»“ä¸ç»“è®º">æ€»ç»“ä¸ç»“è®º</h2><p>åœ¨è¿™ç¯‡ï¼ˆå¾ˆé•¿ï¼Œæˆ‘çŸ¥é“ï¼‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨è¿½è¸ªé˜Ÿå¤´é˜»å¡ã€‚æˆ‘ä»¬é¦–å…ˆè®¨è®ºäº†ä¸ºä»€ä¹ˆ HTTP/1.1 ä¼šå—åˆ°åº”ç”¨å±‚é˜Ÿå¤´é˜»å¡çš„å½±å“ã€‚è¿™ä¸»è¦æ˜¯å› ä¸º HTTP/1.1 æ²¡æœ‰è¯†åˆ«å•ä¸ªèµ„æºå—çš„æ–¹æ³•ã€‚HTTP/2 ä½¿ç”¨å¸§æ¥æ ‡è®°è¿™äº›å—å¹¶å¯ç”¨å¤šè·¯å¤ç”¨ã€‚è¿™è§£å†³äº† HTTP/1.1 çš„é—®é¢˜ï¼Œä½†é—æ†¾çš„æ˜¯HTTP/2 ä»ç„¶å—åˆ°åº•å±‚ TCP çš„é™åˆ¶ã€‚ç”±äº TCP å°† HTTP/2 æ•°æ®æŠ½è±¡ä¸ºä¸€ä¸ªå•ä¸€çš„ã€æœ‰åºçš„ã€ä½†ä¸é€æ˜çš„æµï¼Œå› æ­¤å¦‚æœæ•°æ®åŒ…åœ¨ç½‘ç»œä¸Šä¸¢å¤±æˆ–ä¸¥é‡å»¶è¿Ÿï¼Œå®ƒå°†é­å—é˜Ÿå¤´é˜»å¡ã€‚QUIC é€šè¿‡å°† HTTP/2 çš„ä¸€äº›æ¦‚å¿µå¼•å…¥ä¼ è¾“å±‚æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿™åè¿‡æ¥ä¼šäº§ç”Ÿä¸¥é‡çš„å½±å“ï¼Œå› ä¸ºè·¨æµçš„æ•°æ®ä¸å†æ˜¯å®Œå…¨æœ‰åºçš„ã€‚è¿™æœ€ç»ˆå¯¼è‡´éœ€è¦ä¸€ä¸ªå…¨æ–°çš„ç‰ˆæœ¬ HTTP/3ï¼Œå®ƒåªè¿è¡Œåœ¨ QUIC ä¹‹ä¸Šï¼ˆè€Œ HTTP/2 åªè¿è¡Œåœ¨ TCP ä¹‹ä¸Šï¼Œè¯·å‚è§å›¾6ï¼‰ã€‚</p><p>æˆ‘ä»¬éœ€è¦æ‰€æœ‰è¿™äº›ä¸Šä¸‹æ–‡æ¥æ‰¹åˆ¤æ€§åœ°æ€è€ƒ QUICï¼ˆä»¥åŠ HTTP/3ï¼‰ä¸­çš„é˜Ÿå¤´é˜»å¡ç§»é™¤åœ¨ç°å®ä¸­å¯¹ Web æ€§èƒ½çš„å®é™…å¸®åŠ©æœ‰å¤šå¤§ã€‚æˆ‘ä»¬çœ‹åˆ°å®ƒå¯èƒ½åªä¼šå¯¹æœ‰å¤§é‡æ•°æ®åŒ…ä¸¢å¤±çš„ç½‘ç»œäº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚æˆ‘ä»¬è¿˜è®¨è®ºäº†ä¸ºä»€ä¹ˆå³ä½¿è¿™æ ·ï¼Œæ‚¨ä»ç„¶éœ€è¦å¤šè·¯å¤ç”¨èµ„æºï¼Œå¹¶çœ‹è¿æ°”ä¸¢åŒ…å¯¹å¤šè·¯å¤ç”¨çš„å½±å“æ€ä¹ˆæ ·ã€‚æˆ‘ä»¬çœ‹åˆ°äº†ä¸ºä»€ä¹ˆè¿™æ ·åšå®é™…ä¸Šå¼Šå¤§äºåˆ©ï¼Œå› ä¸ºèµ„æºå¤šè·¯å¤ç”¨é€šå¸¸ä¸æ˜¯ Web æ€§èƒ½çš„æœ€ä½³æ–¹æ¡ˆã€‚æˆ‘ä»¬å¾—å‡ºçš„ç»“è®ºæ˜¯ï¼Œè™½ç„¶ç°åœ¨ç¡®å®šè¿™ä¸€ç‚¹è¿˜ä¸ºæ—¶è¿‡æ—©ï¼Œ<strong>ä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒQUIC å’Œ HTTP/3 çš„é˜Ÿå¤´é˜»å¡ç§»é™¤å¯èƒ½ä¸ä¼šå¯¹ Web æ€§èƒ½èµ·åˆ°å¤šå¤§ä½œç”¨</strong>ã€‚</p><p>é‚£ä¹ˆâ€¦è¿™åˆç»™æˆ‘ä»¬ç•™ä¸‹ä»€ä¹ˆæ ·çš„ Web æ€§èƒ½è¯„ä»·å‘¢ï¼Ÿå¿½ç•¥ QUIC å’Œ HTTP/3ï¼ŒåšæŒ HTTP/2 + TCPï¼Ÿæˆ‘å½“ç„¶ä¸å¸Œæœ›ï¼<strong>æˆ‘ä»ç„¶ç›¸ä¿¡ HTTP/3 æ€»ä½“ä¸Šå°†æ¯” HTTP/2 å¿«</strong>ï¼Œå› ä¸º QUIC è¿˜åŒ…æ‹¬å…¶ä»–æ€§èƒ½æ”¹è¿›ã€‚ä¾‹å¦‚ï¼Œå®ƒæ¯” TCP åœ¨ç½‘ç»œä¸Šçš„å¼€é”€æ›´å°ï¼Œåœ¨æ‹¥å¡æ§åˆ¶æ–¹é¢æ›´åŠ çµæ´»ï¼Œè€Œä¸”æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå…·æœ‰ 0-RTT è¿æ¥å»ºç«‹ç‰¹æ€§ã€‚æˆ‘è§‰å¾—<strong>ç‰¹åˆ«æ˜¯ 0-RTT å°†æä¾›æœ€å¤šçš„Webæ€§èƒ½å¥½å¤„</strong>ï¼Œå°½ç®¡ä¹Ÿæœ‰å¾ˆå¤šæŒ‘æˆ˜ã€‚ä»¥åæˆ‘ä¼šå†™å¦ä¸€ç¯‡å…³äº 0-RTT çš„åšå®¢æ–‡ç« ï¼Œä½†æ˜¯å¦‚æœä½ è¿«ä¸åŠå¾…æƒ³çŸ¥é“æ›´å¤šå…³äºæ”¾å¤§æ”»å‡»é¢„é˜²ã€é‡æ”¾æ”»å‡»ã€åˆå§‹æ‹¥å¡çª—å£å¤§å°ç­‰çš„ä¿¡æ¯ï¼Œè¯·çœ‹æˆ‘çš„å¦ä¸€ç¯‡ YouTube è®²åº§æˆ–é˜…è¯»æˆ‘æœ€è¿‘çš„è®ºæ–‡ã€‚</p><p>å¦‚æœä½ å–œæ¬¢æ‰€æœ‰è¿™äº›ï¼Œå¹¶å¸Œæœ›åœ¨æœªæ¥æœ‰æ›´å¤šçš„äº¤æµï¼Œè¯·å…³æ³¨æˆ‘çš„ twitter <a href="https://link.zhihu.com/?target=https%3A//twitter.com/programmingart">@programmingart</a>ã€‚</p><p>è¿™ç¯‡æ–‡ç« çš„â€œåœ¨çº¿æ–‡æ¡£â€ç‰ˆæœ¬å¯ä»¥åœ¨  github ä¸Šæ‰¾åˆ°ã€‚å¦‚æœæ‚¨æœ‰å…³äºå¦‚ä½•æ”¹è¿›å®ƒçš„å»ºè®®ï¼Œè¯·è®©æˆ‘çŸ¥é“ï¼</p><p>æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼</p><h2 id="å½©è›‹ï¼šHTTP-1-1-ç®¡é“ï¼ˆpipeliningï¼‰">å½©è›‹ï¼šHTTP/1.1 ç®¡é“ï¼ˆ<strong>pipelining</strong>ï¼‰</h2><p>HTTP/1.1 åŒ…å«äº†ä¸€ä¸ªåä¸ºâ€œç®¡é“â€œï¼ˆpipeliningï¼‰çš„ç‰¹æ€§ï¼Œåœ¨æˆ‘çœ‹æ¥è¿™æ˜¯ç»å¸¸è¢«è¯¯è§£çš„ã€‚æˆ‘çœ‹è¿‡å¾ˆå¤šæ–‡ç« ï¼Œç”šè‡³ä¹¦ç±ä¸­éƒ½æœ‰äººå£°ç§° HTTP/1.1 ç®¡é“è§£å†³äº†é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚æˆ‘ç”šè‡³è§è¿‡ä¸€äº›äººè¯´ç®¡é“å’Œæ­£ç¡®çš„å¤šè·¯å¤ç”¨æ˜¯ä¸€æ ·çš„ã€‚ä¸¤ç§è¯´æ³•éƒ½æ˜¯é”™è¯¯çš„ã€‚</p><p>æˆ‘å‘ç°ç”¨ç±»ä¼¼å½©è›‹å›¾1ä¸­çš„æ’å›¾æ¥è§£é‡Š HTTP/1.1 ç®¡é“æ˜¯æœ€ç®€å•çš„ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132814642.png" alt="image-20240427132814642"></p><center>å½©è›‹å›¾1ï¼šHTTP/1.1 ç®¡é“</center><p>å¦‚æœæ²¡æœ‰ç®¡é“ï¼ˆpipeliningï¼‰ï¼ˆå½©è›‹å›¾1çš„å·¦ä¾§ï¼‰ï¼Œæµè§ˆå™¨å¿…é¡»ç­‰å¾…å‘é€ç¬¬äºŒä¸ªèµ„æºè¯·æ±‚ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªè¯·æ±‚çš„å“åº”è¢«å®Œå…¨æ¥æ”¶ï¼ˆåŒæ ·ä½¿ç”¨ Content-Lengthï¼‰ã€‚è¿™ä¼šä¸ºæ¯ä¸ªè¯·æ±‚å¢åŠ ä¸€ä¸ªå¾€è¿”æ—¶é—´ï¼ˆRTTï¼‰å»¶è¿Ÿï¼Œè¿™å¯¹Webæ€§èƒ½ä¸åˆ©ã€‚</p><p>æœ‰äº†ç®¡é“ï¼ˆå½©è›‹å›¾1çš„ä¸­é—´éƒ¨åˆ†ï¼‰ï¼Œæµè§ˆå™¨ä¸å¿…ç­‰å¾…ä»»ä½•å“åº”æ•°æ®ï¼Œç°åœ¨å¯ä»¥èƒŒé èƒŒåœ°å‘é€è¯·æ±‚ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨è¿æ¥è¿‡ç¨‹ä¸­èŠ‚çœäº†ä¸€äº› RTTsï¼Œä½¿å¾—åŠ è½½è¿‡ç¨‹æ›´å¿«ã€‚<em>å¦è¯·æ³¨æ„ï¼Œè¯·å›é¡¾å›¾2ï¼šæ‚¨ä¼šçœ‹åˆ°å®é™…ä¸Šä¹Ÿåœ¨ä½¿ç”¨ç®¡é“ï¼Œå› ä¸ºæœåŠ¡å™¨åœ¨ TCP æ•°æ®åŒ…2ä¸­æ‰“åŒ… <code>script.js</code> ä»¥åŠ <code>style.css</code> çš„å“åº”æ•°æ®ã€‚å½“ç„¶ï¼Œåªæœ‰åœ¨æœåŠ¡å™¨åŒæ—¶æ¥æ”¶åˆ°è¿™ä¸¤ä¸ªè¯·æ±‚æ—¶ï¼Œè¿™æ‰æ˜¯å¯èƒ½çš„ã€‚</em></p><p>ç„¶è€Œï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œè¿™ç§ç®¡é“åªé€‚ç”¨äºæ¥è‡ªæµè§ˆå™¨çš„è¯·æ±‚ã€‚æ­£å¦‚HTTP/1.1 è§„èŒƒæ‰€è¯´ï¼š</p><blockquote><p>æœåŠ¡å™¨å¿…é¡»æŒ‰ç…§æ¥æ”¶è¯·æ±‚çš„é¡ºåºå‘é€å¯¹è¿™äº›[ç®¡é“åŒ–]è¯·æ±‚çš„å“åº”ã€‚</p></blockquote><p>å› æ­¤ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå®é™…çš„å“åº”å—ï¼ˆresponse chunksï¼‰å¤šè·¯å¤ç”¨ï¼ˆå¦‚å½©è›‹å›¾1å³ä¾§æ‰€ç¤ºï¼‰åœ¨ HTTP/1.1 ç®¡é“ä¸­ä»ç„¶æ˜¯ä¸å¯èƒ½çš„ã€‚æ¢ä¸€ç§è¯´æ³•ï¼š<strong>ç®¡é“è§£å†³äº†è¯·æ±‚çš„é˜Ÿå¤´é˜»å¡ï¼Œè€Œä¸æ˜¯å“åº”çš„é˜Ÿå¤´é˜»å¡</strong>ã€‚å¯æ‚²çš„æ˜¯ï¼Œå“åº”é˜Ÿå¤´é˜»å¡æ˜¯å¯¼è‡´ Web æ€§èƒ½é—®é¢˜æœ€å¤šçš„åŸå› ã€‚</p><p>æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå¤§å¤šæ•°æµè§ˆå™¨å®é™…ä¸Šå¹¶æ²¡æœ‰åœ¨ç°å®ä¸­ä½¿ç”¨ HTTP/1.1 ç®¡é“ï¼Œå› ä¸ºè¿™ä¼šä½¿é˜Ÿå¤´é˜»å¡åœ¨å¤šä¸ªå¹¶è¡Œ TCP è¿æ¥çš„è®¾ç½®ä¸­å˜å¾—æ›´åŠ ä¸å¯é¢„æµ‹ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬è®¾æƒ³ä¸€ä¸ªè®¾ç½®ï¼Œå…¶ä¸­é€šè¿‡ä¸¤ä¸ª TCP è¿æ¥ä»æœåŠ¡å™¨è¯·æ±‚ä¸‰ä¸ªæ–‡ä»¶ Aï¼ˆå¤§ï¼‰ã€Bï¼ˆå°ï¼‰å’Œ Cï¼ˆå°ï¼‰ã€‚A å’Œ B åœ¨ä¸åŒçš„è¿æ¥ä¸Šè¢«è¯·æ±‚ã€‚ç°åœ¨ï¼Œæµè§ˆå™¨åº”è¯¥åœ¨å“ªä¸ªè¿æ¥ä¸Šä¼ è¾“å¯¹ C çš„è¯·æ±‚ï¼Ÿæ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€è¯´ï¼Œå®ƒä¸çŸ¥é“ A è¿˜æ˜¯ B å°†æˆä¸ºæœ€å¤§/æœ€æ…¢çš„èµ„æºã€‚</p><p>å¦‚æœå®ƒçŒœå¯¹äº†ï¼ˆBï¼‰ï¼Œå®ƒå°±å¯ä»¥åœ¨ä¼ è¾“ A æ‰€éœ€çš„æ—¶é—´å†…åŒæ—¶ä¸‹è½½ B å’Œ Cï¼Œä»è€Œè·å¾—äº†å¾ˆå¥½çš„åŠ é€Ÿæ•ˆæœã€‚ä½†æ˜¯ï¼Œå¦‚æœçŒœæµ‹æ˜¯é”™è¯¯çš„ï¼ˆAï¼‰ï¼ŒB çš„è¿æ¥å°†é•¿æ—¶é—´å¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œ C åˆ™åœ¨ A åé¢è¢«é˜»å¡ã€‚è¿™æ˜¯å› ä¸º HTTP/1.1 ä¹Ÿæ²¡æœ‰æä¾›ä¸€ç§åœ¨è¯·æ±‚è¢«å‘é€åâ€œä¸­æ­¢â€çš„æ–¹æ³•ï¼ˆHTTP/2 å’Œ HTTP/3 å…è®¸è¿™æ ·åšï¼‰ã€‚å› æ­¤ï¼Œæµè§ˆå™¨ä¸èƒ½ç®€å•åœ°é€šè¿‡ B çš„è¿æ¥è¯·æ±‚ Cï¼Œå› ä¸ºå®ƒæœ€ç»ˆä¼šè¯·æ±‚ä¸¤æ¬¡ Cã€‚</p><p>ä¸ºäº†è§£å†³æ‰€æœ‰è¿™äº›é—®é¢˜ï¼Œç°ä»£æµè§ˆå™¨ä¸ä½¿ç”¨ç®¡é“ï¼Œç”šè‡³ä¼šä¸»åŠ¨å»¶è¿Ÿå¯¹æŸäº›å·²å‘ç°èµ„æºï¼ˆä¾‹å¦‚å›¾åƒï¼‰çš„è¯·æ±‚ä¸€æ®µæ—¶é—´ï¼Œä»¥æŸ¥çœ‹æ˜¯å¦æ‰¾åˆ°æ›´é‡è¦çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ JS å’Œ CSSï¼‰ï¼Œä»¥ç¡®ä¿é«˜ä¼˜å…ˆçº§èµ„æºä¸ä¼šè¢«é˜»å¡ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼ŒHTTP/1.1 ç®¡é“çš„å¤±è´¥æ˜¯ HTTP/2 ä½¿ç”¨æˆªç„¶ä¸åŒæ–¹æ³•çš„å¦ä¸€ä¸ªåŠ¨æœºã€‚ç„¶è€Œï¼Œç”±äº HTTP/2 çš„ä¼˜å…ˆçº§ç³»ç»ŸæŒ‡å¯¼å¤šè·¯å¤ç”¨åœ¨ç°å®ä¸­å¸¸å¸¸æ— æ³•æ‰§è¡Œï¼Œä¸€äº›æµè§ˆå™¨ç”šè‡³é‡‡å–äº†å»¶è¿Ÿ HTTP/2 èµ„æºè¯·æ±‚çš„æ–¹å¼æ¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚</p><h2 id="å½©è›‹ï¼šTLS-é˜Ÿå¤´é˜»å¡">å½©è›‹ï¼šTLS é˜Ÿå¤´é˜»å¡</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼ŒTLS åè®®ä¸ºåº”ç”¨å±‚åè®®ï¼ˆå¦‚ HTTPï¼‰æä¾›åŠ å¯†ï¼ˆå’Œå…¶ä»–åŠŸèƒ½ï¼‰ã€‚å®ƒé€šè¿‡å°†ä» HTTP è·å–çš„æ•°æ®åŒ…è£…åˆ° TLS è®°å½•ä¸­ï¼ŒTLS è®°å½•åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äº HTTP/2 å¸§ï¼ˆframesï¼‰æˆ– TCP æ•°æ®åŒ…ï¼ˆpacketsï¼‰ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬åœ¨å¼€å§‹æ—¶åŒ…å«ä¸€äº›å…ƒæ•°æ®ï¼Œä»¥æ ‡è¯†è®°å½•çš„é•¿åº¦ã€‚ç„¶åï¼Œå¯¹è¯¥è®°å½•åŠå…¶ HTTP å†…å®¹è¿›è¡ŒåŠ å¯†å¹¶ä¼ é€’ç»™ TCP è¿›è¡Œä¼ è¾“ã€‚</p><p>å°± CPU ä½¿ç”¨ç‡è€Œè¨€ï¼ŒåŠ å¯†å¯èƒ½æ˜¯ä¸€é¡¹æ˜‚è´µçš„æ“ä½œï¼Œå› æ­¤ä¸€æ¬¡åŠ å¯†ä¸€ä¸ªå¥½æ•°æ®å—é€šå¸¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºè¿™é€šå¸¸æ›´æœ‰æ•ˆã€‚å®é™…ä¸Šï¼ŒTLS å¯ä»¥ä»¥é«˜è¾¾ 16KB çš„å—åŠ å¯†èµ„æºï¼Œè¿™è¶³ä»¥å¡«å……å¤§çº¦ 11 ä¸ªå…¸å‹çš„ TCP åŒ…ï¼ˆgive æˆ– takeï¼‰ã€‚</p><p>ç„¶è€Œï¼Œè‡³å…³é‡è¦çš„æ˜¯ï¼ŒTLS åªèƒ½å¯¹æ•´ä¸ªè®°å½•è¿›è¡Œè§£å¯†ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¼šå‡ºç° TLS é˜Ÿå¤´é˜»å¡çš„æƒ…å†µã€‚å‡è®¾ TLS è®°å½•åˆ†æ•£åœ¨ 11 ä¸ª TCP åŒ…ä¸Šï¼Œæœ€åä¸€ä¸ª TCP åŒ…ä¸¢å¤±ã€‚ç”±äº TLS è®°å½•æ˜¯ä¸å®Œæ•´çš„ï¼Œå®ƒä¸èƒ½è¢«è§£å¯†ï¼Œå› æ­¤è¢«å¡åœ¨ç­‰å¾…æœ€åä¸€ä¸ª TCP åŒ…çš„é‡ä¼ ã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ TCP é˜Ÿå¤´é˜»å¡ï¼šåœ¨ç¼–å·11ä¹‹åæ²¡æœ‰æ•°æ®åŒ…è¢«å¡ä½ç­‰å¾…é‡æ–°ä¼ è¾“ã€‚æ¢è¨€ä¹‹ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æœ¬ä¾‹ä¸­ä½¿ç”¨çº¯ HTTP è€Œä¸æ˜¯ HTTPSï¼Œé‚£ä¹ˆå‰10ä¸ªåŒ…ä¸­çš„ HTTP æ•°æ®å¯èƒ½å·²ç»è¢«ç§»åŠ¨åˆ°æµè§ˆå™¨ä¸­è¿›è¡Œå¤„ç†ã€‚ç„¶è€Œï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æ•´ä¸ª11åŒ…çš„ TLS è®°å½•æ‰èƒ½è§£å¯†å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰äº†ä¸€ç§æ–°å½¢å¼çš„é˜Ÿå¤´é˜»å¡ã€‚</p><p>è™½ç„¶è¿™æ˜¯ä¸€ä¸ªéå¸¸å…·ä½“çš„æƒ…å†µï¼Œåœ¨ç°å®ä¸­å¯èƒ½ä¸ä¼šç»å¸¸å‘ç”Ÿï¼Œä½†åœ¨è®¾è®¡ QUIC åè®®æ—¶ï¼Œå®ƒä»ç„¶è¢«è€ƒè™‘åœ¨å†…ã€‚å› ä¸ºé‚£é‡Œçš„ç›®æ ‡æ˜¯å½»åº•æ¶ˆé™¤æ‰€æœ‰å½¢å¼çš„é˜Ÿå¤´é˜»å¡ï¼ˆæˆ–è‡³å°‘å°½å¯èƒ½å¤šåœ°æ¶ˆé™¤ï¼‰ï¼Œç”šè‡³è¿™ç§è¾¹ç¼˜æƒ…å†µä¹Ÿå¿…é¡»è¢«ç§»é™¤ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ QUIC é›†æˆäº† TLSï¼Œå®ƒæ€»æ˜¯ä»¥æ¯ä¸ªåŒ…ä¸ºåŸºç¡€åŠ å¯†æ•°æ®ï¼Œå¹¶ä¸”ä¸ç›´æ¥ä½¿ç”¨ TLS è®°å½•ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œä¸ä½¿ç”¨æ›´å¤§çš„å—ç›¸æ¯”ï¼Œè¿™æ•ˆç‡æ›´ä½ï¼Œéœ€è¦æ›´å¤šçš„ CPUï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ QUIC åœ¨å½“å‰å®ç°ä¸­ä»ç„¶æ¯” TCP æ…¢çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p><h2 id="å½©è›‹ï¼šä¼ è¾“æ‹¥å¡æ§åˆ¶">å½©è›‹ï¼šä¼ è¾“æ‹¥å¡æ§åˆ¶</h2><p>ä¼ è¾“å±‚åè®®å¦‚ TCP å’Œ QUIC åŒ…æ‹¬ä¸€ç§ç§°ä¸ºæ‹¥å¡æ§åˆ¶ï¼ˆCongestion Controlï¼‰çš„æœºåˆ¶ã€‚æ‹¥å¡æ§åˆ¶å™¨çš„ä¸»è¦å·¥ä½œæ˜¯ç¡®ä¿ç½‘ç»œä¸ä¼šåŒæ—¶è¢«è¿‡å¤šçš„æ•°æ®è¿‡è½½ã€‚å¦‚æœæ²¡æœ‰ç¼“å†²åŒºçš„è¯ï¼Œæ•°æ®åŒ…å°±ä¼šæº¢å‡ºã€‚æ‰€ä»¥ï¼Œå®ƒé€šå¸¸åªå‘é€ä¸€ç‚¹æ•°æ®ï¼ˆé€šå¸¸æ˜¯ 14KBï¼‰ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½é€šè¿‡ã€‚å¦‚æœæ•°æ®åˆ°è¾¾ï¼Œæ¥æ”¶æ–¹å°†ç¡®è®¤å‘é€å›å‘é€æ–¹ã€‚åªè¦æ‰€æœ‰å‘é€çš„æ•°æ®éƒ½å¾—åˆ°ç¡®è®¤ï¼Œå‘é€æ–¹å°±åœ¨æ¯æ¬¡ RTT æ—¶å°†å…¶å‘é€é€Ÿç‡åŠ å€ï¼Œç›´åˆ°è§‚å¯Ÿåˆ°ä¸¢åŒ…äº‹ä»¶ï¼ˆè¿™æ„å‘³ç€ç½‘ç»œè¿‡è½½ï¼ˆ1 ä½ï¼‰ï¼Œå®ƒéœ€è¦åé€€ï¼ˆ1 ä½ï¼‰ï¼‰ã€‚è¿™å°±æ˜¯ TCP è¿æ¥å¦‚ä½•â€œæ¢æµ‹â€å…¶å¯ç”¨å¸¦å®½ã€‚</p><p><em>æ³¨ï¼šä»¥ä¸Šæè¿°åªæ˜¯æ‹¥å¡æ§åˆ¶çš„ä¸€ç§æ–¹æ³•ã€‚ç›®å‰ï¼Œå…¶ä»–æ–¹æ³•ä¹Ÿè¶Šæ¥è¶Šæµè¡Œï¼Œå…¶ä¸­ä¸»è¦æ˜¯</em> <a href="https://link.zhihu.com/?target=https%3A//research.google/pubs/pub45646/">BBR ç®—æ³•</a><em>ã€‚BBR å¹¶æ²¡æœ‰ç›´æ¥è§‚å¯Ÿæ•°æ®åŒ…ä¸¢å¤±ï¼Œè€Œæ˜¯å¤§é‡è€ƒè™‘ RTT æ³¢åŠ¨æ¥ç¡®å®šç½‘ç»œæ˜¯å¦è¿‡è½½ï¼Œè¿™æ„å‘³ç€å®ƒé€šå¸¸é€šè¿‡æ¢æµ‹å¸¦å®½æ¥å‡å°‘æ•°æ®åŒ…ä¸¢å¤±ã€‚</em></p><p>å…³é”®æ˜¯ï¼š<strong>æ‹¥å¡æ§åˆ¶æœºåˆ¶å¯¹æ¯ä¸ª TCPï¼ˆå’Œ QUICï¼‰è¿æ¥éƒ½æ˜¯ç‹¬ç«‹çš„</strong>ï¼è¿™åè¿‡æ¥ä¹Ÿä¼šå½±å“åˆ° HTTPå±‚ çš„ Web æ€§èƒ½ã€‚é¦–å…ˆï¼Œè¿™æ„å‘³ç€ HTTP/2 çš„å•ä¸ªè¿æ¥æœ€åˆåªå‘é€ 14KBã€‚ç„¶è€Œï¼ŒHTTP/1.1 çš„6ä¸ªè¿æ¥åœ¨å®ƒä»¬çš„ç¬¬ä¸€æ¬¡ä¼ è¾“ä¸­å‘é€ 14KBï¼Œå¤§çº¦æ˜¯ 84KBï¼éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™å°†å˜å¾—å¤æ‚ï¼Œå› ä¸ºæ¯ä¸ª HTTP/1.1 è¿æ¥ä½¿ç”¨æ¯ä¸ª RTT å°†å…¶æ•°æ®åŠ å€ã€‚ç¬¬äºŒï¼Œåªæœ‰åœ¨æ•°æ®åŒ…ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œè¿æ¥æ‰ä¼šé™ä½å…¶å‘é€é€Ÿç‡ã€‚å¯¹äº HTTP/2 çš„å•ä¸ªè¿æ¥ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªåŒ…ä¸¢å¤±ä¹Ÿæ„å‘³ç€å®ƒå°†å‡æ…¢é€Ÿåº¦ï¼ˆé™¤äº†å¯¼è‡´ TCP é˜Ÿå¤´é˜»å¡ä¹‹å¤–ï¼ï¼‰ã€‚ç„¶è€Œï¼Œå¯¹äº HTTP/1.1ï¼Œåªæœ‰ä¸€ä¸ªè¿æ¥ä¸Šçš„ä¸€ä¸ªåŒ…ä¸¢å¤±åªä¼šå‡æ…¢è¿™ä¸€ä¸ªè¿æ¥çš„é€Ÿåº¦ï¼šå…¶ä»–5ä¸ªè¿æ¥å¯ä»¥ä¿æŒæ­£å¸¸çš„å‘é€å’Œå¢é•¿ã€‚</p><p>è¿™ä¸€åˆ‡ä½¿ä¸€ä»¶äº‹å˜å¾—éå¸¸æ¸…æ¥šï¼š<strong>HTTP/2 çš„å¤šè·¯å¤ç”¨ä¸ HTTP/1.1 çš„åŒæ—¶ä¸‹è½½èµ„æºæ˜¯ä¸ä¸€æ ·çš„</strong>ï¼ˆæˆ‘è¿˜çœ‹åˆ°ä¸€äº›äººå£°ç§°è¿™ä¸€ç‚¹ï¼‰ã€‚å•ä¸ª HTTP/2 è¿æ¥çš„å¯ç”¨å¸¦å®½åªæ˜¯åœ¨ä¸åŒæ–‡ä»¶ä¹‹é—´åˆ†å¸ƒ/å…±äº«ï¼Œä½†æ˜¯å—ä»ç„¶æ˜¯æŒ‰é¡ºåºå‘é€çš„ã€‚è¿™ä¸ HTTP/1.1 ä¸åŒï¼Œåè€…ä»¥çœŸæ­£çš„å¹¶è¡Œæ–¹å¼å‘é€å†…å®¹ã€‚</p><p>ç°åœ¨ï¼Œæ‚¨å¯èƒ½ä¼šæƒ³çŸ¥é“ï¼šé‚£ä¹ˆï¼Œ<strong>HTTP/2 æ€ä¹ˆå¯èƒ½æ¯” HTTP/1.1 å¿«å‘¢</strong>ï¼Ÿè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯æˆ‘æ–­æ–­ç»­ç»­é—®è‡ªå·±å¾ˆä¹…çš„é—®é¢˜ã€‚ä¸€ä¸ªæ˜æ˜¾çš„ç­”æ¡ˆæ˜¯ï¼Œå¦‚æœä½ æœ‰è¶…è¿‡6ä¸ªæ–‡ä»¶ã€‚è¿™å°±æ˜¯ HTTP/2 åœ¨å½“æ—¶çš„å¸‚åœºè¥é”€æ–¹å¼ï¼šå°†ä¸€ä¸ªå›¾åƒåˆ†å‰²æˆå°æ­£æ–¹å½¢ï¼Œç„¶åé€šè¿‡ HTTP/1.1 vs HTTP/2 åŠ è½½å®ƒä»¬ã€‚è¿™ä¸»è¦å±•ç¤ºäº† HTTP/2 çš„é˜Ÿå¤´é˜»å¡ç§»é™¤ã€‚ç„¶è€Œï¼Œå¯¹äºæ™®é€š/çœŸå®çš„ç½‘ç«™æ¥è¯´ï¼Œäº‹æƒ…å¾ˆå¿«å°±ä¼šå˜å¾—æ›´åŠ å¾®å¦™ã€‚è¿™å–å†³äºèµ„æºçš„æ•°é‡ã€å¤§å°ã€ä½¿ç”¨çš„ä¼˜å…ˆçº§/å¤šè·¯å¤ç”¨æ–¹æ¡ˆã€åˆ°æœåŠ¡å™¨çš„ RTTã€å®é™…æœ‰å¤šå°‘ä¸¢åŒ…ä»¥åŠä½•æ—¶å‘ç”Ÿã€åŒæ—¶é“¾è·¯ä¸Šæœ‰å¤šå°‘å…¶ä»–æµé‡ã€ä½¿ç”¨çš„æ‹¥å¡æ§åˆ¶å™¨é€»è¾‘ï¼Œç­‰ç­‰ã€‚HTTP/1.1 å¯èƒ½ä¼šä¸¢å¤±çš„ä¸€ä¸ªä¾‹å­æ˜¯åœ¨å¯ç”¨å¸¦å®½æœ‰é™çš„ç½‘ç»œä¸Šï¼š6ä¸ª HTTP/1.1 è¿æ¥å„è‡ªå¢åŠ å…¶å‘é€é€Ÿç‡ï¼Œå¯¼è‡´å®ƒä»¬å¾ˆå¿«ä½¿ç½‘ç»œè¿‡è½½ï¼Œä¹‹åå®ƒä»¬éƒ½å¿…é¡»åé€€ï¼Œå¿…é¡»é€šè¿‡åå¤è¯•éªŒæ‰¾åˆ°å®ƒä»¬å…±å­˜çš„å¸¦å®½é™åˆ¶ï¼ˆåœ¨ HTTP/2 ä¹‹å‰ï¼Œäººä»¬è®¤ä¸º HTTP/1.1 çš„å¹¶è¡Œè¿æ¥å¯èƒ½æ˜¯å› ç‰¹ç½‘ä¸Šæ•°æ®åŒ…ä¸¢å¤±çš„ä¸»è¦åŸå› ï¼‰ã€‚å•ä¸ª HTTP/2 è¿æ¥å¢é•¿è¾ƒæ…¢ï¼Œä½†åœ¨åŒ…ä¸¢å¤±äº‹ä»¶åæ¢å¤é€Ÿåº¦æ›´å¿«ï¼Œå¹¶ä¸”æ›´å¿«åœ°æ‰¾åˆ°æœ€ä½³å¸¦å®½ã€‚å¦ä¸€ä¸ªå¸¦æœ‰æ³¨é‡Šçš„æ‹¥å¡çª—å£çš„æ›´è¯¦ç»†çš„ï¼ŒHTTP/2 æ›´å¿«çš„ç¤ºä¾‹å¯ä»¥çœ‹[è¿™å¼ å›¾ç‰‡ï¼ˆä¸é€‚ç”¨äºèƒ†å°çš„äººï¼‰ã€‚</p><p>QUIC å’Œ HTTP/3 å°†é¢ä¸´ç±»ä¼¼çš„æŒ‘æˆ˜ï¼Œå°±åƒ HTTP/2 ä¸€æ ·ï¼ŒHTTP/3 å°†ä½¿ç”¨å•ä¸€çš„åº•å±‚ QUIC è¿æ¥ã€‚ç„¶åï¼Œæ‚¨å¯èƒ½ä¼šè¯´ QUIC è¿æ¥åœ¨æ¦‚å¿µä¸Šæœ‰ç‚¹åƒå¤šä¸ª TCP è¿æ¥ï¼Œå› ä¸ºæ¯ä¸ª QUIC æµéƒ½å¯ä»¥çœ‹ä½œä¸€ä¸ªTCPè¿æ¥ï¼Œå› ä¸ºä¸¢å¤±æ£€æµ‹æ˜¯åœ¨æ¯ä¸ªæµçš„åŸºç¡€ä¸Šå®Œæˆçš„ã€‚ç„¶è€Œï¼Œå…³é”®çš„æ˜¯ï¼ŒQUIC çš„æ‹¥å¡æ§åˆ¶ä»ç„¶æ˜¯åœ¨è¿æ¥çº§åˆ«å®Œæˆçš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ¯ä¸ªæµã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿æµåœ¨æ¦‚å¿µä¸Šæ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒä»¬ä»ç„¶ä¼šå½±å“ QUIC çš„å•è¿æ¥æ‹¥å¡æ§åˆ¶å™¨ï¼Œå¦‚æœæµä¸­æœ‰ä»»ä½•ä¸€ä¸ªä¸¢å¤±ï¼Œå°±ä¼šå¯¼è‡´é€Ÿåº¦å‡æ…¢ã€‚æ¢å¥è¯è¯´ï¼šå•ä¸ª HTTP/3+QUIC è¿æ¥ä»ç„¶ä¸ä¼šåƒ 6 ä¸ª HTTP/1.1 è¿æ¥é‚£æ ·å¿«é€Ÿå¢é•¿ï¼Œç±»ä¼¼äºä¸€ä¸ªè¿æ¥ä¸Šçš„ HTTP/2+TCP å¢é•¿é€Ÿåº¦å¹¶ä¸å¿«ã€‚</p><h2 id="å½©è›‹ï¼šå¤šè·¯å¤ç”¨æ˜¯å¦é‡è¦ï¼Ÿ">å½©è›‹ï¼šå¤šè·¯å¤ç”¨æ˜¯å¦é‡è¦ï¼Ÿ</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼Œå¹¶åœ¨æœ¬æ¼”ç¤ºæ–‡ç¨¿ä¸­è¿›è¡Œäº†æ·±å…¥è§£é‡Šï¼Œé€šå¸¸å»ºè®®ä»¥é¡ºåºæ–¹å¼è€Œä¸æ˜¯å¤šè·¯ä¼ è¾“æ–¹å¼å‘é€å¤§å¤šæ•°ç½‘é¡µèµ„æºã€‚æ¢ä¸€ç§è¯´æ³•ï¼Œå¦‚æœä½ æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œä½ é€šå¸¸æœ€å¥½å‘é€ 11112222 è€Œä¸æ˜¯ 12121212ã€‚å¯¹äºéœ€è¦åœ¨åº”ç”¨ä¹‹å‰å®Œå…¨æ¥æ”¶çš„èµ„æºï¼Œå¦‚ JSã€CSS å’Œå­—ä½“ï¼Œå°¤å…¶å¦‚æ­¤ã€‚</p><p>å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæƒ³ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å¤šè·¯å¤ç”¨ï¼Ÿé€šè¿‡æ‰©å±•ï¼šHTTP/2 ç”šè‡³ HTTP/3ï¼Œå› ä¸ºå¤šè·¯å¤ç”¨æ˜¯ HTTP/1.1 æ²¡æœ‰çš„ä¸»è¦ç‰¹æ€§ä¹‹ä¸€ã€‚é¦–å…ˆï¼Œä¸€äº›å¯ä»¥å¢é‡å¤„ç†/å‘ˆç°çš„æ–‡ä»¶ç¡®å®ä»å¤šè·¯å¤ç”¨ä¸­è·ç›Šã€‚ä¾‹å¦‚ï¼Œæ¸è¿›å¼å›¾åƒå°±æ˜¯è¿™æ ·ã€‚ç¬¬äºŒï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæ–‡ä»¶æ¯”å…¶ä»–æ–‡ä»¶å°å¾—å¤šï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šå¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒå°†æ›´æ—©åœ°ä¸‹è½½ï¼Œè€Œä¸ä¼šå¯¹å…¶ä»–æ–‡ä»¶é€ æˆå¤ªå¤šçš„å»¶è¿Ÿã€‚ç¬¬ä¸‰ï¼Œ<strong>å¤šè·¯å¤ç”¨å…è®¸æ”¹å˜å“åº”çš„é¡ºåºï¼Œå¹¶ä¸ºé«˜ä¼˜å…ˆçº§çš„å“åº”ä¸­æ–­ä½ä¼˜å…ˆçº§çš„å“åº”</strong>ã€‚</p><p>ç°å®ä¸­å‡ºç°çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯åœ¨æºæœåŠ¡å™¨å‰é¢ä½¿ç”¨ CDN ç¼“å­˜ã€‚å‡è®¾æµè§ˆå™¨ä» CDN è¯·æ±‚ä¸¤ä¸ªæ–‡ä»¶ã€‚ç¬¬ä¸€ä¸ªï¼ˆ1ï¼‰æ²¡æœ‰è¢«ç¼“å­˜ï¼Œéœ€è¦ä»æºæ–‡ä»¶ä¸­è·å–ï¼Œè¿™éœ€è¦ä¸€æ®µæ—¶é—´ã€‚ç¬¬äºŒä¸ªèµ„æºï¼ˆ2ï¼‰ç¼“å­˜åœ¨ CDN ä¸­ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ä¼ è¾“å›æµè§ˆå™¨ã€‚</p><p>åœ¨ä¸€ä¸ªè¿æ¥ä¸Šä½¿ç”¨ HTTP/1.1ï¼Œç”±äºé˜Ÿå¤´é˜»å¡ï¼Œæˆ‘ä»¬å¿…é¡»ç­‰å¾…é˜Ÿå¤´å®Œå…¨å‘é€ï¼ˆ1ï¼‰ï¼Œç„¶åæ‰èƒ½å¼€å§‹å‘é€ï¼ˆ2ï¼‰ã€‚è¿™å°†ç»™æˆ‘ä»¬å¸¦æ¥ 11112222ï¼Œä½†éœ€è¦å¾ˆé•¿çš„å‰æœŸç­‰å¾…æ—¶é—´ã€‚ç„¶è€Œï¼Œä½¿ç”¨HTTP/2ï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³å¼€å§‹å‘é€ï¼ˆ2ï¼‰ï¼Œåˆ©ç”¨ CDN å’ŒæºèŠ‚ç‚¹ä¹‹é—´çš„â€œæ€è€ƒæ—¶é—´â€ï¼Œå¹¶â€œé¢„çƒ­â€è¿æ¥çš„æ‹¥å¡æ§åˆ¶å™¨ã€‚é‡è¦çš„æ˜¯ï¼Œå¦‚æœï¼ˆ1ï¼‰åœ¨ï¼ˆ2ï¼‰å®Œæˆä¹‹å‰å¼€å§‹åˆ°è¾¾ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç®€å•åœ°å¼€å§‹å°†ï¼ˆ1ï¼‰çš„æ•°æ®æ³¨å…¥åˆ°å“åº”æµä¸­ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ° 22111122ï¼Œç­‰å¾…çš„æ—¶é—´è¦çŸ­å¾—å¤šã€‚ç”šè‡³å¯ä»¥åœ¨è¿æ¥å¼€å§‹æ—¶ä½¿ç”¨æœåŠ¡å™¨æ¨é€ï¼ˆServer Pushï¼‰æˆ–103æ—©æœŸæç¤ºï¼ˆ103 early hintsï¼‰ç­‰åŠŸèƒ½ã€‚</p><p>å› æ­¤ï¼Œè™½ç„¶åƒ 12121212 è¿™æ ·çš„å®Œå…¨â€œè½®è¯¢â€å¤šè·¯å¤ç”¨å¾ˆå°‘æ˜¯æ‚¨æƒ³è¦çš„ Web æ€§èƒ½ï¼Œä½†æ˜¯å¤šè·¯å¤ç”¨åœ¨æ€»ä½“ä¸Šç»å¯¹æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„ç‰¹æ€§ã€‚</p>]]></content>
    
    
    <summary type="html">Head-of-Line Blocking</summary>
    
    
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://penge666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://penge666.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>é›¶æ‹·è´-é«˜æ•ˆçš„ä¼ è¾“æ–‡ä»¶</title>
    <link href="https://penge666.github.io/posts/80c635db.html"/>
    <id>https://penge666.github.io/posts/80c635db.html</id>
    <published>2024-04-26T09:31:30.000Z</published>
    <updated>2024-04-26T09:59:51.205Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»‹ç»">ä»‹ç»</h2><p><strong>é›¶æ‹·è´</strong>æ˜¯æŒ‡è®¡ç®—æœºæ‰§è¡ŒIOæ“ä½œæ—¶ï¼ŒCPUä¸éœ€è¦å°†æ•°æ®ä»ä¸€ä¸ªå­˜å‚¨åŒºåŸŸå¤åˆ¶åˆ°å¦ä¸€ä¸ªå­˜å‚¨åŒºåŸŸï¼Œä»è€Œå¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ä»¥åŠCPUçš„æ‹·è´æ—¶é—´ã€‚å®ƒæ˜¯ä¸€ç§<code>I/O</code>æ“ä½œä¼˜åŒ–æŠ€æœ¯ã€‚</p><h2 id="ä¼ ç»Ÿ-IO-çš„æ‰§è¡Œæµç¨‹">ä¼ ç»Ÿ IO çš„æ‰§è¡Œæµç¨‹</h2><p>åšæœåŠ¡ç«¯å¼€å‘çš„å°ä¼™ä¼´ï¼Œæ–‡ä»¶ä¸‹è½½åŠŸèƒ½åº”è¯¥å®ç°è¿‡ä¸å°‘äº†å§ã€‚å¦‚æœä½ å®ç°çš„æ˜¯ä¸€ä¸ª<strong>webç¨‹åº</strong>ï¼Œå‰ç«¯è¯·æ±‚è¿‡æ¥ï¼ŒæœåŠ¡ç«¯çš„ä»»åŠ¡å°±æ˜¯ï¼šå°†æœåŠ¡ç«¯ä¸»æœºç£ç›˜ä¸­çš„æ–‡ä»¶ä»å·²è¿æ¥çš„socketå‘å‡ºå»ã€‚å…³é”®å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>((n = <span class="built_in">read</span>(diskfd, buf, BUF_SIZE)) &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">write</span>(sockfd, buf , n);</span><br></pre></td></tr></table></figure><p>ä¼ ç»Ÿçš„IOæµç¨‹ï¼ŒåŒ…æ‹¬readå’Œwriteçš„è¿‡ç¨‹ã€‚</p><ul><li><code>read</code>ï¼šæŠŠæ•°æ®ä»ç£ç›˜è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œå†æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</li><li><code>write</code>ï¼šå…ˆæŠŠæ•°æ®å†™å…¥åˆ°socketç¼“å†²åŒºï¼Œæœ€åå†™å…¥ç½‘å¡è®¾å¤‡ã€‚</li></ul><p><strong>æµç¨‹å›¾å¦‚ä¸‹ï¼š</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426174926090.png" alt="image-20240426174926090"></p><ul><li>ç”¨æˆ·åº”ç”¨è¿›ç¨‹è°ƒç”¨readå‡½æ•°ï¼Œå‘æ“ä½œç³»ç»Ÿå‘èµ·IOè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€è½¬ä¸ºå†…æ ¸æ€ï¼ˆåˆ‡æ¢1ï¼‰</strong></li><li>DMAæ§åˆ¶å™¨æŠŠæ•°æ®ä»ç£ç›˜ä¸­ï¼Œè¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li>CPUæŠŠå†…æ ¸ç¼“å†²åŒºæ•°æ®ï¼Œæ‹·è´åˆ°ç”¨æˆ·åº”ç”¨ç¼“å†²åŒºï¼Œ<strong>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€è½¬ä¸ºç”¨æˆ·æ€ï¼ˆåˆ‡æ¢2ï¼‰</strong>ï¼Œreadå‡½æ•°è¿”å›</li><li>ç”¨æˆ·åº”ç”¨è¿›ç¨‹é€šè¿‡writeå‡½æ•°ï¼Œå‘èµ·IOè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€è½¬ä¸ºå†…æ ¸æ€ï¼ˆåˆ‡æ¢3ï¼‰</strong></li><li>CPUå°†ç”¨æˆ·ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œæ‹·è´åˆ°socketç¼“å†²åŒº</li><li>DMAæ§åˆ¶å™¨æŠŠæ•°æ®ä»socketç¼“å†²åŒºï¼Œæ‹·è´åˆ°ç½‘å¡è®¾å¤‡ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆåˆ‡æ¢4ï¼‰</strong>ï¼Œwriteå‡½æ•°è¿”å›</li></ul><p>ä»æµç¨‹å›¾å¯ä»¥çœ‹å‡ºï¼Œ<strong>ä¼ ç»ŸIOçš„è¯»å†™æµç¨‹</strong>ï¼ŒåŒ…æ‹¬äº†4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆ4æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼‰ï¼Œ4æ¬¡æ•°æ®æ‹·è´ï¼ˆ<strong>ä¸¤æ¬¡CPUæ‹·è´ä»¥åŠä¸¤æ¬¡çš„DMAæ‹·è´</strong>)ï¼Œä»€ä¹ˆæ˜¯DMAæ‹·è´å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥å›é¡¾ä¸‹ï¼Œé›¶æ‹·è´æ¶‰åŠçš„<strong>æ“ä½œç³»ç»ŸçŸ¥è¯†ç‚¹</strong>å“ˆã€‚</p><h2 id="DMAæŠ€æœ¯">DMAæŠ€æœ¯</h2><p>DMAï¼Œè‹±æ–‡å…¨ç§°æ˜¯<strong>Direct Memory Access</strong>ï¼Œå³ç›´æ¥å†…å­˜è®¿é—®ã€‚<strong>DMA</strong>æœ¬è´¨ä¸Šæ˜¯ä¸€å—ä¸»æ¿ä¸Šç‹¬ç«‹çš„èŠ¯ç‰‡ï¼Œå…è®¸å¤–è®¾è®¾å¤‡å’Œå†…å­˜å­˜å‚¨å™¨ä¹‹é—´ç›´æ¥è¿›è¡ŒIOæ•°æ®ä¼ è¾“ï¼Œå…¶è¿‡ç¨‹<strong>ä¸éœ€è¦CPUçš„å‚ä¸</strong>ã€‚</p><p>æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹IOæµç¨‹ï¼ŒDMAå¸®å¿™åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426175033350.png" alt="image-20240426175033350"></p><ul><li>ç”¨æˆ·åº”ç”¨è¿›ç¨‹è°ƒç”¨readå‡½æ•°ï¼Œå‘æ“ä½œç³»ç»Ÿå‘èµ·IOè°ƒç”¨ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…æ•°æ®è¿”å›ã€‚</li><li>CPUæ”¶åˆ°æŒ‡ä»¤åï¼Œå¯¹DMAæ§åˆ¶å™¨å‘èµ·æŒ‡ä»¤è°ƒåº¦ã€‚</li><li>DMAæ”¶åˆ°IOè¯·æ±‚åï¼Œå°†è¯·æ±‚å‘é€ç»™ç£ç›˜ï¼›</li><li>ç£ç›˜å°†æ•°æ®æ”¾å…¥ç£ç›˜æ§åˆ¶ç¼“å†²åŒºï¼Œå¹¶é€šçŸ¥DMA</li><li>DMAå°†æ•°æ®ä»ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li>DMAå‘CPUå‘å‡ºæ•°æ®è¯»å®Œçš„ä¿¡å·ï¼ŒæŠŠå·¥ä½œäº¤æ¢ç»™CPUï¼Œç”±CPUè´Ÿè´£å°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºã€‚</li><li>ç”¨æˆ·åº”ç”¨è¿›ç¨‹ç”±å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ï¼Œè§£é™¤é˜»å¡çŠ¶æ€</li></ul><p>DMAçš„å·¥ä½œå°±æ˜¯<strong>å¸®å¿™CPUè½¬å‘ä¸€ä¸‹IOè¯·æ±‚ï¼Œä»¥åŠæ‹·è´æ•°æ®</strong>ã€‚</p><blockquote><p>ä¸»è¦å°±æ˜¯æ•ˆç‡ï¼Œå®ƒå¸®å¿™CPUåšäº‹æƒ…ï¼Œè¿™æ—¶å€™ï¼ŒCPUå°±å¯ä»¥é—²ä¸‹æ¥å»åšåˆ«çš„äº‹æƒ…ï¼Œæé«˜äº†CPUçš„åˆ©ç”¨æ•ˆç‡ã€‚å¤§ç™½è¯è§£é‡Šå°±æ˜¯ï¼ŒCPUè€å“¥å¤ªå¿™å¤ªç´¯å•¦ï¼Œæ‰€ä»¥ä»–æ‰¾äº†ä¸ªå°å¼Ÿï¼ˆåå«DMAï¼‰ ï¼Œæ›¿ä»–å®Œæˆä¸€éƒ¨åˆ†çš„æ‹·è´å·¥ä½œï¼Œè¿™æ ·CPUè€å“¥å°±èƒ½ç€æ‰‹å»åšå…¶ä»–äº‹æƒ…ã€‚</p></blockquote><h2 id="é›¶æ‹·è´">é›¶æ‹·è´</h2><p>é›¶æ‹·è´å¹¶ä¸æ˜¯æ²¡æœ‰æ‹·è´æ•°æ®ï¼Œè€Œæ˜¯å‡å°‘ç”¨æˆ·æ€/å†…æ ¸æ€çš„åˆ‡æ¢æ¬¡æ•°ä»¥åŠCPUæ‹·è´çš„æ¬¡æ•°ã€‚</p><p>é›¶æ‹·è´å®ç°æœ‰å¤šç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯</p><ul><li>mmap+write</li><li>sendfile</li><li>sendfile+DMAæ”¶é›†</li><li>splice</li></ul><h3 id="mmap-write">mmap+write</h3><p>mmap çš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> prot, <span class="type">int</span> flags, <span class="type">int</span> fd, <span class="type">off_t</span> offset)</span>;</span><br></pre></td></tr></table></figure><ul><li>addrï¼šæŒ‡å®šæ˜ å°„çš„è™šæ‹Ÿå†…å­˜åœ°å€</li><li>lengthï¼šæ˜ å°„çš„é•¿åº¦</li><li>protï¼šæ˜ å°„å†…å­˜çš„ä¿æŠ¤æ¨¡å¼</li><li>flagsï¼šæŒ‡å®šæ˜ å°„çš„ç±»å‹</li><li>fd:è¿›è¡Œæ˜ å°„çš„æ–‡ä»¶å¥æŸ„</li><li>offset:æ–‡ä»¶åç§»é‡</li></ul><p>mmapç”¨äº†è™šæ‹Ÿå†…å­˜ä¸­å¯ä»¥æŠŠå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†åœ°å€è¿™ä¸ªç‰¹ç‚¹ï¼Œå®ƒå°†å†…æ ¸ä¸­çš„è¯»ç¼“å†²åŒºä¸ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºè¿›è¡Œæ˜ å°„ï¼Œæ‰€æœ‰çš„IOéƒ½åœ¨å†…æ ¸ä¸­å®Œæˆã€‚</p><p><code>mmap+write</code><br>å®ç°çš„é›¶æ‹·è´æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426175310052.png" alt="image-20240426175310052"></p><ul><li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡<code>mmapæ–¹æ³•</code>å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·IOè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€</strong>ã€‚</li><li>CPUåˆ©ç”¨DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li><strong>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€</strong>ï¼Œmmapæ–¹æ³•è¿”å›ã€‚</li><li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡<code>write</code><br>æ–¹æ³•å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·IOè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€</strong>ã€‚</li><li>CPUå°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°çš„socketç¼“å†²åŒºã€‚</li><li>CPUåˆ©ç”¨DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»socketç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€</strong>ï¼Œwriteè°ƒç”¨è¿”å›ã€‚</li></ul><p>å¯ä»¥å‘ç°ï¼Œ<code>mmap+write</code>å®ç°çš„é›¶æ‹·è´ï¼ŒI/Oå‘ç”Ÿäº†<strong>4</strong>æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ3æ¬¡æ•°æ®æ‹·è´ã€‚å…¶ä¸­3æ¬¡æ•°æ®æ‹·è´ä¸­ï¼ŒåŒ…æ‹¬äº†<strong>2æ¬¡DMAæ‹·è´å’Œ1æ¬¡CPUæ‹·è´</strong>ã€‚</p><p><code>mmap</code>æ˜¯å°†è¯»ç¼“å†²åŒºçš„åœ°å€å’Œç”¨æˆ·ç¼“å†²åŒºçš„åœ°å€è¿›è¡Œæ˜ å°„ï¼Œå†…æ ¸ç¼“å†²åŒºå’Œåº”ç”¨ç¼“å†²åŒºå…±äº«ï¼Œæ‰€ä»¥èŠ‚çœäº†ä¸€æ¬¡CPUæ‹·è´â€˜â€™å¹¶ä¸”ç”¨æˆ·è¿›ç¨‹å†…å­˜æ˜¯<strong>è™šæ‹Ÿçš„</strong>ï¼Œåªæ˜¯<strong>æ˜ å°„</strong>åˆ°å†…æ ¸çš„è¯»ç¼“å†²åŒºï¼Œå¯ä»¥èŠ‚çœä¸€åŠçš„å†…å­˜ç©ºé—´ã€‚</p><h3 id="sendfile">sendfile</h3><p><code>sendfile</code>æ˜¯Linux2.1å†…æ ¸ç‰ˆæœ¬åå¼•å…¥çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼ŒAPIå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">sendfile</span><span class="params">(<span class="type">int</span> out_fd, <span class="type">int</span> in_fd, <span class="type">off_t</span> *offset, <span class="type">size_t</span> count)</span></span>;</span><br></pre></td></tr></table></figure><ul><li>out_fd:ä¸ºå¾…å†™å…¥å†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€ä¸ªsocketæè¿°ç¬¦ã€‚ï¼Œ</li><li>in_fd:ä¸ºå¾…è¯»å‡ºå†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¿…é¡»æ˜¯çœŸå®çš„æ–‡ä»¶ï¼Œä¸èƒ½æ˜¯socketå’Œç®¡é“ã€‚</li><li>offsetï¼šæŒ‡å®šä»è¯»å…¥æ–‡ä»¶çš„å“ªä¸ªä½ç½®å¼€å§‹è¯»ï¼Œå¦‚æœä¸ºNULLï¼Œè¡¨ç¤ºæ–‡ä»¶çš„é»˜è®¤èµ·å§‹ä½ç½®ã€‚</li><li>countï¼šæŒ‡å®šåœ¨fdoutå’Œfdinä¹‹é—´ä¼ è¾“çš„å­—èŠ‚æ•°ã€‚</li></ul><p>sendfileè¡¨ç¤ºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œå®ƒæ˜¯åœ¨<strong>æ“ä½œç³»ç»Ÿå†…æ ¸</strong>ä¸­æ“ä½œçš„ï¼Œ<strong>é¿å…äº†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·ç¼“å†²åŒºä¹‹é—´çš„æ‹·è´æ“ä½œ</strong>ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨å®ƒæ¥å®ç°é›¶æ‹·è´ã€‚</p><p>sendfileå®ç°çš„é›¶æ‹·è´æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426175356744.png" alt="image-20240426175356744"></p><ol><li>ç”¨æˆ·è¿›ç¨‹å‘èµ·sendfileç³»ç»Ÿè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢1ï¼‰ä»ç”¨æˆ·æ€è½¬å‘å†…æ ¸æ€</strong></li><li>DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li>CPUå°†è¯»ç¼“å†²åŒºä¸­æ•°æ®æ‹·è´åˆ°socketç¼“å†²åŒº</li><li>DMAæ§åˆ¶å™¨ï¼Œå¼‚æ­¥æŠŠæ•°æ®ä»socketç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ï¼Œ</li><li><strong>ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢2ï¼‰ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€</strong>ï¼Œsendfileè°ƒç”¨è¿”å›ã€‚</li></ol><p>å¯ä»¥å‘ç°ï¼Œ<code>sendfile</code>å®ç°çš„é›¶æ‹·è´ï¼ŒI/Oå‘ç”Ÿäº†<strong>2</strong>æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ3æ¬¡æ•°æ®æ‹·è´ã€‚å…¶ä¸­3æ¬¡æ•°æ®æ‹·è´ä¸­ï¼ŒåŒ…æ‹¬äº†<strong>2æ¬¡DMAæ‹·è´å’Œ1æ¬¡CPUæ‹·è´</strong>ã€‚é‚£èƒ½ä¸èƒ½æŠŠCPUæ‹·è´çš„æ¬¡æ•°å‡å°‘åˆ°0æ¬¡å‘¢ï¼Ÿæœ‰çš„ï¼Œå³å¸¦æœ‰DMAæ”¶é›†æ‹·è´åŠŸèƒ½çš„sendfileï¼</p><h3 id="sendfile-DMA-scatter-gather">sendfile+DMA scatter/gather</h3><p>linux 2.4ç‰ˆæœ¬ä¹‹åï¼Œå¯¹<code>sendfile</code>åšäº†ä¼˜åŒ–å‡çº§ï¼Œå¼•å…¥SG-DMAæŠ€æœ¯ï¼Œå…¶å®å°±æ˜¯å¯¹DMAæ‹·è´åŠ å…¥äº†<code>scatter/gather</code>æ“ä½œï¼Œå®ƒå¯ä»¥ç›´æ¥ä»å†…æ ¸ç©ºé—´ç¼“å†²åŒºä¸­å°†æ•°æ®è¯»å–åˆ°ç½‘å¡ã€‚ä½¿ç”¨è¿™ä¸ªç‰¹ç‚¹æé›¶æ‹·è´ï¼Œå³è¿˜å¯ä»¥å¤šçœå»<strong>ä¸€æ¬¡CPUæ‹·è´</strong>ã€‚</p><p>sendfile+DMA scatter/gatherå®ç°çš„é›¶æ‹·è´æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426175456788.png" alt="image-20240426175456788"></p><ol><li>ç”¨æˆ·è¿›ç¨‹å‘èµ·sendfileç³»ç»Ÿè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢1ï¼‰ä»ç”¨æˆ·æ€è½¬å‘å†…æ ¸æ€</strong></li><li>DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li>CPUæŠŠå†…æ ¸ç¼“å†²åŒºä¸­çš„<strong>æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯</strong>ï¼ˆåŒ…æ‹¬å†…æ ¸ç¼“å†²åŒºçš„å†…å­˜åœ°å€å’Œåç§»é‡ï¼‰å‘é€åˆ°socketç¼“å†²åŒº</li><li>DMAæ§åˆ¶å™¨æ ¹æ®æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œç›´æ¥æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡</li><li><strong>ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢2ï¼‰ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€</strong>ï¼Œsendfileè°ƒç”¨è¿”å›ã€‚</li></ol><p>å¯ä»¥å‘ç°ï¼Œ<code>sendfile+DMA scatter/gather</code>å®ç°çš„é›¶æ‹·è´ï¼ŒI/Oå‘ç”Ÿäº†<strong>2</strong>æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ2æ¬¡æ•°æ®æ‹·è´ã€‚å…¶ä¸­2æ¬¡æ•°æ®æ‹·è´éƒ½æ˜¯åŒ…<strong>DMAæ‹·è´</strong>ã€‚è¿™å°±æ˜¯çœŸæ­£çš„ <strong>é›¶æ‹·è´ï¼ˆZero-copy)</strong> æŠ€æœ¯ï¼Œå…¨ç¨‹éƒ½æ²¡æœ‰é€šè¿‡CPUæ¥æ¬è¿æ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é€šè¿‡DMAæ¥è¿›è¡Œä¼ è¾“çš„ã€‚</p><h3 id="splice">splice</h3><p>åŸºäº splice ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ0 æ¬¡ CPU æ‹·è´ä»¥åŠ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ splice() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li><li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚</li><li>CPU åœ¨å†…æ ¸ç©ºé—´çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰å’Œç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ä¹‹é—´å»ºç«‹ç®¡é“ï¼ˆpipelineï¼‰ã€‚</li><li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li><li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œsplice ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li></ol><p>splice æ‹·è´æ–¹å¼ä¹ŸåŒæ ·å­˜åœ¨ç”¨æˆ·ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„é—®é¢˜ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä½¿ç”¨äº† Linux çš„ç®¡é“ç¼“å†²æœºåˆ¶ï¼Œå¯ä»¥ç”¨äºä»»æ„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸­ä¼ è¾“æ•°æ®ï¼Œä½†æ˜¯å®ƒçš„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦å‚æ•°ä¸­æœ‰ä¸€ä¸ªå¿…é¡»æ˜¯ç®¡é“è®¾å¤‡ã€‚</p><p><strong>æ€»ç»“</strong></p><p>æ— è®ºæ˜¯ä¼ ç»Ÿ I/O æ‹·è´æ–¹å¼è¿˜æ˜¯å¼•å…¥é›¶æ‹·è´çš„æ–¹å¼ï¼Œ2 æ¬¡ DMA Copy æ˜¯éƒ½å°‘ä¸äº†çš„ï¼Œå› ä¸ºä¸¤æ¬¡ DMA éƒ½æ˜¯ä¾èµ–ç¡¬ä»¶å®Œæˆçš„ã€‚ä¸‹é¢ä» CPU æ‹·è´æ¬¡æ•°ã€DMA æ‹·è´æ¬¡æ•°ä»¥åŠç³»ç»Ÿè°ƒç”¨å‡ ä¸ªæ–¹é¢æ€»ç»“ä¸€ä¸‹ä¸Šè¿°å‡ ç§ I/O æ‹·è´æ–¹å¼çš„å·®åˆ«ã€‚</p><table><thead><tr><th>æ‹·è´æ–¹å¼</th><th>CPUæ‹·è´</th><th>DMAæ‹·è´</th><th>ç³»ç»Ÿè°ƒç”¨</th><th>ä¸Šä¸‹æ–‡åˆ‡æ¢</th></tr></thead><tbody><tr><td>ä¼ ç»Ÿæ–¹å¼ï¼ˆread + writeï¼‰</td><td>2</td><td>2</td><td>read / write</td><td>4</td></tr><tr><td>å†…å­˜æ˜ å°„ï¼ˆmmap + writeï¼‰</td><td>1</td><td>2</td><td>mmap / write</td><td>4</td></tr><tr><td>sendfile</td><td>1</td><td>2</td><td>sendfile</td><td>2</td></tr><tr><td>sendfile + DMA gather copy</td><td>0</td><td>2</td><td>sendfile</td><td>2</td></tr><tr><td>splice</td><td>0</td><td>2</td><td>splice</td><td>2</td></tr></tbody></table><h2 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h2><ul><li><a href="https://juejin.cn/user/3104676567320286/posts">é›¶å£¹æŠ€æœ¯æ ˆ</a></li><li><a href="https://juejin.cn/user/4406498336190638/posts">æ½œè¡Œå‰è¡Œ</a></li><li><a href="https://www.modb.pro/db/218517">çœ‹ä¸€éå°±ç†è§£ï¼šé›¶æ‹·è´è¯¦è§£</a></li></ul>]]></content>
    
    
    <summary type="html">é›¶æ‹·è´</summary>
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://penge666.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://penge666.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>é¡µä¸­æ–­</title>
    <link href="https://penge666.github.io/posts/54462149.html"/>
    <id>https://penge666.github.io/posts/54462149.html</id>
    <published>2024-04-26T08:29:19.000Z</published>
    <updated>2024-04-26T08:58:28.284Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†</h2><blockquote><p><strong>Linuxè™šæ‹Ÿå†…å­˜ç³»ç»Ÿ</strong></p></blockquote><p>Linuxå°†è™šæ‹Ÿå†…å­˜ç»„ç»‡æˆä¸€äº›åŒºåŸŸ(ä¹Ÿå«åšæ®µ)çš„é›†åˆã€‚ä¸€ä¸ªåŒºåŸŸ(area)å°±æ˜¯å·²ç»å­˜åœ¨ç€çš„(å·²åˆ†é…çš„)è™šæ‹Ÿå†…å­˜çš„è¿ç»­ç‰‡(chunk)ï¼Œè¿™äº›é¡µæ˜¯ä»¥æŸç§æ–¹å¼ç›¸å…³è”çš„ã€‚ä¾‹å¦‚ï¼Œä»£ç æ®µã€æ•°æ®æ®µã€å †ã€å…±äº«åº“æ®µï¼Œä»¥åŠç”¨æˆ·æ ˆéƒ½æ˜¯ä¸åŒçš„åŒºåŸŸã€‚æ¯ä¸ªå­˜åœ¨çš„è™šæ‹Ÿé¡µé¢éƒ½ä¿å­˜åœ¨æŸä¸ªåŒºåŸŸä¸­ï¼Œè€Œä¸å±äºæŸä¸ªåŒºåŸŸçš„è™šæ‹Ÿé¡µæ˜¯ä¸å­˜åœ¨çš„ï¼Œå¹¶ä¸”ä¸èƒ½è¢«è¿›ç¨‹å¼•ç”¨ã€‚åŒºåŸŸçš„æ¦‚å¿µå¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸è™šæ‹Ÿåœ°å€ç©ºé—´æœ‰é—´éš™ã€‚å†…æ ¸ä¸ç”¨è®°å½•é‚£äº›ä¸å­˜åœ¨çš„è™šæ‹Ÿé¡µï¼Œè€Œè¿™æ ·çš„é¡µä¹Ÿä¸å ç”¨å†…å­˜ã€ç£ç›˜æˆ–è€…å†…æ ¸æœ¬èº«ä¸­çš„ä»»ä½•é¢å¤–èµ„æºã€‚</p><p>Linuxå°†è™šæ‹Ÿå†…å­˜ç»„ç»‡æˆä¸€äº›åŒºåŸŸ(ä¹Ÿå«åšæ®µ)çš„é›†åˆã€‚ä¸€ä¸ªåŒºåŸŸ(area)å°±æ˜¯å·²ç»å­˜åœ¨ç€çš„(å·²åˆ†é…çš„)è™šæ‹Ÿå†…å­˜çš„è¿ç»­ç‰‡(chunk)ï¼Œè¿™äº›é¡µæ˜¯ä»¥æŸç§æ–¹å¼ç›¸å…³è”çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426163611028.png" alt="image-20240426163611028"></p><p>ä¸‹å›¾å¼ºè°ƒäº†è®°å½•ä¸€ä¸ªè¿›ç¨‹ä¸­è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„å†…æ ¸æ•°æ®ç»“æ„ã€‚å†…æ ¸ä¸ºç³»ç»Ÿä¸­çš„æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ªå•ç‹¬çš„ä»»åŠ¡ç»“æ„(æºä»£ç ä¸­çš„task_struct)ã€‚ä»»åŠ¡ç»“æ„ä¸­çš„å…ƒç´ åŒ…å«æˆ–è€…æŒ‡å‘å†…æ ¸è¿è¡Œè¯¥è¿›ç¨‹æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯(ä¾‹å¦‚ï¼ŒPIDã€æŒ‡å‘ç”¨æˆ·æ ˆçš„æŒ‡é’ˆã€å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶çš„åå­—ï¼Œä»¥åŠç¨‹åºè®¡æ•°å™¨)ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426163509993.png" alt="image-20240426163509993"></p><p>ä»»åŠ¡ç»“æ„ä¸­çš„ä¸€ä¸ªæ¡ç›®æŒ‡å‘mm_structï¼Œå®ƒæè¿°äº†è™šæ‹Ÿå†…å­˜çš„å½“å‰çŠ¶æ€ã€‚æˆ‘ä»¬æ„Ÿå…´è¶£çš„ä¸¤ä¸ªå­—æ®µæ˜¯ pgdå’Œmmapï¼Œå…¶ä¸­ pgdæŒ‡å‘ç¬¬ä¸€çº§é¡µè¡¨(é¡µå…¨å±€ç›®å½•)çš„åŸºå€ï¼Œè€ŒmmapæŒ‡å‘ä¸€ä¸ªvm area_structs(åŒºåŸŸç»“æ„)çš„é“¾è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªvm_area_structséƒ½æè¿°äº†å½“å‰è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€ä¸ªåŒºåŸŸã€‚å½“å†…æ ¸è¿è¡Œè¿™ä¸ªè¿›ç¨‹æ—¶ï¼Œå°±å°†pgdå­˜æ”¾åœ¨CR3æ§åˆ¶å¯„å­˜å™¨ä¸­ã€‚</p><p>ä¸€ä¸ªå…·ä½“çš„åŒºåŸŸç»“æ„åŒ…å«ä»¥ä¸‹å­—æ®µï¼š</p><ul><li>vm_start:æŒ‡å‘è¿™ä¸ªåŒºåŸŸçš„èµ·å§‹å¤„ã€‚</li><li>vm_end:æŒ‡å‘è¿™ä¸ªåŒºåŸŸçš„ç»“æŸå¤„ã€‚</li><li>vm_prot:æè¿°è¿™ä¸ªåŒºåŸŸå†…åŒ…å«çš„æ‰€æœ‰é¡µçš„è¯»å†™è®¸å¯æƒé™ã€‚</li><li>vm_flags:æè¿°è¿™ä¸ªåŒºåŸŸå†…çš„é¡µé¢æ˜¯ä¸å…¶ä»–è¿›ç¨‹å…±äº«çš„ï¼Œè¿˜æ˜¯è¿™ä¸ªè¿›ç¨‹ç§æœ‰çš„(è¿˜æè¿°äº†å…¶ä»–ä¸€äº›ä¿¡æ¯)ã€‚</li><li>vm_next:æŒ‡å‘é“¾è¡¨ä¸­ä¸‹ä¸€ä¸ªåŒºåŸŸç»“æ„ã€‚</li></ul><blockquote><p><strong>é¡µä¸­æ–­å¼‚å¸¸å¤„ç†</strong></p></blockquote><p>å‡è®¾ MMUåœ¨è¯•å›¾ç¿»è¯‘æŸä¸ªè™šæ‹Ÿåœ°å€Aæ—¶ï¼Œè§¦å‘äº†ä¸€ä¸ªç¼ºé¡µã€‚è¿™ä¸ªå¼‚å¸¸å¯¼è‡´æ§åˆ¶è½¬ç§»åˆ°å†…æ ¸çš„ç¼ºé¡µå¤„ç†ç¨‹åºï¼Œå¤„ç†ç¨‹åºéšåå°±æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤:</p><ol><li>è™šæ‹Ÿåœ°å€Aæ˜¯åˆæ³•çš„å—?æ¢å¥è¯è¯´ï¼ŒAåœ¨æŸä¸ªåŒºåŸŸç»“æ„å®šä¹‰çš„åŒºåŸŸå†…å—?ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œç¼ºé¡µå¤„ç†ç¨‹åºæœç´¢åŒºåŸŸç»“æ„çš„é“¾è¡¨ï¼ŒæŠŠAå’Œæ¯ä¸ªåŒºåŸŸç»“æ„ä¸­çš„vm_startå’Œvm_endåšæ¯”è¾ƒã€‚å¦‚æœè¿™ä¸ªæŒ‡ä»¤æ˜¯ä¸åˆæ³•çš„ï¼Œé‚£ä¹ˆç¼ºé¡µå¤„ç†ç¨‹åºå°±è§¦å‘ä¸€ä¸ªæ®µé”™è¯¯ï¼Œä»è€Œå©†æ­¢è¿™ä¸ªè¿›ç¨‹ã€‚è¿™ä¸ªæƒ…å†µåœ¨å›¾9-28ä¸­æ ‡è¯†ä¸ºâ€œ1â€ã€‚<br>å› ä¸ºä¸€ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„æ–°è™šæ‹Ÿå†…å­˜åŒºåŸŸ(ä½¿ç”¨åœ¨ä¸‹ä¸€èŠ‚ä¸­æè¿°çš„mmapå‡½æ•°)ï¼Œæ‰€ä»¥é¡ºåºæœç´¢åŒºåŸŸç»“æ„çš„é“¾è¡¨èŠ±é”€å¯èƒ½ä¼šå¾ˆå¤§ã€‚å› æ­¤åœ¨å®é™…ä¸­ï¼ŒLinuxä½¿ç”¨æŸäº›æˆ‘ä»¬æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥çš„å­—æ®µï¼ŒLinuxåœ¨é“¾è¡¨ä¸­æ„å»ºäº†ä¸€æ£µæ ‘ï¼Œå¹¶åœ¨è¿™æ£µæ ‘ä¸Šè¿›è¡ŒæŸ¥æ‰¾ã€‚</li><li>è¯•å›¾è¿›è¡Œçš„å†…å­˜è®¿é—®æ˜¯å¦åˆæ³•?æ¢å¥è¯è¯´ï¼Œè¿›ç¨‹æ˜¯å¦æœ‰è¯»ã€å†™æˆ–è€…æ‰§è¡Œè¿™ä¸ªåŒºåŸŸå†…é¡µé¢çš„æƒé™?ä¾‹å¦‚ï¼Œè¿™ä¸ªç¼ºé¡µæ˜¯ä¸æ˜¯ç”±ä¸€æ¡è¯•å›¾å¯¹è¿™ä¸ªä»£ç æ®µé‡Œçš„åªè¯»é¡µé¢è¿›è¡Œå†™æ“ä½œçš„å­˜å‚¨æŒ‡ä»¤é€ æˆçš„?è¿™ä¸ªç¼ºé¡µæ˜¯ä¸æ˜¯å› ä¸ºä¸€ä¸ªè¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸­çš„è¿›ç¨‹è¯•å›¾ä»å†…æ ¸è™šæ‹Ÿå†…å­˜ä¸­è¯»å–å­—é€ æˆçš„?å¦‚æœè¯•å›¾è¿›è¡Œçš„è®¿é—®æ˜¯ä¸åˆæ³•çš„ï¼Œé‚£ä¹ˆç¼ºé¡µå¤„ç†ç¨‹åºä¼šè§¦å‘ä¸€ä¸ªä¿æŠ¤å¼‚å¸¸ï¼Œä»è€Œç»ˆæ­¢è¿™ä¸ªè¿›ç¨‹ã€‚è¿™ç§æƒ…å†µåœ¨å›¾9-28ä¸­æ ‡è¯†ä¸ºâ€œ2â€ã€‚</li><li>æ­¤åˆ»ï¼Œå†…æ ¸çŸ¥é“äº†è¿™ä¸ªç¼ºé¡µæ˜¯ç”±äºå¯¹åˆæ³•çš„è™šæ‹Ÿåœ°å€è¿›è¡Œåˆæ³•çš„æ“ä½œé€ æˆçš„ã€‚å®ƒæ˜¯è¿™æ ·æ¥å¤„ç†è¿™ä¸ªç¼ºé¡µçš„:é€‰æ‹©ä¸€ä¸ªç‰ºç‰²é¡µé¢ï¼Œå¦‚æœè¿™ä¸ªç‰ºç‰²é¡µé¢è¢«ä¿®æ”¹è¿‡ï¼Œé‚£ä¹ˆå°±å°†å®ƒäº¤æ¢å‡ºå»ï¼Œæ¢å…¥æ–°çš„é¡µé¢å¹¶æ›´æ–°é¡µè¡¨ã€‚å½“ç¼ºé¡µå¤„ç†ç¨‹åºè¿”å›æ—¶ï¼ŒCPUé‡æ–°å¯åŠ¨å¼•èµ·ç¼ºé¡µçš„æŒ‡ä»¤ï¼Œè¿™æ¡æŒ‡ä»¤å°†å†æ¬¡å‘é€Aåˆ° MMUã€‚è¿™æ¬¡ï¼ŒMMUå°±èƒ½æ­£å¸¸åœ°ç¿»è¯‘Aï¼Œè€Œä¸ä¼šå†äº§ç”Ÿç¼ºé¡µä¸­æ–­äº†ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426165657036.png" alt="image-20240426165657036"></p><h2 id="forkåŸç†">forkåŸç†</h2><p><strong>forkåŸç†ï¼šå†™ä¿æŠ¤ä¸­æ–­ä¸å†™æ—¶å¤åˆ¶</strong></p><p>çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸ä»…å¯ä»¥è®¿é—®å…±æœ‰çš„å˜é‡ï¼Œè¿˜å¯ä»¥å„è‡ªä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œå¹¶ä¸”è¿™ä¸ªä¿®æ”¹å¯¹æ–¹éƒ½çœ‹ä¸è§ã€‚è¿™å…¶å®æ˜¯ fork çš„ä¸€ç§å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œè€Œé‡Œé¢èµ·å…³é”®ä½œç”¨çš„å°±æ˜¯å†™ä¿æŠ¤ä¸­æ–­ã€‚</p><p>å®é™…ä¸Šï¼Œæ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªè¿›ç¨‹ç®¡ç†çš„ç»“æ„ï¼Œåœ¨åç†è®ºçš„ä¹¦ç±é‡Œä¸€èˆ¬ä¼šç§°å®ƒä¸ºè¿›ç¨‹æ§åˆ¶å—ï¼ˆProcess Control Blockï¼ŒPCB)ã€‚å…·ä½“åˆ° Linux ç³»ç»Ÿä¸Šï¼ŒPCB å°±æ˜¯ task_struct è¿™ä¸ªç»“æ„ä½“ã€‚å®ƒé‡Œé¢è®°å½•äº†è¿›ç¨‹çš„é¡µè¡¨åŸºå€ï¼Œæ‰“å¼€æ–‡ä»¶åˆ—è¡¨ã€ä¿¡å·ã€æ—¶é—´ç‰‡ã€è°ƒåº¦å‚æ•°å’Œçº¿æ€§ç©ºé—´å·²ç»åˆ†é…çš„å†…å­˜åŒºåŸŸç­‰ç­‰æ•°æ®ã€‚</p><p>å…¶ä¸­ï¼Œ<strong>æè¿°çº¿æ€§ç©ºé—´å·²åˆ†é…çš„å†…å­˜åŒºåŸŸçš„ç»“æ„å¯¹äºå†…å­˜ç®¡ç†è‡³å…³é‡è¦</strong>ã€‚åœ¨ Linux æºç ä¸­ï¼Œè´Ÿè´£è¿™ä¸ªåŠŸèƒ½çš„ç»“æ„æ˜¯ vm_area_structï¼Œåé¢ç®€ç§° vmaã€ä¹Ÿæ˜¯å‰ç½®çŸ¥è¯†ä¸­æåˆ°çš„ã€‘ã€‚å†…æ ¸å°†æ¯ä¸€æ®µå…·æœ‰ç›¸åŒå±æ€§çš„å†…å­˜åŒºåŸŸå½“ä½œä¸€ä¸ªå•ç‹¬çš„å†…å­˜å¯¹è±¡è¿›è¡Œç®¡ç†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">vm_area_struct</span> &#123; </span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> vm_start;      <span class="comment">// åŒºé—´é¦–åœ°å€</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> vm_end;        <span class="comment">// åŒºé—´å°¾åœ°å€</span></span><br><span class="line">  <span class="type">pgprot_t</span>      vm_page_prot;  <span class="comment">// è®¿é—®æ§åˆ¶æƒé™</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> vm_flags;      <span class="comment">// æ ‡å¿—ä½</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">file</span> * vm_file;       <span class="comment">// è¢«æ˜ å°„çš„æ–‡ä»¶</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> vm_pgoff;      <span class="comment">// æ–‡ä»¶ä¸­çš„åç§»é‡</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸é‡Œï¼Œfork çš„ç¬¬ä¸€ä¸ªåŠ¨ä½œæ˜¯æŠŠ PCB å¤åˆ¶ä¸€ä»½ï¼Œä½†ç±»ä¼¼äºç‰©ç†é¡µç­‰è¿›ç¨‹èµ„æºä¸ä¼šè¢«å¤åˆ¶</strong>ã€‚è¿™æ ·çš„è¯ï¼Œçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µã€å †å’Œæ ˆéƒ½æ˜¯ç›¸åŒçš„ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬æ‹¥æœ‰ç›¸åŒçš„é¡µè¡¨ï¼Œè‡ªç„¶ä¹Ÿæœ‰ç›¸åŒçš„è™šæ‹Ÿç©ºé—´å¸ƒå±€å’Œå¯¹ç‰©ç†å†…å­˜çš„æ˜ å°„ã€‚å¦‚æœçˆ¶è¿›ç¨‹åœ¨ fork å­è¿›ç¨‹ä¹‹å‰åˆ›å»ºäº†ä¸€ä¸ªå˜é‡ï¼Œæ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆçˆ¶å­è¿›ç¨‹éƒ½èƒ½çœ‹åˆ°è¿™ä¸ªå˜é‡å’Œæ–‡ä»¶ã€‚</p><p><strong>fork çš„ç¬¬äºŒä¸ªåŠ¨ä½œæ˜¯å¤åˆ¶é¡µè¡¨å’Œ PCB ä¸­çš„ vma æ•°ç»„ï¼Œå¹¶æŠŠæ‰€æœ‰å½“å‰æ­£å¸¸çŠ¶æ€çš„æ•°æ®æ®µã€å †å’Œæ ˆç©ºé—´çš„è™šæ‹Ÿå†…å­˜é¡µï¼Œè®¾ç½®ä¸ºä¸å¯å†™ï¼Œç„¶åæŠŠå·²ç»æ˜ å°„çš„ç‰©ç†é¡µé¢çš„å¼•ç”¨è®¡æ•°åŠ  1</strong>ã€‚è¿™ä¸€æ­¥åªéœ€è¦å¤åˆ¶é¡µè¡¨å’Œä¿®æ”¹ PTE ä¸­çš„å†™æƒé™ä½å¯ä»¥äº†ï¼Œå¹¶ä¸ä¼šçœŸçš„ä¸ºå­è¿›ç¨‹çš„æ‰€æœ‰å†…å­˜ç©ºé—´åˆ†é…ç‰©ç†é¡µé¢ï¼Œä¿®æ”¹æ˜ å°„ï¼Œæ‰€ä»¥å®ƒçš„æ•ˆç‡æ˜¯éå¸¸é«˜çš„ã€‚è¿™æ—¶ï¼Œçˆ¶å­è¿›ç¨‹çš„é¡µè¡¨çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426164350719.png" alt="image-20240426164350719"></p><p>åœ¨ä¸Šå›¾ä¸­ï¼Œç‰©ç†é¡µæ‹¬å·ä¸­çš„æ•°å­—ä»£è¡¨è¯¥é¡µè¢«å¤šå°‘ä¸ªè¿›ç¨‹æ‰€å¼•ç”¨ã€‚Linux ä¸­ç”¨äºç®¡ç†ç‰©ç†é¡µé¢ï¼Œå’Œç»´æŠ¤ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°çš„ç»“æ„æ˜¯ mem_map å’Œ page structã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯å†™ä¿æŠ¤ä¸­æ–­è¦å‘æŒ¥ä½œç”¨çš„åœ°æ–¹äº†ã€‚ä¸ç®¡æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ï¼Œå®ƒä»¬æ¥ä¸‹æ¥éƒ½æœ‰å¯èƒ½å‘ç”Ÿå†™æ“ä½œï¼Œä½†æˆ‘ä»¬çŸ¥é“åœ¨ fork çš„ç¬¬äºŒæ­¥æ“ä½œä¸­ï¼Œå·²ç»å°†æ‰€æœ‰åŸæ¥å¯å†™çš„åœ°æ–¹éƒ½å˜æˆä¸å¯å†™äº†ï¼Œæ‰€ä»¥è¿™æ—¶å¿…ç„¶ä¼šå‘ç”Ÿå†™ä¿æŠ¤ä¸­æ–­ã€‚</p><p>æˆ‘ä»¬åˆšæ‰è¯´ï¼ŒLinux ç³»ç»Ÿçš„é¡µä¸­æ–­çš„å…¥å£åœ°å€æ˜¯ do_page_faultï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼Œå®ƒä¼šç»§ç»­åˆ¤æ–­ä¸­æ–­çš„ç±»å‹ã€‚ç”±äºå‘ç”Ÿä¸­æ–­çš„è™šæ‹Ÿåœ°å€åœ¨ vma ä¸­æ˜¯å¯å†™çš„ï¼Œåœ¨ PTE ä¸­å´æ˜¯åªè¯»çš„ï¼Œå¯ä»¥æ–­å®šè¿™æ˜¯ä¸€æ¬¡å†™ä¿æŠ¤ä¸­æ–­ã€‚è¿™æ—¶å€™ï¼Œå†…æ ¸å°±ä¼šè½¬è€Œè°ƒç”¨ do_wp_page æ¥å¤„ç†è¿™æ¬¡ä¸­æ–­ï¼Œwp æ˜¯ write protection çš„ç¼©å†™ã€‚</p><p>åœ¨ do_wp_page ä¸­ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å‘ç”Ÿä¸­æ–­çš„è™šæ‹Ÿåœ°å€æ‰€å¯¹åº”çš„ç‰©ç†åœ°å€çš„å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœå¤§äº 1ï¼Œå°±è¯´æ˜ç°åœ¨å­˜åœ¨å¤šä¸ªè¿›ç¨‹å…±äº«è¿™ä¸€å—ç‰©ç†é¡µé¢ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦ä¸ºå‘ç”Ÿä¸­æ–­çš„è¿›ç¨‹å†åˆ†é…ä¸€ä¸ªç‰©ç†é¡µé¢ï¼ŒæŠŠè€çš„é¡µé¢å†…å®¹æ‹·è´è¿›è¿™ä¸ªæ–°çš„ç‰©ç†é¡µï¼Œæœ€åæŠŠå‘ç”Ÿä¸­æ–­çš„è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°æ–°çš„ç‰©ç†é¡µã€‚è¿™å°±å®Œæˆäº†ä¸€æ¬¡å†™æ—¶å¤åˆ¶ (Copy On Writeï¼Œ COWï¼‰ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426164426565.png" alt="image-20240426164426565"></p><p>åœ¨ä¸Šå›¾ä¸­ï¼Œå½“å­è¿›ç¨‹å‘ç”Ÿå†™ä¿æŠ¤ä¸­æ–­åï¼Œç³»ç»Ÿå°±ä¼šä¸ºå®ƒåˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œç„¶åå¤åˆ¶é¡µé¢ï¼Œå†ä¿®æ”¹é¡µè¡¨æ˜ å°„ã€‚è¿™æ—¶è€çš„ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°å°±å˜ä¸º 1ï¼ŒåŒæ—¶å­è¿›ç¨‹ä¸­çš„ PTE çš„æƒé™ä¹Ÿä»åªè¯»å˜ä¸ºè¯»å†™ã€‚</p><p>å½“çˆ¶è¿›ç¨‹å†è®¿é—®åˆ°è¿™ä¸ªåœ°å€æ—¶ï¼Œä¹Ÿä¼šè§¦å‘ä¸€æ¬¡å†™ä¿æŠ¤ä¸­æ–­ï¼Œè¿™æ—¶ç³»ç»Ÿå‘ç°ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ä¸º 1ï¼Œé‚£å°±åªè¦æŠŠçˆ¶è¿›ç¨‹ PTE ä¸­çš„æƒé™ï¼Œç®€å•åœ°ä»åªè¯»å˜ä¸ºè¯»å†™å°±å¯ä»¥äº†ã€‚</p><p>æ€»ç»“ï¼š</p><p>fork åœ¨æ‰§è¡Œæ—¶ï¼Œå­è¿›ç¨‹åªä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„ PCB å’Œé¡µè¡¨ï¼Œå¹¶ä¸”æŠŠæ‰€æœ‰é¡µè¡¨é¡¹éƒ½è®¾ä¸ºåªè¯»ï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸ä¼šå¤åˆ¶çœŸæ­£çš„ç‰©ç†é¡µã€‚åªæœ‰å½“çˆ¶å­è¿›ç¨‹å…¶ä¸­ä¸€ä¸ªå¯¹é¡µè¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œæ‰ä¼šå¤åˆ¶ä¸€ä¸ªå‰¯æœ¬å‡ºæ¥ã€‚è¿™ç§æœºåˆ¶è¢«ç§°ä¸ºå†™æ—¶å¤åˆ¶ã€‚</p><h2 id="execveåŸç†">execveåŸç†</h2><p><strong>execveåŸç†ï¼šç¼ºé¡µä¸­æ–­</strong></p><p>execve çš„ä½œç”¨æ˜¯ä½¿å½“å‰è¿›ç¨‹æ‰§è¡Œä¸€ä¸ªæ–°çš„å¯æ‰§è¡Œç¨‹åºï¼Œå®ƒçš„åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">execve</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename, <span class="type">const</span> <span class="type">char</span>* argv[],<span class="type">const</span> <span class="type">char</span>* envp[])</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ execve çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯æ‰§è¡Œç¨‹åºçš„æ–‡ä»¶åï¼Œç¬¬äºŒä¸ªå‚æ•°ç”¨æ¥ä¼ é€’å‘½ä»¤è¡Œå‚æ•°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ç”¨æ¥ä¼ é€’ç¯å¢ƒå˜é‡ã€‚</p><p>execve çš„æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ol><li>æ¸…ç©ºé¡µè¡¨ï¼Œè¿™æ ·æ•´ä¸ªè¿›ç¨‹ä¸­çš„é¡µéƒ½å˜æˆä¸å­˜åœ¨äº†ï¼Œä¸€æ—¦è®¿é—®è¿™äº›é¡µï¼Œå°±ä¼šå‘ç”Ÿé¡µä¸­æ–­ï¼›</li><li>æ‰“å¼€å¾…åŠ è½½æ‰§è¡Œçš„æ–‡ä»¶ï¼Œåœ¨å†…æ ¸ä¸­åˆ›å»ºä»£è¡¨è¿™ä¸ªæ–‡ä»¶çš„ struct file ç»“æ„ï¼›</li><li>åŠ è½½å’Œè§£ææ–‡ä»¶å¤´ï¼Œæ–‡ä»¶å¤´é‡Œæè¿°äº†è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸€å…±æœ‰å¤šå°‘ sectionï¼›</li><li>åˆ›å»ºç›¸åº”çš„ vma æ¥æè¿°ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œå¹¶ä¸”å°†æ–‡ä»¶çš„å„ä¸ª section ä¸è¿™äº›å†…å­˜åŒºåŸŸå»ºç«‹æ˜ å°„å…³ç³»ï¼›</li><li>å¦‚æœå½“å‰åŠ è½½çš„æ–‡ä»¶è¿˜ä¾èµ–å…¶ä»–å…±äº«åº“æ–‡ä»¶ï¼Œåˆ™æ‰¾åˆ°è¿™ä¸ªå…±äº«åº“æ–‡ä»¶ï¼Œå¹¶è·³è½¬åˆ°ç¬¬ 2 æ­¥ç»§ç»­å¤„ç†è¿™ä¸ªå…±äº«åº“æ–‡ä»¶ï¼›</li><li>æœ€åè·³è½¬åˆ°å¯æ‰§è¡Œç¨‹åºçš„å…¥å£å¤„æ‰§è¡Œã€‚</li></ol><p><strong>execve çš„å®ç°å¹¶ä¸è´Ÿè´£å°†æ–‡ä»¶å†…å®¹åŠ è½½åˆ°ç‰©ç†é¡µä¸­ï¼Œå®ƒåªå»ºç«‹äº†è¿™ç§æ–‡ä»¶ sectionï¼Œä¸å†…å­˜åŒºåŸŸçš„æ˜ å°„å…³ç³»å°±ç»“æŸäº†</strong>ã€‚çœŸæ­£è´Ÿè´£åŠ è½½æ–‡ä»¶å†…å®¹çš„æ˜¯ç¼ºé¡µä¸­æ–­ã€‚</p><p>å› ä¸ºç”±äºç¬¬ 1 æ­¥æŠŠé¡µè¡¨éƒ½æ¸…ç©ºäº†ï¼Œè¿™å°±å¯¼è‡´ CPU åœ¨åŠ è½½æŒ‡ä»¤æ—¶ä¼šå‘ç°ä»£ç æ®µæ˜¯ç¼ºå¤±çš„ï¼Œæ­¤æ—¶å°±ä¼šäº§ç”Ÿç¼ºé¡µä¸­æ–­ã€‚</p><p>Linux å†…æ ¸ç”¨äºå¤„ç†ç¼ºé¡µä¸­æ–­çš„å‡½æ•°æ˜¯ do_no_pageï¼Œå¦‚æœå†…æ ¸æ£€æŸ¥ï¼Œå½“å‰å‡ºç°ç¼ºé¡µä¸­æ–­çš„è™šæ‹Ÿåœ°å€æ‰€åœ¨çš„å†…å­˜åŒºåŸŸ vmaï¼ˆè™šæ‹Ÿåœ°å€è½åœ¨è¯¥å†…å­˜åŒºåŸŸçš„ vm_start å’Œ vm_end ä¹‹é—´ï¼‰å­˜åœ¨æ–‡ä»¶æ˜ å°„ (vm_file ä¸ä¸ºç©ºï¼‰ï¼Œé‚£å°±å¯ä»¥é€šè¿‡è™šæ‹Ÿå†…å­˜åœ°å€è®¡ç®—æ–‡ä»¶ä¸­çš„åç§»ï¼Œè¿™å°±å®šä½åˆ°äº†å†…å­˜æ‰€ç¼ºçš„é¡µå¯¹åº”åˆ°æ–‡ä»¶çš„å“ªä¸€æ®µã€‚ç„¶åå†…æ ¸å°±å¯åŠ¨ç£ç›˜ IOï¼Œå°†å¯¹åº”çš„é¡µä»ç£ç›˜åŠ è½½è¿›å†…å­˜ã€‚ä¸€æ¬¡ç¼ºé¡µä¸­æ–­å°±è¿™æ ·è¢«è§£å†³äº†ã€‚</p><h2 id="mmapåŸç†">mmapåŸç†</h2><blockquote><p><strong>mmapå†…å­˜æ˜ å°„è¿‡ç¨‹</strong></p></blockquote><p>mmapå†…å­˜æ˜ å°„çš„å®ç°è¿‡ç¨‹ï¼Œæ€»çš„æ¥è¯´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><p><strong>(ä¸€)è¿›ç¨‹å¯åŠ¨æ˜ å°„è¿‡ç¨‹ï¼Œå¹¶åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸ºæ˜ å°„åˆ›å»ºè™šæ‹Ÿæ˜ å°„åŒºåŸŸ</strong></p><ol><li><p>è¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´è°ƒç”¨åº“å‡½æ•°mmapï¼ŒåŸå‹ï¼švoid *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offset);</p></li><li><p>åœ¨å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œå¯»æ‰¾ä¸€æ®µç©ºé—²çš„æ»¡è¶³è¦æ±‚çš„è¿ç»­çš„è™šæ‹Ÿåœ°å€ã€‚</p></li><li><p>ä¸ºæ­¤è™šæ‹ŸåŒºåˆ†é…ä¸€ä¸ªvm_area_structç»“æ„ï¼Œæ¥ç€å¯¹è¿™ä¸ªç»“æ„çš„å„ä¸ªåŸŸè¿›è¡Œäº†åˆå§‹åŒ–ã€‚</p></li><li><p>å°†æ–°å»ºçš„è™šæ‹ŸåŒºç»“æ„ï¼ˆvm_area_structï¼‰æ’å…¥è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€åŒºåŸŸé“¾è¡¨æˆ–æ ‘ä¸­ã€‚</p></li></ol><p><strong>(äºŒ)è°ƒç”¨å†…æ ¸ç©ºé—´çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°mmapï¼ˆä¸åŒäºç”¨æˆ·ç©ºé—´å‡½æ•°ï¼‰ï¼Œå®ç°æ–‡ä»¶ç‰©ç†åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€çš„ä¸€ä¸€æ˜ å°„å…³ç³»</strong></p><ol start="5"><li><p>ä¸ºæ˜ å°„åˆ†é…äº†æ–°çš„è™šæ‹Ÿåœ°å€åŒºåŸŸåï¼Œé€šè¿‡å¾…æ˜ å°„çš„æ–‡ä»¶æŒ‡é’ˆï¼Œåœ¨æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡æ–‡ä»¶æè¿°ç¬¦ï¼Œé“¾æ¥åˆ°å†…æ ¸â€œå·²æ‰“å¼€æ–‡ä»¶é›†â€ä¸­è¯¥æ–‡ä»¶çš„æ–‡ä»¶ç»“æ„ä½“ï¼ˆstruct fileï¼‰ï¼Œæ¯ä¸ªæ–‡ä»¶ç»“æ„ä½“ç»´æŠ¤ç€å’Œè¿™ä¸ªå·²æ‰“å¼€æ–‡ä»¶ç›¸å…³å„é¡¹ä¿¡æ¯ã€‚</p></li><li><p>é€šè¿‡è¯¥æ–‡ä»¶çš„æ–‡ä»¶ç»“æ„ä½“ï¼Œé“¾æ¥åˆ°file_operationsæ¨¡å—ï¼Œè°ƒç”¨å†…æ ¸å‡½æ•°mmapï¼Œå…¶åŸå‹ä¸ºï¼šint mmap(struct file *filp, struct vm_area_struct *vma)ï¼Œä¸åŒäºç”¨æˆ·ç©ºé—´åº“å‡½æ•°ã€‚</p></li><li><p>å†…æ ¸mmapå‡½æ•°é€šè¿‡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿinodeæ¨¡å—å®šä½åˆ°æ–‡ä»¶ç£ç›˜ç‰©ç†åœ°å€ã€‚</p></li><li><p>é€šè¿‡remap_pfn_rangeå‡½æ•°å»ºç«‹é¡µè¡¨ï¼Œå³å®ç°äº†æ–‡ä»¶åœ°å€å’Œè™šæ‹Ÿåœ°å€åŒºåŸŸçš„æ˜ å°„å…³ç³»ã€‚æ­¤æ—¶ï¼Œè¿™ç‰‡è™šæ‹Ÿåœ°å€å¹¶æ²¡æœ‰ä»»ä½•æ•°æ®å…³è”åˆ°ä¸»å­˜ä¸­ã€‚</p></li></ol><p><strong>(ä¸‰)è¿›ç¨‹å‘èµ·å¯¹è¿™ç‰‡æ˜ å°„ç©ºé—´çš„è®¿é—®ï¼Œå¼•å‘ç¼ºé¡µå¼‚å¸¸ï¼Œå®ç°æ–‡ä»¶å†…å®¹åˆ°ç‰©ç†å†…å­˜ï¼ˆä¸»å­˜ï¼‰çš„æ‹·è´</strong></p><p>æ³¨ï¼šå‰ä¸¤ä¸ªé˜¶æ®µä»…åœ¨äºåˆ›å»ºè™šæ‹ŸåŒºé—´å¹¶å®Œæˆåœ°å€æ˜ å°„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å°†ä»»ä½•æ–‡ä»¶æ•°æ®çš„æ‹·è´è‡³ä¸»å­˜ã€‚çœŸæ­£çš„æ–‡ä»¶è¯»å–æ˜¯å½“è¿›ç¨‹å‘èµ·è¯»æˆ–å†™æ“ä½œæ—¶ã€‚</p><ol start="9"><li><p>è¿›ç¨‹çš„è¯»æˆ–å†™æ“ä½œè®¿é—®è™šæ‹Ÿåœ°å€ç©ºé—´è¿™ä¸€æ®µæ˜ å°„åœ°å€ï¼Œé€šè¿‡æŸ¥è¯¢é¡µè¡¨ï¼Œå‘ç°è¿™ä¸€æ®µåœ°å€å¹¶ä¸åœ¨ç‰©ç†é¡µé¢ä¸Šã€‚å› ä¸ºç›®å‰åªå»ºç«‹äº†åœ°å€æ˜ å°„ï¼ŒçœŸæ­£çš„ç¡¬ç›˜æ•°æ®è¿˜æ²¡æœ‰æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤å¼•å‘ç¼ºé¡µå¼‚å¸¸ã€‚</p></li><li><p>ç¼ºé¡µå¼‚å¸¸è¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­ï¼Œç¡®å®šæ— éæ³•æ“ä½œåï¼Œå†…æ ¸å‘èµ·è¯·æ±‚è°ƒé¡µè¿‡ç¨‹ã€‚</p></li><li><p>è°ƒé¡µè¿‡ç¨‹å…ˆåœ¨äº¤æ¢ç¼“å­˜ç©ºé—´ï¼ˆswap cacheï¼‰ä¸­å¯»æ‰¾éœ€è¦è®¿é—®çš„å†…å­˜é¡µï¼Œå¦‚æœæ²¡æœ‰åˆ™è°ƒç”¨nopageå‡½æ•°æŠŠæ‰€ç¼ºçš„é¡µä»ç£ç›˜è£…å…¥åˆ°ä¸»å­˜ä¸­ã€‚</p></li><li><p>ä¹‹åè¿›ç¨‹å³å¯å¯¹è¿™ç‰‡ä¸»å­˜è¿›è¡Œè¯»æˆ–è€…å†™çš„æ“ä½œï¼Œå¦‚æœå†™æ“ä½œæ”¹å˜äº†å…¶å†…å®¹ï¼Œä¸€å®šæ—¶é—´åç³»ç»Ÿä¼šè‡ªåŠ¨å›å†™è„é¡µé¢åˆ°å¯¹åº”ç£ç›˜åœ°å€ï¼Œä¹Ÿå³å®Œæˆäº†å†™å…¥åˆ°æ–‡ä»¶çš„è¿‡ç¨‹ã€‚</p></li></ol><p>**æ³¨æ„ï¼š**ä¿®æ”¹è¿‡çš„è„é¡µé¢å¹¶ä¸ä¼šç«‹å³æ›´æ–°å›æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯æœ‰ä¸€æ®µæ—¶é—´çš„å»¶è¿Ÿï¼Œå¯ä»¥è°ƒç”¨msync()æ¥å¼ºåˆ¶åŒæ­¥, è¿™æ ·æ‰€å†™çš„å†…å®¹å°±èƒ½ç«‹å³ä¿å­˜åˆ°æ–‡ä»¶é‡Œäº†ã€‚</p><blockquote><p><strong>mmap å’Œå¸¸è§„æ–‡ä»¶æ“ä½œçš„åŒºåˆ«</strong></p></blockquote><p>ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼š</p><ol><li><p>è¿›ç¨‹å‘èµ·è¯»æ–‡ä»¶è¯·æ±‚ã€‚</p></li><li><p>å†…æ ¸é€šè¿‡æŸ¥æ‰¾è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œå®šä½åˆ°å†…æ ¸å·²æ‰“å¼€æ–‡ä»¶é›†ä¸Šçš„æ–‡ä»¶ä¿¡æ¯ï¼Œä»è€Œæ‰¾åˆ°æ­¤æ–‡ä»¶çš„inodeã€‚</p></li><li><p>inodeåœ¨address_spaceä¸ŠæŸ¥æ‰¾è¦è¯·æ±‚çš„æ–‡ä»¶é¡µæ˜¯å¦å·²ç»ç¼“å­˜åœ¨é¡µç¼“å­˜ä¸­ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ç‰‡æ–‡ä»¶é¡µçš„å†…å®¹ã€‚</p></li><li><p>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é€šè¿‡inodeå®šä½åˆ°æ–‡ä»¶ç£ç›˜åœ°å€ï¼Œå°†æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°é¡µç¼“å­˜ã€‚ä¹‹åå†æ¬¡å‘èµ·è¯»é¡µé¢è¿‡ç¨‹ï¼Œè¿›è€Œå°†é¡µç¼“å­˜ä¸­çš„æ•°æ®å‘ç»™ç”¨æˆ·è¿›ç¨‹ã€‚</p></li></ol><p>ã€é‡ç‚¹ã€‘æ€»ç»“æ¥è¯´ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œä¸ºäº†æé«˜è¯»å†™æ•ˆç‡å’Œä¿æŠ¤ç£ç›˜ï¼Œä½¿ç”¨äº†é¡µç¼“å­˜æœºåˆ¶ã€‚è¿™æ ·é€ æˆè¯»æ–‡ä»¶æ—¶éœ€è¦å…ˆå°†æ–‡ä»¶é¡µä»ç£ç›˜æ‹·è´åˆ°é¡µç¼“å­˜ä¸­ï¼Œç”±äºé¡µç¼“å­˜å¤„åœ¨å†…æ ¸ç©ºé—´ï¼Œä¸èƒ½è¢«ç”¨æˆ·è¿›ç¨‹ç›´æ¥å¯»å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦å°†é¡µç¼“å­˜ä¸­æ•°æ®é¡µå†æ¬¡æ‹·è´åˆ°å†…å­˜å¯¹åº”çš„ç”¨æˆ·ç©ºé—´ä¸­ã€‚è¿™æ ·ï¼Œé€šè¿‡äº†ä¸¤æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œæ‰èƒ½å®Œæˆè¿›ç¨‹å¯¹æ–‡ä»¶å†…å®¹çš„è·å–ä»»åŠ¡ã€‚å†™æ“ä½œä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¾…å†™å…¥çš„bufferåœ¨å†…æ ¸ç©ºé—´ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œå¿…é¡»è¦å…ˆæ‹·è´è‡³å†…æ ¸ç©ºé—´å¯¹åº”çš„ä¸»å­˜ï¼Œå†å†™å›ç£ç›˜ä¸­ï¼ˆå»¶è¿Ÿå†™å›ï¼‰ï¼Œä¹Ÿæ˜¯éœ€è¦ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚</p><p>è€Œä½¿ç”¨mmapæ“ä½œæ–‡ä»¶ä¸­ï¼Œåˆ›å»ºæ–°çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸå’Œå»ºç«‹æ–‡ä»¶ç£ç›˜åœ°å€å’Œè™šæ‹Ÿå†…å­˜åŒºåŸŸæ˜ å°„è¿™ä¸¤æ­¥ï¼Œæ²¡æœ‰ä»»ä½•æ–‡ä»¶æ‹·è´æ“ä½œã€‚è€Œä¹‹åè®¿é—®æ•°æ®æ—¶å‘ç°å†…å­˜ä¸­å¹¶æ— æ•°æ®è€Œå‘èµ·çš„ç¼ºé¡µå¼‚å¸¸è¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡å·²ç»å»ºç«‹å¥½çš„æ˜ å°„å…³ç³»ï¼Œåªä½¿ç”¨ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œå°±ä»ç£ç›˜ä¸­å°†æ•°æ®ä¼ å…¥å†…å­˜çš„ç”¨æˆ·ç©ºé—´ä¸­ï¼Œä¾›è¿›ç¨‹ä½¿ç”¨ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œéœ€è¦ä»ç£ç›˜åˆ°é¡µç¼“å­˜å†åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚è€Œmmapæ“æ§æ–‡ä»¶ï¼Œåªéœ€è¦ä»ç£ç›˜åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸€æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ã€‚è¯´ç™½äº†ï¼Œmmapçš„å…³é”®ç‚¹æ˜¯å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®ç›´æ¥äº¤äº’è€Œçœå»äº†ç©ºé—´ä¸åŒã€æ•°æ®ä¸é€šçš„ç¹çè¿‡ç¨‹ã€‚å› æ­¤mmapæ•ˆç‡æ›´é«˜ã€‚</p><p><strong>Note</strong>ï¼šä½¿ç”¨mmapéœ€è¦æ³¨æ„çš„ä¸€ä¸ªå…³é”®ç‚¹æ˜¯ï¼Œmmapæ˜ å°„åŒºåŸŸå¤§å°å¿…é¡»æ˜¯ç‰©ç†é¡µå¤§å°(page_size)çš„æ•´å€æ•°ï¼ˆ32ä½ç³»ç»Ÿä¸­é€šå¸¸æ˜¯4kå­—èŠ‚ï¼‰ã€‚</p><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://joytsing.cn/posts/30090/">mmap,æ¯”æƒ³è±¡çš„æ›´é‡è¦ä¸€ç‚¹</a></li><li>æå®¢æ—¶é—´</li><li>ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹</li></ul>]]></content>
    
    
    <summary type="html">å¼ºå¤§çš„é¡µä¸­æ–­</summary>
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://penge666.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://penge666.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>EXTæ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="https://penge666.github.io/posts/93870e50.html"/>
    <id>https://penge666.github.io/posts/93870e50.html</id>
    <published>2024-04-26T06:26:10.000Z</published>
    <updated>2024-04-26T06:29:51.448Z</updated>
    
    <content type="html"><![CDATA[<h2 id="EXTæ–‡ä»¶ç³»ç»Ÿ">EXTæ–‡ä»¶ç³»ç»Ÿ</h2><h3 id="å‰è¨€">å‰è¨€</h3><p>å¼ºçƒˆæ¨èçœ‹å®Œè¿™ç¯‡Blogï¼Œè‡ªå·±åŠ¨æ‰‹äº²è‡ªå®ç°ä¸€ä¸ªminçš„æ–‡ä»¶ç³»ç»Ÿï¼Œæˆå°±æ„Ÿæ»¡æ»¡~</p><p>è¯¾ç¨‹ä¿¡æ¯ï¼šCSE.30341.FA17: Project 06ï¼šSimple File System</p><p>é“¾æ¥ï¼š<a href="https://www3.nd.edu/~pbui/teaching/cse.30341.fa17/project06.html">https://www3.nd.edu/~pbui/teaching/cse.30341.fa17/project06.html</a></p><p>ç”±äºå®éªŒè¦æ±‚ï¼Œè¿™é‡Œä¸æ”¾ä»“åº“é“¾æ¥ğŸ”—ã€‚æœ‰éœ€è¦å‚è€ƒçš„å°ä¼™ä¼´å¯ç§æˆ‘ã€‚</p><h3 id="0-é¢„å¤‡çŸ¥è¯†">0.é¢„å¤‡çŸ¥è¯†</h3><p>åœ¨å­¦ä¹ çŸ¥è¯†å‰ï¼Œæœ€å¥½è¦æœ‰ä¸ªæ•´ä½“çš„è®¤çŸ¥ï¼Œå†å»å­¦ä¹ ç»†èŠ‚ã€‚è¦ä¸ç„¶å®¹æ˜“é™·å…¥ç»†èŠ‚è¿·å¤±æ–¹å‘ã€‚</p><p>å…ˆæ¥ä¸ªæ•´ä½“çš„è®¤çŸ¥</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133829332.png" alt="image-20240426133829332"></p><ul><li><a href="https://www.bilibili.com/video/BV1ce4y1R7et/?spm_id_from=333.337.search-card.all.click&amp;vd_source=d6efee335659a376be8deb6c0654e9f7">ä¸€æ–‡å½»åº•ææ‡‚æ–‡ä»¶ç³»ç»Ÿã€‚æ–‡ä»¶ç³»ç»Ÿï¼Œè·ªä¸‹ï¼23è®¡ç®—æœºè€ƒç ”æ“ä½œç³»ç»Ÿå¤ç›˜ä¹‹æ–‡ä»¶ç³»ç»Ÿ</a></li></ul><p>æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹æœ‰å¾ˆå¤šç§</p><ul><li>CentOS 5å’ŒCentOS 6ä¸Šé»˜è®¤ä½¿ç”¨çš„ext2/ext3/ext4</li><li>CentOS 7ä¸Šé»˜è®¤ä½¿ç”¨çš„xfs</li><li>windowsä¸Šçš„NTFS</li><li>å…‰ç›˜ç±»çš„æ–‡ä»¶ç³»ç»ŸISO9660</li><li>MACä¸Šçš„æ··åˆæ–‡ä»¶ç³»ç»ŸHFS</li><li>ç½‘ç»œæ–‡ä»¶ç³»ç»ŸNFS</li><li>Oracleç ”å‘çš„btrfs</li><li>è¿˜æœ‰è€å¼çš„FAT/FAT32ç­‰ã€‚</li></ul><h3 id="1-æ–‡ä»¶ç³»ç»Ÿçš„ç»„æˆéƒ¨åˆ†">1.æ–‡ä»¶ç³»ç»Ÿçš„ç»„æˆéƒ¨åˆ†</h3><h4 id="1-1-blockçš„å‡ºç°">1.1 blockçš„å‡ºç°</h4><p>ç¡¬ç›˜æœ€åº•å±‚çš„è¯»å†™IOä¸€æ¬¡æ˜¯ä¸€ä¸ªæ‰‡åŒº512å­—èŠ‚ï¼Œå¦‚æœè¦è¯»å†™å¤§é‡æ–‡ä»¶ï¼Œä»¥æ‰‡åŒºä¸ºå•ä½è‚¯å®šå¾ˆæ…¢å¾ˆæ¶ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥ç¡¬ç›˜ä½¿ç”¨äº†ä¸€ä¸ªç§°ä½œé€»è¾‘å—çš„æ¦‚å¿µã€‚é€»è¾‘å—æ˜¯é€»è¾‘çš„ï¼Œç”±ç£ç›˜é©±åŠ¨å™¨è´Ÿè´£ç»´æŠ¤å’Œæ“ä½œï¼Œå®ƒå¹¶éæ˜¯åƒæ‰‡åŒºä¸€æ ·ç‰©ç†åˆ’åˆ†çš„ã€‚ä¸€ä¸ªé€»è¾‘å—çš„å¤§å°å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ‰‡åŒºï¼Œæ¯ä¸ªé€»è¾‘å—éƒ½æœ‰å”¯ä¸€çš„åœ°å€ï¼Œç§°ä¸ºLBAã€(Logical Block Addressing)é€»è¾‘å—å¯»å€æ¨¡å¼ã€‘ã€‚æœ‰äº†é€»è¾‘å—ä¹‹åï¼Œç£ç›˜æ§åˆ¶å™¨å¯¹æ•°æ®çš„æ“ä½œå°±ä»¥é€»è¾‘å—ä¸ºå•ä½ï¼Œä¸€æ¬¡è¯»å†™ä¸€ä¸ªé€»è¾‘å—ï¼Œç£ç›˜æ§åˆ¶å™¨çŸ¥é“å¦‚ä½•å°†é€»è¾‘å—ç¿»è¯‘æˆå¯¹åº”çš„æ‰‡åŒºå¹¶è¯»å†™æ•°æ®ã€‚</p><p>åˆ°äº†Linuxæ“ä½œç³»ç»Ÿå±‚æ¬¡ï¼Œé€šè¿‡æ–‡ä»¶ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªä¹Ÿç§°ä¸ºå—çš„è¯»å†™å•å…ƒï¼Œæ–‡ä»¶ç³»ç»Ÿæ•°æ®å—çš„å¤§å°ä¸€èˆ¬ä¸º1024bytes(1K)æˆ–2048bytes(2K)æˆ–4096bytes(4K)ã€‚æ–‡ä»¶ç³»ç»Ÿæ•°æ®å—ä¹Ÿæ˜¯é€»è¾‘æ¦‚å¿µï¼Œæ˜¯æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»´æŠ¤çš„ï¼Œè€Œç£ç›˜ä¸Šçš„é€»è¾‘æ•°æ®å—æ˜¯ç”±ç£ç›˜æ§åˆ¶å™¨ç»´æŠ¤çš„ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„IOç®¡ç†å™¨çŸ¥é“å¦‚ä½•å°†å®ƒçš„æ•°æ®å—ç¿»è¯‘æˆç£ç›˜ç»´æŠ¤çš„æ•°æ®å—åœ°å€LBAã€‚</p><p>å¯¹äºä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçš„IOæ“ä½œæ¥è¯´ï¼Œæ¯”å¦‚è¯»å†™æ–‡ä»¶ï¼Œè¿™äº›IOçš„åŸºæœ¬å•å…ƒæ˜¯æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ•°æ®å—ï¼Œä¸€æ¬¡è¯»å†™ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ•°æ®å—ã€‚æ¯”å¦‚éœ€è¦è¯»ä¸€ä¸ªæˆ–å¤šä¸ªå—æ—¶ï¼Œ<strong>æ–‡ä»¶ç³»ç»Ÿçš„IOç®¡ç†å™¨é¦–å…ˆè®¡ç®—è¿™äº›æ–‡ä»¶ç³»ç»Ÿå—å¯¹åº”åœ¨å“ªäº›ç£ç›˜æ•°æ®å—ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—å‡ºLBAï¼Œç„¶åé€šçŸ¥ç£ç›˜æ§åˆ¶å™¨è¦è¯»å–å“ªäº›å—çš„æ•°æ®ï¼Œç¡¬ç›˜æ§åˆ¶å™¨å°†è¿™äº›å—ç¿»è¯‘æˆæ‰‡åŒºåœ°å€ï¼Œç„¶åä»æ‰‡åŒºä¸­è¯»å–æ•°æ®ï¼Œå†é€šè¿‡ç¡¬ç›˜æ§åˆ¶å™¨å°†è¿™äº›æ‰‡åŒºæ•°æ®é‡ç»„å†™å…¥åˆ°å†…å­˜ä¸­å»</strong>ã€‚</p><p>æ­£å¦‚æ ‡é¢˜æ‰€ç¤ºï¼Œæœ¬æ–‡é‡ç‚¹æ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿè€Œä¸æ˜¯åœ¨ç£ç›˜ï¼Œæ‰€ä»¥<strong>åæ–‡å‡ºç°çš„blockå‡è¡¨ç¤ºçš„æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®å—</strong>è€Œä¸æ˜¯ç£ç›˜ç»´æŠ¤çš„é€»è¾‘å—ã€‚</p><p>æ–‡ä»¶ç³»ç»Ÿblockçš„å‡ºç°ä½¿å¾—åœ¨æ–‡ä»¶ç³»ç»Ÿå±‚é¢ä¸Šè¯»å†™æ€§èƒ½å¤§å¤§æé«˜ï¼Œä¹Ÿå¤§é‡å‡å°‘äº†ç¢ç‰‡ã€‚ä½†æ˜¯å®ƒçš„å‰¯ä½œç”¨æ˜¯å¯èƒ½é€ æˆç©ºé—´æµªè´¹ã€‚ç”±äºæ–‡ä»¶ç³»ç»Ÿä»¥blockä¸ºè¯»å†™å•å…ƒï¼Œå³ä½¿å­˜å‚¨çš„æ–‡ä»¶åªæœ‰1Kå¤§å°ä¹Ÿå°†å ç”¨ä¸€ä¸ªblockï¼Œå‰©ä½™çš„ç©ºé—´å®Œå…¨æ˜¯æµªè´¹çš„ã€‚</p><h4 id="1-2-inodeçš„å‡ºç°">1.2 inodeçš„å‡ºç°</h4><p>é—®é¢˜1ï¼šå¦‚æœä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå ç”¨å¤§é‡çš„blockè¯»å–æ—¶ä¼šå¦‚ä½•ï¼Ÿ</p><p>å‡å¦‚blockå¤§å°ä¸º1KBï¼Œä»…ä»…å­˜å‚¨ä¸€ä¸ª10Mçš„æ–‡ä»¶å°±éœ€è¦10240ä¸ªblockï¼Œè€Œä¸”è¿™äº›blockså¾ˆå¯èƒ½åœ¨ä½ç½®ä¸Šæ˜¯ä¸è¿ç»­åœ¨ä¸€èµ·çš„(ä¸ç›¸é‚»)ï¼Œè¯»å–è¯¥æ–‡ä»¶æ—¶éš¾é“è¦ä»å‰å‘åæ‰«ææ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å—ï¼Œç„¶åæ‰¾å‡ºå±äºè¯¥æ–‡ä»¶çš„å—å—?æ˜¾ç„¶æ˜¯ä¸åº”è¯¥è¿™ä¹ˆåšçš„ï¼Œå› ä¸ºå¤ªæ…¢å¤ªå‚»ç“œå¼äº†ã€‚</p><p>é—®é¢˜2ï¼šå¦‚æœä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå ç”¨å°‘é‡çš„blockè¯»å–æ—¶ä¼šå¦‚ä½•ï¼Ÿ</p><p>å‡è®¾è¯»å–ä¸€ä¸ªåªå ç”¨1ä¸ªblockçš„æ–‡ä»¶ï¼Œéš¾é“åªè¯»å–ä¸€ä¸ªblockå°±ç»“æŸäº†å—?å¹¶ä¸æ˜¯ï¼Œä»ç„¶æ˜¯æ‰«ææ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰blockï¼Œå› ä¸ºå®ƒä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰«æåˆ°ï¼Œæ‰«æåˆ°äº†å®ƒä¹Ÿä¸çŸ¥é“è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸æ˜¯å·²ç»å®Œæ•´è€Œä¸éœ€è¦å†æ‰«æå…¶ä»–çš„blockã€‚</p><p>é—®é¢˜3ï¼šæ–‡ä»¶åçš„å…ƒæ•°æ®å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p><p>â€¦</p><p>å¯¹äºç±»ä¼¼é—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯ä½¿ç”¨ç´¢å¼•ï¼Œå› ä¸ºé€šè¿‡æ‰«æç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„æ•°æ®ï¼Œè€Œä¸”ç´¢å¼•å¯ä»¥å­˜å‚¨éƒ¨åˆ†æ•°æ®ã€‚</p><p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šç´¢å¼•æŠ€æœ¯å…·ä½“åŒ–ä¸ºç´¢å¼•èŠ‚ç‚¹(index node)ï¼Œåœ¨ç´¢å¼•èŠ‚ç‚¹ä¸Šå­˜å‚¨çš„éƒ¨åˆ†æ•°æ®å³ä¸ºæ–‡ä»¶çš„å±æ€§å…ƒæ•°æ®åŠå…¶ä»–å°‘é‡ä¿¡æ¯ã€‚ä¸€èˆ¬æ¥è¯´ç´¢å¼•å ç”¨çš„ç©ºé—´ç›¸æ¯”å…¶ç´¢å¼•çš„æ–‡ä»¶æ•°æ®è€Œè¨€å ç”¨çš„ç©ºé—´å°±å°å¾—å¤šï¼Œæ‰«æå®ƒæ¯”æ‰«ææ•´ä¸ªæ•°æ®è¦å¿«å¾—å¤šï¼Œå¦åˆ™ç´¢å¼•å°±æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰ã€‚è¿™æ ·ä¸€æ¥å°±è§£å†³äº†å‰é¢æ‰€æœ‰çš„é—®é¢˜ã€‚</p><p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æœ¯è¯­ä¸­ï¼Œç´¢å¼•èŠ‚ç‚¹ç§°ä¸ºinodeã€‚åœ¨inodeä¸­å­˜å‚¨äº†inodeå·ã€æ–‡ä»¶ç±»å‹ã€æƒé™ã€æ–‡ä»¶æ‰€æœ‰è€…ã€å¤§å°ã€æ—¶é—´æˆ³ç­‰å…ƒæ•°æ®ä¿¡æ¯ï¼Œæœ€é‡è¦çš„æ˜¯è¿˜å­˜å‚¨äº†æŒ‡å‘å±äºè¯¥æ–‡ä»¶blockçš„æŒ‡é’ˆï¼Œè¿™æ ·<strong>è¯»å–inodeå°±å¯ä»¥æ‰¾åˆ°å±äºè¯¥æ–‡ä»¶çš„block</strong>ï¼Œè¿›è€Œè¯»å–è¿™äº›blockå¹¶è·å¾—è¯¥æ–‡ä»¶çš„æ•°æ®ã€‚ä¸ºäº†æ–¹ä¾¿ç§°å‘¼å’ŒåŒºåˆ†ï¼Œæš‚ä¸”å°†è¿™ä¸ªinodeè®°å½•ä¸­æŒ‡å‘æ–‡ä»¶data blockçš„æŒ‡é’ˆç§°ä¹‹ä¸ºblockæŒ‡é’ˆã€‚</p><p>ä»¥ä¸‹æ˜¯ext2æ–‡ä»¶ç³»ç»Ÿä¸­inodeåŒ…å«çš„ä¿¡æ¯ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Inode: 12 Type: regular Mode: 0644 Flags: 0x0 </span><br><span class="line">Generation: 1454951771 Version: 0x00000000:00000001 </span><br><span class="line">User: 0 Group: 0 Size: 5 </span><br><span class="line">File ACL: 0 Directory ACL: 0 </span><br><span class="line">Links: 1 Blockcount: 8 </span><br><span class="line">Fragment: Address: 0 Number: 0 Size: 0 </span><br><span class="line"> ctime: 0x5b628db2:15e0aff4 -- Thu Aug 2 12:50:58 2018 </span><br><span class="line"> atime: 0x5b628db2:15e0aff4 -- Thu Aug 2 12:50:58 2018 </span><br><span class="line"> mtime: 0x5b628db2:15e0aff4 -- Thu Aug 2 12:50:58 2018 </span><br><span class="line">crtime: 0x5b628db2:15e0aff4 -- Thu Aug 2 12:50:58 2018 </span><br><span class="line">Size of extra inode fields: 28 </span><br><span class="line">BLOCKS: </span><br><span class="line">(0):1024 </span><br><span class="line">TOTAL: 1 </span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬inodeå¤§å°ä¸º128å­—èŠ‚æˆ–256å­—èŠ‚ï¼Œç›¸æ¯”é‚£äº›MBæˆ–GBè®¡ç®—çš„æ–‡ä»¶æ•°æ®è€Œè¨€å°å¾—å¤šçš„å¤šï¼Œä½†ä¹Ÿè¦çŸ¥é“å¯èƒ½ä¸€ä¸ªæ–‡ä»¶å¤§å°å°äºinodeå¤§å°ï¼Œä¾‹å¦‚åªå ç”¨1ä¸ªå­—èŠ‚çš„æ–‡ä»¶ã€‚</p><h4 id="1-3-bmapå‡ºç°">1.3 bmapå‡ºç°</h4><p>åœ¨å‘ç¡¬ç›˜å­˜å‚¨æ•°æ®æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿéœ€è¦çŸ¥é“å“ªäº›å—æ˜¯ç©ºé—²çš„ï¼Œå“ªäº›å—æ˜¯å·²ç»å ç”¨äº†çš„ã€‚æœ€ç¬¨çš„æ–¹æ³•å½“ç„¶æ˜¯ä»å‰å‘åæ‰«æï¼Œé‡åˆ°ç©ºé—²å—å°±å­˜å‚¨ä¸€éƒ¨åˆ†ï¼Œç»§ç»­æ‰«æç›´åˆ°å­˜å‚¨å®Œæ‰€æœ‰æ•°æ®ã€‚</p><blockquote><p>è§£é‡Šï¼šç©ºé—²çš„å«ä¹‰</p></blockquote><p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œâ€œç©ºé—²å—â€ æŒ‡çš„æ˜¯å°šæœªè¢«ä»»ä½•æ–‡ä»¶æˆ–æ•°æ®å ç”¨çš„ç£ç›˜å—ã€‚æ–‡ä»¶ç³»ç»Ÿéœ€è¦ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨æˆ–è€…ä½å›¾æ¥è®°å½•å“ªäº›ç£ç›˜å—æ˜¯ç©ºé—²çš„ï¼Œä»¥åŠå“ªäº›ç£ç›˜å—å·²ç»è¢«æ–‡ä»¶æˆ–è€…æ•°æ®å ç”¨äº†ã€‚è¿™æ ·çš„ä¿¡æ¯å¯ä»¥å¸®åŠ©æ–‡ä»¶ç³»ç»Ÿæœ‰æ•ˆåœ°ç®¡ç†ç£ç›˜ç©ºé—´ï¼Œç¡®ä¿æ•°æ®çš„å­˜å‚¨å’Œæ£€ç´¢æ“ä½œèƒ½å¤Ÿæ­£å¸¸è¿›è¡Œã€‚</p><p>å½“æ–‡ä»¶ç³»ç»Ÿéœ€è¦ä¸ºæ–°æ–‡ä»¶æˆ–è€…æ•°æ®åˆ†é…å­˜å‚¨ç©ºé—´æ—¶ï¼Œå®ƒä¼šæŸ¥æ‰¾ç©ºé—²å—åˆ—è¡¨æˆ–è€…ä½å›¾ï¼Œæ‰¾åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªç©ºé—²çš„ç£ç›˜å—ï¼Œå¹¶å°†å®ƒä»¬æ ‡è®°ä¸ºå·²ç»è¢«å ç”¨ã€‚ç›¸åï¼Œå½“æ–‡ä»¶æˆ–è€…æ•°æ®è¢«åˆ é™¤æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šå°†å¯¹åº”çš„ç£ç›˜å—æ ‡è®°ä¸ºç©ºé—²ï¼Œä»¥ä¾¿åç»­è¢«é‡ç”¨ã€‚</p><p>é€šè¿‡ç»´æŠ¤ç©ºé—²å—åˆ—è¡¨æˆ–è€…ä½å›¾ï¼Œæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å®ç°å¯¹ç£ç›˜ç©ºé—´çš„åŠ¨æ€ç®¡ç†ï¼Œç¡®ä¿ç£ç›˜ç©ºé—´çš„é«˜æ•ˆåˆ©ç”¨ã€‚</p><hr><p>ä¼˜åŒ–çš„æ–¹æ³•å½“ç„¶ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ç´¢å¼•ï¼Œä½†æ˜¯ä»…ä»…1Gçš„æ–‡ä»¶ç³»ç»Ÿå°±æœ‰1KBçš„blockå…±1024*1024=1048576ä¸ªã€1G/1Kã€‘ï¼Œè¿™ä»…ä»…åªæ˜¯1Gï¼Œå¦‚æœæ˜¯100Gã€500Gç”šè‡³æ›´å¤§å‘¢ï¼Œä»…ä»…ä½¿ç”¨ç´¢å¼•ç´¢å¼•çš„æ•°é‡å’Œç©ºé—´å ç”¨ä¹Ÿå°†æå¤§ï¼Œè¿™æ—¶å°±å‡ºç°æ›´é«˜ä¸€çº§çš„ä¼˜åŒ–æ–¹æ³•ï¼šä½¿ç”¨å—ä½å›¾(bitmapç®€ç§°bmap)ã€‚</p><p>ä½å›¾åªä½¿ç”¨0å’Œ1æ ‡è¯†å¯¹åº”blockæ˜¯ç©ºé—²è¿˜æ˜¯è¢«å ç”¨ï¼Œ0å’Œ1åœ¨ä½å›¾ä¸­çš„ä½ç½®å’Œblockçš„ä½ç½®ä¸€ä¸€å¯¹åº”ï¼Œç¬¬ä¸€ä½æ ‡è¯†ç¬¬ä¸€ä¸ªå—ï¼Œç¬¬äºŒä¸ªä½æ ‡è¯†ç¬¬äºŒä¸ªå—ï¼Œä¾æ¬¡ä¸‹å»ç›´åˆ°æ ‡è®°å®Œæ‰€æœ‰çš„blockã€‚</p><p>æ€è€ƒï¼šä¸ºä»€ä¹ˆå—ä½å›¾æ›´ä¼˜åŒ–ï¼Ÿ</p><p>åœ¨ä½å›¾ä¸­1ä¸ªå­—èŠ‚8ä¸ªä½ï¼Œå¯ä»¥æ ‡è¯†8ä¸ªblockã€‚å¯¹äºä¸€ä¸ªblockå¤§å°ä¸º1KBã€å®¹é‡ä¸º1Gçš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€ï¼Œblockæ•°é‡æœ‰1024 * 1024ä¸ªï¼Œæ‰€ä»¥åœ¨ä½å›¾ä¸­ä½¿ç”¨1024 * 1024ä¸ªä½å…±1024 * 1024/8=131072å­—èŠ‚=128Kï¼Œå³1Gçš„æ–‡ä»¶åªéœ€è¦128ä¸ªblockåšä½å›¾å°±èƒ½å®Œæˆä¸€ä¸€å¯¹åº”ã€‚é€šè¿‡æ‰«æè¿™100å¤šä¸ªblockå°±èƒ½çŸ¥é“å“ªäº›blockæ˜¯ç©ºé—²çš„ï¼Œé€Ÿåº¦æé«˜äº†éå¸¸å¤šã€‚</p><p>ä½†æ˜¯è¦æ³¨æ„ï¼Œ<strong>bmapçš„ä¼˜åŒ–é’ˆå¯¹çš„æ˜¯å†™ä¼˜åŒ–</strong>ï¼Œå› ä¸ºåªæœ‰å†™æ‰éœ€è¦æ‰¾åˆ°ç©ºé—²blockå¹¶åˆ†é…ç©ºé—²blockã€‚å¯¹äºè¯»è€Œè¨€ï¼Œåªè¦é€šè¿‡inodeæ‰¾åˆ°äº†blockçš„ä½ç½®ï¼Œcpuå°±èƒ½è¿…é€Ÿè®¡ç®—å‡ºblockåœ¨ç‰©ç†ç£ç›˜ä¸Šçš„åœ°å€ï¼Œcpuçš„è®¡ç®—é€Ÿåº¦æ˜¯æå¿«çš„ï¼Œè®¡ç®—blockåœ°å€çš„æ—¶é—´å‡ ä¹å¯ä»¥å¿½ç•¥ï¼Œé‚£ä¹ˆè¯»é€Ÿåº¦åŸºæœ¬è®¤ä¸ºæ˜¯å—ç¡¬ç›˜æœ¬èº«æ€§èƒ½çš„å½±å“è€Œä¸æ–‡ä»¶ç³»ç»Ÿæ— å…³ã€‚å¤§å¤šæ•°ç¨å¤§ä¸€ç‚¹çš„æ–‡ä»¶å¯èƒ½éƒ½ä¼šå­˜å‚¨åœ¨ä¸è¿ç»­çš„blockä¸Šï¼Œè€Œä¸”ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´çš„æ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä¼šæœ‰ä¸å°‘ç¢ç‰‡ï¼Œè¿™æ—¶ç¡¬ç›˜çš„éšæœºè¯»å–æ€§èƒ½ç›´æ¥å†³å®šè¯»æ•°æ®çš„é€Ÿåº¦ï¼Œè¿™ä¹Ÿæ˜¯æœºæ¢°ç¡¬ç›˜é€Ÿåº¦ç›¸æ¯”å›ºæ€ç¡¬ç›˜æ…¢çš„å¤šçš„å¤šçš„åŸå› ä¹‹ä¸€ï¼Œè€Œä¸”å›ºæ€ç¡¬ç›˜çš„éšæœºè¯»å’Œè¿ç»­è¯»å–é€Ÿåº¦å‡ ä¹æ˜¯ä¸€è‡´çš„ï¼Œå¯¹å®ƒæ¥è¯´ï¼Œæ–‡ä»¶ç³»ç»Ÿç¢ç‰‡çš„å¤šå°‘å¹¶ä¸ä¼šå½±å“è¯»å–é€Ÿåº¦ã€‚</p><p>è™½ç„¶bmapå·²ç»æå¤§çš„ä¼˜åŒ–äº†æ‰«æï¼Œä½†æ˜¯ä»æœ‰å…¶ç“¶é¢ˆï¼šå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ˜¯100Gå‘¢?</p><p>100Gçš„æ–‡ä»¶ç³»ç»Ÿè¦ä½¿ç”¨128*100=12800ä¸ª1KBå¤§å°çš„blockï¼Œè¿™å°±å ç”¨äº†12.5Mçš„ç©ºé—´äº†ã€‚è¯•æƒ³å®Œå…¨æ‰«æ12800ä¸ªå¾ˆå¯èƒ½ä¸è¿ç»­çš„blockè¿™ä¹Ÿæ˜¯éœ€è¦å ç”¨ä¸€äº›æ—¶é—´çš„ï¼Œè™½ç„¶å¿«ä½†æ˜¯æ‰›ä¸ä½æ¯æ¬¡å­˜å‚¨æ–‡ä»¶éƒ½è¦æ‰«æå¸¦æ¥çš„å·¨å¤§å¼€é”€ã€‚</p><p>æ‰€ä»¥éœ€è¦å†æ¬¡ä¼˜åŒ–ï¼Œå¦‚ä½•ä¼˜åŒ–?ç®€è€Œè¨€ä¹‹å°±æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†å¼€å½¢æˆå—ç»„ï¼Œè‡³äºå—ç»„çš„ä»‹ç»æ”¾åœ¨åæ–‡ã€‚</p><h4 id="1-4-inodeè¡¨çš„å‡ºç°">1.4 inodeè¡¨çš„å‡ºç°</h4><p>å›é¡¾ä¸‹inodeç›¸å…³ä¿¡æ¯ï¼šinodeå­˜å‚¨äº†inodeå·ã€æ–‡ä»¶å±æ€§å…ƒæ•°æ®ã€æŒ‡å‘æ–‡ä»¶å ç”¨çš„blockçš„æŒ‡é’ˆ;<strong>æ¯ä¸€ä¸ªinodeå ç”¨128å­—èŠ‚æˆ–256å­—èŠ‚ã€‚</strong></p><p>ç°åœ¨åˆå‡ºç°é—®é¢˜äº†ï¼Œä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­å¯ä»¥è¯´æœ‰æ— æ•°å¤šä¸ªæ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶éƒ½å¯¹åº”ä¸€ä¸ªinodeï¼Œéš¾é“æ¯ä¸€ä¸ªä»…128å­—èŠ‚çš„inodeéƒ½è¦å•ç‹¬å ç”¨ä¸€ä¸ªblockè¿›è¡Œå­˜å‚¨å—?è¿™å¤ªæµªè´¹ç©ºé—´äº†ã€‚</p><p>æ‰€ä»¥æ›´ä¼˜çš„æ–¹æ³•æ˜¯å°†å¤šä¸ªinodeåˆå¹¶å­˜å‚¨åœ¨blockä¸­ï¼Œå¯¹äº128å­—èŠ‚çš„inodeï¼Œä¸€ä¸ªblockå­˜å‚¨8ã€1K/128Bã€‘ä¸ªinodeï¼Œå¯¹äº256å­—èŠ‚çš„inodeï¼Œä¸€ä¸ªblockå­˜å‚¨4ä¸ªinodeã€‚è¿™å°±ä½¿å¾—æ¯ä¸ªå­˜å‚¨inodeçš„å—éƒ½ä¸æµªè´¹ã€‚</p><p>åœ¨extæ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œå°†è¿™äº›ç‰©ç†ä¸Šå­˜å‚¨inodeçš„blockç»„åˆèµ·æ¥ï¼Œåœ¨é€»è¾‘ä¸Šå½¢æˆä¸€å¼ inodeè¡¨(inode table)æ¥è®°å½•æ‰€æœ‰çš„inodeã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯ä¸€ä¸ªå®¶åº­éƒ½è¦å‘æ´¾å‡ºæ‰€ç™»è®°æˆ·å£ä¿¡æ¯ï¼Œé€šè¿‡æˆ·å£æœ¬å¯ä»¥çŸ¥é“å®¶åº­ä½å€ï¼Œè€Œæ¯ä¸ªé•‡æˆ–è¡—é“çš„æ´¾å‡ºæ‰€å°†æœ¬é•‡æˆ–æœ¬è¡—é“çš„æ‰€æœ‰æˆ·å£æ•´åˆåœ¨ä¸€èµ·ï¼Œè¦æŸ¥æ‰¾æŸä¸€æˆ·åœ°å€æ—¶ï¼Œåœ¨æ´¾å‡ºæ‰€å°±èƒ½å¿«é€ŸæŸ¥æ‰¾åˆ°ã€‚inode tableå°±æ˜¯è¿™é‡Œçš„æ´¾å‡ºæ‰€ã€‚å®ƒçš„å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425201144640.png" alt=""></p><p>å®é™…ä¸Šï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºå®Œæˆåæ‰€æœ‰çš„inodeå·éƒ½å·²ç»åˆ†é…å¥½å¹¶è®°å½•åˆ°inode tableä¸­äº†ï¼Œåªä¸è¿‡è¢«ä½¿ç”¨çš„inodeå·æ‰€åœ¨çš„è¡Œè¿˜æœ‰æ–‡ä»¶å±æ€§çš„å…ƒæ•°æ®ä¿¡æ¯å’Œblockä½ç½®ä¿¡æ¯ï¼Œè€Œæœªè¢«ä½¿ç”¨çš„inodeå·åªæœ‰ä¸€ä¸ªinodeå·è€Œå·²è€Œæ²¡æœ‰å…¶ä»–ä¿¡æ¯è€Œå·²ã€‚</p><p>å†ç»†ç»†ä¸€æ€è€ƒï¼Œå°±èƒ½å‘ç°ä¸€ä¸ªå¤§çš„æ–‡ä»¶ç³»ç»Ÿä»å°†å ç”¨å¤§é‡çš„å—æ¥å­˜å‚¨inodeï¼Œæƒ³è¦æ‰¾åˆ°å…¶ä¸­çš„ä¸€ä¸ªinodeè®°å½•ä¹Ÿéœ€è¦ä¸å°çš„å¼€é”€ï¼Œå°½ç®¡å®ƒä»¬å·²ç»å½¢æˆäº†ä¸€å¼ é€»è¾‘ä¸Šçš„è¡¨ï¼Œä½†æ‰›ä¸ä½è¡¨å¤ªå¤§è®°å½•å¤ªå¤šã€‚é‚£ä¹ˆå¦‚ä½•å¿«é€Ÿæ‰¾åˆ°inodeï¼Œè¿™åŒæ ·æ˜¯éœ€è¦ä¼˜åŒ–çš„ï¼Œä¼˜åŒ–çš„æ–¹æ³•æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿçš„blockè¿›è¡Œåˆ†ç»„åˆ’åˆ†ï¼Œæ¯ä¸ªç»„ä¸­éƒ½å­˜æœ‰æœ¬ç»„inode tableèŒƒå›´ã€bmapç­‰ã€‚</p><h4 id="1-5-imapçš„å‡ºç°">1.5 imapçš„å‡ºç°</h4><p>å‰é¢è¯´bmapæ˜¯å—ä½å›¾ï¼Œç”¨äºæ ‡è¯†æ–‡ä»¶ç³»ç»Ÿä¸­å“ªäº›blockæ˜¯ç©ºé—²å“ªäº›blockæ˜¯å ç”¨çš„ã€‚</p><p>å¯¹äºinodeä¹Ÿä¸€æ ·ï¼Œåœ¨å­˜å‚¨æ–‡ä»¶(Linuxä¸­ä¸€åˆ‡çš†æ–‡ä»¶)æ—¶éœ€è¦ä¸ºå…¶åˆ†é…ä¸€ä¸ªinodeå·ã€‚ä½†æ˜¯åœ¨æ ¼å¼åŒ–åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿåæ‰€æœ‰çš„inodeå·éƒ½æ˜¯è¢«äº‹å…ˆè®¾å®šå¥½å­˜æ”¾åœ¨inode tableä¸­çš„ï¼Œå› æ­¤äº§ç”Ÿäº†é—®é¢˜ï¼šè¦ä¸ºæ–‡ä»¶åˆ†é…å“ªä¸€ä¸ªinodeå·å‘¢?åˆå¦‚ä½•çŸ¥é“æŸä¸€ä¸ªinodeå·æ˜¯å¦å·²ç»è¢«åˆ†é…äº†å‘¢?</p><p>æ—¢ç„¶æ˜¯&quot;æ˜¯å¦è¢«å ç”¨&quot;çš„é—®é¢˜ï¼Œä½¿ç”¨ä½å›¾æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œåƒbmapè®°å½•blockçš„å ç”¨æƒ…å†µä¸€æ ·ã€‚æ ‡è¯†inodeå·æ˜¯å¦è¢«åˆ†é…çš„ä½å›¾ç§°ä¸ºinodemapç®€ç§°ä¸ºimapã€‚è¿™æ—¶è¦ä¸ºä¸€ä¸ªæ–‡ä»¶åˆ†é…inodeå·åªéœ€æ‰«æimapå³å¯çŸ¥é“å“ªä¸€ä¸ªinodeå·æ˜¯ç©ºé—²çš„ã€‚</p><p>imapå­˜åœ¨ç€å’Œbmapå’Œinode tableä¸€æ ·éœ€è¦è§£å†³çš„é—®é¢˜ï¼šå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ¯”è¾ƒå¤§ï¼Œimapæœ¬èº«å°±ä¼šå¾ˆå¤§ï¼Œæ¯æ¬¡å­˜å‚¨æ–‡ä»¶éƒ½è¦è¿›è¡Œæ‰«æï¼Œä¼šå¯¼è‡´æ•ˆç‡ä¸å¤Ÿé«˜ã€‚åŒæ ·ï¼Œä¼˜åŒ–çš„æ–¹å¼æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿå ç”¨çš„blockåˆ’åˆ†æˆå—ç»„ï¼Œæ¯ä¸ªå—ç»„æœ‰è‡ªå·±çš„imapèŒƒå›´ã€‚</p><h4 id="1-6-å—ç»„çš„å‡ºç°">1.6 å—ç»„çš„å‡ºç°</h4><p>å‰é¢ä¸€ç›´æåˆ°çš„ä¼˜åŒ–æ–¹æ³•æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿå ç”¨çš„blockåˆ’åˆ†æˆå—ç»„(block group)ï¼Œè§£å†³bmapã€inode tableå’Œimapå¤ªå¤§çš„é—®é¢˜ã€‚</p><p>åœ¨ç‰©ç†å±‚é¢ä¸Šçš„åˆ’åˆ†æ˜¯å°†ç£ç›˜æŒ‰æŸ±é¢åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼Œå³å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚åœ¨é€»è¾‘å±‚é¢ä¸Šçš„åˆ’åˆ†æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†æˆå—ç»„ã€‚<strong>æ¯ä¸ªæ–‡ä»¶ç³»ç»ŸåŒ…å«å¤šä¸ªå—ç»„ï¼Œæ¯ä¸ªå—ç»„åŒ…å«å¤šä¸ªå…ƒæ•°æ®åŒºå’Œæ•°æ®åŒº</strong>ã€çœ‹ä¸‹èŠ‚çš„å›¾ã€‘ï¼š</p><ul><li>å…ƒæ•°æ®åŒºå°±æ˜¯å­˜å‚¨bmapã€inode tableã€imapç­‰çš„æ•°æ®;</li><li>æ•°æ®åŒºå°±æ˜¯å­˜å‚¨æ–‡ä»¶æ•°æ®çš„åŒºåŸŸã€‚</li></ul><p>æ³¨æ„å—ç»„æ˜¯é€»è¾‘å±‚é¢çš„æ¦‚å¿µï¼Œæ‰€ä»¥å¹¶ä¸ä¼šçœŸçš„åœ¨ç£ç›˜ä¸ŠæŒ‰æŸ±é¢ã€æŒ‰æ‰‡åŒºã€æŒ‰ç£é“ç­‰æ¦‚å¿µè¿›è¡Œåˆ’åˆ†ã€‚</p><h4 id="1-7-å—ç»„çš„åˆ’åˆ†">1.7 å—ç»„çš„åˆ’åˆ†</h4><p>å—ç»„åœ¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºå®Œæˆåå°±å·²ç»åˆ’åˆ†å®Œæˆäº†ï¼Œä¹Ÿå°±æ˜¯è¯´å…ƒæ•°æ®åŒºbmapã€inode tableå’Œimapç­‰ä¿¡æ¯å ç”¨çš„blockä»¥åŠæ•°æ®åŒºå ç”¨çš„blockéƒ½å·²ç»åˆ’åˆ†å¥½äº†ã€‚é‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿå¦‚ä½•çŸ¥é“ä¸€ä¸ªå—ç»„å…ƒæ•°æ®åŒºåŒ…å«å¤šå°‘ä¸ªblockï¼Œæ•°æ®åŒºåˆåŒ…å«å¤šå°‘blockå‘¢?</p><p>å®ƒåªéœ€ç¡®å®šä¸€ä¸ªæ•°æ®â€”â€”æ¯ä¸ªblockçš„å¤§å°ï¼Œå†æ ¹æ®bmapè‡³å¤šåªèƒ½å ç”¨ä¸€ä¸ªå®Œæ•´çš„blockçš„æ ‡å‡†å°±èƒ½è®¡ç®—å‡ºå—ç»„å¦‚ä½•åˆ’åˆ†ã€‚å¦‚æœæ–‡ä»¶ç³»ç»Ÿéå¸¸å°ï¼Œæ‰€æœ‰çš„bmapæ€»å…±éƒ½ä¸èƒ½å ç”¨å®Œä¸€ä¸ªblockï¼Œé‚£ä¹ˆä¹Ÿåªèƒ½ç©ºé—²bmapçš„blockäº†ã€‚</p><p>æ¯ä¸ªblockçš„å¤§å°åœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿæ—¶å¯ä»¥äººä¸ºæŒ‡å®šï¼Œä¸æŒ‡å®šä¹Ÿæœ‰é»˜è®¤å€¼ã€‚</p><p>å‡å¦‚ç°åœ¨blockçš„å¤§å°æ˜¯1KBï¼Œä¸€ä¸ªbmapå®Œæ•´å ç”¨ä¸€ä¸ªblockèƒ½æ ‡è¯†1024*8= 8192ä¸ªblock(å½“ç„¶è¿™8192ä¸ªblockæ˜¯æ•°æ®åŒºå’Œå…ƒæ•°æ®åŒºå…±8192ä¸ªï¼Œå› ä¸ºå…ƒæ•°æ®åŒºåˆ†é…çš„blockä¹Ÿéœ€è¦é€šè¿‡bmapæ¥æ ‡è¯†)ã€‚æ¯ä¸ªblockæ˜¯1Kï¼Œæ¯ä¸ªå—ç»„æ˜¯8192Kå³8Mï¼Œåˆ›å»º1Gçš„æ–‡ä»¶ç³»ç»Ÿéœ€è¦åˆ’åˆ†1024/8=128ä¸ªå—ç»„ï¼Œå¦‚æœæ˜¯1.1Gçš„æ–‡ä»¶ç³»ç»Ÿå‘¢?128+12.8=128+13=141ä¸ªå—ç»„ã€‚ã€ç»™å‡ºblockçš„å¤§å°ï¼Œå°±å¯ä»¥ä»æ–‡ä»¶å¤§å°è®¡ç®—å‡ºå¿«ç»„çš„ä¸ªæ•°ã€‘</p><p>æ¯ä¸ªç»„çš„blockæ•°ç›®æ˜¯åˆ’åˆ†å¥½äº†ï¼Œä½†æ˜¯æ¯ä¸ªç»„è®¾å®šå¤šå°‘ä¸ªinodeå·å‘¢?inode tableå ç”¨å¤šå°‘blockå‘¢?è¿™éœ€è¦ç”±ç³»ç»Ÿå†³å®šäº†ï¼Œå› ä¸ºæè¿°&quot;æ¯å¤šå°‘ä¸ªæ•°æ®åŒºçš„blockå°±ä¸ºå…¶åˆ†é…ä¸€ä¸ªinodeå·&quot;çš„æŒ‡æ ‡é»˜è®¤æ˜¯æˆ‘ä»¬ä¸çŸ¥é“çš„ï¼Œå½“ç„¶åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿæ—¶ä¹Ÿå¯ä»¥äººä¸ºæŒ‡å®šè¿™ä¸ªæŒ‡æ ‡æˆ–è€…ç™¾åˆ†æ¯”ä¾‹ã€‚è§åæ–‡&quot;inodeæ·±å…¥&quot;ã€‚</p><p>ä½¿ç”¨dumpe2fså¯ä»¥å°†extç±»çš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯å…¨éƒ¨æ˜¾ç¤ºå‡ºæ¥ï¼Œå½“ç„¶bmapæ˜¯æ¯ä¸ªå—ç»„å›ºå®šä¸€ä¸ªblockçš„ä¸ç”¨æ˜¾ç¤ºï¼Œimapæ¯”bmapæ›´å°æ‰€ä»¥ä¹Ÿåªå ç”¨1ä¸ªblockä¸ç”¨æ˜¾ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425215539679.png" alt="image-20240425215539679"></p><p>ä»è¿™å¼ è¡¨ä¸­èƒ½è®¡ç®—å‡ºæ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ï¼Œè¯¥æ–‡ä»¶ç³»ç»Ÿå…±4667136ä¸ªblocksï¼Œæ¯ä¸ªblockå¤§å°ä¸º4Kï¼Œæ‰€ä»¥æ–‡ä»¶ç³»ç»Ÿå¤§å°ä¸º4667136*4/1024/1024=17.8GBã€‚</p><p>ä¹Ÿèƒ½è®¡ç®—å‡ºåˆ†äº†å¤šå°‘ä¸ªå—ç»„ï¼Œå› ä¸ºæ¯ä¸€ä¸ªå—ç»„çš„blockæ•°é‡ä¸º32768ï¼Œæ‰€ä»¥å—ç»„çš„æ•°é‡ä¸º4667136/32768=142.4å³143ä¸ªå—ç»„ã€‚ç”±äºå—ç»„ä»0å¼€å§‹ç¼–å·ï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªå—ç»„ç¼–å·ä¸ºGroup 142ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºæ˜¯æœ€åä¸€ä¸ªå—ç»„çš„ä¿¡æ¯ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425215816389.png" alt="image-20240425215816389"></p><h3 id="2-æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´ç»“æ„">2. æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´ç»“æ„</h3><p>å°†ä¸Šæ–‡æè¿°çš„bmapã€inode tableã€imapã€æ•°æ®åŒºçš„blockså’Œå—ç»„çš„æ¦‚å¿µç»„åˆèµ·æ¥å°±å½¢æˆäº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå½“ç„¶è¿™è¿˜ä¸æ˜¯å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿã€‚å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿå¦‚ä¸‹å›¾</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425215902069.png" alt="image-20240425215902069"></p><p>é¦–å…ˆï¼Œè¯¥å›¾ä¸­å¤šäº†Boot Blockã€Super Blockã€GDTã€Reserver GDTè¿™å‡ ä¸ªæ¦‚å¿µã€‚ä¸‹é¢ä¼šåˆ†åˆ«ä»‹ç»å®ƒä»¬ã€‚</p><p>ç„¶åï¼Œå›¾ä¸­æŒ‡æ˜äº†å—ç»„ä¸­æ¯ä¸ªéƒ¨åˆ†å ç”¨çš„blockæ•°é‡ï¼Œé™¤äº†superblockã€bmapã€imapèƒ½ç¡®å®šå ç”¨1ä¸ªblockï¼Œå…¶ä»–çš„éƒ¨åˆ†éƒ½ä¸èƒ½ç¡®å®šå ç”¨å‡ ä¸ªblockã€‚</p><p>æœ€åï¼Œå›¾ä¸­æŒ‡æ˜äº†Superblockã€GDTå’ŒReserved GDTæ˜¯åŒæ—¶å‡ºç°ä¸”ä¸ä¸€å®šå­˜åœ¨äºæ¯ä¸€ä¸ªå—ç»„ä¸­çš„ï¼Œä¹ŸæŒ‡æ˜äº†bmapã€imapã€inode tableå’Œdata blocksæ˜¯æ¯ä¸ªå—ç»„éƒ½æœ‰çš„ã€‚</p><h4 id="2-1-å¼•å¯¼å—">2.1 å¼•å¯¼å—</h4><p>å³ä¸Šå›¾ä¸­çš„Boot Blockéƒ¨åˆ†ï¼Œä¹Ÿç§°ä¸ºboot sectorã€‚å®ƒä½äºåˆ†åŒºä¸Šçš„ç¬¬ä¸€ä¸ªå—ï¼Œå ç”¨1024å­—èŠ‚ï¼Œå¹¶éæ‰€æœ‰åˆ†åŒºéƒ½æœ‰è¿™ä¸ªboot sectorï¼Œåªæœ‰è£…äº†æ“ä½œç³»ç»Ÿçš„ä¸»åˆ†åŒºå’Œè£…äº†æ“ä½œç³»ç»Ÿçš„é€»è¾‘åˆ†åŒºæ‰æœ‰ã€‚é‡Œé¢å­˜æ”¾çš„ä¹Ÿæ˜¯boot loaderï¼Œè¿™æ®µboot loaderç§°ä¸ºVBR(ä¸»åˆ†åŒºè£…æ“ä½œç³»ç»Ÿæ—¶)æˆ–EBR(æ‰©å±•åˆ†åŒºè£…æ“ä½œç³»ç»Ÿæ—¶)ï¼Œè¿™é‡Œçš„Boot loaderå’Œmbrä¸Šçš„boot loaderæ˜¯å­˜åœ¨äº¤é”™å…³ç³»çš„ã€‚å¼€æœºå¯åŠ¨çš„æ—¶å€™ï¼Œé¦–å…ˆåŠ è½½mbrä¸­çš„bootloaderï¼Œç„¶åå®šä½åˆ°æ“ä½œç³»ç»Ÿæ‰€åœ¨åˆ†åŒºçš„boot serctorä¸ŠåŠ è½½æ­¤å¤„çš„boot loaderã€‚å¦‚æœæ˜¯å¤šç³»ç»Ÿï¼ŒåŠ è½½mbrä¸­çš„bootloaderåä¼šåˆ—å‡ºæ“ä½œç³»ç»Ÿèœå•ï¼Œèœå•ä¸Šçš„å„æ“ä½œç³»ç»ŸæŒ‡å‘å®ƒä»¬æ‰€åœ¨åˆ†åŒºçš„boot sectorä¸Šã€‚å®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425220833137.png" alt="image-20240425220833137"></p><p>ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼çš„æ“ä½œç³»ç»Ÿèœå•æ—©å·²ç»å¼ƒä¹‹ä¸ç”¨äº†ï¼Œè€Œæ˜¯ä½¿ç”¨grubæ¥ç®¡ç†å¯åŠ¨èœå•ã€‚å°½ç®¡å¦‚æ­¤ï¼Œåœ¨å®‰è£…æ“ä½œç³»ç»Ÿæ—¶ï¼Œä»ç„¶æœ‰ä¸€æ­¥æ˜¯é€‰æ‹©boot loaderå®‰è£…ä½ç½®çš„æ­¥éª¤ã€‚</p><h4 id="2-2-è¶…çº§å—-superblock">2.2 è¶…çº§å—(superblock)</h4><p>æ—¢ç„¶ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¼šåˆ†å¤šä¸ªå—ç»„ï¼Œ<strong>é‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿæ€ä¹ˆçŸ¥é“åˆ†äº†å¤šå°‘ä¸ªå—ç»„å‘¢?æ¯ä¸ªå—ç»„åˆæœ‰å¤šå°‘blockå¤šå°‘inodeå·ç­‰ç­‰ä¿¡æ¯å‘¢?è¿˜æœ‰ï¼Œæ–‡ä»¶ç³»ç»Ÿæœ¬èº«çš„å±æ€§ä¿¡æ¯å¦‚å„ç§æ—¶é—´æˆ³ã€blockæ€»æ•°é‡å’Œç©ºé—²æ•°é‡ã€inodeæ€»æ•°é‡å’Œç©ºé—²æ•°é‡ã€å½“å‰æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ­£å¸¸ã€ä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªæ£€ç­‰ç­‰ï¼Œå®ƒä»¬åˆå­˜å‚¨åœ¨å“ªé‡Œå‘¢?</strong></p><p>æ¯«æ— ç–‘é—®ï¼Œè¿™äº›ä¿¡æ¯å¿…é¡»è¦å­˜å‚¨åœ¨blockä¸­ã€‚å­˜å‚¨è¿™äº›ä¿¡æ¯å ç”¨1024å­—èŠ‚ï¼Œæ‰€ä»¥ä¹Ÿè¦ä¸€ä¸ªblockï¼Œ<strong>è¿™ä¸ªblockç§°ä¸ºè¶…çº§å—(superblock)</strong>ï¼Œå®ƒçš„blockå·å¯èƒ½ä¸º0ä¹Ÿå¯èƒ½ä¸º1ã€‚å¦‚æœblockå¤§å°ä¸º1Kï¼Œåˆ™å¼•å¯¼å—æ­£å¥½å ç”¨ä¸€ä¸ªblockï¼Œè¿™ä¸ªblockå·ä¸º0ï¼Œæ‰€ä»¥superblockçš„å·ä¸º1;å¦‚æœblockå¤§å°å¤§äº1Kï¼Œåˆ™å¼•å¯¼å—å’Œè¶…çº§å—åŒç½®åœ¨ä¸€ä¸ªblockä¸­ï¼Œè¿™ä¸ªblockå·ä¸º0ã€‚æ€»ä¹‹superblockçš„èµ·æ­¢ä½ç½®æ˜¯ç¬¬äºŒä¸ª1024(1024-2047)å­—èŠ‚ã€‚</p><p>ä½¿ç”¨dfå‘½ä»¤è¯»å–çš„å°±æ˜¯æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„superblockï¼Œæ‰€ä»¥å®ƒçš„ç»Ÿè®¡é€Ÿåº¦éå¸¸å¿«ã€‚ç›¸åï¼Œç”¨duå‘½ä»¤æŸ¥çœ‹ä¸€ä¸ªè¾ƒå¤§ç›®å½•çš„å·²ç”¨ç©ºé—´å°±éå¸¸æ…¢ï¼Œå› ä¸ºä¸å¯é¿å…åœ°è¦éå†æ•´ä¸ªç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -hT </span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">udev           devtmpfs  1.9G     0  1.9G   0% /dev</span><br><span class="line">tmpfs          tmpfs     388M  2.0M  386M   1% /run</span><br><span class="line">/dev/sda5      ext4       59G   43G   14G  77% /</span><br><span class="line">tmpfs          tmpfs     1.9G     0  1.9G   0% /dev/shm</span><br><span class="line">tmpfs          tmpfs     5.0M  4.0K  5.0M   1% /run/lock</span><br><span class="line">tmpfs          tmpfs     1.9G     0  1.9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/loop0     squashfs  128K  128K     0 100% /snap/bare/5</span><br><span class="line">/dev/loop2     squashfs   75M   75M     0 100% /snap/core22/1122</span><br><span class="line">/dev/loop1     squashfs   64M   64M     0 100% /snap/core20/2264</span><br></pre></td></tr></table></figure><p>superblockå¯¹äºæ–‡ä»¶ç³»ç»Ÿè€Œè¨€æ˜¯è‡³å…³é‡è¦çš„ï¼Œè¶…çº§å—ä¸¢å¤±æˆ–æŸåå¿…å°†å¯¼è‡´æ–‡ä»¶ç³»ç»Ÿçš„æŸåã€‚æ‰€ä»¥æ—§å¼çš„æ–‡ä»¶ç³»ç»Ÿå°†è¶…çº§å—å¤‡ä»½åˆ°æ¯ä¸€ä¸ªå—ç»„ä¸­ï¼Œä½†æ˜¯è¿™åˆæœ‰æ‰€ç©ºé—´æµªè´¹ï¼Œæ‰€ä»¥ext2æ–‡ä»¶ç³»ç»Ÿåªåœ¨å—ç»„0ã€1å’Œ3ã€5ã€7å¹‚æ¬¡æ–¹çš„å—ç»„ä¸­ä¿å­˜è¶…çº§å—çš„ä¿¡æ¯ï¼Œå¦‚Group9ã€Group25ç­‰ã€‚å°½ç®¡ä¿å­˜äº†è¿™ä¹ˆå¤šçš„superblockï¼Œä½†æ˜¯æ–‡ä»¶ç³»ç»Ÿåªä½¿ç”¨ç¬¬ä¸€ä¸ªå—ç»„å³Group0ä¸­è¶…çº§å—ä¿¡æ¯æ¥è·å–æ–‡ä»¶ç³»ç»Ÿå±æ€§ï¼Œåªæœ‰å½“Group0ä¸Šçš„superblockæŸåæˆ–ä¸¢å¤±æ‰ä¼šæ‰¾ä¸‹ä¸€ä¸ªå¤‡ä»½è¶…çº§å—å¤åˆ¶åˆ°Group0ä¸­æ¥æ¢å¤æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªext4æ–‡ä»¶ç³»ç»Ÿçš„superblockçš„ä¿¡æ¯ï¼Œextå®¶æ—çš„æ–‡ä»¶ç³»ç»Ÿéƒ½èƒ½ä½¿ç”¨dumpe2fs -hè·å–ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425221706736.png" alt="image-20240425221706736"></p><h4 id="2-3-å—ç»„æè¿°ç¬¦è¡¨-GDT">2.3 å—ç»„æè¿°ç¬¦è¡¨(GDT)</h4><p>æ—¢ç„¶æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†äº†å—ç»„ï¼Œé‚£ä¹ˆæ¯ä¸ªå—ç»„çš„ä¿¡æ¯å’Œå±æ€§å…ƒæ•°æ®åˆä¿å­˜åœ¨å“ªé‡Œå‘¢?</p><p><strong>extæ–‡ä»¶ç³»ç»Ÿæ¯ä¸€ä¸ªå—ç»„ä¿¡æ¯ä½¿ç”¨32å­—èŠ‚æè¿°ï¼Œè¿™32ä¸ªå­—èŠ‚ç§°ä¸ºå—ç»„æè¿°ç¬¦</strong>ï¼Œæ‰€æœ‰å—ç»„çš„å—ç»„æè¿°ç¬¦ç»„æˆå—ç»„æè¿°ç¬¦è¡¨GDT(group descriptor table)ã€‚</p><p>è™½ç„¶æ¯ä¸ªå—ç»„éƒ½éœ€è¦å—ç»„æè¿°ç¬¦æ¥è®°å½•å—ç»„çš„ä¿¡æ¯å’Œå±æ€§å…ƒæ•°æ®ï¼Œä½†æ˜¯ä¸æ˜¯æ¯ä¸ªå—ç»„ä¸­éƒ½å­˜æ”¾äº†å—ç»„æè¿°ç¬¦ã€‚<strong>extæ–‡ä»¶ç³»ç»Ÿçš„å­˜å‚¨æ–¹å¼æ˜¯ï¼šå°†å®ƒä»¬ç»„æˆä¸€ä¸ªGDTï¼Œå¹¶å°†è¯¥GDTå­˜æ”¾äºæŸäº›å—ç»„ä¸­ï¼Œå­˜æ”¾GDTçš„å—ç»„å’Œå­˜æ”¾superblockå’Œå¤‡ä»½superblockçš„å—ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬æ˜¯åŒæ—¶å‡ºç°åœ¨æŸä¸€ä¸ªå—ç»„ä¸­çš„ã€‚è¯»å–æ—¶ä¹Ÿæ€»æ˜¯è¯»å–Group0ä¸­çš„å—ç»„æè¿°ç¬¦è¡¨ä¿¡æ¯ã€‚</strong></p><p>å‡å¦‚blockå¤§å°ä¸º4KBçš„æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†äº†143ä¸ªå—ç»„ï¼Œæ¯ä¸ªå—ç»„æè¿°ç¬¦32å­—èŠ‚ï¼Œé‚£ä¹ˆGDTå°±éœ€è¦143*32=4576å­—èŠ‚å³ä¸¤ä¸ªblockæ¥å­˜æ”¾ã€‚è¿™ä¸¤ä¸ªGDT blockä¸­è®°å½•äº†æ‰€æœ‰å—ç»„çš„å—ç»„ä¿¡æ¯ï¼Œä¸”å­˜æ”¾GDTçš„å—ç»„ä¸­çš„GDTéƒ½æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚</p><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªå—ç»„æè¿°ç¬¦çš„ä¿¡æ¯(é€šè¿‡dumpe2fsè·å–)ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425222725852.png" alt="image-20240425222725852"></p><h4 id="2-4-Reserved-GDT">2.4 Reserved GDT</h4><p>ä¿ç•™GDTï¼šReserved GDT</p><p>ä¿ç•™GDTç”¨äºä»¥åæ‰©å®¹æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ï¼Œé˜²æ­¢æ‰©å®¹åå—ç»„å¤ªå¤šï¼Œä½¿å¾—å—ç»„æè¿°ç¬¦è¶…å‡ºå½“å‰å­˜å‚¨GDTçš„blocksã€‚ä¿ç•™GDTå’ŒGDTæ€»æ˜¯åŒæ—¶å‡ºç°ï¼Œå½“ç„¶ä¹Ÿå°±å’ŒsuperblockåŒæ—¶å‡ºç°äº†ã€‚</p><p>ä¾‹å¦‚å‰é¢143ä¸ªå—ç»„ä½¿ç”¨äº†2ä¸ªblockæ¥å­˜æ”¾GDTï¼Œä½†æ˜¯æ­¤æ—¶ç¬¬äºŒä¸ªblockè¿˜ç©ºä½™å¾ˆå¤šç©ºé—´ï¼Œå½“æ‰©å®¹åˆ°ä¸€å®šç¨‹åº¦æ—¶2ä¸ªblockå·²ç»æ— æ³•å†è®°å½•å—ç»„æè¿°ç¬¦äº†ï¼Œè¿™æ—¶å°±éœ€è¦åˆ†é…ä¸€ä¸ªæˆ–å¤šä¸ªReserved GDTçš„blockæ¥å­˜æ”¾è¶…å‡ºçš„å—ç»„æè¿°ç¬¦ã€‚</p><p>ç”±äºæ–°å¢åŠ äº†GDT blockï¼Œæ‰€ä»¥åº”è¯¥è®©æ¯ä¸€ä¸ªä¿å­˜GDTçš„å—ç»„éƒ½åŒæ—¶å¢åŠ è¿™ä¸€ä¸ªGDT blockï¼Œæ‰€ä»¥å°†ä¿ç•™GDTå’ŒGDTå­˜æ”¾åœ¨åŒä¸€ä¸ªå—ç»„ä¸­å¯ä»¥ç›´æ¥å°†ä¿ç•™GDTå˜æ¢ä¸ºGDTè€Œæ— éœ€ä½¿ç”¨ä½æ•ˆçš„å¤åˆ¶æ‰‹æ®µå¤‡ä»½åˆ°æ¯ä¸ªå­˜æ”¾GDTçš„å—ç»„ã€‚</p><p>åŒç†ï¼Œæ–°å¢åŠ äº†GDTéœ€è¦ä¿®æ”¹æ¯ä¸ªå—ç»„ä¸­superblockä¸­çš„æ–‡ä»¶ç³»ç»Ÿå±æ€§ï¼Œæ‰€ä»¥å°†superblockå’ŒReserved GDT/GDTæ”¾åœ¨ä¸€èµ·åˆèƒ½æå‡æ•ˆç‡ã€‚</p><h3 id="3-Data-Block">3.Data Block</h3><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425215902069.png" alt=""></p><p>å¦‚ä¸Šå›¾ï¼Œé™¤äº†Data Blockså…¶ä»–çš„éƒ¨åˆ†éƒ½è§£é‡Šè¿‡äº†ã€‚data blockæ˜¯ç›´æ¥å­˜å‚¨æ•°æ®çš„blockï¼Œä½†äº‹å®ä¸Šå¹¶éå¦‚æ­¤ç®€å•ã€‚</p><p>æ•°æ®æ‰€å ç”¨çš„blockç”±æ–‡ä»¶å¯¹åº”inodeè®°å½•ä¸­çš„blockæŒ‡é’ˆæ‰¾åˆ°ï¼Œä¸åŒçš„æ–‡ä»¶ç±»å‹ï¼Œæ•°æ®blockä¸­å­˜å‚¨çš„å†…å®¹æ˜¯ä¸ä¸€æ ·çš„ã€‚ä»¥ä¸‹æ˜¯Linuxä¸­ä¸åŒç±»å‹æ–‡ä»¶çš„å­˜å‚¨æ–¹å¼ã€‚</p><ul><li>å¯¹äºå¸¸è§„æ–‡ä»¶ï¼Œæ–‡ä»¶çš„æ•°æ®æ­£å¸¸å­˜å‚¨åœ¨æ•°æ®å—ä¸­ã€‚</li><li>å¯¹äºç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œä¸€çº§å­ç›®å½•çš„ç›®å½•åå­˜å‚¨åœ¨æ•°æ®å—ä¸­ã€‚</li><li>æ–‡ä»¶åä¸æ˜¯å­˜å‚¨åœ¨å…¶è‡ªèº«çš„inodeä¸­ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨å…¶æ‰€åœ¨ç›®å½•çš„data blockä¸­ã€‚</li><li>å¯¹äºç¬¦å·é“¾æ¥ï¼Œå¦‚æœç›®æ ‡è·¯å¾„åè¾ƒçŸ­åˆ™ç›´æ¥ä¿å­˜åœ¨inodeä¸­ä»¥ä¾¿æ›´å¿«åœ°æŸ¥æ‰¾ï¼Œå¦‚æœç›®æ ‡è·¯å¾„åè¾ƒé•¿åˆ™åˆ†é…ä¸€ä¸ªæ•°æ®å—æ¥ä¿å­˜ã€‚</li><li>è®¾å¤‡æ–‡ä»¶ã€FIFOå’Œsocketç­‰ç‰¹æ®Šæ–‡ä»¶æ²¡æœ‰æ•°æ®å—ï¼Œè®¾å¤‡æ–‡ä»¶çš„ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ä¿å­˜åœ¨inodeä¸­ã€‚</li></ul><h4 id="3-1-ç›®å½•æ–‡ä»¶çš„data-block">3.1 ç›®å½•æ–‡ä»¶çš„data block</h4><p>å¯¹äºç›®å½•æ–‡ä»¶ï¼Œå…¶inodeè®°å½•ä¸­å­˜å‚¨çš„æ˜¯ç›®å½•çš„inodeå·ã€ç›®å½•çš„å±æ€§å…ƒæ•°æ®å’Œç›®å½•æ–‡ä»¶çš„blockæŒ‡é’ˆï¼Œè¿™é‡Œé¢æ²¡æœ‰å­˜å‚¨ç›®å½•è‡ªèº«æ–‡ä»¶åçš„ä¿¡æ¯ã€‚</p><p>è€Œå…¶data blockçš„å­˜å‚¨æ–¹å¼åˆ™å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425223235705.png" alt="image-20240425223235705"></p><p>ç”±å›¾å¯çŸ¥ï¼Œåœ¨ç›®å½•æ–‡ä»¶çš„æ•°æ®å—ä¸­å­˜å‚¨äº†å…¶ä¸‹çš„æ–‡ä»¶åã€ç›®å½•åã€ç›®å½•æœ¬èº«çš„ç›¸å¯¹åç§°&quot;.â€œå’Œä¸Šçº§ç›®å½•çš„ç›¸å¯¹åç§°â€â€¦â€œï¼Œè¿˜å­˜å‚¨äº†æŒ‡å‘inode tableä¸­è¿™äº›æ–‡ä»¶åå¯¹åº”çš„inodeå·çš„æŒ‡é’ˆ(å¹¶éç›´æ¥å­˜å‚¨inodeå·ç )ã€ç›®å½•é¡¹é•¿åº¦rec_lenã€æ–‡ä»¶åé•¿åº¦name_lenå’Œæ–‡ä»¶ç±»å‹file_typeã€‚æ³¨æ„åˆ°é™¤äº†æ–‡ä»¶æœ¬èº«çš„inodeè®°å½•äº†æ–‡ä»¶ç±»å‹ï¼Œå…¶æ‰€åœ¨çš„ç›®å½•çš„æ•°æ®å—ä¹Ÿè®°å½•äº†æ–‡ä»¶ç±»å‹ã€‚ç”±äºrec_lenåªèƒ½æ˜¯4çš„å€æ•°ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨â€\0&quot;æ¥å¡«å……name_lenä¸å¤Ÿå‡‘æ»¡4å€æ•°çš„éƒ¨åˆ†ã€‚è‡³äºrec_lenå…·ä½“æ˜¯ä»€ä¹ˆï¼Œåªéœ€çŸ¥é“å®ƒæ˜¯ä¸€ç§åç§»å³å¯ã€‚</p><p>ç›®å½•çš„data blockä¸­å¹¶æ²¡æœ‰ç›´æ¥å­˜å‚¨ç›®å½•ä¸­æ–‡ä»¶çš„inodeå·ï¼Œå®ƒå­˜å‚¨çš„æ˜¯æŒ‡å‘inode tableä¸­å¯¹åº”æ–‡ä»¶inodeå·çš„æŒ‡é’ˆï¼Œæš‚ä¸”ç§°ä¹‹ä¸ºinodeæŒ‡é’ˆ(è‡³æ­¤ï¼Œå·²ç»çŸ¥é“äº†ä¸¤ç§æŒ‡é’ˆï¼šä¸€ç§æ˜¯inode tableä¸­æ¯ä¸ªinodeè®°å½•æŒ‡å‘å…¶å¯¹åº”data blockçš„blockæŒ‡é’ˆï¼Œä¸€ä¸ªæ­¤å¤„çš„inodeæŒ‡é’ˆã€‚é¢˜å¤–è¯ï¼šå®é™…ä¸ŠinodeæŒ‡é’ˆåº”è¯¥ç§°ä¹‹ä¸ºå­˜å‚¨åœ¨ç›®å½•data blcokä¸­çš„é“¾æ¥linkï¼Œè¿™ä¸ªlinkå’Œinode numä¸€ä¸€æ˜ å°„ï¼Œæ‰€ä»¥åˆ é™¤æ–‡ä»¶çš„å‡½æ•°ç§°ä¸ºunlink()ï¼Œè¡¨ç¤ºåœ¨ç›®å½•çš„data blockä¸­åˆ é™¤è¿™ä¸ªé“¾æ¥)ã€‚ä¸€ä¸ªå¾ˆæœ‰è¯´æœåŠ›çš„ä¾‹å­ï¼Œåœ¨ç›®å½•åªæœ‰è¯»è€Œæ²¡æœ‰æ‰§è¡Œæƒé™çš„æ—¶å€™ï¼Œä½¿ç”¨&quot;ls -l&quot;æ˜¯æ— æ³•è·å–åˆ°å…¶å†…æ–‡ä»¶inodeå·çš„ï¼Œè¿™å°±è¡¨æ˜æ²¡æœ‰ç›´æ¥å­˜å‚¨inodeå·ã€‚å®é™…ä¸Šï¼Œå› ä¸ºåœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œinodeå·å°±å·²ç»å…¨éƒ¨åˆ’åˆ†å¥½å¹¶åœ¨æ¯ä¸ªå—ç»„çš„inode tableä¸­å­˜æ”¾å¥½ï¼Œinode tableåœ¨å—ç»„ä¸­æ˜¯æœ‰å…·ä½“ä½ç½®çš„ï¼Œå¦‚æœä½¿ç”¨dumpe2fsæŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿï¼Œä¼šå‘ç°æ¯ä¸ªå—ç»„çš„inode tableå ç”¨çš„blockæ•°é‡æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå¦‚ä¸‹å›¾æ˜¯æŸåˆ†åŒºä¸Šå…¶ä¸­ä¸¤ä¸ªå—ç»„çš„ä¿¡æ¯ï¼Œå®ƒä»¬éƒ½å ç”¨249ä¸ªblockã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425223747136.png" alt="image-20240425223747136"></p><p>é™¤äº†inodeæŒ‡é’ˆï¼Œç›®å½•çš„data blockä¸­è¿˜ä½¿ç”¨æ•°å­—æ ¼å¼è®°å½•äº†æ–‡ä»¶ç±»å‹ï¼Œæ•°å­—æ ¼å¼å’Œæ–‡ä»¶ç±»å‹çš„å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425223811142.png" alt="image-20240425223811142"></p><p>æ³¨æ„åˆ°ç›®å½•çš„data blockä¸­å‰ä¸¤è¡Œå­˜å‚¨çš„æ˜¯ç›®å½•æœ¬èº«çš„ç›¸å¯¹åç§°&quot;.â€œå’Œä¸Šçº§ç›®å½•çš„ç›¸å¯¹åç§°â€â€¦&quot;ï¼Œå®ƒä»¬å®é™…ä¸Šæ˜¯ç›®å½•æœ¬èº«çš„ç¡¬é“¾æ¥å’Œä¸Šçº§ç›®å½•çš„ç¡¬é“¾æ¥ã€‚ç¡¬é“¾æ¥çš„æœ¬è´¨åé¢è¯´æ˜ã€‚</p><p>ç”±æ­¤ä¹Ÿå°±å®¹æ˜“ç†è§£ç›®å½•æƒé™çš„ç‰¹æ®Šä¹‹å¤„äº†ã€‚ç›®å½•æ–‡ä»¶çš„è¯»æƒé™Â®å’Œå†™æƒé™(w)ï¼Œéƒ½æ˜¯é’ˆå¯¹ç›®å½•æ–‡ä»¶çš„æ•°æ®å—æœ¬èº«ã€‚ç”±äºç›®å½•æ–‡ä»¶å†…åªæœ‰æ–‡ä»¶åã€æ–‡ä»¶ç±»å‹å’ŒinodeæŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœåªæœ‰è¯»æƒé™ï¼Œåªèƒ½è·å–æ–‡ä»¶åå’Œæ–‡ä»¶ç±»å‹ä¿¡æ¯ï¼Œæ— æ³•è·å–å…¶ä»–ä¿¡æ¯ï¼Œå°½ç®¡ç›®å½•çš„data blockä¸­ä¹Ÿè®°å½•ç€æ–‡ä»¶çš„inodeæŒ‡é’ˆï¼Œä½†å®šä½æŒ‡é’ˆæ˜¯éœ€è¦xæƒé™çš„ï¼Œå› ä¸ºå…¶å®ƒä¿¡æ¯éƒ½å‚¨å­˜åœ¨æ–‡ä»¶è‡ªèº«å¯¹åº”çš„inodeä¸­ï¼Œè€Œè¦è¯»å–æ–‡ä»¶inodeä¿¡æ¯éœ€è¦æœ‰ç›®å½•æ–‡ä»¶çš„æ‰§è¡Œæƒé™é€šè¿‡inodeæŒ‡é’ˆå®šä½åˆ°æ–‡ä»¶å¯¹åº”çš„inodeè®°å½•ä¸Šã€‚ä»¥ä¸‹æ˜¯æ²¡æœ‰ç›®å½•xæƒé™æ—¶çš„æŸ¥è¯¢çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°é™¤äº†æ–‡ä»¶åå’Œæ–‡ä»¶ç±»å‹ï¼Œå…¶ä½™çš„å…¨æ˜¯&quot;?&quot;ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[lisi4@xuexi tmp]$ ll -i d </span><br><span class="line"><span class="built_in">ls</span>: cannot access d/hehe: Permission denied </span><br><span class="line"><span class="built_in">ls</span>: cannot access d/haha: Permission denied </span><br><span class="line">total 0 </span><br><span class="line">? d????????? ? ? ? ? ? haha </span><br><span class="line">? -????????? ? ? ? ? ? hehe </span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œxfsæ–‡ä»¶ç³»ç»Ÿå’Œextæ–‡ä»¶ç³»ç»Ÿä¸ä¸€æ ·ï¼Œå®ƒè¿æ–‡ä»¶ç±»å‹éƒ½æ— æ³•è·å–ã€‚</p><h4 id="3-2-ç¬¦å·é“¾æ¥å­˜å‚¨æ–¹å¼">3.2 ç¬¦å·é“¾æ¥å­˜å‚¨æ–¹å¼</h4><p>ç¬¦å·é“¾æ¥å³ä¸ºè½¯é“¾æ¥ï¼Œç±»ä¼¼äºWindowsæ“ä½œç³»ç»Ÿä¸­çš„å¿«æ·æ–¹å¼ï¼Œå®ƒçš„ä½œç”¨æ˜¯æŒ‡å‘åŸæ–‡ä»¶æˆ–ç›®å½•ã€‚</p><p>è½¯é“¾æ¥ä¹‹æ‰€ä»¥ä¹Ÿè¢«ç§°ä¸ºç‰¹æ®Šæ–‡ä»¶çš„åŸå› æ˜¯ï¼šå®ƒä¸€èˆ¬æƒ…å†µä¸‹ä¸å ç”¨data blockï¼Œä»…ä»…é€šè¿‡å®ƒå¯¹åº”çš„inodeè®°å½•å°±èƒ½å°†å…¶ä¿¡æ¯æè¿°å®Œæˆ;ç¬¦å·é“¾æ¥çš„å¤§å°æ˜¯å…¶æŒ‡å‘ç›®æ ‡è·¯å¾„å ç”¨çš„å­—ç¬¦ä¸ªæ•°ï¼Œä¾‹å¦‚æŸä¸ªç¬¦å·é“¾æ¥çš„æŒ‡å‘æ–¹å¼ä¸º&quot;rmt --&gt; â€¦/sbin/rmt&quot;ï¼Œåˆ™å…¶æ–‡ä»¶å¤§å°ä¸º11å­—èŠ‚;åªæœ‰å½“ç¬¦å·é“¾æ¥æŒ‡å‘çš„ç›®æ ‡çš„è·¯å¾„åè¾ƒé•¿(60ä¸ªå­—èŠ‚)æ—¶æ–‡ä»¶ç³»ç»Ÿæ‰ä¼šåˆ’åˆ†ä¸€ä¸ªdata blockç»™å®ƒ;å®ƒçš„æƒé™å¦‚ä½•ä¹Ÿä¸é‡è¦ï¼Œå› å®ƒåªæ˜¯ä¸€ä¸ªæŒ‡å‘åŸæ–‡ä»¶çš„&quot;å·¥å…·&quot;ï¼Œæœ€ç»ˆå†³å®šæ˜¯å¦èƒ½è¯»å†™æ‰§è¡Œçš„æƒé™ç”±åŸæ–‡ä»¶å†³å®šï¼Œæ‰€ä»¥å¾ˆå¯èƒ½ls -læŸ¥çœ‹åˆ°çš„ç¬¦å·é“¾æ¥æƒé™ä¸º777ã€‚</p><p>æ³¨æ„ï¼Œè½¯é“¾æ¥çš„blockæŒ‡é’ˆå­˜å‚¨çš„æ˜¯ç›®æ ‡æ–‡ä»¶åã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé“¾æ¥æ–‡ä»¶çš„ä¸€åˆ‡éƒ½ä¾èµ–äºå…¶ç›®æ ‡æ–‡ä»¶åã€‚è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ/mntçš„è½¯é“¾æ¥/tmp/mntåœ¨/mntæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿåï¼Œé€šè¿‡è½¯é“¾æ¥å°±èƒ½è¿›å…¥/mntæ‰€æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿã€‚ç©¶å…¶åŸå› ï¼Œè¿˜æ˜¯å› ä¸ºå…¶ç›®æ ‡æ–‡ä»¶å&quot;/mnt&quot;å¹¶æ²¡æœ‰æ”¹å˜ã€‚</p><p>ä¾‹å¦‚ä»¥ä¸‹ç­›é€‰å‡ºäº†/etc/ä¸‹çš„ç¬¦å·é“¾æ¥ï¼Œæ³¨æ„è§‚å¯Ÿå®ƒä»¬çš„æƒé™å’Œå®ƒä»¬å ç”¨çš„ç©ºé—´å¤§å°ã€‚</p><h4 id="3-3-è®¾å¤‡æ–‡ä»¶ã€FIFOã€å¥—æ¥å­—æ–‡ä»¶">3.3 è®¾å¤‡æ–‡ä»¶ã€FIFOã€å¥—æ¥å­—æ–‡ä»¶</h4><p>å…³äºè¿™3ç§æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶åªéœ€è¦é€šè¿‡inodeå°±èƒ½å®Œå…¨ä¿å­˜å®ƒä»¬çš„ä¿¡æ¯ï¼Œå®ƒä»¬ä¸å ç”¨ä»»ä½•æ•°æ®å—ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯ç‰¹æ®Šæ–‡ä»¶ã€‚</p><p>è®¾å¤‡æ–‡ä»¶çš„ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ä¹Ÿä¿å­˜åœ¨inodeä¸­ã€‚ä»¥ä¸‹æ˜¯/dev/ä¸‹çš„éƒ¨åˆ†è®¾å¤‡ä¿¡æ¯ã€‚æ³¨æ„åˆ°å®ƒä»¬çš„ç¬¬5åˆ—å’Œç¬¬6åˆ—ä¿¡æ¯ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ï¼Œä¸»è®¾å¤‡å·æ ‡è¯†æ¯ä¸€ç§è®¾å¤‡çš„ç±»å‹ï¼Œæ¬¡è®¾å¤‡å·æ ‡è¯†åŒç§è®¾å¤‡ç±»å‹çš„ä¸åŒç¼–å·;ä¹Ÿæ³¨æ„åˆ°è¿™äº›ä¿¡æ¯ä¸­æ²¡æœ‰å¤§å°çš„ä¿¡æ¯ï¼Œå› ä¸ºè®¾å¤‡æ–‡ä»¶ä¸å ç”¨æ•°æ®å—æ‰€ä»¥æ²¡æœ‰å¤§å°çš„æ¦‚å¿µã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi ~]<span class="comment"># ll /dev | tail </span></span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 129 Oct 7 21:26 vcsa1 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 130 Oct 7 21:27 vcsa2 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 131 Oct 7 21:27 vcsa3 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 132 Oct 7 21:27 vcsa4 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 133 Oct 7 21:27 vcsa5 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 134 Oct 7 21:27 vcsa6 </span><br><span class="line">crw-rw---- 1 root root 10, 63 Oct 7 21:26 vga_arbiter </span><br><span class="line">crw------- 1 root root 10, 57 Oct 7 21:26 vmci </span><br><span class="line">crw-rw-rw- 1 root root 10, 56 Oct 7 21:27 vsock </span><br><span class="line">crw-rw-rw- 1 root root 1, 5 Oct 7 21:26 zero </span><br></pre></td></tr></table></figure><h3 id="4-inodeåŸºç¡€çŸ¥è¯†">4.inodeåŸºç¡€çŸ¥è¯†</h3><p>æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªinodeï¼Œåœ¨å°†inodeå…³è”åˆ°æ–‡ä»¶åç³»ç»Ÿå°†é€šè¿‡inodeå·æ¥è¯†åˆ«æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ–‡ä»¶åã€‚å¹¶ä¸”è®¿é—®æ–‡ä»¶æ—¶å°†å…ˆæ‰¾åˆ°inodeï¼Œé€šè¿‡inodeä¸­è®°å½•çš„blockä½ç½®æ‰¾åˆ°è¯¥æ–‡ä»¶ã€‚</p><p>Qï¼šä¸ºä»€ä¹ˆè¦è¦é“¾æ¥ï¼Ÿ</p><p>Aï¼šä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è®¿é—®æ–‡ä»¶ï¼Œå¯ä»¥å°†ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•ä¸å¦ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•å»ºç«‹å…³è”ï¼Œä»è€Œå®ç°å¤šä¸ªè·¯å¾„æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„æ•ˆæœã€‚</p><p>Qï¼šä¸ºä»€ä¹ˆéœ€è¦ç¡¬å’Œè½¯ä¸¤ç§é“¾æ¥å‘¢ï¼Ÿ</p><p>Aï¼š</p><ul><li><strong>ç¡¬é“¾æ¥</strong>æ˜¯æŒ‡åœ¨<strong>åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­</strong>ï¼Œå°†ä¸€ä¸ªæ–‡ä»¶åå…³è”åˆ°ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶ä¸Šï¼Œä½¿å¾—è¯¥æ–‡ä»¶åä¹Ÿå¯ä»¥è®¿é—®è¯¥æ–‡ä»¶ã€‚</li><li><strong>è½¯é“¾æ¥</strong>ï¼ˆä¹Ÿç§°ç¬¦å·é“¾æ¥ï¼‰æ˜¯æŒ‡åœ¨<strong>ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¹‹é—´</strong>ï¼Œå°†ä¸€ä¸ªæ–‡ä»¶åå…³è”åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸Šï¼Œä½¿å¾—è¯¥æ–‡ä»¶åä¹Ÿå¯ä»¥è®¿é—®è¯¥æ–‡ä»¶ã€‚</li></ul><h4 id="4-1-ç¡¬é“¾æ¥">4.1 ç¡¬é“¾æ¥</h4><p><strong>æœ¬è´¨ï¼šç¡¬é“¾æ¥å°±æ˜¯å¤šä¸ªæ–‡ä»¶åæŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®å—ã€‚</strong></p><p>è™½ç„¶æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªinodeï¼Œä½†æ˜¯å­˜åœ¨ä¸€ç§å¯èƒ½ï¼šå¤šä¸ªæ–‡ä»¶çš„inodeç›¸åŒï¼Œä¹Ÿå°±å³inodeå·ã€å…ƒæ•°æ®ã€blockä½ç½®éƒ½ç›¸åŒï¼Œè¿™æ˜¯ä¸€ç§ä»€ä¹ˆæ ·çš„æƒ…å†µå‘¢?</p><p>èƒ½å¤Ÿæƒ³è±¡è¿™äº›inodeç›¸åŒçš„æ–‡ä»¶ä½¿ç”¨çš„éƒ½æ˜¯åŒä¸€æ¡inodeè®°å½•ï¼Œæ‰€ä»¥ä»£è¡¨çš„éƒ½æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„data blockä¸­çš„inodeæŒ‡é’ˆç›®çš„åœ°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å„æŒ‡é’ˆå¯¹åº”çš„æ–‡ä»¶åäº’ä¸ç›¸åŒè€Œå·²ã€‚è¿™ç§inodeç›¸åŒçš„æ–‡ä»¶åœ¨Linuxä¸­è¢«ç§°ä¸º&quot;ç¡¬é“¾æ¥&quot;ã€‚</p><p>ç¡¬é“¾æ¥æ–‡ä»¶çš„inodeéƒ½ç›¸åŒï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª&quot;ç¡¬é“¾æ¥æ•°&quot;çš„å±æ€§ï¼Œä½¿ç”¨ls -lçš„ç¬¬äºŒåˆ—å°±æ˜¯è¢«ç¡¬é“¾æ¥æ•°ï¼Œå®ƒè¡¨ç¤ºçš„å°±æ˜¯è¯¥æ–‡ä»¶æœ‰å‡ ä¸ªç¡¬é“¾æ¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">penge@penge-virtual-machine  ~/Desktop/MordenCpp/tmp1  <span class="built_in">ls</span> -l</span><br><span class="line">total 40</span><br><span class="line">-rwxrwxr-x 1 penge penge 18264 4æœˆ  17 13:32 a.out</span><br><span class="line">-rw-rw-r-- 1 penge penge   196 4æœˆ  25 17:11 example.c</span><br><span class="line">-rw-rw-r-- 1 penge penge  4240 4æœˆ  17 13:31 example.o</span><br><span class="line">-rw-rw-r-- 1 penge penge    56 4æœˆ  17 13:31 external.c</span><br><span class="line">-rw-rw-r-- 1 penge penge  2952 4æœˆ  17 13:32 external.o</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">ls</span> -i file1</span><br><span class="line">1055165 file1</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">ls</span> -i file2</span><br><span class="line">1055165 file2</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ä¸‹å›¾æè¿°çš„æ˜¯dir1ç›®å½•ä¸­çš„æ–‡ä»¶name1åŠå…¶ç¡¬é“¾æ¥dir2/name2ï¼Œå³è¾¹åˆ†åˆ«æ˜¯å®ƒä»¬çš„inodeå’Œdatablockã€‚è¿™é‡Œä¹Ÿçœ‹å‡ºäº†ç¡¬é“¾æ¥æ–‡ä»¶ä¹‹é—´å”¯ä¸€ä¸åŒçš„å°±æ˜¯å…¶æ‰€åœ¨ç›®å½•ä¸­çš„è®°å½•ä¸åŒã€‚æ³¨æ„ä¸‹å›¾ä¸­æœ‰ä¸€åˆ—Link Countå°±æ˜¯æ ‡è®°ç¡¬é“¾æ¥æ•°çš„å±æ€§ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426105519520.png" alt="image-20240426105519520"></p><p>æ¯åˆ›å»ºä¸€ä¸ªæ–‡ä»¶çš„ç¡¬é“¾æ¥ï¼Œå®è´¨ä¸Šæ˜¯å¤šä¸€ä¸ªæŒ‡å‘è¯¥inodeè®°å½•çš„inodeæŒ‡é’ˆï¼Œå¹¶ä¸”ç¡¬é“¾æ¥æ•°åŠ 1ã€‚</p><p>åˆ é™¤æ–‡ä»¶çš„å®è´¨æ˜¯åˆ é™¤è¯¥æ–‡ä»¶æ‰€åœ¨ç›®å½•data blockä¸­çš„å¯¹åº”çš„inodeæŒ‡é’ˆï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å‡å°‘ç¡¬é“¾æ¥æ¬¡æ•°ï¼Œç”±äºblockæŒ‡é’ˆæ˜¯å­˜å‚¨åœ¨inodeä¸­çš„ï¼Œæ‰€ä»¥ä¸æ˜¯çœŸçš„åˆ é™¤æ•°æ®ï¼Œå¦‚æœä»æœ‰å…¶ä»–æŒ‡é’ˆæŒ‡å‘è¯¥inodeï¼Œé‚£ä¹ˆè¯¥æ–‡ä»¶çš„blockæŒ‡é’ˆä»ç„¶æ˜¯å¯ç”¨çš„ã€‚å½“ç¡¬é“¾æ¥æ¬¡æ•°ä¸º1æ—¶å†åˆ é™¤æ–‡ä»¶å°±æ˜¯çœŸçš„åˆ é™¤æ–‡ä»¶äº†ï¼Œæ­¤æ—¶inodeè®°å½•ä¸­blockæŒ‡é’ˆä¹Ÿå°†è¢«åˆ é™¤ã€‚</p><p>ä¸èƒ½è·¨åˆ†åŒºåˆ›å»ºç¡¬é“¾æ¥ï¼Œå› ä¸ºä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„inodeå·å¯èƒ½ä¼šç›¸åŒï¼Œå¦‚æœå…è®¸åˆ›å»ºç¡¬é“¾æ¥ï¼Œå¤åˆ¶åˆ°å¦ä¸€ä¸ªåˆ†åŒºæ—¶inodeå¯èƒ½ä¼šå’Œæ­¤åˆ†åŒºå·²ä½¿ç”¨çš„inodeå·å†²çªã€‚</p><p>ç¡¬é“¾æ¥åªèƒ½å¯¹æ–‡ä»¶åˆ›å»ºï¼Œæ— æ³•å¯¹ç›®å½•åˆ›å»ºç¡¬é“¾æ¥ã€‚ã€è¿™é‡Œæˆ‘çš„ç†è§£æ˜¯å¯èƒ½ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨çš„æƒ…å†µã€‘ä¹‹æ‰€ä»¥æ— æ³•å¯¹ç›®å½•åˆ›å»ºç¡¬é“¾æ¥ï¼Œæ˜¯å› ä¸ºæ–‡ä»¶ç³»ç»Ÿå·²ç»æŠŠæ¯ä¸ªç›®å½•çš„ç¡¬é“¾æ¥åˆ›å»ºå¥½äº†ï¼Œå®ƒä»¬å°±æ˜¯ç›¸å¯¹è·¯å¾„ä¸­çš„&quot;.â€œå’Œâ€â€¦&quot;ï¼Œåˆ†åˆ«æ ‡è¯†å½“å‰ç›®å½•çš„ç¡¬é“¾æ¥å’Œä¸Šçº§ç›®å½•çš„ç¡¬é“¾æ¥ã€‚æ¯ä¸€ä¸ªç›®å½•ä¸­éƒ½ä¼šåŒ…å«è¿™ä¸¤ä¸ªç¡¬é“¾æ¥ï¼Œå®ƒåŒ…å«äº†ä¸¤ä¸ªä¿¡æ¯ï¼š</p><p>(1) ä¸€ä¸ªæ²¡æœ‰å­ç›®å½•çš„ç›®å½•æ–‡ä»¶çš„ç¡¬é“¾æ¥æ•°æ˜¯2ï¼Œå…¶ä¸€æ˜¯ç›®å½•æœ¬èº«ï¼Œå³è¯¥ç›®å½•datablockä¸­çš„&quot;.&quot;ï¼Œå…¶äºŒæ˜¯å…¶çˆ¶ç›®å½•datablockä¸­è¯¥ç›®å½•çš„è®°å½•ï¼Œè¿™ä¸¤è€…éƒ½æŒ‡å‘åŒä¸€ä¸ªinodeå·;</p><p>(2) ä¸€ä¸ªåŒ…å«å­ç›®å½•çš„ç›®å½•æ–‡ä»¶ï¼Œå…¶ç¡¬é“¾æ¥æ•°æ˜¯2+å­ç›®å½•æ•°ï¼Œå› ä¸ºæ¯ä¸ªå­ç›®å½•éƒ½å…³è”ä¸€ä¸ªçˆ¶ç›®å½•çš„ç¡¬é“¾æ¥&quot;â€¦â€œã€‚å¾ˆå¤šäººåœ¨è®¡ç®—ç›®å½•çš„ç¡¬é“¾æ¥æ•°æ—¶è®¤ä¸ºç”±äºåŒ…å«äº†â€.â€œå’Œâ€â€¦â€œï¼Œæ‰€ä»¥ç©ºç›®å½•çš„ç¡¬é“¾æ¥æ•°æ˜¯2ï¼Œè¿™æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºâ€â€¦â€œä¸æ˜¯æœ¬ç›®å½•çš„ç¡¬é“¾æ¥ã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç›®å½•åº”è¯¥çº³å…¥è€ƒè™‘ï¼Œå³â€/â€œç›®å½•ï¼Œå®ƒè‡ªèº«æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å…¥å£ï¼Œæ˜¯è‡ªå¼•ç”¨(ä¸‹æ–‡ä¸­ä¼šè§£é‡Šè‡ªå¼•ç”¨)çš„ï¼Œæ‰€ä»¥â€/â€œç›®å½•ä¸‹çš„â€.â€œå’Œâ€â€¦â€œçš„inodeå·ç›¸åŒï¼Œå®ƒè‡ªèº«ä¸å ç”¨ç¡¬é“¾æ¥ï¼Œå› ä¸ºå…¶datablockä¸­åªè®°å½•inodeå·ç›¸åŒçš„â€.â€œå’Œâ€â€¦â€œï¼Œä¸å†åƒå…¶ä»–ç›®å½•ä¸€æ ·è¿˜è®°å½•ä¸€ä¸ªåä¸ºâ€/â€œçš„ç›®å½•ï¼Œæ‰€ä»¥â€/â€œçš„ç¡¬é“¾æ¥æ•°ä¹Ÿæ˜¯2+å­ç›®å½•æ•°ï¼Œä½†è¿™ä¸ª2æ˜¯â€.â€œå’Œâ€â€¦&quot;çš„ç»“æœã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi ~]<span class="comment"># ln /tmp /mydata </span></span><br><span class="line"><span class="built_in">ln</span>: `/tmp<span class="string">&#x27;: hard link not allowed for directory </span></span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆæ–‡ä»¶ç³»ç»Ÿè‡ªå·±åˆ›å»ºå¥½äº†ç›®å½•çš„ç¡¬é“¾æ¥å°±ä¸å…è®¸äººä¸ºåˆ›å»ºå‘¢?ä»&quot;.â€œå’Œâ€â€¦â€œçš„ç”¨æ³•ä¸Šè€ƒè™‘ï¼Œå¦‚æœå½“å‰ç›®å½•ä¸º/usrï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨â€./local&quot;æ¥è¡¨ç¤º/usr/localï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬äººä¸ºåˆ›å»ºäº†/usrç›®å½•çš„ç¡¬é“¾æ¥/tmp/husrï¼Œéš¾é“æˆ‘ä»¬ä¹Ÿè¦ä½¿ç”¨&quot;/tmp/husr/local&quot;æ¥è¡¨ç¤º/usr/localå—?è¿™å…¶å®å·²ç»æ˜¯è½¯é“¾æ¥çš„ä½œç”¨äº†ã€‚è‹¥è¦å°†å…¶è®¤ä¸ºæ˜¯ç¡¬é“¾æ¥çš„åŠŸèƒ½ï¼Œè¿™å¿…å°†å¯¼è‡´ç¡¬é“¾æ¥ç»´æŠ¤çš„æ··ä¹±ã€‚ã€è¿™ä¸ªè§£é‡Šä¹Ÿå¾ˆå¥½ã€‘</p><p>ä¸è¿‡ï¼Œé€šè¿‡mountå·¥å…·çš„&quot;â€“bind&quot;é€‰é¡¹ï¼Œå¯ä»¥å°†ä¸€ä¸ªç›®å½•æŒ‚è½½åˆ°å¦ä¸€ä¸ªç›®å½•ä¸‹ï¼Œå®ç°ä¼ª&quot;ç¡¬é“¾æ¥&quot;ï¼Œå®ƒä»¬çš„å†…å®¹å’Œinodeå·æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚</p><p>ç¡¬é“¾æ¥çš„åˆ›å»ºæ–¹æ³•ï¼š ln file_target link_name ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426140728344.png" alt="image-20240426140728344"></p><h4 id="4-2-è½¯é“¾æ¥">4.2 è½¯é“¾æ¥</h4><p><strong>è½¯é“¾æ¥çš„æœ¬è´¨æ˜¯ä¸€ä¸ªåŒ…å«ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•è·¯å¾„çš„å°æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åƒç¡¬é“¾æ¥ä¸€æ ·ç›´æ¥æŒ‡å‘æ•°æ®å—ã€‚å½“ä½ è®¿é—®è½¯é“¾æ¥æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šæ ¹æ®è¯¥é“¾æ¥ä¸­åŒ…å«çš„è·¯å¾„æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¹¶å°†æ“ä½œé‡å®šå‘åˆ°ç›®æ ‡ã€‚</strong></p><p>è½¯é“¾æ¥å°±æ˜¯å­—ç¬¦é“¾æ¥ï¼Œ<strong>é“¾æ¥æ–‡ä»¶é»˜è®¤æŒ‡çš„å°±æ˜¯å­—ç¬¦é“¾æ¥æ–‡ä»¶(æ³¨æ„ä¸æ˜¯å­—ç¬¦è®¾å¤‡)ï¼Œä½¿ç”¨&quot;l&quot;è¡¨ç¤ºå…¶ç±»å‹ã€‚</strong></p><p>ç¡¬é“¾æ¥ä¸èƒ½è·¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºï¼Œå¦åˆ™inodeå·å¯èƒ½ä¼šå†²çªã€‚äºæ˜¯å®ç°äº†è½¯é“¾æ¥ä»¥ä¾¿è·¨æ–‡ä»¶ç³»ç»Ÿå»ºç«‹é“¾æ¥ã€‚æ—¢ç„¶æ˜¯è·¨æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£ä¹ˆè½¯é“¾æ¥å¿…é¡»å¾—æœ‰è‡ªå·±çš„inodeå·ã€‚</p><p>è½¯é“¾æ¥åœ¨åŠŸèƒ½ä¸Šç­‰ä»·ä¸Windowsç³»ç»Ÿä¸­çš„å¿«æ·æ–¹å¼ï¼Œå®ƒæŒ‡å‘åŸæ–‡ä»¶ï¼ŒåŸæ–‡ä»¶æŸåæˆ–æ¶ˆå¤±ï¼Œè½¯é“¾æ¥æ–‡ä»¶å°±æŸåã€‚å¯ä»¥è®¤ä¸ºè½¯é“¾æ¥inodeè®°å½•ä¸­çš„æŒ‡é’ˆå†…å®¹æ˜¯ç›®æ ‡è·¯å¾„çš„å­—ç¬¦ä¸²ã€‚</p><p>åˆ›å»ºæ–¹å¼ï¼š ln â€“s source_file softlink_name ï¼Œè®°ä½æ˜¯source_file&lt;â€“link_nameçš„æŒ‡å‘å…³ç³»(åç®­å¤´)ï¼Œä»¥å‰æˆ‘è€æé”™ä½ç½®ã€‚</p><p>æŸ¥çœ‹è½¯é“¾æ¥çš„å€¼ï¼š readlink softlink_name</p><p>åœ¨è®¾ç½®è½¯é“¾æ¥çš„æ—¶å€™ï¼Œ<strong>source_fileè™½ç„¶ä¸è¦æ±‚æ˜¯ç»å¯¹è·¯å¾„ï¼Œä½†å»ºè®®ç»™ç»å¯¹è·¯å¾„</strong>ã€‚æ˜¯å¦è¿˜è®°å¾—è½¯é“¾æ¥æ–‡ä»¶çš„å¤§å°?å®ƒæ˜¯æ ¹æ®è½¯é“¾æ¥æ‰€æŒ‡å‘è·¯å¾„çš„å­—ç¬¦æ•°è®¡ç®—çš„ï¼Œä¾‹å¦‚æŸä¸ªç¬¦å·é“¾æ¥çš„æŒ‡å‘æ–¹å¼ä¸º&quot;rmt --&gt; â€¦/sbin/rmt&quot;ï¼Œå®ƒçš„æ–‡ä»¶å¤§å°ä¸º11å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦å»ºç«‹äº†è½¯é“¾æ¥åï¼Œè½¯é“¾æ¥çš„æŒ‡å‘è·¯å¾„æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œä»ç„¶æ˜¯&quot;â€¦/sbin/rmt&quot;ã€‚å¦‚æœæ­¤æ—¶ç§»åŠ¨è½¯é“¾æ¥æ–‡ä»¶æœ¬èº«ï¼Œå®ƒçš„æŒ‡å‘æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œä»ç„¶æ˜¯11ä¸ªå­—ç¬¦çš„&quot;â€¦/sbin/rmt&quot;ï¼Œä½†æ­¤æ—¶è¯¥è½¯é“¾æ¥çˆ¶ç›®å½•ä¸‹å¯èƒ½æ ¹æœ¬å°±ä¸å­˜åœ¨/sbin/rmtï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶è¯¥è½¯é“¾æ¥æ˜¯ä¸€ä¸ªè¢«ç ´åçš„è½¯é“¾æ¥ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426140716839.png" alt="image-20240426140716839"></p><h4 id="4-3-å®æ“">4.3 å®æ“</h4><ul><li><a href="https://zhuanlan.zhihu.com/p/641716217">ã€Linuxã€‘ç¡¬é“¾æ¥ å’Œ è½¯é“¾æ¥</a></li></ul><blockquote><p><strong>ç¡¬é“¾æ¥</strong></p></blockquote><p>å¦‚æœAæ–‡ä»¶å’ŒBæ–‡ä»¶çš„å…³ç³»æ˜¯ç¡¬è¿æ¥çš„å…³ç³»ã€‚å½“ç”¨æˆ·ä¿®æ”¹äº†Aæ–‡ä»¶çš„å†…å®¹ï¼Œé‚£ä¹ˆBæ–‡ä»¶çš„å†…å®¹ä¹Ÿä¼šå‘ç”Ÿæ›´æ”¹ã€‚å¦‚æœä¿®æ”¹çš„Bæ–‡ä»¶ï¼Œé‚£ä¹ˆAæ–‡ä»¶çš„å†…å®¹ä¹Ÿä¼šå‘ç”Ÿæ›´æ”¹ã€‚</p><p>ç‰¹ç‚¹:<br>1ã€ç¡¬è¿æ¥ä¸é™äºä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´ï¼Œå¯ä»¥åœ¨å¤šä¸ªæ–‡ä»¶ä¹‹é—´è¿›è¡Œã€‚ls -lå‘½ä»¤ä¸­æ˜¾ç¤ºäº†æ–‡ä»¶çš„ç¡¬è¿æ¥æ•°</p><p>2ã€ä¸èƒ½å¯¹ç›®å½•åšç¡¬ä»¶è¿æ¥</p><p>3ã€ä¸èƒ½åœ¨ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¹‹é—´åšç¡¬é“¾æ¥ã€”Linuxçš„æ–‡ä»¶ç³»ç»Ÿ: ext4ã€‚xfsç­‰ç­‰)</p><p>4ã€æ‰€æœ‰çš„ç¡¬è¿æ¥ï¼Œå…·å¤‡ç›¸åŒçš„iNodeèŠ‚ç‚¹å·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">touch</span> file1</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">ln</span> file1 file2</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° ll            </span><br><span class="line">total 88K</span><br><span class="line">-rwxrwxr-x 1 penge penge  38K 3æœˆ  10 15:14 a.out</span><br><span class="line">-rw-rw-r-- 2 penge penge    0 4æœˆ  26 14:00 file1</span><br><span class="line">-rw-rw-r-- 2 penge penge    0 4æœˆ  26 14:00 file2</span><br><span class="line">-rw-rw-r-- 1 penge penge 1.6K 3æœˆ  10 15:14 http_conn.cpp</span><br><span class="line">-rw-rw-r-- 1 penge penge  779 3æœˆ  13 11:18 http_conn.h</span><br><span class="line">-rw-rw-r-- 1 penge penge 2.7K 3æœˆ  10 10:52 locker.h</span><br><span class="line">-rwxrwxr-x 1 penge penge  21K 4æœˆ  12 10:39 main</span><br><span class="line">-rw-rw-r-- 1 penge penge    0 4æœˆ  17 13:30 main.cpp</span><br><span class="line">-rw-rw-r-- 1 penge penge 3.6K 3æœˆ  10 10:52 threadpool.h</span><br><span class="line">drwxrwxr-x 2 penge penge 4.0K 4æœˆ  16 14:25 tmp</span><br><span class="line">drwxrwxr-x 2 penge penge 4.0K 4æœˆ  25 16:05 tmp1</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">echo</span> <span class="string">&#x27;aaa&#x27;</span>&gt;file1                                                  </span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file1                                                         </span><br><span class="line">aaa</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file2</span><br><span class="line">aaa</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">echo</span> <span class="string">&#x27;bbb&#x27;</span>&gt;file2</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file2       </span><br><span class="line">bbb</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file2       </span><br><span class="line">bbb</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file1</span><br><span class="line">bbb</span><br></pre></td></tr></table></figure><blockquote><p><strong>è½¯é“¾æ¥</strong></p></blockquote><p>ç±»ä¼¼Windowsä¸­çš„å¿«æ·æ–¹å¼ã€‚ä¸ºä¸€ä¸ªæºæ–‡ä»¶åˆ›å»ºä¸€ä¸ªå¿«æ·æ–¹å¼ã€‚</p><p>1ã€å¦‚æœæºæ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•ä½¿ç”¨è¯¥å¿«æ·æ–¹å¼ã€‚ä¸€æ—¦ä»¥åŒæ ·æ–‡ä»¶ååˆ›å»ºäº†æºæ–‡ä»¶ï¼Œé“¾æ¥å°†ç»§ç»­æŒ‡å‘è¯¥æ–‡ä»¶çš„æ–°æ•°æ®</p><p>2ã€åœ¨ls-lä¸­ï¼Œè½¯é“¾æ¥ä½œä¸ºä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ç±»å‹æ˜¾ç¤ºå‡ºæ¥ï¼Œå…¶ç¬¬ä¸€ä¸ªå­—æ¯æ˜¯lã€‚</p><p>3ã€è½¯é“¾æ¥çš„å¤§å°æ˜¯å…¶é“¾æ¥æ–‡ä»¶çš„è·¯å¾„åä¸­çš„å­—ç¬¦æ•°ã€‚</p><p>pwd -Pæ˜¾ç¤ºæ–‡ä»¶çš„å®é™…è·¯å¾„,è€Œä¸æ˜¯è½¯è¿æ¥çš„è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> penge@penge-virtual-machine î‚° /bin î‚° <span class="built_in">pwd</span> -P</span><br><span class="line">/usr/bin</span><br></pre></td></tr></table></figure><h3 id="5-inodeæ·±å…¥">5.inodeæ·±å…¥</h3><h4 id="5-1-inodeå¤§å°å’Œåˆ’åˆ†">5.1 inodeå¤§å°å’Œåˆ’åˆ†</h4><p>inodeå¤§å°ä¸º128å­—èŠ‚çš„å€æ•°ï¼Œæœ€å°ä¸º128å­—èŠ‚ã€‚å®ƒæœ‰é»˜è®¤å€¼å¤§å°ï¼Œå®ƒçš„é»˜è®¤å€¼ç”±/etc/mke2fs.confæ–‡ä»¶ä¸­æŒ‡å®šã€‚ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿé»˜è®¤å€¼å¯èƒ½ä¸åŒã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi ~]<span class="comment"># cat /etc/mke2fs.conf </span></span><br><span class="line">[defaults] </span><br><span class="line"> base_features = sparse_super,filetype,resize_inode,dir_index,ext_attr </span><br><span class="line"> enable_periodic_fsck = 1 </span><br><span class="line"> blocksize = 4096 </span><br><span class="line"> inode_size = 256 </span><br><span class="line"> inode_ratio = 16384 </span><br><span class="line">[fs_types] </span><br><span class="line"> ext3 = &#123; </span><br><span class="line"> features = has_journal </span><br><span class="line"> &#125; </span><br><span class="line"> ext4 = &#123; </span><br><span class="line"> features = has_journal,extent,huge_file,flex_bg,uninit_bg,dir_nlink,extra_isize </span><br><span class="line"> inode_size = 256 </span><br><span class="line"> &#125; </span><br></pre></td></tr></table></figure><p>åŒæ ·è§‚å¯Ÿåˆ°è¿™ä¸ªæ–‡ä»¶ä¸­è¿˜è®°å½•äº†blocksizeçš„é»˜è®¤å€¼å’Œinodeåˆ†é…æ¯”ç‡inode_ratioã€‚inode_ratio=16384è¡¨ç¤ºæ¯16384ä¸ªå­—èŠ‚å³16KBå°±åˆ†é…ä¸€ä¸ªinodeå·ï¼Œç”±äºé»˜è®¤blocksize=4KBï¼Œæ‰€ä»¥æ¯4ä¸ªblockå°±åˆ†é…ä¸€ä¸ªinodeå·ã€‚å½“ç„¶åˆ†é…çš„è¿™äº›inodeå·åªæ˜¯é¢„åˆ†é…ï¼Œå¹¶ä¸çœŸçš„ä»£è¡¨ä¼šå…¨éƒ¨ä½¿ç”¨ï¼Œæ¯•ç«Ÿæ¯ä¸ªæ–‡ä»¶æ‰ä¼šåˆ†é…ä¸€ä¸ªinodeå·ã€‚ä½†æ˜¯åˆ†é…çš„inodeè‡ªèº«ä¼šå ç”¨blockï¼Œè€Œä¸”å…¶è‡ªèº«å¤§å°256å­—èŠ‚è¿˜ä¸ç®—å°ï¼Œæ‰€ä»¥inodeå·çš„æµªè´¹ä»£è¡¨ç€ç©ºé—´çš„æµªè´¹ã€‚</p><p>æ—¢ç„¶çŸ¥é“äº†inodeåˆ†é…æ¯”ç‡ï¼Œå°±èƒ½è®¡ç®—å‡ºæ¯ä¸ªå—ç»„åˆ†é…å¤šå°‘ä¸ªinodeå·ï¼Œä¹Ÿå°±èƒ½è®¡ç®—å‡ºinode tableå ç”¨å¤šå°‘ä¸ªblockã€‚</p><p>å¦‚æœæ–‡ä»¶ç³»ç»Ÿä¸­å¤§é‡å­˜å‚¨ç”µå½±ç­‰å¤§æ–‡ä»¶ï¼Œinodeå·å°±æµªè´¹å¾ˆå¤šï¼Œinodeå ç”¨çš„ç©ºé—´ä¹Ÿæµªè´¹å¾ˆå¤šã€‚ä½†æ˜¯æ²¡åŠæ³•ï¼Œæ–‡ä»¶ç³»ç»Ÿåˆä¸çŸ¥é“ä½ è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿæ˜¯ç”¨æ¥å­˜ä»€ä¹ˆæ ·çš„æ•°æ®ï¼Œå¤šå¤§çš„æ•°æ®ï¼Œå¤šå°‘æ•°æ®ã€‚</p><p>å½“ç„¶inodesizeã€inodeåˆ†é…æ¯”ä¾‹ã€blocksizeéƒ½å¯ä»¥åœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™äººä¸ºæŒ‡å®šã€‚</p><h4 id="5-2-extæ–‡ä»¶ç³»ç»Ÿé¢„ç•™çš„inodeå·">5.2 extæ–‡ä»¶ç³»ç»Ÿé¢„ç•™çš„inodeå·</h4><p>Exté¢„ç•™äº†ä¸€äº›inodeåšç‰¹æ®Šç‰¹æ€§ä½¿ç”¨ï¼Œå¦‚ä¸‹ï¼šæŸäº›å¯èƒ½å¹¶éæ€»æ˜¯å‡†ç¡®ï¼Œå…·ä½“çš„inodeå·å¯¹åº”ä»€ä¹ˆæ–‡ä»¶å¯ä»¥ä½¿ç”¨&quot;find / -inum NUM&quot;æŸ¥çœ‹ã€‚</p><ul><li>Ext4çš„ç‰¹æ®Šinode</li><li>Inodeå· ç”¨é€”</li><li>0 ä¸å­˜åœ¨0å·inode</li><li>1 è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚/procå’Œ/sys</li><li>2 æ ¹ç›®å½•</li><li>3 ACLç´¢å¼•</li><li>4 ACLæ•°æ®</li><li>5 Boot loader</li><li>6 æœªåˆ é™¤çš„ç›®å½•</li><li>7 é¢„ç•™çš„å—ç»„æè¿°ç¬¦inode</li><li>8 æ—¥å¿—inode</li><li>11 ç¬¬ä¸€ä¸ªéé¢„ç•™çš„inodeï¼Œé€šå¸¸æ˜¯lost+foundç›®å½•</li></ul><p>æ‰€ä»¥åœ¨ext4æ–‡ä»¶ç³»ç»Ÿçš„dumpe2fsä¿¡æ¯ä¸­ï¼Œèƒ½è§‚å¯Ÿåˆ°fisrt inodeå·å¯èƒ½ä¸º11ä¹Ÿå¯èƒ½ä¸º12ã€‚</p><p>å¹¶ä¸”æ³¨æ„åˆ°&quot;/&quot;çš„inodeå·ä¸º2ï¼Œè¿™ä¸ªç‰¹æ€§åœ¨æ–‡ä»¶è®¿é—®æ—¶ä¼šç”¨ä¸Šã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½ä¼šåˆ†é…è‡ªå·±çš„inodeå·ï¼Œä¸åŒæ–‡ä»¶ç³»ç»Ÿä¹‹é—´æ˜¯å¯èƒ½ä¼šå‡ºç°ä½¿ç”¨ç›¸åŒinodeå·æ–‡ä»¶çš„ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi ~]<span class="comment"># find / -ignore_readdir_race -inum 2 -ls </span></span><br><span class="line"> 2 4 dr-xr-xr-x 22 root root 4096 Jun 9 09:56 / </span><br><span class="line"> 2 2 dr-xr-xr-x 5 root root 1024 Feb 25 11:53 /boot </span><br><span class="line"> 2 0 c--------- 1 root root Jun 7 02:13 /dev/pts/ptmx </span><br><span class="line"> 2 0 -rw-r--r-- 1 root root 0 Jun 6 18:13 /proc/sys/fs/binfmt_misc/status </span><br><span class="line"> 2 0 drwxr-xr-x 3 root root 0 Jun 6 18:13 /sys/fs </span><br></pre></td></tr></table></figure><p>ä»ç»“æœä¸­å¯è§ï¼Œé™¤äº†æ ¹çš„Inodeå·ä¸º2ï¼Œè¿˜æœ‰å‡ ä¸ªæ–‡ä»¶çš„inodeå·ä¹Ÿæ˜¯ 2ï¼Œå®ƒä»¬éƒ½å±äºç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæœ‰äº›æ˜¯è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚/procå’Œ/sysã€‚</p><h4 id="5-3-ext2-3çš„inodeç›´æ¥ã€é—´æ¥å¯»å€">5.3 ext2/3çš„inodeç›´æ¥ã€é—´æ¥å¯»å€</h4><p>å‰æ–‡è¯´è¿‡ï¼Œinodeä¸­ä¿å­˜äº†blocksæŒ‡é’ˆï¼Œä½†æ˜¯ä¸€æ¡inodeè®°å½•ä¸­èƒ½ä¿å­˜çš„æŒ‡é’ˆæ•°é‡æ˜¯æœ‰é™çš„ï¼Œå¦åˆ™å°±ä¼šè¶…å‡ºinodeå¤§å°(128å­—èŠ‚æˆ–256å­—èŠ‚)ã€‚</p><p>åœ¨ext2å’Œext3æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªinodeä¸­æœ€å¤šåªèƒ½æœ‰15ä¸ªæŒ‡é’ˆï¼Œæ¯ä¸ªæŒ‡é’ˆä½¿ç”¨i_block[n]è¡¨ç¤ºã€‚</p><p>å‰12ä¸ªæŒ‡é’ˆi_block[0]åˆ°i_block[11]æ˜¯ç›´æ¥å¯»å€æŒ‡é’ˆï¼Œæ¯ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæ•°æ®åŒºçš„blockã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426112610456.png" alt="image-20240426112610456"></p><p>ç¬¬13ä¸ªæŒ‡é’ˆi_block[12]æ˜¯ä¸€çº§é—´æ¥å¯»å€æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªä»ç„¶å­˜å‚¨äº†æŒ‡é’ˆçš„blockå³i_block[12] --&gt; Pointerblock --&gt; datablockã€‚</p><p>ç¬¬14ä¸ªæŒ‡é’ˆi_block[13]æ˜¯äºŒçº§é—´æ¥å¯»å€æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªä»ç„¶å­˜å‚¨äº†æŒ‡é’ˆçš„blockï¼Œä½†æ˜¯è¿™ä¸ªblockä¸­çš„æŒ‡é’ˆè¿˜ç»§ç»­æŒ‡å‘å…¶ä»–å­˜å‚¨æŒ‡é’ˆçš„blockï¼Œå³i_block[13] --&gt; Pointerblock1 --&gt; PointerBlock2 --&gt; datablockã€‚</p><p>ç¬¬15ä¸ªæŒ‡é’ˆi_block[14]æ˜¯ä¸‰çº§é—´æ¥å¯»å€æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªä»»ç„¶å­˜å‚¨äº†æŒ‡é’ˆçš„blockï¼Œè¿™ä¸ªæŒ‡é’ˆblockä¸‹è¿˜æœ‰ä¸¤æ¬¡æŒ‡é’ˆæŒ‡å‘ã€‚å³i_block[13] --&gt; Pointerblock1 --&gt; PointerBlock2 --&gt; PointerBlock3 --&gt; datablockã€‚</p><p>å…¶ä¸­ç”±äºæ¯ä¸ªæŒ‡é’ˆå¤§å°ä¸º4å­—èŠ‚ï¼Œæ‰€ä»¥æ¯ä¸ªæŒ‡é’ˆblockèƒ½å­˜æ”¾çš„æŒ‡é’ˆæ•°é‡ä¸ºBlockSize/4byteã€‚ä¾‹å¦‚blocksizeä¸º4KBï¼Œé‚£ä¹ˆä¸€ä¸ªBlockå¯ä»¥å­˜æ”¾4096/4=1024ä¸ªæŒ‡é’ˆã€‚</p><p>å¦‚ä¸‹å›¾</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426112704312.png" alt="image-20240426112704312"></p><p>ä¸ºä»€ä¹ˆè¦åˆ†é—´æ¥å’Œç›´æ¥æŒ‡é’ˆå‘¢?å¦‚æœä¸€ä¸ªinodeä¸­15ä¸ªæŒ‡é’ˆå…¨æ˜¯ç›´æ¥æŒ‡é’ˆï¼Œå‡å¦‚æ¯ä¸ªblockçš„å¤§å°ä¸º1KBï¼Œé‚£ä¹ˆ15ä¸ªæŒ‡é’ˆåªèƒ½æŒ‡å‘15ä¸ªblockå³15KBçš„å¤§å°ï¼Œç”±äºæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªinodeå·ï¼Œæ‰€ä»¥å°±é™åˆ¶äº†æ¯ä¸ªæ–‡ä»¶æœ€å¤§ä¸º15*1=15KBï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚</p><p>å¦‚æœå­˜å‚¨å¤§äº15KBçš„æ–‡ä»¶è€Œåˆä¸å¤ªå¤§çš„æ—¶å€™ï¼Œå°±å ç”¨ä¸€çº§é—´æ¥æŒ‡é’ˆi_block[12]ï¼Œè¿™æ—¶å¯ä»¥å­˜æ”¾æŒ‡é’ˆæ•°é‡ä¸º1024/4+12=268ï¼Œæ‰€ä»¥èƒ½å­˜æ”¾268KBçš„æ–‡ä»¶ã€‚</p><p>å¦‚æœå­˜å‚¨å¤§äº268K çš„æ–‡ä»¶è€Œåˆä¸å¤ªå¤§çš„æ—¶å€™ï¼Œå°±ç»§ç»­å ç”¨äºŒçº§æŒ‡é’ˆi_block[13]ï¼Œè¿™æ—¶å¯ä»¥å­˜æ”¾æŒ‡é’ˆæ•°é‡ä¸º[1024/4]^2+1024/4+12=65804ï¼Œæ‰€ä»¥èƒ½å­˜æ”¾65804KB=64Må·¦å³çš„æ–‡ä»¶ã€‚</p><p>å¦‚æœå­˜æ”¾çš„æ–‡ä»¶å¤§äº64Mï¼Œé‚£ä¹ˆå°±ç»§ç»­ä½¿ç”¨ä¸‰çº§é—´æ¥æŒ‡é’ˆi_block[14]ï¼Œå­˜æ”¾çš„æŒ‡é’ˆæ•°é‡ä¸º[1024/4]^3+[1024/4]^2+[1024/4]+12=16843020ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥èƒ½å­˜æ”¾16843020KB=16GBå·¦å³çš„æ–‡ä»¶ã€‚</p><p>å¦‚æœblocksize=4KBå‘¢?é‚£ä¹ˆæœ€å¤§èƒ½å­˜æ”¾çš„æ–‡ä»¶å¤§å°ä¸º([4096/4]^3+[4096/4]^2+[4096/4]+12)*4/1024/1024/1024=4Tå·¦å³ã€‚</p><p>å½“ç„¶è¿™æ ·è®¡ç®—å‡ºæ¥çš„ä¸ä¸€å®šå°±æ˜¯æœ€å¤§èƒ½å­˜æ”¾çš„æ–‡ä»¶å¤§å°ï¼Œå®ƒè¿˜å—åˆ°å¦ä¸€ä¸ªæ¡ä»¶çš„é™åˆ¶ã€‚è¿™é‡Œçš„è®¡ç®—åªæ˜¯è¡¨æ˜ä¸€ä¸ªå¤§æ–‡ä»¶æ˜¯å¦‚ä½•å¯»å€å’Œåˆ†é…çš„ã€‚</p><p>å…¶å®çœ‹åˆ°è¿™é‡Œçš„è®¡ç®—æ•°å€¼ï¼Œå°±çŸ¥é“ext2å’Œext3å¯¹è¶…å¤§æ–‡ä»¶çš„å­˜å–æ•ˆç‡æ˜¯ä½ä¸‹çš„ï¼Œå®ƒè¦æ ¸å¯¹å¤ªå¤šçš„æŒ‡é’ˆï¼Œç‰¹åˆ«æ˜¯4KBå¤§å°çš„blocksizeæ—¶ã€‚è€Œext4é’ˆå¯¹è¿™ä¸€ç‚¹å°±è¿›è¡Œäº†ä¼˜åŒ–ï¼Œext4ä½¿ç”¨extentçš„ç®¡ç†æ–¹å¼å–ä»£ext2å’Œext3çš„å—æ˜ å°„ï¼Œå¤§å¤§æé«˜äº†æ•ˆç‡ä¹Ÿé™ä½äº†ç¢ç‰‡ã€‚</p><h3 id="6-å•æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶æ“ä½œçš„åŸç†">6.å•æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶æ“ä½œçš„åŸç†</h3><p>åœ¨Linuxä¸Šæ‰§è¡Œåˆ é™¤ã€å¤åˆ¶ã€é‡å‘½åã€ç§»åŠ¨ç­‰æ“ä½œæ—¶ï¼Œå®ƒä»¬æ˜¯æ€ä¹ˆè¿›è¡Œçš„å‘¢?è¿˜æœ‰è®¿é—®æ–‡ä»¶æ—¶æ˜¯å¦‚ä½•æ‰¾åˆ°å®ƒçš„å‘¢?å…¶å®åªè¦ç†è§£äº†å‰æ–‡ä¸­ä»‹ç»çš„å‡ ä¸ªæœ¯è¯­ä»¥åŠå®ƒä»¬çš„ä½œç”¨å°±å¾ˆå®¹æ˜“çŸ¥é“æ–‡ä»¶æ“ä½œçš„åŸç†äº†ã€‚</p><p>æ³¨ï¼šåœ¨è¿™ä¸€å°èŠ‚æ‰€è§£é‡Šçš„éƒ½æ˜¯åœ¨å•ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸‹çš„è¡Œä¸ºï¼Œåœ¨å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­å¦‚ä½•è¯·çœ‹ä¸‹ä¸€ä¸ªå°èŠ‚ï¼šå¤šæ–‡ä»¶ç³»ç»Ÿå…³è”ã€‚</p><h4 id="6-1-è¯»å–æ–‡ä»¶"><strong>6.1 è¯»å–æ–‡ä»¶</strong></h4><p>å½“æ‰§è¡Œ&quot;<strong>cat /var/log/messages</strong>&quot;å‘½ä»¤åœ¨ç³»ç»Ÿå†…éƒ¨è¿›è¡Œäº†ä»€ä¹ˆæ ·çš„æ­¥éª¤å‘¢?è¯¥å‘½ä»¤èƒ½è¢«æˆåŠŸæ‰§è¡Œæ¶‰åŠäº†catå‘½ä»¤çš„å¯»æ‰¾ã€æƒé™åˆ¤æ–­ä»¥åŠmessagesæ–‡ä»¶çš„å¯»æ‰¾å’Œæƒé™åˆ¤æ–­ç­‰ç­‰å¤æ‚çš„è¿‡ç¨‹ã€‚è¿™é‡Œåªè§£é‡Šå’Œæœ¬èŠ‚å†…å®¹ç›¸å…³çš„å¦‚ä½•å¯»æ‰¾åˆ°è¢«catçš„/var/log/messagesæ–‡ä»¶ã€‚</p><ul><li>æ‰¾åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å—ç»„æè¿°ç¬¦è¡¨æ‰€åœ¨çš„blocksï¼Œè¯»å–GDT(å·²åœ¨å†…å­˜ä¸­)æ‰¾åˆ°inode tableçš„blockå·ã€‚</li></ul><p>å› ä¸ºGDTæ€»æ˜¯å’Œsuperblockåœ¨åŒä¸€ä¸ªå—ç»„ï¼Œè€Œsuperblockæ€»æ˜¯åœ¨åˆ†åŒºçš„ç¬¬1024-2047ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±çŸ¥é“ç¬¬ä¸€ä¸ªGDTæ‰€åœ¨çš„å—ç»„ä»¥åŠGDTåœ¨è¿™ä¸ªå—ç»„ä¸­å ç”¨äº†å“ªäº›blockã€‚</p><p>å…¶å®GDTæ—©å·²ç»åœ¨å†…å­˜ä¸­äº†ï¼Œåœ¨ç³»ç»Ÿå¼€æœºçš„æ—¶å€™ä¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½çš„æ—¶å€™å°±å·²ç»å°†æ‰€æœ‰çš„GDTæ”¾è¿›å†…å­˜ä¸­ã€‚</p><ul><li>åœ¨inode tableçš„blockä¸­å®šä½åˆ°æ ¹&quot;/â€œçš„inodeï¼Œæ‰¾å‡ºâ€/&quot;æŒ‡å‘çš„data blockã€‚</li></ul><p>å‰æ–‡è¯´è¿‡ï¼Œextæ–‡ä»¶ç³»ç»Ÿé¢„ç•™äº†ä¸€äº›inodeå·ï¼Œå…¶ä¸­&quot;/&quot;çš„inodeå·ä¸º2ï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®inodeå·ç›´æ¥å®šä½æ ¹ç›®å½•æ–‡ä»¶çš„data blockã€‚</p><ul><li>åœ¨&quot;/&quot;çš„datablockä¸­è®°å½•äº†varç›®å½•åå’ŒæŒ‡å‘varç›®å½•æ–‡ä»¶inodeçš„æŒ‡é’ˆï¼Œå¹¶æ‰¾åˆ°è¯¥inodeè®°å½•ï¼Œinodeè®°å½•ä¸­å­˜å‚¨äº†æŒ‡å‘varçš„blockæŒ‡é’ˆï¼Œæ‰€ä»¥ä¹Ÿå°±æ‰¾åˆ°äº†varç›®å½•æ–‡ä»¶çš„data blockã€‚</li></ul><p>é€šè¿‡varç›®å½•çš„inodeæŒ‡é’ˆï¼Œå¯ä»¥å¯»æ‰¾åˆ°varç›®å½•çš„inodeè®°å½•ï¼Œä½†æ˜¯æŒ‡é’ˆå®šä½çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦çŸ¥é“è¯¥inodeè®°å½•æ‰€åœ¨çš„å—ç»„ä»¥åŠæ‰€åœ¨çš„inode tableï¼Œæ‰€ä»¥éœ€è¦è¯»å–GDTï¼ŒåŒæ ·ï¼ŒGDTå·²ç»ç¼“å­˜åˆ°äº†å†…å­˜ä¸­ã€‚</p><ul><li>åœ¨varçš„data blockä¸­è®°å½•äº†logç›®å½•åå’Œå…¶inodeæŒ‡é’ˆï¼Œé€šè¿‡è¯¥æŒ‡é’ˆå®šä½åˆ°è¯¥inodeæ‰€åœ¨çš„å—ç»„åŠæ‰€åœ¨çš„inode tableï¼Œå¹¶æ ¹æ®è¯¥inodeè®°å½•æ‰¾åˆ°logçš„data blockã€‚</li><li>åœ¨logç›®å½•æ–‡ä»¶çš„data blockä¸­è®°å½•äº†messagesæ–‡ä»¶åå’Œå¯¹åº”çš„inodeæŒ‡é’ˆï¼Œé€šè¿‡è¯¥æŒ‡é’ˆå®šä½åˆ°è¯¥inodeæ‰€åœ¨çš„å—ç»„åŠæ‰€åœ¨çš„inode tableï¼Œå¹¶æ ¹æ®è¯¥inodeè®°å½•æ‰¾åˆ°messagesçš„data blockã€‚</li><li>æœ€åè¯»å–messageså¯¹åº”çš„datablockã€‚</li></ul><p>å°†ä¸Šè¿°æ­¥éª¤ä¸­GDTéƒ¨åˆ†çš„æ­¥éª¤ç®€åŒ–åæ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚å¦‚ä¸‹:<strong>æ‰¾åˆ°GDTâ€“&gt;æ‰¾åˆ°&quot;/&quot;çš„inodeâ€“&gt;æ‰¾åˆ°/çš„æ•°æ®å—è¯»å–varçš„inodeâ€“&gt;æ‰¾åˆ°varçš„æ•°æ®å—è¯»å–logçš„inodeâ€“&gt;æ‰¾åˆ°logçš„æ•°æ®å—è¯»å–messagesçš„inodeâ€“&gt;æ‰¾åˆ°messagesçš„æ•°æ®å—å¹¶è¯»å–å®ƒä»¬ã€‚</strong></p><h4 id="6-2-åˆ é™¤ã€é‡å‘½åå’Œç§»åŠ¨æ–‡ä»¶">6.2 åˆ é™¤ã€é‡å‘½åå’Œç§»åŠ¨æ–‡ä»¶</h4><p>æ³¨æ„è¿™é‡Œæ˜¯ä¸è·¨è¶Šæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œè¡Œä¸ºã€‚</p><ul><li><strong>åˆ é™¤æ–‡ä»¶åˆ†ä¸ºæ™®é€šæ–‡ä»¶å’Œç›®å½•æ–‡ä»¶</strong>ï¼ŒçŸ¥é“äº†è¿™ä¸¤ç§ç±»å‹çš„æ–‡ä»¶çš„åˆ é™¤åŸç†ï¼Œå°±çŸ¥é“äº†å…¶ä»–ç±»å‹ç‰¹æ®Šæ–‡ä»¶çš„åˆ é™¤æ–¹æ³•ã€‚</li></ul><p>å¯¹äºåˆ é™¤æ™®é€šæ–‡ä»¶ï¼š</p><p>(1) æ‰¾åˆ°æ–‡ä»¶çš„inodeå’Œdata block(æ ¹æ®å‰ä¸€ä¸ªå°èŠ‚ä¸­çš„æ–¹æ³•å¯»æ‰¾);</p><p>(2) å°†inode tableä¸­è¯¥inodeè®°å½•ä¸­çš„data blockæŒ‡é’ˆåˆ é™¤;</p><p>(3) åœ¨imapä¸­å°†è¯¥æ–‡ä»¶çš„inodeå·æ ‡è®°ä¸ºæœªä½¿ç”¨;</p><p>(4) åœ¨å…¶æ‰€åœ¨ç›®å½•çš„data blockä¸­å°†è¯¥æ–‡ä»¶åæ‰€åœ¨çš„è®°å½•è¡Œåˆ é™¤ï¼Œåˆ é™¤äº†è®°å½•å°±ä¸¢å¤±äº†æŒ‡å‘inodeçš„æŒ‡é’ˆ;</p><p>(5) å°†bmapä¸­data blockå¯¹åº”çš„blockå·æ ‡è®°ä¸ºæœªä½¿ç”¨ã€‚</p><p>å¯¹äºåˆ é™¤ç›®å½•æ–‡ä»¶ï¼šæ‰¾åˆ°ç›®å½•å’Œç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ã€å­ç›®å½•ã€å­æ–‡ä»¶çš„inodeå’Œdata block;åœ¨imapä¸­å°†è¿™äº›inodeå·æ ‡è®°ä¸ºæœªä½¿ç”¨;å°†bmapä¸­å°†è¿™äº›æ–‡ä»¶å ç”¨çš„ blockå·æ ‡è®°ä¸ºæœªä½¿ç”¨;åœ¨è¯¥ç›®å½•çš„çˆ¶ç›®å½•çš„data blockä¸­å°†è¯¥ç›®å½•åæ‰€åœ¨çš„è®°å½•è¡Œåˆ é™¤ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ é™¤çˆ¶ç›®å½•data blockä¸­çš„è®°å½•æ˜¯æœ€åä¸€æ­¥ï¼Œå¦‚æœè¯¥æ­¥éª¤æå‰ï¼Œå°†æŠ¥ç›®å½•éç©ºçš„é”™è¯¯ï¼Œå› ä¸ºåœ¨è¯¥ç›®å½•ä¸­è¿˜æœ‰æ–‡ä»¶å ç”¨ã€‚</p><p>å…³äºä¸Šé¢çš„(2)-(5)ï¼šå½“(2)ä¸­åˆ é™¤data blockæŒ‡é’ˆåï¼Œå°†æ— æ³•å†æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶çš„æ•°æ®;å½“(3)æ ‡è®°inodeå·æœªä½¿ç”¨ï¼Œè¡¨ç¤ºè¯¥inodeå·å¯ä»¥è¢«åç»­çš„æ–‡ä»¶é‡ç”¨;å½“(4)åˆ é™¤ç›®å½•data blockä¸­å…³äºè¯¥æ–‡ä»¶çš„è®°å½•ï¼ŒçœŸæ­£çš„åˆ é™¤æ–‡ä»¶ï¼Œå¤–ç•Œå†ä¹Ÿå®šä½ä¹Ÿæ— æ³•çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶äº†;å½“(5)æ ‡è®°data blockä¸ºæœªä½¿ç”¨åï¼Œè¡¨ç¤ºå¼€å§‹é‡Šæ”¾ç©ºé—´ï¼Œè¿™äº›data blockå¯ä»¥è¢«å…¶ä»–æ–‡ä»¶é‡ç”¨ã€‚</p><p>æ³¨æ„ï¼Œåœ¨ç¬¬(5)æ­¥ä¹‹å‰ï¼Œç”±äºdata blockè¿˜æœªè¢«æ ‡è®°ä¸ºæœªä½¿ç”¨ï¼Œåœ¨superblockä¸­ä»ç„¶è®¤ä¸ºè¿™äº›data blockæ˜¯æ­£åœ¨ä½¿ç”¨ä¸­çš„ã€‚è¿™è¡¨ç¤ºå°½ç®¡æ–‡ä»¶å·²ç»è¢«åˆ é™¤äº†ï¼Œä½†ç©ºé—´å´è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œdfä¹Ÿä¼šå°†å…¶ç»Ÿè®¡åˆ°å·²ç”¨ç©ºé—´ä¸­(dfæ˜¯è¯»å–superblockä¸­çš„æ•°æ®å—æ•°é‡ï¼Œå¹¶è®¡ç®—è½¬æ¢ä¸ºç©ºé—´å¤§å°)ã€‚</p><p>ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µå‘¢?å½“ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨å¼•ç”¨æ–‡ä»¶æ—¶å°†è¯¥æ–‡ä»¶åˆ é™¤ï¼Œå°±ä¼šå‡ºç°æ–‡ä»¶å·²åˆ é™¤ä½†ç©ºé—´æœªé‡Šæ”¾çš„æƒ…å†µã€‚è¿™æ—¶æ­¥éª¤å·²ç»è¿›è¡Œåˆ°(4)ï¼Œå¤–ç•Œæ— æ³•å†æ‰¾åˆ°è¯¥æ–‡ä»¶ï¼Œä½†ç”±äºè¿›ç¨‹åœ¨åŠ è½½è¯¥æ–‡ä»¶æ—¶å·²ç»è·å–åˆ°äº†è¯¥æ–‡ä»¶æ‰€æœ‰çš„data blockæŒ‡é’ˆï¼Œè¯¥è¿›ç¨‹å¯ä»¥è·å–åˆ°è¯¥æ–‡ä»¶çš„æ‰€æœ‰æ•°æ®ï¼Œä½†å´æš‚æ—¶ä¸ä¼šé‡Šæ”¾è¯¥æ–‡ä»¶ç©ºé—´ã€‚ç›´åˆ°è¯¥è¿›ç¨‹ç»“æŸï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰å°†æœªæ‰§è¡Œçš„æ­¥éª¤(5)ç»§ç»­å®Œæˆã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™duçš„ç»Ÿè®¡ç»“æœæ¯”dfå°çš„åŸå› ï¼Œå…³äºduå’Œdfç»Ÿè®¡ç»“æœçš„å·®åˆ«ï¼Œè¯¦ç»†å†…å®¹è§ï¼šè¯¦ç»†åˆ†æduå’Œdfçš„ç»Ÿè®¡ç»“æœä¸ºä»€ä¹ˆä¸ä¸€æ ·ã€‚</p><ul><li>é‡å‘½åæ–‡ä»¶åˆ†ä¸ºåŒç›®å½•å†…é‡å‘½åå’ŒéåŒç›®å½•å†…é‡å‘½åã€‚éåŒç›®å½•å†…é‡å‘½åå®é™…ä¸Šæ˜¯ç§»åŠ¨æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œè§ä¸‹æ–‡ã€‚</li></ul><p>åŒç›®å½•å†…é‡å‘½åæ–‡ä»¶çš„åŠ¨ä½œä»…ä»…åªæ˜¯ä¿®æ”¹æ‰€åœ¨ç›®å½•data blockä¸­è¯¥æ–‡ä»¶è®°å½•çš„æ–‡ä»¶åéƒ¨åˆ†ï¼Œä¸æ˜¯åˆ é™¤å†é‡å»ºçš„è¿‡ç¨‹ã€‚</p><p>å¦‚æœé‡å‘½åæ—¶æœ‰æ–‡ä»¶åå†²çª(è¯¥ç›®å½•å†…å·²ç»å­˜åœ¨è¯¥æ–‡ä»¶å)ï¼Œåˆ™æç¤ºæ˜¯å¦è¦†ç›–ã€‚è¦†ç›–çš„è¿‡ç¨‹æ˜¯è¦†ç›–ç›®å½•data blockä¸­å†²çªæ–‡ä»¶çš„è®°å½•ã€‚ä¾‹å¦‚/tmp/ä¸‹æœ‰a.txtå’Œa.logï¼Œè‹¥å°†a.txté‡å‘½åä¸ºa.logï¼Œåˆ™æç¤ºè¦†ç›–ï¼Œè‹¥é€‰æ‹©è¦†ç›–ï¼Œåˆ™/tmpçš„data blockä¸­å…³äºa.logçš„è®°å½•è¢«è¦†ç›–ï¼Œæ­¤æ—¶å®ƒçš„æŒ‡é’ˆæ˜¯æŒ‡å‘a.txtçš„inodeã€‚</p><ul><li>ç§»åŠ¨æ–‡ä»¶</li></ul><p>åŒæ–‡ä»¶ç³»ç»Ÿä¸‹ç§»åŠ¨æ–‡ä»¶å®é™…ä¸Šæ˜¯ä¿®æ”¹ç›®æ ‡æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„data blockï¼Œå‘å…¶ä¸­æ·»åŠ ä¸€è¡ŒæŒ‡å‘inode tableä¸­å¾…ç§»åŠ¨æ–‡ä»¶çš„inodeæŒ‡é’ˆï¼Œå¦‚æœç›®æ ‡è·¯å¾„ä¸‹æœ‰åŒåæ–‡ä»¶ï¼Œåˆ™ä¼šæç¤ºæ˜¯å¦è¦†ç›–ï¼Œå®é™…ä¸Šæ˜¯è¦†ç›–ç›®å½•data blockä¸­å†²çªæ–‡ä»¶çš„è®°å½•ï¼Œç”±äºåŒåæ–‡ä»¶çš„inodeè®°å½•æŒ‡é’ˆè¢«è¦†ç›–ï¼Œæ‰€ä»¥æ— æ³•å†æ‰¾åˆ°è¯¥æ–‡ä»¶çš„data blockï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ–‡ä»¶è¢«æ ‡è®°ä¸ºåˆ é™¤(å¦‚æœå¤šä¸ªç¡¬é“¾æ¥æ•°ï¼Œåˆ™å¦å½“åˆ«è®º)ã€‚</p><p>æ‰€ä»¥åœ¨åŒæ–‡ä»¶ç³»ç»Ÿå†…ç§»åŠ¨æ–‡ä»¶ç›¸å½“å¿«ï¼Œä»…ä»…åœ¨æ‰€åœ¨ç›®å½•data blockä¸­æ·»åŠ æˆ–è¦†ç›–äº†ä¸€æ¡è®°å½•è€Œå·²ã€‚ä¹Ÿå› æ­¤ï¼Œç§»åŠ¨æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶çš„inodeå·æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚</p><p>å¯¹äºä¸åŒæ–‡ä»¶ç³»ç»Ÿå†…çš„ç§»åŠ¨ï¼Œç›¸å½“äºå…ˆå¤åˆ¶å†åˆ é™¤çš„åŠ¨ä½œã€‚è§åæ–‡ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426113825639.png" alt="image-20240426113825639"></p><p>å…³äºæ–‡ä»¶ç§»åŠ¨ï¼Œåœ¨Linuxç¯å¢ƒä¸‹æœ‰ä¸€ä¸ªéå¸¸ç»å…¸ç½‘ä¸Šå´åˆæ²¡ä»»ä½•è§£é‡Šçš„é—®é¢˜ï¼š/tmp/a/aèƒ½è¦†ç›–ä¸º/tmp/aå—?ç­”æ¡ˆæ˜¯ä¸èƒ½ï¼Œä½†windowsèƒ½ã€‚ä¸ºä»€ä¹ˆä¸èƒ½?è§mvçš„ä¸€ä¸ªç»å…¸é—®é¢˜(mvçš„æœ¬è´¨)ã€‚</p><h4 id="6-3-å­˜å‚¨å’Œå¤åˆ¶æ–‡ä»¶">6.3 å­˜å‚¨å’Œå¤åˆ¶æ–‡ä»¶</h4><ul><li>å¯¹äºæ–‡ä»¶å­˜å‚¨</li><li>(1).è¯»å–GDTï¼Œæ‰¾åˆ°å„ä¸ª(æˆ–éƒ¨åˆ†)å—ç»„imapä¸­æœªä½¿ç”¨çš„inodeå·ï¼Œå¹¶ä¸ºå¾…å­˜å‚¨æ–‡ä»¶åˆ†é…inodeå·;</li><li>(2).åœ¨inode tableä¸­å®Œå–„è¯¥inodeå·æ‰€åœ¨è¡Œçš„è®°å½•;</li><li>(3).åœ¨ç›®å½•çš„data blockä¸­æ·»åŠ ä¸€æ¡è¯¥æ–‡ä»¶çš„ç›¸å…³è®°å½•;</li><li>(4).å°†æ•°æ®å¡«å……åˆ°data blockä¸­ã€‚</li><li>æ³¨æ„ï¼Œå¡«å……åˆ°data blockä¸­çš„æ—¶å€™ä¼šè°ƒç”¨blockåˆ†é…å™¨ï¼šä¸€æ¬¡åˆ†é…4KBå¤§å°çš„blockæ•°é‡ï¼Œå½“å¡«å……å®Œ4KBçš„data blockåä¼šç»§ç»­è°ƒç”¨blockåˆ†é…å™¨åˆ†é…4KBçš„blockï¼Œç„¶åå¾ªç¯ç›´åˆ°å¡«å……å®Œæ‰€æœ‰æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå­˜å‚¨ä¸€ä¸ª100Mçš„æ–‡ä»¶éœ€è¦è°ƒç”¨blockåˆ†é…å™¨100*1024/4=25600æ¬¡ã€‚</li><li>å¦ä¸€æ–¹é¢ï¼Œåœ¨blockåˆ†é…å™¨åˆ†é…blockæ—¶ï¼Œblockåˆ†é…å™¨å¹¶ä¸çŸ¥é“çœŸæ­£æœ‰å¤šå°‘blockè¦åˆ†é…ï¼Œåªæ˜¯æ¯æ¬¡éœ€è¦åˆ†é…æ—¶å°±åˆ†é…ï¼Œåœ¨æ¯å­˜å‚¨ä¸€ä¸ªdata blockå‰ï¼Œå°±å»bmapä¸­æ ‡è®°ä¸€æ¬¡è¯¥blockå·²ä½¿ç”¨ï¼Œå®ƒæ— æ³•å®ç°ä¸€æ¬¡æ ‡è®°å¤šä¸ªbmapä½ã€‚è¿™ä¸€ç‚¹åœ¨ext4ä¸­è¿›è¡Œäº†ä¼˜åŒ–ã€‚</li><li>(5)å¡«å……å®Œä¹‹åï¼Œå»inode tableä¸­æ›´æ–°è¯¥æ–‡ä»¶inodeè®°å½•ä¸­æŒ‡å‘data blockçš„å¯»å€æŒ‡é’ˆã€‚</li><li>å¯¹äºå¤åˆ¶ï¼Œå®Œå…¨å°±æ˜¯å¦ä¸€ç§æ–¹å¼çš„å­˜å‚¨æ–‡ä»¶ã€‚æ­¥éª¤å’Œå­˜å‚¨æ–‡ä»¶çš„æ­¥éª¤ä¸€æ ·ã€‚</li></ul><h3 id="7-å¤šæ–‡ä»¶ç³»ç»Ÿå…³è”">7.å¤šæ–‡ä»¶ç³»ç»Ÿå…³è”</h3><p>åœ¨å•ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æ“ä½œå’Œå¤šæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ“ä½œæœ‰æ‰€ä¸åŒã€‚æœ¬æ–‡å°†å¯¹æ­¤åšå‡ºéå¸¸è¯¦ç»†çš„è¯´æ˜ã€‚</p><h4 id="7-1-æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ®Šæ€§">7.1 æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ®Šæ€§</h4><p>è¿™é‡Œè¦æ˜ç¡®çš„æ˜¯ï¼Œä»»ä½•ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè¦åœ¨Linuxä¸Šèƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå¿…é¡»æŒ‚è½½åœ¨æŸä¸ªå·²ç»æŒ‚è½½å¥½çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„æŸä¸ªç›®å½•ä¸‹ï¼Œä¾‹å¦‚/dev/cdromæŒ‚è½½åœ¨/mntä¸Šï¼Œ/mntç›®å½•æœ¬èº«æ˜¯åœ¨&quot;/â€œæ–‡ä»¶ç³»ç»Ÿä¸‹çš„ã€‚è€Œä¸”ä»»æ„æ–‡ä»¶ç³»ç»Ÿçš„ä¸€çº§æŒ‚è½½ç‚¹å¿…é¡»æ˜¯åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŸä¸ªç›®å½•ä¸‹ï¼Œå› ä¸ºåªæœ‰â€/&quot;æ˜¯è‡ªå¼•ç”¨çš„ã€‚è¿™é‡Œè¦è¯´æ˜æŒ‚è½½ç‚¹çš„çº§åˆ«å’Œè‡ªå¼•ç”¨çš„æ¦‚å¿µã€‚</p><p>å‡å¦‚/dev/sdb1æŒ‚è½½åœ¨/mydataä¸Šï¼Œ/dev/cdromæŒ‚è½½åœ¨/mydata/cdromä¸Šï¼Œé‚£ä¹ˆ/mydataå°±æ˜¯ä¸€çº§æŒ‚è½½ç‚¹ï¼Œæ­¤æ—¶/mydataå·²ç»æ˜¯æ–‡ä»¶ç³»ç»Ÿ/dev/sdb1çš„å…¥å£äº†ï¼Œè€Œ/dev/cdromæ‰€æŒ‚è½½çš„ç›®å½•/mydata/cdromæ˜¯æ–‡ä»¶ç³»ç»Ÿ/dev/sdb1ä¸­çš„æŸä¸ªç›®å½•ï¼Œé‚£ä¹ˆ/mydata/cdromå°±æ˜¯äºŒçº§æŒ‚è½½ç‚¹ã€‚ä¸€çº§æŒ‚è½½ç‚¹å¿…é¡»åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸‹ï¼Œæ‰€ä»¥å¯ç®€è¿°ä¸ºï¼šæ–‡ä»¶ç³»ç»Ÿ2æŒ‚è½½åœ¨æ–‡ä»¶ç³»ç»Ÿ1ä¸­çš„æŸä¸ªç›®å½•ä¸‹ï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿ1åˆæŒ‚è½½åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„æŸä¸ªç›®å½•ä¸‹ã€‚</p><p>å†è§£é‡Šè‡ªå¼•ç”¨ã€‚é¦–å…ˆè¦è¯´çš„æ˜¯ï¼Œè‡ªå¼•ç”¨çš„åªèƒ½æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿè¡¨ç°å½¢å¼æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ‰€ä»¥è‡ªå¼•ç”¨æ˜¯æŒ‡è¯¥ç›®å½•çš„data blockä¸­ï¼Œ&quot;.â€œå’Œâ€â€¦&quot;çš„è®°å½•ä¸­çš„inodeæŒ‡é’ˆéƒ½æŒ‡å‘inode tableä¸­åŒä¸€ä¸ªinodeè®°å½•ï¼Œæ‰€ä»¥å®ƒä»¬inodeå·æ˜¯ç›¸åŒçš„ï¼Œå³äº’ä¸ºç¡¬é“¾æ¥ã€‚è€Œæ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯å”¯ä¸€å¯ä»¥è‡ªå¼•ç”¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi /]<span class="comment"># ll -ai / </span></span><br><span class="line">total 102 </span><br><span class="line"> 2 dr-xr-xr-x. 22 root root 4096 Jun 6 18:13 . </span><br><span class="line"> 2 dr-xr-xr-x. 22 root root 4096 Jun 6 18:13 ..  </span><br></pre></td></tr></table></figure><p>ç”±æ­¤ä¹Ÿèƒ½è§£é‡Šcd /.å’Œcd /â€¦çš„ç»“æœéƒ½è¿˜æ˜¯åœ¨æ ¹ä¸‹ï¼Œè¿™æ˜¯è‡ªå¼•ç”¨æœ€ç›´æ¥çš„è¡¨ç°å½¢å¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi tmp]<span class="comment"># cd /. </span></span><br><span class="line">[root@xuexi /]<span class="comment"># </span></span><br><span class="line">[root@xuexi tmp]<span class="comment"># cd /.. </span></span><br><span class="line">[root@xuexi /]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œæ ¹ç›®å½•ä¸‹çš„&quot;.â€œå’Œâ€â€¦â€œéƒ½æ˜¯â€/â€œç›®å½•çš„ç¡¬é“¾æ¥ï¼Œä¸”å…¶datablockä¸­ä¸è®°å½•åä¸ºâ€/&quot;çš„æ¡ç›®ï¼Œå› æ­¤é™¤å»æ ¹ç›®å½•ä¸‹å­ç›®å½•æ•°åçš„ç¡¬é“¾æ¥æ•°ä¸º2ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server2 tmp]<span class="comment"># a=$(ls -ld / | awk &#x27;&#123;print $2&#125;&#x27;) </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># b=$(ls -l / | grep &quot;^d&quot; |wc -l) </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># echo $((a - b)) </span></span><br><span class="line">2</span><br></pre></td></tr></table></figure><h4 id="7-2-æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„ç»†èŠ‚">7.2 æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„ç»†èŠ‚</h4><p>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿåˆ°æŸä¸ªç›®å½•ä¸‹ï¼Œä¾‹å¦‚&quot;mount /dev/cdrom /mnt&quot;ï¼ŒæŒ‚è½½æˆåŠŸå/mntç›®å½•ä¸­çš„æ–‡ä»¶å…¨éƒ½æš‚æ—¶ä¸å¯è§äº†ï¼Œä¸”æŒ‚è½½åæƒé™å’Œæ‰€æœ‰è€…(å¦‚æœæŒ‡å®šå…è®¸æ™®é€šç”¨æˆ·æŒ‚è½½)ç­‰çš„éƒ½æ”¹å˜äº†ï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆå—?</p><p>ä¸‹é¢å°±ä»¥é€šè¿‡&quot;mount /dev/cdrom /mnt&quot;ä¸ºä¾‹ï¼Œè¯¦ç»†è¯´æ˜æŒ‚è½½è¿‡ç¨‹ä¸­æ¶‰åŠçš„ç»†èŠ‚ã€‚</p><p>åœ¨å°†æ–‡ä»¶ç³»ç»Ÿ/dev/cdrom(æ­¤å¤„æš‚ä¸”è®¤ä¸ºå®ƒæ˜¯æ–‡ä»¶ç³»ç»Ÿ)æŒ‚è½½åˆ°æŒ‚è½½ç‚¹/mntä¹‹å‰ï¼ŒæŒ‚è½½ç‚¹/mntæ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªç›®å½•ï¼Œ&quot;/&quot;çš„data blockä¸­è®°å½•äº†/mntçš„ä¸€äº›ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬inodeæŒ‡é’ˆinode_nï¼Œè€Œåœ¨inode tableä¸­ï¼Œ/mntå¯¹åº”çš„inodeè®°å½•ä¸­åˆå­˜å‚¨äº†blockæŒ‡é’ˆblock_nï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªæŒ‡é’ˆè¿˜æ˜¯æ™®é€šçš„æŒ‡é’ˆã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426131810028.png" alt="image-20240426131810028"></p><p>å½“æ–‡ä»¶ç³»ç»Ÿ/dev/cdromæŒ‚è½½åˆ°/mntä¸Šåï¼Œ/mntæ­¤æ—¶å°±å·²ç»æˆä¸ºå¦ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å…¥å£äº†ï¼Œå› æ­¤å®ƒéœ€è¦è¿æ¥ä¸¤è¾¹æ–‡ä»¶ç³»ç»Ÿçš„inodeå’Œdata blockã€‚ä½†æ˜¯å¦‚ä½•è¿æ¥å‘¢ï¼Ÿå¦‚ä¸‹å›¾ã€‚ã€å¥½å›¾ã€‘</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426131959318.png" alt="image-20240426131959318"></p><p>åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„inode tableä¸­ï¼Œä¸º/mnté‡æ–°åˆ†é…ä¸€ä¸ªinodeè®°å½•mï¼Œè¯¥è®°å½•çš„blockæŒ‡é’ˆblock_mæŒ‡å‘æ–‡ä»¶ç³»ç»Ÿ/dev/cdromä¸­çš„data blockã€‚æ—¢ç„¶ä¸º/mntåˆ†é…äº†æ–°çš„inodeè®°å½•mï¼Œé‚£ä¹ˆåœ¨&quot;/&quot;ç›®å½•çš„data blockä¸­ï¼Œä¹Ÿéœ€è¦ä¿®æ”¹å…¶inodeæŒ‡é’ˆä¸ºinode_mä»¥æŒ‡å‘mè®°å½•ã€‚åŒæ—¶ï¼ŒåŸæ¥inode tableä¸­çš„inodeè®°å½•nå°±è¢«æ ‡è®°ä¸ºæš‚æ—¶ä¸å¯ç”¨ã€‚</p><p>block_mæŒ‡å‘çš„æ˜¯æ–‡ä»¶ç³»ç»Ÿ/dev/cdromçš„data blockï¼Œæ‰€ä»¥ä¸¥æ ¼è¯´èµ·æ¥ï¼Œé™¤äº†/mntçš„å…ƒæ•°æ®ä¿¡æ¯å³inodeè®°å½•mè¿˜åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œ/mntçš„data blockå·²ç»æ˜¯åœ¨/dev/cdromä¸­çš„äº†ã€‚è¿™å°±æ˜¯æŒ‚è½½æ–°æ–‡ä»¶ç³»ç»Ÿåå®ç°çš„è·¨æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå°†æŒ‚è½½ç‚¹çš„å…ƒæ•°æ®ä¿¡æ¯å’Œæ•°æ®ä¿¡æ¯åˆ†åˆ«å­˜å‚¨åœ¨ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¸Šã€‚</p><p>æŒ‚è½½å®Œæˆåï¼Œå°†åœ¨/proc/self/{mounts,mountstats,mountinfo}è¿™ä¸‰ä¸ªæ–‡ä»¶ä¸­å†™å…¥æŒ‚è½½è®°å½•å’Œç›¸å…³çš„æŒ‚è½½ä¿¡æ¯ï¼Œå¹¶ä¼šå°†/proc/self/mountsä¸­çš„ä¿¡æ¯åŒæ­¥åˆ°/etc/mtabæ–‡ä»¶ä¸­ï¼Œå½“ç„¶ï¼Œå¦‚æœæŒ‚è½½æ—¶åŠ äº†-nå‚æ•°ï¼Œå°†ä¸ä¼šåŒæ­¥åˆ°/etc/mtabã€‚</p><p>è€Œå¸è½½æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶å®è´¨æ˜¯ç§»é™¤ä¸´æ—¶æ–°å»ºçš„inodeè®°å½•(å½“ç„¶ï¼Œåœ¨ç§»é™¤å‰ä¼šæ£€æŸ¥æ˜¯å¦æ­£åœ¨ä½¿ç”¨)åŠå…¶æŒ‡é’ˆï¼Œå¹¶å°†æŒ‡é’ˆæŒ‡å›åŸæ¥çš„inodeè®°å½•ï¼Œè¿™æ ·inodeè®°å½•ä¸­çš„blockæŒ‡é’ˆä¹Ÿå°±åŒæ—¶ç”Ÿæ•ˆè€Œæ‰¾å›å¯¹åº”çš„data blockäº†ã€‚ç”±äºå¸è½½åªæ˜¯ç§»é™¤inodeè®°å½•ï¼Œæ‰€ä»¥ä½¿ç”¨æŒ‚è½½ç‚¹å’Œæ–‡ä»¶ç³»ç»Ÿéƒ½å¯ä»¥å®ç°å¸è½½ï¼Œå› ä¸ºå®ƒä»¬æ˜¯è”ç³»åœ¨ä¸€èµ·çš„ã€‚</p><p>ä¸‹é¢æ˜¯åˆ†ææˆ–ç»“è®º</p><p>(1).æŒ‚è½½ç‚¹æŒ‚è½½æ—¶çš„inodeè®°å½•æ˜¯æ–°åˆ†é…çš„ã€‚</p><p># æŒ‚è½½å‰æŒ‚è½½ç‚¹/mntçš„inodeå·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server2 tmp]<span class="comment"># ll -id /mnt </span></span><br><span class="line">100663447 drwxr-xr-x. 2 root root 6 Aug 12 2015 /mnt </span><br><span class="line">[root@server2 tmp]<span class="comment"># mount /dev/cdrom /mnt </span></span><br><span class="line"><span class="comment"># æŒ‚è½½åæŒ‚è½½ç‚¹çš„inodeå· </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># ll -id /mnt  </span></span><br><span class="line">1856 dr-xr-xr-x 8 root root 2048 Dec 10 2015 mnt </span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯ä»¥éªŒè¯ï¼Œinodeå·ç¡®å®æ˜¯é‡æ–°åˆ†é…çš„ã€‚</p><p>(2).æŒ‚è½½åï¼ŒæŒ‚è½½ç‚¹çš„å†…å®¹å°†æš‚æ—¶ä¸å¯è§ã€ä¸å¯ç”¨ï¼Œå¸è½½åæ–‡ä»¶åˆå†æ¬¡å¯è§ã€å¯ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨æŒ‚è½½å‰ï¼Œå‘æŒ‚è½½ç‚¹ä¸­åˆ›å»ºå‡ ä¸ªæ–‡ä»¶ </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># touch /mnt/a.txt </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># mkdir /mnt/abcdir </span></span><br><span class="line"><span class="comment"># æŒ‚è½½ </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># mount /dev/cdrom /mnt </span></span><br><span class="line"><span class="comment"># æŒ‚è½½åï¼ŒæŒ‚è½½ç‚¹ä¸­å°†æ‰¾ä¸åˆ°åˆšåˆ›å»ºçš„æ–‡ä»¶ </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># ll /mnt </span></span><br><span class="line">total 636 </span><br><span class="line">-r--r--r-- 1 root root 14 Dec 10 2015 CentOS_BuildTag </span><br><span class="line">dr-xr-xr-x 3 root root 2048 Dec 10 2015 EFI </span><br><span class="line">-r--r--r-- 1 root root 215 Dec 10 2015 EULA </span><br><span class="line">-r--r--r-- 1 root root 18009 Dec 10 2015 GPL </span><br><span class="line">dr-xr-xr-x 3 root root 2048 Dec 10 2015 images </span><br><span class="line">dr-xr-xr-x 2 root root 2048 Dec 10 2015 isolinux </span><br><span class="line">dr-xr-xr-x 2 root root 2048 Dec 10 2015 LiveOS </span><br><span class="line">dr-xr-xr-x 2 root root 612352 Dec 10 2015 Packages </span><br><span class="line">dr-xr-xr-x 2 root root 4096 Dec 10 2015 repodata </span><br><span class="line">-r--r--r-- 1 root root 1690 Dec 10 2015 RPM-GPG-KEY-CentOS-7 </span><br><span class="line">-r--r--r-- 1 root root 1690 Dec 10 2015 RPM-GPG-KEY-CentOS-Testing-7 </span><br><span class="line">-r--r--r-- 1 root root 2883 Dec 10 2015 TRANS.TBL </span><br><span class="line"><span class="comment"># å¸è½½åï¼ŒæŒ‚è½½ç‚¹/mntä¸­çš„æ–‡ä»¶å°†å†æ¬¡å¯è§ </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># umount /mnt </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># ll /mnt </span></span><br><span class="line">total 0 </span><br><span class="line">drwxr-xr-x 2 root root 6 Jun 9 08:18 abcdir </span><br><span class="line">-rw-r--r-- 1 root root 0 Jun 9 08:18 a.txt </span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥ä¼šè¿™æ ·ï¼Œæ˜¯å› ä¸ºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿåï¼ŒæŒ‚è½½ç‚¹åŸæ¥çš„inodeè®°å½•æš‚æ—¶è¢«æ ‡è®°ä¸ºä¸å¯ç”¨ï¼Œå…³é”®æ˜¯æ²¡æœ‰æŒ‡å‘è¯¥inodeè®°å½•çš„inodeæŒ‡é’ˆäº†ã€‚åœ¨å¸è½½æ–‡ä»¶ç³»ç»Ÿåï¼Œåˆé‡æ–°å¯ç”¨æŒ‚è½½ç‚¹åŸæ¥çš„inodeè®°å½•ï¼Œ&quot;/&quot;ç›®å½•ä¸‹çš„mntçš„inodeæŒ‡é’ˆåˆé‡æ–°æŒ‡å‘è¯¥inodeè®°å½•ã€‚</p><p>(3).æŒ‚è½½åï¼ŒæŒ‚è½½ç‚¹çš„å…ƒæ•°æ®å’Œdata blockæ˜¯åˆ†åˆ«å­˜æ”¾åœ¨ä¸åŒæ–‡ä»¶ç³»ç»Ÿä¸Šçš„ã€‚</p><p>(4).æŒ‚è½½ç‚¹å³ä½¿åœ¨æŒ‚è½½åï¼Œä¹Ÿè¿˜æ˜¯å±äºæºæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ã€‚</p><h4 id="7-3-å¤šæ–‡ä»¶ç³»ç»Ÿæ“ä½œå…³è”">7.3 å¤šæ–‡ä»¶ç³»ç»Ÿæ“ä½œå…³è”</h4><p>å‡å¦‚ä¸‹å›¾ä¸­çš„åœ†ä»£è¡¨ä¸€å—ç¡¬ç›˜ï¼Œå…¶ä¸­åˆ’åˆ†äº†3ä¸ªåŒºå³3ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚å…¶ä¸­æ ¹æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œ/mntæ˜¯å¦ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸAçš„å…¥å£ï¼ŒAæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨/mntä¸Šï¼Œ/mnt/cdromä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸBçš„å…¥å£ï¼ŒBæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨/mnt/cdromä¸Šã€‚æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½ç»´æŠ¤äº†ä¸€äº›inode tableï¼Œè¿™é‡Œå‡è®¾å›¾ä¸­çš„inode tableæ˜¯æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæ‰€æœ‰å—ç»„ä¸­çš„inode tableçš„é›†åˆè¡¨ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426132902871.png" alt="image-20240426132902871"></p><p>å¦‚ä½•è¯»å–/var/log/messageså‘¢?è¿™æ˜¯å’Œ&quot;/&quot;åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶è¯»å–ï¼Œåœ¨å‰é¢å•æ–‡ä»¶ç³»ç»Ÿä¸­å·²ç»è¯¦ç»†è¯´æ˜äº†ã€‚</p><p>ä½†å¦‚ä½•è¯»å–Aæ–‡ä»¶ç³»ç»Ÿä¸­çš„/mnt/a.logå‘¢?é¦–å…ˆï¼Œä»æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰¾åˆ°/mntçš„inodeè®°å½•ï¼Œè¿™æ˜¯å•æ–‡ä»¶ç³»ç»Ÿå†…çš„æŸ¥æ‰¾;ç„¶åæ ¹æ®æ­¤inodeè®°å½•çš„blockæŒ‡é’ˆï¼Œå®šä½åˆ°/mntçš„data blockä¸­ï¼Œè¿™äº›blockæ˜¯Aæ–‡ä»¶ç³»ç»Ÿçš„data block;ç„¶åä»/mntçš„data blockä¸­è¯»å–a.logè®°å½•ï¼Œå¹¶æ ¹æ®a.logçš„inodeæŒ‡é’ˆå®šä½åˆ°Aæ–‡ä»¶ç³»ç»Ÿçš„inode tableä¸­å¯¹åº”a.logçš„inodeè®°å½•;æœ€åä»æ­¤inodeè®°å½•çš„blockæŒ‡é’ˆæ‰¾åˆ°a.logçš„data blockã€‚è‡³æ­¤ï¼Œå°±èƒ½è¯»å–åˆ°/mnt/a.logæ–‡ä»¶çš„å†…å®¹ã€‚</p><p>ä¸‹å›¾èƒ½æ›´å®Œæ•´çš„æè¿°ä¸Šè¿°è¿‡ç¨‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133033004.png" alt="image-20240426133033004"></p><p>é‚£ä¹ˆåˆå¦‚ä½•è¯»å–/mnt/cdromä¸­çš„/mnt/cdrom/a.rpmå‘¢?è¿™é‡Œcdromä»£è¡¨çš„æ–‡ä»¶ç³»ç»ŸBæŒ‚è½½ç‚¹ä½äº/mntä¸‹ï¼Œæ‰€ä»¥åˆå¤šäº†ä¸€ä¸ªæ­¥éª¤ã€‚å…ˆæ‰¾åˆ°&quot;/&quot;ï¼Œå†æ‰¾åˆ°æ ¹ä¸­çš„mntï¼Œè¿›å…¥åˆ°mntæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ‰¾åˆ°cdromçš„data blockï¼Œå†è¿›å…¥åˆ°cdromæ‰¾åˆ°a.rpmã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œmntç›®å½•æ–‡ä»¶å­˜æ”¾ä½ç½®æ˜¯æ ¹ï¼Œcdromç›®å½•æ–‡ä»¶å­˜æ”¾ä½ç½®æ˜¯mntï¼Œæœ€åa.rpmå­˜æ”¾çš„ä½ç½®æ‰æ˜¯cdromã€‚</p><p>ç»§ç»­å®Œå–„ä¸Šå›¾ã€‚å¦‚ä¸‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133050365.png" alt="image-20240426133050365"></p><h3 id="8-ext3æ–‡ä»¶ç³»ç»Ÿçš„æ—¥å¿—åŠŸèƒ½">8.ext3æ–‡ä»¶ç³»ç»Ÿçš„æ—¥å¿—åŠŸèƒ½</h3><p>ç›¸æ¯”ext2æ–‡ä»¶ç³»ç»Ÿï¼Œext3å¤šäº†ä¸€ä¸ªæ—¥å¿—åŠŸèƒ½ã€‚</p><p>åœ¨ext2æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œåªæœ‰ä¸¤ä¸ªåŒºï¼šæ•°æ®åŒºå’Œå…ƒæ•°æ®åŒºã€‚å¦‚æœæ­£åœ¨å‘data blockä¸­å¡«å……æ•°æ®æ—¶çªç„¶æ–­ç”µï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡å¯åŠ¨æ—¶å°±ä¼šæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿä¸­æ•°æ®å’ŒçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œè¿™æ®µæ£€æŸ¥å’Œä¿®å¤å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡æ—¶é—´ï¼Œç”šè‡³æ£€æŸ¥åæ— æ³•ä¿®å¤ã€‚ä¹‹æ‰€ä»¥ä¼šè¿™æ ·æ˜¯å› ä¸ºæ–‡ä»¶ç³»ç»Ÿåœ¨çªç„¶æ–­ç”µåï¼Œå®ƒä¸çŸ¥é“ä¸Šæ¬¡æ­£åœ¨å­˜å‚¨çš„æ–‡ä»¶çš„blockä»å“ªé‡Œå¼€å§‹ã€å“ªé‡Œç»“æŸï¼Œæ‰€ä»¥å®ƒä¼šæ‰«ææ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ’é™¤(ä¹Ÿè®¸æ˜¯è¿™æ ·æ£€æŸ¥çš„å§)ã€‚</p><p>è€Œåœ¨åˆ›å»ºext3æ–‡ä»¶ç³»ç»Ÿæ—¶ä¼šåˆ’åˆ†ä¸‰ä¸ªåŒºï¼šæ•°æ®åŒºã€æ—¥å¿—åŒºå’Œå…ƒæ•°æ®åŒºã€‚æ¯æ¬¡å­˜å‚¨æ•°æ®æ—¶ï¼Œå…ˆåœ¨æ—¥å¿—åŒºä¸­è¿›è¡Œext2ä¸­å…ƒæ•°æ®åŒºçš„æ´»åŠ¨ï¼Œç›´åˆ°æ–‡ä»¶å­˜å‚¨å®Œæˆåæ ‡è®°ä¸Šcommitæ‰å°†æ—¥å¿—åŒºä¸­çš„æ•°æ®è½¬å­˜åˆ°å…ƒæ•°æ®åŒºã€‚å½“å­˜å‚¨æ–‡ä»¶æ—¶çªç„¶æ–­ç”µï¼Œä¸‹ä¸€æ¬¡æ£€æŸ¥ä¿®å¤æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œåªéœ€è¦æ£€æŸ¥æ—¥å¿—åŒºçš„è®°å½•ï¼Œå°†bmapå¯¹åº”çš„data blockæ ‡è®°ä¸ºæœªä½¿ç”¨ï¼Œå¹¶æŠŠinodeå·æ ‡è®°æœªä½¿ç”¨ï¼Œè¿™æ ·å°±ä¸éœ€è¦æ‰«ææ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿè€Œè€—è´¹å¤§é‡æ—¶é—´ã€‚</p><p>è™½è¯´ext3ç›¸æ¯”ext2å¤šäº†ä¸€ä¸ªæ—¥å¿—åŒºè½¬å†™å…ƒæ•°æ®åŒºçš„åŠ¨ä½œè€Œå¯¼è‡´ext3ç›¸æ¯”ext2æ€§èƒ½è¦å·®ä¸€ç‚¹ï¼Œç‰¹åˆ«æ˜¯å†™ä¼—å¤šå°æ–‡ä»¶æ—¶ã€‚ä½†æ˜¯ç”±äºext3å…¶ä»–æ–¹é¢çš„ä¼˜åŒ–ä½¿å¾—ext3å’Œext2æ€§èƒ½å‡ ä¹æ²¡æœ‰å·®è·ã€‚</p><h3 id="9-ext4æ–‡ä»¶ç³»ç»Ÿ">9.ext4æ–‡ä»¶ç³»ç»Ÿ</h3><p>å›é¡¾å‰é¢å…³äºext2å’Œext3æ–‡ä»¶ç³»ç»Ÿçš„å­˜å‚¨æ ¼å¼ï¼Œå®ƒä½¿ç”¨blockä¸ºå­˜å‚¨å•å…ƒï¼Œæ¯ä¸ªblockä½¿ç”¨bmapä¸­çš„ä½æ¥æ ‡è®°æ˜¯å¦ç©ºé—²ï¼Œå°½ç®¡ä½¿ç”¨åˆ’åˆ†å—ç»„çš„æ–¹æ³•ä¼˜åŒ–æé«˜äº†æ•ˆç‡ï¼Œä½†æ˜¯ä¸€ä¸ªå—ç»„å†…éƒ¨ä»ç„¶ä½¿ç”¨bmapæ¥æ ‡è®°è¯¥å—ç»„å†…çš„blockã€‚å¯¹äºä¸€ä¸ªå·¨å¤§çš„æ–‡ä»¶ï¼Œæ‰«ææ•´ä¸ªbmapéƒ½å°†æ˜¯ä¸€ä»¶æµ©å¤§çš„å·¥ç¨‹ã€‚å¦å¤–åœ¨inodeå¯»å€æ–¹é¢ï¼Œext2/3ä½¿ç”¨ç›´æ¥å’Œé—´æ¥çš„å¯»å€æ–¹å¼ï¼Œå¯¹äºä¸‰çº§é—´æ¥æŒ‡é’ˆï¼Œå¯èƒ½è¦éå†çš„æŒ‡é’ˆæ•°é‡æ˜¯éå¸¸éå¸¸å·¨å¤§çš„ã€‚</p><p>ext4æ–‡ä»¶ç³»ç»Ÿçš„æœ€å¤§ç‰¹ç‚¹æ˜¯åœ¨ext3çš„åŸºç¡€ä¸Šä½¿ç”¨åŒº(extentï¼Œæˆ–ç§°ä¸ºæ®µ)çš„æ¦‚å¿µæ¥ç®¡ç†ã€‚ä¸€ä¸ªextentå°½å¯èƒ½çš„åŒ…å«ç‰©ç†ä¸Šè¿ç»­çš„ä¸€å †blockã€‚inodeå¯»å€æ–¹é¢ä¹Ÿä¸€æ ·ä½¿ç”¨åŒºæ®µæ ‘çš„æ–¹å¼è¿›è¡Œäº†æ”¹è¿›ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒEXT4ä¸å†ä½¿ç”¨EXT3çš„block mappingåˆ†é…æ–¹å¼ ï¼Œè€Œæ”¹ä¸ºExtentæ–¹å¼åˆ†é…ã€‚</p><p>ä»¥ä¸‹æ˜¯ext4æ–‡ä»¶ç³»ç»Ÿä¸­ä¸€ä¸ªæ–‡ä»¶çš„inodeå±æ€§ç¤ºä¾‹ï¼Œæ³¨æ„æœ€åä¸¤è¡Œçš„EXTENTSã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Inode: 12 Type: regular Mode: 0644 Flags: 0x80000 </span><br><span class="line">Generation: 476513974 Version: 0x00000000:00000001 </span><br><span class="line">User: 0 Group: 0 Size: 11 </span><br><span class="line">File ACL: 0 Directory ACL: 0 </span><br><span class="line">Links: 1 Blockcount: 8 </span><br><span class="line">Fragment: Address: 0 Number: 0 Size: 0 </span><br><span class="line"> ctime: 0x5b628ca0:491d6224 -- Thu Aug 2 12:46:24 2018 </span><br><span class="line"> atime: 0x5b628ca0:491d6224 -- Thu Aug 2 12:46:24 2018 </span><br><span class="line"> mtime: 0x5b628ca0:491d6224 -- Thu Aug 2 12:46:24 2018 </span><br><span class="line">crtime: 0x5b628ca0:491d6224 -- Thu Aug 2 12:46:24 2018 </span><br><span class="line">Size of extra inode fields: 28 </span><br><span class="line">EXTENTS: </span><br><span class="line">(0):33409 </span><br></pre></td></tr></table></figure><p>(1). å…³äºEXT4çš„ç»“æ„ç‰¹å¾</p><p>EXT4åœ¨æ€»ä½“ç»“æ„ä¸Šä¸EXT3ç›¸ä¼¼ï¼Œå¤§çš„åˆ†é…æ–¹å‘éƒ½æ˜¯åŸºäºç›¸åŒå¤§å°çš„å—ç»„ï¼Œæ¯ä¸ªå—ç»„å†…åˆ†é…å›ºå®šæ•°é‡çš„inodeã€å¯èƒ½çš„superblock(æˆ–å¤‡ä»½)åŠGDTã€‚</p><p>EXT4çš„inode ç»“æ„åšäº†é‡å¤§æ”¹å˜ï¼Œä¸ºå¢åŠ æ–°çš„ä¿¡æ¯ï¼Œå¤§å°ç”±EXT3çš„128å­—èŠ‚å¢åŠ åˆ°é»˜è®¤çš„256å­—èŠ‚ï¼ŒåŒæ—¶inodeå¯»å€ç´¢å¼•ä¸å†ä½¿ç”¨EXT3çš„&quot;12ä¸ªç›´æ¥å¯»å€å—+1ä¸ªä¸€çº§é—´æ¥å¯»å€å—+1ä¸ªäºŒçº§é—´æ¥å¯»å€å—+1ä¸ªä¸‰çº§é—´æ¥å¯»å€å—&quot;çš„ç´¢å¼•æ¨¡å¼ï¼Œè€Œæ”¹ä¸º4ä¸ªExtentç‰‡æ–­æµï¼Œæ¯ä¸ªç‰‡æ–­æµè®¾å®šç‰‡æ–­çš„èµ·å§‹blockå·åŠè¿ç»­çš„blockæ•°é‡(æœ‰å¯èƒ½ç›´æ¥æŒ‡å‘æ•°æ®åŒºï¼Œä¹Ÿæœ‰å¯èƒ½æŒ‡å‘ç´¢å¼•å—åŒº)ã€‚</p><p>ç‰‡æ®µæµå³ä¸‹å›¾ä¸­ç´¢å¼•èŠ‚ç‚¹(inde node block)éƒ¨åˆ†çš„ç»¿è‰²åŒºåŸŸï¼Œæ¯ä¸ª15å­—èŠ‚ï¼Œå…±60å­—èŠ‚ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133212168.png" alt="image-20240426133212168"></p><p>(2). EXT4åˆ é™¤æ•°æ®çš„ç»“æ„æ›´æ”¹ã€‚</p><p>EXT4åˆ é™¤æ•°æ®åï¼Œä¼šä¾æ¬¡é‡Šæ”¾æ–‡ä»¶ç³»ç»Ÿbitmapç©ºé—´ä½ã€æ›´æ–°ç›®å½•ç»“æ„ã€é‡Šæ”¾inodeç©ºé—´ä½ã€‚</p><p>(3). ext4ä½¿ç”¨å¤šblockåˆ†é…æ–¹å¼ã€‚</p><p>åœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œext3ä¸­çš„blockåˆ†é…å™¨ä¸€æ¬¡åªèƒ½åˆ†é…4KBå¤§å°çš„Blockæ•°é‡ï¼Œè€Œä¸”æ¯å­˜å‚¨ä¸€ä¸ªblockå‰å°±æ ‡è®°ä¸€æ¬¡bmapã€‚å‡å¦‚å­˜å‚¨1Gçš„æ–‡ä»¶ï¼Œblocksizeæ˜¯4KBï¼Œé‚£ä¹ˆæ¯å­˜å‚¨å®Œä¸€ä¸ªBlockå°±å°†è°ƒç”¨ä¸€æ¬¡blockåˆ†é…å™¨ï¼Œå³è°ƒç”¨çš„æ¬¡æ•°ä¸º1024 * 1024 / 4KB=262144æ¬¡ï¼Œæ ‡è®°bmapçš„æ¬¡æ•°ä¹Ÿä¸º1024 * 1024/4=262144æ¬¡ã€‚</p><p>è€Œåœ¨ext4ä¸­æ ¹æ®åŒºæ®µæ¥åˆ†é…ï¼Œå¯ä»¥å®ç°è°ƒç”¨ä¸€æ¬¡blockåˆ†é…å™¨å°±åˆ†é…ä¸€å †è¿ç»­çš„blockï¼Œå¹¶åœ¨å­˜å‚¨è¿™ä¸€å †blockå‰ä¸€æ¬¡æ€§æ ‡è®°å¯¹åº”çš„bmapã€‚è¿™å¯¹äºå¤§æ–‡ä»¶æ¥è¯´æå¤§çš„æå‡äº†å­˜å‚¨æ•ˆç‡ã€‚</p><h3 id="10-extç±»çš„æ–‡ä»¶ç³»ç»Ÿçš„ç¼ºç‚¹">10.extç±»çš„æ–‡ä»¶ç³»ç»Ÿçš„ç¼ºç‚¹</h3><p>æœ€å¤§çš„ç¼ºç‚¹æ˜¯å®ƒåœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™å°±åˆ’åˆ†å¥½ä¸€åˆ‡éœ€è¦åˆ’åˆ†çš„ä¸œè¥¿ï¼Œä»¥åç”¨åˆ°çš„æ—¶å€™å¯ä»¥ç›´æ¥è¿›è¡Œåˆ†é…ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸æ”¯æŒåŠ¨æ€åˆ’åˆ†å’ŒåŠ¨æ€åˆ†é…ã€‚å¯¹äºè¾ƒå°çš„åˆ†åŒºæ¥è¯´é€Ÿåº¦è¿˜å¥½ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªè¶…å¤§çš„ç£ç›˜ï¼Œé€Ÿåº¦æ˜¯ææ…¢ææ…¢çš„ã€‚ä¾‹å¦‚å°†ä¸€ä¸ªå‡ åTçš„ç£ç›˜é˜µåˆ—æ ¼å¼åŒ–ä¸ºext4æ–‡ä»¶ç³»ç»Ÿï¼Œå¯èƒ½ä½ ä¼šå› æ­¤è€Œå¤±å»ä¸€åˆ‡è€å¿ƒã€‚</p><p>é™¤äº†æ ¼å¼åŒ–é€Ÿåº¦è¶…æ…¢ä»¥å¤–ï¼Œext4æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯éå¸¸å¯å–çš„ã€‚å½“ç„¶ï¼Œä¸åŒå…¬å¸å¼€å‘çš„æ–‡ä»¶ç³»ç»Ÿéƒ½å„æœ‰ç‰¹è‰²ï¼Œæœ€ä¸»è¦çš„è¿˜æ˜¯æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</p><h3 id="11-è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸVFS">11.è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸVFS</h3><p>æ¯ä¸€ä¸ªåˆ†åŒºæ ¼å¼åŒ–åéƒ½å¯ä»¥å»ºç«‹ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ŒLinuxä¸Šå¯ä»¥è¯†åˆ«å¾ˆå¤šç§æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•è¯†åˆ«çš„å‘¢?å¦å¤–ï¼Œåœ¨æˆ‘ä»¬æ“ä½œåˆ†åŒºä¸­çš„æ–‡ä»¶æ—¶ï¼Œå¹¶æ²¡æœ‰æŒ‡å®šè¿‡å®ƒæ˜¯å“ªä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ï¼Œå„ç§ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå¦‚ä½•è¢«æˆ‘ä»¬ç”¨æˆ·ä»¥æ— å·®åˆ«çš„æ–¹å¼æ“ä½œå‘¢?è¿™å°±æ˜¯è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„ä½œç”¨ã€‚</p><p>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸ºç”¨æˆ·æ“ä½œå„ç§æ–‡ä»¶ç³»ç»Ÿæä¾›äº†é€šç”¨æ¥å£ï¼Œä½¿å¾—ç”¨æˆ·æ‰§è¡Œç¨‹åºæ—¶ä¸éœ€è¦è€ƒè™‘æ–‡ä»¶æ˜¯åœ¨å“ªç§ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œåº”è¯¥ä½¿ç”¨ä»€ä¹ˆæ ·çš„ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œè¯¥æ–‡ä»¶ã€‚æœ‰äº†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œåªè¦å°†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ç¨‹åºè°ƒç”¨VFSçš„ç³»ç»Ÿè°ƒç”¨å°±å¯ä»¥äº†ï¼Œå‰©ä¸‹çš„åŠ¨ä½œç”±VFSæ¥å¸®å¿™å®Œæˆã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133132195.png" alt="image-20240426133132195"></p><h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3><p>æœ¬æ–‡ç« æ‘˜è‡ªï¼š</p><ul><li><a href="https://www.51cto.com/article/603104.html">EXTæ–‡ä»¶ç³»ç»Ÿæœºåˆ¶åŸç†è¯¦è§£</a></li><li><a href="https://www.yuque.com/yukun-srnyg/gxz6gg/hovdfg">æ“ä½œç³»ç»Ÿ-å“ˆå·¥å¤§ææ²»å†›è€å¸ˆ</a></li></ul><h3 id=""></h3>]]></content>
    
    
    <summary type="html">åŠ¨æ‰‹å®ç°æ–‡ä»¶ç³»ç»Ÿ</summary>
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://penge666.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://penge666.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
</feed>
