<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>LinuxæƒŠç¾¤æ•ˆåº”</title>
      <link href="/posts/e5c92e8d.html"/>
      <url>/posts/e5c92e8d.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ¬åšå®¢ä¸»è¦ä»‹ç»ä»€ä¹ˆæ˜¯æƒŠç¾¤ï¼ŒæƒŠç¾¤åœ¨çº¿ç¨‹å’Œè¿›ç¨‹ä¸­çš„å…·ä½“è¡¨ç°ï¼ŒæƒŠç¾¤çš„ç³»ç»Ÿæ¶ˆè€—å’ŒæƒŠç¾¤çš„å¤„ç†æ–¹æ³•ã€‚</p><h2 id="ä»‹ç»">ä»‹ç»</h2><p>æƒŠç¾¤æ•ˆåº”ä¹Ÿæœ‰äººå«åšé›·é¸£ç¾¤ä½“æ•ˆåº”ï¼Œä¸è¿‡å«ä»€ä¹ˆï¼Œç®€è¨€ä¹‹ï¼ŒæƒŠç¾¤ç°è±¡å°±æ˜¯å¤šè¿›ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰åœ¨åŒæ—¶é˜»å¡ç­‰å¾…åŒä¸€ä¸ªäº‹ä»¶çš„æ—¶å€™ï¼ˆä¼‘çœ çŠ¶æ€ï¼‰ï¼Œå¦‚æœç­‰å¾…çš„è¿™ä¸ªäº‹ä»¶å‘ç”Ÿï¼Œé‚£ä¹ˆä»–å°±ä¼šå”¤é†’ç­‰å¾…çš„æ‰€æœ‰è¿›ç¨‹ï¼ˆæˆ–è€…çº¿ç¨‹ï¼‰ï¼Œä½†æ˜¯æœ€ç»ˆå´åªå¯èƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰è·å¾—è¿™ä¸ªæ—¶é—´çš„â€œæ§åˆ¶æƒâ€ï¼Œå¯¹è¯¥äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œè€Œå…¶ä»–è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰è·å–â€œæ§åˆ¶æƒâ€å¤±è´¥ï¼Œåªèƒ½é‡æ–°è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè¿™ç§ç°è±¡å’Œæ€§èƒ½æµªè´¹å°±å«åšæƒŠç¾¤ã€‚</p><p>è¿™é‡Œæ‰“ä¸ªæœ‰è¶£çš„æ¯”æ–¹ï¼Œå°±åƒåœ¨å­¦æ ¡çš„æ¹–é‡Œé¢ç”¨é¢åŒ…ğŸå–‚å¤©é¹…ï¼Œå½“ä½ å¾€ä¸€ç¾¤å¤©é¹…ä¸­é—´æ‰”ä¸€æ’®é¢åŒ…ğŸï¼Œæ‰€æœ‰çš„å¤©é¹…å„è‡ªéƒ½è¢«æƒŠåŠ¨å‰æ¥æŠ¢å¤ºè¿™å¯å£çš„é£Ÿç‰©ï¼Œä½†æ˜¯æœ€ç»ˆæ³¨å®šåªæœ‰ä¸€ä¸ªå¤©é¹…æŠ¢åˆ°é£Ÿç‰©ï¼Œæ²¡æœ‰æŠ¢åˆ°çš„å¤©é¹…åªå¥½å›å»ç»§ç»­ç­‰å¾…ã€‚</p><blockquote><p><strong>æƒŠç¾¤æ•ˆåº”å­˜åœ¨çš„é—®é¢˜</strong></p></blockquote><p>ï¼ˆ1ï¼‰ç³»ç»Ÿå¯¹ç”¨æˆ·è¿›ç¨‹/çº¿ç¨‹é¢‘ç¹åœ°åšæ— æ•ˆçš„è°ƒåº¦ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ç³»ç»Ÿæ€§èƒ½å¤§æ‰“æŠ˜æ‰£ã€‚</p><p>ï¼ˆ2ï¼‰ä¸ºäº†ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¾—åˆ°èµ„æºï¼Œç”¨æˆ·å¿…é¡»å¯¹èµ„æºæ“ä½œè¿›è¡ŒåŠ é”ä¿æŠ¤ï¼Œè¿›ä¸€æ­¥åŠ å¤§äº†ç³»ç»Ÿå¼€é”€ã€‚</p><h2 id="æƒŠç¾¤æ•ˆåº”ç¤ºä¾‹">æƒŠç¾¤æ•ˆåº”ç¤ºä¾‹</h2><h3 id="accept">accept</h3><p>åœºæ™¯ï¼šä¸»è¿›ç¨‹åˆ›å»ºäº†socketã€bindã€listenä¹‹åï¼Œfork()å‡ºæ¥å¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªå­è¿›ç¨‹éƒ½å¼€å§‹å¾ªç¯å¤„ç†ï¼ˆacceptï¼‰è¿™ä¸ªlisten_fdã€‚æ¯ä¸ªè¿›ç¨‹éƒ½é˜»å¡åœ¨acceptä¸Šï¼Œå½“ä¸€ä¸ªæ–°çš„è¿æ¥åˆ°æ¥æ—¶å€™ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼šè¢«å”¤é†’ï¼Œä½†æ˜¯å…¶ä¸­åªæœ‰ä¸€ä¸ªè¿›ç¨‹ä¼šæ¥å—æˆåŠŸï¼Œå…¶ä½™çš†å¤±è´¥ï¼Œé‡æ–°ä¼‘çœ ã€‚</p><p>main.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROCESS_NUM 10</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> connfd;</span><br><span class="line">    <span class="type">int</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuff[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serveraddr;</span><br><span class="line">    serveraddr.sin_family = AF_INET;</span><br><span class="line">    serveraddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    serveraddr.sin_port = <span class="built_in">htons</span>(<span class="number">1234</span>);</span><br><span class="line">    <span class="built_in">bind</span>(fd, (<span class="keyword">struct</span> sockaddr *)&amp;serveraddr, <span class="built_in">sizeof</span>(serveraddr));</span><br><span class="line">    <span class="built_in">listen</span>(fd, <span class="number">1024</span>);</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PROCESS_NUM; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                connfd = <span class="built_in">accept</span>(fd, (<span class="keyword">struct</span> sockaddr *)<span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (connfd == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">snprintf</span>(sendbuff, <span class="built_in">sizeof</span>(sendbuff), <span class="string">&quot;æ¥æ”¶åˆ°acceptäº‹ä»¶çš„è¿›ç¨‹PID = %d\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">send</span>(connfd, sendbuff, <span class="built_in">strlen</span>(sendbuff) + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;process %d accept success\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">                    <span class="built_in">close</span>(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;process %d accept a connection failed: %s\n&quot;</span>, <span class="built_in">getpid</span>(), <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    <span class="built_in">close</span>(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// int status;</span></span><br><span class="line">    <span class="built_in">wait</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/test î‚° g++ main.cpp -o main -pthread</span><br><span class="line">penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/test î‚° strace -f ./main</span><br></pre></td></tr></table></figure><ul><li><a href="https://zhuanlan.zhihu.com/p/180053751">Linuxç¥å™¨straceçš„ä½¿ç”¨æ–¹æ³•åŠå®è·µ</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[pid 171338] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171338] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171338] accept(3, NULL, NULLstrace: Process 171339 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171339</span><br><span class="line">[pid 171339] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171339] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171339] accept(3, NULL, NULLstrace: Process 171340 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171340</span><br><span class="line">[pid 171340] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171340] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171340] accept(3, NULL, NULLstrace: Process 171341 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171341</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171341] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">strace: Process 171342 attached</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171342</span><br><span class="line">[pid 171341] accept(3, NULL, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid 171342] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171342] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171342] accept(3, NULL, NULLstrace: Process 171343 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171343</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171343] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">[pid 171343] accept(3, NULL, NULLstrace: Process 171344 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171344</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171344] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">[pid 171344] accept(3, NULL, NULLstrace: Process 171345 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171345</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171345] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">strace: Process 171346 attached</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171346</span><br><span class="line">[pid 171345] accept(3, NULL, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] <span class="built_in">clone</span>(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD &lt;unfinished ...&gt;</span><br><span class="line">[pid 171346] set_robust_list(0x7fc56358fa20, 24) = 0</span><br><span class="line">[pid 171346] accept(3, NULL, NULLstrace: Process 171347 attached</span><br><span class="line"> &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] &lt;... <span class="built_in">clone</span> resumed&gt;, child_tidptr=0x7fc56358fa10) = 171347</span><br><span class="line">[pid 171347] set_robust_list(0x7fc56358fa20, 24 &lt;unfinished ...&gt;</span><br><span class="line">[pid 171337] wait4(-1,  &lt;unfinished ...&gt;</span><br><span class="line">[pid 171347] &lt;... set_robust_list resumed&gt;) = 0</span><br><span class="line">[pid 171347] accept(3, NULL, NULL &lt;unfinished ...&gt;</span><br></pre></td></tr></table></figure><p>ä¹‹åï¼Œåœ¨å¯ç”¨ä¸€ä¸ªç»ˆç«¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 127.0.0.1 1234</span><br></pre></td></tr></table></figure><p>çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[pid 172089] fstat(1, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0x9), ...&#125;) = 0</span><br><span class="line">[pid 172089] brk(NULL)                  = 0x55f621f04000</span><br><span class="line">[pid 172089] brk(0x55f621f25000)        = 0x55f621f25000</span><br><span class="line">[pid 172089] write(1, <span class="string">&quot;process 172089 accept a connecti&quot;</span>..., 51process 172089 accept a connection failed: Success</span><br><span class="line">) = 51</span><br><span class="line">[pid 172089] close(4)                   = 0</span><br><span class="line">[pid 172089] accept(3, NULL, NULL^C &lt;unfinished ...&gt;</span><br><span class="line">[pid 172098] &lt;... accept resumed&gt;)      = ? ERESTARTSYS (To be restarted <span class="keyword">if</span> SA_RESTART is <span class="built_in">set</span>)</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾å½“telnetè¿æ¥çš„æ—¶å€™åªæœ‰ä¸€ä¸ªè¿›ç¨‹acceptæˆåŠŸï¼Œä¹Ÿå°±è¯´æ˜äº†è¿™é‡Œå¹¶æ²¡æœ‰å‘ç”ŸæƒŠç¾¤ã€‚</p><p>å…¶å®åœ¨linux2.6ç‰ˆæœ¬ä»¥åï¼Œlinuxå†…æ ¸å·²ç»è§£å†³äº†acceptï¼ˆï¼‰å‡½æ•°çš„â€œæƒŠç¾¤â€ç°è±¡ï¼Œå¤§æ¦‚çš„å¤„ç†æ–¹å¼å°±æ˜¯ï¼Œå½“å†…æ ¸æ¥æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·è¿æ¥åï¼Œåªä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰,æ‰€ä»¥å¦‚æœæœåŠ¡å™¨é‡‡ç”¨accepté˜»å¡è°ƒç”¨æ–¹å¼ï¼Œåœ¨æœ€æ–°çš„linuxç³»ç»Ÿä¸­å·²ç»æ²¡æœ‰â€œæƒŠç¾¤æ•ˆåº”â€äº†</p><h3 id="epoll">epoll</h3><p>åœºæ™¯ï¼šå¦‚æœå¤šä¸ªè¿›ç¨‹/çº¿ç¨‹é˜»å¡åœ¨ç›‘å¬åŒä¸€ä¸ªç›‘å¬socket fdçš„epoll_waitä¸Šï¼Œå½“æœ‰ä¸€ä¸ªæ–°çš„è¿æ¥åˆ°æ¥æ—¶ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼šè¢«å”¤é†’ã€‚</p><p>ä¸»è¿›ç¨‹åˆ›å»ºsocketï¼Œbindï¼Œlistenåï¼Œå°†è¯¥socketåŠ å…¥åˆ°epollä¸­ï¼Œç„¶åforkå‡ºå¤šä¸ªå­è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½é˜»å¡åœ¨epoll_waitä¸Šï¼Œå¦‚æœæœ‰äº‹ä»¶åˆ°æ¥ï¼Œåˆ™åˆ¤æ–­è¯¥äº‹ä»¶æ˜¯å¦æ˜¯è¯¥socketä¸Šçš„äº‹ä»¶å¦‚æœæ˜¯ï¼Œè¯´æ˜æœ‰æ–°çš„è¿æ¥åˆ°æ¥äº†ï¼Œåˆ™è¿›è¡Œæ¥å—æ“ä½œã€‚ä¸ºäº†ç®€åŒ–å¤„ç†ï¼Œå¿½ç•¥åç»­çš„è¯»å†™ä»¥åŠå¯¹æ¥å—è¿”å›çš„æ–°çš„å¥—æ¥å­—çš„å¤„ç†ï¼Œç›´æ¥æ–­å¼€è¿æ¥ã€‚<br>main.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROCESS_NUM 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXEVENTS 64</span></span><br><span class="line"><span class="comment">// socketåˆ›å»ºå’Œç»‘å®š</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sock_creat_bind</span><span class="params">(<span class="type">char</span> *port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> sock_fd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serveraddr;</span><br><span class="line">    serveraddr.sin_family = AF_INET;</span><br><span class="line">    serveraddr.sin_port = <span class="built_in">htons</span>(<span class="built_in">atoi</span>(port));</span><br><span class="line">    serveraddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bind</span>(sock_fd, (<span class="keyword">struct</span> sockaddr *)&amp;serveraddr, <span class="built_in">sizeof</span>(serveraddr));</span><br><span class="line">    <span class="keyword">return</span> sock_fd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆ©ç”¨fcntlè®¾ç½®æ–‡ä»¶æˆ–è€…å‡½æ•°è°ƒç”¨çš„çŠ¶æ€æ ‡å¿—</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">make_nonblocking</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> val = <span class="built_in">fcntl</span>(fd, F_GETFL);</span><br><span class="line">    val |= O_NONBLOCK;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(fd, F_SETFL, val) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;fcntl set&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> sock_fd, epoll_fd;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> event;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> *events;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: [port] %s&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((sock_fd = <span class="built_in">sock_creat_bind</span>(argv[<span class="number">1</span>])) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket and bind&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">make_nonblocking</span>(sock_fd) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;make non blocking&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(sock_fd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((epoll_fd = <span class="built_in">epoll_create</span>(MAXEVENTS)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;epoll_create&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    event.data.fd = sock_fd;</span><br><span class="line">    event.events = EPOLLIN;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epoll_fd, EPOLL_CTL_ADD, sock_fd, &amp;event) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;epoll_ctl&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*buffer where events are returned*/</span></span><br><span class="line">    events = <span class="built_in">static_cast</span>&lt;epoll_event *&gt;(<span class="built_in">calloc</span>(MAXEVENTS, <span class="built_in">sizeof</span>(event)));</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PROCESS_NUM; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int</span> num, j;</span><br><span class="line">                num = <span class="built_in">epoll_wait</span>(epoll_fd, events, MAXEVENTS, <span class="number">-1</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;process %d returnt from epoll_wait\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">                <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; ++i)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((events[i].events &amp; EPOLLERR) || (events[i].events &amp; EPOLLHUP) || (!(events[i].events &amp; EPOLLIN)))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;epoll error\n&quot;</span>);</span><br><span class="line">                        <span class="built_in">close</span>(events[i].data.fd);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (sock_fd == events[i].data.fd)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// æ”¶åˆ°å…³äºç›‘å¬å¥—æ¥å­—çš„é€šçŸ¥ï¼Œæ„å‘³ç€ä¸€ç›’æˆ–è€…å¤šä¸ªä¼ å…¥è¿æ¥</span></span><br><span class="line">                        <span class="keyword">struct</span> sockaddr in_addr;</span><br><span class="line">                        <span class="type">socklen_t</span> in_len = <span class="built_in">sizeof</span>(in_addr);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">accept</span>(sock_fd, &amp;in_addr, &amp;in_len) &lt; <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;process %d accept failed!\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;process %d accept successful!\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">wait</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(events);</span><br><span class="line">    <span class="built_in">close</span>(sock_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> âœ˜ penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/test î‚° ./main 1234  </span><br><span class="line">process 173413 returnt from epoll_wait</span><br><span class="line">process 173412 returnt from epoll_wait</span><br><span class="line">process 173411 returnt from epoll_wait</span><br><span class="line">process 173410 returnt from epoll_wait</span><br><span class="line">process 173409 returnt from epoll_wait</span><br><span class="line">process 173408 returnt from epoll_wait</span><br><span class="line">process 173407 returnt from epoll_wait</span><br><span class="line">process 173406 returnt from epoll_wait</span><br><span class="line">process 173405 returnt from epoll_wait</span><br><span class="line">process 173404 returnt from epoll_wait</span><br><span class="line">process 173407 accept successful!</span><br><span class="line">process 173409 accept failed!</span><br><span class="line">process 173410 accept failed!</span><br><span class="line">process 173411 accept failed!</span><br><span class="line">process 173412 accept failed!</span><br><span class="line">process 173406 accept failed!</span><br><span class="line">process 173404 accept failed!</span><br><span class="line">process 173413 accept failed!</span><br><span class="line">process 173405 accept failed!</span><br><span class="line">process 173408 accept failed!</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œå‘ç”Ÿäº†æƒŠç¾¤æ•ˆåº”ã€‚</p><blockquote><p>æ€ä¹ˆåˆ¤æ–­å‘ç”Ÿäº†æƒŠç¾¤å‘¢ï¼Ÿ</p></blockquote><p>æˆ‘ä»¬æ ¹æ®straceçš„è¿”å›ä¿¡æ¯å¯ä»¥ç¡®å®š:</p><p>(1) ç³»ç»Ÿåªä¼šè®©ä¸€ä¸ªè¿›ç¨‹çœŸæ­£çš„æ¥å—è¿™ä¸ªè¿æ¥ï¼Œè€Œå‰©ä½™çš„è¿›ç¨‹ä¼šè·å¾—ä¸€ä¸ªEAGAINä¿¡å·ã€‚</p><p>(2ï¼‰é€šè¿‡è¿”å›ç»“æœå’Œè¿›ç¨‹æ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨åˆ¤æ–­ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆå†…æ ¸å¤„ç†äº†acceptçš„æƒŠç¾¤ï¼Œå´ä¸å¤„ç†epoll_waitçš„æƒŠç¾¤å‘¢ï¼Ÿ</p></blockquote><p>acceptç¡®å®åº”è¯¥åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨æˆåŠŸï¼Œå†…æ ¸å¾ˆæ¸…æ¥šè¿™ä¸€ç‚¹ã€‚ä½†epollä¸ä¸€æ ·ï¼Œä»–ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé™¤äº†å¯èƒ½åç»­è¢«acceptè°ƒç”¨å¤–ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯å…¶ä»–ç½‘ç»œIOäº‹ä»¶çš„ï¼Œè€Œå…¶ä»–IOäº‹ä»¶æ˜¯å¦åªèƒ½ç”±ä¸€ä¸ªè¿›ç¨‹å¤„ç†ï¼Œæ˜¯ä¸ä¸€å®šçš„ï¼Œå†…æ ¸ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹ï¼Œè¿™æ˜¯ä¸€ä¸ªç”±ç”¨æˆ·å†³å®šçš„äº‹æƒ…ï¼Œä¾‹å¦‚å¯èƒ½ä¸€ä¸ªæ–‡ä»¶ä¼šç”±å¤šä¸ªè¿›ç¨‹æ¥è¯»å†™ã€‚æ‰€ä»¥ï¼Œå¯¹epollçš„æƒŠç¾¤ï¼Œå†…æ ¸åˆ™ä¸äºˆå¤„ç†ã€‚</p><h2 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</h2><p>è§£å†³æ–¹å¼ä¸€å…±æœ‰ä¸‰ç§</p><ol><li>accept_mutexï¼ˆåº”ç”¨å±‚çš„è§£å†³æ–¹æ¡ˆï¼‰</li><li>EPOLLEXCLUSIVEï¼ˆå†…æ ¸å±‚çš„è§£å†³æ–¹æ¡ˆï¼‰</li><li>SO_REUSEPORTï¼ˆå†…æ ¸å±‚çš„è§£å†³æ–¹æ¡ˆï¼‰</li></ol><h3 id="accept-mutex">accept_mutex</h3><p>çœ‹åˆ° mutex å¯èƒ½ä½ å°±çŸ¥é“äº†ï¼Œé”å˜›ï¼è¿™ä¹Ÿæ˜¯å¯¹äºé«˜å¹¶å‘å¤„ç†çš„ â€åŸºæ“â€œ é‡äº‹ä¸å†³åŠ é”ï¼Œæ²¡é”™ï¼ŒåŠ é”è‚¯å®šèƒ½è§£å†³é—®é¢˜ã€‚</p><p>æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹è¿™éƒ¨åˆ†çš„<a href="https://github.com/nginx/nginx/blob/b489ba83e9be446923facfe1a2fe392be3095d1f/src/event/ngx_event_accept.c#L328">ä»£ç å®ç°</a>ã€‚</p><h3 id="EPOLLEXCLUSIVE">EPOLLEXCLUSIVE</h3><p>EPOLLEXCLUSIVE æ˜¯ 2016 å¹´ 4.5+ å†…æ ¸æ–°æ·»åŠ çš„ä¸€ä¸ª epoll çš„æ ‡è¯†ã€‚å®ƒé™ä½äº†å¤šä¸ªè¿›ç¨‹/çº¿ç¨‹é€šè¿‡ epoll_ctl æ·»åŠ å…±äº« fd å¼•å‘çš„æƒŠç¾¤æ¦‚ç‡ï¼Œä½¿å¾—ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåªå”¤é†’ä¸€ä¸ªæ­£åœ¨ epoll_wait é˜»å¡ç­‰å¾…å”¤é†’çš„è¿›ç¨‹ï¼ˆè€Œä¸æ˜¯å…¨éƒ¨å”¤é†’ï¼‰ã€‚</p><p>å…³é”®æ˜¯ï¼šæ¯æ¬¡å†…æ ¸åªå”¤é†’ä¸€ä¸ªç¡çœ çš„è¿›ç¨‹å¤„ç†èµ„æºã€‚</p><h3 id="SO-REUSEPORT">SO_REUSEPORT</h3><p>Linuxå†…æ ¸çš„3.9ç‰ˆæœ¬å¸¦æ¥äº†SO_REUSEPORTç‰¹æ€§ï¼Œè¯¥ç‰¹æ€§æ”¯æŒå¤šä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹ç»‘å®šåˆ°åŒä¸€ç«¯å£ï¼Œæé«˜æœåŠ¡å™¨ç¨‹åºçš„æ€§èƒ½ï¼Œå…è®¸å¤šä¸ªå¥—æ¥å­—bind()ä»¥åŠlisten()åŒä¸€ä¸ªTCPæˆ–UDPç«¯å£ï¼Œå¹¶ä¸”åœ¨å†…æ ¸å±‚é¢å®ç°è´Ÿè½½å‡è¡¡ã€‚</p><ul><li>åœ¨æœªå¼€å¯SO_REUSEPORTçš„æ—¶å€™ï¼Œç”±ä¸€ä¸ªç›‘å¬socketå°†æ–°æ¥æ”¶çš„è¿æ¥è¯·æ±‚äº¤ç»™å„ä¸ªå·¥ä½œè€…å¤„ç†ï¼Œçœ‹å›¾ç¤ºï¼š<ul><li><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240430110045200.png" alt="image-20240430110045200"></li></ul></li><li>åœ¨ä½¿ç”¨SO_REUSEPORTåï¼Œå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶ç›‘å¬åŒä¸€ä¸ªIPï¼šç«¯å£ï¼Œç„¶åç”±å†…æ ¸å†³å®šå°†æ–°é“¾æ¥å‘é€ç»™å“ªä¸ªè¿›ç¨‹ï¼Œæ˜¾ç„¶ä¼šé™ä½æ¯ä¸ªå·¥äººæ¥æ”¶æ–°é“¾æ¥æ—¶é”ç«äº‰ã€‚<ul><li><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240430110103466.png" alt="image-20240430110103466"></li></ul></li></ul><blockquote><p><strong>SO_REUSEPORTè§£å†³äº†ä»€ä¹ˆé—®é¢˜</strong></p></blockquote><p>ï¼ˆ1ï¼‰å…è®¸å¤šä¸ªå¥—æ¥å­—bind()/listen()åŒä¸€ä¸ªtcp/udpç«¯å£ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æœåŠ¡å™¨å¥—æ¥å­—ï¼Œåœ¨æœåŠ¡å™¨å¥—æ¥å­—ä¸Šæ²¡æœ‰é”çš„ç«äº‰ã€‚</p><p>ï¼ˆ2ï¼‰å†…æ ¸å±‚é¢å®ç°è´Ÿè½½å‡è¡¡</p><p>ï¼ˆ3ï¼‰å®‰å…¨å±‚é¢ï¼Œç›‘å¬åŒä¸€ä¸ªç«¯å£çš„å¥—æ¥å­—åªèƒ½ä½äºåŒä¸€ä¸ªç”¨æˆ·ä¸‹é¢ã€‚</p><p>ï¼ˆ4ï¼‰å¤„ç†æ–°å»ºè¿æ¥æ—¶ï¼ŒæŸ¥æ‰¾listenerçš„æ—¶å€™ï¼Œèƒ½å¤Ÿæ”¯æŒåœ¨ç›‘å¬ç›¸åŒIPå’Œç«¯å£çš„å¤šä¸ªsockä¹‹é—´å‡è¡¡é€‰æ‹©ã€‚</p><blockquote><p><strong>å½“ä¸€ä¸ªè¿æ¥åˆ°æ¥çš„æ—¶å€™ï¼Œç³»ç»Ÿåˆ°åº•æ˜¯æ€ä¹ˆå†³å®šé‚£ä¸ªå¥—æ¥å­—æ¥å¤„ç†å®ƒï¼Ÿ</strong></p></blockquote><p>å¯¹äºä¸åŒå†…æ ¸ï¼Œå­˜åœ¨ä¸¤ç§æ¨¡å¼ï¼Œè¿™ä¸¤ç§æ¨¡å¼å¹¶ä¸å…±å­˜ï¼Œä¸€ç§å«åšçƒ­å¤‡ä»½æ¨¡å¼ï¼Œå¦ä¸€ç§å«åšè´Ÿè½½å‡è¡¡æ¨¡å¼ï¼Œ3.9å†…æ ¸ä»¥åï¼Œå…¨éƒ¨æ”¹ä¸ºè´Ÿè½½å‡è¡¡æ¨¡å¼ã€‚</p><ul><li>çƒ­å¤‡ä»½æ¨¡å¼ï¼šä¸€èˆ¬è€Œè¨€ï¼Œä¼šå°†æ‰€æœ‰çš„reuseportåŒä¸€ä¸ªIPåœ°å€/ç«¯å£çš„å¥—æ¥å­—æŒ‚åœ¨ä¸€ä¸ªé“¾è¡¨ä¸Šï¼Œå–ç¬¬ä¸€ä¸ªå³å¯ï¼Œå·¥ä½œçš„åªæœ‰ä¸€ä¸ªï¼Œå…¶ä»–çš„ä½œä¸ºå¤‡ä»½å­˜åœ¨ï¼Œå¦‚æœè¯¥å¥—æ¥å­—æŒ‚äº†ï¼Œå®ƒä¼šè¢«ä»é“¾è¡¨åˆ é™¤ï¼Œç„¶åç¬¬äºŒä¸ªä¾¿ä¼šæˆä¸ºç¬¬ä¸€ä¸ªã€‚</li><li>è´Ÿè½½å‡è¡¡æ¨¡å¼ï¼šå’Œçƒ­å¤‡ä»½æ¨¡å¼ä¸€æ ·ï¼Œæ‰€æœ‰reuseportåŒä¸€ä¸ªIPåœ°å€/ç«¯å£çš„å¥—æ¥å­—ä¼šæŒ‚åœ¨ä¸€ä¸ªé“¾è¡¨ä¸Šï¼Œä½ ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¿™æ ·ä¼šæ›´åŠ æ–¹ä¾¿ï¼Œå½“æœ‰è¿æ¥åˆ°æ¥æ—¶ï¼Œç”¨æ•°æ®åŒ…çš„æºIP/æºç«¯å£ä½œä¸ºä¸€ä¸ªHASHå‡½æ•°çš„è¾“å…¥ï¼Œå°†ç»“æœå¯¹reuseportå¥—æ¥å­—æ•°é‡å–æ¨¡ï¼Œå¾—åˆ°ä¸€ä¸ªç´¢å¼•ï¼Œè¯¥ç´¢å¼•æŒ‡ç¤ºçš„æ•°ç»„ä½ç½®å¯¹åº”çš„å¥—æ¥å­—ä¾¿æ˜¯å·¥ä½œå¥—æ¥å­—ã€‚è¿™æ ·å°±å¯ä»¥è¾¾åˆ°è´Ÿè½½å‡è¡¡çš„ç›®çš„ï¼Œä»è€Œé™ä½æŸä¸ªæœåŠ¡çš„å‹åŠ›ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/666017070">Nginx æ˜¯å¦‚ä½•è§£å†³æƒŠç¾¤æ•ˆåº”çš„ï¼Ÿ</a></li><li><a href="https://blog.csdn.net/lyztyycode/article/details/78648798">LinuxæƒŠç¾¤æ•ˆåº”è¯¦è§£</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Cpp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cpp </tag>
            
            <tag> æ“ä½œç³»ç»Ÿ </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTPå­¦ä¹ ç¬”è®°</title>
      <link href="/posts/f5ef6bcf.html"/>
      <url>/posts/f5ef6bcf.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>TCPåè®®</title>
      <link href="/posts/51aeee82.html"/>
      <url>/posts/51aeee82.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è®¡ç®—æœºç½‘ç»œåŸºç¡€ï¼Œæ˜¯ä¸€åè®¡ç®—æœºå­¦ç”Ÿå¿…é¡»ç‰¢ç‰¢æŒæ¡çš„åŸºæœ¬åŠŸã€‚</p><p>è¿™é‡Œå®‰åˆ©ä¸‹æ–¯å¦ç¦å¤§å­¦å¼€è®¾çš„CS144è¯¾ç¨‹ï¼Œç»™æƒ³è¿›ä¸€æ­¥äº†è§£TCPåè®®å…·ä½“å®ç°çš„å°ä¼™ä¼´ã€‚</p><p>è¯¾ç¨‹ğŸ”—ï¼š<a href="https://cs144.github.io/">https://cs144.github.io/</a></p><p>è¿™é—¨è¯¾å°†å¸¦ä½ ä»0åˆ°1å®ç°ä¸€ä¸ªå±äºè‡ªå·±çš„èƒ½åœ¨ç½‘ç»œä¸Šé€šä¿¡çš„ TCP/IP åè®®æ ˆã€‚</p><p>å¥½äº†ï¼Œå¼€å§‹åŸºæœ¬çš„çŸ¥è¯†ç‚¹æ¢³ç†~</p><h2 id="TCPå’ŒUDPçš„åŒºåˆ«"><a href="#TCPå’ŒUDPçš„åŒºåˆ«" class="headerlink" title="TCPå’ŒUDPçš„åŒºåˆ«"></a>TCPå’ŒUDPçš„åŒºåˆ«</h2><p><strong>UDPå¤´éƒ¨</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427173840722.png" alt="image-20240427173840722"></p><p>å­—æ®µå«ä¹‰</p><ul><li><p>ç«¯å£ï¼šé•¿åº¦16ä½ï¼ŒæŒ‡å®šå‘é€æ–¹æ‰€ä½¿ç”¨çš„ç«¯å£å·ï¼Œè‹¥ä¸éœ€è¦å¯¹æ–¹å›å‘æ¶ˆæ¯ï¼Œåˆ™å¯å…¨ç½®ä¸º0ã€‚</p></li><li><p>ç›®çš„ç«¯å£ï¼šé•¿åº¦16ä½ï¼ŒæŒ‡å®šæ¥æ”¶æ–¹æ‰€ä½¿ç”¨çš„ç«¯å£å·ã€‚</p></li><li><p>UDPæ€»é•¿åº¦ï¼šé•¿åº¦16ä½ï¼ŒæŒ‡å®šäº†UDPæ•°æ®æŠ¥çš„æ€»é•¿åº¦ã€‚</p></li><li><p>æ ¡éªŒå’Œï¼šé•¿åº¦16ä½ï¼Œç”¨äºUDPçš„å·®é”™æ£€æµ‹ï¼Œé˜²æ­¢UDPæŠ¥æ–‡å‡ºé”™ï¼ŒåŒæ—¶ä¼ªé¦–éƒ¨å‚ä¸è®¡ç®—ï¼Œé¿å…UDPç”¨æˆ·æ•°æ®æŠ¥ä¼ é€åˆ°é”™è¯¯çš„ç›®çš„åœ°ã€‚UDPçš„é¦–éƒ¨ï¼Œæ•°æ®éƒ¨åˆ†ï¼Œä¼ªé¦–éƒ¨éƒ½ä¼šå‚ä¸æ£€éªŒå’Œçš„è®¡ç®—ï¼Œå„å­—æ®µæ˜¯æŒ‰ç…§16æ¯”ç‰¹ä¸ºå•ä½è¿›è¡Œè®¡ç®—çš„ï¼Œå› æ­¤æ•°æ®éƒ¨åˆ†æ˜¯è¦ä¿è¯æ˜¯16æ¯”ç‰¹çš„å€æ•°ï¼Œä¸å¤Ÿç”¨0å¡«å……ã€‚</p></li></ul><p><strong>TCPå¤´éƒ¨</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427173903612.png" alt="image-20240427173903612"></p><p>å­—æ®µå«ä¹‰</p><ul><li><p>16ä½ç«¯å£å·ï¼šæºç«¯å£å·ï¼Œä¸»æœºè¯¥æŠ¥æ–‡æ®µæ˜¯æ¥è‡ªå“ªé‡Œï¼›ç›®æ ‡ç«¯å£å·ï¼Œè¦ä¼ ç»™å“ªä¸ªä¸Šå±‚åè®®æˆ–åº”ç”¨ç¨‹åºã€‚</p></li><li><p>32ä½åºå·ï¼šä¸€æ¬¡TCPé€šä¿¡ï¼ˆä»TCPè¿æ¥å»ºç«‹åˆ°æ–­å¼€ï¼‰è¿‡ç¨‹ä¸­æŸä¸€ä¸ªä¼ è¾“æ–¹å‘ä¸Šçš„å­—èŠ‚æµçš„æ¯ä¸ªå­—èŠ‚çš„ç¼–å·ã€‚</p></li><li><p>32ä½ç¡®è®¤å·ï¼šç”¨ä½œå¯¹å¦ä¸€æ–¹å‘é€çš„tcpæŠ¥æ–‡æ®µçš„å“åº”ã€‚å…¶å€¼æ˜¯æ”¶åˆ°çš„TCPæŠ¥æ–‡æ®µçš„åºå·å€¼åŠ 1ã€‚</p></li><li><p>4ä½å¤´éƒ¨é•¿åº¦ï¼šè¡¨ç¤ºtcpå¤´éƒ¨æœ‰å¤šå°‘ä¸ª32bitå­—ï¼ˆ4å­—èŠ‚ï¼‰ã€‚å› ä¸º4ä½æœ€å¤§èƒ½æ ‡è¯†15ï¼Œæ‰€ä»¥TCPå¤´éƒ¨æœ€é•¿æ˜¯60å­—èŠ‚ã€‚</p></li><li><p>6ä½æ ‡å¿—ä½ï¼šURG(ç´§æ€¥æŒ‡é’ˆæ˜¯å¦æœ‰æ•ˆ)ï¼ŒACkï¼ˆè¡¨ç¤ºç¡®è®¤å·æ˜¯å¦æœ‰æ•ˆï¼‰ï¼ŒPSHï¼ˆç¼“å†²åŒºå°šæœªå¡«æ»¡ï¼‰ï¼ŒRSTï¼ˆè¡¨ç¤ºè¦æ±‚å¯¹æ–¹é‡æ–°å»ºç«‹è¿æ¥ï¼‰ï¼ŒSYNï¼ˆå»ºç«‹è¿æ¥æ¶ˆæ¯æ ‡å¿—æ¥ï¼‰ï¼ŒFINï¼ˆè¡¨ç¤ºå‘ŠçŸ¥å¯¹æ–¹æœ¬ç«¯è¦å…³é—­è¿æ¥äº†ï¼‰ã€‚</p></li><li><p>16ä½çª—å£å¤§å°ï¼šæ˜¯TCPæµé‡æ§åˆ¶çš„ä¸€ä¸ªæ‰‹æ®µã€‚è¿™é‡Œè¯´çš„çª—å£ï¼ŒæŒ‡çš„æ˜¯æ¥æ”¶é€šå‘Šçª—å£ã€‚å®ƒå‘Šè¯‰å¯¹æ–¹æœ¬ç«¯çš„TCPæ¥æ”¶ç¼“å†²åŒºè¿˜èƒ½å®¹çº³å¤šå°‘å­—èŠ‚çš„æ•°æ®ï¼Œè¿™æ ·å¯¹æ–¹å°±å¯ä»¥æ§åˆ¶å‘é€æ•°æ®çš„é€Ÿåº¦ã€‚</p></li><li><p>16ä½æ ¡éªŒå’Œï¼šç”±å‘é€ç«¯å¡«å……ï¼Œæ¥æ”¶ç«¯å¯¹TCPæŠ¥æ–‡æ®µæ‰§è¡ŒCRCç®—æ³•ä»¥æ£€éªŒTCPæŠ¥æ–‡æ®µåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦æŸåã€‚æ³¨æ„ï¼Œè¿™ä¸ªæ ¡éªŒä¸ä»…åŒ…æ‹¬TCPå¤´éƒ¨ï¼Œä¹ŸåŒ…æ‹¬æ•°æ®éƒ¨åˆ†ã€‚è¿™ä¹Ÿæ˜¯TCPå¯é ä¼ è¾“çš„ä¸€ä¸ªé‡è¦ä¿éšœã€‚</p></li><li><p>16ä½ç´§æ€¥æŒ‡é’ˆï¼šä¸€ä¸ªæ­£çš„åç§»é‡ã€‚å®ƒå’Œåºå·å­—æ®µçš„å€¼ç›¸åŠ è¡¨ç¤ºæœ€åä¸€ä¸ªç´§æ€¥æ•°æ®çš„ä¸‹ä¸€å­—èŠ‚çš„åºå·ã€‚å› æ­¤ï¼Œç¡®åˆ‡åœ°è¯´ï¼Œè¿™ä¸ªå­—æ®µæ˜¯ç´§æ€¥æŒ‡é’ˆç›¸å¯¹å½“å‰åºå·çš„åç§»ï¼Œä¸å¦¨ç§°ä¹‹ä¸ºç´§æ€¥åç§»ã€‚TCPçš„ç´§æ€¥æŒ‡é’ˆæ˜¯å‘é€ç«¯å‘æ¥æ”¶ç«¯å‘é€ç´§æ€¥æ•°æ®çš„æ–¹æ³•ã€‚</p></li></ul><p><strong>åŒºåˆ«</strong></p><ul><li>TCP<strong>é¢å‘è¿æ¥</strong>ï¼›UDPæ˜¯æ— è¿æ¥çš„ï¼Œå³å‘é€æ•°æ®ä¹‹å‰ä¸éœ€è¦å»ºç«‹è¿æ¥ã€‚</li><li>TCPæä¾›<strong>å¯é çš„æœåŠ¡</strong>ï¼›UDPä¸ä¿è¯å¯é äº¤ä»˜ã€‚</li><li>TCP<strong>é¢å‘å­—èŠ‚æµ</strong>ï¼ŒæŠŠæ•°æ®çœ‹æˆä¸€è¿ä¸²æ— ç»“æ„çš„å­—èŠ‚æµï¼›UDPæ˜¯é¢å‘æŠ¥æ–‡çš„ã€‚</li><li>TCPæœ‰<strong>æ‹¥å¡æ§åˆ¶</strong>ï¼›UDPæ²¡æœ‰æ‹¥å¡æ§åˆ¶ï¼Œå› æ­¤ç½‘ç»œå‡ºç°æ‹¥å¡ä¸ä¼šä½¿æºä¸»æœºçš„å‘é€é€Ÿç‡é™ä½ï¼ˆå¯¹å®æ—¶åº”ç”¨å¾ˆæœ‰ç”¨ï¼Œå¦‚å®æ—¶è§†é¢‘ä¼šè®®ç­‰ï¼‰ã€‚</li><li><p>æ¯ä¸€æ¡TCPè¿æ¥åªèƒ½æ˜¯<strong>ç‚¹åˆ°ç‚¹</strong>çš„ï¼›UDPæ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šçš„é€šä¿¡æ–¹å¼ã€‚</p></li><li><p>TCPé¦–éƒ¨å¼€é”€20å­—èŠ‚ï¼›UDPçš„é¦–éƒ¨å¼€é”€å°ï¼Œåªæœ‰8ä¸ªå­—èŠ‚ã€‚</p></li></ul><p><strong>å¸¸è§çš„åº”ç”¨åè®®</strong></p><p>åŸºäºTCPçš„åº”ç”¨å±‚åè®®æœ‰ï¼šHTTPã€FTPã€SMTPã€TELNETã€SSH</p><ul><li><strong>HTTP</strong>ï¼šHyperText Transfer Protocolï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰ï¼Œé»˜è®¤ç«¯å£80</li><li><strong>FTP</strong>: File Transfer Protocol (æ–‡ä»¶ä¼ è¾“åè®®), é»˜è®¤ç«¯å£(20ç”¨äºä¼ è¾“æ•°æ®ï¼Œ21ç”¨äºä¼ è¾“æ§åˆ¶ä¿¡æ¯)</li><li><strong>SMTP</strong>: Simple Mail Transfer Protocol (ç®€å•é‚®ä»¶ä¼ è¾“åè®®) ,é»˜è®¤ç«¯å£25</li><li><strong>TELNET</strong>: Teletype over the Network (ç½‘ç»œç”µä¼ ), é»˜è®¤ç«¯å£23</li><li><strong>SSH</strong>ï¼šSecure Shellï¼ˆå®‰å…¨å¤–å£³åè®®ï¼‰ï¼Œé»˜è®¤ç«¯å£ 22</li></ul><p>åŸºäºUDPçš„åº”ç”¨å±‚åè®®ï¼šDNSã€TFTPã€SNMP</p><ul><li><strong>DNS</strong> : Domain Name Service (åŸŸåæœåŠ¡),é»˜è®¤ç«¯å£ 53</li><li><strong>TFTP</strong>: Trivial File Transfer Protocol (ç®€å•æ–‡ä»¶ä¼ è¾“åè®®)ï¼Œé»˜è®¤ç«¯å£69</li><li><strong>SNMP</strong>ï¼šSimple Network Management Protocolï¼ˆç®€å•ç½‘ç»œç®¡ç†åè®®ï¼‰ï¼Œé€šè¿‡UDPç«¯å£161æ¥æ”¶ï¼Œåªæœ‰Trapä¿¡æ¯é‡‡ç”¨UDPç«¯å£162ã€‚</li></ul><blockquote><p><strong>TCPæ˜¯å¦‚ä½•ç¡®ä¿å¯é æ€§çš„å‘¢ï¼Ÿ</strong></p></blockquote><ul><li>é¦–å…ˆï¼ŒTCPçš„è¿æ¥æ˜¯åŸºäº<strong>ä¸‰æ¬¡æ¡æ‰‹</strong>ï¼Œè€Œæ–­å¼€åˆ™æ˜¯åŸºäº<strong>å››æ¬¡æŒ¥æ‰‹</strong>ã€‚ç¡®ä¿è¿æ¥å’Œæ–­å¼€çš„å¯é æ€§ã€‚</li><li>å…¶æ¬¡ï¼ŒTCPçš„å¯é æ€§ï¼Œè¿˜ä½“ç°åœ¨<strong>æœ‰çŠ¶æ€</strong>;TCPä¼šè®°å½•å“ªäº›æ•°æ®å‘é€äº†ï¼Œå“ªäº›æ•°æ®è¢«æ¥æ”¶äº†ï¼Œå“ªäº›æ²¡æœ‰è¢«æ¥å—ï¼Œå¹¶ä¸”ä¿è¯æ•°æ®åŒ…æŒ‰åºåˆ°è¾¾ï¼Œä¿è¯æ•°æ®ä¼ è¾“ä¸å‡ºå·®é”™ã€‚</li><li>å†æ¬¡ï¼ŒTCPçš„å¯é æ€§ï¼Œè¿˜ä½“ç°åœ¨<strong>å¯æ§åˆ¶</strong>ã€‚å®ƒæœ‰æ•°æ®åŒ…æ ¡éªŒã€ACKåº”ç­”ã€<strong>è¶…æ—¶é‡ä¼ (å‘é€æ–¹)</strong>ã€å¤±åºæ•°æ®é‡ä¼ ï¼ˆæ¥æ”¶æ–¹ï¼‰ã€ä¸¢å¼ƒé‡å¤æ•°æ®ã€æµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£ï¼‰å’Œæ‹¥å¡æ§åˆ¶ç­‰æœºåˆ¶ã€‚</li></ul><h2 id="TCPçš„ä¸‰æ¬¡æ¡æ‰‹"><a href="#TCPçš„ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="TCPçš„ä¸‰æ¬¡æ¡æ‰‹"></a>TCPçš„ä¸‰æ¬¡æ¡æ‰‹</h2><p>å‡è®¾å‘é€ç«¯ä¸ºå®¢æˆ·ç«¯ï¼Œæ¥æ”¶ç«¯ä¸ºæœåŠ¡ç«¯ã€‚</p><p>å¼€å§‹æ—¶å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„çŠ¶æ€éƒ½æ˜¯<code>CLOSED</code></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427171700576.png" alt="image-20240427171700576"></p><ul><li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·å»ºç«‹è¿æ¥è¯·æ±‚ï¼Œå®¢æˆ·ç«¯ä¼šéšæœºç”Ÿæˆä¸€ä¸ªèµ·å§‹åºåˆ—å·xï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€çš„å­—æ®µä¸­åŒ…å«æ ‡å¿—ä½<code>SYN=1</code>ï¼Œåºåˆ—å·<code>seq=x</code>ã€‚ç¬¬ä¸€æ¬¡æ¡æ‰‹å‰å®¢æˆ·ç«¯çš„çŠ¶æ€ä¸º<code>CLOSE</code>ï¼Œç¬¬ä¸€æ¬¡æ¡æ‰‹åå®¢æˆ·ç«¯çš„çŠ¶æ€ä¸º<code>SYN-SENT</code>ã€‚æ­¤æ—¶æœåŠ¡ç«¯çš„çŠ¶æ€ä¸º<code>LISTEN</code>ã€‚</li><li>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡ç«¯åœ¨æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„æŠ¥æ–‡åï¼Œä¼šéšæœºç”Ÿæˆä¸€ä¸ªæœåŠ¡ç«¯çš„èµ·å§‹åºåˆ—å·yï¼Œç„¶åç»™å®¢æˆ·ç«¯å›å¤ä¸€æ®µæŠ¥æ–‡ï¼Œå…¶ä¸­åŒ…æ‹¬æ ‡å¿—ä½<code>SYN=1</code>ï¼Œ<code>ACK=1</code>ï¼Œåºåˆ—å·<code>seq=y</code>ï¼Œç¡®è®¤å·<code>ack=x+1</code>ã€‚ç¬¬äºŒæ¬¡æ¡æ‰‹å‰æœåŠ¡ç«¯çš„çŠ¶æ€ä¸º<code>LISTEN</code>ï¼Œç¬¬äºŒæ¬¡æ¡æ‰‹åæœåŠ¡ç«¯çš„çŠ¶æ€ä¸º<code>SYN-RCVD</code>ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯çš„çŠ¶æ€ä¸º<code>SYN-SENT</code>ã€‚ï¼ˆå…¶ä¸­<code>SYN=1</code>è¡¨ç¤ºè¦å’Œå®¢æˆ·ç«¯å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œ<code>ACK=1</code>è¡¨ç¤ºç¡®è®¤åºå·æœ‰æ•ˆï¼‰ã€‚</li><li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯å‘æ¥çš„æŠ¥æ–‡åï¼Œä¼šå†å‘æœåŠ¡ç«¯å‘é€æŠ¥æ–‡ï¼Œå…¶ä¸­åŒ…å«æ ‡å¿—ä½<code>ACK=1</code>ï¼Œåºåˆ—å·<code>seq=x+1</code>ï¼Œç¡®è®¤å·<code>ack=y+1</code>ã€‚ç¬¬ä¸‰æ¬¡æ¡æ‰‹å‰å®¢æˆ·ç«¯çš„çŠ¶æ€ä¸º<code>SYN-SENT</code>ï¼Œç¬¬ä¸‰æ¬¡æ¡æ‰‹åå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„çŠ¶æ€éƒ½ä¸º<code>ESTABLISHED</code>ã€‚<strong>æ­¤æ—¶è¿æ¥å»ºç«‹å®Œæˆã€‚</strong></li></ul><blockquote><p><strong>ä¸¤æ¬¡æ¡æ‰‹å¯ä»¥å—ï¼Ÿ</strong></p></blockquote><p>é˜²æ­¢é‡å¤è¿æ¥</p><ul><li>ä¸‰æ¬¡æ¡æ‰‹çš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†é˜²æ­¢æ—§çš„é‡å¤è¿æ¥å¼•èµ·è¿æ¥æ··ä¹±é—®é¢˜ã€‚</li><li>æ¯”å¦‚åœ¨ç½‘ç»œçŠ¶å†µæ¯”è¾ƒå¤æ‚æˆ–è€…ç½‘ç»œçŠ¶å†µæ¯”è¾ƒå·®çš„æƒ…å†µä¸‹ï¼Œå‘é€æ–¹å¯èƒ½ä¼šè¿ç»­å‘é€å¤šæ¬¡å»ºç«‹è¿æ¥çš„è¯·æ±‚ã€‚</li><li>å¦‚æœ TCP æ¡æ‰‹çš„æ¬¡æ•°åªæœ‰ä¸¤æ¬¡ï¼Œé‚£ä¹ˆæ¥æ”¶æ–¹åªèƒ½é€‰æ‹©æ¥å—è¯·æ±‚æˆ–è€…æ‹’ç»æ¥å—è¯·æ±‚ï¼Œä½†å®ƒå¹¶ä¸æ¸…æ¥šè¿™æ¬¡çš„è¯·æ±‚æ˜¯æ­£å¸¸çš„è¯·æ±‚ï¼Œè¿˜æ˜¯ç”±äºç½‘ç»œç¯å¢ƒé—®é¢˜è€Œå¯¼è‡´çš„è¿‡æœŸè¯·æ±‚ï¼Œå¦‚æœæ˜¯è¿‡æœŸè¯·æ±‚çš„è¯å°±ä¼šé€ æˆé”™è¯¯çš„è¿æ¥ã€‚</li><li>æ‰€ä»¥å¦‚æœ TCP æ˜¯ä¸‰æ¬¡æ¡æ‰‹çš„è¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°æœåŠ¡å™¨ç«¯ SEQ+1 çš„æ¶ˆæ¯ä¹‹åï¼Œå°±å¯ä»¥åˆ¤æ–­å½“å‰çš„è¿æ¥æ˜¯å¦ä¸ºå†å²è¿æ¥ï¼Œå¦‚æœåˆ¤æ–­ä¸ºå†å²è¿æ¥çš„è¯å°±ä¼šå‘é€ç»ˆæ­¢æŠ¥æ–‡ï¼ˆRSTï¼‰ç»™æœåŠ¡å™¨ç«¯ç»ˆæ­¢è¿æ¥ï¼›å¦‚æœåˆ¤æ–­å½“å‰è¿æ¥ä¸æ˜¯å†å²è¿æ¥çš„è¯å°±ä¼šå‘é€æŒ‡ä»¤ç»™æœåŠ¡å™¨ç«¯æ¥å»ºç«‹è¿æ¥ã€‚</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427172057128.png" alt="image-20240427172057128"></p><h2 id="TCPçš„å››æ¬¡æŒ¥æ‰‹"><a href="#TCPçš„å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="TCPçš„å››æ¬¡æŒ¥æ‰‹"></a>TCPçš„å››æ¬¡æŒ¥æ‰‹</h2><p>å®¢æˆ·ç«¯Aå‘å®Œæ•°æ®ï¼Œè¦å…³é—­è¿æ¥ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427172134551.png" alt="image-20240427172134551"></p><ol><li>Açš„åº”ç”¨è¿›ç¨‹å…ˆå‘å…¶TCPå‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼ˆ<code>FIN=1ï¼Œseq=u</code>ï¼‰ï¼Œå¹¶åœæ­¢å†å‘é€æ•°æ®ï¼Œä¸»åŠ¨å…³é—­TCPè¿æ¥ï¼Œè¿›å…¥<code>FIN-WAIT-1</code>ï¼ˆç»ˆæ­¢ç­‰å¾…1ï¼‰çŠ¶æ€ï¼Œç­‰å¾…Bçš„ç¡®è®¤ã€‚</li><li>Bæ”¶åˆ°è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåå³å‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ˆ<code>ACK=1ï¼Œack=u+1ï¼Œseq=v</code>ï¼‰ï¼ŒBè¿›å…¥<code>CLOSE-WAIT</code>ï¼ˆå…³é—­ç­‰å¾…ï¼‰çŠ¶æ€ï¼Œæ­¤æ—¶çš„TCPå¤„äºåŠå…³é—­çŠ¶æ€ï¼ŒAåˆ°Bçš„è¿æ¥é‡Šæ”¾ã€‚</li><li>Aæ”¶åˆ°Bçš„ç¡®è®¤åï¼Œè¿›å…¥<code>FIN-WAIT-2</code>ï¼ˆç»ˆæ­¢ç­‰å¾…2ï¼‰çŠ¶æ€ï¼Œç­‰å¾…Bå‘å‡ºçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µã€‚</li><li>Bå‘é€å®Œæ•°æ®ï¼Œå°±ä¼šå‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼ˆ<code>FIN=1ï¼ŒACK=1ï¼Œseq=wï¼Œack=u+1</code>ï¼‰ï¼ŒBè¿›å…¥<code>LAST-ACK</code>ï¼ˆæœ€åç¡®è®¤ï¼‰çŠ¶æ€ï¼Œç­‰å¾…Açš„ç¡®è®¤ã€‚</li><li>Aæ”¶åˆ°Bçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåï¼Œå¯¹æ­¤å‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ˆ<code>ACK=1ï¼Œseq=u+1ï¼Œack=w+1</code>ï¼‰ï¼ŒAè¿›å…¥<code>TIME-WAIT</code>ï¼ˆæ—¶é—´ç­‰å¾…ï¼‰çŠ¶æ€ã€‚æ­¤æ—¶TCPæœªé‡Šæ”¾æ‰ï¼Œéœ€è¦ç»è¿‡æ—¶é—´ç­‰å¾…è®¡æ—¶å™¨è®¾ç½®çš„æ—¶é—´<code>2MSL</code>ï¼ˆæœ€å¤§æŠ¥æ–‡æ®µç”Ÿå­˜æ—¶é—´ï¼‰åï¼ŒAæ‰è¿›å…¥<code>CLOSED</code>çŠ¶æ€ã€‚Bæ”¶åˆ°Aå‘å‡ºçš„ç¡®è®¤æŠ¥æ–‡æ®µåå…³é—­è¿æ¥ï¼Œè‹¥æ²¡æ”¶åˆ°Aå‘å‡ºçš„ç¡®è®¤æŠ¥æ–‡æ®µï¼ŒBå°±ä¼šé‡ä¼ è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µã€‚</li></ol><blockquote><p><strong>ä»€ä¹ˆTIME_WAITçŠ¶æ€ï¼Ÿ</strong></p></blockquote><p>TIME-WAITçŠ¶æ€æŒ‡çš„æ˜¯ç¬¬å››æ¬¡æŒ¥æ‰‹åï¼Œä¸»åŠ¨ä¸­æ–­è¿æ¥æ–¹æ‰€å¤„çš„çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œä¸»åŠ¨æ–¹å°šæœªå®Œå…¨å…³é—­TCPè¿æ¥ï¼Œç«¯å£ä¸å¯å¤ç”¨ã€‚</p><blockquote><p><strong>ä¸ºä»€ä¹ˆTIME-WAITçŠ¶æ€éœ€è¦ç­‰å¾…2MSL?</strong></p></blockquote><ul><li><strong>ä¿è¯Aå‘é€çš„æœ€åä¸€ä¸ªACKæŠ¥æ–‡æ®µèƒ½å¤Ÿåˆ°è¾¾B</strong>ã€‚è¿™ä¸ª<code>ACK</code>æŠ¥æ–‡æ®µæœ‰å¯èƒ½ä¸¢å¤±ï¼ŒBæ”¶ä¸åˆ°è¿™ä¸ªç¡®è®¤æŠ¥æ–‡ï¼Œå°±ä¼šè¶…æ—¶é‡ä¼ è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼Œç„¶åAå¯ä»¥åœ¨<code>2MSL</code>æ—¶é—´å†…æ”¶åˆ°è¿™ä¸ªé‡ä¼ çš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼Œæ¥ç€Aé‡ä¼ ä¸€æ¬¡ç¡®è®¤ï¼Œé‡æ–°å¯åŠ¨2MSLè®¡æ—¶å™¨ï¼Œæœ€åAå’ŒBéƒ½è¿›å…¥åˆ°<code>CLOSED</code>çŠ¶æ€ï¼Œè‹¥Aåœ¨<code>TIME-WAIT</code>çŠ¶æ€ä¸ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè€Œæ˜¯å‘é€å®ŒACKæŠ¥æ–‡æ®µåç«‹å³é‡Šæ”¾è¿æ¥ï¼Œåˆ™æ— æ³•æ”¶åˆ°Bé‡ä¼ çš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼Œæ‰€ä»¥ä¸ä¼šå†å‘é€ä¸€æ¬¡ç¡®è®¤æŠ¥æ–‡æ®µï¼ŒBå°±æ— æ³•æ­£å¸¸è¿›å…¥åˆ°<code>CLOSED</code>çŠ¶æ€ã€‚</li><li><strong>é˜²æ­¢å·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µå‡ºç°åœ¨æœ¬è¿æ¥ä¸­</strong>ã€‚Aåœ¨å‘é€å®Œæœ€åä¸€ä¸ª<code>ACK</code>æŠ¥æ–‡æ®µåï¼Œå†ç»è¿‡2MSLï¼Œå°±å¯ä»¥ä½¿è¿™ä¸ªè¿æ¥æ‰€äº§ç”Ÿçš„æ‰€æœ‰æŠ¥æ–‡æ®µéƒ½ä»ç½‘ç»œä¸­æ¶ˆå¤±ï¼Œä½¿ä¸‹ä¸€ä¸ªæ–°çš„è¿æ¥ä¸­ä¸ä¼šå‡ºç°æ—§çš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µã€‚</li></ul><h2 id="TCPçš„çŠ¶æ€è½¬æ¢å›¾"><a href="#TCPçš„çŠ¶æ€è½¬æ¢å›¾" class="headerlink" title="TCPçš„çŠ¶æ€è½¬æ¢å›¾"></a>TCPçš„çŠ¶æ€è½¬æ¢å›¾</h2><p>çŠ¶æ€è½¬æ¢å›¾å‡ ä¹å‡ºç°åœ¨æ¯ä¸€æœ¬æœ‰å…³TCPçš„æ•™æä¸­ï¼Œå¯è°“æ˜¯ç»å…¸ä¸­çš„ç»å…¸ã€‚</p><p>TCPé€šä¿¡è¿‡ç¨‹åŒ…æ‹¬ä¸‰ä¸ªæ­¥éª¤ï¼šå»ºç«‹TCPè¿æ¥é€šé“ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰ã€æ•°æ®ä¼ è¾“ã€æ–­å¼€TCPè¿æ¥é€šé“ï¼ˆå››æ¬¡æŒ¥æ‰‹ï¼‰</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427171057056.png" alt="image-20240427171057056"></p><p>è€Œæ•´ä¸ªè¿‡ç¨‹å¯ä»¥è¡¨ç¤ºæˆ<strong>TCPçŠ¶æ€çŠ¶æ€è½¬æ¢å›¾</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427171502114.png" alt="image-20240427171502114"></p><p>è¯¦ç»†å­¦ä¹ è¿™ç¯‡å†…å®¹ï¼š<a href="https://www.coonote.com/tcpip/tcpip-tutorial.html">TCP/IP æ•™ç¨‹</a></p><h2 id="TCPçš„æ»‘åŠ¨çª—å£æœºåˆ¶"><a href="#TCPçš„æ»‘åŠ¨çª—å£æœºåˆ¶" class="headerlink" title="TCPçš„æ»‘åŠ¨çª—å£æœºåˆ¶"></a>TCPçš„æ»‘åŠ¨çª—å£æœºåˆ¶</h2><p>TCP åˆ©ç”¨æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶ã€‚</p><p>æµé‡æ§åˆ¶æ˜¯ä¸ºäº†æ§åˆ¶å‘é€æ–¹å‘é€é€Ÿç‡ï¼Œä¿è¯æ¥æ”¶æ–¹æ¥å¾—åŠæ¥æ”¶ã€‚ TCPä¼šè¯çš„åŒæ–¹éƒ½å„è‡ªç»´æŠ¤ä¸€ä¸ªå‘é€çª—å£å’Œä¸€ä¸ªæ¥æ”¶çª—å£ã€‚æ¥æ”¶çª—å£å¤§å°å–å†³äºåº”ç”¨ã€ç³»ç»Ÿã€ç¡¬ä»¶çš„é™åˆ¶ã€‚å‘é€çª—å£åˆ™å–å†³äºå¯¹ç«¯é€šå‘Šçš„æ¥æ”¶çª—å£ã€‚æ¥æ”¶æ–¹å‘é€çš„ç¡®è®¤æŠ¥æ–‡ä¸­çš„windowå­—æ®µå¯ä»¥ç”¨æ¥æ§åˆ¶å‘é€æ–¹çª—å£å¤§å°ï¼Œä»è€Œå½±å“å‘é€æ–¹çš„å‘é€é€Ÿç‡ã€‚å°†æ¥æ”¶æ–¹çš„ç¡®è®¤æŠ¥æ–‡windowå­—æ®µè®¾ç½®ä¸º 0ï¼Œåˆ™å‘é€æ–¹ä¸èƒ½å‘é€æ•°æ®ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427172810673.png" alt="image-20240427172810673"></p><p>TCPå¤´åŒ…å«windowå­—æ®µï¼Œ16bitä½ï¼Œå®ƒä»£è¡¨çš„æ˜¯çª—å£çš„å­—èŠ‚å®¹é‡ï¼Œæœ€å¤§ä¸º65535ã€‚è¿™ä¸ªå­—æ®µæ˜¯æ¥æ”¶ç«¯å‘Šè¯‰å‘é€ç«¯è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºå¯ä»¥æ¥æ”¶æ•°æ®ã€‚äºæ˜¯å‘é€ç«¯å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›æ¥å‘é€æ•°æ®ï¼Œè€Œä¸ä¼šå¯¼è‡´æ¥æ”¶ç«¯å¤„ç†ä¸è¿‡æ¥ã€‚æ¥æ”¶çª—å£çš„å¤§å°æ˜¯çº¦ç­‰äºå‘é€çª—å£çš„å¤§å°ã€‚</p><h2 id="TCPæ‹¥å¡æ§åˆ¶"><a href="#TCPæ‹¥å¡æ§åˆ¶" class="headerlink" title="TCPæ‹¥å¡æ§åˆ¶"></a>TCPæ‹¥å¡æ§åˆ¶</h2><p>é˜²æ­¢è¿‡å¤šçš„æ•°æ®æ³¨å…¥åˆ°ç½‘ç»œä¸­ã€‚ å‡ ç§æ‹¥å¡æ§åˆ¶æ–¹æ³•ï¼šæ…¢å¼€å§‹( slow-start )ã€æ‹¥å¡é¿å…( congestion avoidance )ã€å¿«é‡ä¼ ( fast retransmit )å’Œå¿«æ¢å¤( fast recovery )ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427173017396.png" alt="image-20240427173017396"></p><p><strong>æ…¢å¼€å§‹</strong></p><p>æŠŠæ‹¥å¡çª—å£ cwnd è®¾ç½®ä¸ºä¸€ä¸ªæœ€å¤§æŠ¥æ–‡æ®µMSSçš„æ•°å€¼ã€‚è€Œåœ¨æ¯æ”¶åˆ°ä¸€ä¸ªå¯¹æ–°çš„æŠ¥æ–‡æ®µçš„ç¡®è®¤åï¼ŒæŠŠæ‹¥å¡çª—å£å¢åŠ è‡³å¤šä¸€ä¸ªMSSçš„æ•°å€¼ã€‚æ¯ç»è¿‡ä¸€ä¸ªä¼ è¾“è½®æ¬¡ï¼Œæ‹¥å¡çª—å£ cwnd å°±åŠ å€ã€‚ ä¸ºäº†é˜²æ­¢æ‹¥å¡çª—å£cwndå¢é•¿è¿‡å¤§å¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œè¿˜éœ€è¦è®¾ç½®ä¸€ä¸ªæ…¢å¼€å§‹é—¨é™ssthreshçŠ¶æ€å˜é‡ã€‚</p><p>å½“ cwnd &lt; ssthresh æ—¶ï¼Œä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ã€‚</p><p>å½“ cwnd &gt; ssthresh æ—¶ï¼Œåœæ­¢ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•è€Œæ”¹ç”¨æ‹¥å¡é¿å…ç®—æ³•ã€‚</p><p>å½“ cwnd = ssthresh æ—¶ï¼Œæ—¢å¯ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ï¼Œä¹Ÿå¯ä½¿ç”¨æ‹¥å¡æ§åˆ¶é¿å…ç®—æ³•ã€‚</p><p><strong>æ‹¥å¡é¿å…</strong></p><p>è®©æ‹¥å¡çª—å£cwndç¼“æ…¢åœ°å¢å¤§ï¼Œæ¯ç»è¿‡ä¸€ä¸ªå¾€è¿”æ—¶é—´RTTå°±æŠŠå‘é€æ–¹çš„æ‹¥å¡çª—å£cwndåŠ 1ï¼Œè€Œä¸æ˜¯åŠ å€ã€‚è¿™æ ·æ‹¥å¡çª—å£cwndæŒ‰çº¿æ€§è§„å¾‹ç¼“æ…¢å¢é•¿ã€‚</p><p>æ— è®ºåœ¨æ…¢å¼€å§‹é˜¶æ®µè¿˜æ˜¯åœ¨æ‹¥å¡é¿å…é˜¶æ®µï¼Œåªè¦å‘é€æ–¹åˆ¤æ–­ç½‘ç»œå‡ºç°æ‹¥å¡ï¼ˆå…¶æ ¹æ®å°±æ˜¯æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼‰ï¼Œå°±è¦æŠŠæ…¢å¼€å§‹é—¨é™ssthreshè®¾ç½®ä¸ºå‡ºç°æ‹¥å¡æ—¶çš„å‘é€ æ–¹çª—å£å€¼çš„ä¸€åŠï¼ˆä½†ä¸èƒ½å°äº2ï¼‰ã€‚ç„¶åæŠŠæ‹¥å¡çª—å£cwndé‡æ–°è®¾ç½®ä¸º1ï¼Œæ‰§è¡Œæ…¢å¼€å§‹ç®—æ³•ã€‚è¿™æ ·åšçš„ç›®çš„å°±æ˜¯è¦è¿…é€Ÿå‡å°‘ä¸»æœºå‘é€åˆ°ç½‘ç»œä¸­çš„åˆ†ç»„æ•°ï¼Œä½¿å¾—å‘ç”Ÿ æ‹¥å¡çš„è·¯ç”±å™¨æœ‰è¶³å¤Ÿæ—¶é—´æŠŠé˜Ÿåˆ—ä¸­ç§¯å‹çš„åˆ†ç»„å¤„ç†å®Œæ¯•ã€‚</p><p><strong>å¿«é‡ä¼ </strong></p><p>æœ‰æ—¶ä¸ªåˆ«æŠ¥æ–‡æ®µä¼šåœ¨ç½‘ç»œä¸­ä¸¢å¤±ï¼Œä½†å®é™…ä¸Šç½‘ç»œå¹¶æœªå‘ç”Ÿæ‹¥å¡ã€‚å¦‚æœå‘é€æ–¹è¿Ÿè¿Ÿæ”¶ä¸åˆ°ç¡®è®¤ï¼Œå°±ä¼šäº§ç”Ÿè¶…æ—¶ï¼Œå°±ä¼šè¯¯è®¤ä¸ºç½‘ç»œå‘ç”Ÿäº†æ‹¥å¡ã€‚è¿™å°±å¯¼è‡´å‘é€æ–¹é”™è¯¯åœ°å¯åŠ¨æ…¢å¼€å§‹ï¼ŒæŠŠæ‹¥å¡çª—å£cwndåˆè®¾ç½®ä¸º1ï¼Œå› è€Œé™ä½äº†ä¼ è¾“æ•ˆç‡ã€‚</p><p>å¿«é‡ä¼ ç®—æ³•å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚å¿«é‡ä¼ ç®—æ³•é¦–å…ˆè¦æ±‚æ¥æ”¶æ–¹æ¯æ”¶åˆ°ä¸€ä¸ªå¤±åºçš„æŠ¥æ–‡æ®µåå°±ç«‹å³å‘å‡ºé‡å¤ç¡®è®¤ï¼Œä½¿å‘é€æ–¹åŠæ—©çŸ¥é“æœ‰æŠ¥æ–‡æ®µæ²¡æœ‰åˆ°è¾¾å¯¹æ–¹ã€‚</p><p>å‘é€æ–¹åªè¦ä¸€è¿æ”¶åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤å°±åº”å½“ç«‹å³é‡ä¼ å¯¹æ–¹å°šæœªæ”¶åˆ°çš„æŠ¥æ–‡æ®µï¼Œè€Œä¸å¿…ç»§ç»­ç­‰å¾…é‡ä¼ è®¡æ—¶å™¨åˆ°æœŸã€‚ç”±äºå‘é€æ–¹å°½æ—©é‡ä¼ æœªè¢«ç¡®è®¤çš„æŠ¥æ–‡æ®µï¼Œå› æ­¤é‡‡ç”¨å¿«é‡ä¼ åå¯ä»¥ä½¿æ•´ä¸ªç½‘ç»œååé‡æé«˜çº¦20%ã€‚</p><p><strong>å¿«æ¢å¤</strong></p><p>å½“å‘é€æ–¹è¿ç»­æ”¶åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤ï¼Œå°±ä¼šæŠŠæ…¢å¼€å§‹é—¨é™ssthreshå‡åŠï¼Œæ¥ç€æŠŠcwndå€¼è®¾ç½®ä¸ºæ…¢å¼€å§‹é—¨é™ssthreshå‡åŠåçš„æ•°å€¼ï¼Œç„¶åå¼€å§‹æ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•ï¼Œä½¿æ‹¥å¡çª—å£ç¼“æ…¢åœ°çº¿æ€§å¢å¤§ã€‚</p><p>åœ¨é‡‡ç”¨å¿«æ¢å¤ç®—æ³•æ—¶ï¼Œæ…¢å¼€å§‹ç®—æ³•åªæ˜¯åœ¨TCPè¿æ¥å»ºç«‹æ—¶å’Œç½‘ç»œå‡ºç°è¶…æ—¶æ—¶æ‰ä½¿ç”¨ã€‚ é‡‡ç”¨è¿™æ ·çš„æ‹¥å¡æ§åˆ¶æ–¹æ³•ä½¿å¾—TCPçš„æ€§èƒ½æœ‰æ˜æ˜¾çš„æ”¹è¿›ã€‚</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="ç²˜åŒ…"><a href="#ç²˜åŒ…" class="headerlink" title="ç²˜åŒ…"></a>ç²˜åŒ…</h3><p>ç²˜åŒ…æŒ‡TCPåè®®ä¸­ï¼Œå‘é€æ–¹å‘é€çš„è‹¥å¹²åŒ…æ•°æ®åˆ°æ¥æ”¶æ–¹æ¥æ”¶æ—¶ç²˜æˆä¸€åŒ…ï¼Œä»æ¥æ”¶ç¼“å†²åŒºçœ‹ï¼Œåä¸€åŒ…æ•°æ®çš„å¤´ç´§æ¥ç€å‰ä¸€åŒ…æ•°æ®çš„å°¾ã€‚</p><p><strong>Note</strong>:åªæœ‰UDPåè®®ä¸å­˜åœ¨ç²˜åŒ…ã€‚è¿™æ˜¯ç”±äºUDPæœ‰æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œï¼Œä¸ä¼šå‘ç”Ÿç²˜åŒ…æ‹†åŒ…é—®é¢˜ã€‚</p><p>å› ä¸ºTCPæ˜¯é¢å‘æµï¼Œæ²¡æœ‰è¾¹ç•Œï¼Œè€Œæ“ä½œç³»ç»Ÿåœ¨å‘é€TCPæ•°æ®æ—¶ï¼Œä¼šé€šè¿‡ç¼“å†²åŒºæ¥è¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚ç¼“å†²åŒºä¸º1024ä¸ªå­—èŠ‚å¤§å°ã€‚</p><ul><li><p>å¦‚æœä¸€æ¬¡è¯·æ±‚å‘é€çš„æ•°æ®é‡æ¯”è¾ƒå°ï¼Œæ²¡è¾¾åˆ°ç¼“å†²åŒºå¤§å°ï¼ŒTCPåˆ™ä¼šå°†å¤šä¸ªè¯·æ±‚åˆå¹¶ä¸ºåŒä¸€ä¸ªè¯·æ±‚è¿›è¡Œå‘é€ï¼Œè¿™å°±å½¢æˆäº†ç²˜åŒ…é—®é¢˜ã€‚</p></li><li><p>å¦‚æœä¸€æ¬¡è¯·æ±‚å‘é€çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œè¶…è¿‡äº†ç¼“å†²åŒºå¤§å°ï¼ŒTCPå°±ä¼šå°†å…¶æ‹†åˆ†ä¸ºå¤šæ¬¡å‘é€ï¼Œè¿™å°±æ˜¯æ‹†åŒ…ã€‚</p></li></ul><p>ç²˜åŒ…å’Œæ‹†åŒ…ç¤ºæ„å›¾ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427173217720.png" alt="image-20240427173217720"></p><p>ä¸Šå›¾ä¸­æ¼”ç¤ºäº†ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ul><li>æ­£å¸¸çš„ç†æƒ³æƒ…å†µï¼Œä¸¤ä¸ªåŒ…æ°å¥½æ»¡è¶³TCPç¼“å†²åŒºçš„å¤§å°æˆ–è¾¾åˆ°TCPç­‰å¾…æ—¶é•¿ï¼Œåˆ†åˆ«å‘é€ä¸¤ä¸ªåŒ…ï¼›</li><li>ç²˜åŒ…ï¼šä¸¤ä¸ªåŒ…è¾ƒå°ï¼Œé—´éš”æ—¶é—´çŸ­ï¼Œå‘ç”Ÿç²˜åŒ…ï¼Œåˆå¹¶æˆä¸€ä¸ªåŒ…å‘é€ï¼›</li><li>æ‹†åŒ…ï¼šä¸€ä¸ªåŒ…è¿‡å¤§ï¼Œè¶…è¿‡ç¼“å­˜åŒºå¤§å°ï¼Œæ‹†åˆ†æˆä¸¤ä¸ªæˆ–å¤šä¸ªåŒ…å‘é€ï¼›</li><li>æ‹†åŒ…å’Œç²˜åŒ…ï¼šPacket1è¿‡å¤§ï¼Œè¿›è¡Œäº†æ‹†åŒ…å¤„ç†ï¼Œè€Œæ‹†å‡ºå»çš„ä¸€éƒ¨åˆ†åˆä¸Packet2è¿›è¡Œç²˜åŒ…å¤„ç†ã€‚</li></ul><p><strong>è§£å†³åŠæ³•</strong>ï¼š</p><ul><li>å‘é€ç«¯å°†æ¯ä¸ªåŒ…éƒ½å°è£…æˆå›ºå®šçš„é•¿åº¦ï¼Œæ¯”å¦‚100å­—èŠ‚å¤§å°ã€‚å¦‚æœä¸è¶³100å­—èŠ‚å¯é€šè¿‡è¡¥0æˆ–ç©ºç­‰è¿›è¡Œå¡«å……åˆ°æŒ‡å®šé•¿åº¦ï¼›</li><li>å‘é€ç«¯åœ¨æ¯ä¸ªåŒ…çš„æœ«å°¾ä½¿ç”¨å›ºå®šçš„åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚\r\nã€‚å¦‚æœå‘ç”Ÿæ‹†åŒ…éœ€ç­‰å¾…å¤šä¸ªåŒ…å‘é€è¿‡æ¥ä¹‹åå†æ‰¾åˆ°å…¶ä¸­çš„\r\nè¿›è¡Œåˆå¹¶ï¼›ä¾‹å¦‚ï¼ŒFTPåè®®ï¼›</li><li>å°†æ¶ˆæ¯åˆ†ä¸ºå¤´éƒ¨å’Œæ¶ˆæ¯ä½“ï¼Œå¤´éƒ¨ä¸­ä¿å­˜æ•´ä¸ªæ¶ˆæ¯çš„é•¿åº¦ï¼Œåªæœ‰è¯»å–åˆ°è¶³å¤Ÿé•¿åº¦çš„æ¶ˆæ¯ä¹‹åæ‰ç®—æ˜¯è¯»åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼›</li><li>é€šè¿‡è‡ªå®šä¹‰åè®®è¿›è¡Œç²˜åŒ…å’Œæ‹†åŒ…çš„å¤„ç†ã€‚</li></ul><h3 id="SYN-floodæ”»å‡»"><a href="#SYN-floodæ”»å‡»" class="headerlink" title="SYN-floodæ”»å‡»"></a>SYN-floodæ”»å‡»</h3><p>SYN æ´ªæ³›æ”»å‡» (SYN flood attack)</p><p>åŸç†</p><ul><li>åˆ©ç”¨ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹æ¼æ´</li><li>å¤§é‡å‘é€ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼ˆå‡IP)çš„æŠ¥æ–‡</li><li>æ”»å‡»æ–¹å¿½ç•¥ç¬¬äºŒæ¬¡æ¡æ‰‹çš„æŠ¥æ–‡</li><li>è¢«æ”»å‡»æ–¹å¤šä¸ªTCPè¿æ¥å¤„äº(SYNC-RCVD)é˜¶æ®µï¼Œè€—è´¹å¤§é‡èµ„æº</li><li>æœ€ç»ˆå› ä¸ºèµ„æºè€—å°½ï¼Œæ‹’ç»æœåŠ¡(DoS)</li></ul><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://joytsing.cn/posts/42952/#toc-heading-2">TCPåè®®ä¸­ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹</a></li><li><a href="https://www.coonote.com/tcpip/tcpip-tutorial.html">TCP/IP æ•™ç¨‹</a></li><li><a href="https://zhuanlan.zhihu.com/p/356225028">é¢è¯•é¢˜ï¼šèŠèŠTCPçš„ç²˜åŒ…ã€æ‹†åŒ…ä»¥åŠè§£å†³æ–¹æ¡ˆ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç®—æœºç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTPé˜Ÿå¤´é˜»å¡</title>
      <link href="/posts/9b06a28b.html"/>
      <url>/posts/9b06a28b.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªï¼š<a href="https://calendar.perfplanet.com/2020/head-of-line-blocking-in-quic-and-http-3-the-details/">Head-of-Line Blocking in QUIC and HTTP/3: The Details</a></p><p>æ‚¨å¯èƒ½å·²ç»å¬è¯´ï¼Œç»è¿‡4å¹´çš„å·¥ä½œï¼Œæ–°çš„ HTTP/3 å’Œ QUIC åè®®ç»ˆäºæ¥è¿‘æ­£å¼æ ‡å‡†åŒ–ã€‚é¢„è§ˆç‰ˆç°åœ¨å¯ä»¥åœ¨æœåŠ¡å™¨å’Œæµè§ˆå™¨ä¸­è¿›è¡Œæµ‹è¯•ã€‚</p><p>ä¸ HTTP/2 ç›¸æ¯”ï¼ŒHTTP/3 æœ‰å¾ˆå¤§çš„æ€§èƒ½æ”¹è¿›ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºå®ƒå°†åº•å±‚ä¼ è¾“åè®®ä» TCP æ”¹ä¸ºåŸºäº UDP çš„ QUICã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥äº†è§£å…¶ä¸­çš„ä¸€é¡¹æ”¹è¿›ï¼Œå³<strong>æ¶ˆé™¤é˜Ÿå¤´é˜»å¡</strong>ï¼ˆHead-of-Line blocking, ç®€å†™ï¼šHOL blockingï¼‰é—®é¢˜ã€‚è¿™å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºæˆ‘è¯»è¿‡å¾ˆå¤šå…³äºè¿™å®é™…ä¸Šæ„å‘³ç€ä»€ä¹ˆä»¥åŠå®ƒåœ¨ç°å®ä¸­æœ‰å¤šå¤§å¸®åŠ©çš„è¯¯è§£ã€‚è§£å†³é˜Ÿå¤´é˜»å¡ä¹Ÿæ˜¯ HTTP/3 å’Œ QUIC ä»¥åŠ HTTP/2 èƒŒåçš„ä¸»è¦åŠ¨æœºä¹‹ä¸€ï¼Œå› æ­¤å®ƒä¹Ÿä¸ºåè®®æ¼”è¿›çš„åŸå› æä¾›äº†ä¸€ä¸ªæå¥½çš„è§†è§’ã€‚</p><p>æˆ‘å°†é¦–å…ˆä»‹ç»é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œç„¶ååœ¨æ•´ä¸ª HTTP å†å²ä¸­è·Ÿè¸ªå®ƒçš„ä¸åŒå½¢å¼ã€‚æˆ‘ä»¬è¿˜å°†ç ”ç©¶å®ƒå¦‚ä½•ä¸å…¶ä»–ç³»ç»Ÿäº¤äº’ï¼Œå¦‚ä¼˜å…ˆçº§å’Œæ‹¥å¡æ§åˆ¶ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¸®åŠ©äººä»¬å¯¹ HTTP/3 çš„æ€§èƒ½æ”¹è¿›åšå‡ºæ­£ç¡®çš„åˆ¤æ–­ï¼Œè€Œè¿™ï¼ˆå‰§é€ï¼‰å¯èƒ½ä¸åƒè¥é”€ææ–™ä¸­æ‰€è¯´çš„é‚£æ ·ä»¤äººæƒŠè®¶ã€‚</p><p><strong>ç›®å½•ï¼š</strong></p><ol><li>ä»€ä¹ˆæ˜¯é˜Ÿå¤´é˜»å¡ï¼Ÿ</li><li>HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡</li><li>HTTP/2ï¼ˆåŸºäº TCPï¼‰çš„é˜Ÿå¤´é˜»å¡</li><li>HTTP/3ï¼ˆåŸºäº QUICï¼‰çš„é˜Ÿå¤´é˜»å¡</li><li>æ€»ç»“ä¸ç»“è®º</li></ol><p><strong>å½©è›‹å†…å®¹ï¼š</strong></p><ul><li>å½©è›‹ï¼šHTTP/1.1 ç®¡é“</li><li>å½©è›‹ï¼šTLS é˜Ÿå¤´é˜»å¡</li><li>å½©è›‹ï¼šä¼ è¾“æ‹¥å µæ§åˆ¶</li><li>å½©è›‹ï¼šå¤šè·¯å¤ç”¨æ˜¯å¦é‡è¦ï¼Ÿ</li></ul><h2 id="ä»€ä¹ˆæ˜¯é˜Ÿå¤´é˜»å¡ï¼ˆHead-of-Line-blockingï¼‰ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯é˜Ÿå¤´é˜»å¡ï¼ˆHead-of-Line-blockingï¼‰ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯é˜Ÿå¤´é˜»å¡ï¼ˆHead-of-Line blockingï¼‰ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯é˜Ÿå¤´é˜»å¡ï¼ˆ<strong>Head-of-Line blocking</strong>ï¼‰ï¼Ÿ</h2><p>å¾ˆéš¾ç»™ä½ ä¸€ä¸ªå•ä¸€çš„é˜Ÿå¤´é˜»å¡ï¼ˆHOL blockingï¼‰çš„æŠ€æœ¯å®šä¹‰ï¼Œå› ä¸ºè¿™ç¯‡åšå®¢æ–‡ç« å•ç‹¬æè¿°äº†å®ƒçš„å››ä¸ªä¸åŒå˜ä½“ã€‚ç„¶è€Œï¼Œä¸€ä¸ªç®€å•çš„å®šä¹‰æ˜¯ï¼š</p><blockquote><p>å½“å•ä¸ªï¼ˆæ…¢ï¼‰å¯¹è±¡é˜»æ­¢å…¶ä»–/åç»­çš„å¯¹è±¡å‰è¿›æ—¶</p></blockquote><p>ç°å®ç”Ÿæ´»ä¸­ä¸€ä¸ªå¾ˆå¥½çš„æ¯”å–»å°±æ˜¯åªæœ‰ä¸€ä¸ªæ”¶é“¶å°çš„æ‚è´§åº—ã€‚ä¸€ä¸ªé¡¾å®¢ä¹°äº†å¾ˆå¤šä¸œè¥¿ï¼Œæœ€åä¼šè€½è¯¯æ’åœ¨ä»–åé¢çš„äººï¼Œå› ä¸ºé¡¾å®¢æ˜¯ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFirst In, First Outï¼‰çš„æ–¹å¼æœåŠ¡çš„ã€‚å¦ä¸€ä¸ªä¾‹å­æ˜¯åªæœ‰å•è¡Œé“çš„é«˜é€Ÿå…¬è·¯ã€‚åœ¨è¿™æ¡è·¯ä¸Šå‘ç”Ÿä¸€èµ·è½¦ç¥¸ï¼Œå¯èƒ½ä¼šä½¿æ•´ä¸ªé€šé“å µå¡å¾ˆé•¿ä¸€æ®µæ—¶é—´ã€‚å› æ­¤ï¼Œå³ä½¿æ˜¯åœ¨â€œå¤´éƒ¨ï¼ˆheadï¼‰â€ä¸€ä¸ªå•ä¸€çš„é—®é¢˜å¯ä»¥â€œé˜»å¡ï¼ˆblockï¼‰â€æ•´æ¡â€œçº¿ï¼ˆlineï¼‰â€ã€‚</p><p>è¿™ä¸ªæ¦‚å¿µä¸€ç›´æ˜¯æœ€éš¾è§£å†³çš„ Web æ€§èƒ½é—®é¢˜ä¹‹ä¸€ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬ä» HTTP/1.1 å¼€å§‹è®²èµ·ã€‚</p><h2 id="HTTP-1-1-çš„é˜Ÿå¤´é˜»å¡"><a href="#HTTP-1-1-çš„é˜Ÿå¤´é˜»å¡" class="headerlink" title="HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡"></a>HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡</h2><p>HTTP/1.1æ˜¯ä¸€ç§æ›´ç®€å•çš„åè®®ã€‚ä¸€ä¸ªåè®®ä»ç„¶å¯ä»¥åŸºäºæ–‡æœ¬å¹¶åœ¨ç½‘ç»œä¸Šå¯è¯»çš„æ—¶ä»£ã€‚å¦‚ä¸‹å›¾1æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132357401.png" alt="image-20240427132357401"></p><center>å›¾1ï¼šæœåŠ¡å™¨ HTTP/1.1 å“åº” script.js</center><p>åœ¨æœ¬ä¾‹ä¸­ï¼Œæµè§ˆå™¨åŸºäº HTTP/1.1ä¸Š è¯·æ±‚ç®€å•çš„<code>script.js</code>æ–‡ä»¶ï¼ˆç»¿è‰²ï¼‰ï¼Œå›¾1æ˜¾ç¤ºäº†æœåŠ¡å™¨å¯¹è¯¥è¯·æ±‚çš„å“åº”ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ° HTTP æ–¹é¢æœ¬èº«å¾ˆç®€å•ï¼šå®ƒåªæ˜¯åœ¨æ˜æ–‡æ–‡ä»¶å†…å®¹æˆ–â€œæœ‰æ•ˆè·è½½â€ï¼ˆpayloadï¼‰å‰é¢ç›´æ¥æ·»åŠ ä¸€äº›æ–‡æœ¬â€œheadersâ€ï¼ˆçº¢è‰²ï¼‰ã€‚ç„¶åï¼Œå¤´ï¼ˆHeadersï¼‰+ æœ‰æ•ˆè·è½½ï¼ˆpayloadï¼‰è¢«ä¼ é€’åˆ°åº•å±‚ TCPï¼ˆæ©™è‰²ï¼‰ï¼Œä»¥ä¾¿çœŸå®ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬ä¸èƒ½å°†æ•´ä¸ªæ–‡ä»¶æ”¾å…¥ä¸€ä¸ª TCP åŒ…ä¸­ï¼Œå¹¶ä¸”å¿…é¡»å°†å®ƒåˆ†æˆä¸¤éƒ¨åˆ†ã€‚</p><p><em>æ³¨æ„ï¼šå®é™…ä¸Šï¼Œå½“ä½¿ç”¨ HTTPS æ—¶ï¼ŒHTTP å’Œ TCP ä¹‹é—´æœ‰å¦ä¸€ä¸ªå®‰å…¨å±‚ï¼Œé€šå¸¸ä½¿ç”¨ TLS åè®®ã€‚ä¸è¿‡ï¼Œä¸ºäº†æ¸…æ™°èµ·è§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œçœç•¥äº†è¿™ä¸€ç‚¹ã€‚æˆ‘åœ¨ç»“å°¾åŠ å…¥äº†ä¸€ä¸ªé¢å¤–çš„å½©è›‹éƒ¨åˆ†ï¼Œè¯¦ç»†è¯´æ˜äº† TLS ç‰¹å®šçš„é˜Ÿå¤´é˜»å¡å˜ä½“ä»¥åŠ QUIC å¦‚ä½•é¿å…å®ƒã€‚é˜…è¯»å®Œæ­£æ–‡åï¼Œè¯·éšæ„é˜…è¯»å®ƒï¼ˆä»¥åŠå…¶ä»–çš„å½©è›‹éƒ¨åˆ†ï¼‰ã€‚</em></p><p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å½“æµè§ˆå™¨ä¹Ÿè¯·æ±‚<code>style.css</code>æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¦‚å›¾2ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132410754.png" alt="image-20240427132410754"></p><center>å›¾2ï¼šæœåŠ¡å™¨ HTTP/1.1 å“åº” script.js å’Œ sytle.css</center><p>åœ¨æœ¬ä¾‹ä¸­ï¼Œå½“<code>script.js</code>çš„å“åº”ä¼ è¾“ä¹‹åï¼Œæˆ‘ä»¬å‘é€<code>style.css</code>ï¼ˆç´«è‰²ï¼‰ã€‚<code>style.css</code>çš„å¤´éƒ¨ï¼ˆheadersï¼‰å’Œå†…å®¹åªæ˜¯é™„åŠ åœ¨ JavaScriptï¼ˆJSï¼‰æ–‡ä»¶ä¹‹åã€‚æ¥æ”¶è€…ä½¿ç”¨<strong>Content-Length</strong> header æ¥çŸ¥é“æ¯ä¸ªå“åº”çš„ç»“æŸä½ç½®å’Œå¦ä¸€ä¸ªå“åº”çš„å¼€å§‹ä½ç½®ï¼ˆåœ¨æˆ‘ä»¬çš„ç®€åŒ–ç¤ºä¾‹ä¸­ï¼Œ<code>script.js</code>æ˜¯1000å­—èŠ‚ï¼Œè€Œ<code>style.css</code>åªæœ‰600å­—èŠ‚ï¼‰ã€‚</p><p>åœ¨è¿™ä¸ªåŒ…å«ä¸¤ä¸ªå°æ–‡ä»¶çš„ç®€å•ç¤ºä¾‹ä¸­ï¼Œæ‰€æœ‰è¿™äº›ä¼¼ä¹éƒ½å¾ˆåˆç†ã€‚ä½†æ˜¯ï¼Œå‡è®¾ JS æ–‡ä»¶æ¯” CSS å¤§å¾—å¤šï¼ˆæ¯”å¦‚è¯´ 1MB è€Œä¸æ˜¯ 1KBï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨ä¸‹è½½æ•´ä¸ªJSæ–‡ä»¶ä¹‹å‰ï¼ŒCSS å¿…é¡»ç­‰å¾…ï¼Œå°½ç®¡å®ƒè¦å°å¾—å¤šï¼Œå…¶å®å¯ä»¥æ›´æ—©åœ°è§£æ/ä½¿ç”¨ã€‚æ›´ç›´æ¥åœ°å°†å…¶å¯è§†åŒ–ï¼Œä½¿ç”¨æ•°å­— 1 è¡¨ç¤º<code>large_script.js</code>å’Œ 2 è¡¨ç¤º<code>style.css</code>ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11111111111111111111111111111111111111122</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªé˜Ÿå¤´é˜»å¡é—®é¢˜çš„ä¾‹å­ï¼ç°åœ¨ä½ å¯èƒ½ä¼šæƒ³ï¼šè¿™å¾ˆå®¹æ˜“è§£å†³ï¼åªéœ€è®©æµè§ˆå™¨åœ¨JSæ–‡ä»¶ä¹‹å‰è¯·æ±‚CSSæ–‡ä»¶ï¼ç„¶è€Œï¼Œè‡³å…³é‡è¦çš„æ˜¯ï¼Œæµè§ˆå™¨æ— æ³•é¢„å…ˆçŸ¥é“è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„å“ªä¸€ä¸ªåœ¨è¯·æ±‚æ—¶ä¼šæˆä¸ºæ›´å¤§çš„æ–‡ä»¶ã€‚è¿™æ˜¯å› ä¸ºæ²¡æœ‰åŠæ³•åœ¨HTMLä¸­æŒ‡æ˜æ–‡ä»¶æœ‰å¤šå¤§ï¼ˆç±»ä¼¼è¿™æ ·çš„ä¸œè¥¿å¾ˆä¸é”™ï¼ŒHTMLå·¥ä½œç»„ï¼š<code>&lt;img src=&quot;thisisfine.jpg&quot; size=&quot;15000&quot; /&gt;</code>ï¼‰ã€‚</p><p>è¿™ä¸ªé—®é¢˜çš„â€œçœŸæ­£â€è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨<strong>å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰</strong>ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥å°†æ¯ä¸ªæ–‡ä»¶çš„æœ‰æ•ˆè·è½½ï¼ˆheaderï¼‰åˆ†æˆæ›´å°çš„ç‰‡ï¼ˆpiecesï¼‰æˆ–â€œå—â€ï¼ˆchunksï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ç½‘ç»œä¸Šæ··åˆæˆ–â€œäº¤é”™â€ï¼ˆinterleaveï¼‰è¿™äº›å—ï¼šä¸º JS å‘é€ä¸€ä¸ªå—ï¼Œä¸º CSS å‘é€ä¸€ä¸ªå—ï¼Œç„¶åå†å‘é€å¦ä¸€ä¸ªç”¨äº JSï¼Œç­‰ç­‰ï¼Œç›´åˆ°æ–‡ä»¶è¢«ä¸‹è½½ä¸ºæ­¢ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œè¾ƒå°çš„CSSæ–‡ä»¶å°†æ›´æ—©åœ°ä¸‹è½½ï¼ˆå¹¶ä¸”å¯ç”¨ï¼‰ï¼ŒåŒæ—¶åªå°†è¾ƒå¤§çš„JSæ–‡ä»¶å»¶è¿Ÿä¸€ç‚¹ã€‚ç”¨æ•°å­—å½¢è±¡åŒ–æˆ‘ä»¬ä¼šå¾—åˆ°ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">12121111111111111111111111111111111111111</span><br></pre></td></tr></table></figure><p>ç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œç”±äºåè®®å­˜åœ¨ä¸€äº›åŸºç¡€çš„é™åˆ¶ï¼Œè¿™ç§å¤šè·¯å¤ç”¨åœ¨ HTTP/1.1 ä¸­æ˜¯ä¸å¯èƒ½çš„ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ç»§ç»­æŸ¥çœ‹å¤§èµ„æºå¯¹å°èµ„æºï¼ˆlarge-vs-smallï¼‰åœºæ™¯ï¼Œå› ä¸ºå®ƒå·²ç»åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­æ˜¾ç¤ºäº†ä¸¤ä¸ªè¾ƒå°çš„æ–‡ä»¶ã€‚å¦‚å›¾3ï¼Œæˆ‘ä»¬åªä¸ºä¸¤ä¸ªèµ„æºäº¤é”™4ä¸ªå—ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427211652242.png" alt="image-20240427211652242"></p><center>å›¾3ï¼šæœåŠ¡å™¨ HTTP/1.1 å¤šè·¯å¤ç”¨ script.js å’Œ style.css</center><p>è¿™é‡Œçš„ä¸»è¦é—®é¢˜æ˜¯ HTTP/1.1 æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬åè®®ï¼Œå®ƒåªåœ¨æœ‰æ•ˆè·è½½ï¼ˆpayloadï¼‰çš„å‰é¢é™„åŠ å¤´ï¼ˆheadersï¼‰ã€‚å®ƒä¸ä¼šè¿›ä¸€æ­¥åŒºåˆ†å•ä¸ªï¼ˆå¤§å—ï¼‰èµ„æºä¸å…¶ä»–èµ„æºã€‚è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜è¿™ä¸€ç‚¹ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•äº†å®ƒä¼šå‘ç”Ÿä»€ä¹ˆã€‚åœ¨å›¾3ä¸­ï¼Œæµè§ˆå™¨å¼€å§‹åˆ†æ<code>script.js</code>å¹¶æœŸæœ›åé¢æœ‰1000ä¸ªå­—èŠ‚ï¼ˆContent-Lengthï¼‰çš„æœ‰æ•ˆè·è½½ã€‚ä½†æ˜¯ï¼Œå®ƒåªæ¥æ”¶450ä¸ª JS å­—èŠ‚ï¼ˆç¬¬ä¸€ä¸ªå—ï¼‰ï¼Œç„¶åå¼€å§‹è¯»å–<code>sytle.css</code>çš„å¤´éƒ¨ã€‚å®ƒæœ€ç»ˆå°† CSS å¤´éƒ¨å’Œç¬¬ä¸€ä¸ª CSS å—è§£é‡Šä¸ºJSçš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ–‡ä»¶çš„æœ‰æ•ˆè·è½½å’Œå¤´éƒ½æ˜¯çº¯æ–‡æœ¬ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå®ƒåœ¨è¯»å–1000ä¸ªå­—èŠ‚ååœæ­¢ï¼Œç›´åˆ°ç¬¬äºŒä¸ª<code>script.js</code>å—çš„ä¸€åŠã€‚æ­¤æ—¶ï¼Œå®ƒçœ‹ä¸åˆ°æœ‰æ•ˆçš„æ–°æŠ¥å¤´ï¼Œå¿…é¡»åˆ é™¤ TCP æ•°æ®åŒ…3ï¼ˆpacket 3ï¼‰çš„å…¶ä½™éƒ¨åˆ†ã€‚ç„¶åæµè§ˆå™¨ä¼ é€’å®ƒè®¤ä¸ºçš„å†…å®¹<code>script.js</code>åˆ°JSè§£æå™¨ï¼Œå®ƒå¤±è´¥äº†å› ä¸ºä¸æ˜¯æœ‰æ•ˆçš„ JavaScriptï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">first</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>; &#125;</span><br><span class="line"><span class="variable constant_">HTTP</span>/<span class="number">1.1</span> <span class="number">200</span> <span class="variable constant_">OK</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Length</span>: <span class="number">600</span></span><br><span class="line"></span><br><span class="line">.<span class="property">h1</span> &#123; font-<span class="attr">size</span>: 4em; &#125;</span><br><span class="line">func</span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œæ‚¨å¯ä»¥è¯´æœ‰ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆï¼šè®©æµè§ˆå™¨æŸ¥æ‰¾<code>HTTP/1.1 &#123;statusCode&#125; &#123;statusString&#125;\n</code>æ¨¡å¼æ¥æŸ¥çœ‹æ–°çš„å¤´å—ä½•æ—¶å¼€å§‹ã€‚è¿™å¯èƒ½é€‚ç”¨äº TCP æ•°æ®åŒ…2ï¼ˆpacket 2ï¼‰ï¼Œä½†åœ¨æ•°æ®åŒ…3ï¼ˆpacket 3ï¼‰ä¸­ä¼šå¤±è´¥ï¼šæµè§ˆå™¨å¦‚ä½•çŸ¥é“ç»¿è‰²çš„<code>script.js</code>å—åœ¨å“ªé‡Œç»“æŸå’Œç´«è‰²<code>style.css</code>å—ä»å“ªé‡Œå¼€å§‹ï¼Ÿ</p><p>è¿™æ˜¯ HTTP/1.1 åè®®è®¾è®¡æ–¹å¼çš„ä¸€ä¸ªåŸºç¡€é™åˆ¶ã€‚å¦‚æœæ‚¨åªæœ‰ä¸€ä¸ª HTTP/1.1 è¿æ¥ï¼Œé‚£ä¹ˆåœ¨æ‚¨åˆ‡æ¢åˆ°å‘é€æ–°èµ„æºä¹‹å‰ï¼Œå¿…é¡»<strong>å®Œæ•´åœ°</strong>ä¼ è¾“èµ„æºå“åº”ã€‚å¦‚æœå‰é¢çš„èµ„æºåˆ›å»ºç¼“æ…¢ï¼ˆä¾‹å¦‚ï¼Œä»æ•°æ®åº“æŸ¥è¯¢åŠ¨æ€ç”Ÿæˆçš„<code>index.html</code>ï¼‰æˆ–è€…ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœå‰é¢çš„èµ„æºå¾ˆå¤§ã€‚è¿™äº›é—®é¢˜å¯èƒ½ä¼šå¼•èµ·é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚</p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæµè§ˆå™¨å¼€å§‹ä¸º HTTP/1.1 ä¸Šçš„æ¯ä¸ªé¡µé¢åŠ è½½<a href="https://link.zhihu.com/?target=http%3A//www.stevesouders.com/blog/2008/03/20/roundup-on-parallel-connections/">æ‰“å¼€å¤šä¸ªå¹¶è¡Œ TCP è¿æ¥</a>ï¼ˆé€šå¸¸ä¸º6ä¸ªï¼‰ã€‚è¿™æ ·ï¼Œè¯·æ±‚å¯ä»¥åˆ†å¸ƒåœ¨è¿™äº›å•ç‹¬çš„è¿æ¥ä¸Šï¼Œå¹¶ä¸”ä¸å†æœ‰é˜Ÿå¤´é˜»å¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤éæ¯é¡µæœ‰è¶…è¿‡6ä¸ªèµ„æºâ€¦è¿™å½“ç„¶æ˜¯å¾ˆå¸¸è§çš„ã€‚è¿™å°±æ˜¯åœ¨å¤šä¸ªåŸŸåä¸Šâ€œåˆ†ç‰‡â€ï¼ˆshardingï¼‰èµ„æºçš„å®è·µ(<a href="https://link.zhihu.com/?target=http%3A//img.mysite.com/">img.mysite.com</a>, static.mysite.com, ç­‰ï¼‰å’Œ CDN çš„ç”±æ¥ã€‚ç”±äºæ¯ä¸ªå•ç‹¬çš„åŸŸåæœ‰6ä¸ªè¿æ¥ï¼Œæµè§ˆå™¨å°†ä¸ºæ¯ä¸ªé¡µé¢åŠ è½½æ€»å…±æ‰“å¼€ 30-ish ä¸ª TCP è¿æ¥ã€‚è¿™æ˜¯å¯è¡Œçš„ï¼Œä½†æœ‰ç›¸å½“å¤§çš„å¼€é”€ï¼šå»ºç«‹ä¸€ä¸ªæ–°çš„ TCP è¿æ¥å¯èƒ½æ˜¯æ˜‚è´µçš„ï¼ˆä¾‹å¦‚åœ¨æœåŠ¡å™¨ä¸Šçš„çŠ¶æ€å’Œå†…å­˜æ–¹é¢ï¼Œä»¥åŠè®¾ç½® TLS åŠ å¯†çš„è®¡ç®—ï¼‰ï¼Œå¹¶ä¸”éœ€è¦æ¶ˆè€—ä¸€äº›æ—¶é—´ï¼ˆç‰¹åˆ«æ˜¯å¯¹äº HTTPS è¿æ¥ï¼Œå› ä¸º TLS éœ€è¦è‡ªå·±çš„æ¡æ‰‹ï¼‰ã€‚</p><p>ç”±äºè¿™ä¸ªé—®é¢˜ä¸èƒ½ç”¨ HTTP/1.1 è§£å†³ï¼Œè€Œä¸”å¹¶è¡Œ TCP è¿æ¥çš„è¡¥ä¸è§£å†³æ–¹æ¡ˆä¹Ÿä¸èƒ½éšç€æ—¶é—´çš„æ¨ç§»æ‰©å±•å¾—å¤ªå¥½ï¼Œå¾ˆæ˜æ˜¾éœ€è¦ä¸€ç§å…¨æ–°çš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯åæ¥çš„ HTTP/2ã€‚</p><p><em>æ³¨æ„ï¼šé˜…è¯»æœ¬æ–‡çš„è€å“¥å¯èƒ½ä¼šè¡¨ç¤ºæƒ³çŸ¥é“ HTTP/1.1 ç®¡é“ï¼ˆpipeliningï¼‰ã€‚æˆ‘å†³å®šä¸åœ¨è¿™é‡Œè®¨è®ºè¿™ä¸€ç‚¹ï¼Œä»¥ä¿æŒæ•´ä¸ªæ•…äº‹çš„æµç•…æ€§ï¼Œä½†å¯¹æ›´æ·±å…¥çš„æŠ€æœ¯æ„Ÿå…´è¶£çš„äººå¯ä»¥é˜…è¯»ç»“å°¾çš„å½©è›‹éƒ¨åˆ†ã€‚</em></p><h2 id="HTTP-2ï¼ˆåŸºäº-TCPï¼‰çš„é˜Ÿå¤´é˜»å¡"><a href="#HTTP-2ï¼ˆåŸºäº-TCPï¼‰çš„é˜Ÿå¤´é˜»å¡" class="headerlink" title="HTTP/2ï¼ˆåŸºäº TCPï¼‰çš„é˜Ÿå¤´é˜»å¡"></a><strong>HTTP/2ï¼ˆåŸºäº TCPï¼‰çš„é˜Ÿå¤´é˜»å¡</strong></h2><p>é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ã€‚HTTP/1.1 æœ‰ä¸€ä¸ªé˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œä¸€ä¸ªå¤§çš„æˆ–æ…¢çš„å“åº”ä¼šå»¶è¿Ÿåé¢çš„å…¶ä»–å“åº”ã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºåè®®æœ¬è´¨ä¸Šæ˜¯çº¯æ–‡æœ¬çš„ï¼Œåœ¨èµ„æºå—ï¼ˆresource chunksï¼‰ä¹‹é—´ä¸ä½¿ç”¨åˆ†éš”ç¬¦ã€‚ä½œä¸ºä¸€ç§è§£å†³åŠæ³•ï¼Œæµè§ˆå™¨æ‰“å¼€è®¸å¤šå¹¶è¡ŒTCPè¿æ¥ï¼Œè¿™æ—¢ä¸é«˜æ•ˆï¼Œä¹Ÿä¸å¯æ‰©å±•ã€‚</p><p>å› æ­¤ï¼ŒHTTP/2 çš„ç›®æ ‡éå¸¸æ˜ç¡®ï¼š<strong>æˆ‘ä»¬èƒ½å¤Ÿå›åˆ°å•ä¸ª TCP è¿æ¥ï¼Œè§£å†³é˜Ÿå¤´é˜»å¡é—®é¢˜</strong>ã€‚æ¢ä¸€ç§è¯´æ³•ï¼šæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ­£ç¡®åœ°å¤ç”¨èµ„æºå—ï¼ˆresource chunksï¼‰ã€‚è¿™åœ¨ HTTP/1.1 ä¸­æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºæ²¡æœ‰åŠæ³•åˆ†è¾¨ä¸€ä¸ªå—å±äºå“ªä¸ªèµ„æºï¼Œæˆ–è€…å®ƒåœ¨å“ªé‡Œç»“æŸï¼Œå¦ä¸€ä¸ªå—ä»å“ªé‡Œå¼€å§‹ã€‚HTTP/2 éå¸¸ä¼˜é›…åœ°è§£å†³äº†è¿™ä¸€é—®é¢˜ï¼Œå®ƒåœ¨èµ„æºå—ä¹‹å‰æ·»åŠ äº†<strong>å¸§ï¼ˆframesï¼‰</strong>ã€‚å¦‚å›¾4æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132443159.png" alt="image-20240427132443159"></p><center>å›¾4ï¼šHTTP/1.1 vs HTTP/2 å“åº” script.js</center><p>HTTP/2 åœ¨æ¯ä¸ªå—å‰é¢æ”¾ç½®ä¸€ä¸ªæ‰€è°“çš„æ•°æ®å¸§ï¼ˆDATA frameï¼‰ã€‚è¿™äº›æ•°æ®å¸§ä¸»è¦åŒ…å«ä¸¤ä¸ªå…³é”®çš„å…ƒæ•°æ®ã€‚é¦–å…ˆï¼šä¸‹é¢çš„å—å±äºå“ªä¸ªèµ„æºã€‚æ¯ä¸ªèµ„æºçš„â€œå­—èŠ‚æµï¼ˆbytestreamï¼‰â€éƒ½è¢«åˆ†é…äº†ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—ï¼Œå³<strong>æµidï¼ˆstream idï¼‰</strong>ã€‚ç¬¬äºŒï¼šå—çš„å¤§å°æ˜¯å¤šå°‘ã€‚åè®®è¿˜æœ‰è®¸å¤šå…¶ä»–å¸§ç±»å‹ï¼Œå›¾5ä¹Ÿæ˜¾ç¤ºäº†å¤´éƒ¨å¸§ï¼ˆHEADERS frameï¼‰ã€‚è¿™å†æ¬¡ä½¿ç”¨æµidï¼ˆstream idï¼‰æ¥æŒ‡å‡ºè¿™äº›å¤´ï¼ˆheadersï¼‰å±äºå“ªä¸ªå“åº”ï¼Œè¿™æ ·ç”šè‡³å¯ä»¥å°†å¤´ï¼ˆheadersï¼‰ä»å®ƒä»¬çš„å®é™…å“åº”æ•°æ®ä¸­åˆ†ç¦»å‡ºæ¥ã€‚</p><p>ä½¿ç”¨è¿™äº›å¸§ï¼ŒHTTP/2 ç¡®å®å…è®¸åœ¨ä¸€ä¸ªè¿æ¥ä¸Šæ­£ç¡®åœ°å¤ç”¨å¤šä¸ªèµ„æºï¼Œå‚è§å›¾5ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132510915.png" alt="image-20240427132510915"></p><center>å›¾5ï¼šHTTP/2 å¤šè·¯å¤ç”¨å“åº” script.js å’Œ style.css</center><p>ä¸å›¾3ä¸­çš„ç¤ºä¾‹ä¸åŒï¼Œæµè§ˆå™¨ç°åœ¨å¯ä»¥å®Œç¾åœ°å¤„ç†è¿™ç§æƒ…å†µã€‚å®ƒé¦–å…ˆå¤„ç†<code>script.js</code>çš„å¤´éƒ¨å¸§ï¼ˆHEADERS frameï¼‰ï¼Œç„¶åæ˜¯ç¬¬ä¸€ä¸ªJSå—çš„æ•°æ®å¸§ï¼ˆDATA frameï¼‰ã€‚ä»æ•°æ®å¸§ï¼ˆDATA frameï¼‰ä¸­åŒ…å«çš„å—é•¿åº¦æ¥çœ‹ï¼Œæµè§ˆå™¨çŸ¥é“å®ƒåªå»¶ä¼¸åˆ° TCP æ•°æ®åŒ…1çš„æœ«å°¾ï¼Œå¹¶ä¸”éœ€è¦ä» TCP æ•°æ®åŒ…2å¼€å§‹å¯»æ‰¾ä¸€ä¸ªå…¨æ–°çš„å¸§ã€‚åœ¨é‚£é‡Œå®ƒç¡®å®æ‰¾åˆ°äº†<code>style.css</code>çš„å¤´ï¼ˆHEADERSï¼‰ï¼Œ ä¸‹ä¸€ä¸ªæ•°æ®å¸§ï¼ˆDATA frameï¼‰å«æœ‰ä¸ç¬¬ä¸€ä¸ªæ•°æ®å¸§ï¼ˆ1ï¼‰ä¸åŒçš„æµ idï¼ˆ2ï¼‰ï¼Œå› æ­¤æµè§ˆå™¨çŸ¥é“è¿™å±äºä¸åŒçš„èµ„æºã€‚åŒæ ·çš„æƒ…å†µä¹Ÿé€‚ç”¨äº TCP æ•°æ®åŒ…3ï¼Œå…¶ä¸­æ•°æ®å¸§ï¼ˆDATA frameï¼‰æµ id ç”¨äºå°†å“åº”å—â€œè§£å¤ç”¨â€ï¼ˆde-multiplexï¼‰åˆ°æ­£ç¡®çš„èµ„æºâ€œæµâ€ï¼ˆstreamsï¼‰ã€‚</p><p>å› æ­¤ï¼Œé€šè¿‡â€œframingâ€å•ä¸ªæ¶ˆæ¯ï¼ŒHTTP/2 æ¯” HTTP/1.1 æ›´åŠ çµæ´»ã€‚å®ƒå…è®¸åœ¨å•ä¸ª TCP è¿æ¥ä¸Šé€šè¿‡äº¤é”™æ’åˆ—å—æ¥å¤šè·¯ä¼ è¾“å¤šä¸ªèµ„æºã€‚å®ƒè¿˜è§£å†³äº†ç¬¬ä¸€ä¸ªèµ„æºç¼“æ…¢æ—¶çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼šè€Œä¸å¿…ç­‰å¾…æŸ¥è¯¢æ•°æ®åº“ç”Ÿæˆçš„<code>index.html</code>ï¼ŒæœåŠ¡å™¨å¯ä»¥åœ¨ç­‰å¾…<code>index.html</code>æ—¶å¼€å§‹å‘é€å…¶ä»–èµ„æºã€‚</p><p>HTTP/2 çš„æ–¹å¼ä¸€ä¸ªé‡è¦ç»“æœæ˜¯ï¼Œæˆ‘ä»¬çªç„¶éœ€è¦ä¸€ç§æ–¹æ³•è®©æµè§ˆå™¨ä¸æœåŠ¡å™¨é€šä¿¡ï¼Œå•ä¸ªè¿æ¥çš„å¸¦å®½å¦‚ä½•è·¨èµ„æºåˆ†å¸ƒï¼ˆdistributedï¼‰ã€‚æ¢ä¸€ç§è¯´æ³•ï¼šèµ„æºå—åº”è¯¥å¦‚ä½•â€œè°ƒåº¦ï¼ˆscheduledï¼‰â€æˆ–äº¤é”™ï¼ˆinterleavedï¼‰ã€‚å¦‚æœæˆ‘ä»¬å†æ¬¡ç”¨ 1 å’Œ 2 æ¥è¡¨ç¤ºï¼Œæˆ‘ä»¬ä¼šå‘ç°å¯¹äº HTTP/1.1ï¼Œå”¯ä¸€çš„é€‰é¡¹æ˜¯11112222ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºé¡ºåºçš„ï¼ˆsequentialï¼‰ï¼‰ã€‚ç„¶è€Œï¼Œ HTTP/2 æœ‰æ›´å¤šçš„è‡ªç”±ï¼š</p><ul><li>å…¬å¹³å¤šè·¯å¤ç”¨ï¼ˆä¾‹å¦‚ä¸¤ä¸ªæ¸è¿›çš„ JPEGsï¼‰ï¼š12121212</li><li>åŠ æƒå¤šè·¯å¤ç”¨ï¼ˆ2æ˜¯1çš„ä¸¤å€ï¼‰ï¼š22122122121</li><li>åå‘é¡ºåºè°ƒåº¦ï¼ˆä¾‹å¦‚2æ˜¯å¯†é’¥æœåŠ¡å™¨æ¨é€çš„èµ„æºï¼‰ï¼š22221111</li><li>éƒ¨åˆ†è°ƒåº¦ï¼ˆæµ1è¢«ä¸­æ­¢ä¸”æœªå®Œæ•´å‘é€ï¼‰ï¼š112222</li></ul><p>ä½¿ç”¨å“ªç§æ–¹æ³•æ˜¯ç”± HTTP/2 ä¸­æ‰€è°“çš„â€œä¼˜å…ˆçº§ï¼ˆprioritizationï¼‰â€ç³»ç»Ÿé©±åŠ¨çš„ï¼Œæ‰€é€‰æ‹©çš„æ–¹æ³•å¯¹Web æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚ç„¶è€Œï¼Œè¿™æœ¬èº«å°±æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„è¯é¢˜ï¼Œä½ ä¸éœ€è¦åœ¨æ¥ä¸‹æ¥çš„åšå®¢æ–‡ç« ä¸­ç†è§£å®ƒï¼Œæ‰€ä»¥æˆ‘ä¸æŠŠå®ƒæ”¾åœ¨è¿™é‡Œè®²äº†ã€‚</p><p>æˆ‘æƒ³æ‚¨ä¼šåŒæ„ï¼Œé€šè¿‡ HTTP/2 çš„å¸§ï¼ˆframesï¼‰åŠå…¶ä¼˜å…ˆçº§è®¾ç½®ï¼Œå®ƒç¡®å®è§£å†³äº† HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚è¿™æ„å‘³ç€æˆ‘åœ¨è¿™é‡Œçš„å·¥ä½œå®Œæˆäº†ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å›å®¶äº†ã€‚å¯¹å—ï¼Ÿå¥½å§ï¼Œæ²¡é‚£ä¹ˆç®€å•ã€‚æˆ‘ä»¬å·²ç»è§£å†³äº† HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡ï¼Œæ˜¯çš„ï¼Œä½†æ˜¯ TCP çš„é˜Ÿå¤´é˜»å¡å‘¢ï¼Ÿ</p><h2 id="TCP-é˜Ÿå¤´é˜»å¡"><a href="#TCP-é˜Ÿå¤´é˜»å¡" class="headerlink" title="TCP é˜Ÿå¤´é˜»å¡"></a>TCP é˜Ÿå¤´é˜»å¡</h2><p>äº‹å®è¯æ˜ï¼ŒHTTP/2 åªè§£å†³äº† HTTP çº§åˆ«çš„é˜Ÿå¤´é˜»å¡ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸ºâ€œåº”ç”¨å±‚â€é˜Ÿå¤´é˜»å¡ã€‚ç„¶è€Œï¼Œåœ¨å…¸å‹çš„ç½‘ç»œæ¨¡å‹ä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘ä¸‹é¢çš„å…¶ä»–å±‚ã€‚æ‚¨å¯ä»¥åœ¨å›¾6ä¸­æ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132530740.png" alt="image-20240427132530740"></p><center>å›¾6ï¼šå…¸å‹ç½‘ç»œæ¨¡å‹ä¸­çš„å‡ ä¸ªåè®®å±‚</center><p>HTTP ä½äºé¡¶å±‚ï¼Œä½†é¦–å…ˆç”±å®‰å…¨å±‚çš„ TLS æ”¯æŒï¼ˆè¯·å‚é˜…â€œå½©è›‹ TLSâ€éƒ¨åˆ†ï¼‰ï¼Œç„¶åæ¥ç€å†ç”±ä¼ è¾“å±‚çš„ TCP ä¼ è¾“ã€‚è¿™äº›åè®®ä¸­çš„æ¯ä¸€å±‚éƒ½ç”¨ä¸€äº›å…ƒæ•°æ®åŒ…è£…æ¥è‡ªå…¶ä¸Šä¸€å±‚çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ HTTP(S) æ•°æ®ä¸­é¢„å…ˆåŠ ä¸Š TCP åŒ…å¤´ï¼ˆpacket headerï¼‰ï¼Œç„¶åå°†å…¶æ”¾å…¥ IP åŒ…ç­‰ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åè®®ä¹‹é—´å®ç°ç›¸å¯¹ç®€æ´çš„åˆ†ç¦»ã€‚è¿™åè¿‡æ¥åˆæœ‰åˆ©äºå®ƒä»¬çš„å¯é‡ç”¨æ€§ï¼šåƒ TCP è¿™æ ·çš„ä¼ è¾“å±‚åè®®ä¸å¿…å…³å¿ƒå®ƒæ­£åœ¨ä¼ è¾“ä»€ä¹ˆç±»å‹çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ HTTPï¼Œä¹Ÿå¯ä»¥æ˜¯ FTPï¼Œä¹Ÿå¯ä»¥æ˜¯ SSHï¼Œè°çŸ¥é“å‘¢ï¼‰ï¼Œè€Œä¸” IP å¯¹äº TCP å’Œ UDP éƒ½èƒ½å¾ˆå¥½åœ°å·¥ä½œã€‚</p><p>ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°†å¤šä¸ª HTTP/2 èµ„æºå¤šè·¯ä¼ è¾“åˆ°ä¸€ä¸ª TCP è¿æ¥ä¸Šï¼Œè¿™ç¡®å®ä¼šäº§ç”Ÿé‡è¦çš„åæœã€‚å¦‚å›¾7ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132541483.png" alt="image-20240427132541483"></p><center>å›¾7ï¼šHTTP/2 å’Œ TCP åœ¨é€è§†å›¾ä¸Šçš„å·®å¼‚</center><p>è™½ç„¶æˆ‘ä»¬å’Œæµè§ˆå™¨éƒ½çŸ¥é“æˆ‘ä»¬æ­£åœ¨è·å– JavaScript å’Œ CSS æ–‡ä»¶ï¼Œä½† HTTP/2 ä¸éœ€è¦çŸ¥é“è¿™ä¸€ç‚¹ã€‚å®ƒåªçŸ¥é“å®ƒåœ¨ä½¿ç”¨æ¥è‡ªä¸åŒèµ„æºæµ id ï¼ˆstream idï¼‰çš„å—ã€‚ç„¶è€Œï¼Œ<strong>TCP ç”šè‡³ä¸çŸ¥é“å®ƒåœ¨ä¼ è¾“ HTTPï¼</strong>TCP æ‰€çŸ¥é“çš„å°±æ˜¯å®ƒè¢«èµ‹äºˆäº†ä¸€ç³»åˆ—å­—èŠ‚ï¼Œå®ƒå¿…é¡»ä»ä¸€å°è®¡ç®—æœºä¼ è¾“å¦ä¸€å°è®¡ç®—æœºã€‚ä¸ºæ­¤ï¼Œå®ƒä½¿ç”¨ç‰¹å®šæœ€å¤§å¤§å°ï¼ˆmaximum sizeï¼‰çš„æ•°æ®åŒ…ï¼Œé€šå¸¸å¤§çº¦ä¸º1450å­—èŠ‚ã€‚æ¯ä¸ªæ•°æ®åŒ…åªè·Ÿè¸ªå®ƒæºå¸¦çš„æ•°æ®çš„é‚£ä¸€éƒ¨åˆ†ï¼ˆå­—èŠ‚èŒƒå›´ï¼‰ï¼Œè¿™æ ·åŸå§‹æ•°æ®å°±å¯ä»¥æŒ‰ç…§æ­£ç¡®çš„é¡ºåºé‡å»ºã€‚</p><p>æ¢è¨€ä¹‹ï¼Œè¿™ä¸¤ä¸ªå±‚ä¹‹é—´çš„é€è§†å›¾æ˜¯ä¸åŒ¹é…çš„ï¼šHTTP/2 å¯ä»¥çœ‹åˆ°å¤šä¸ªç‹¬ç«‹çš„èµ„æºå­—èŠ‚æµï¼ˆbytestreamï¼‰ï¼Œè€Œ TCP åªçœ‹åˆ°ä¸€ä¸ªä¸é€æ˜çš„å­—èŠ‚æµï¼ˆbytestreamsï¼‰ã€‚å›¾7çš„TCPæ•°æ®åŒ…3å°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼šTCP åªçŸ¥é“å®ƒæ­£åœ¨ä¼ è¾“çš„ä»»ä½•å†…å®¹çš„å­—èŠ‚ 750 åˆ°å­—èŠ‚1 599ã€‚å¦ä¸€æ–¹é¢ï¼ŒHTTP/2 çŸ¥é“æ•°æ®åŒ…3ä¸­å®é™…ä¸Šæœ‰ä¸¤ä¸ªç‹¬ç«‹èµ„æºçš„ä¸¤ä¸ªå—ã€‚<em>ï¼ˆæ³¨æ„ï¼šå®é™…ä¸Šï¼Œæ¯ä¸ª HTTP/2 å¸§ï¼ˆå¦‚ DATA å’Œ HEADERSï¼‰çš„å¤§å°ä¹Ÿæœ‰å‡ ä¸ªå­—èŠ‚ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘æ²¡æœ‰è®¡ç®—é¢å¤–çš„å¼€é”€æˆ–è¿™é‡Œçš„ HEADERS å¸§ï¼Œä»¥ä½¿æ•°å­—æ›´ç›´è§‚ã€‚ï¼‰</em></p><p>æ‰€æœ‰è¿™äº›çœ‹èµ·æ¥éƒ½æ˜¯ä¸å¿…è¦çš„ç»†èŠ‚ï¼Œç›´åˆ°ä½ æ„è¯†åˆ°äº’è”ç½‘æ˜¯ä¸€ä¸ªæ ¹æœ¬ä¸å¯é çš„ç½‘ç»œã€‚åœ¨ä»ä¸€ä¸ªç«¯ç‚¹åˆ°å¦ä¸€ä¸ªç«¯ç‚¹çš„ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œæ•°æ®åŒ…ä¼šä¸¢å¤±å’Œå»¶è¿Ÿã€‚TCP çš„å¯é æ€§æ­£æ˜¯å…¶æœ€å—æ¬¢è¿çš„åŸå› ä¹‹ä¸€ã€‚å®ƒåªéœ€é‡<strong>æ–°ä¼ è¾“ä¸¢å¤±æ•°æ®åŒ…çš„å‰¯æœ¬</strong>å°±å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ç†è§£ä¼ è¾“å±‚æ˜¯å¦‚ä½•å¯¼è‡´é˜Ÿå¤´é˜»å¡çš„ã€‚å†æ¬¡æ€è€ƒä¸‹å›¾7å¹¶é—®è‡ªå·±ï¼šå¦‚æœ TCP æ•°æ®åŒ…2åœ¨ç½‘ç»œä¸­ä¸¢å¤±ï¼Œä½†æ•°æ®åŒ…1å’Œæ•°æ®åŒ…3å·²ç»åˆ°è¾¾ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿè¯·è®°ä½ï¼ŒTCPå¹¶ä¸çŸ¥é“å®ƒæ­£åœ¨æ‰¿è½½ HTTP/2ï¼ŒåªçŸ¥é“å®ƒéœ€è¦æŒ‰é¡ºåºä¼ é€’æ•°æ®ã€‚å› æ­¤ï¼Œå®ƒçŸ¥é“æ•°æ®åŒ…1çš„å†…å®¹å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¹¶å°†è¿™äº›å†…å®¹ä¼ é€’ç»™æµè§ˆå™¨ã€‚ç„¶è€Œï¼Œå®ƒå‘ç°æ•°æ®åŒ…1ä¸­çš„å­—èŠ‚å’Œæ•°æ®åŒ…3ä¸­çš„å­—èŠ‚ï¼ˆæ”¾æ•°æ®åŒ…2 çš„åœ°æ–¹ï¼‰ä¹‹é—´å­˜åœ¨é—´éš™ï¼Œå› æ­¤è¿˜ä¸èƒ½å°†æ•°æ®åŒ…3ä¼ é€’ç»™æµè§ˆå™¨ã€‚TCP å°†æ•°æ®åŒ…3ä¿å­˜åœ¨å…¶æ¥æ”¶ç¼“å†²åŒºï¼ˆreceive bufferï¼‰ä¸­ï¼Œç›´åˆ°å®ƒæ¥æ”¶åˆ°æ•°æ®åŒ…2çš„é‡ä¼ å‰¯æœ¬ï¼ˆè¿™è‡³å°‘éœ€è¦å¾€è¿”æœåŠ¡å™¨ä¸€æ¬¡ï¼‰ï¼Œä¹‹åå®ƒå¯ä»¥æŒ‰ç…§æ­£ç¡®çš„é¡ºåºå°†è¿™ä¸¤ä¸ªæ•°æ®åŒ…éƒ½ä¼ é€’ç»™æµè§ˆå™¨ã€‚æ¢ä¸ªè¯´æ³•ï¼š<strong>ä¸¢å¤±çš„æ•°æ®åŒ…2 é˜Ÿå¤´é˜»å¡ï¼ˆHOL blockingï¼‰æ•°æ®åŒ…3ï¼</strong></p><p>æ‚¨å¯èƒ½ä¸æ¸…æ¥šä¸ºä»€ä¹ˆè¿™æ˜¯ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°ç ”ç©¶å›¾7ä¸­ HTTP å±‚çš„ TCP åŒ…ä¸­çš„å®é™…å†…å®¹ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTCP æ•°æ®åŒ…2åªæºå¸¦æµid 2ï¼ˆCSSæ–‡ä»¶ï¼‰çš„æ•°æ®ï¼Œæ•°æ®åŒ…3åŒæ—¶æºå¸¦æµ1ï¼ˆJSæ–‡ä»¶ï¼‰å’Œæµ2çš„æ•°æ®ã€‚åœ¨ HTTP çº§åˆ«ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸¤ä¸ªæµæ˜¯ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”ç”±æ•°æ®å¸§ï¼ˆDATA frameï¼‰æ¸…æ¥šåœ°æè¿°å‡ºæ¥ã€‚å› æ­¤ï¼Œç†è®ºä¸Šæˆ‘ä»¬å¯ä»¥å®Œç¾åœ°å°†æ•°æ®åŒ…3ä¼ é€’ç»™æµè§ˆå™¨ï¼Œè€Œä¸å¿…ç­‰å¾…æ•°æ®åŒ…2åˆ°è¾¾ã€‚æµè§ˆå™¨å°†çœ‹åˆ°æµidä¸º1çš„æ•°æ®å¸§ï¼Œå¹¶ä¸”èƒ½å¤Ÿç›´æ¥ä½¿ç”¨å®ƒã€‚åªæœ‰æµ2å¿…é¡»è¢«æŒ‚èµ·ï¼Œç­‰å¾…æ•°æ®åŒ…2çš„é‡æ–°ä¼ è¾“ã€‚è¿™å°†æ¯”æˆ‘ä»¬ä» TCP çš„æ–¹å¼ä¸­å¾—åˆ°çš„æ•ˆç‡æ›´é«˜ï¼ŒTCP çš„æ–¹å¼æœ€ç»ˆä¼šé˜»å¡æµ1å’Œæµ2ã€‚</p><p>å¦ä¸€ä¸ªä¾‹å­æ˜¯æ•°æ®åŒ…1ä¸¢å¤±ï¼Œä½†æ˜¯æ¥æ”¶åˆ°2å’Œ3çš„æƒ…å†µã€‚TCPå°†å†æ¬¡é˜»æ­¢æ•°æ®åŒ…2å’Œ3ï¼Œç­‰å¾…1ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨HTTP/2çº§åˆ«ï¼Œæµ2çš„æ•°æ®ï¼ˆCSSæ–‡ä»¶ï¼‰å®Œå…¨å­˜åœ¨äºæ•°æ®åŒ…2å’Œ3ä¸­ï¼Œä¸å¿…ç­‰å¾…æ•°æ®åŒ…1çš„é‡æ–°ä¼ è¾“ã€‚æµè§ˆå™¨æœ¬å¯ä»¥å®Œç¾åœ°è§£æ/å¤„ç†/ä½¿ç”¨ CSS æ–‡ä»¶ï¼Œä½†å´è¢«å›°åœ¨ç­‰å¾… JS æ–‡ä»¶çš„é‡æ–°ä¼ è¾“ã€‚</p><p>æ€»ä¹‹ï¼ŒTCP ä¸çŸ¥é“ HTTP/2 çš„ç‹¬ç«‹æµï¼ˆstreamsï¼‰è¿™ä¸€äº‹å®æ„å‘³ç€ <strong>TCP å±‚é˜Ÿå¤´é˜»å¡ï¼ˆç”±äºä¸¢å¤±æˆ–å»¶è¿Ÿçš„æ•°æ®åŒ…ï¼‰ä¹Ÿæœ€ç»ˆå¯¼è‡´ HTTP é˜Ÿå¤´é˜»å¡ï¼</strong></p><p>ç°åœ¨ï¼Œæ‚¨å¯èƒ½ä¼šé—®è‡ªå·±ï¼šé‚£é‡ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœæˆ‘ä»¬ä»ç„¶æœ‰ TCP é˜Ÿå¤´é˜»å¡ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨HTTP/2 å‘¢ï¼Ÿå¥½å§ï¼Œä¸»è¦åŸå› æ˜¯è™½ç„¶æ•°æ®åŒ…ä¸¢å¤±ç¡®å®å‘ç”Ÿåœ¨ç½‘ç»œä¸Šï¼Œä½†è¿˜æ˜¯æ¯”è¾ƒå°‘è§çš„ã€‚ç‰¹åˆ«æ˜¯åœ¨æœ‰çº¿ç½‘ç»œä¸­ï¼ŒåŒ…ä¸¢å¤±ç‡åªæœ‰ 0.01%ã€‚å³ä½¿æ˜¯åœ¨æœ€å·®çš„èœ‚çªç½‘ç»œä¸Šï¼Œåœ¨ç°å®ä¸­ï¼Œæ‚¨ä¹Ÿå¾ˆå°‘çœ‹åˆ°ä¸¢åŒ…ç‡é«˜äº2%ã€‚è¿™ä¸æ•°æ®åŒ…ä¸¢å¤±å’ŒæŠ–åŠ¨ï¼ˆç½‘ç»œä¸­çš„å»¶è¿Ÿå˜åŒ–ï¼‰é€šå¸¸æ˜¯<strong>çªå‘æ€§</strong>çš„è¿™ä¸€äº‹å®ç»“åˆåœ¨ä¸€èµ·çš„ã€‚åŒ…ä¸¢å¤±ç‡ä¸º2%å¹¶ä¸æ„å‘³ç€æ¯100ä¸ªåŒ…ä¸­æ€»æ˜¯æœ‰2ä¸ªåŒ…ä¸¢å¤±ï¼ˆä¾‹å¦‚æ•°æ®åŒ… 42 å’Œ 96ï¼‰ã€‚å®é™…ä¸Šï¼Œå¯èƒ½æ›´åƒæ˜¯åœ¨æ€»å…±500ä¸ªåŒ…ä¸­ä¸¢å¤±10ä¸ª<strong>è¿ç»­çš„</strong>åŒ…ï¼ˆä¾‹å¦‚æ•°æ®åŒ…255åˆ°265ï¼‰ã€‚è¿™æ˜¯å› ä¸ºæ•°æ®åŒ…ä¸¢å¤±é€šå¸¸æ˜¯ç”±ç½‘ç»œè·¯å¾„ä¸­çš„è·¯ç”±å™¨å†…å­˜ç¼“å†²åŒºæš‚æ—¶æº¢å‡ºå¼•èµ·çš„ï¼Œè¿™äº›ç¼“å†²åŒºå¼€å§‹ä¸¢å¼ƒæ— æ³•å­˜å‚¨çš„æ•°æ®åŒ…ã€‚ä¸è¿‡ï¼Œç»†èŠ‚åœ¨è¿™é‡Œå¹¶ä¸é‡è¦ã€‚é‡è¦çš„æ˜¯ï¼šæ˜¯çš„ï¼ŒTCP é˜Ÿå¤´é˜»å¡æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œä½†æ˜¯å®ƒå¯¹ Web æ€§èƒ½çš„å½±å“è¦æ¯”HTTP/1.1 é˜Ÿå¤´é˜»å¡å°å¾—å¤šï¼ŒHTTP/1.1 é˜Ÿå¤´é˜»å¡å‡ ä¹å¯ä»¥ä¿è¯æ¯æ¬¡éƒ½ä¼šé‡åˆ°å®ƒï¼Œè€Œä¸”å®ƒä¹Ÿä¼šå—åˆ° TCP é˜Ÿå¤´é˜»å¡çš„å½±å“ï¼</p><p>ç„¶è€Œï¼Œå½“æ¯”è¾ƒå•ä¸ªè¿æ¥ä¸Šçš„ HTTP/2 å’Œå•ä¸ªè¿æ¥ä¸Šçš„ HTTP/1.1 æ—¶ï¼Œè¿™ä¸ªåŸºæœ¬ä¸Šæ˜¯çœŸçš„ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€çœ‹åˆ°çš„ï¼Œå®é™…ä¸Šå®ƒå¹¶ä¸æ˜¯è¿™æ ·å·¥ä½œçš„ï¼Œå› ä¸º HTTP/1.1 é€šå¸¸ä¼šæ‰“å¼€å¤šä¸ªè¿æ¥ã€‚è¿™ä½¿å¾— HTTP/1.1 ä¸ä»…åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡è½»äº† HTTP çº§åˆ«ï¼Œè€Œä¸”å‡è½»äº† TCP çº§åˆ«çš„é˜Ÿå¤´é˜»å¡ã€‚å› æ­¤ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå•ä¸ªè¿æ¥ä¸Šçš„ HTTP/2 å¾ˆéš¾æ¯”6ä¸ªè¿æ¥ä¸Šçš„ HTTP/1.1 å¿«ï¼Œç”šè‡³ä¸ HTTP/1.1 ä¸€æ ·å¿«ã€‚è¿™ä¸»è¦æ˜¯ç”±äº TCP çš„<strong>â€œæ‹¥å¡æ§åˆ¶â€ï¼ˆcongestion controlï¼‰</strong>æœºåˆ¶ã€‚ç„¶è€Œï¼Œè¿™æ˜¯å¦ä¸€ä¸ªéå¸¸æ·±å…¥çš„è¯é¢˜ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬è®¨è®ºé˜Ÿå¤´é˜»å¡ï¼ˆHOL blockingï¼‰çš„æ ¸å¿ƒï¼Œæ‰€ä»¥æˆ‘æŠŠå®ƒç§»åˆ°äº†æœ«å°¾çš„å¦ä¸€ä¸ªå½©è›‹éƒ¨åˆ†ã€‚</p><p>æ€»ä¹‹ï¼Œäº‹å®ä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼ˆä¹Ÿè®¸å‡ºä¹æ„æ–™ï¼‰ï¼Œ<strong>HTTP/2 ç›®å‰éƒ¨ç½²åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¸­ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹é€šå¸¸ä¸ HTTP/1.1 ä¸€æ ·å¿«æˆ–ç•¥å¿«</strong>ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™éƒ¨åˆ†æ˜¯å› ä¸ºç½‘ç«™åœ¨ä¼˜åŒ– HTTP/2 æ–¹é¢åšå¾—æ›´å¥½ï¼Œéƒ¨åˆ†åŸå› æ˜¯æµè§ˆå™¨ä»ç„¶ç»å¸¸æ‰“å¼€å¤šä¸ªå¹¶è¡Œ HTTP/2 è¿æ¥ï¼Œä»è€Œä½¿ä¸¤è€…å…¼å¾—ã€‚</p><p>ç„¶è€Œï¼Œä¹Ÿæœ‰ä¸€äº›æƒ…å†µï¼ˆç‰¹åˆ«æ˜¯åœ¨æ•°æ®åŒ…ä¸¢å¤±ç‡è¾ƒé«˜çš„ä½é€Ÿç½‘ç»œä¸Šï¼‰ï¼Œ6ä¸ªè¿æ¥çš„ HTTP/1.1 ä»ç„¶æ¯”ä¸€ä¸ªè¿æ¥çš„ HTTP/2 æ›´ä¸ºå‡ºè‰²ï¼Œè¿™é€šå¸¸æ˜¯ç”±äº TCP çº§åˆ«çš„é˜Ÿå¤´é˜»å¡é—®é¢˜é€ æˆçš„ã€‚æ­£æ˜¯è¿™ä¸ªäº‹å®æå¤§åœ°æ¨åŠ¨äº†æ–°çš„ QUIC ä¼ è¾“åè®®çš„å¼€å‘ï¼Œä»¥å–ä»£ TCPã€‚</p><h2 id="HTTP-3ï¼ˆåŸºäº-QUICï¼‰çš„é˜Ÿå¤´é˜»å¡"><a href="#HTTP-3ï¼ˆåŸºäº-QUICï¼‰çš„é˜Ÿå¤´é˜»å¡" class="headerlink" title="HTTP/3ï¼ˆåŸºäº QUICï¼‰çš„é˜Ÿå¤´é˜»å¡"></a>HTTP/3ï¼ˆåŸºäº QUICï¼‰çš„é˜Ÿå¤´é˜»å¡</h2><p>åœ¨é‚£ä¹‹åï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å¼€å§‹è°ˆè®ºæ–°çš„ä¸œè¥¿äº†ï¼ä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹æˆ‘ä»¬ç›®å‰æ‰€å­¦åˆ°çš„ï¼š</p><ul><li>HTTP/1.1 æœ‰é˜Ÿå¤´é˜»å¡ï¼Œå› ä¸ºå®ƒéœ€è¦å®Œæ•´åœ°å‘é€å“åº”ï¼Œå¹¶ä¸”ä¸èƒ½å¤šè·¯å¤ç”¨å®ƒä»¬</li><li>HTTP/2 é€šè¿‡å¼•å…¥â€œå¸§â€ï¼ˆframesï¼‰æ ‡è¯†æ¯ä¸ªèµ„æºå—å±äºå“ªä¸ªâ€œæµâ€ï¼ˆstreamï¼‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜</li><li>ç„¶è€Œï¼ŒTCP ä¸çŸ¥é“è¿™äº›å•ç‹¬çš„â€œæµâ€ï¼ˆstreamsï¼‰ï¼Œåªæ˜¯æŠŠæ‰€æœ‰çš„ä¸œè¥¿çœ‹ä½œä¸€ä¸ªå¤§æµï¼ˆ1 big streamï¼‰</li><li>å¦‚æœä¸€ä¸ª TCP åŒ…ä¸¢å¤±ï¼Œæ‰€æœ‰åç»­çš„åŒ…éƒ½éœ€è¦ç­‰å¾…å®ƒçš„é‡ä¼ ï¼Œå³ä½¿å®ƒä»¬åŒ…å«æ¥è‡ªä¸åŒæµçš„æ— å…³è”æ•°æ®ã€‚TCP å…·æœ‰ä¼ è¾“å±‚é˜Ÿå¤´é˜»å¡ã€‚</li></ul><p>æˆ‘æ•¢è‚¯å®šä½ ç°åœ¨å¯ä»¥é¢„æµ‹æˆ‘ä»¬å¦‚ä½•è§£å†³ TCP çš„é—®é¢˜ï¼Œå¯¹å§ï¼Ÿæ¯•ç«Ÿï¼Œè§£å†³æ–¹æ¡ˆå¾ˆç®€å•ï¼šæˆ‘ä»¬â€œåªæ˜¯â€éœ€è¦<strong>è®©ä¼ è¾“å±‚çŸ¥é“ä¸åŒçš„ã€ç‹¬ç«‹çš„æµ</strong>ï¼è¿™æ ·ï¼Œå¦‚æœä¸€ä¸ªæµçš„æ•°æ®ä¸¢å¤±ï¼Œä¼ è¾“å±‚æœ¬èº«å°±çŸ¥é“å®ƒä¸éœ€è¦é˜»å¡å…¶ä»–æµã€‚</p><p>å°½ç®¡è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ¦‚å¿µç®€å•ï¼Œä½†åœ¨ç°å®ä¸­å´å¾ˆéš¾å®ç°ã€‚ç”±äºå„ç§åŸå› ï¼Œä¸å¯èƒ½æ”¹å˜ TCP æœ¬èº«ä½¿å…¶å…·æœ‰æµæ„è¯†ï¼ˆstream-awareï¼‰ã€‚é€‰æ‹©çš„æ›¿ä»£æ–¹æ³•æ˜¯ä»¥ QUIC çš„å½¢å¼å®ç°ä¸€ä¸ªå…¨æ–°çš„ä¼ è¾“å±‚åè®®ã€‚ä¸ºäº†ä½¿ QUIC ç°å®ä¸­å¯ä»¥éƒ¨ç½²åœ¨å› ç‰¹ç½‘ä¸Šï¼Œå®ƒè¿è¡Œåœ¨ä¸å¯é çš„ UDP åè®®ä¹‹ä¸Šã€‚ç„¶è€Œï¼Œéå¸¸é‡è¦çš„æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€ QUIC æœ¬èº«ä¹Ÿæ˜¯ä¸å¯é çš„ï¼åœ¨è®¸å¤šæ–¹é¢ï¼ŒQUIC åº”è¯¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ª TCP 2.0ã€‚å®ƒåŒ…æ‹¬ TCP çš„æ‰€æœ‰ç‰¹æ€§ï¼ˆå¯é æ€§ã€æ‹¥å¡æ§åˆ¶ã€æµé‡æ§åˆ¶ã€æ’åºç­‰ï¼‰çš„æœ€ä½³ç‰ˆæœ¬ï¼Œä»¥åŠæ›´å¤šå…¶ä»–ç‰¹æ€§ã€‚QUICè¿˜å®Œå…¨é›†æˆäº†TLSï¼ˆå‚è§å›¾6ï¼‰ï¼Œå¹¶ä¸”ä¸å…è®¸æœªåŠ å¯†çš„è¿æ¥ã€‚å› ä¸º QUIC ä¸ TCP å¦‚æ­¤ä¸åŒï¼Œè¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ä»…ä»…åœ¨å…¶ä¸Šè¿è¡Œ HTTP/2ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåˆ›å»ºäº† HTTP/3ï¼ˆç¨åæˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼‰ã€‚è¿™ç¯‡åšæ–‡å·²ç»è¶³å¤Ÿé•¿äº†ï¼Œä¸éœ€è¦æ›´è¯¦ç»†åœ°è®¨è®ºQUICï¼Œå› æ­¤æˆ‘å°†åªå…³æ³¨æˆ‘ä»¬éœ€è¦äº†è§£å½“å‰é˜Ÿå¤´é˜»å¡è®¨è®ºçš„å‡ ä¸ªéƒ¨åˆ†ã€‚å¦‚å›¾8æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132618174.png" alt="image-20240427132618174"></p><center>å›¾8ï¼šHTTP/1.1 vs HTTP/2 vs HTTP/3 å“åº” script.js</center><p>æˆ‘ä»¬è§‚å¯Ÿåˆ°ï¼Œè®© QUIC çŸ¥é“ä¸åŒçš„æµï¼ˆstreamsï¼‰æ˜¯éå¸¸ç®€å•çš„ã€‚QUIC å—åˆ° HTTP/2 å¸§æ–¹å¼ï¼ˆframing-approachï¼‰çš„å¯å‘ï¼Œè¿˜æ·»åŠ äº†è‡ªå·±çš„å¸§ï¼ˆframesï¼‰ï¼›åœ¨æœ¬ä¾‹ä¸­æ˜¯æµå¸§ï¼ˆSTREAM frameï¼‰ã€‚æµidï¼ˆstream idï¼‰ä»¥å‰åœ¨ HTTP/2 çš„æ•°æ®å¸§ï¼ˆDATA frameï¼‰ä¸­ï¼Œç°åœ¨è¢«<strong>ä¸‹ç§»åˆ°ä¼ è¾“å±‚çš„ QUIC æµå¸§ï¼ˆSTREAM frameï¼‰ä¸­</strong>ã€‚è¿™ä¹Ÿè¯´æ˜äº†å¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨ QUICï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ HTTP çš„åŸå› ä¹‹ä¸€ï¼šå¦‚æœæˆ‘ä»¬åªåœ¨ QUIC ä¹‹ä¸Šè¿è¡Œ HTTP/2ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æœ‰ä¸¤ä¸ªï¼ˆå¯èƒ½å†²çªçš„ï¼‰â€œæµå±‚â€ï¼ˆstream layersï¼‰ã€‚ç›¸åï¼ŒHTTP/3 ä» HTTP å±‚åˆ é™¤äº†æµçš„æ¦‚å¿µï¼ˆå®ƒçš„æ•°æ®å¸§ï¼ˆDATA framesï¼‰æ²¡æœ‰æµidï¼‰ï¼Œè€Œæ˜¯é‡æ–°ä½¿ç”¨åº•å±‚çš„ QUIC æµã€‚</p><p><em>æ³¨æ„ï¼šè¿™å¹¶ä¸æ„å‘³ç€ QUIC çªç„¶çŸ¥é“ JS æˆ– CSS æ–‡ä»¶ï¼Œç”šè‡³çŸ¥é“å®ƒæ­£åœ¨ä¼ è¾“ HTTPï¼›å’Œ TCP ä¸€æ ·ï¼ŒQUIC åº”è¯¥æ˜¯ä¸€ä¸ªé€šç”¨çš„ã€å¯é‡ç”¨çš„åè®®ã€‚å®ƒåªçŸ¥é“æœ‰ç‹¬ç«‹çš„æµï¼ˆstreamsï¼‰ï¼Œå®ƒå¯ä»¥å•ç‹¬å¤„ç†ï¼Œè€Œä¸å¿…çŸ¥é“å®ƒä»¬åˆ°åº•æ˜¯ä»€ä¹ˆã€‚</em></p><p>ç°åœ¨æˆ‘ä»¬äº†è§£äº†QUICçš„æµå¸§ï¼ˆSTREAM framesï¼‰ï¼Œä¹Ÿå¾ˆå®¹æ˜“çœ‹å‡ºå®ƒä»¬å¦‚ä½•å¸®åŠ©è§£å†³å›¾9ä¸­çš„ä¼ è¾“å±‚é˜Ÿå¤´é˜»å¡ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132627615.png" alt="image-20240427132627615"></p><center>å›¾9ï¼šTCP å’Œ QUIC åœ¨é€è§†å›¾ä¸Šçš„å·®å¼‚</center><p>ä¸ HTTP/2 çš„æ•°æ®å¸§ï¼ˆDATA framesï¼‰éå¸¸ç›¸ä¼¼ï¼Œ<strong>QUIC çš„æµå¸§ï¼ˆSTREAM framesï¼‰åˆ†åˆ«è·Ÿè¸ªæ¯ä¸ªæµçš„å­—èŠ‚èŒƒå›´</strong>ã€‚è¿™ä¸ TCP ä¸åŒï¼ŒTCP åªæ˜¯å°†æ‰€æœ‰æµæ•°æ®é™„åŠ åˆ°ä¸€ä¸ªå¤§ blob ä¸­ã€‚åƒä»¥å‰ä¸€æ ·ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚æœ QUIC æ•°æ®åŒ…2ä¸¢å¤±ï¼Œè€Œ 1 å’Œ 3 åˆ°è¾¾ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ä¸ TCP ç±»ä¼¼ï¼Œæ•°æ®åŒ…1ä¸­æµ1ï¼ˆstream 1ï¼‰çš„æ•°æ®å¯ä»¥ç›´æ¥ä¼ é€’åˆ°æµè§ˆå™¨ã€‚ç„¶è€Œï¼Œå¯¹äºæ•°æ®åŒ…3ï¼ŒQUIC å¯ä»¥æ¯” TCP æ›´èªæ˜ã€‚å®ƒæŸ¥çœ‹æµ1çš„å­—èŠ‚èŒƒå›´ï¼Œå‘ç°è¿™ä¸ªæµå¸§ï¼ˆSTREAM frameï¼‰å®Œå…¨éµå¾ªæµid 1çš„ç¬¬ä¸€ä¸ªæµå¸§ STREAM frameï¼ˆå­—èŠ‚ 450 è·Ÿåœ¨å­—èŠ‚ 449 ä¹‹åï¼Œå› æ­¤æ•°æ®ä¸­æ²¡æœ‰å­—èŠ‚é—´éš™ï¼‰ã€‚å®ƒå¯ä»¥ç«‹å³å°†è¿™äº›æ•°æ®æä¾›ç»™æµè§ˆå™¨è¿›è¡Œå¤„ç†ã€‚ç„¶è€Œï¼Œå¯¹äºæµid 2ï¼ŒQUICç¡®å®çœ‹åˆ°äº†ä¸€ä¸ªç¼ºå£ï¼ˆå®ƒè¿˜æ²¡æœ‰æ¥æ”¶åˆ°å­—èŠ‚0-299ï¼Œè¿™äº›å­—èŠ‚åœ¨ä¸¢å¤±çš„ QUIC æ•°æ®åŒ…2ä¸­ï¼‰ã€‚å®ƒå°†ä¿å­˜è¯¥æµå¸§ï¼ˆSTREAM frameï¼‰ï¼Œç›´åˆ° QUIC æ•°æ®åŒ…2çš„é‡ä¼ ï¼ˆretransmissionï¼‰åˆ°è¾¾ã€‚å†æ¬¡å°†å…¶ä¸ TCP è¿›è¡Œå¯¹æ¯”ï¼Œåè€…ä¹Ÿå°†æ•°æ®æµ1çš„æ•°æ®ä¿ç•™åœ¨æ•°æ®åŒ…3ä¸­ï¼</p><p>ç±»ä¼¼çš„æƒ…å†µå‘ç”Ÿåœ¨å¦ä¸€ç§æƒ…å½¢ä¸‹ï¼Œæ•°æ®åŒ…1ä¸¢å¤±ï¼Œä½†2å’Œ3åˆ°è¾¾ã€‚QUIC çŸ¥é“å®ƒå·²ç»æ¥æ”¶åˆ°æµ2ï¼ˆstream 2ï¼‰çš„æ‰€æœ‰é¢„æœŸæ•°æ®ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™æµè§ˆå™¨ï¼Œåªä¿ç•™æµ1ï¼ˆstream 1ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­ï¼ŒQUIC ç¡®å®è§£å†³äº† TCP çš„é˜Ÿå¤´é˜»å¡ï¼</p><p>ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼æœ‰å‡ ä¸ªé‡è¦çš„åæœã€‚æœ€æœ‰å½±å“çš„æ˜¯ <strong>QUIC æ•°æ®å¯èƒ½ä¸å†ä»¥ä¸å‘é€æ—¶å®Œå…¨ç›¸åŒçš„é¡ºåºå‘é€åˆ°æµè§ˆå™¨</strong>ã€‚å¯¹äº TCPï¼Œå¦‚æœæ‚¨å‘é€æ•°æ®åŒ…1ã€2å’Œ3ï¼Œå®ƒä»¬çš„å†…å®¹å°†ä»¥å®Œå…¨ç›¸åŒçš„é¡ºåºå‘é€åˆ°æµè§ˆå™¨ï¼ˆè¿™å°±æ˜¯å¯¼è‡´é˜Ÿå¤´é˜»å¡çš„ç¬¬ä¸€ä¸ªåŸå› ï¼‰ã€‚ç„¶è€Œï¼Œå¯¹äº QUICï¼Œåœ¨ä¸Šé¢çš„ç¬¬äºŒä¸ªç¤ºä¾‹ä¸­ï¼Œåœ¨æ•°æ®åŒ…1ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨é¦–å…ˆçœ‹åˆ°æ•°æ®åŒ…2çš„å†…å®¹ï¼Œç„¶åæ˜¯æ•°æ®åŒ…3çš„æœ€åä¸€éƒ¨åˆ†ï¼Œç„¶åæ˜¯æ•°æ®åŒ…1çš„ï¼ˆé‡ä¼ ï¼‰ï¼Œç„¶åæ˜¯æ•°æ®åŒ…3çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚æ¢è¨€ä¹‹ï¼š<strong>QUIC åœ¨å•ä¸ªèµ„æºæµä¸­ä¿ç•™äº†é¡ºåºï¼Œä½†ä¸å†è·¨å•ä¸ªæµï¼ˆindividual streamsï¼‰è¿›è¡Œæ’åº</strong>ã€‚</p><p>è¿™æ˜¯éœ€è¦ HTTP/3 çš„ç¬¬äºŒä¸ªä¹Ÿæ˜¯æœ€é‡è¦çš„åŸå› ï¼Œå› ä¸ºäº‹å®è¯æ˜ï¼ŒHTTP/2 ä¸­çš„å‡ ä¸ªç³»ç»Ÿéå¸¸ä¸¥é‡åœ°ä¾èµ–äº TCP è·¨æµï¼ˆacross streamsï¼‰çš„å®Œå…¨ç¡®å®šæ€§æ’åºã€‚ä¾‹å¦‚ï¼ŒHTTP/2 çš„ä¼˜å…ˆçº§ç³»ç»Ÿé€šè¿‡ä¼ è¾“æ›´æ”¹æ ‘æ•°æ®ç»“æ„ï¼ˆtree data structure ï¼‰å¸ƒå±€çš„æ“ä½œï¼ˆä¾‹å¦‚ï¼Œå°†èµ„æº5æ·»åŠ ä¸ºèµ„æº6çš„å­çº§ï¼‰å·¥ä½œçš„ã€‚å¦‚æœè¿™äº›æ“ä½œåº”ç”¨çš„é¡ºåºä¸å‘é€é¡ºåºä¸åŒï¼ˆç°åœ¨é€šè¿‡ QUIC æ˜¯å¯èƒ½å‡ºç°çš„ï¼‰ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ä¼˜å…ˆçº§çŠ¶æ€å¯èƒ½ä¸åŒã€‚HTTP/2 çš„å¤´å‹ç¼©ç³»ç»Ÿ HPACK ä¹Ÿä¼šå‘ç”Ÿç±»ä¼¼çš„æƒ…å†µã€‚ç†è§£è¿™é‡Œçš„ç»†èŠ‚å¹¶ä¸é‡è¦ï¼Œåªéœ€è¦å¾—å‡ºç»“è®ºï¼šè¦è®©è¿™äº› HTTP/2 ç³»ç»Ÿç›´æ¥åº”ç”¨ QUIC æ˜¯éå¸¸å›°éš¾çš„ã€‚å› æ­¤ï¼Œ<strong>å¯¹äº HTTP/3ï¼Œæœ‰äº›ç³»ç»Ÿä½¿ç”¨å®Œå…¨ä¸åŒçš„æ–¹æ³•</strong>ã€‚ä¾‹å¦‚ï¼ŒQPACK æ˜¯ HTTP/3 çš„ HPACK ç‰ˆæœ¬ï¼Œå®ƒå…è®¸åœ¨æ½œåœ¨çš„é˜Ÿå¤´é˜»å¡å’Œå‹ç¼©æ€§èƒ½ä¹‹é—´è¿›è¡Œè‡ªæˆ‘é€‰æ‹©çš„æƒè¡¡ã€‚HTTP/2 çš„ä¼˜å…ˆçº§ç³»ç»Ÿç”šè‡³è¢«å®Œå…¨åˆ é™¤ï¼Œå¾ˆå¯èƒ½ä¼šè¢« HTTP/3 çš„ç®€åŒ–ç‰ˆæœ¬æ‰€å–ä»£ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å› ä¸ºï¼Œä¸ TCP ä¸åŒï¼ŒQUIC ä¸èƒ½å®Œå…¨ä¿è¯é¦–å…ˆå‘é€çš„æ•°æ®ä¹Ÿä¼šé¦–å…ˆè¢«æ¥æ”¶ã€‚</p><p>æ‰€ä»¥ï¼Œæ‰€æœ‰ QUIC å’Œé‡æ–°è®¾æƒ³ HTTP ç‰ˆæœ¬çš„è¿™äº›å·¥ä½œéƒ½æ˜¯ä¸ºäº†æ¶ˆé™¤ä¼ è¾“å±‚é˜Ÿå¤´é˜»å¡ã€‚æˆ‘å½“ç„¶å¸Œæœ›è¿™æ˜¯å€¼å¾—çš„â€¦</p><h2 id="QUIC-å’Œ-HTTP-3-çœŸçš„å®Œå…¨æ¶ˆé™¤äº†é˜Ÿå¤´é˜»å¡ï¼Ÿ"><a href="#QUIC-å’Œ-HTTP-3-çœŸçš„å®Œå…¨æ¶ˆé™¤äº†é˜Ÿå¤´é˜»å¡ï¼Ÿ" class="headerlink" title="QUIC å’Œ HTTP/3 çœŸçš„å®Œå…¨æ¶ˆé™¤äº†é˜Ÿå¤´é˜»å¡ï¼Ÿ"></a>QUIC å’Œ HTTP/3 çœŸçš„å®Œå…¨æ¶ˆé™¤äº†é˜Ÿå¤´é˜»å¡ï¼Ÿ</h2><p>å¦‚æœä½ å…è®¸æˆ‘è¯´ä¸€ç‚¹ä¸å¥½çš„è¯ï¼Œæˆ‘æƒ³å¼•ç”¨è‡ªå·±å‡ ä¸ªæ®µè½å‰çš„è¯ï¼š</p><blockquote><p>QUICåœ¨å•ä¸ªèµ„æºæµä¸­ä¿ç•™æ’åº</p></blockquote><p>ä½ æƒ³æƒ³ï¼Œè¿™å¾ˆç¬¦åˆé€»è¾‘ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯è¿™æ ·è¯´çš„ï¼šå¦‚æœä½ æœ‰ä¸€ä¸ª JavaScript æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶éœ€è¦é‡æ–°ç»„è£…ï¼ˆre-assembledï¼‰ï¼Œå°±åƒå®ƒæ˜¯ç”±å¼€å‘äººå‘˜åˆ›å»ºçš„ä¸€æ ·ï¼ˆæˆ–è€…ï¼Œè€å®è¯´ï¼Œé€šè¿‡ webpackï¼‰ï¼Œå¦åˆ™ä»£ç å°†æ— æ³•å·¥ä½œã€‚ä»»ä½•ç±»å‹çš„æ–‡ä»¶éƒ½æ˜¯ä¸€æ ·çš„ï¼šæŠŠå›¾ç‰‡éšæœºåœ°æ”¾åœ¨ä¸€èµ·æ„å‘³ç€ä½ é˜¿å§¨å¯„æ¥çš„ä¸€äº›å¥‡æ€ªçš„ç”µå­åœ£è¯å¡ï¼ˆç”šè‡³æ›´å¥‡æ€ªçš„ï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œ<strong>å³ä½¿åœ¨QUICä¸­ï¼Œæˆ‘ä»¬ä»ç„¶æœ‰ä¸€ç§é˜Ÿå¤´é˜»å¡çš„å½¢å¼</strong>ï¼šå¦‚æœåœ¨å•ä¸ªæµä¸­æœ‰ä¸€ä¸ªå­—èŠ‚é—´éš™ï¼Œé‚£ä¹ˆæµçš„åé¢éƒ¨åˆ†ä»ç„¶ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è¿™ä¸ªé—´éš™è¢«å¡«æ»¡ã€‚</p><p>è¿™æœ‰ä¸€ä¸ªå…³é”®çš„å«ä¹‰ï¼šQUIC çš„é˜Ÿå¤´é˜»å¡ç§»é™¤åªæœ‰åœ¨<strong>å¤šä¸ªèµ„æºæµåŒæ—¶æ´»åŠ¨æ—¶</strong>æ‰æœ‰æ•ˆã€‚è¿™æ ·ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæµä¸Šæœ‰åŒ…ä¸¢å¤±ï¼Œå…¶ä»–æµä»ç„¶å¯ä»¥ç»§ç»­ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šé¢å›¾9çš„ä¾‹å­ä¸­çœ‹åˆ°çš„ã€‚ç„¶è€Œï¼Œå¦‚æœåœ¨æŸä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæµåœ¨æ´»åŠ¨ï¼Œä»»ä½•ä¸¢åŒ…éƒ½ä¼šå½±å“åˆ°è¿™æ¡å­¤ç‹¬çš„æµï¼Œæˆ‘ä»¬ä»ç„¶ä¼šè¢«é˜»å¡ï¼Œå³ä½¿åœ¨ QUICã€‚æ‰€ä»¥ï¼ŒçœŸæ­£çš„é—®é¢˜æ˜¯ï¼š<strong>æˆ‘ä»¬ä¼šç»å¸¸æœ‰å¤šä¸ªå¹¶å‘æµï¼ˆsimultaneous streamsï¼‰å—ï¼Ÿ</strong></p><p>æ­£å¦‚å¯¹ HTTP/2 æ‰€è§£é‡Šçš„ï¼Œè¿™æ˜¯å¯ä»¥é€šè¿‡ä½¿ç”¨é€‚å½“çš„èµ„æºè°ƒåº¦å™¨/å¤šè·¯å¤ç”¨æ–¹æ³•æ¥é…ç½®çš„ã€‚æµ1å’Œæµ2å¯ä»¥è¢«å‘é€ 1122ã€2121ã€1221 ç­‰ï¼Œå¹¶ä¸”æµè§ˆå™¨å¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§ç³»ç»ŸæŒ‡å®šå®ƒå¸Œæœ›æœåŠ¡å™¨éµå¾ªçš„æ–¹æ¡ˆï¼ˆå¯¹äº HTTP/3 ä»ç„¶å¦‚æ­¤ï¼‰ã€‚æ‰€ä»¥æµè§ˆå™¨å¯ä»¥è¯´ï¼šå˜¿ï¼æˆ‘æ³¨æ„åˆ°è¿™ä¸ªè¿æ¥æœ‰ä¸¥é‡çš„æ•°æ®åŒ…ä¸¢å¤±ã€‚æˆ‘å°†è®©æœåŠ¡å™¨ä»¥ 121212 æ¨¡å¼è€Œä¸æ˜¯ 111222 å‘æˆ‘å‘é€èµ„æºã€‚è¿™æ ·ï¼Œå¦‚æœ1çš„ä¸€ä¸ªæ•°æ®åŒ…ä¸¢å¤±ï¼Œ2ä»ç„¶å¯ä»¥ç»§ç»­å·¥ä½œã€‚ç„¶è€Œï¼Œè¿™ç§æ¨¡å¼çš„é—®é¢˜æ˜¯ï¼Œ<strong>121212 æ¨¡å¼ï¼ˆæˆ–è€…ç±»ä¼¼çš„ï¼‰å¯¹èµ„æºåŠ è½½æ€§èƒ½é€šå¸¸ä¸æ˜¯æœ€ä¼˜çš„ã€‚</strong></p><p>è¿™æ˜¯å¦ä¸€ä¸ªå¤æ‚çš„è¯é¢˜ï¼Œæˆ‘ç°åœ¨ä¸æƒ³å¤ªæ·±å…¥ã€‚ä½†æ˜¯ï¼Œé€šè¿‡æˆ‘ä»¬çš„ JS å’Œ CSS æ–‡ä»¶çš„ç®€å•ç¤ºä¾‹ï¼ŒåŸºæœ¬æ¦‚å¿µå¾ˆå®¹æ˜“ç†è§£ã€‚æ­£å¦‚æ‚¨å¯èƒ½çŸ¥é“çš„é‚£æ ·ï¼Œæµè§ˆå™¨éœ€è¦æ¥æ”¶æ•´ä¸ª JS æˆ– CSS æ–‡ä»¶ï¼Œç„¶åæ‰èƒ½å®é™…æ‰§è¡Œ/åº”ç”¨å®ƒï¼ˆè™½ç„¶æœ‰äº›æµè§ˆå™¨å·²ç»å¯ä»¥å¼€å§‹ç¼–è¯‘/è§£æéƒ¨åˆ†ä¸‹è½½çš„æ–‡ä»¶ï¼Œä½†å®ƒä»¬ä»ç„¶éœ€è¦ç­‰å¾…å®ƒä»¬å®Œæ•´åæ‰èƒ½å®é™…ä½¿ç”¨å®ƒä»¬ï¼‰ã€‚ä½†æ˜¯ï¼Œå¤§é‡å¤šè·¯å¤ç”¨è¿™äº›æ–‡ä»¶çš„èµ„æºå—æœ€ç»ˆä¼šå»¶è¿Ÿå®ƒä»¬ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨å¤šè·¯å¤ç”¨ï¼ˆè¾ƒæ…¢ï¼‰ï¼š</span><br><span class="line">---------------------------</span><br><span class="line">                              æµ1ï¼ˆStream 1ï¼‰åªæœ‰åˆ°è¿™é‡Œæ‰èƒ½ä½¿ç”¨</span><br><span class="line">                              â–¼</span><br><span class="line">12121212121212121212121212121212</span><br><span class="line">                               â–²</span><br><span class="line">                               æµ2ï¼ˆStream 2ï¼‰åœ¨è¿™é‡Œä¸‹è½½å®Œæ¯•</span><br><span class="line"></span><br><span class="line">æœªä½¿ç”¨å¤šè·¯å¤ç”¨/é¡ºåºï¼ˆæµ1ï¼ˆStream 1ï¼‰æ›´å¿«ï¼‰ï¼š</span><br><span class="line">------------------------------------------------------</span><br><span class="line">                 æµ1ï¼ˆStream 1ï¼‰åœ¨è¿™é‡Œä¸‹è½½å®Œæ¯•ï¼Œå¯ä»¥æ›´æ—©åœ°ä½¿ç”¨</span><br><span class="line">                 â–¼   </span><br><span class="line">11111111111111111122222222222222</span><br><span class="line">                               â–²</span><br><span class="line">                               æµ2ï¼ˆStream 2ï¼‰è¿˜æ˜¯åœ¨è¿™é‡Œä¸‹è½½å®Œæ¯•</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œè¿™ä¸ªè¯é¢˜æœ‰å¾ˆå¤šç»†å¾®å·®åˆ«ï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨å¤šè·¯å¤ç”¨æ–¹æ³•æ›´å¿«çš„æƒ…å†µï¼ˆä¾‹å¦‚ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæ–‡ä»¶æ¯”å¦ä¸€ä¸ªæ–‡ä»¶å°å¾—å¤šï¼Œæ­£å¦‚æœ¬æ–‡å‰é¢è®¨è®ºçš„é‚£æ ·ï¼‰ã€‚ç„¶è€Œï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºå¤§å¤šæ•°é¡µé¢å’Œå¤§å¤šæ•°èµ„æºç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥è¯´é¡ºåºæ–¹æ³•æœ€æœ‰æ•ˆã€‚</p><p>ç°åœ¨ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå¯¹äºæœ€ä½³æ€§èƒ½ï¼Œæˆ‘ä»¬æœ‰<strong>ä¸¤ä¸ªç›¸äº’å†²çªçš„æ€§èƒ½ä¼˜åŒ–å»ºè®®</strong>ï¼š</p><ol><li>ä» QUIC çš„é˜Ÿå¤´é˜»å¡ç§»é™¤ä¸­è·åˆ©ï¼šå¤šè·¯å¤ç”¨å‘é€èµ„æºï¼ˆ12121212ï¼‰</li><li>ä¸ºäº†ç¡®ä¿æµè§ˆå™¨èƒ½å¤Ÿå°½å¿«å¤„ç†æ ¸å¿ƒèµ„æºï¼šæŒ‰é¡ºåºå‘é€èµ„æºï¼ˆ11112222ï¼‰</li></ol><p>é‚£ä¹ˆï¼Œå“ªä¸€ä¸ªæ˜¯æ­£ç¡®çš„ï¼Ÿæˆ–è€…è‡³å°‘ï¼šå“ªä¸€ä¸ªåº”è¯¥ä¼˜å…ˆäºå¦ä¸€ä¸ªï¼Ÿå¯æ‚²çš„æ˜¯ï¼Œç›®å‰æˆ‘è¿˜ä¸èƒ½ç»™ä½ ä¸€ä¸ªæ˜ç¡®çš„ç­”æ¡ˆï¼Œå› ä¸ºè¿™æ˜¯æˆ‘æ­£åœ¨ç ”ç©¶çš„ä¸€ä¸ªä¸»é¢˜ã€‚è¿™ä¹‹æ‰€ä»¥å›°éš¾ï¼Œä¸»è¦æ˜¯å› ä¸º<strong>æ•°æ®åŒ…ä¸¢å¤±æ¨¡å¼å¾ˆéš¾é¢„æµ‹</strong>ã€‚</p><p>æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢è®¨è®ºè¿‡çš„ï¼ŒåŒ…ä¸¢å¤±é€šå¸¸æ˜¯çªå‘æ€§çš„å’Œåˆ†ç»„çš„ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¸Šé¢ 12121212 çš„ä¾‹å­å·²ç»è¿‡äºç®€åŒ–äº†ã€‚å›¾10ç»™å‡ºäº†ä¸€ä¸ªæ›´çœŸå®çš„æ¦‚è¿°ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å‡è®¾åœ¨ä¸‹è½½2ä¸ªæµï¼ˆç»¿è‰²å’Œç´«è‰²ï¼‰æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª8ä¸ªä¸¢å¤±åŒ…çš„çªå‘äº‹ä»¶ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132717355.png" alt="image-20240427132717355"></p><center>å›¾10ï¼šHTTP/3 over QUIC æµå¤šè·¯å¤ç”¨å¯¹é˜²æ­¢é˜Ÿå¤´é˜»å¡çš„å½±å“ã€‚æ¯ä¸ªçŸ©å½¢æ˜¯ä¸€ä¸ªå•ç‹¬çš„QUICåŒ…ï¼Œä¸ºä¸€ä¸ªæµä¼ è¾“æ•°æ®ã€‚çº¢å‰è¡¨ç¤ºä¸¢å¤±çš„åŒ…ã€‚</center><p>åœ¨å›¾10çš„é¡¶éƒ¨ç¬¬ä¸€è¡Œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ˆé€šå¸¸ï¼‰å¯¹èµ„æºåŠ è½½æ€§èƒ½æ›´å¥½çš„é¡ºåºæƒ…å†µã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ° QUIC å¯¹æ¶ˆé™¤é˜Ÿå¤´é˜»å¡ç¡®å®æ²¡æœ‰é‚£ä¹ˆå¤§çš„å¸®åŠ©ï¼šåœ¨ä¸¢åŒ…ä¹‹åæ”¶åˆ°çš„ç»¿åŒ…ä¸èƒ½è¢«æµè§ˆå™¨å¤„ç†ï¼Œå› ä¸ºå®ƒä»¬å±äºç»å†ä¸¢åŒ…çš„åŒä¸€ä¸ªæµã€‚ç¬¬äºŒä¸ªï¼ˆç´«è‰²ï¼‰æµçš„æ•°æ®å°šæœªæ”¶åˆ°ï¼Œå› æ­¤æ— æ³•å¤„ç†ã€‚</p><p>è¿™ä¸ä¸­é—´ä¸€è¡Œä¸åŒï¼Œä¸­é—´ä¸€è¡Œï¼ˆå¶ç„¶ï¼ï¼‰ä¸¢å¤±çš„8ä¸ªæ•°æ®åŒ…éƒ½æ¥è‡ªç»¿è‰²æµã€‚è¿™æ„å‘³ç€æµè§ˆå™¨å¯ä»¥å¤„ç†æœ€åæ”¶åˆ°çš„ç´«è‰²æ•°æ®åŒ…ã€‚ç„¶è€Œï¼Œæ­£å¦‚å‰é¢æ‰€è®¨è®ºçš„ï¼Œå¦‚æœæµè§ˆå™¨æ˜¯ JS æˆ– CSS æ–‡ä»¶ï¼Œå¦‚æœæœ‰æ›´å¤šçš„ç´«è‰²æ•°æ®å‡ºç°ï¼Œæµè§ˆå™¨å¯èƒ½ä¸ä¼šä»ä¸­å—ç›Šå¤ªå¤šã€‚å› æ­¤ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä» QUIC çš„é˜Ÿå¤´é˜»å¡ç§»é™¤ä¸­è·å¾—äº†ä¸€äº›å¥½å¤„ï¼ˆå› ä¸ºç´«è‰²æ²¡æœ‰è¢«ç»¿è‰²é˜»æ­¢ï¼‰ï¼Œä½†æ˜¯å¯èƒ½ä¼šç‰ºç‰²æ•´ä½“èµ„æºåŠ è½½æ€§èƒ½ï¼ˆå› ä¸ºå¤šè·¯å¤ç”¨ä¼šå¯¼è‡´æ–‡ä»¶ç¨åå®Œæˆï¼‰ã€‚</p><p>æœ€ä¸‹é¢ä¸€è¡Œå‡ ä¹æ˜¯æœ€ç³Ÿç³•çš„æƒ…å†µã€‚8ä¸ªä¸¢å¤±çš„æ•°æ®åŒ…åˆ†å¸ƒåœ¨ä¸¤ä¸ªæµä¸­ã€‚è¿™æ„å‘³ç€è¿™ä¸¤ä¸ªæµç°åœ¨éƒ½è¢«é˜Ÿå¤´é˜»å¡äº†ï¼šä¸æ˜¯å› ä¸ºå®ƒä»¬åƒTCPé‚£æ ·åœ¨ç­‰å¾…å¯¹æ–¹ï¼Œè€Œæ˜¯å› ä¸ºæ¯ä¸ªæµä»ç„¶éœ€è¦è‡ªå·±æ’åºã€‚</p><p><em>æ³¨æ„ï¼šè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•° QUIC å®ç°å¾ˆå°‘åŒæ—¶åˆ›å»ºåŒ…å«æ¥è‡ªå¤šä¸ªæµï¼ˆstreamsï¼‰çš„æ•°æ®åŒ…ï¼ˆpacketsï¼‰çš„åŸå› ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªæ•°æ®åŒ…ä¸¢å¤±ï¼Œåˆ™ä¼šç«‹å³å¯¼è‡´å•ä¸ªæ•°æ®åŒ…ä¸­æ‰€æœ‰æµçš„é˜Ÿå¤´é˜»å¡ï¼</em></p><p>å› æ­¤ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯èƒ½å­˜åœ¨æŸç§æœ€ä½³ä½ç½®ï¼ˆä¸­é—´ä¸€è¡Œï¼‰ï¼Œåœ¨è¿™é‡Œï¼Œ<strong>é˜Ÿå¤´é˜»å¡é¢„é˜²å’Œèµ„æºåŠ è½½æ€§èƒ½ä¹‹é—´çš„æƒè¡¡å¯èƒ½æ˜¯å€¼å¾—çš„</strong>ã€‚ç„¶è€Œï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€è¯´ï¼Œä¸¢åŒ…æ¨¡å¼å¾ˆéš¾é¢„æµ‹ã€‚ä¸ä¼šæ€»æ˜¯8ä¸ªæ•°æ®åŒ…ã€‚å®ƒä»¬ä¸ä¼šæ€»æ˜¯ä¸€æ ·çš„8ä¸ªæ•°æ®åŒ…ã€‚å¦‚æœæˆ‘ä»¬æé”™äº†ï¼Œä¸¢å¤±çš„æ•°æ®åŒ…åªå‘å·¦ç§»åŠ¨äº†ä¸€ä¸ªï¼Œæˆ‘ä»¬çªç„¶ä¹Ÿå°‘äº†ä¸€ä¸ªç´«è‰²çš„åŒ…ï¼Œè¿™åŸºæœ¬ä¸Šä½¿æˆ‘ä»¬é™çº§åˆ°ä¸æœ€ä¸‹é¢ä¸€è¡Œç›¸ä¼¼çš„ä½ç½®â€¦</p><p>æˆ‘æƒ³ä½ ä¼šåŒæ„æˆ‘çš„è§‚ç‚¹ï¼Œé‚£å¬èµ·æ¥å¾ˆå¤æ‚ï¼Œç”šè‡³å¯èƒ½å¤ªå¤æ‚äº†ã€‚å³ä¾¿å¦‚æ­¤ï¼Œé—®é¢˜æ˜¯è¿™ä¼šæœ‰å¤šå¤§å¸®åŠ©ã€‚å¦‚å‰æ‰€è¿°ï¼ŒåŒ…ä¸¢å¤±åœ¨è®¸å¤šç½‘ç»œç±»å‹ä¸­é€šå¸¸æ¯”è¾ƒå°‘è§ï¼Œå¯èƒ½ï¼ˆä¹Ÿè®¸ï¼Ÿï¼‰å¤ªç½•è§äº†ï¼Œçœ‹ä¸åˆ° QUIC ç§»é™¤é˜Ÿå¤´é˜»å¡çš„å½±å“ã€‚å¦ä¸€æ–¹é¢ï¼Œå·²ç»æœ‰å¾ˆå¥½çš„æ–‡æ¡£è¯æ˜æ— è®ºæ‚¨ä½¿ç”¨çš„æ˜¯ HTTP/2 è¿˜æ˜¯ HTTP/3ï¼Œæ¯ä¸ªèµ„æºçš„æ•°æ®åŒ…ï¼ˆå›¾10çš„æœ€åä¸€è¡Œï¼‰å¯¹èµ„æºåŠ è½½æ€§èƒ½éƒ½æ˜¯ç›¸å½“ä¸åˆ©çš„ã€‚</p><p>å› æ­¤ï¼Œæœ‰äººå¯èƒ½ä¼šè¯´ï¼Œè™½ç„¶ QUIC å’Œ HTTP/3 ä¸å†å—åˆ°åº”ç”¨å±‚æˆ–ä¼ è¾“å±‚é˜Ÿå¤´é˜»å¡çš„å½±å“ï¼Œä½†è¿™åœ¨ç°å®ä¸­å¯èƒ½å¹¶ä¸é‡è¦ã€‚æˆ‘ä¸èƒ½ç¡®å®šè¿™ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å®Œå…¨å®Œæˆ QUIC å’Œ HTTP/3 çš„å®ç°ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ²¡æœ‰æœ€åçš„åº¦é‡ï¼ˆmeasurementsï¼‰ã€‚ç„¶è€Œï¼Œæˆ‘ä¸ªäººçš„ç›´è§‰ï¼ˆè¿™æ˜¯ç”±æˆ‘çš„å‡ ä¸ªæ—©æœŸå®éªŒçš„ç»“æœæ”¯æŒçš„ï¼‰è¯´ï¼Œ<strong>QUIC æ¶ˆé™¤é˜Ÿå¤´é˜»å¡å¯èƒ½å®é™…ä¸Šå¯¹ Web æ€§èƒ½æ²¡æœ‰å¤ªå¤§å¸®åŠ©</strong>ï¼Œå› ä¸ºç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›ä¸ºäº†èµ„æºåŠ è½½æ€§èƒ½è€Œå¯¹è®¸å¤šæµè¿›è¡Œå¤šè·¯å¤ç”¨ã€‚è€Œä¸”ï¼Œå¦‚æœä½ çœŸçš„æƒ³è®©å®ƒå·¥ä½œå¾—å¾ˆå¥½ï¼Œä½ å°±å¿…é¡»éå¸¸å·§å¦™åœ°è°ƒæ•´ä½ çš„å¤šè·¯å¤ç”¨æ–¹å¼æ¥é€‚åº”è¿æ¥ç±»å‹ï¼Œå› ä¸ºä½ ç»å¯¹ä¸æƒ³åœ¨åŒ…ä¸¢å¤±éå¸¸ä½çš„å¿«é€Ÿç½‘ç»œä¸Šè¿›è¡Œå¤§é‡çš„å¤šè·¯å¤ç”¨ï¼ˆå› ä¸ºå®ƒä»¬æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šé­å—å¤ªå¤šçš„é˜Ÿå¤´é˜»å¡ï¼‰ã€‚å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘ä¸è®¤ä¸ºä¼šå‘ç”Ÿè¿™ç§äº‹ã€‚</p><p><em>æ³¨æ„ï¼šåœ¨è¿™é‡Œï¼Œåœ¨ç»“å°¾ï¼Œä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°æˆ‘çš„æ•…äº‹æœ‰ç‚¹ä¸ä¸€è‡´ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘è¯´ HTTP/1.1 çš„é—®é¢˜æ˜¯å®ƒä¸å…è®¸å¤šè·¯å¤ç”¨ã€‚æœ€åï¼Œæˆ‘è¯´å¤šè·¯å¤ç”¨åœ¨ç°å®ä¸­å¹¶ä¸é‚£ä¹ˆé‡è¦ã€‚ä¸ºäº†å¸®åŠ©è§£å†³è¿™ä¸ªæ˜æ˜¾çš„çŸ›ç›¾ï¼Œæˆ‘æ·»åŠ äº†å¦ä¸€ä¸ªé¢å¤–çš„å½©è›‹éƒ¨åˆ†</em></p><h2 id="æ€»ç»“ä¸ç»“è®º"><a href="#æ€»ç»“ä¸ç»“è®º" class="headerlink" title="æ€»ç»“ä¸ç»“è®º"></a>æ€»ç»“ä¸ç»“è®º</h2><p>åœ¨è¿™ç¯‡ï¼ˆå¾ˆé•¿ï¼Œæˆ‘çŸ¥é“ï¼‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨è¿½è¸ªé˜Ÿå¤´é˜»å¡ã€‚æˆ‘ä»¬é¦–å…ˆè®¨è®ºäº†ä¸ºä»€ä¹ˆ HTTP/1.1 ä¼šå—åˆ°åº”ç”¨å±‚é˜Ÿå¤´é˜»å¡çš„å½±å“ã€‚è¿™ä¸»è¦æ˜¯å› ä¸º HTTP/1.1 æ²¡æœ‰è¯†åˆ«å•ä¸ªèµ„æºå—çš„æ–¹æ³•ã€‚HTTP/2 ä½¿ç”¨å¸§æ¥æ ‡è®°è¿™äº›å—å¹¶å¯ç”¨å¤šè·¯å¤ç”¨ã€‚è¿™è§£å†³äº† HTTP/1.1 çš„é—®é¢˜ï¼Œä½†é—æ†¾çš„æ˜¯HTTP/2 ä»ç„¶å—åˆ°åº•å±‚ TCP çš„é™åˆ¶ã€‚ç”±äº TCP å°† HTTP/2 æ•°æ®æŠ½è±¡ä¸ºä¸€ä¸ªå•ä¸€çš„ã€æœ‰åºçš„ã€ä½†ä¸é€æ˜çš„æµï¼Œå› æ­¤å¦‚æœæ•°æ®åŒ…åœ¨ç½‘ç»œä¸Šä¸¢å¤±æˆ–ä¸¥é‡å»¶è¿Ÿï¼Œå®ƒå°†é­å—é˜Ÿå¤´é˜»å¡ã€‚QUIC é€šè¿‡å°† HTTP/2 çš„ä¸€äº›æ¦‚å¿µå¼•å…¥ä¼ è¾“å±‚æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿™åè¿‡æ¥ä¼šäº§ç”Ÿä¸¥é‡çš„å½±å“ï¼Œå› ä¸ºè·¨æµçš„æ•°æ®ä¸å†æ˜¯å®Œå…¨æœ‰åºçš„ã€‚è¿™æœ€ç»ˆå¯¼è‡´éœ€è¦ä¸€ä¸ªå…¨æ–°çš„ç‰ˆæœ¬ HTTP/3ï¼Œå®ƒåªè¿è¡Œåœ¨ QUIC ä¹‹ä¸Šï¼ˆè€Œ HTTP/2 åªè¿è¡Œåœ¨ TCP ä¹‹ä¸Šï¼Œè¯·å‚è§å›¾6ï¼‰ã€‚</p><p>æˆ‘ä»¬éœ€è¦æ‰€æœ‰è¿™äº›ä¸Šä¸‹æ–‡æ¥æ‰¹åˆ¤æ€§åœ°æ€è€ƒ QUICï¼ˆä»¥åŠ HTTP/3ï¼‰ä¸­çš„é˜Ÿå¤´é˜»å¡ç§»é™¤åœ¨ç°å®ä¸­å¯¹ Web æ€§èƒ½çš„å®é™…å¸®åŠ©æœ‰å¤šå¤§ã€‚æˆ‘ä»¬çœ‹åˆ°å®ƒå¯èƒ½åªä¼šå¯¹æœ‰å¤§é‡æ•°æ®åŒ…ä¸¢å¤±çš„ç½‘ç»œäº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚æˆ‘ä»¬è¿˜è®¨è®ºäº†ä¸ºä»€ä¹ˆå³ä½¿è¿™æ ·ï¼Œæ‚¨ä»ç„¶éœ€è¦å¤šè·¯å¤ç”¨èµ„æºï¼Œå¹¶çœ‹è¿æ°”ä¸¢åŒ…å¯¹å¤šè·¯å¤ç”¨çš„å½±å“æ€ä¹ˆæ ·ã€‚æˆ‘ä»¬çœ‹åˆ°äº†ä¸ºä»€ä¹ˆè¿™æ ·åšå®é™…ä¸Šå¼Šå¤§äºåˆ©ï¼Œå› ä¸ºèµ„æºå¤šè·¯å¤ç”¨é€šå¸¸ä¸æ˜¯ Web æ€§èƒ½çš„æœ€ä½³æ–¹æ¡ˆã€‚æˆ‘ä»¬å¾—å‡ºçš„ç»“è®ºæ˜¯ï¼Œè™½ç„¶ç°åœ¨ç¡®å®šè¿™ä¸€ç‚¹è¿˜ä¸ºæ—¶è¿‡æ—©ï¼Œ<strong>ä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒQUIC å’Œ HTTP/3 çš„é˜Ÿå¤´é˜»å¡ç§»é™¤å¯èƒ½ä¸ä¼šå¯¹ Web æ€§èƒ½èµ·åˆ°å¤šå¤§ä½œç”¨</strong>ã€‚</p><p>é‚£ä¹ˆâ€¦è¿™åˆç»™æˆ‘ä»¬ç•™ä¸‹ä»€ä¹ˆæ ·çš„ Web æ€§èƒ½è¯„ä»·å‘¢ï¼Ÿå¿½ç•¥ QUIC å’Œ HTTP/3ï¼ŒåšæŒ HTTP/2 + TCPï¼Ÿæˆ‘å½“ç„¶ä¸å¸Œæœ›ï¼<strong>æˆ‘ä»ç„¶ç›¸ä¿¡ HTTP/3 æ€»ä½“ä¸Šå°†æ¯” HTTP/2 å¿«</strong>ï¼Œå› ä¸º QUIC è¿˜åŒ…æ‹¬å…¶ä»–æ€§èƒ½æ”¹è¿›ã€‚ä¾‹å¦‚ï¼Œå®ƒæ¯” TCP åœ¨ç½‘ç»œä¸Šçš„å¼€é”€æ›´å°ï¼Œåœ¨æ‹¥å¡æ§åˆ¶æ–¹é¢æ›´åŠ çµæ´»ï¼Œè€Œä¸”æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå…·æœ‰ 0-RTT è¿æ¥å»ºç«‹ç‰¹æ€§ã€‚æˆ‘è§‰å¾—<strong>ç‰¹åˆ«æ˜¯ 0-RTT å°†æä¾›æœ€å¤šçš„Webæ€§èƒ½å¥½å¤„</strong>ï¼Œå°½ç®¡ä¹Ÿæœ‰å¾ˆå¤šæŒ‘æˆ˜ã€‚ä»¥åæˆ‘ä¼šå†™å¦ä¸€ç¯‡å…³äº 0-RTT çš„åšå®¢æ–‡ç« ï¼Œä½†æ˜¯å¦‚æœä½ è¿«ä¸åŠå¾…æƒ³çŸ¥é“æ›´å¤šå…³äºæ”¾å¤§æ”»å‡»é¢„é˜²ã€é‡æ”¾æ”»å‡»ã€åˆå§‹æ‹¥å¡çª—å£å¤§å°ç­‰çš„ä¿¡æ¯ï¼Œè¯·çœ‹æˆ‘çš„å¦ä¸€ç¯‡ YouTube è®²åº§æˆ–é˜…è¯»æˆ‘æœ€è¿‘çš„è®ºæ–‡ã€‚</p><p>å¦‚æœä½ å–œæ¬¢æ‰€æœ‰è¿™äº›ï¼Œå¹¶å¸Œæœ›åœ¨æœªæ¥æœ‰æ›´å¤šçš„äº¤æµï¼Œè¯·å…³æ³¨æˆ‘çš„ twitter <a href="https://link.zhihu.com/?target=https%3A//twitter.com/programmingart">@programmingart</a>ã€‚</p><p>è¿™ç¯‡æ–‡ç« çš„â€œåœ¨çº¿æ–‡æ¡£â€ç‰ˆæœ¬å¯ä»¥åœ¨  github ä¸Šæ‰¾åˆ°ã€‚å¦‚æœæ‚¨æœ‰å…³äºå¦‚ä½•æ”¹è¿›å®ƒçš„å»ºè®®ï¼Œè¯·è®©æˆ‘çŸ¥é“ï¼</p><p>æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼</p><h2 id="å½©è›‹ï¼šHTTP-1-1-ç®¡é“ï¼ˆpipeliningï¼‰"><a href="#å½©è›‹ï¼šHTTP-1-1-ç®¡é“ï¼ˆpipeliningï¼‰" class="headerlink" title="å½©è›‹ï¼šHTTP/1.1 ç®¡é“ï¼ˆpipeliningï¼‰"></a>å½©è›‹ï¼šHTTP/1.1 ç®¡é“ï¼ˆ<strong>pipelining</strong>ï¼‰</h2><p>HTTP/1.1 åŒ…å«äº†ä¸€ä¸ªåä¸ºâ€œç®¡é“â€œï¼ˆpipeliningï¼‰çš„ç‰¹æ€§ï¼Œåœ¨æˆ‘çœ‹æ¥è¿™æ˜¯ç»å¸¸è¢«è¯¯è§£çš„ã€‚æˆ‘çœ‹è¿‡å¾ˆå¤šæ–‡ç« ï¼Œç”šè‡³ä¹¦ç±ä¸­éƒ½æœ‰äººå£°ç§° HTTP/1.1 ç®¡é“è§£å†³äº†é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚æˆ‘ç”šè‡³è§è¿‡ä¸€äº›äººè¯´ç®¡é“å’Œæ­£ç¡®çš„å¤šè·¯å¤ç”¨æ˜¯ä¸€æ ·çš„ã€‚ä¸¤ç§è¯´æ³•éƒ½æ˜¯é”™è¯¯çš„ã€‚</p><p>æˆ‘å‘ç°ç”¨ç±»ä¼¼å½©è›‹å›¾1ä¸­çš„æ’å›¾æ¥è§£é‡Š HTTP/1.1 ç®¡é“æ˜¯æœ€ç®€å•çš„ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240427132814642.png" alt="image-20240427132814642"></p><center>å½©è›‹å›¾1ï¼šHTTP/1.1 ç®¡é“</center><p>å¦‚æœæ²¡æœ‰ç®¡é“ï¼ˆpipeliningï¼‰ï¼ˆå½©è›‹å›¾1çš„å·¦ä¾§ï¼‰ï¼Œæµè§ˆå™¨å¿…é¡»ç­‰å¾…å‘é€ç¬¬äºŒä¸ªèµ„æºè¯·æ±‚ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªè¯·æ±‚çš„å“åº”è¢«å®Œå…¨æ¥æ”¶ï¼ˆåŒæ ·ä½¿ç”¨ Content-Lengthï¼‰ã€‚è¿™ä¼šä¸ºæ¯ä¸ªè¯·æ±‚å¢åŠ ä¸€ä¸ªå¾€è¿”æ—¶é—´ï¼ˆRTTï¼‰å»¶è¿Ÿï¼Œè¿™å¯¹Webæ€§èƒ½ä¸åˆ©ã€‚</p><p>æœ‰äº†ç®¡é“ï¼ˆå½©è›‹å›¾1çš„ä¸­é—´éƒ¨åˆ†ï¼‰ï¼Œæµè§ˆå™¨ä¸å¿…ç­‰å¾…ä»»ä½•å“åº”æ•°æ®ï¼Œç°åœ¨å¯ä»¥èƒŒé èƒŒåœ°å‘é€è¯·æ±‚ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨è¿æ¥è¿‡ç¨‹ä¸­èŠ‚çœäº†ä¸€äº› RTTsï¼Œä½¿å¾—åŠ è½½è¿‡ç¨‹æ›´å¿«ã€‚<em>å¦è¯·æ³¨æ„ï¼Œè¯·å›é¡¾å›¾2ï¼šæ‚¨ä¼šçœ‹åˆ°å®é™…ä¸Šä¹Ÿåœ¨ä½¿ç”¨ç®¡é“ï¼Œå› ä¸ºæœåŠ¡å™¨åœ¨ TCP æ•°æ®åŒ…2ä¸­æ‰“åŒ… <code>script.js</code> ä»¥åŠ <code>style.css</code> çš„å“åº”æ•°æ®ã€‚å½“ç„¶ï¼Œåªæœ‰åœ¨æœåŠ¡å™¨åŒæ—¶æ¥æ”¶åˆ°è¿™ä¸¤ä¸ªè¯·æ±‚æ—¶ï¼Œè¿™æ‰æ˜¯å¯èƒ½çš„ã€‚</em></p><p>ç„¶è€Œï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œè¿™ç§ç®¡é“åªé€‚ç”¨äºæ¥è‡ªæµè§ˆå™¨çš„è¯·æ±‚ã€‚æ­£å¦‚HTTP/1.1 è§„èŒƒæ‰€è¯´ï¼š</p><blockquote><p>æœåŠ¡å™¨å¿…é¡»æŒ‰ç…§æ¥æ”¶è¯·æ±‚çš„é¡ºåºå‘é€å¯¹è¿™äº›[ç®¡é“åŒ–]è¯·æ±‚çš„å“åº”ã€‚</p></blockquote><p>å› æ­¤ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå®é™…çš„å“åº”å—ï¼ˆresponse chunksï¼‰å¤šè·¯å¤ç”¨ï¼ˆå¦‚å½©è›‹å›¾1å³ä¾§æ‰€ç¤ºï¼‰åœ¨ HTTP/1.1 ç®¡é“ä¸­ä»ç„¶æ˜¯ä¸å¯èƒ½çš„ã€‚æ¢ä¸€ç§è¯´æ³•ï¼š<strong>ç®¡é“è§£å†³äº†è¯·æ±‚çš„é˜Ÿå¤´é˜»å¡ï¼Œè€Œä¸æ˜¯å“åº”çš„é˜Ÿå¤´é˜»å¡</strong>ã€‚å¯æ‚²çš„æ˜¯ï¼Œå“åº”é˜Ÿå¤´é˜»å¡æ˜¯å¯¼è‡´ Web æ€§èƒ½é—®é¢˜æœ€å¤šçš„åŸå› ã€‚</p><p>æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå¤§å¤šæ•°æµè§ˆå™¨å®é™…ä¸Šå¹¶æ²¡æœ‰åœ¨ç°å®ä¸­ä½¿ç”¨ HTTP/1.1 ç®¡é“ï¼Œå› ä¸ºè¿™ä¼šä½¿é˜Ÿå¤´é˜»å¡åœ¨å¤šä¸ªå¹¶è¡Œ TCP è¿æ¥çš„è®¾ç½®ä¸­å˜å¾—æ›´åŠ ä¸å¯é¢„æµ‹ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬è®¾æƒ³ä¸€ä¸ªè®¾ç½®ï¼Œå…¶ä¸­é€šè¿‡ä¸¤ä¸ª TCP è¿æ¥ä»æœåŠ¡å™¨è¯·æ±‚ä¸‰ä¸ªæ–‡ä»¶ Aï¼ˆå¤§ï¼‰ã€Bï¼ˆå°ï¼‰å’Œ Cï¼ˆå°ï¼‰ã€‚A å’Œ B åœ¨ä¸åŒçš„è¿æ¥ä¸Šè¢«è¯·æ±‚ã€‚ç°åœ¨ï¼Œæµè§ˆå™¨åº”è¯¥åœ¨å“ªä¸ªè¿æ¥ä¸Šä¼ è¾“å¯¹ C çš„è¯·æ±‚ï¼Ÿæ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€è¯´ï¼Œå®ƒä¸çŸ¥é“ A è¿˜æ˜¯ B å°†æˆä¸ºæœ€å¤§/æœ€æ…¢çš„èµ„æºã€‚</p><p>å¦‚æœå®ƒçŒœå¯¹äº†ï¼ˆBï¼‰ï¼Œå®ƒå°±å¯ä»¥åœ¨ä¼ è¾“ A æ‰€éœ€çš„æ—¶é—´å†…åŒæ—¶ä¸‹è½½ B å’Œ Cï¼Œä»è€Œè·å¾—äº†å¾ˆå¥½çš„åŠ é€Ÿæ•ˆæœã€‚ä½†æ˜¯ï¼Œå¦‚æœçŒœæµ‹æ˜¯é”™è¯¯çš„ï¼ˆAï¼‰ï¼ŒB çš„è¿æ¥å°†é•¿æ—¶é—´å¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œ C åˆ™åœ¨ A åé¢è¢«é˜»å¡ã€‚è¿™æ˜¯å› ä¸º HTTP/1.1 ä¹Ÿæ²¡æœ‰æä¾›ä¸€ç§åœ¨è¯·æ±‚è¢«å‘é€åâ€œä¸­æ­¢â€çš„æ–¹æ³•ï¼ˆHTTP/2 å’Œ HTTP/3 å…è®¸è¿™æ ·åšï¼‰ã€‚å› æ­¤ï¼Œæµè§ˆå™¨ä¸èƒ½ç®€å•åœ°é€šè¿‡ B çš„è¿æ¥è¯·æ±‚ Cï¼Œå› ä¸ºå®ƒæœ€ç»ˆä¼šè¯·æ±‚ä¸¤æ¬¡ Cã€‚</p><p>ä¸ºäº†è§£å†³æ‰€æœ‰è¿™äº›é—®é¢˜ï¼Œç°ä»£æµè§ˆå™¨ä¸ä½¿ç”¨ç®¡é“ï¼Œç”šè‡³ä¼šä¸»åŠ¨å»¶è¿Ÿå¯¹æŸäº›å·²å‘ç°èµ„æºï¼ˆä¾‹å¦‚å›¾åƒï¼‰çš„è¯·æ±‚ä¸€æ®µæ—¶é—´ï¼Œä»¥æŸ¥çœ‹æ˜¯å¦æ‰¾åˆ°æ›´é‡è¦çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ JS å’Œ CSSï¼‰ï¼Œä»¥ç¡®ä¿é«˜ä¼˜å…ˆçº§èµ„æºä¸ä¼šè¢«é˜»å¡ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼ŒHTTP/1.1 ç®¡é“çš„å¤±è´¥æ˜¯ HTTP/2 ä½¿ç”¨æˆªç„¶ä¸åŒæ–¹æ³•çš„å¦ä¸€ä¸ªåŠ¨æœºã€‚ç„¶è€Œï¼Œç”±äº HTTP/2 çš„ä¼˜å…ˆçº§ç³»ç»ŸæŒ‡å¯¼å¤šè·¯å¤ç”¨åœ¨ç°å®ä¸­å¸¸å¸¸æ— æ³•æ‰§è¡Œï¼Œä¸€äº›æµè§ˆå™¨ç”šè‡³é‡‡å–äº†å»¶è¿Ÿ HTTP/2 èµ„æºè¯·æ±‚çš„æ–¹å¼æ¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚</p><h2 id="å½©è›‹ï¼šTLS-é˜Ÿå¤´é˜»å¡"><a href="#å½©è›‹ï¼šTLS-é˜Ÿå¤´é˜»å¡" class="headerlink" title="å½©è›‹ï¼šTLS é˜Ÿå¤´é˜»å¡"></a>å½©è›‹ï¼šTLS é˜Ÿå¤´é˜»å¡</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼ŒTLS åè®®ä¸ºåº”ç”¨å±‚åè®®ï¼ˆå¦‚ HTTPï¼‰æä¾›åŠ å¯†ï¼ˆå’Œå…¶ä»–åŠŸèƒ½ï¼‰ã€‚å®ƒé€šè¿‡å°†ä» HTTP è·å–çš„æ•°æ®åŒ…è£…åˆ° TLS è®°å½•ä¸­ï¼ŒTLS è®°å½•åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äº HTTP/2 å¸§ï¼ˆframesï¼‰æˆ– TCP æ•°æ®åŒ…ï¼ˆpacketsï¼‰ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬åœ¨å¼€å§‹æ—¶åŒ…å«ä¸€äº›å…ƒæ•°æ®ï¼Œä»¥æ ‡è¯†è®°å½•çš„é•¿åº¦ã€‚ç„¶åï¼Œå¯¹è¯¥è®°å½•åŠå…¶ HTTP å†…å®¹è¿›è¡ŒåŠ å¯†å¹¶ä¼ é€’ç»™ TCP è¿›è¡Œä¼ è¾“ã€‚</p><p>å°± CPU ä½¿ç”¨ç‡è€Œè¨€ï¼ŒåŠ å¯†å¯èƒ½æ˜¯ä¸€é¡¹æ˜‚è´µçš„æ“ä½œï¼Œå› æ­¤ä¸€æ¬¡åŠ å¯†ä¸€ä¸ªå¥½æ•°æ®å—é€šå¸¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºè¿™é€šå¸¸æ›´æœ‰æ•ˆã€‚å®é™…ä¸Šï¼ŒTLS å¯ä»¥ä»¥é«˜è¾¾ 16KB çš„å—åŠ å¯†èµ„æºï¼Œè¿™è¶³ä»¥å¡«å……å¤§çº¦ 11 ä¸ªå…¸å‹çš„ TCP åŒ…ï¼ˆgive æˆ– takeï¼‰ã€‚</p><p>ç„¶è€Œï¼Œè‡³å…³é‡è¦çš„æ˜¯ï¼ŒTLS åªèƒ½å¯¹æ•´ä¸ªè®°å½•è¿›è¡Œè§£å¯†ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¼šå‡ºç° TLS é˜Ÿå¤´é˜»å¡çš„æƒ…å†µã€‚å‡è®¾ TLS è®°å½•åˆ†æ•£åœ¨ 11 ä¸ª TCP åŒ…ä¸Šï¼Œæœ€åä¸€ä¸ª TCP åŒ…ä¸¢å¤±ã€‚ç”±äº TLS è®°å½•æ˜¯ä¸å®Œæ•´çš„ï¼Œå®ƒä¸èƒ½è¢«è§£å¯†ï¼Œå› æ­¤è¢«å¡åœ¨ç­‰å¾…æœ€åä¸€ä¸ª TCP åŒ…çš„é‡ä¼ ã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ TCP é˜Ÿå¤´é˜»å¡ï¼šåœ¨ç¼–å·11ä¹‹åæ²¡æœ‰æ•°æ®åŒ…è¢«å¡ä½ç­‰å¾…é‡æ–°ä¼ è¾“ã€‚æ¢è¨€ä¹‹ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æœ¬ä¾‹ä¸­ä½¿ç”¨çº¯ HTTP è€Œä¸æ˜¯ HTTPSï¼Œé‚£ä¹ˆå‰10ä¸ªåŒ…ä¸­çš„ HTTP æ•°æ®å¯èƒ½å·²ç»è¢«ç§»åŠ¨åˆ°æµè§ˆå™¨ä¸­è¿›è¡Œå¤„ç†ã€‚ç„¶è€Œï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æ•´ä¸ª11åŒ…çš„ TLS è®°å½•æ‰èƒ½è§£å¯†å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰äº†ä¸€ç§æ–°å½¢å¼çš„é˜Ÿå¤´é˜»å¡ã€‚</p><p>è™½ç„¶è¿™æ˜¯ä¸€ä¸ªéå¸¸å…·ä½“çš„æƒ…å†µï¼Œåœ¨ç°å®ä¸­å¯èƒ½ä¸ä¼šç»å¸¸å‘ç”Ÿï¼Œä½†åœ¨è®¾è®¡ QUIC åè®®æ—¶ï¼Œå®ƒä»ç„¶è¢«è€ƒè™‘åœ¨å†…ã€‚å› ä¸ºé‚£é‡Œçš„ç›®æ ‡æ˜¯å½»åº•æ¶ˆé™¤æ‰€æœ‰å½¢å¼çš„é˜Ÿå¤´é˜»å¡ï¼ˆæˆ–è‡³å°‘å°½å¯èƒ½å¤šåœ°æ¶ˆé™¤ï¼‰ï¼Œç”šè‡³è¿™ç§è¾¹ç¼˜æƒ…å†µä¹Ÿå¿…é¡»è¢«ç§»é™¤ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ QUIC é›†æˆäº† TLSï¼Œå®ƒæ€»æ˜¯ä»¥æ¯ä¸ªåŒ…ä¸ºåŸºç¡€åŠ å¯†æ•°æ®ï¼Œå¹¶ä¸”ä¸ç›´æ¥ä½¿ç”¨ TLS è®°å½•ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œä¸ä½¿ç”¨æ›´å¤§çš„å—ç›¸æ¯”ï¼Œè¿™æ•ˆç‡æ›´ä½ï¼Œéœ€è¦æ›´å¤šçš„ CPUï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ QUIC åœ¨å½“å‰å®ç°ä¸­ä»ç„¶æ¯” TCP æ…¢çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p><h2 id="å½©è›‹ï¼šä¼ è¾“æ‹¥å¡æ§åˆ¶"><a href="#å½©è›‹ï¼šä¼ è¾“æ‹¥å¡æ§åˆ¶" class="headerlink" title="å½©è›‹ï¼šä¼ è¾“æ‹¥å¡æ§åˆ¶"></a>å½©è›‹ï¼šä¼ è¾“æ‹¥å¡æ§åˆ¶</h2><p>ä¼ è¾“å±‚åè®®å¦‚ TCP å’Œ QUIC åŒ…æ‹¬ä¸€ç§ç§°ä¸ºæ‹¥å¡æ§åˆ¶ï¼ˆCongestion Controlï¼‰çš„æœºåˆ¶ã€‚æ‹¥å¡æ§åˆ¶å™¨çš„ä¸»è¦å·¥ä½œæ˜¯ç¡®ä¿ç½‘ç»œä¸ä¼šåŒæ—¶è¢«è¿‡å¤šçš„æ•°æ®è¿‡è½½ã€‚å¦‚æœæ²¡æœ‰ç¼“å†²åŒºçš„è¯ï¼Œæ•°æ®åŒ…å°±ä¼šæº¢å‡ºã€‚æ‰€ä»¥ï¼Œå®ƒé€šå¸¸åªå‘é€ä¸€ç‚¹æ•°æ®ï¼ˆé€šå¸¸æ˜¯ 14KBï¼‰ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½é€šè¿‡ã€‚å¦‚æœæ•°æ®åˆ°è¾¾ï¼Œæ¥æ”¶æ–¹å°†ç¡®è®¤å‘é€å›å‘é€æ–¹ã€‚åªè¦æ‰€æœ‰å‘é€çš„æ•°æ®éƒ½å¾—åˆ°ç¡®è®¤ï¼Œå‘é€æ–¹å°±åœ¨æ¯æ¬¡ RTT æ—¶å°†å…¶å‘é€é€Ÿç‡åŠ å€ï¼Œç›´åˆ°è§‚å¯Ÿåˆ°ä¸¢åŒ…äº‹ä»¶ï¼ˆè¿™æ„å‘³ç€ç½‘ç»œè¿‡è½½ï¼ˆ1 ä½ï¼‰ï¼Œå®ƒéœ€è¦åé€€ï¼ˆ1 ä½ï¼‰ï¼‰ã€‚è¿™å°±æ˜¯ TCP è¿æ¥å¦‚ä½•â€œæ¢æµ‹â€å…¶å¯ç”¨å¸¦å®½ã€‚</p><p><em>æ³¨ï¼šä»¥ä¸Šæè¿°åªæ˜¯æ‹¥å¡æ§åˆ¶çš„ä¸€ç§æ–¹æ³•ã€‚ç›®å‰ï¼Œå…¶ä»–æ–¹æ³•ä¹Ÿè¶Šæ¥è¶Šæµè¡Œï¼Œå…¶ä¸­ä¸»è¦æ˜¯</em> <a href="https://link.zhihu.com/?target=https%3A//research.google/pubs/pub45646/">BBR ç®—æ³•</a><em>ã€‚BBR å¹¶æ²¡æœ‰ç›´æ¥è§‚å¯Ÿæ•°æ®åŒ…ä¸¢å¤±ï¼Œè€Œæ˜¯å¤§é‡è€ƒè™‘ RTT æ³¢åŠ¨æ¥ç¡®å®šç½‘ç»œæ˜¯å¦è¿‡è½½ï¼Œè¿™æ„å‘³ç€å®ƒé€šå¸¸é€šè¿‡æ¢æµ‹å¸¦å®½æ¥å‡å°‘æ•°æ®åŒ…ä¸¢å¤±ã€‚</em></p><p>å…³é”®æ˜¯ï¼š<strong>æ‹¥å¡æ§åˆ¶æœºåˆ¶å¯¹æ¯ä¸ª TCPï¼ˆå’Œ QUICï¼‰è¿æ¥éƒ½æ˜¯ç‹¬ç«‹çš„</strong>ï¼è¿™åè¿‡æ¥ä¹Ÿä¼šå½±å“åˆ° HTTPå±‚ çš„ Web æ€§èƒ½ã€‚é¦–å…ˆï¼Œè¿™æ„å‘³ç€ HTTP/2 çš„å•ä¸ªè¿æ¥æœ€åˆåªå‘é€ 14KBã€‚ç„¶è€Œï¼ŒHTTP/1.1 çš„6ä¸ªè¿æ¥åœ¨å®ƒä»¬çš„ç¬¬ä¸€æ¬¡ä¼ è¾“ä¸­å‘é€ 14KBï¼Œå¤§çº¦æ˜¯ 84KBï¼éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™å°†å˜å¾—å¤æ‚ï¼Œå› ä¸ºæ¯ä¸ª HTTP/1.1 è¿æ¥ä½¿ç”¨æ¯ä¸ª RTT å°†å…¶æ•°æ®åŠ å€ã€‚ç¬¬äºŒï¼Œåªæœ‰åœ¨æ•°æ®åŒ…ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œè¿æ¥æ‰ä¼šé™ä½å…¶å‘é€é€Ÿç‡ã€‚å¯¹äº HTTP/2 çš„å•ä¸ªè¿æ¥ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªåŒ…ä¸¢å¤±ä¹Ÿæ„å‘³ç€å®ƒå°†å‡æ…¢é€Ÿåº¦ï¼ˆé™¤äº†å¯¼è‡´ TCP é˜Ÿå¤´é˜»å¡ä¹‹å¤–ï¼ï¼‰ã€‚ç„¶è€Œï¼Œå¯¹äº HTTP/1.1ï¼Œåªæœ‰ä¸€ä¸ªè¿æ¥ä¸Šçš„ä¸€ä¸ªåŒ…ä¸¢å¤±åªä¼šå‡æ…¢è¿™ä¸€ä¸ªè¿æ¥çš„é€Ÿåº¦ï¼šå…¶ä»–5ä¸ªè¿æ¥å¯ä»¥ä¿æŒæ­£å¸¸çš„å‘é€å’Œå¢é•¿ã€‚</p><p>è¿™ä¸€åˆ‡ä½¿ä¸€ä»¶äº‹å˜å¾—éå¸¸æ¸…æ¥šï¼š<strong>HTTP/2 çš„å¤šè·¯å¤ç”¨ä¸ HTTP/1.1 çš„åŒæ—¶ä¸‹è½½èµ„æºæ˜¯ä¸ä¸€æ ·çš„</strong>ï¼ˆæˆ‘è¿˜çœ‹åˆ°ä¸€äº›äººå£°ç§°è¿™ä¸€ç‚¹ï¼‰ã€‚å•ä¸ª HTTP/2 è¿æ¥çš„å¯ç”¨å¸¦å®½åªæ˜¯åœ¨ä¸åŒæ–‡ä»¶ä¹‹é—´åˆ†å¸ƒ/å…±äº«ï¼Œä½†æ˜¯å—ä»ç„¶æ˜¯æŒ‰é¡ºåºå‘é€çš„ã€‚è¿™ä¸ HTTP/1.1 ä¸åŒï¼Œåè€…ä»¥çœŸæ­£çš„å¹¶è¡Œæ–¹å¼å‘é€å†…å®¹ã€‚</p><p>ç°åœ¨ï¼Œæ‚¨å¯èƒ½ä¼šæƒ³çŸ¥é“ï¼šé‚£ä¹ˆï¼Œ<strong>HTTP/2 æ€ä¹ˆå¯èƒ½æ¯” HTTP/1.1 å¿«å‘¢</strong>ï¼Ÿè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯æˆ‘æ–­æ–­ç»­ç»­é—®è‡ªå·±å¾ˆä¹…çš„é—®é¢˜ã€‚ä¸€ä¸ªæ˜æ˜¾çš„ç­”æ¡ˆæ˜¯ï¼Œå¦‚æœä½ æœ‰è¶…è¿‡6ä¸ªæ–‡ä»¶ã€‚è¿™å°±æ˜¯ HTTP/2 åœ¨å½“æ—¶çš„å¸‚åœºè¥é”€æ–¹å¼ï¼šå°†ä¸€ä¸ªå›¾åƒåˆ†å‰²æˆå°æ­£æ–¹å½¢ï¼Œç„¶åé€šè¿‡ HTTP/1.1 vs HTTP/2 åŠ è½½å®ƒä»¬ã€‚è¿™ä¸»è¦å±•ç¤ºäº† HTTP/2 çš„é˜Ÿå¤´é˜»å¡ç§»é™¤ã€‚ç„¶è€Œï¼Œå¯¹äºæ™®é€š/çœŸå®çš„ç½‘ç«™æ¥è¯´ï¼Œäº‹æƒ…å¾ˆå¿«å°±ä¼šå˜å¾—æ›´åŠ å¾®å¦™ã€‚è¿™å–å†³äºèµ„æºçš„æ•°é‡ã€å¤§å°ã€ä½¿ç”¨çš„ä¼˜å…ˆçº§/å¤šè·¯å¤ç”¨æ–¹æ¡ˆã€åˆ°æœåŠ¡å™¨çš„ RTTã€å®é™…æœ‰å¤šå°‘ä¸¢åŒ…ä»¥åŠä½•æ—¶å‘ç”Ÿã€åŒæ—¶é“¾è·¯ä¸Šæœ‰å¤šå°‘å…¶ä»–æµé‡ã€ä½¿ç”¨çš„æ‹¥å¡æ§åˆ¶å™¨é€»è¾‘ï¼Œç­‰ç­‰ã€‚HTTP/1.1 å¯èƒ½ä¼šä¸¢å¤±çš„ä¸€ä¸ªä¾‹å­æ˜¯åœ¨å¯ç”¨å¸¦å®½æœ‰é™çš„ç½‘ç»œä¸Šï¼š6ä¸ª HTTP/1.1 è¿æ¥å„è‡ªå¢åŠ å…¶å‘é€é€Ÿç‡ï¼Œå¯¼è‡´å®ƒä»¬å¾ˆå¿«ä½¿ç½‘ç»œè¿‡è½½ï¼Œä¹‹åå®ƒä»¬éƒ½å¿…é¡»åé€€ï¼Œå¿…é¡»é€šè¿‡åå¤è¯•éªŒæ‰¾åˆ°å®ƒä»¬å…±å­˜çš„å¸¦å®½é™åˆ¶ï¼ˆåœ¨ HTTP/2 ä¹‹å‰ï¼Œäººä»¬è®¤ä¸º HTTP/1.1 çš„å¹¶è¡Œè¿æ¥å¯èƒ½æ˜¯å› ç‰¹ç½‘ä¸Šæ•°æ®åŒ…ä¸¢å¤±çš„ä¸»è¦åŸå› ï¼‰ã€‚å•ä¸ª HTTP/2 è¿æ¥å¢é•¿è¾ƒæ…¢ï¼Œä½†åœ¨åŒ…ä¸¢å¤±äº‹ä»¶åæ¢å¤é€Ÿåº¦æ›´å¿«ï¼Œå¹¶ä¸”æ›´å¿«åœ°æ‰¾åˆ°æœ€ä½³å¸¦å®½ã€‚å¦ä¸€ä¸ªå¸¦æœ‰æ³¨é‡Šçš„æ‹¥å¡çª—å£çš„æ›´è¯¦ç»†çš„ï¼ŒHTTP/2 æ›´å¿«çš„ç¤ºä¾‹å¯ä»¥çœ‹[è¿™å¼ å›¾ç‰‡ï¼ˆä¸é€‚ç”¨äºèƒ†å°çš„äººï¼‰ã€‚</p><p>QUIC å’Œ HTTP/3 å°†é¢ä¸´ç±»ä¼¼çš„æŒ‘æˆ˜ï¼Œå°±åƒ HTTP/2 ä¸€æ ·ï¼ŒHTTP/3 å°†ä½¿ç”¨å•ä¸€çš„åº•å±‚ QUIC è¿æ¥ã€‚ç„¶åï¼Œæ‚¨å¯èƒ½ä¼šè¯´ QUIC è¿æ¥åœ¨æ¦‚å¿µä¸Šæœ‰ç‚¹åƒå¤šä¸ª TCP è¿æ¥ï¼Œå› ä¸ºæ¯ä¸ª QUIC æµéƒ½å¯ä»¥çœ‹ä½œä¸€ä¸ªTCPè¿æ¥ï¼Œå› ä¸ºä¸¢å¤±æ£€æµ‹æ˜¯åœ¨æ¯ä¸ªæµçš„åŸºç¡€ä¸Šå®Œæˆçš„ã€‚ç„¶è€Œï¼Œå…³é”®çš„æ˜¯ï¼ŒQUIC çš„æ‹¥å¡æ§åˆ¶ä»ç„¶æ˜¯åœ¨è¿æ¥çº§åˆ«å®Œæˆçš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ¯ä¸ªæµã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿æµåœ¨æ¦‚å¿µä¸Šæ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒä»¬ä»ç„¶ä¼šå½±å“ QUIC çš„å•è¿æ¥æ‹¥å¡æ§åˆ¶å™¨ï¼Œå¦‚æœæµä¸­æœ‰ä»»ä½•ä¸€ä¸ªä¸¢å¤±ï¼Œå°±ä¼šå¯¼è‡´é€Ÿåº¦å‡æ…¢ã€‚æ¢å¥è¯è¯´ï¼šå•ä¸ª HTTP/3+QUIC è¿æ¥ä»ç„¶ä¸ä¼šåƒ 6 ä¸ª HTTP/1.1 è¿æ¥é‚£æ ·å¿«é€Ÿå¢é•¿ï¼Œç±»ä¼¼äºä¸€ä¸ªè¿æ¥ä¸Šçš„ HTTP/2+TCP å¢é•¿é€Ÿåº¦å¹¶ä¸å¿«ã€‚</p><h2 id="å½©è›‹ï¼šå¤šè·¯å¤ç”¨æ˜¯å¦é‡è¦ï¼Ÿ"><a href="#å½©è›‹ï¼šå¤šè·¯å¤ç”¨æ˜¯å¦é‡è¦ï¼Ÿ" class="headerlink" title="å½©è›‹ï¼šå¤šè·¯å¤ç”¨æ˜¯å¦é‡è¦ï¼Ÿ"></a>å½©è›‹ï¼šå¤šè·¯å¤ç”¨æ˜¯å¦é‡è¦ï¼Ÿ</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼Œå¹¶åœ¨æœ¬æ¼”ç¤ºæ–‡ç¨¿ä¸­è¿›è¡Œäº†æ·±å…¥è§£é‡Šï¼Œé€šå¸¸å»ºè®®ä»¥é¡ºåºæ–¹å¼è€Œä¸æ˜¯å¤šè·¯ä¼ è¾“æ–¹å¼å‘é€å¤§å¤šæ•°ç½‘é¡µèµ„æºã€‚æ¢ä¸€ç§è¯´æ³•ï¼Œå¦‚æœä½ æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œä½ é€šå¸¸æœ€å¥½å‘é€ 11112222 è€Œä¸æ˜¯ 12121212ã€‚å¯¹äºéœ€è¦åœ¨åº”ç”¨ä¹‹å‰å®Œå…¨æ¥æ”¶çš„èµ„æºï¼Œå¦‚ JSã€CSS å’Œå­—ä½“ï¼Œå°¤å…¶å¦‚æ­¤ã€‚</p><p>å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæƒ³ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å¤šè·¯å¤ç”¨ï¼Ÿé€šè¿‡æ‰©å±•ï¼šHTTP/2 ç”šè‡³ HTTP/3ï¼Œå› ä¸ºå¤šè·¯å¤ç”¨æ˜¯ HTTP/1.1 æ²¡æœ‰çš„ä¸»è¦ç‰¹æ€§ä¹‹ä¸€ã€‚é¦–å…ˆï¼Œä¸€äº›å¯ä»¥å¢é‡å¤„ç†/å‘ˆç°çš„æ–‡ä»¶ç¡®å®ä»å¤šè·¯å¤ç”¨ä¸­è·ç›Šã€‚ä¾‹å¦‚ï¼Œæ¸è¿›å¼å›¾åƒå°±æ˜¯è¿™æ ·ã€‚ç¬¬äºŒï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæ–‡ä»¶æ¯”å…¶ä»–æ–‡ä»¶å°å¾—å¤šï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šå¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒå°†æ›´æ—©åœ°ä¸‹è½½ï¼Œè€Œä¸ä¼šå¯¹å…¶ä»–æ–‡ä»¶é€ æˆå¤ªå¤šçš„å»¶è¿Ÿã€‚ç¬¬ä¸‰ï¼Œ<strong>å¤šè·¯å¤ç”¨å…è®¸æ”¹å˜å“åº”çš„é¡ºåºï¼Œå¹¶ä¸ºé«˜ä¼˜å…ˆçº§çš„å“åº”ä¸­æ–­ä½ä¼˜å…ˆçº§çš„å“åº”</strong>ã€‚</p><p>ç°å®ä¸­å‡ºç°çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯åœ¨æºæœåŠ¡å™¨å‰é¢ä½¿ç”¨ CDN ç¼“å­˜ã€‚å‡è®¾æµè§ˆå™¨ä» CDN è¯·æ±‚ä¸¤ä¸ªæ–‡ä»¶ã€‚ç¬¬ä¸€ä¸ªï¼ˆ1ï¼‰æ²¡æœ‰è¢«ç¼“å­˜ï¼Œéœ€è¦ä»æºæ–‡ä»¶ä¸­è·å–ï¼Œè¿™éœ€è¦ä¸€æ®µæ—¶é—´ã€‚ç¬¬äºŒä¸ªèµ„æºï¼ˆ2ï¼‰ç¼“å­˜åœ¨ CDN ä¸­ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ä¼ è¾“å›æµè§ˆå™¨ã€‚</p><p>åœ¨ä¸€ä¸ªè¿æ¥ä¸Šä½¿ç”¨ HTTP/1.1ï¼Œç”±äºé˜Ÿå¤´é˜»å¡ï¼Œæˆ‘ä»¬å¿…é¡»ç­‰å¾…é˜Ÿå¤´å®Œå…¨å‘é€ï¼ˆ1ï¼‰ï¼Œç„¶åæ‰èƒ½å¼€å§‹å‘é€ï¼ˆ2ï¼‰ã€‚è¿™å°†ç»™æˆ‘ä»¬å¸¦æ¥ 11112222ï¼Œä½†éœ€è¦å¾ˆé•¿çš„å‰æœŸç­‰å¾…æ—¶é—´ã€‚ç„¶è€Œï¼Œä½¿ç”¨HTTP/2ï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³å¼€å§‹å‘é€ï¼ˆ2ï¼‰ï¼Œåˆ©ç”¨ CDN å’ŒæºèŠ‚ç‚¹ä¹‹é—´çš„â€œæ€è€ƒæ—¶é—´â€ï¼Œå¹¶â€œé¢„çƒ­â€è¿æ¥çš„æ‹¥å¡æ§åˆ¶å™¨ã€‚é‡è¦çš„æ˜¯ï¼Œå¦‚æœï¼ˆ1ï¼‰åœ¨ï¼ˆ2ï¼‰å®Œæˆä¹‹å‰å¼€å§‹åˆ°è¾¾ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç®€å•åœ°å¼€å§‹å°†ï¼ˆ1ï¼‰çš„æ•°æ®æ³¨å…¥åˆ°å“åº”æµä¸­ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ° 22111122ï¼Œç­‰å¾…çš„æ—¶é—´è¦çŸ­å¾—å¤šã€‚ç”šè‡³å¯ä»¥åœ¨è¿æ¥å¼€å§‹æ—¶ä½¿ç”¨æœåŠ¡å™¨æ¨é€ï¼ˆServer Pushï¼‰æˆ–103æ—©æœŸæç¤ºï¼ˆ103 early hintsï¼‰ç­‰åŠŸèƒ½ã€‚</p><p>å› æ­¤ï¼Œè™½ç„¶åƒ 12121212 è¿™æ ·çš„å®Œå…¨â€œè½®è¯¢â€å¤šè·¯å¤ç”¨å¾ˆå°‘æ˜¯æ‚¨æƒ³è¦çš„ Web æ€§èƒ½ï¼Œä½†æ˜¯å¤šè·¯å¤ç”¨åœ¨æ€»ä½“ä¸Šç»å¯¹æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„ç‰¹æ€§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç®—æœºç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é›¶æ‹·è´-é«˜æ•ˆçš„ä¼ è¾“æ–‡ä»¶</title>
      <link href="/posts/80c635db.html"/>
      <url>/posts/80c635db.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p><strong>é›¶æ‹·è´</strong>æ˜¯æŒ‡è®¡ç®—æœºæ‰§è¡ŒIOæ“ä½œæ—¶ï¼ŒCPUä¸éœ€è¦å°†æ•°æ®ä»ä¸€ä¸ªå­˜å‚¨åŒºåŸŸå¤åˆ¶åˆ°å¦ä¸€ä¸ªå­˜å‚¨åŒºåŸŸï¼Œä»è€Œå¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ä»¥åŠCPUçš„æ‹·è´æ—¶é—´ã€‚å®ƒæ˜¯ä¸€ç§<code>I/O</code>æ“ä½œä¼˜åŒ–æŠ€æœ¯ã€‚</p><h2 id="ä¼ ç»Ÿ-IO-çš„æ‰§è¡Œæµç¨‹"><a href="#ä¼ ç»Ÿ-IO-çš„æ‰§è¡Œæµç¨‹" class="headerlink" title="ä¼ ç»Ÿ IO çš„æ‰§è¡Œæµç¨‹"></a>ä¼ ç»Ÿ IO çš„æ‰§è¡Œæµç¨‹</h2><p>åšæœåŠ¡ç«¯å¼€å‘çš„å°ä¼™ä¼´ï¼Œæ–‡ä»¶ä¸‹è½½åŠŸèƒ½åº”è¯¥å®ç°è¿‡ä¸å°‘äº†å§ã€‚å¦‚æœä½ å®ç°çš„æ˜¯ä¸€ä¸ª<strong>webç¨‹åº</strong>ï¼Œå‰ç«¯è¯·æ±‚è¿‡æ¥ï¼ŒæœåŠ¡ç«¯çš„ä»»åŠ¡å°±æ˜¯ï¼šå°†æœåŠ¡ç«¯ä¸»æœºç£ç›˜ä¸­çš„æ–‡ä»¶ä»å·²è¿æ¥çš„socketå‘å‡ºå»ã€‚å…³é”®å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>((n = <span class="built_in">read</span>(diskfd, buf, BUF_SIZE)) &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">write</span>(sockfd, buf , n);</span><br></pre></td></tr></table></figure><p>ä¼ ç»Ÿçš„IOæµç¨‹ï¼ŒåŒ…æ‹¬readå’Œwriteçš„è¿‡ç¨‹ã€‚</p><ul><li><code>read</code>ï¼šæŠŠæ•°æ®ä»ç£ç›˜è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œå†æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</li><li><code>write</code>ï¼šå…ˆæŠŠæ•°æ®å†™å…¥åˆ°socketç¼“å†²åŒºï¼Œæœ€åå†™å…¥ç½‘å¡è®¾å¤‡ã€‚</li></ul><p><strong>æµç¨‹å›¾å¦‚ä¸‹ï¼š</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426174926090.png" alt="image-20240426174926090"></p><ul><li>ç”¨æˆ·åº”ç”¨è¿›ç¨‹è°ƒç”¨readå‡½æ•°ï¼Œå‘æ“ä½œç³»ç»Ÿå‘èµ·IOè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€è½¬ä¸ºå†…æ ¸æ€ï¼ˆåˆ‡æ¢1ï¼‰</strong></li><li>DMAæ§åˆ¶å™¨æŠŠæ•°æ®ä»ç£ç›˜ä¸­ï¼Œè¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li>CPUæŠŠå†…æ ¸ç¼“å†²åŒºæ•°æ®ï¼Œæ‹·è´åˆ°ç”¨æˆ·åº”ç”¨ç¼“å†²åŒºï¼Œ<strong>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€è½¬ä¸ºç”¨æˆ·æ€ï¼ˆåˆ‡æ¢2ï¼‰</strong>ï¼Œreadå‡½æ•°è¿”å›</li><li>ç”¨æˆ·åº”ç”¨è¿›ç¨‹é€šè¿‡writeå‡½æ•°ï¼Œå‘èµ·IOè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€è½¬ä¸ºå†…æ ¸æ€ï¼ˆåˆ‡æ¢3ï¼‰</strong></li><li>CPUå°†ç”¨æˆ·ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œæ‹·è´åˆ°socketç¼“å†²åŒº</li><li>DMAæ§åˆ¶å™¨æŠŠæ•°æ®ä»socketç¼“å†²åŒºï¼Œæ‹·è´åˆ°ç½‘å¡è®¾å¤‡ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆåˆ‡æ¢4ï¼‰</strong>ï¼Œwriteå‡½æ•°è¿”å›</li></ul><p>ä»æµç¨‹å›¾å¯ä»¥çœ‹å‡ºï¼Œ<strong>ä¼ ç»ŸIOçš„è¯»å†™æµç¨‹</strong>ï¼ŒåŒ…æ‹¬äº†4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆ4æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼‰ï¼Œ4æ¬¡æ•°æ®æ‹·è´ï¼ˆ<strong>ä¸¤æ¬¡CPUæ‹·è´ä»¥åŠä¸¤æ¬¡çš„DMAæ‹·è´</strong>)ï¼Œä»€ä¹ˆæ˜¯DMAæ‹·è´å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥å›é¡¾ä¸‹ï¼Œé›¶æ‹·è´æ¶‰åŠçš„<strong>æ“ä½œç³»ç»ŸçŸ¥è¯†ç‚¹</strong>å“ˆã€‚</p><h2 id="DMAæŠ€æœ¯"><a href="#DMAæŠ€æœ¯" class="headerlink" title="DMAæŠ€æœ¯"></a>DMAæŠ€æœ¯</h2><p>DMAï¼Œè‹±æ–‡å…¨ç§°æ˜¯<strong>Direct Memory Access</strong>ï¼Œå³ç›´æ¥å†…å­˜è®¿é—®ã€‚<strong>DMA</strong>æœ¬è´¨ä¸Šæ˜¯ä¸€å—ä¸»æ¿ä¸Šç‹¬ç«‹çš„èŠ¯ç‰‡ï¼Œå…è®¸å¤–è®¾è®¾å¤‡å’Œå†…å­˜å­˜å‚¨å™¨ä¹‹é—´ç›´æ¥è¿›è¡ŒIOæ•°æ®ä¼ è¾“ï¼Œå…¶è¿‡ç¨‹<strong>ä¸éœ€è¦CPUçš„å‚ä¸</strong>ã€‚</p><p>æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹IOæµç¨‹ï¼ŒDMAå¸®å¿™åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426175033350.png" alt="image-20240426175033350"></p><ul><li>ç”¨æˆ·åº”ç”¨è¿›ç¨‹è°ƒç”¨readå‡½æ•°ï¼Œå‘æ“ä½œç³»ç»Ÿå‘èµ·IOè°ƒç”¨ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…æ•°æ®è¿”å›ã€‚</li><li>CPUæ”¶åˆ°æŒ‡ä»¤åï¼Œå¯¹DMAæ§åˆ¶å™¨å‘èµ·æŒ‡ä»¤è°ƒåº¦ã€‚</li><li>DMAæ”¶åˆ°IOè¯·æ±‚åï¼Œå°†è¯·æ±‚å‘é€ç»™ç£ç›˜ï¼›</li><li>ç£ç›˜å°†æ•°æ®æ”¾å…¥ç£ç›˜æ§åˆ¶ç¼“å†²åŒºï¼Œå¹¶é€šçŸ¥DMA</li><li>DMAå°†æ•°æ®ä»ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li>DMAå‘CPUå‘å‡ºæ•°æ®è¯»å®Œçš„ä¿¡å·ï¼ŒæŠŠå·¥ä½œäº¤æ¢ç»™CPUï¼Œç”±CPUè´Ÿè´£å°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºã€‚</li><li>ç”¨æˆ·åº”ç”¨è¿›ç¨‹ç”±å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ï¼Œè§£é™¤é˜»å¡çŠ¶æ€</li></ul><p>DMAçš„å·¥ä½œå°±æ˜¯<strong>å¸®å¿™CPUè½¬å‘ä¸€ä¸‹IOè¯·æ±‚ï¼Œä»¥åŠæ‹·è´æ•°æ®</strong>ã€‚</p><blockquote><p>ä¸»è¦å°±æ˜¯æ•ˆç‡ï¼Œå®ƒå¸®å¿™CPUåšäº‹æƒ…ï¼Œè¿™æ—¶å€™ï¼ŒCPUå°±å¯ä»¥é—²ä¸‹æ¥å»åšåˆ«çš„äº‹æƒ…ï¼Œæé«˜äº†CPUçš„åˆ©ç”¨æ•ˆç‡ã€‚å¤§ç™½è¯è§£é‡Šå°±æ˜¯ï¼ŒCPUè€å“¥å¤ªå¿™å¤ªç´¯å•¦ï¼Œæ‰€ä»¥ä»–æ‰¾äº†ä¸ªå°å¼Ÿï¼ˆåå«DMAï¼‰ ï¼Œæ›¿ä»–å®Œæˆä¸€éƒ¨åˆ†çš„æ‹·è´å·¥ä½œï¼Œè¿™æ ·CPUè€å“¥å°±èƒ½ç€æ‰‹å»åšå…¶ä»–äº‹æƒ…ã€‚</p></blockquote><h2 id="é›¶æ‹·è´"><a href="#é›¶æ‹·è´" class="headerlink" title="é›¶æ‹·è´"></a>é›¶æ‹·è´</h2><p>é›¶æ‹·è´å¹¶ä¸æ˜¯æ²¡æœ‰æ‹·è´æ•°æ®ï¼Œè€Œæ˜¯å‡å°‘ç”¨æˆ·æ€/å†…æ ¸æ€çš„åˆ‡æ¢æ¬¡æ•°ä»¥åŠCPUæ‹·è´çš„æ¬¡æ•°ã€‚</p><p>é›¶æ‹·è´å®ç°æœ‰å¤šç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯</p><ul><li>mmap+write</li><li>sendfile</li><li>sendfile+DMAæ”¶é›†</li><li>splice</li></ul><h3 id="mmap-write"><a href="#mmap-write" class="headerlink" title="mmap+write"></a>mmap+write</h3><p>mmap çš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> prot, <span class="type">int</span> flags, <span class="type">int</span> fd, <span class="type">off_t</span> offset)</span>;</span><br></pre></td></tr></table></figure><ul><li>addrï¼šæŒ‡å®šæ˜ å°„çš„è™šæ‹Ÿå†…å­˜åœ°å€</li><li>lengthï¼šæ˜ å°„çš„é•¿åº¦</li><li>protï¼šæ˜ å°„å†…å­˜çš„ä¿æŠ¤æ¨¡å¼</li><li>flagsï¼šæŒ‡å®šæ˜ å°„çš„ç±»å‹</li><li>fd:è¿›è¡Œæ˜ å°„çš„æ–‡ä»¶å¥æŸ„</li><li>offset:æ–‡ä»¶åç§»é‡</li></ul><p>mmapç”¨äº†è™šæ‹Ÿå†…å­˜ä¸­å¯ä»¥æŠŠå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†åœ°å€è¿™ä¸ªç‰¹ç‚¹ï¼Œå®ƒå°†å†…æ ¸ä¸­çš„è¯»ç¼“å†²åŒºä¸ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºè¿›è¡Œæ˜ å°„ï¼Œæ‰€æœ‰çš„IOéƒ½åœ¨å†…æ ¸ä¸­å®Œæˆã€‚</p><p><code>mmap+write</code><br>å®ç°çš„é›¶æ‹·è´æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426175310052.png" alt="image-20240426175310052"></p><ul><li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡<code>mmapæ–¹æ³•</code>å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·IOè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€</strong>ã€‚</li><li>CPUåˆ©ç”¨DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li><strong>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€</strong>ï¼Œmmapæ–¹æ³•è¿”å›ã€‚</li><li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡<code>write</code><br>æ–¹æ³•å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·IOè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€</strong>ã€‚</li><li>CPUå°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°çš„socketç¼“å†²åŒºã€‚</li><li>CPUåˆ©ç”¨DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»socketç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ï¼Œ<strong>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€</strong>ï¼Œwriteè°ƒç”¨è¿”å›ã€‚</li></ul><p>å¯ä»¥å‘ç°ï¼Œ<code>mmap+write</code>å®ç°çš„é›¶æ‹·è´ï¼ŒI/Oå‘ç”Ÿäº†<strong>4</strong>æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ3æ¬¡æ•°æ®æ‹·è´ã€‚å…¶ä¸­3æ¬¡æ•°æ®æ‹·è´ä¸­ï¼ŒåŒ…æ‹¬äº†<strong>2æ¬¡DMAæ‹·è´å’Œ1æ¬¡CPUæ‹·è´</strong>ã€‚</p><p><code>mmap</code>æ˜¯å°†è¯»ç¼“å†²åŒºçš„åœ°å€å’Œç”¨æˆ·ç¼“å†²åŒºçš„åœ°å€è¿›è¡Œæ˜ å°„ï¼Œå†…æ ¸ç¼“å†²åŒºå’Œåº”ç”¨ç¼“å†²åŒºå…±äº«ï¼Œæ‰€ä»¥èŠ‚çœäº†ä¸€æ¬¡CPUæ‹·è´â€˜â€™å¹¶ä¸”ç”¨æˆ·è¿›ç¨‹å†…å­˜æ˜¯<strong>è™šæ‹Ÿçš„</strong>ï¼Œåªæ˜¯<strong>æ˜ å°„</strong>åˆ°å†…æ ¸çš„è¯»ç¼“å†²åŒºï¼Œå¯ä»¥èŠ‚çœä¸€åŠçš„å†…å­˜ç©ºé—´ã€‚</p><h3 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h3><p><code>sendfile</code>æ˜¯Linux2.1å†…æ ¸ç‰ˆæœ¬åå¼•å…¥çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼ŒAPIå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">sendfile</span><span class="params">(<span class="type">int</span> out_fd, <span class="type">int</span> in_fd, <span class="type">off_t</span> *offset, <span class="type">size_t</span> count)</span></span>;</span><br></pre></td></tr></table></figure><ul><li>out_fd:ä¸ºå¾…å†™å…¥å†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€ä¸ªsocketæè¿°ç¬¦ã€‚ï¼Œ</li><li>in_fd:ä¸ºå¾…è¯»å‡ºå†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¿…é¡»æ˜¯çœŸå®çš„æ–‡ä»¶ï¼Œä¸èƒ½æ˜¯socketå’Œç®¡é“ã€‚</li><li>offsetï¼šæŒ‡å®šä»è¯»å…¥æ–‡ä»¶çš„å“ªä¸ªä½ç½®å¼€å§‹è¯»ï¼Œå¦‚æœä¸ºNULLï¼Œè¡¨ç¤ºæ–‡ä»¶çš„é»˜è®¤èµ·å§‹ä½ç½®ã€‚</li><li>countï¼šæŒ‡å®šåœ¨fdoutå’Œfdinä¹‹é—´ä¼ è¾“çš„å­—èŠ‚æ•°ã€‚</li></ul><p>sendfileè¡¨ç¤ºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œå®ƒæ˜¯åœ¨<strong>æ“ä½œç³»ç»Ÿå†…æ ¸</strong>ä¸­æ“ä½œçš„ï¼Œ<strong>é¿å…äº†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·ç¼“å†²åŒºä¹‹é—´çš„æ‹·è´æ“ä½œ</strong>ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨å®ƒæ¥å®ç°é›¶æ‹·è´ã€‚</p><p>sendfileå®ç°çš„é›¶æ‹·è´æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426175356744.png" alt="image-20240426175356744"></p><ol><li>ç”¨æˆ·è¿›ç¨‹å‘èµ·sendfileç³»ç»Ÿè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢1ï¼‰ä»ç”¨æˆ·æ€è½¬å‘å†…æ ¸æ€</strong></li><li>DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li>CPUå°†è¯»ç¼“å†²åŒºä¸­æ•°æ®æ‹·è´åˆ°socketç¼“å†²åŒº</li><li>DMAæ§åˆ¶å™¨ï¼Œå¼‚æ­¥æŠŠæ•°æ®ä»socketç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ï¼Œ</li><li><strong>ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢2ï¼‰ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€</strong>ï¼Œsendfileè°ƒç”¨è¿”å›ã€‚</li></ol><p>å¯ä»¥å‘ç°ï¼Œ<code>sendfile</code>å®ç°çš„é›¶æ‹·è´ï¼ŒI/Oå‘ç”Ÿäº†<strong>2</strong>æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ3æ¬¡æ•°æ®æ‹·è´ã€‚å…¶ä¸­3æ¬¡æ•°æ®æ‹·è´ä¸­ï¼ŒåŒ…æ‹¬äº†<strong>2æ¬¡DMAæ‹·è´å’Œ1æ¬¡CPUæ‹·è´</strong>ã€‚é‚£èƒ½ä¸èƒ½æŠŠCPUæ‹·è´çš„æ¬¡æ•°å‡å°‘åˆ°0æ¬¡å‘¢ï¼Ÿæœ‰çš„ï¼Œå³å¸¦æœ‰DMAæ”¶é›†æ‹·è´åŠŸèƒ½çš„sendfileï¼</p><h3 id="sendfile-DMA-scatter-gather"><a href="#sendfile-DMA-scatter-gather" class="headerlink" title="sendfile+DMA scatter/gather"></a>sendfile+DMA scatter/gather</h3><p>linux 2.4ç‰ˆæœ¬ä¹‹åï¼Œå¯¹<code>sendfile</code>åšäº†ä¼˜åŒ–å‡çº§ï¼Œå¼•å…¥SG-DMAæŠ€æœ¯ï¼Œå…¶å®å°±æ˜¯å¯¹DMAæ‹·è´åŠ å…¥äº†<code>scatter/gather</code>æ“ä½œï¼Œå®ƒå¯ä»¥ç›´æ¥ä»å†…æ ¸ç©ºé—´ç¼“å†²åŒºä¸­å°†æ•°æ®è¯»å–åˆ°ç½‘å¡ã€‚ä½¿ç”¨è¿™ä¸ªç‰¹ç‚¹æé›¶æ‹·è´ï¼Œå³è¿˜å¯ä»¥å¤šçœå»<strong>ä¸€æ¬¡CPUæ‹·è´</strong>ã€‚</p><p>sendfile+DMA scatter/gatherå®ç°çš„é›¶æ‹·è´æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426175456788.png" alt="image-20240426175456788"></p><ol><li>ç”¨æˆ·è¿›ç¨‹å‘èµ·sendfileç³»ç»Ÿè°ƒç”¨ï¼Œ<strong>ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢1ï¼‰ä»ç”¨æˆ·æ€è½¬å‘å†…æ ¸æ€</strong></li><li>DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li><li>CPUæŠŠå†…æ ¸ç¼“å†²åŒºä¸­çš„<strong>æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯</strong>ï¼ˆåŒ…æ‹¬å†…æ ¸ç¼“å†²åŒºçš„å†…å­˜åœ°å€å’Œåç§»é‡ï¼‰å‘é€åˆ°socketç¼“å†²åŒº</li><li>DMAæ§åˆ¶å™¨æ ¹æ®æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œç›´æ¥æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡</li><li><strong>ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢2ï¼‰ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€</strong>ï¼Œsendfileè°ƒç”¨è¿”å›ã€‚</li></ol><p>å¯ä»¥å‘ç°ï¼Œ<code>sendfile+DMA scatter/gather</code>å®ç°çš„é›¶æ‹·è´ï¼ŒI/Oå‘ç”Ÿäº†<strong>2</strong>æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ2æ¬¡æ•°æ®æ‹·è´ã€‚å…¶ä¸­2æ¬¡æ•°æ®æ‹·è´éƒ½æ˜¯åŒ…<strong>DMAæ‹·è´</strong>ã€‚è¿™å°±æ˜¯çœŸæ­£çš„ <strong>é›¶æ‹·è´ï¼ˆZero-copy)</strong> æŠ€æœ¯ï¼Œå…¨ç¨‹éƒ½æ²¡æœ‰é€šè¿‡CPUæ¥æ¬è¿æ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é€šè¿‡DMAæ¥è¿›è¡Œä¼ è¾“çš„ã€‚</p><h3 id="splice"><a href="#splice" class="headerlink" title="splice"></a>splice</h3><p>åŸºäº splice ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ0 æ¬¡ CPU æ‹·è´ä»¥åŠ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ splice() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li><li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚</li><li>CPU åœ¨å†…æ ¸ç©ºé—´çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰å’Œç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ä¹‹é—´å»ºç«‹ç®¡é“ï¼ˆpipelineï¼‰ã€‚</li><li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li><li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œsplice ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li></ol><p>splice æ‹·è´æ–¹å¼ä¹ŸåŒæ ·å­˜åœ¨ç”¨æˆ·ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„é—®é¢˜ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä½¿ç”¨äº† Linux çš„ç®¡é“ç¼“å†²æœºåˆ¶ï¼Œå¯ä»¥ç”¨äºä»»æ„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸­ä¼ è¾“æ•°æ®ï¼Œä½†æ˜¯å®ƒçš„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦å‚æ•°ä¸­æœ‰ä¸€ä¸ªå¿…é¡»æ˜¯ç®¡é“è®¾å¤‡ã€‚</p><p><strong>æ€»ç»“</strong></p><p>æ— è®ºæ˜¯ä¼ ç»Ÿ I/O æ‹·è´æ–¹å¼è¿˜æ˜¯å¼•å…¥é›¶æ‹·è´çš„æ–¹å¼ï¼Œ2 æ¬¡ DMA Copy æ˜¯éƒ½å°‘ä¸äº†çš„ï¼Œå› ä¸ºä¸¤æ¬¡ DMA éƒ½æ˜¯ä¾èµ–ç¡¬ä»¶å®Œæˆçš„ã€‚ä¸‹é¢ä» CPU æ‹·è´æ¬¡æ•°ã€DMA æ‹·è´æ¬¡æ•°ä»¥åŠç³»ç»Ÿè°ƒç”¨å‡ ä¸ªæ–¹é¢æ€»ç»“ä¸€ä¸‹ä¸Šè¿°å‡ ç§ I/O æ‹·è´æ–¹å¼çš„å·®åˆ«ã€‚</p><div class="table-container"><table><thead><tr><th>æ‹·è´æ–¹å¼</th><th>CPUæ‹·è´</th><th>DMAæ‹·è´</th><th>ç³»ç»Ÿè°ƒç”¨</th><th>ä¸Šä¸‹æ–‡åˆ‡æ¢</th></tr></thead><tbody><tr><td>ä¼ ç»Ÿæ–¹å¼ï¼ˆread + writeï¼‰</td><td>2</td><td>2</td><td>read / write</td><td>4</td></tr><tr><td>å†…å­˜æ˜ å°„ï¼ˆmmap + writeï¼‰</td><td>1</td><td>2</td><td>mmap / write</td><td>4</td></tr><tr><td>sendfile</td><td>1</td><td>2</td><td>sendfile</td><td>2</td></tr><tr><td>sendfile + DMA gather copy</td><td>0</td><td>2</td><td>sendfile</td><td>2</td></tr><tr><td>splice</td><td>0</td><td>2</td><td>splice</td><td>2</td></tr></tbody></table></div><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ul><li><a href="https://juejin.cn/user/3104676567320286/posts">é›¶å£¹æŠ€æœ¯æ ˆ</a></li><li><a href="https://juejin.cn/user/4406498336190638/posts">æ½œè¡Œå‰è¡Œ</a></li><li><a href="https://www.modb.pro/db/218517">çœ‹ä¸€éå°±ç†è§£ï¼šé›¶æ‹·è´è¯¦è§£</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ“ä½œç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ“ä½œç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¡µä¸­æ–­</title>
      <link href="/posts/54462149.html"/>
      <url>/posts/54462149.html</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†</h2><blockquote><p><strong>Linuxè™šæ‹Ÿå†…å­˜ç³»ç»Ÿ</strong></p></blockquote><p>Linuxå°†è™šæ‹Ÿå†…å­˜ç»„ç»‡æˆä¸€äº›åŒºåŸŸ(ä¹Ÿå«åšæ®µ)çš„é›†åˆã€‚ä¸€ä¸ªåŒºåŸŸ(area)å°±æ˜¯å·²ç»å­˜åœ¨ç€çš„(å·²åˆ†é…çš„)è™šæ‹Ÿå†…å­˜çš„è¿ç»­ç‰‡(chunk)ï¼Œè¿™äº›é¡µæ˜¯ä»¥æŸç§æ–¹å¼ç›¸å…³è”çš„ã€‚ä¾‹å¦‚ï¼Œä»£ç æ®µã€æ•°æ®æ®µã€å †ã€å…±äº«åº“æ®µï¼Œä»¥åŠç”¨æˆ·æ ˆéƒ½æ˜¯ä¸åŒçš„åŒºåŸŸã€‚æ¯ä¸ªå­˜åœ¨çš„è™šæ‹Ÿé¡µé¢éƒ½ä¿å­˜åœ¨æŸä¸ªåŒºåŸŸä¸­ï¼Œè€Œä¸å±äºæŸä¸ªåŒºåŸŸçš„è™šæ‹Ÿé¡µæ˜¯ä¸å­˜åœ¨çš„ï¼Œå¹¶ä¸”ä¸èƒ½è¢«è¿›ç¨‹å¼•ç”¨ã€‚åŒºåŸŸçš„æ¦‚å¿µå¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸è™šæ‹Ÿåœ°å€ç©ºé—´æœ‰é—´éš™ã€‚å†…æ ¸ä¸ç”¨è®°å½•é‚£äº›ä¸å­˜åœ¨çš„è™šæ‹Ÿé¡µï¼Œè€Œè¿™æ ·çš„é¡µä¹Ÿä¸å ç”¨å†…å­˜ã€ç£ç›˜æˆ–è€…å†…æ ¸æœ¬èº«ä¸­çš„ä»»ä½•é¢å¤–èµ„æºã€‚</p><p>Linuxå°†è™šæ‹Ÿå†…å­˜ç»„ç»‡æˆä¸€äº›åŒºåŸŸ(ä¹Ÿå«åšæ®µ)çš„é›†åˆã€‚ä¸€ä¸ªåŒºåŸŸ(area)å°±æ˜¯å·²ç»å­˜åœ¨ç€çš„(å·²åˆ†é…çš„)è™šæ‹Ÿå†…å­˜çš„è¿ç»­ç‰‡(chunk)ï¼Œè¿™äº›é¡µæ˜¯ä»¥æŸç§æ–¹å¼ç›¸å…³è”çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426163611028.png" alt="image-20240426163611028"></p><p>ä¸‹å›¾å¼ºè°ƒäº†è®°å½•ä¸€ä¸ªè¿›ç¨‹ä¸­è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„å†…æ ¸æ•°æ®ç»“æ„ã€‚å†…æ ¸ä¸ºç³»ç»Ÿä¸­çš„æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ªå•ç‹¬çš„ä»»åŠ¡ç»“æ„(æºä»£ç ä¸­çš„task_struct)ã€‚ä»»åŠ¡ç»“æ„ä¸­çš„å…ƒç´ åŒ…å«æˆ–è€…æŒ‡å‘å†…æ ¸è¿è¡Œè¯¥è¿›ç¨‹æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯(ä¾‹å¦‚ï¼ŒPIDã€æŒ‡å‘ç”¨æˆ·æ ˆçš„æŒ‡é’ˆã€å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶çš„åå­—ï¼Œä»¥åŠç¨‹åºè®¡æ•°å™¨)ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426163509993.png" alt="image-20240426163509993"></p><p>ä»»åŠ¡ç»“æ„ä¸­çš„ä¸€ä¸ªæ¡ç›®æŒ‡å‘mm_structï¼Œå®ƒæè¿°äº†è™šæ‹Ÿå†…å­˜çš„å½“å‰çŠ¶æ€ã€‚æˆ‘ä»¬æ„Ÿå…´è¶£çš„ä¸¤ä¸ªå­—æ®µæ˜¯ pgdå’Œmmapï¼Œå…¶ä¸­ pgdæŒ‡å‘ç¬¬ä¸€çº§é¡µè¡¨(é¡µå…¨å±€ç›®å½•)çš„åŸºå€ï¼Œè€ŒmmapæŒ‡å‘ä¸€ä¸ªvm area_structs(åŒºåŸŸç»“æ„)çš„é“¾è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªvm_area_structséƒ½æè¿°äº†å½“å‰è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€ä¸ªåŒºåŸŸã€‚å½“å†…æ ¸è¿è¡Œè¿™ä¸ªè¿›ç¨‹æ—¶ï¼Œå°±å°†pgdå­˜æ”¾åœ¨CR3æ§åˆ¶å¯„å­˜å™¨ä¸­ã€‚</p><p>ä¸€ä¸ªå…·ä½“çš„åŒºåŸŸç»“æ„åŒ…å«ä»¥ä¸‹å­—æ®µï¼š</p><ul><li>vm_start:æŒ‡å‘è¿™ä¸ªåŒºåŸŸçš„èµ·å§‹å¤„ã€‚</li><li>vm_end:æŒ‡å‘è¿™ä¸ªåŒºåŸŸçš„ç»“æŸå¤„ã€‚</li><li>vm_prot:æè¿°è¿™ä¸ªåŒºåŸŸå†…åŒ…å«çš„æ‰€æœ‰é¡µçš„è¯»å†™è®¸å¯æƒé™ã€‚</li><li>vm_flags:æè¿°è¿™ä¸ªåŒºåŸŸå†…çš„é¡µé¢æ˜¯ä¸å…¶ä»–è¿›ç¨‹å…±äº«çš„ï¼Œè¿˜æ˜¯è¿™ä¸ªè¿›ç¨‹ç§æœ‰çš„(è¿˜æè¿°äº†å…¶ä»–ä¸€äº›ä¿¡æ¯)ã€‚</li><li>vm_next:æŒ‡å‘é“¾è¡¨ä¸­ä¸‹ä¸€ä¸ªåŒºåŸŸç»“æ„ã€‚</li></ul><blockquote><p><strong>é¡µä¸­æ–­å¼‚å¸¸å¤„ç†</strong></p></blockquote><p>å‡è®¾ MMUåœ¨è¯•å›¾ç¿»è¯‘æŸä¸ªè™šæ‹Ÿåœ°å€Aæ—¶ï¼Œè§¦å‘äº†ä¸€ä¸ªç¼ºé¡µã€‚è¿™ä¸ªå¼‚å¸¸å¯¼è‡´æ§åˆ¶è½¬ç§»åˆ°å†…æ ¸çš„ç¼ºé¡µå¤„ç†ç¨‹åºï¼Œå¤„ç†ç¨‹åºéšåå°±æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤:</p><ol><li>è™šæ‹Ÿåœ°å€Aæ˜¯åˆæ³•çš„å—?æ¢å¥è¯è¯´ï¼ŒAåœ¨æŸä¸ªåŒºåŸŸç»“æ„å®šä¹‰çš„åŒºåŸŸå†…å—?ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œç¼ºé¡µå¤„ç†ç¨‹åºæœç´¢åŒºåŸŸç»“æ„çš„é“¾è¡¨ï¼ŒæŠŠAå’Œæ¯ä¸ªåŒºåŸŸç»“æ„ä¸­çš„vm_startå’Œvm_endåšæ¯”è¾ƒã€‚å¦‚æœè¿™ä¸ªæŒ‡ä»¤æ˜¯ä¸åˆæ³•çš„ï¼Œé‚£ä¹ˆç¼ºé¡µå¤„ç†ç¨‹åºå°±è§¦å‘ä¸€ä¸ªæ®µé”™è¯¯ï¼Œä»è€Œå©†æ­¢è¿™ä¸ªè¿›ç¨‹ã€‚è¿™ä¸ªæƒ…å†µåœ¨å›¾9-28ä¸­æ ‡è¯†ä¸ºâ€œ1â€ã€‚<br>å› ä¸ºä¸€ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„æ–°è™šæ‹Ÿå†…å­˜åŒºåŸŸ(ä½¿ç”¨åœ¨ä¸‹ä¸€èŠ‚ä¸­æè¿°çš„mmapå‡½æ•°)ï¼Œæ‰€ä»¥é¡ºåºæœç´¢åŒºåŸŸç»“æ„çš„é“¾è¡¨èŠ±é”€å¯èƒ½ä¼šå¾ˆå¤§ã€‚å› æ­¤åœ¨å®é™…ä¸­ï¼ŒLinuxä½¿ç”¨æŸäº›æˆ‘ä»¬æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥çš„å­—æ®µï¼ŒLinuxåœ¨é“¾è¡¨ä¸­æ„å»ºäº†ä¸€æ£µæ ‘ï¼Œå¹¶åœ¨è¿™æ£µæ ‘ä¸Šè¿›è¡ŒæŸ¥æ‰¾ã€‚</li><li>è¯•å›¾è¿›è¡Œçš„å†…å­˜è®¿é—®æ˜¯å¦åˆæ³•?æ¢å¥è¯è¯´ï¼Œè¿›ç¨‹æ˜¯å¦æœ‰è¯»ã€å†™æˆ–è€…æ‰§è¡Œè¿™ä¸ªåŒºåŸŸå†…é¡µé¢çš„æƒé™?ä¾‹å¦‚ï¼Œè¿™ä¸ªç¼ºé¡µæ˜¯ä¸æ˜¯ç”±ä¸€æ¡è¯•å›¾å¯¹è¿™ä¸ªä»£ç æ®µé‡Œçš„åªè¯»é¡µé¢è¿›è¡Œå†™æ“ä½œçš„å­˜å‚¨æŒ‡ä»¤é€ æˆçš„?è¿™ä¸ªç¼ºé¡µæ˜¯ä¸æ˜¯å› ä¸ºä¸€ä¸ªè¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸­çš„è¿›ç¨‹è¯•å›¾ä»å†…æ ¸è™šæ‹Ÿå†…å­˜ä¸­è¯»å–å­—é€ æˆçš„?å¦‚æœè¯•å›¾è¿›è¡Œçš„è®¿é—®æ˜¯ä¸åˆæ³•çš„ï¼Œé‚£ä¹ˆç¼ºé¡µå¤„ç†ç¨‹åºä¼šè§¦å‘ä¸€ä¸ªä¿æŠ¤å¼‚å¸¸ï¼Œä»è€Œç»ˆæ­¢è¿™ä¸ªè¿›ç¨‹ã€‚è¿™ç§æƒ…å†µåœ¨å›¾9-28ä¸­æ ‡è¯†ä¸ºâ€œ2â€ã€‚</li><li>æ­¤åˆ»ï¼Œå†…æ ¸çŸ¥é“äº†è¿™ä¸ªç¼ºé¡µæ˜¯ç”±äºå¯¹åˆæ³•çš„è™šæ‹Ÿåœ°å€è¿›è¡Œåˆæ³•çš„æ“ä½œé€ æˆçš„ã€‚å®ƒæ˜¯è¿™æ ·æ¥å¤„ç†è¿™ä¸ªç¼ºé¡µçš„:é€‰æ‹©ä¸€ä¸ªç‰ºç‰²é¡µé¢ï¼Œå¦‚æœè¿™ä¸ªç‰ºç‰²é¡µé¢è¢«ä¿®æ”¹è¿‡ï¼Œé‚£ä¹ˆå°±å°†å®ƒäº¤æ¢å‡ºå»ï¼Œæ¢å…¥æ–°çš„é¡µé¢å¹¶æ›´æ–°é¡µè¡¨ã€‚å½“ç¼ºé¡µå¤„ç†ç¨‹åºè¿”å›æ—¶ï¼ŒCPUé‡æ–°å¯åŠ¨å¼•èµ·ç¼ºé¡µçš„æŒ‡ä»¤ï¼Œè¿™æ¡æŒ‡ä»¤å°†å†æ¬¡å‘é€Aåˆ° MMUã€‚è¿™æ¬¡ï¼ŒMMUå°±èƒ½æ­£å¸¸åœ°ç¿»è¯‘Aï¼Œè€Œä¸ä¼šå†äº§ç”Ÿç¼ºé¡µä¸­æ–­äº†ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426165657036.png" alt="image-20240426165657036"></p><h2 id="forkåŸç†">forkåŸç†</h2><p><strong>forkåŸç†ï¼šå†™ä¿æŠ¤ä¸­æ–­ä¸å†™æ—¶å¤åˆ¶</strong></p><p>çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸ä»…å¯ä»¥è®¿é—®å…±æœ‰çš„å˜é‡ï¼Œè¿˜å¯ä»¥å„è‡ªä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œå¹¶ä¸”è¿™ä¸ªä¿®æ”¹å¯¹æ–¹éƒ½çœ‹ä¸è§ã€‚è¿™å…¶å®æ˜¯ fork çš„ä¸€ç§å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œè€Œé‡Œé¢èµ·å…³é”®ä½œç”¨çš„å°±æ˜¯å†™ä¿æŠ¤ä¸­æ–­ã€‚</p><p>å®é™…ä¸Šï¼Œæ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªè¿›ç¨‹ç®¡ç†çš„ç»“æ„ï¼Œåœ¨åç†è®ºçš„ä¹¦ç±é‡Œä¸€èˆ¬ä¼šç§°å®ƒä¸ºè¿›ç¨‹æ§åˆ¶å—ï¼ˆProcess Control Blockï¼ŒPCB)ã€‚å…·ä½“åˆ° Linux ç³»ç»Ÿä¸Šï¼ŒPCB å°±æ˜¯ task_struct è¿™ä¸ªç»“æ„ä½“ã€‚å®ƒé‡Œé¢è®°å½•äº†è¿›ç¨‹çš„é¡µè¡¨åŸºå€ï¼Œæ‰“å¼€æ–‡ä»¶åˆ—è¡¨ã€ä¿¡å·ã€æ—¶é—´ç‰‡ã€è°ƒåº¦å‚æ•°å’Œçº¿æ€§ç©ºé—´å·²ç»åˆ†é…çš„å†…å­˜åŒºåŸŸç­‰ç­‰æ•°æ®ã€‚</p><p>å…¶ä¸­ï¼Œ<strong>æè¿°çº¿æ€§ç©ºé—´å·²åˆ†é…çš„å†…å­˜åŒºåŸŸçš„ç»“æ„å¯¹äºå†…å­˜ç®¡ç†è‡³å…³é‡è¦</strong>ã€‚åœ¨ Linux æºç ä¸­ï¼Œè´Ÿè´£è¿™ä¸ªåŠŸèƒ½çš„ç»“æ„æ˜¯ vm_area_structï¼Œåé¢ç®€ç§° vmaã€ä¹Ÿæ˜¯å‰ç½®çŸ¥è¯†ä¸­æåˆ°çš„ã€‘ã€‚å†…æ ¸å°†æ¯ä¸€æ®µå…·æœ‰ç›¸åŒå±æ€§çš„å†…å­˜åŒºåŸŸå½“ä½œä¸€ä¸ªå•ç‹¬çš„å†…å­˜å¯¹è±¡è¿›è¡Œç®¡ç†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">vm_area_struct</span> &#123; </span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> vm_start;      <span class="comment">// åŒºé—´é¦–åœ°å€</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> vm_end;        <span class="comment">// åŒºé—´å°¾åœ°å€</span></span><br><span class="line">  <span class="type">pgprot_t</span>      vm_page_prot;  <span class="comment">// è®¿é—®æ§åˆ¶æƒé™</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> vm_flags;      <span class="comment">// æ ‡å¿—ä½</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">file</span> * vm_file;       <span class="comment">// è¢«æ˜ å°„çš„æ–‡ä»¶</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> vm_pgoff;      <span class="comment">// æ–‡ä»¶ä¸­çš„åç§»é‡</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸é‡Œï¼Œfork çš„ç¬¬ä¸€ä¸ªåŠ¨ä½œæ˜¯æŠŠ PCB å¤åˆ¶ä¸€ä»½ï¼Œä½†ç±»ä¼¼äºç‰©ç†é¡µç­‰è¿›ç¨‹èµ„æºä¸ä¼šè¢«å¤åˆ¶</strong>ã€‚è¿™æ ·çš„è¯ï¼Œçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µã€å †å’Œæ ˆéƒ½æ˜¯ç›¸åŒçš„ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬æ‹¥æœ‰ç›¸åŒçš„é¡µè¡¨ï¼Œè‡ªç„¶ä¹Ÿæœ‰ç›¸åŒçš„è™šæ‹Ÿç©ºé—´å¸ƒå±€å’Œå¯¹ç‰©ç†å†…å­˜çš„æ˜ å°„ã€‚å¦‚æœçˆ¶è¿›ç¨‹åœ¨ fork å­è¿›ç¨‹ä¹‹å‰åˆ›å»ºäº†ä¸€ä¸ªå˜é‡ï¼Œæ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆçˆ¶å­è¿›ç¨‹éƒ½èƒ½çœ‹åˆ°è¿™ä¸ªå˜é‡å’Œæ–‡ä»¶ã€‚</p><p><strong>fork çš„ç¬¬äºŒä¸ªåŠ¨ä½œæ˜¯å¤åˆ¶é¡µè¡¨å’Œ PCB ä¸­çš„ vma æ•°ç»„ï¼Œå¹¶æŠŠæ‰€æœ‰å½“å‰æ­£å¸¸çŠ¶æ€çš„æ•°æ®æ®µã€å †å’Œæ ˆç©ºé—´çš„è™šæ‹Ÿå†…å­˜é¡µï¼Œè®¾ç½®ä¸ºä¸å¯å†™ï¼Œç„¶åæŠŠå·²ç»æ˜ å°„çš„ç‰©ç†é¡µé¢çš„å¼•ç”¨è®¡æ•°åŠ  1</strong>ã€‚è¿™ä¸€æ­¥åªéœ€è¦å¤åˆ¶é¡µè¡¨å’Œä¿®æ”¹ PTE ä¸­çš„å†™æƒé™ä½å¯ä»¥äº†ï¼Œå¹¶ä¸ä¼šçœŸçš„ä¸ºå­è¿›ç¨‹çš„æ‰€æœ‰å†…å­˜ç©ºé—´åˆ†é…ç‰©ç†é¡µé¢ï¼Œä¿®æ”¹æ˜ å°„ï¼Œæ‰€ä»¥å®ƒçš„æ•ˆç‡æ˜¯éå¸¸é«˜çš„ã€‚è¿™æ—¶ï¼Œçˆ¶å­è¿›ç¨‹çš„é¡µè¡¨çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426164350719.png" alt="image-20240426164350719"></p><p>åœ¨ä¸Šå›¾ä¸­ï¼Œç‰©ç†é¡µæ‹¬å·ä¸­çš„æ•°å­—ä»£è¡¨è¯¥é¡µè¢«å¤šå°‘ä¸ªè¿›ç¨‹æ‰€å¼•ç”¨ã€‚Linux ä¸­ç”¨äºç®¡ç†ç‰©ç†é¡µé¢ï¼Œå’Œç»´æŠ¤ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°çš„ç»“æ„æ˜¯ mem_map å’Œ page structã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯å†™ä¿æŠ¤ä¸­æ–­è¦å‘æŒ¥ä½œç”¨çš„åœ°æ–¹äº†ã€‚ä¸ç®¡æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ï¼Œå®ƒä»¬æ¥ä¸‹æ¥éƒ½æœ‰å¯èƒ½å‘ç”Ÿå†™æ“ä½œï¼Œä½†æˆ‘ä»¬çŸ¥é“åœ¨ fork çš„ç¬¬äºŒæ­¥æ“ä½œä¸­ï¼Œå·²ç»å°†æ‰€æœ‰åŸæ¥å¯å†™çš„åœ°æ–¹éƒ½å˜æˆä¸å¯å†™äº†ï¼Œæ‰€ä»¥è¿™æ—¶å¿…ç„¶ä¼šå‘ç”Ÿå†™ä¿æŠ¤ä¸­æ–­ã€‚</p><p>æˆ‘ä»¬åˆšæ‰è¯´ï¼ŒLinux ç³»ç»Ÿçš„é¡µä¸­æ–­çš„å…¥å£åœ°å€æ˜¯ do_page_faultï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼Œå®ƒä¼šç»§ç»­åˆ¤æ–­ä¸­æ–­çš„ç±»å‹ã€‚ç”±äºå‘ç”Ÿä¸­æ–­çš„è™šæ‹Ÿåœ°å€åœ¨ vma ä¸­æ˜¯å¯å†™çš„ï¼Œåœ¨ PTE ä¸­å´æ˜¯åªè¯»çš„ï¼Œå¯ä»¥æ–­å®šè¿™æ˜¯ä¸€æ¬¡å†™ä¿æŠ¤ä¸­æ–­ã€‚è¿™æ—¶å€™ï¼Œå†…æ ¸å°±ä¼šè½¬è€Œè°ƒç”¨ do_wp_page æ¥å¤„ç†è¿™æ¬¡ä¸­æ–­ï¼Œwp æ˜¯ write protection çš„ç¼©å†™ã€‚</p><p>åœ¨ do_wp_page ä¸­ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å‘ç”Ÿä¸­æ–­çš„è™šæ‹Ÿåœ°å€æ‰€å¯¹åº”çš„ç‰©ç†åœ°å€çš„å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœå¤§äº 1ï¼Œå°±è¯´æ˜ç°åœ¨å­˜åœ¨å¤šä¸ªè¿›ç¨‹å…±äº«è¿™ä¸€å—ç‰©ç†é¡µé¢ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦ä¸ºå‘ç”Ÿä¸­æ–­çš„è¿›ç¨‹å†åˆ†é…ä¸€ä¸ªç‰©ç†é¡µé¢ï¼ŒæŠŠè€çš„é¡µé¢å†…å®¹æ‹·è´è¿›è¿™ä¸ªæ–°çš„ç‰©ç†é¡µï¼Œæœ€åæŠŠå‘ç”Ÿä¸­æ–­çš„è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°æ–°çš„ç‰©ç†é¡µã€‚è¿™å°±å®Œæˆäº†ä¸€æ¬¡å†™æ—¶å¤åˆ¶ (Copy On Writeï¼Œ COWï¼‰ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426164426565.png" alt="image-20240426164426565"></p><p>åœ¨ä¸Šå›¾ä¸­ï¼Œå½“å­è¿›ç¨‹å‘ç”Ÿå†™ä¿æŠ¤ä¸­æ–­åï¼Œç³»ç»Ÿå°±ä¼šä¸ºå®ƒåˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œç„¶åå¤åˆ¶é¡µé¢ï¼Œå†ä¿®æ”¹é¡µè¡¨æ˜ å°„ã€‚è¿™æ—¶è€çš„ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°å°±å˜ä¸º 1ï¼ŒåŒæ—¶å­è¿›ç¨‹ä¸­çš„ PTE çš„æƒé™ä¹Ÿä»åªè¯»å˜ä¸ºè¯»å†™ã€‚</p><p>å½“çˆ¶è¿›ç¨‹å†è®¿é—®åˆ°è¿™ä¸ªåœ°å€æ—¶ï¼Œä¹Ÿä¼šè§¦å‘ä¸€æ¬¡å†™ä¿æŠ¤ä¸­æ–­ï¼Œè¿™æ—¶ç³»ç»Ÿå‘ç°ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ä¸º 1ï¼Œé‚£å°±åªè¦æŠŠçˆ¶è¿›ç¨‹ PTE ä¸­çš„æƒé™ï¼Œç®€å•åœ°ä»åªè¯»å˜ä¸ºè¯»å†™å°±å¯ä»¥äº†ã€‚</p><p>æ€»ç»“ï¼š</p><p>fork åœ¨æ‰§è¡Œæ—¶ï¼Œå­è¿›ç¨‹åªä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„ PCB å’Œé¡µè¡¨ï¼Œå¹¶ä¸”æŠŠæ‰€æœ‰é¡µè¡¨é¡¹éƒ½è®¾ä¸ºåªè¯»ï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸ä¼šå¤åˆ¶çœŸæ­£çš„ç‰©ç†é¡µã€‚åªæœ‰å½“çˆ¶å­è¿›ç¨‹å…¶ä¸­ä¸€ä¸ªå¯¹é¡µè¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œæ‰ä¼šå¤åˆ¶ä¸€ä¸ªå‰¯æœ¬å‡ºæ¥ã€‚è¿™ç§æœºåˆ¶è¢«ç§°ä¸ºå†™æ—¶å¤åˆ¶ã€‚</p><h2 id="execveåŸç†">execveåŸç†</h2><p><strong>execveåŸç†ï¼šç¼ºé¡µä¸­æ–­</strong></p><p>execve çš„ä½œç”¨æ˜¯ä½¿å½“å‰è¿›ç¨‹æ‰§è¡Œä¸€ä¸ªæ–°çš„å¯æ‰§è¡Œç¨‹åºï¼Œå®ƒçš„åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">execve</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename, <span class="type">const</span> <span class="type">char</span>* argv[],<span class="type">const</span> <span class="type">char</span>* envp[])</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ execve çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯æ‰§è¡Œç¨‹åºçš„æ–‡ä»¶åï¼Œç¬¬äºŒä¸ªå‚æ•°ç”¨æ¥ä¼ é€’å‘½ä»¤è¡Œå‚æ•°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ç”¨æ¥ä¼ é€’ç¯å¢ƒå˜é‡ã€‚</p><p>execve çš„æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ol><li>æ¸…ç©ºé¡µè¡¨ï¼Œè¿™æ ·æ•´ä¸ªè¿›ç¨‹ä¸­çš„é¡µéƒ½å˜æˆä¸å­˜åœ¨äº†ï¼Œä¸€æ—¦è®¿é—®è¿™äº›é¡µï¼Œå°±ä¼šå‘ç”Ÿé¡µä¸­æ–­ï¼›</li><li>æ‰“å¼€å¾…åŠ è½½æ‰§è¡Œçš„æ–‡ä»¶ï¼Œåœ¨å†…æ ¸ä¸­åˆ›å»ºä»£è¡¨è¿™ä¸ªæ–‡ä»¶çš„ struct file ç»“æ„ï¼›</li><li>åŠ è½½å’Œè§£ææ–‡ä»¶å¤´ï¼Œæ–‡ä»¶å¤´é‡Œæè¿°äº†è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸€å…±æœ‰å¤šå°‘ sectionï¼›</li><li>åˆ›å»ºç›¸åº”çš„ vma æ¥æè¿°ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œå¹¶ä¸”å°†æ–‡ä»¶çš„å„ä¸ª section ä¸è¿™äº›å†…å­˜åŒºåŸŸå»ºç«‹æ˜ å°„å…³ç³»ï¼›</li><li>å¦‚æœå½“å‰åŠ è½½çš„æ–‡ä»¶è¿˜ä¾èµ–å…¶ä»–å…±äº«åº“æ–‡ä»¶ï¼Œåˆ™æ‰¾åˆ°è¿™ä¸ªå…±äº«åº“æ–‡ä»¶ï¼Œå¹¶è·³è½¬åˆ°ç¬¬ 2 æ­¥ç»§ç»­å¤„ç†è¿™ä¸ªå…±äº«åº“æ–‡ä»¶ï¼›</li><li>æœ€åè·³è½¬åˆ°å¯æ‰§è¡Œç¨‹åºçš„å…¥å£å¤„æ‰§è¡Œã€‚</li></ol><p><strong>execve çš„å®ç°å¹¶ä¸è´Ÿè´£å°†æ–‡ä»¶å†…å®¹åŠ è½½åˆ°ç‰©ç†é¡µä¸­ï¼Œå®ƒåªå»ºç«‹äº†è¿™ç§æ–‡ä»¶ sectionï¼Œä¸å†…å­˜åŒºåŸŸçš„æ˜ å°„å…³ç³»å°±ç»“æŸäº†</strong>ã€‚çœŸæ­£è´Ÿè´£åŠ è½½æ–‡ä»¶å†…å®¹çš„æ˜¯ç¼ºé¡µä¸­æ–­ã€‚</p><p>å› ä¸ºç”±äºç¬¬ 1 æ­¥æŠŠé¡µè¡¨éƒ½æ¸…ç©ºäº†ï¼Œè¿™å°±å¯¼è‡´ CPU åœ¨åŠ è½½æŒ‡ä»¤æ—¶ä¼šå‘ç°ä»£ç æ®µæ˜¯ç¼ºå¤±çš„ï¼Œæ­¤æ—¶å°±ä¼šäº§ç”Ÿç¼ºé¡µä¸­æ–­ã€‚</p><p>Linux å†…æ ¸ç”¨äºå¤„ç†ç¼ºé¡µä¸­æ–­çš„å‡½æ•°æ˜¯ do_no_pageï¼Œå¦‚æœå†…æ ¸æ£€æŸ¥ï¼Œå½“å‰å‡ºç°ç¼ºé¡µä¸­æ–­çš„è™šæ‹Ÿåœ°å€æ‰€åœ¨çš„å†…å­˜åŒºåŸŸ vmaï¼ˆè™šæ‹Ÿåœ°å€è½åœ¨è¯¥å†…å­˜åŒºåŸŸçš„ vm_start å’Œ vm_end ä¹‹é—´ï¼‰å­˜åœ¨æ–‡ä»¶æ˜ å°„ (vm_file ä¸ä¸ºç©ºï¼‰ï¼Œé‚£å°±å¯ä»¥é€šè¿‡è™šæ‹Ÿå†…å­˜åœ°å€è®¡ç®—æ–‡ä»¶ä¸­çš„åç§»ï¼Œè¿™å°±å®šä½åˆ°äº†å†…å­˜æ‰€ç¼ºçš„é¡µå¯¹åº”åˆ°æ–‡ä»¶çš„å“ªä¸€æ®µã€‚ç„¶åå†…æ ¸å°±å¯åŠ¨ç£ç›˜ IOï¼Œå°†å¯¹åº”çš„é¡µä»ç£ç›˜åŠ è½½è¿›å†…å­˜ã€‚ä¸€æ¬¡ç¼ºé¡µä¸­æ–­å°±è¿™æ ·è¢«è§£å†³äº†ã€‚</p><h2 id="mmapåŸç†">mmapåŸç†</h2><blockquote><p><strong>mmapå†…å­˜æ˜ å°„è¿‡ç¨‹</strong></p></blockquote><p>mmapå†…å­˜æ˜ å°„çš„å®ç°è¿‡ç¨‹ï¼Œæ€»çš„æ¥è¯´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><p><strong>(ä¸€)è¿›ç¨‹å¯åŠ¨æ˜ å°„è¿‡ç¨‹ï¼Œå¹¶åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸ºæ˜ å°„åˆ›å»ºè™šæ‹Ÿæ˜ å°„åŒºåŸŸ</strong></p><ol><li><p>è¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´è°ƒç”¨åº“å‡½æ•°mmapï¼ŒåŸå‹ï¼švoid *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offset);</p></li><li><p>åœ¨å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œå¯»æ‰¾ä¸€æ®µç©ºé—²çš„æ»¡è¶³è¦æ±‚çš„è¿ç»­çš„è™šæ‹Ÿåœ°å€ã€‚</p></li><li><p>ä¸ºæ­¤è™šæ‹ŸåŒºåˆ†é…ä¸€ä¸ªvm_area_structç»“æ„ï¼Œæ¥ç€å¯¹è¿™ä¸ªç»“æ„çš„å„ä¸ªåŸŸè¿›è¡Œäº†åˆå§‹åŒ–ã€‚</p></li><li><p>å°†æ–°å»ºçš„è™šæ‹ŸåŒºç»“æ„ï¼ˆvm_area_structï¼‰æ’å…¥è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€åŒºåŸŸé“¾è¡¨æˆ–æ ‘ä¸­ã€‚</p></li></ol><p><strong>(äºŒ)è°ƒç”¨å†…æ ¸ç©ºé—´çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°mmapï¼ˆä¸åŒäºç”¨æˆ·ç©ºé—´å‡½æ•°ï¼‰ï¼Œå®ç°æ–‡ä»¶ç‰©ç†åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€çš„ä¸€ä¸€æ˜ å°„å…³ç³»</strong></p><ol start="5"><li><p>ä¸ºæ˜ å°„åˆ†é…äº†æ–°çš„è™šæ‹Ÿåœ°å€åŒºåŸŸåï¼Œé€šè¿‡å¾…æ˜ å°„çš„æ–‡ä»¶æŒ‡é’ˆï¼Œåœ¨æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡æ–‡ä»¶æè¿°ç¬¦ï¼Œé“¾æ¥åˆ°å†…æ ¸â€œå·²æ‰“å¼€æ–‡ä»¶é›†â€ä¸­è¯¥æ–‡ä»¶çš„æ–‡ä»¶ç»“æ„ä½“ï¼ˆstruct fileï¼‰ï¼Œæ¯ä¸ªæ–‡ä»¶ç»“æ„ä½“ç»´æŠ¤ç€å’Œè¿™ä¸ªå·²æ‰“å¼€æ–‡ä»¶ç›¸å…³å„é¡¹ä¿¡æ¯ã€‚</p></li><li><p>é€šè¿‡è¯¥æ–‡ä»¶çš„æ–‡ä»¶ç»“æ„ä½“ï¼Œé“¾æ¥åˆ°file_operationsæ¨¡å—ï¼Œè°ƒç”¨å†…æ ¸å‡½æ•°mmapï¼Œå…¶åŸå‹ä¸ºï¼šint mmap(struct file *filp, struct vm_area_struct *vma)ï¼Œä¸åŒäºç”¨æˆ·ç©ºé—´åº“å‡½æ•°ã€‚</p></li><li><p>å†…æ ¸mmapå‡½æ•°é€šè¿‡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿinodeæ¨¡å—å®šä½åˆ°æ–‡ä»¶ç£ç›˜ç‰©ç†åœ°å€ã€‚</p></li><li><p>é€šè¿‡remap_pfn_rangeå‡½æ•°å»ºç«‹é¡µè¡¨ï¼Œå³å®ç°äº†æ–‡ä»¶åœ°å€å’Œè™šæ‹Ÿåœ°å€åŒºåŸŸçš„æ˜ å°„å…³ç³»ã€‚æ­¤æ—¶ï¼Œè¿™ç‰‡è™šæ‹Ÿåœ°å€å¹¶æ²¡æœ‰ä»»ä½•æ•°æ®å…³è”åˆ°ä¸»å­˜ä¸­ã€‚</p></li></ol><p><strong>(ä¸‰)è¿›ç¨‹å‘èµ·å¯¹è¿™ç‰‡æ˜ å°„ç©ºé—´çš„è®¿é—®ï¼Œå¼•å‘ç¼ºé¡µå¼‚å¸¸ï¼Œå®ç°æ–‡ä»¶å†…å®¹åˆ°ç‰©ç†å†…å­˜ï¼ˆä¸»å­˜ï¼‰çš„æ‹·è´</strong></p><p>æ³¨ï¼šå‰ä¸¤ä¸ªé˜¶æ®µä»…åœ¨äºåˆ›å»ºè™šæ‹ŸåŒºé—´å¹¶å®Œæˆåœ°å€æ˜ å°„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å°†ä»»ä½•æ–‡ä»¶æ•°æ®çš„æ‹·è´è‡³ä¸»å­˜ã€‚çœŸæ­£çš„æ–‡ä»¶è¯»å–æ˜¯å½“è¿›ç¨‹å‘èµ·è¯»æˆ–å†™æ“ä½œæ—¶ã€‚</p><ol start="9"><li><p>è¿›ç¨‹çš„è¯»æˆ–å†™æ“ä½œè®¿é—®è™šæ‹Ÿåœ°å€ç©ºé—´è¿™ä¸€æ®µæ˜ å°„åœ°å€ï¼Œé€šè¿‡æŸ¥è¯¢é¡µè¡¨ï¼Œå‘ç°è¿™ä¸€æ®µåœ°å€å¹¶ä¸åœ¨ç‰©ç†é¡µé¢ä¸Šã€‚å› ä¸ºç›®å‰åªå»ºç«‹äº†åœ°å€æ˜ å°„ï¼ŒçœŸæ­£çš„ç¡¬ç›˜æ•°æ®è¿˜æ²¡æœ‰æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤å¼•å‘ç¼ºé¡µå¼‚å¸¸ã€‚</p></li><li><p>ç¼ºé¡µå¼‚å¸¸è¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­ï¼Œç¡®å®šæ— éæ³•æ“ä½œåï¼Œå†…æ ¸å‘èµ·è¯·æ±‚è°ƒé¡µè¿‡ç¨‹ã€‚</p></li><li><p>è°ƒé¡µè¿‡ç¨‹å…ˆåœ¨äº¤æ¢ç¼“å­˜ç©ºé—´ï¼ˆswap cacheï¼‰ä¸­å¯»æ‰¾éœ€è¦è®¿é—®çš„å†…å­˜é¡µï¼Œå¦‚æœæ²¡æœ‰åˆ™è°ƒç”¨nopageå‡½æ•°æŠŠæ‰€ç¼ºçš„é¡µä»ç£ç›˜è£…å…¥åˆ°ä¸»å­˜ä¸­ã€‚</p></li><li><p>ä¹‹åè¿›ç¨‹å³å¯å¯¹è¿™ç‰‡ä¸»å­˜è¿›è¡Œè¯»æˆ–è€…å†™çš„æ“ä½œï¼Œå¦‚æœå†™æ“ä½œæ”¹å˜äº†å…¶å†…å®¹ï¼Œä¸€å®šæ—¶é—´åç³»ç»Ÿä¼šè‡ªåŠ¨å›å†™è„é¡µé¢åˆ°å¯¹åº”ç£ç›˜åœ°å€ï¼Œä¹Ÿå³å®Œæˆäº†å†™å…¥åˆ°æ–‡ä»¶çš„è¿‡ç¨‹ã€‚</p></li></ol><p>**æ³¨æ„ï¼š**ä¿®æ”¹è¿‡çš„è„é¡µé¢å¹¶ä¸ä¼šç«‹å³æ›´æ–°å›æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯æœ‰ä¸€æ®µæ—¶é—´çš„å»¶è¿Ÿï¼Œå¯ä»¥è°ƒç”¨msync()æ¥å¼ºåˆ¶åŒæ­¥, è¿™æ ·æ‰€å†™çš„å†…å®¹å°±èƒ½ç«‹å³ä¿å­˜åˆ°æ–‡ä»¶é‡Œäº†ã€‚</p><blockquote><p><strong>mmap å’Œå¸¸è§„æ–‡ä»¶æ“ä½œçš„åŒºåˆ«</strong></p></blockquote><p>ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼š</p><ol><li><p>è¿›ç¨‹å‘èµ·è¯»æ–‡ä»¶è¯·æ±‚ã€‚</p></li><li><p>å†…æ ¸é€šè¿‡æŸ¥æ‰¾è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œå®šä½åˆ°å†…æ ¸å·²æ‰“å¼€æ–‡ä»¶é›†ä¸Šçš„æ–‡ä»¶ä¿¡æ¯ï¼Œä»è€Œæ‰¾åˆ°æ­¤æ–‡ä»¶çš„inodeã€‚</p></li><li><p>inodeåœ¨address_spaceä¸ŠæŸ¥æ‰¾è¦è¯·æ±‚çš„æ–‡ä»¶é¡µæ˜¯å¦å·²ç»ç¼“å­˜åœ¨é¡µç¼“å­˜ä¸­ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ç‰‡æ–‡ä»¶é¡µçš„å†…å®¹ã€‚</p></li><li><p>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é€šè¿‡inodeå®šä½åˆ°æ–‡ä»¶ç£ç›˜åœ°å€ï¼Œå°†æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°é¡µç¼“å­˜ã€‚ä¹‹åå†æ¬¡å‘èµ·è¯»é¡µé¢è¿‡ç¨‹ï¼Œè¿›è€Œå°†é¡µç¼“å­˜ä¸­çš„æ•°æ®å‘ç»™ç”¨æˆ·è¿›ç¨‹ã€‚</p></li></ol><p>ã€é‡ç‚¹ã€‘æ€»ç»“æ¥è¯´ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œä¸ºäº†æé«˜è¯»å†™æ•ˆç‡å’Œä¿æŠ¤ç£ç›˜ï¼Œä½¿ç”¨äº†é¡µç¼“å­˜æœºåˆ¶ã€‚è¿™æ ·é€ æˆè¯»æ–‡ä»¶æ—¶éœ€è¦å…ˆå°†æ–‡ä»¶é¡µä»ç£ç›˜æ‹·è´åˆ°é¡µç¼“å­˜ä¸­ï¼Œç”±äºé¡µç¼“å­˜å¤„åœ¨å†…æ ¸ç©ºé—´ï¼Œä¸èƒ½è¢«ç”¨æˆ·è¿›ç¨‹ç›´æ¥å¯»å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦å°†é¡µç¼“å­˜ä¸­æ•°æ®é¡µå†æ¬¡æ‹·è´åˆ°å†…å­˜å¯¹åº”çš„ç”¨æˆ·ç©ºé—´ä¸­ã€‚è¿™æ ·ï¼Œé€šè¿‡äº†ä¸¤æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œæ‰èƒ½å®Œæˆè¿›ç¨‹å¯¹æ–‡ä»¶å†…å®¹çš„è·å–ä»»åŠ¡ã€‚å†™æ“ä½œä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¾…å†™å…¥çš„bufferåœ¨å†…æ ¸ç©ºé—´ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œå¿…é¡»è¦å…ˆæ‹·è´è‡³å†…æ ¸ç©ºé—´å¯¹åº”çš„ä¸»å­˜ï¼Œå†å†™å›ç£ç›˜ä¸­ï¼ˆå»¶è¿Ÿå†™å›ï¼‰ï¼Œä¹Ÿæ˜¯éœ€è¦ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚</p><p>è€Œä½¿ç”¨mmapæ“ä½œæ–‡ä»¶ä¸­ï¼Œåˆ›å»ºæ–°çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸå’Œå»ºç«‹æ–‡ä»¶ç£ç›˜åœ°å€å’Œè™šæ‹Ÿå†…å­˜åŒºåŸŸæ˜ å°„è¿™ä¸¤æ­¥ï¼Œæ²¡æœ‰ä»»ä½•æ–‡ä»¶æ‹·è´æ“ä½œã€‚è€Œä¹‹åè®¿é—®æ•°æ®æ—¶å‘ç°å†…å­˜ä¸­å¹¶æ— æ•°æ®è€Œå‘èµ·çš„ç¼ºé¡µå¼‚å¸¸è¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡å·²ç»å»ºç«‹å¥½çš„æ˜ å°„å…³ç³»ï¼Œåªä½¿ç”¨ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œå°±ä»ç£ç›˜ä¸­å°†æ•°æ®ä¼ å…¥å†…å­˜çš„ç”¨æˆ·ç©ºé—´ä¸­ï¼Œä¾›è¿›ç¨‹ä½¿ç”¨ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œéœ€è¦ä»ç£ç›˜åˆ°é¡µç¼“å­˜å†åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚è€Œmmapæ“æ§æ–‡ä»¶ï¼Œåªéœ€è¦ä»ç£ç›˜åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸€æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ã€‚è¯´ç™½äº†ï¼Œmmapçš„å…³é”®ç‚¹æ˜¯å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®ç›´æ¥äº¤äº’è€Œçœå»äº†ç©ºé—´ä¸åŒã€æ•°æ®ä¸é€šçš„ç¹çè¿‡ç¨‹ã€‚å› æ­¤mmapæ•ˆç‡æ›´é«˜ã€‚</p><p><strong>Note</strong>ï¼šä½¿ç”¨mmapéœ€è¦æ³¨æ„çš„ä¸€ä¸ªå…³é”®ç‚¹æ˜¯ï¼Œmmapæ˜ å°„åŒºåŸŸå¤§å°å¿…é¡»æ˜¯ç‰©ç†é¡µå¤§å°(page_size)çš„æ•´å€æ•°ï¼ˆ32ä½ç³»ç»Ÿä¸­é€šå¸¸æ˜¯4kå­—èŠ‚ï¼‰ã€‚</p><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://joytsing.cn/posts/30090/">mmap,æ¯”æƒ³è±¡çš„æ›´é‡è¦ä¸€ç‚¹</a></li><li>æå®¢æ—¶é—´</li><li>ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹</li></ul>]]></content>
      
      
      <categories>
          
          <category> æ“ä½œç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ“ä½œç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EXTæ–‡ä»¶ç³»ç»Ÿ</title>
      <link href="/posts/93870e50.html"/>
      <url>/posts/93870e50.html</url>
      
        <content type="html"><![CDATA[<h2 id="EXTæ–‡ä»¶ç³»ç»Ÿ">EXTæ–‡ä»¶ç³»ç»Ÿ</h2><h3 id="å‰è¨€">å‰è¨€</h3><p>å¼ºçƒˆæ¨èçœ‹å®Œè¿™ç¯‡Blogï¼Œè‡ªå·±åŠ¨æ‰‹äº²è‡ªå®ç°ä¸€ä¸ªminçš„æ–‡ä»¶ç³»ç»Ÿï¼Œæˆå°±æ„Ÿæ»¡æ»¡~</p><p>è¯¾ç¨‹ä¿¡æ¯ï¼šCSE.30341.FA17: Project 06ï¼šSimple File System</p><p>é“¾æ¥ï¼š<a href="https://www3.nd.edu/~pbui/teaching/cse.30341.fa17/project06.html">https://www3.nd.edu/~pbui/teaching/cse.30341.fa17/project06.html</a></p><p>ç”±äºå®éªŒè¦æ±‚ï¼Œè¿™é‡Œä¸æ”¾ä»“åº“é“¾æ¥ğŸ”—ã€‚æœ‰éœ€è¦å‚è€ƒçš„å°ä¼™ä¼´å¯ç§æˆ‘ã€‚</p><h3 id="0-é¢„å¤‡çŸ¥è¯†">0.é¢„å¤‡çŸ¥è¯†</h3><p>åœ¨å­¦ä¹ çŸ¥è¯†å‰ï¼Œæœ€å¥½è¦æœ‰ä¸ªæ•´ä½“çš„è®¤çŸ¥ï¼Œå†å»å­¦ä¹ ç»†èŠ‚ã€‚è¦ä¸ç„¶å®¹æ˜“é™·å…¥ç»†èŠ‚è¿·å¤±æ–¹å‘ã€‚</p><p>å…ˆæ¥ä¸ªæ•´ä½“çš„è®¤çŸ¥</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133829332.png" alt="image-20240426133829332"></p><ul><li><a href="https://www.bilibili.com/video/BV1ce4y1R7et/?spm_id_from=333.337.search-card.all.click&amp;vd_source=d6efee335659a376be8deb6c0654e9f7">ä¸€æ–‡å½»åº•ææ‡‚æ–‡ä»¶ç³»ç»Ÿã€‚æ–‡ä»¶ç³»ç»Ÿï¼Œè·ªä¸‹ï¼23è®¡ç®—æœºè€ƒç ”æ“ä½œç³»ç»Ÿå¤ç›˜ä¹‹æ–‡ä»¶ç³»ç»Ÿ</a></li></ul><p>æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹æœ‰å¾ˆå¤šç§</p><ul><li>CentOS 5å’ŒCentOS 6ä¸Šé»˜è®¤ä½¿ç”¨çš„ext2/ext3/ext4</li><li>CentOS 7ä¸Šé»˜è®¤ä½¿ç”¨çš„xfs</li><li>windowsä¸Šçš„NTFS</li><li>å…‰ç›˜ç±»çš„æ–‡ä»¶ç³»ç»ŸISO9660</li><li>MACä¸Šçš„æ··åˆæ–‡ä»¶ç³»ç»ŸHFS</li><li>ç½‘ç»œæ–‡ä»¶ç³»ç»ŸNFS</li><li>Oracleç ”å‘çš„btrfs</li><li>è¿˜æœ‰è€å¼çš„FAT/FAT32ç­‰ã€‚</li></ul><h3 id="1-æ–‡ä»¶ç³»ç»Ÿçš„ç»„æˆéƒ¨åˆ†">1.æ–‡ä»¶ç³»ç»Ÿçš„ç»„æˆéƒ¨åˆ†</h3><h4 id="1-1-blockçš„å‡ºç°">1.1 blockçš„å‡ºç°</h4><p>ç¡¬ç›˜æœ€åº•å±‚çš„è¯»å†™IOä¸€æ¬¡æ˜¯ä¸€ä¸ªæ‰‡åŒº512å­—èŠ‚ï¼Œå¦‚æœè¦è¯»å†™å¤§é‡æ–‡ä»¶ï¼Œä»¥æ‰‡åŒºä¸ºå•ä½è‚¯å®šå¾ˆæ…¢å¾ˆæ¶ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥ç¡¬ç›˜ä½¿ç”¨äº†ä¸€ä¸ªç§°ä½œé€»è¾‘å—çš„æ¦‚å¿µã€‚é€»è¾‘å—æ˜¯é€»è¾‘çš„ï¼Œç”±ç£ç›˜é©±åŠ¨å™¨è´Ÿè´£ç»´æŠ¤å’Œæ“ä½œï¼Œå®ƒå¹¶éæ˜¯åƒæ‰‡åŒºä¸€æ ·ç‰©ç†åˆ’åˆ†çš„ã€‚ä¸€ä¸ªé€»è¾‘å—çš„å¤§å°å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ‰‡åŒºï¼Œæ¯ä¸ªé€»è¾‘å—éƒ½æœ‰å”¯ä¸€çš„åœ°å€ï¼Œç§°ä¸ºLBAã€(Logical Block Addressing)é€»è¾‘å—å¯»å€æ¨¡å¼ã€‘ã€‚æœ‰äº†é€»è¾‘å—ä¹‹åï¼Œç£ç›˜æ§åˆ¶å™¨å¯¹æ•°æ®çš„æ“ä½œå°±ä»¥é€»è¾‘å—ä¸ºå•ä½ï¼Œä¸€æ¬¡è¯»å†™ä¸€ä¸ªé€»è¾‘å—ï¼Œç£ç›˜æ§åˆ¶å™¨çŸ¥é“å¦‚ä½•å°†é€»è¾‘å—ç¿»è¯‘æˆå¯¹åº”çš„æ‰‡åŒºå¹¶è¯»å†™æ•°æ®ã€‚</p><p>åˆ°äº†Linuxæ“ä½œç³»ç»Ÿå±‚æ¬¡ï¼Œé€šè¿‡æ–‡ä»¶ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªä¹Ÿç§°ä¸ºå—çš„è¯»å†™å•å…ƒï¼Œæ–‡ä»¶ç³»ç»Ÿæ•°æ®å—çš„å¤§å°ä¸€èˆ¬ä¸º1024bytes(1K)æˆ–2048bytes(2K)æˆ–4096bytes(4K)ã€‚æ–‡ä»¶ç³»ç»Ÿæ•°æ®å—ä¹Ÿæ˜¯é€»è¾‘æ¦‚å¿µï¼Œæ˜¯æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»´æŠ¤çš„ï¼Œè€Œç£ç›˜ä¸Šçš„é€»è¾‘æ•°æ®å—æ˜¯ç”±ç£ç›˜æ§åˆ¶å™¨ç»´æŠ¤çš„ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„IOç®¡ç†å™¨çŸ¥é“å¦‚ä½•å°†å®ƒçš„æ•°æ®å—ç¿»è¯‘æˆç£ç›˜ç»´æŠ¤çš„æ•°æ®å—åœ°å€LBAã€‚</p><p>å¯¹äºä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçš„IOæ“ä½œæ¥è¯´ï¼Œæ¯”å¦‚è¯»å†™æ–‡ä»¶ï¼Œè¿™äº›IOçš„åŸºæœ¬å•å…ƒæ˜¯æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ•°æ®å—ï¼Œä¸€æ¬¡è¯»å†™ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ•°æ®å—ã€‚æ¯”å¦‚éœ€è¦è¯»ä¸€ä¸ªæˆ–å¤šä¸ªå—æ—¶ï¼Œ<strong>æ–‡ä»¶ç³»ç»Ÿçš„IOç®¡ç†å™¨é¦–å…ˆè®¡ç®—è¿™äº›æ–‡ä»¶ç³»ç»Ÿå—å¯¹åº”åœ¨å“ªäº›ç£ç›˜æ•°æ®å—ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—å‡ºLBAï¼Œç„¶åé€šçŸ¥ç£ç›˜æ§åˆ¶å™¨è¦è¯»å–å“ªäº›å—çš„æ•°æ®ï¼Œç¡¬ç›˜æ§åˆ¶å™¨å°†è¿™äº›å—ç¿»è¯‘æˆæ‰‡åŒºåœ°å€ï¼Œç„¶åä»æ‰‡åŒºä¸­è¯»å–æ•°æ®ï¼Œå†é€šè¿‡ç¡¬ç›˜æ§åˆ¶å™¨å°†è¿™äº›æ‰‡åŒºæ•°æ®é‡ç»„å†™å…¥åˆ°å†…å­˜ä¸­å»</strong>ã€‚</p><p>æ­£å¦‚æ ‡é¢˜æ‰€ç¤ºï¼Œæœ¬æ–‡é‡ç‚¹æ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿè€Œä¸æ˜¯åœ¨ç£ç›˜ï¼Œæ‰€ä»¥<strong>åæ–‡å‡ºç°çš„blockå‡è¡¨ç¤ºçš„æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®å—</strong>è€Œä¸æ˜¯ç£ç›˜ç»´æŠ¤çš„é€»è¾‘å—ã€‚</p><p>æ–‡ä»¶ç³»ç»Ÿblockçš„å‡ºç°ä½¿å¾—åœ¨æ–‡ä»¶ç³»ç»Ÿå±‚é¢ä¸Šè¯»å†™æ€§èƒ½å¤§å¤§æé«˜ï¼Œä¹Ÿå¤§é‡å‡å°‘äº†ç¢ç‰‡ã€‚ä½†æ˜¯å®ƒçš„å‰¯ä½œç”¨æ˜¯å¯èƒ½é€ æˆç©ºé—´æµªè´¹ã€‚ç”±äºæ–‡ä»¶ç³»ç»Ÿä»¥blockä¸ºè¯»å†™å•å…ƒï¼Œå³ä½¿å­˜å‚¨çš„æ–‡ä»¶åªæœ‰1Kå¤§å°ä¹Ÿå°†å ç”¨ä¸€ä¸ªblockï¼Œå‰©ä½™çš„ç©ºé—´å®Œå…¨æ˜¯æµªè´¹çš„ã€‚</p><h4 id="1-2-inodeçš„å‡ºç°">1.2 inodeçš„å‡ºç°</h4><p>é—®é¢˜1ï¼šå¦‚æœä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå ç”¨å¤§é‡çš„blockè¯»å–æ—¶ä¼šå¦‚ä½•ï¼Ÿ</p><p>å‡å¦‚blockå¤§å°ä¸º1KBï¼Œä»…ä»…å­˜å‚¨ä¸€ä¸ª10Mçš„æ–‡ä»¶å°±éœ€è¦10240ä¸ªblockï¼Œè€Œä¸”è¿™äº›blockså¾ˆå¯èƒ½åœ¨ä½ç½®ä¸Šæ˜¯ä¸è¿ç»­åœ¨ä¸€èµ·çš„(ä¸ç›¸é‚»)ï¼Œè¯»å–è¯¥æ–‡ä»¶æ—¶éš¾é“è¦ä»å‰å‘åæ‰«ææ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å—ï¼Œç„¶åæ‰¾å‡ºå±äºè¯¥æ–‡ä»¶çš„å—å—?æ˜¾ç„¶æ˜¯ä¸åº”è¯¥è¿™ä¹ˆåšçš„ï¼Œå› ä¸ºå¤ªæ…¢å¤ªå‚»ç“œå¼äº†ã€‚</p><p>é—®é¢˜2ï¼šå¦‚æœä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå ç”¨å°‘é‡çš„blockè¯»å–æ—¶ä¼šå¦‚ä½•ï¼Ÿ</p><p>å‡è®¾è¯»å–ä¸€ä¸ªåªå ç”¨1ä¸ªblockçš„æ–‡ä»¶ï¼Œéš¾é“åªè¯»å–ä¸€ä¸ªblockå°±ç»“æŸäº†å—?å¹¶ä¸æ˜¯ï¼Œä»ç„¶æ˜¯æ‰«ææ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰blockï¼Œå› ä¸ºå®ƒä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰«æåˆ°ï¼Œæ‰«æåˆ°äº†å®ƒä¹Ÿä¸çŸ¥é“è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸æ˜¯å·²ç»å®Œæ•´è€Œä¸éœ€è¦å†æ‰«æå…¶ä»–çš„blockã€‚</p><p>é—®é¢˜3ï¼šæ–‡ä»¶åçš„å…ƒæ•°æ®å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p><p>â€¦</p><p>å¯¹äºç±»ä¼¼é—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯ä½¿ç”¨ç´¢å¼•ï¼Œå› ä¸ºé€šè¿‡æ‰«æç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„æ•°æ®ï¼Œè€Œä¸”ç´¢å¼•å¯ä»¥å­˜å‚¨éƒ¨åˆ†æ•°æ®ã€‚</p><p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šç´¢å¼•æŠ€æœ¯å…·ä½“åŒ–ä¸ºç´¢å¼•èŠ‚ç‚¹(index node)ï¼Œåœ¨ç´¢å¼•èŠ‚ç‚¹ä¸Šå­˜å‚¨çš„éƒ¨åˆ†æ•°æ®å³ä¸ºæ–‡ä»¶çš„å±æ€§å…ƒæ•°æ®åŠå…¶ä»–å°‘é‡ä¿¡æ¯ã€‚ä¸€èˆ¬æ¥è¯´ç´¢å¼•å ç”¨çš„ç©ºé—´ç›¸æ¯”å…¶ç´¢å¼•çš„æ–‡ä»¶æ•°æ®è€Œè¨€å ç”¨çš„ç©ºé—´å°±å°å¾—å¤šï¼Œæ‰«æå®ƒæ¯”æ‰«ææ•´ä¸ªæ•°æ®è¦å¿«å¾—å¤šï¼Œå¦åˆ™ç´¢å¼•å°±æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰ã€‚è¿™æ ·ä¸€æ¥å°±è§£å†³äº†å‰é¢æ‰€æœ‰çš„é—®é¢˜ã€‚</p><p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æœ¯è¯­ä¸­ï¼Œç´¢å¼•èŠ‚ç‚¹ç§°ä¸ºinodeã€‚åœ¨inodeä¸­å­˜å‚¨äº†inodeå·ã€æ–‡ä»¶ç±»å‹ã€æƒé™ã€æ–‡ä»¶æ‰€æœ‰è€…ã€å¤§å°ã€æ—¶é—´æˆ³ç­‰å…ƒæ•°æ®ä¿¡æ¯ï¼Œæœ€é‡è¦çš„æ˜¯è¿˜å­˜å‚¨äº†æŒ‡å‘å±äºè¯¥æ–‡ä»¶blockçš„æŒ‡é’ˆï¼Œè¿™æ ·<strong>è¯»å–inodeå°±å¯ä»¥æ‰¾åˆ°å±äºè¯¥æ–‡ä»¶çš„block</strong>ï¼Œè¿›è€Œè¯»å–è¿™äº›blockå¹¶è·å¾—è¯¥æ–‡ä»¶çš„æ•°æ®ã€‚ä¸ºäº†æ–¹ä¾¿ç§°å‘¼å’ŒåŒºåˆ†ï¼Œæš‚ä¸”å°†è¿™ä¸ªinodeè®°å½•ä¸­æŒ‡å‘æ–‡ä»¶data blockçš„æŒ‡é’ˆç§°ä¹‹ä¸ºblockæŒ‡é’ˆã€‚</p><p>ä»¥ä¸‹æ˜¯ext2æ–‡ä»¶ç³»ç»Ÿä¸­inodeåŒ…å«çš„ä¿¡æ¯ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Inode: 12 Type: regular Mode: 0644 Flags: 0x0 </span><br><span class="line">Generation: 1454951771 Version: 0x00000000:00000001 </span><br><span class="line">User: 0 Group: 0 Size: 5 </span><br><span class="line">File ACL: 0 Directory ACL: 0 </span><br><span class="line">Links: 1 Blockcount: 8 </span><br><span class="line">Fragment: Address: 0 Number: 0 Size: 0 </span><br><span class="line"> ctime: 0x5b628db2:15e0aff4 -- Thu Aug 2 12:50:58 2018 </span><br><span class="line"> atime: 0x5b628db2:15e0aff4 -- Thu Aug 2 12:50:58 2018 </span><br><span class="line"> mtime: 0x5b628db2:15e0aff4 -- Thu Aug 2 12:50:58 2018 </span><br><span class="line">crtime: 0x5b628db2:15e0aff4 -- Thu Aug 2 12:50:58 2018 </span><br><span class="line">Size of extra inode fields: 28 </span><br><span class="line">BLOCKS: </span><br><span class="line">(0):1024 </span><br><span class="line">TOTAL: 1 </span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬inodeå¤§å°ä¸º128å­—èŠ‚æˆ–256å­—èŠ‚ï¼Œç›¸æ¯”é‚£äº›MBæˆ–GBè®¡ç®—çš„æ–‡ä»¶æ•°æ®è€Œè¨€å°å¾—å¤šçš„å¤šï¼Œä½†ä¹Ÿè¦çŸ¥é“å¯èƒ½ä¸€ä¸ªæ–‡ä»¶å¤§å°å°äºinodeå¤§å°ï¼Œä¾‹å¦‚åªå ç”¨1ä¸ªå­—èŠ‚çš„æ–‡ä»¶ã€‚</p><h4 id="1-3-bmapå‡ºç°">1.3 bmapå‡ºç°</h4><p>åœ¨å‘ç¡¬ç›˜å­˜å‚¨æ•°æ®æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿéœ€è¦çŸ¥é“å“ªäº›å—æ˜¯ç©ºé—²çš„ï¼Œå“ªäº›å—æ˜¯å·²ç»å ç”¨äº†çš„ã€‚æœ€ç¬¨çš„æ–¹æ³•å½“ç„¶æ˜¯ä»å‰å‘åæ‰«æï¼Œé‡åˆ°ç©ºé—²å—å°±å­˜å‚¨ä¸€éƒ¨åˆ†ï¼Œç»§ç»­æ‰«æç›´åˆ°å­˜å‚¨å®Œæ‰€æœ‰æ•°æ®ã€‚</p><blockquote><p>è§£é‡Šï¼šç©ºé—²çš„å«ä¹‰</p></blockquote><p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œâ€œç©ºé—²å—â€ æŒ‡çš„æ˜¯å°šæœªè¢«ä»»ä½•æ–‡ä»¶æˆ–æ•°æ®å ç”¨çš„ç£ç›˜å—ã€‚æ–‡ä»¶ç³»ç»Ÿéœ€è¦ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨æˆ–è€…ä½å›¾æ¥è®°å½•å“ªäº›ç£ç›˜å—æ˜¯ç©ºé—²çš„ï¼Œä»¥åŠå“ªäº›ç£ç›˜å—å·²ç»è¢«æ–‡ä»¶æˆ–è€…æ•°æ®å ç”¨äº†ã€‚è¿™æ ·çš„ä¿¡æ¯å¯ä»¥å¸®åŠ©æ–‡ä»¶ç³»ç»Ÿæœ‰æ•ˆåœ°ç®¡ç†ç£ç›˜ç©ºé—´ï¼Œç¡®ä¿æ•°æ®çš„å­˜å‚¨å’Œæ£€ç´¢æ“ä½œèƒ½å¤Ÿæ­£å¸¸è¿›è¡Œã€‚</p><p>å½“æ–‡ä»¶ç³»ç»Ÿéœ€è¦ä¸ºæ–°æ–‡ä»¶æˆ–è€…æ•°æ®åˆ†é…å­˜å‚¨ç©ºé—´æ—¶ï¼Œå®ƒä¼šæŸ¥æ‰¾ç©ºé—²å—åˆ—è¡¨æˆ–è€…ä½å›¾ï¼Œæ‰¾åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªç©ºé—²çš„ç£ç›˜å—ï¼Œå¹¶å°†å®ƒä»¬æ ‡è®°ä¸ºå·²ç»è¢«å ç”¨ã€‚ç›¸åï¼Œå½“æ–‡ä»¶æˆ–è€…æ•°æ®è¢«åˆ é™¤æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šå°†å¯¹åº”çš„ç£ç›˜å—æ ‡è®°ä¸ºç©ºé—²ï¼Œä»¥ä¾¿åç»­è¢«é‡ç”¨ã€‚</p><p>é€šè¿‡ç»´æŠ¤ç©ºé—²å—åˆ—è¡¨æˆ–è€…ä½å›¾ï¼Œæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å®ç°å¯¹ç£ç›˜ç©ºé—´çš„åŠ¨æ€ç®¡ç†ï¼Œç¡®ä¿ç£ç›˜ç©ºé—´çš„é«˜æ•ˆåˆ©ç”¨ã€‚</p><hr><p>ä¼˜åŒ–çš„æ–¹æ³•å½“ç„¶ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ç´¢å¼•ï¼Œä½†æ˜¯ä»…ä»…1Gçš„æ–‡ä»¶ç³»ç»Ÿå°±æœ‰1KBçš„blockå…±1024*1024=1048576ä¸ªã€1G/1Kã€‘ï¼Œè¿™ä»…ä»…åªæ˜¯1Gï¼Œå¦‚æœæ˜¯100Gã€500Gç”šè‡³æ›´å¤§å‘¢ï¼Œä»…ä»…ä½¿ç”¨ç´¢å¼•ç´¢å¼•çš„æ•°é‡å’Œç©ºé—´å ç”¨ä¹Ÿå°†æå¤§ï¼Œè¿™æ—¶å°±å‡ºç°æ›´é«˜ä¸€çº§çš„ä¼˜åŒ–æ–¹æ³•ï¼šä½¿ç”¨å—ä½å›¾(bitmapç®€ç§°bmap)ã€‚</p><p>ä½å›¾åªä½¿ç”¨0å’Œ1æ ‡è¯†å¯¹åº”blockæ˜¯ç©ºé—²è¿˜æ˜¯è¢«å ç”¨ï¼Œ0å’Œ1åœ¨ä½å›¾ä¸­çš„ä½ç½®å’Œblockçš„ä½ç½®ä¸€ä¸€å¯¹åº”ï¼Œç¬¬ä¸€ä½æ ‡è¯†ç¬¬ä¸€ä¸ªå—ï¼Œç¬¬äºŒä¸ªä½æ ‡è¯†ç¬¬äºŒä¸ªå—ï¼Œä¾æ¬¡ä¸‹å»ç›´åˆ°æ ‡è®°å®Œæ‰€æœ‰çš„blockã€‚</p><p>æ€è€ƒï¼šä¸ºä»€ä¹ˆå—ä½å›¾æ›´ä¼˜åŒ–ï¼Ÿ</p><p>åœ¨ä½å›¾ä¸­1ä¸ªå­—èŠ‚8ä¸ªä½ï¼Œå¯ä»¥æ ‡è¯†8ä¸ªblockã€‚å¯¹äºä¸€ä¸ªblockå¤§å°ä¸º1KBã€å®¹é‡ä¸º1Gçš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€ï¼Œblockæ•°é‡æœ‰1024 * 1024ä¸ªï¼Œæ‰€ä»¥åœ¨ä½å›¾ä¸­ä½¿ç”¨1024 * 1024ä¸ªä½å…±1024 * 1024/8=131072å­—èŠ‚=128Kï¼Œå³1Gçš„æ–‡ä»¶åªéœ€è¦128ä¸ªblockåšä½å›¾å°±èƒ½å®Œæˆä¸€ä¸€å¯¹åº”ã€‚é€šè¿‡æ‰«æè¿™100å¤šä¸ªblockå°±èƒ½çŸ¥é“å“ªäº›blockæ˜¯ç©ºé—²çš„ï¼Œé€Ÿåº¦æé«˜äº†éå¸¸å¤šã€‚</p><p>ä½†æ˜¯è¦æ³¨æ„ï¼Œ<strong>bmapçš„ä¼˜åŒ–é’ˆå¯¹çš„æ˜¯å†™ä¼˜åŒ–</strong>ï¼Œå› ä¸ºåªæœ‰å†™æ‰éœ€è¦æ‰¾åˆ°ç©ºé—²blockå¹¶åˆ†é…ç©ºé—²blockã€‚å¯¹äºè¯»è€Œè¨€ï¼Œåªè¦é€šè¿‡inodeæ‰¾åˆ°äº†blockçš„ä½ç½®ï¼Œcpuå°±èƒ½è¿…é€Ÿè®¡ç®—å‡ºblockåœ¨ç‰©ç†ç£ç›˜ä¸Šçš„åœ°å€ï¼Œcpuçš„è®¡ç®—é€Ÿåº¦æ˜¯æå¿«çš„ï¼Œè®¡ç®—blockåœ°å€çš„æ—¶é—´å‡ ä¹å¯ä»¥å¿½ç•¥ï¼Œé‚£ä¹ˆè¯»é€Ÿåº¦åŸºæœ¬è®¤ä¸ºæ˜¯å—ç¡¬ç›˜æœ¬èº«æ€§èƒ½çš„å½±å“è€Œä¸æ–‡ä»¶ç³»ç»Ÿæ— å…³ã€‚å¤§å¤šæ•°ç¨å¤§ä¸€ç‚¹çš„æ–‡ä»¶å¯èƒ½éƒ½ä¼šå­˜å‚¨åœ¨ä¸è¿ç»­çš„blockä¸Šï¼Œè€Œä¸”ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´çš„æ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä¼šæœ‰ä¸å°‘ç¢ç‰‡ï¼Œè¿™æ—¶ç¡¬ç›˜çš„éšæœºè¯»å–æ€§èƒ½ç›´æ¥å†³å®šè¯»æ•°æ®çš„é€Ÿåº¦ï¼Œè¿™ä¹Ÿæ˜¯æœºæ¢°ç¡¬ç›˜é€Ÿåº¦ç›¸æ¯”å›ºæ€ç¡¬ç›˜æ…¢çš„å¤šçš„å¤šçš„åŸå› ä¹‹ä¸€ï¼Œè€Œä¸”å›ºæ€ç¡¬ç›˜çš„éšæœºè¯»å’Œè¿ç»­è¯»å–é€Ÿåº¦å‡ ä¹æ˜¯ä¸€è‡´çš„ï¼Œå¯¹å®ƒæ¥è¯´ï¼Œæ–‡ä»¶ç³»ç»Ÿç¢ç‰‡çš„å¤šå°‘å¹¶ä¸ä¼šå½±å“è¯»å–é€Ÿåº¦ã€‚</p><p>è™½ç„¶bmapå·²ç»æå¤§çš„ä¼˜åŒ–äº†æ‰«æï¼Œä½†æ˜¯ä»æœ‰å…¶ç“¶é¢ˆï¼šå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ˜¯100Gå‘¢?</p><p>100Gçš„æ–‡ä»¶ç³»ç»Ÿè¦ä½¿ç”¨128*100=12800ä¸ª1KBå¤§å°çš„blockï¼Œè¿™å°±å ç”¨äº†12.5Mçš„ç©ºé—´äº†ã€‚è¯•æƒ³å®Œå…¨æ‰«æ12800ä¸ªå¾ˆå¯èƒ½ä¸è¿ç»­çš„blockè¿™ä¹Ÿæ˜¯éœ€è¦å ç”¨ä¸€äº›æ—¶é—´çš„ï¼Œè™½ç„¶å¿«ä½†æ˜¯æ‰›ä¸ä½æ¯æ¬¡å­˜å‚¨æ–‡ä»¶éƒ½è¦æ‰«æå¸¦æ¥çš„å·¨å¤§å¼€é”€ã€‚</p><p>æ‰€ä»¥éœ€è¦å†æ¬¡ä¼˜åŒ–ï¼Œå¦‚ä½•ä¼˜åŒ–?ç®€è€Œè¨€ä¹‹å°±æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†å¼€å½¢æˆå—ç»„ï¼Œè‡³äºå—ç»„çš„ä»‹ç»æ”¾åœ¨åæ–‡ã€‚</p><h4 id="1-4-inodeè¡¨çš„å‡ºç°">1.4 inodeè¡¨çš„å‡ºç°</h4><p>å›é¡¾ä¸‹inodeç›¸å…³ä¿¡æ¯ï¼šinodeå­˜å‚¨äº†inodeå·ã€æ–‡ä»¶å±æ€§å…ƒæ•°æ®ã€æŒ‡å‘æ–‡ä»¶å ç”¨çš„blockçš„æŒ‡é’ˆ;<strong>æ¯ä¸€ä¸ªinodeå ç”¨128å­—èŠ‚æˆ–256å­—èŠ‚ã€‚</strong></p><p>ç°åœ¨åˆå‡ºç°é—®é¢˜äº†ï¼Œä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­å¯ä»¥è¯´æœ‰æ— æ•°å¤šä¸ªæ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶éƒ½å¯¹åº”ä¸€ä¸ªinodeï¼Œéš¾é“æ¯ä¸€ä¸ªä»…128å­—èŠ‚çš„inodeéƒ½è¦å•ç‹¬å ç”¨ä¸€ä¸ªblockè¿›è¡Œå­˜å‚¨å—?è¿™å¤ªæµªè´¹ç©ºé—´äº†ã€‚</p><p>æ‰€ä»¥æ›´ä¼˜çš„æ–¹æ³•æ˜¯å°†å¤šä¸ªinodeåˆå¹¶å­˜å‚¨åœ¨blockä¸­ï¼Œå¯¹äº128å­—èŠ‚çš„inodeï¼Œä¸€ä¸ªblockå­˜å‚¨8ã€1K/128Bã€‘ä¸ªinodeï¼Œå¯¹äº256å­—èŠ‚çš„inodeï¼Œä¸€ä¸ªblockå­˜å‚¨4ä¸ªinodeã€‚è¿™å°±ä½¿å¾—æ¯ä¸ªå­˜å‚¨inodeçš„å—éƒ½ä¸æµªè´¹ã€‚</p><p>åœ¨extæ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œå°†è¿™äº›ç‰©ç†ä¸Šå­˜å‚¨inodeçš„blockç»„åˆèµ·æ¥ï¼Œåœ¨é€»è¾‘ä¸Šå½¢æˆä¸€å¼ inodeè¡¨(inode table)æ¥è®°å½•æ‰€æœ‰çš„inodeã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯ä¸€ä¸ªå®¶åº­éƒ½è¦å‘æ´¾å‡ºæ‰€ç™»è®°æˆ·å£ä¿¡æ¯ï¼Œé€šè¿‡æˆ·å£æœ¬å¯ä»¥çŸ¥é“å®¶åº­ä½å€ï¼Œè€Œæ¯ä¸ªé•‡æˆ–è¡—é“çš„æ´¾å‡ºæ‰€å°†æœ¬é•‡æˆ–æœ¬è¡—é“çš„æ‰€æœ‰æˆ·å£æ•´åˆåœ¨ä¸€èµ·ï¼Œè¦æŸ¥æ‰¾æŸä¸€æˆ·åœ°å€æ—¶ï¼Œåœ¨æ´¾å‡ºæ‰€å°±èƒ½å¿«é€ŸæŸ¥æ‰¾åˆ°ã€‚inode tableå°±æ˜¯è¿™é‡Œçš„æ´¾å‡ºæ‰€ã€‚å®ƒçš„å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425201144640.png" alt=""></p><p>å®é™…ä¸Šï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºå®Œæˆåæ‰€æœ‰çš„inodeå·éƒ½å·²ç»åˆ†é…å¥½å¹¶è®°å½•åˆ°inode tableä¸­äº†ï¼Œåªä¸è¿‡è¢«ä½¿ç”¨çš„inodeå·æ‰€åœ¨çš„è¡Œè¿˜æœ‰æ–‡ä»¶å±æ€§çš„å…ƒæ•°æ®ä¿¡æ¯å’Œblockä½ç½®ä¿¡æ¯ï¼Œè€Œæœªè¢«ä½¿ç”¨çš„inodeå·åªæœ‰ä¸€ä¸ªinodeå·è€Œå·²è€Œæ²¡æœ‰å…¶ä»–ä¿¡æ¯è€Œå·²ã€‚</p><p>å†ç»†ç»†ä¸€æ€è€ƒï¼Œå°±èƒ½å‘ç°ä¸€ä¸ªå¤§çš„æ–‡ä»¶ç³»ç»Ÿä»å°†å ç”¨å¤§é‡çš„å—æ¥å­˜å‚¨inodeï¼Œæƒ³è¦æ‰¾åˆ°å…¶ä¸­çš„ä¸€ä¸ªinodeè®°å½•ä¹Ÿéœ€è¦ä¸å°çš„å¼€é”€ï¼Œå°½ç®¡å®ƒä»¬å·²ç»å½¢æˆäº†ä¸€å¼ é€»è¾‘ä¸Šçš„è¡¨ï¼Œä½†æ‰›ä¸ä½è¡¨å¤ªå¤§è®°å½•å¤ªå¤šã€‚é‚£ä¹ˆå¦‚ä½•å¿«é€Ÿæ‰¾åˆ°inodeï¼Œè¿™åŒæ ·æ˜¯éœ€è¦ä¼˜åŒ–çš„ï¼Œä¼˜åŒ–çš„æ–¹æ³•æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿçš„blockè¿›è¡Œåˆ†ç»„åˆ’åˆ†ï¼Œæ¯ä¸ªç»„ä¸­éƒ½å­˜æœ‰æœ¬ç»„inode tableèŒƒå›´ã€bmapç­‰ã€‚</p><h4 id="1-5-imapçš„å‡ºç°">1.5 imapçš„å‡ºç°</h4><p>å‰é¢è¯´bmapæ˜¯å—ä½å›¾ï¼Œç”¨äºæ ‡è¯†æ–‡ä»¶ç³»ç»Ÿä¸­å“ªäº›blockæ˜¯ç©ºé—²å“ªäº›blockæ˜¯å ç”¨çš„ã€‚</p><p>å¯¹äºinodeä¹Ÿä¸€æ ·ï¼Œåœ¨å­˜å‚¨æ–‡ä»¶(Linuxä¸­ä¸€åˆ‡çš†æ–‡ä»¶)æ—¶éœ€è¦ä¸ºå…¶åˆ†é…ä¸€ä¸ªinodeå·ã€‚ä½†æ˜¯åœ¨æ ¼å¼åŒ–åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿåæ‰€æœ‰çš„inodeå·éƒ½æ˜¯è¢«äº‹å…ˆè®¾å®šå¥½å­˜æ”¾åœ¨inode tableä¸­çš„ï¼Œå› æ­¤äº§ç”Ÿäº†é—®é¢˜ï¼šè¦ä¸ºæ–‡ä»¶åˆ†é…å“ªä¸€ä¸ªinodeå·å‘¢?åˆå¦‚ä½•çŸ¥é“æŸä¸€ä¸ªinodeå·æ˜¯å¦å·²ç»è¢«åˆ†é…äº†å‘¢?</p><p>æ—¢ç„¶æ˜¯&quot;æ˜¯å¦è¢«å ç”¨&quot;çš„é—®é¢˜ï¼Œä½¿ç”¨ä½å›¾æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œåƒbmapè®°å½•blockçš„å ç”¨æƒ…å†µä¸€æ ·ã€‚æ ‡è¯†inodeå·æ˜¯å¦è¢«åˆ†é…çš„ä½å›¾ç§°ä¸ºinodemapç®€ç§°ä¸ºimapã€‚è¿™æ—¶è¦ä¸ºä¸€ä¸ªæ–‡ä»¶åˆ†é…inodeå·åªéœ€æ‰«æimapå³å¯çŸ¥é“å“ªä¸€ä¸ªinodeå·æ˜¯ç©ºé—²çš„ã€‚</p><p>imapå­˜åœ¨ç€å’Œbmapå’Œinode tableä¸€æ ·éœ€è¦è§£å†³çš„é—®é¢˜ï¼šå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ¯”è¾ƒå¤§ï¼Œimapæœ¬èº«å°±ä¼šå¾ˆå¤§ï¼Œæ¯æ¬¡å­˜å‚¨æ–‡ä»¶éƒ½è¦è¿›è¡Œæ‰«æï¼Œä¼šå¯¼è‡´æ•ˆç‡ä¸å¤Ÿé«˜ã€‚åŒæ ·ï¼Œä¼˜åŒ–çš„æ–¹å¼æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿå ç”¨çš„blockåˆ’åˆ†æˆå—ç»„ï¼Œæ¯ä¸ªå—ç»„æœ‰è‡ªå·±çš„imapèŒƒå›´ã€‚</p><h4 id="1-6-å—ç»„çš„å‡ºç°">1.6 å—ç»„çš„å‡ºç°</h4><p>å‰é¢ä¸€ç›´æåˆ°çš„ä¼˜åŒ–æ–¹æ³•æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿå ç”¨çš„blockåˆ’åˆ†æˆå—ç»„(block group)ï¼Œè§£å†³bmapã€inode tableå’Œimapå¤ªå¤§çš„é—®é¢˜ã€‚</p><p>åœ¨ç‰©ç†å±‚é¢ä¸Šçš„åˆ’åˆ†æ˜¯å°†ç£ç›˜æŒ‰æŸ±é¢åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼Œå³å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚åœ¨é€»è¾‘å±‚é¢ä¸Šçš„åˆ’åˆ†æ˜¯å°†æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†æˆå—ç»„ã€‚<strong>æ¯ä¸ªæ–‡ä»¶ç³»ç»ŸåŒ…å«å¤šä¸ªå—ç»„ï¼Œæ¯ä¸ªå—ç»„åŒ…å«å¤šä¸ªå…ƒæ•°æ®åŒºå’Œæ•°æ®åŒº</strong>ã€çœ‹ä¸‹èŠ‚çš„å›¾ã€‘ï¼š</p><ul><li>å…ƒæ•°æ®åŒºå°±æ˜¯å­˜å‚¨bmapã€inode tableã€imapç­‰çš„æ•°æ®;</li><li>æ•°æ®åŒºå°±æ˜¯å­˜å‚¨æ–‡ä»¶æ•°æ®çš„åŒºåŸŸã€‚</li></ul><p>æ³¨æ„å—ç»„æ˜¯é€»è¾‘å±‚é¢çš„æ¦‚å¿µï¼Œæ‰€ä»¥å¹¶ä¸ä¼šçœŸçš„åœ¨ç£ç›˜ä¸ŠæŒ‰æŸ±é¢ã€æŒ‰æ‰‡åŒºã€æŒ‰ç£é“ç­‰æ¦‚å¿µè¿›è¡Œåˆ’åˆ†ã€‚</p><h4 id="1-7-å—ç»„çš„åˆ’åˆ†">1.7 å—ç»„çš„åˆ’åˆ†</h4><p>å—ç»„åœ¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºå®Œæˆåå°±å·²ç»åˆ’åˆ†å®Œæˆäº†ï¼Œä¹Ÿå°±æ˜¯è¯´å…ƒæ•°æ®åŒºbmapã€inode tableå’Œimapç­‰ä¿¡æ¯å ç”¨çš„blockä»¥åŠæ•°æ®åŒºå ç”¨çš„blockéƒ½å·²ç»åˆ’åˆ†å¥½äº†ã€‚é‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿå¦‚ä½•çŸ¥é“ä¸€ä¸ªå—ç»„å…ƒæ•°æ®åŒºåŒ…å«å¤šå°‘ä¸ªblockï¼Œæ•°æ®åŒºåˆåŒ…å«å¤šå°‘blockå‘¢?</p><p>å®ƒåªéœ€ç¡®å®šä¸€ä¸ªæ•°æ®â€”â€”æ¯ä¸ªblockçš„å¤§å°ï¼Œå†æ ¹æ®bmapè‡³å¤šåªèƒ½å ç”¨ä¸€ä¸ªå®Œæ•´çš„blockçš„æ ‡å‡†å°±èƒ½è®¡ç®—å‡ºå—ç»„å¦‚ä½•åˆ’åˆ†ã€‚å¦‚æœæ–‡ä»¶ç³»ç»Ÿéå¸¸å°ï¼Œæ‰€æœ‰çš„bmapæ€»å…±éƒ½ä¸èƒ½å ç”¨å®Œä¸€ä¸ªblockï¼Œé‚£ä¹ˆä¹Ÿåªèƒ½ç©ºé—²bmapçš„blockäº†ã€‚</p><p>æ¯ä¸ªblockçš„å¤§å°åœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿæ—¶å¯ä»¥äººä¸ºæŒ‡å®šï¼Œä¸æŒ‡å®šä¹Ÿæœ‰é»˜è®¤å€¼ã€‚</p><p>å‡å¦‚ç°åœ¨blockçš„å¤§å°æ˜¯1KBï¼Œä¸€ä¸ªbmapå®Œæ•´å ç”¨ä¸€ä¸ªblockèƒ½æ ‡è¯†1024*8= 8192ä¸ªblock(å½“ç„¶è¿™8192ä¸ªblockæ˜¯æ•°æ®åŒºå’Œå…ƒæ•°æ®åŒºå…±8192ä¸ªï¼Œå› ä¸ºå…ƒæ•°æ®åŒºåˆ†é…çš„blockä¹Ÿéœ€è¦é€šè¿‡bmapæ¥æ ‡è¯†)ã€‚æ¯ä¸ªblockæ˜¯1Kï¼Œæ¯ä¸ªå—ç»„æ˜¯8192Kå³8Mï¼Œåˆ›å»º1Gçš„æ–‡ä»¶ç³»ç»Ÿéœ€è¦åˆ’åˆ†1024/8=128ä¸ªå—ç»„ï¼Œå¦‚æœæ˜¯1.1Gçš„æ–‡ä»¶ç³»ç»Ÿå‘¢?128+12.8=128+13=141ä¸ªå—ç»„ã€‚ã€ç»™å‡ºblockçš„å¤§å°ï¼Œå°±å¯ä»¥ä»æ–‡ä»¶å¤§å°è®¡ç®—å‡ºå¿«ç»„çš„ä¸ªæ•°ã€‘</p><p>æ¯ä¸ªç»„çš„blockæ•°ç›®æ˜¯åˆ’åˆ†å¥½äº†ï¼Œä½†æ˜¯æ¯ä¸ªç»„è®¾å®šå¤šå°‘ä¸ªinodeå·å‘¢?inode tableå ç”¨å¤šå°‘blockå‘¢?è¿™éœ€è¦ç”±ç³»ç»Ÿå†³å®šäº†ï¼Œå› ä¸ºæè¿°&quot;æ¯å¤šå°‘ä¸ªæ•°æ®åŒºçš„blockå°±ä¸ºå…¶åˆ†é…ä¸€ä¸ªinodeå·&quot;çš„æŒ‡æ ‡é»˜è®¤æ˜¯æˆ‘ä»¬ä¸çŸ¥é“çš„ï¼Œå½“ç„¶åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿæ—¶ä¹Ÿå¯ä»¥äººä¸ºæŒ‡å®šè¿™ä¸ªæŒ‡æ ‡æˆ–è€…ç™¾åˆ†æ¯”ä¾‹ã€‚è§åæ–‡&quot;inodeæ·±å…¥&quot;ã€‚</p><p>ä½¿ç”¨dumpe2fså¯ä»¥å°†extç±»çš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯å…¨éƒ¨æ˜¾ç¤ºå‡ºæ¥ï¼Œå½“ç„¶bmapæ˜¯æ¯ä¸ªå—ç»„å›ºå®šä¸€ä¸ªblockçš„ä¸ç”¨æ˜¾ç¤ºï¼Œimapæ¯”bmapæ›´å°æ‰€ä»¥ä¹Ÿåªå ç”¨1ä¸ªblockä¸ç”¨æ˜¾ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425215539679.png" alt="image-20240425215539679"></p><p>ä»è¿™å¼ è¡¨ä¸­èƒ½è®¡ç®—å‡ºæ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ï¼Œè¯¥æ–‡ä»¶ç³»ç»Ÿå…±4667136ä¸ªblocksï¼Œæ¯ä¸ªblockå¤§å°ä¸º4Kï¼Œæ‰€ä»¥æ–‡ä»¶ç³»ç»Ÿå¤§å°ä¸º4667136*4/1024/1024=17.8GBã€‚</p><p>ä¹Ÿèƒ½è®¡ç®—å‡ºåˆ†äº†å¤šå°‘ä¸ªå—ç»„ï¼Œå› ä¸ºæ¯ä¸€ä¸ªå—ç»„çš„blockæ•°é‡ä¸º32768ï¼Œæ‰€ä»¥å—ç»„çš„æ•°é‡ä¸º4667136/32768=142.4å³143ä¸ªå—ç»„ã€‚ç”±äºå—ç»„ä»0å¼€å§‹ç¼–å·ï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªå—ç»„ç¼–å·ä¸ºGroup 142ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºæ˜¯æœ€åä¸€ä¸ªå—ç»„çš„ä¿¡æ¯ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425215816389.png" alt="image-20240425215816389"></p><h3 id="2-æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´ç»“æ„">2. æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´ç»“æ„</h3><p>å°†ä¸Šæ–‡æè¿°çš„bmapã€inode tableã€imapã€æ•°æ®åŒºçš„blockså’Œå—ç»„çš„æ¦‚å¿µç»„åˆèµ·æ¥å°±å½¢æˆäº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå½“ç„¶è¿™è¿˜ä¸æ˜¯å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿã€‚å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿå¦‚ä¸‹å›¾</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425215902069.png" alt="image-20240425215902069"></p><p>é¦–å…ˆï¼Œè¯¥å›¾ä¸­å¤šäº†Boot Blockã€Super Blockã€GDTã€Reserver GDTè¿™å‡ ä¸ªæ¦‚å¿µã€‚ä¸‹é¢ä¼šåˆ†åˆ«ä»‹ç»å®ƒä»¬ã€‚</p><p>ç„¶åï¼Œå›¾ä¸­æŒ‡æ˜äº†å—ç»„ä¸­æ¯ä¸ªéƒ¨åˆ†å ç”¨çš„blockæ•°é‡ï¼Œé™¤äº†superblockã€bmapã€imapèƒ½ç¡®å®šå ç”¨1ä¸ªblockï¼Œå…¶ä»–çš„éƒ¨åˆ†éƒ½ä¸èƒ½ç¡®å®šå ç”¨å‡ ä¸ªblockã€‚</p><p>æœ€åï¼Œå›¾ä¸­æŒ‡æ˜äº†Superblockã€GDTå’ŒReserved GDTæ˜¯åŒæ—¶å‡ºç°ä¸”ä¸ä¸€å®šå­˜åœ¨äºæ¯ä¸€ä¸ªå—ç»„ä¸­çš„ï¼Œä¹ŸæŒ‡æ˜äº†bmapã€imapã€inode tableå’Œdata blocksæ˜¯æ¯ä¸ªå—ç»„éƒ½æœ‰çš„ã€‚</p><h4 id="2-1-å¼•å¯¼å—">2.1 å¼•å¯¼å—</h4><p>å³ä¸Šå›¾ä¸­çš„Boot Blockéƒ¨åˆ†ï¼Œä¹Ÿç§°ä¸ºboot sectorã€‚å®ƒä½äºåˆ†åŒºä¸Šçš„ç¬¬ä¸€ä¸ªå—ï¼Œå ç”¨1024å­—èŠ‚ï¼Œå¹¶éæ‰€æœ‰åˆ†åŒºéƒ½æœ‰è¿™ä¸ªboot sectorï¼Œåªæœ‰è£…äº†æ“ä½œç³»ç»Ÿçš„ä¸»åˆ†åŒºå’Œè£…äº†æ“ä½œç³»ç»Ÿçš„é€»è¾‘åˆ†åŒºæ‰æœ‰ã€‚é‡Œé¢å­˜æ”¾çš„ä¹Ÿæ˜¯boot loaderï¼Œè¿™æ®µboot loaderç§°ä¸ºVBR(ä¸»åˆ†åŒºè£…æ“ä½œç³»ç»Ÿæ—¶)æˆ–EBR(æ‰©å±•åˆ†åŒºè£…æ“ä½œç³»ç»Ÿæ—¶)ï¼Œè¿™é‡Œçš„Boot loaderå’Œmbrä¸Šçš„boot loaderæ˜¯å­˜åœ¨äº¤é”™å…³ç³»çš„ã€‚å¼€æœºå¯åŠ¨çš„æ—¶å€™ï¼Œé¦–å…ˆåŠ è½½mbrä¸­çš„bootloaderï¼Œç„¶åå®šä½åˆ°æ“ä½œç³»ç»Ÿæ‰€åœ¨åˆ†åŒºçš„boot serctorä¸ŠåŠ è½½æ­¤å¤„çš„boot loaderã€‚å¦‚æœæ˜¯å¤šç³»ç»Ÿï¼ŒåŠ è½½mbrä¸­çš„bootloaderåä¼šåˆ—å‡ºæ“ä½œç³»ç»Ÿèœå•ï¼Œèœå•ä¸Šçš„å„æ“ä½œç³»ç»ŸæŒ‡å‘å®ƒä»¬æ‰€åœ¨åˆ†åŒºçš„boot sectorä¸Šã€‚å®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425220833137.png" alt="image-20240425220833137"></p><p>ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼çš„æ“ä½œç³»ç»Ÿèœå•æ—©å·²ç»å¼ƒä¹‹ä¸ç”¨äº†ï¼Œè€Œæ˜¯ä½¿ç”¨grubæ¥ç®¡ç†å¯åŠ¨èœå•ã€‚å°½ç®¡å¦‚æ­¤ï¼Œåœ¨å®‰è£…æ“ä½œç³»ç»Ÿæ—¶ï¼Œä»ç„¶æœ‰ä¸€æ­¥æ˜¯é€‰æ‹©boot loaderå®‰è£…ä½ç½®çš„æ­¥éª¤ã€‚</p><h4 id="2-2-è¶…çº§å—-superblock">2.2 è¶…çº§å—(superblock)</h4><p>æ—¢ç„¶ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¼šåˆ†å¤šä¸ªå—ç»„ï¼Œ<strong>é‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿæ€ä¹ˆçŸ¥é“åˆ†äº†å¤šå°‘ä¸ªå—ç»„å‘¢?æ¯ä¸ªå—ç»„åˆæœ‰å¤šå°‘blockå¤šå°‘inodeå·ç­‰ç­‰ä¿¡æ¯å‘¢?è¿˜æœ‰ï¼Œæ–‡ä»¶ç³»ç»Ÿæœ¬èº«çš„å±æ€§ä¿¡æ¯å¦‚å„ç§æ—¶é—´æˆ³ã€blockæ€»æ•°é‡å’Œç©ºé—²æ•°é‡ã€inodeæ€»æ•°é‡å’Œç©ºé—²æ•°é‡ã€å½“å‰æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ­£å¸¸ã€ä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªæ£€ç­‰ç­‰ï¼Œå®ƒä»¬åˆå­˜å‚¨åœ¨å“ªé‡Œå‘¢?</strong></p><p>æ¯«æ— ç–‘é—®ï¼Œè¿™äº›ä¿¡æ¯å¿…é¡»è¦å­˜å‚¨åœ¨blockä¸­ã€‚å­˜å‚¨è¿™äº›ä¿¡æ¯å ç”¨1024å­—èŠ‚ï¼Œæ‰€ä»¥ä¹Ÿè¦ä¸€ä¸ªblockï¼Œ<strong>è¿™ä¸ªblockç§°ä¸ºè¶…çº§å—(superblock)</strong>ï¼Œå®ƒçš„blockå·å¯èƒ½ä¸º0ä¹Ÿå¯èƒ½ä¸º1ã€‚å¦‚æœblockå¤§å°ä¸º1Kï¼Œåˆ™å¼•å¯¼å—æ­£å¥½å ç”¨ä¸€ä¸ªblockï¼Œè¿™ä¸ªblockå·ä¸º0ï¼Œæ‰€ä»¥superblockçš„å·ä¸º1;å¦‚æœblockå¤§å°å¤§äº1Kï¼Œåˆ™å¼•å¯¼å—å’Œè¶…çº§å—åŒç½®åœ¨ä¸€ä¸ªblockä¸­ï¼Œè¿™ä¸ªblockå·ä¸º0ã€‚æ€»ä¹‹superblockçš„èµ·æ­¢ä½ç½®æ˜¯ç¬¬äºŒä¸ª1024(1024-2047)å­—èŠ‚ã€‚</p><p>ä½¿ç”¨dfå‘½ä»¤è¯»å–çš„å°±æ˜¯æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„superblockï¼Œæ‰€ä»¥å®ƒçš„ç»Ÿè®¡é€Ÿåº¦éå¸¸å¿«ã€‚ç›¸åï¼Œç”¨duå‘½ä»¤æŸ¥çœ‹ä¸€ä¸ªè¾ƒå¤§ç›®å½•çš„å·²ç”¨ç©ºé—´å°±éå¸¸æ…¢ï¼Œå› ä¸ºä¸å¯é¿å…åœ°è¦éå†æ•´ä¸ªç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -hT </span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">udev           devtmpfs  1.9G     0  1.9G   0% /dev</span><br><span class="line">tmpfs          tmpfs     388M  2.0M  386M   1% /run</span><br><span class="line">/dev/sda5      ext4       59G   43G   14G  77% /</span><br><span class="line">tmpfs          tmpfs     1.9G     0  1.9G   0% /dev/shm</span><br><span class="line">tmpfs          tmpfs     5.0M  4.0K  5.0M   1% /run/lock</span><br><span class="line">tmpfs          tmpfs     1.9G     0  1.9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/loop0     squashfs  128K  128K     0 100% /snap/bare/5</span><br><span class="line">/dev/loop2     squashfs   75M   75M     0 100% /snap/core22/1122</span><br><span class="line">/dev/loop1     squashfs   64M   64M     0 100% /snap/core20/2264</span><br></pre></td></tr></table></figure><p>superblockå¯¹äºæ–‡ä»¶ç³»ç»Ÿè€Œè¨€æ˜¯è‡³å…³é‡è¦çš„ï¼Œè¶…çº§å—ä¸¢å¤±æˆ–æŸåå¿…å°†å¯¼è‡´æ–‡ä»¶ç³»ç»Ÿçš„æŸåã€‚æ‰€ä»¥æ—§å¼çš„æ–‡ä»¶ç³»ç»Ÿå°†è¶…çº§å—å¤‡ä»½åˆ°æ¯ä¸€ä¸ªå—ç»„ä¸­ï¼Œä½†æ˜¯è¿™åˆæœ‰æ‰€ç©ºé—´æµªè´¹ï¼Œæ‰€ä»¥ext2æ–‡ä»¶ç³»ç»Ÿåªåœ¨å—ç»„0ã€1å’Œ3ã€5ã€7å¹‚æ¬¡æ–¹çš„å—ç»„ä¸­ä¿å­˜è¶…çº§å—çš„ä¿¡æ¯ï¼Œå¦‚Group9ã€Group25ç­‰ã€‚å°½ç®¡ä¿å­˜äº†è¿™ä¹ˆå¤šçš„superblockï¼Œä½†æ˜¯æ–‡ä»¶ç³»ç»Ÿåªä½¿ç”¨ç¬¬ä¸€ä¸ªå—ç»„å³Group0ä¸­è¶…çº§å—ä¿¡æ¯æ¥è·å–æ–‡ä»¶ç³»ç»Ÿå±æ€§ï¼Œåªæœ‰å½“Group0ä¸Šçš„superblockæŸåæˆ–ä¸¢å¤±æ‰ä¼šæ‰¾ä¸‹ä¸€ä¸ªå¤‡ä»½è¶…çº§å—å¤åˆ¶åˆ°Group0ä¸­æ¥æ¢å¤æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªext4æ–‡ä»¶ç³»ç»Ÿçš„superblockçš„ä¿¡æ¯ï¼Œextå®¶æ—çš„æ–‡ä»¶ç³»ç»Ÿéƒ½èƒ½ä½¿ç”¨dumpe2fs -hè·å–ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425221706736.png" alt="image-20240425221706736"></p><h4 id="2-3-å—ç»„æè¿°ç¬¦è¡¨-GDT">2.3 å—ç»„æè¿°ç¬¦è¡¨(GDT)</h4><p>æ—¢ç„¶æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†äº†å—ç»„ï¼Œé‚£ä¹ˆæ¯ä¸ªå—ç»„çš„ä¿¡æ¯å’Œå±æ€§å…ƒæ•°æ®åˆä¿å­˜åœ¨å“ªé‡Œå‘¢?</p><p><strong>extæ–‡ä»¶ç³»ç»Ÿæ¯ä¸€ä¸ªå—ç»„ä¿¡æ¯ä½¿ç”¨32å­—èŠ‚æè¿°ï¼Œè¿™32ä¸ªå­—èŠ‚ç§°ä¸ºå—ç»„æè¿°ç¬¦</strong>ï¼Œæ‰€æœ‰å—ç»„çš„å—ç»„æè¿°ç¬¦ç»„æˆå—ç»„æè¿°ç¬¦è¡¨GDT(group descriptor table)ã€‚</p><p>è™½ç„¶æ¯ä¸ªå—ç»„éƒ½éœ€è¦å—ç»„æè¿°ç¬¦æ¥è®°å½•å—ç»„çš„ä¿¡æ¯å’Œå±æ€§å…ƒæ•°æ®ï¼Œä½†æ˜¯ä¸æ˜¯æ¯ä¸ªå—ç»„ä¸­éƒ½å­˜æ”¾äº†å—ç»„æè¿°ç¬¦ã€‚<strong>extæ–‡ä»¶ç³»ç»Ÿçš„å­˜å‚¨æ–¹å¼æ˜¯ï¼šå°†å®ƒä»¬ç»„æˆä¸€ä¸ªGDTï¼Œå¹¶å°†è¯¥GDTå­˜æ”¾äºæŸäº›å—ç»„ä¸­ï¼Œå­˜æ”¾GDTçš„å—ç»„å’Œå­˜æ”¾superblockå’Œå¤‡ä»½superblockçš„å—ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬æ˜¯åŒæ—¶å‡ºç°åœ¨æŸä¸€ä¸ªå—ç»„ä¸­çš„ã€‚è¯»å–æ—¶ä¹Ÿæ€»æ˜¯è¯»å–Group0ä¸­çš„å—ç»„æè¿°ç¬¦è¡¨ä¿¡æ¯ã€‚</strong></p><p>å‡å¦‚blockå¤§å°ä¸º4KBçš„æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†äº†143ä¸ªå—ç»„ï¼Œæ¯ä¸ªå—ç»„æè¿°ç¬¦32å­—èŠ‚ï¼Œé‚£ä¹ˆGDTå°±éœ€è¦143*32=4576å­—èŠ‚å³ä¸¤ä¸ªblockæ¥å­˜æ”¾ã€‚è¿™ä¸¤ä¸ªGDT blockä¸­è®°å½•äº†æ‰€æœ‰å—ç»„çš„å—ç»„ä¿¡æ¯ï¼Œä¸”å­˜æ”¾GDTçš„å—ç»„ä¸­çš„GDTéƒ½æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚</p><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªå—ç»„æè¿°ç¬¦çš„ä¿¡æ¯(é€šè¿‡dumpe2fsè·å–)ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425222725852.png" alt="image-20240425222725852"></p><h4 id="2-4-Reserved-GDT">2.4 Reserved GDT</h4><p>ä¿ç•™GDTï¼šReserved GDT</p><p>ä¿ç•™GDTç”¨äºä»¥åæ‰©å®¹æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ï¼Œé˜²æ­¢æ‰©å®¹åå—ç»„å¤ªå¤šï¼Œä½¿å¾—å—ç»„æè¿°ç¬¦è¶…å‡ºå½“å‰å­˜å‚¨GDTçš„blocksã€‚ä¿ç•™GDTå’ŒGDTæ€»æ˜¯åŒæ—¶å‡ºç°ï¼Œå½“ç„¶ä¹Ÿå°±å’ŒsuperblockåŒæ—¶å‡ºç°äº†ã€‚</p><p>ä¾‹å¦‚å‰é¢143ä¸ªå—ç»„ä½¿ç”¨äº†2ä¸ªblockæ¥å­˜æ”¾GDTï¼Œä½†æ˜¯æ­¤æ—¶ç¬¬äºŒä¸ªblockè¿˜ç©ºä½™å¾ˆå¤šç©ºé—´ï¼Œå½“æ‰©å®¹åˆ°ä¸€å®šç¨‹åº¦æ—¶2ä¸ªblockå·²ç»æ— æ³•å†è®°å½•å—ç»„æè¿°ç¬¦äº†ï¼Œè¿™æ—¶å°±éœ€è¦åˆ†é…ä¸€ä¸ªæˆ–å¤šä¸ªReserved GDTçš„blockæ¥å­˜æ”¾è¶…å‡ºçš„å—ç»„æè¿°ç¬¦ã€‚</p><p>ç”±äºæ–°å¢åŠ äº†GDT blockï¼Œæ‰€ä»¥åº”è¯¥è®©æ¯ä¸€ä¸ªä¿å­˜GDTçš„å—ç»„éƒ½åŒæ—¶å¢åŠ è¿™ä¸€ä¸ªGDT blockï¼Œæ‰€ä»¥å°†ä¿ç•™GDTå’ŒGDTå­˜æ”¾åœ¨åŒä¸€ä¸ªå—ç»„ä¸­å¯ä»¥ç›´æ¥å°†ä¿ç•™GDTå˜æ¢ä¸ºGDTè€Œæ— éœ€ä½¿ç”¨ä½æ•ˆçš„å¤åˆ¶æ‰‹æ®µå¤‡ä»½åˆ°æ¯ä¸ªå­˜æ”¾GDTçš„å—ç»„ã€‚</p><p>åŒç†ï¼Œæ–°å¢åŠ äº†GDTéœ€è¦ä¿®æ”¹æ¯ä¸ªå—ç»„ä¸­superblockä¸­çš„æ–‡ä»¶ç³»ç»Ÿå±æ€§ï¼Œæ‰€ä»¥å°†superblockå’ŒReserved GDT/GDTæ”¾åœ¨ä¸€èµ·åˆèƒ½æå‡æ•ˆç‡ã€‚</p><h3 id="3-Data-Block">3.Data Block</h3><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425215902069.png" alt=""></p><p>å¦‚ä¸Šå›¾ï¼Œé™¤äº†Data Blockså…¶ä»–çš„éƒ¨åˆ†éƒ½è§£é‡Šè¿‡äº†ã€‚data blockæ˜¯ç›´æ¥å­˜å‚¨æ•°æ®çš„blockï¼Œä½†äº‹å®ä¸Šå¹¶éå¦‚æ­¤ç®€å•ã€‚</p><p>æ•°æ®æ‰€å ç”¨çš„blockç”±æ–‡ä»¶å¯¹åº”inodeè®°å½•ä¸­çš„blockæŒ‡é’ˆæ‰¾åˆ°ï¼Œä¸åŒçš„æ–‡ä»¶ç±»å‹ï¼Œæ•°æ®blockä¸­å­˜å‚¨çš„å†…å®¹æ˜¯ä¸ä¸€æ ·çš„ã€‚ä»¥ä¸‹æ˜¯Linuxä¸­ä¸åŒç±»å‹æ–‡ä»¶çš„å­˜å‚¨æ–¹å¼ã€‚</p><ul><li>å¯¹äºå¸¸è§„æ–‡ä»¶ï¼Œæ–‡ä»¶çš„æ•°æ®æ­£å¸¸å­˜å‚¨åœ¨æ•°æ®å—ä¸­ã€‚</li><li>å¯¹äºç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œä¸€çº§å­ç›®å½•çš„ç›®å½•åå­˜å‚¨åœ¨æ•°æ®å—ä¸­ã€‚</li><li>æ–‡ä»¶åä¸æ˜¯å­˜å‚¨åœ¨å…¶è‡ªèº«çš„inodeä¸­ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨å…¶æ‰€åœ¨ç›®å½•çš„data blockä¸­ã€‚</li><li>å¯¹äºç¬¦å·é“¾æ¥ï¼Œå¦‚æœç›®æ ‡è·¯å¾„åè¾ƒçŸ­åˆ™ç›´æ¥ä¿å­˜åœ¨inodeä¸­ä»¥ä¾¿æ›´å¿«åœ°æŸ¥æ‰¾ï¼Œå¦‚æœç›®æ ‡è·¯å¾„åè¾ƒé•¿åˆ™åˆ†é…ä¸€ä¸ªæ•°æ®å—æ¥ä¿å­˜ã€‚</li><li>è®¾å¤‡æ–‡ä»¶ã€FIFOå’Œsocketç­‰ç‰¹æ®Šæ–‡ä»¶æ²¡æœ‰æ•°æ®å—ï¼Œè®¾å¤‡æ–‡ä»¶çš„ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ä¿å­˜åœ¨inodeä¸­ã€‚</li></ul><h4 id="3-1-ç›®å½•æ–‡ä»¶çš„data-block">3.1 ç›®å½•æ–‡ä»¶çš„data block</h4><p>å¯¹äºç›®å½•æ–‡ä»¶ï¼Œå…¶inodeè®°å½•ä¸­å­˜å‚¨çš„æ˜¯ç›®å½•çš„inodeå·ã€ç›®å½•çš„å±æ€§å…ƒæ•°æ®å’Œç›®å½•æ–‡ä»¶çš„blockæŒ‡é’ˆï¼Œè¿™é‡Œé¢æ²¡æœ‰å­˜å‚¨ç›®å½•è‡ªèº«æ–‡ä»¶åçš„ä¿¡æ¯ã€‚</p><p>è€Œå…¶data blockçš„å­˜å‚¨æ–¹å¼åˆ™å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425223235705.png" alt="image-20240425223235705"></p><p>ç”±å›¾å¯çŸ¥ï¼Œåœ¨ç›®å½•æ–‡ä»¶çš„æ•°æ®å—ä¸­å­˜å‚¨äº†å…¶ä¸‹çš„æ–‡ä»¶åã€ç›®å½•åã€ç›®å½•æœ¬èº«çš„ç›¸å¯¹åç§°&quot;.â€œå’Œä¸Šçº§ç›®å½•çš„ç›¸å¯¹åç§°â€â€¦â€œï¼Œè¿˜å­˜å‚¨äº†æŒ‡å‘inode tableä¸­è¿™äº›æ–‡ä»¶åå¯¹åº”çš„inodeå·çš„æŒ‡é’ˆ(å¹¶éç›´æ¥å­˜å‚¨inodeå·ç )ã€ç›®å½•é¡¹é•¿åº¦rec_lenã€æ–‡ä»¶åé•¿åº¦name_lenå’Œæ–‡ä»¶ç±»å‹file_typeã€‚æ³¨æ„åˆ°é™¤äº†æ–‡ä»¶æœ¬èº«çš„inodeè®°å½•äº†æ–‡ä»¶ç±»å‹ï¼Œå…¶æ‰€åœ¨çš„ç›®å½•çš„æ•°æ®å—ä¹Ÿè®°å½•äº†æ–‡ä»¶ç±»å‹ã€‚ç”±äºrec_lenåªèƒ½æ˜¯4çš„å€æ•°ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨â€\0&quot;æ¥å¡«å……name_lenä¸å¤Ÿå‡‘æ»¡4å€æ•°çš„éƒ¨åˆ†ã€‚è‡³äºrec_lenå…·ä½“æ˜¯ä»€ä¹ˆï¼Œåªéœ€çŸ¥é“å®ƒæ˜¯ä¸€ç§åç§»å³å¯ã€‚</p><p>ç›®å½•çš„data blockä¸­å¹¶æ²¡æœ‰ç›´æ¥å­˜å‚¨ç›®å½•ä¸­æ–‡ä»¶çš„inodeå·ï¼Œå®ƒå­˜å‚¨çš„æ˜¯æŒ‡å‘inode tableä¸­å¯¹åº”æ–‡ä»¶inodeå·çš„æŒ‡é’ˆï¼Œæš‚ä¸”ç§°ä¹‹ä¸ºinodeæŒ‡é’ˆ(è‡³æ­¤ï¼Œå·²ç»çŸ¥é“äº†ä¸¤ç§æŒ‡é’ˆï¼šä¸€ç§æ˜¯inode tableä¸­æ¯ä¸ªinodeè®°å½•æŒ‡å‘å…¶å¯¹åº”data blockçš„blockæŒ‡é’ˆï¼Œä¸€ä¸ªæ­¤å¤„çš„inodeæŒ‡é’ˆã€‚é¢˜å¤–è¯ï¼šå®é™…ä¸ŠinodeæŒ‡é’ˆåº”è¯¥ç§°ä¹‹ä¸ºå­˜å‚¨åœ¨ç›®å½•data blcokä¸­çš„é“¾æ¥linkï¼Œè¿™ä¸ªlinkå’Œinode numä¸€ä¸€æ˜ å°„ï¼Œæ‰€ä»¥åˆ é™¤æ–‡ä»¶çš„å‡½æ•°ç§°ä¸ºunlink()ï¼Œè¡¨ç¤ºåœ¨ç›®å½•çš„data blockä¸­åˆ é™¤è¿™ä¸ªé“¾æ¥)ã€‚ä¸€ä¸ªå¾ˆæœ‰è¯´æœåŠ›çš„ä¾‹å­ï¼Œåœ¨ç›®å½•åªæœ‰è¯»è€Œæ²¡æœ‰æ‰§è¡Œæƒé™çš„æ—¶å€™ï¼Œä½¿ç”¨&quot;ls -l&quot;æ˜¯æ— æ³•è·å–åˆ°å…¶å†…æ–‡ä»¶inodeå·çš„ï¼Œè¿™å°±è¡¨æ˜æ²¡æœ‰ç›´æ¥å­˜å‚¨inodeå·ã€‚å®é™…ä¸Šï¼Œå› ä¸ºåœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œinodeå·å°±å·²ç»å…¨éƒ¨åˆ’åˆ†å¥½å¹¶åœ¨æ¯ä¸ªå—ç»„çš„inode tableä¸­å­˜æ”¾å¥½ï¼Œinode tableåœ¨å—ç»„ä¸­æ˜¯æœ‰å…·ä½“ä½ç½®çš„ï¼Œå¦‚æœä½¿ç”¨dumpe2fsæŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿï¼Œä¼šå‘ç°æ¯ä¸ªå—ç»„çš„inode tableå ç”¨çš„blockæ•°é‡æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå¦‚ä¸‹å›¾æ˜¯æŸåˆ†åŒºä¸Šå…¶ä¸­ä¸¤ä¸ªå—ç»„çš„ä¿¡æ¯ï¼Œå®ƒä»¬éƒ½å ç”¨249ä¸ªblockã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425223747136.png" alt="image-20240425223747136"></p><p>é™¤äº†inodeæŒ‡é’ˆï¼Œç›®å½•çš„data blockä¸­è¿˜ä½¿ç”¨æ•°å­—æ ¼å¼è®°å½•äº†æ–‡ä»¶ç±»å‹ï¼Œæ•°å­—æ ¼å¼å’Œæ–‡ä»¶ç±»å‹çš„å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425223811142.png" alt="image-20240425223811142"></p><p>æ³¨æ„åˆ°ç›®å½•çš„data blockä¸­å‰ä¸¤è¡Œå­˜å‚¨çš„æ˜¯ç›®å½•æœ¬èº«çš„ç›¸å¯¹åç§°&quot;.â€œå’Œä¸Šçº§ç›®å½•çš„ç›¸å¯¹åç§°â€â€¦&quot;ï¼Œå®ƒä»¬å®é™…ä¸Šæ˜¯ç›®å½•æœ¬èº«çš„ç¡¬é“¾æ¥å’Œä¸Šçº§ç›®å½•çš„ç¡¬é“¾æ¥ã€‚ç¡¬é“¾æ¥çš„æœ¬è´¨åé¢è¯´æ˜ã€‚</p><p>ç”±æ­¤ä¹Ÿå°±å®¹æ˜“ç†è§£ç›®å½•æƒé™çš„ç‰¹æ®Šä¹‹å¤„äº†ã€‚ç›®å½•æ–‡ä»¶çš„è¯»æƒé™Â®å’Œå†™æƒé™(w)ï¼Œéƒ½æ˜¯é’ˆå¯¹ç›®å½•æ–‡ä»¶çš„æ•°æ®å—æœ¬èº«ã€‚ç”±äºç›®å½•æ–‡ä»¶å†…åªæœ‰æ–‡ä»¶åã€æ–‡ä»¶ç±»å‹å’ŒinodeæŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœåªæœ‰è¯»æƒé™ï¼Œåªèƒ½è·å–æ–‡ä»¶åå’Œæ–‡ä»¶ç±»å‹ä¿¡æ¯ï¼Œæ— æ³•è·å–å…¶ä»–ä¿¡æ¯ï¼Œå°½ç®¡ç›®å½•çš„data blockä¸­ä¹Ÿè®°å½•ç€æ–‡ä»¶çš„inodeæŒ‡é’ˆï¼Œä½†å®šä½æŒ‡é’ˆæ˜¯éœ€è¦xæƒé™çš„ï¼Œå› ä¸ºå…¶å®ƒä¿¡æ¯éƒ½å‚¨å­˜åœ¨æ–‡ä»¶è‡ªèº«å¯¹åº”çš„inodeä¸­ï¼Œè€Œè¦è¯»å–æ–‡ä»¶inodeä¿¡æ¯éœ€è¦æœ‰ç›®å½•æ–‡ä»¶çš„æ‰§è¡Œæƒé™é€šè¿‡inodeæŒ‡é’ˆå®šä½åˆ°æ–‡ä»¶å¯¹åº”çš„inodeè®°å½•ä¸Šã€‚ä»¥ä¸‹æ˜¯æ²¡æœ‰ç›®å½•xæƒé™æ—¶çš„æŸ¥è¯¢çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°é™¤äº†æ–‡ä»¶åå’Œæ–‡ä»¶ç±»å‹ï¼Œå…¶ä½™çš„å…¨æ˜¯&quot;?&quot;ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[lisi4@xuexi tmp]$ ll -i d </span><br><span class="line"><span class="built_in">ls</span>: cannot access d/hehe: Permission denied </span><br><span class="line"><span class="built_in">ls</span>: cannot access d/haha: Permission denied </span><br><span class="line">total 0 </span><br><span class="line">? d????????? ? ? ? ? ? haha </span><br><span class="line">? -????????? ? ? ? ? ? hehe </span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œxfsæ–‡ä»¶ç³»ç»Ÿå’Œextæ–‡ä»¶ç³»ç»Ÿä¸ä¸€æ ·ï¼Œå®ƒè¿æ–‡ä»¶ç±»å‹éƒ½æ— æ³•è·å–ã€‚</p><h4 id="3-2-ç¬¦å·é“¾æ¥å­˜å‚¨æ–¹å¼">3.2 ç¬¦å·é“¾æ¥å­˜å‚¨æ–¹å¼</h4><p>ç¬¦å·é“¾æ¥å³ä¸ºè½¯é“¾æ¥ï¼Œç±»ä¼¼äºWindowsæ“ä½œç³»ç»Ÿä¸­çš„å¿«æ·æ–¹å¼ï¼Œå®ƒçš„ä½œç”¨æ˜¯æŒ‡å‘åŸæ–‡ä»¶æˆ–ç›®å½•ã€‚</p><p>è½¯é“¾æ¥ä¹‹æ‰€ä»¥ä¹Ÿè¢«ç§°ä¸ºç‰¹æ®Šæ–‡ä»¶çš„åŸå› æ˜¯ï¼šå®ƒä¸€èˆ¬æƒ…å†µä¸‹ä¸å ç”¨data blockï¼Œä»…ä»…é€šè¿‡å®ƒå¯¹åº”çš„inodeè®°å½•å°±èƒ½å°†å…¶ä¿¡æ¯æè¿°å®Œæˆ;ç¬¦å·é“¾æ¥çš„å¤§å°æ˜¯å…¶æŒ‡å‘ç›®æ ‡è·¯å¾„å ç”¨çš„å­—ç¬¦ä¸ªæ•°ï¼Œä¾‹å¦‚æŸä¸ªç¬¦å·é“¾æ¥çš„æŒ‡å‘æ–¹å¼ä¸º&quot;rmt --&gt; â€¦/sbin/rmt&quot;ï¼Œåˆ™å…¶æ–‡ä»¶å¤§å°ä¸º11å­—èŠ‚;åªæœ‰å½“ç¬¦å·é“¾æ¥æŒ‡å‘çš„ç›®æ ‡çš„è·¯å¾„åè¾ƒé•¿(60ä¸ªå­—èŠ‚)æ—¶æ–‡ä»¶ç³»ç»Ÿæ‰ä¼šåˆ’åˆ†ä¸€ä¸ªdata blockç»™å®ƒ;å®ƒçš„æƒé™å¦‚ä½•ä¹Ÿä¸é‡è¦ï¼Œå› å®ƒåªæ˜¯ä¸€ä¸ªæŒ‡å‘åŸæ–‡ä»¶çš„&quot;å·¥å…·&quot;ï¼Œæœ€ç»ˆå†³å®šæ˜¯å¦èƒ½è¯»å†™æ‰§è¡Œçš„æƒé™ç”±åŸæ–‡ä»¶å†³å®šï¼Œæ‰€ä»¥å¾ˆå¯èƒ½ls -læŸ¥çœ‹åˆ°çš„ç¬¦å·é“¾æ¥æƒé™ä¸º777ã€‚</p><p>æ³¨æ„ï¼Œè½¯é“¾æ¥çš„blockæŒ‡é’ˆå­˜å‚¨çš„æ˜¯ç›®æ ‡æ–‡ä»¶åã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé“¾æ¥æ–‡ä»¶çš„ä¸€åˆ‡éƒ½ä¾èµ–äºå…¶ç›®æ ‡æ–‡ä»¶åã€‚è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ/mntçš„è½¯é“¾æ¥/tmp/mntåœ¨/mntæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿåï¼Œé€šè¿‡è½¯é“¾æ¥å°±èƒ½è¿›å…¥/mntæ‰€æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿã€‚ç©¶å…¶åŸå› ï¼Œè¿˜æ˜¯å› ä¸ºå…¶ç›®æ ‡æ–‡ä»¶å&quot;/mnt&quot;å¹¶æ²¡æœ‰æ”¹å˜ã€‚</p><p>ä¾‹å¦‚ä»¥ä¸‹ç­›é€‰å‡ºäº†/etc/ä¸‹çš„ç¬¦å·é“¾æ¥ï¼Œæ³¨æ„è§‚å¯Ÿå®ƒä»¬çš„æƒé™å’Œå®ƒä»¬å ç”¨çš„ç©ºé—´å¤§å°ã€‚</p><h4 id="3-3-è®¾å¤‡æ–‡ä»¶ã€FIFOã€å¥—æ¥å­—æ–‡ä»¶">3.3 è®¾å¤‡æ–‡ä»¶ã€FIFOã€å¥—æ¥å­—æ–‡ä»¶</h4><p>å…³äºè¿™3ç§æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶åªéœ€è¦é€šè¿‡inodeå°±èƒ½å®Œå…¨ä¿å­˜å®ƒä»¬çš„ä¿¡æ¯ï¼Œå®ƒä»¬ä¸å ç”¨ä»»ä½•æ•°æ®å—ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯ç‰¹æ®Šæ–‡ä»¶ã€‚</p><p>è®¾å¤‡æ–‡ä»¶çš„ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ä¹Ÿä¿å­˜åœ¨inodeä¸­ã€‚ä»¥ä¸‹æ˜¯/dev/ä¸‹çš„éƒ¨åˆ†è®¾å¤‡ä¿¡æ¯ã€‚æ³¨æ„åˆ°å®ƒä»¬çš„ç¬¬5åˆ—å’Œç¬¬6åˆ—ä¿¡æ¯ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ï¼Œä¸»è®¾å¤‡å·æ ‡è¯†æ¯ä¸€ç§è®¾å¤‡çš„ç±»å‹ï¼Œæ¬¡è®¾å¤‡å·æ ‡è¯†åŒç§è®¾å¤‡ç±»å‹çš„ä¸åŒç¼–å·;ä¹Ÿæ³¨æ„åˆ°è¿™äº›ä¿¡æ¯ä¸­æ²¡æœ‰å¤§å°çš„ä¿¡æ¯ï¼Œå› ä¸ºè®¾å¤‡æ–‡ä»¶ä¸å ç”¨æ•°æ®å—æ‰€ä»¥æ²¡æœ‰å¤§å°çš„æ¦‚å¿µã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi ~]<span class="comment"># ll /dev | tail </span></span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 129 Oct 7 21:26 vcsa1 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 130 Oct 7 21:27 vcsa2 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 131 Oct 7 21:27 vcsa3 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 132 Oct 7 21:27 vcsa4 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 133 Oct 7 21:27 vcsa5 </span><br><span class="line">crw-rw---- 1 vcsa <span class="built_in">tty</span> 7, 134 Oct 7 21:27 vcsa6 </span><br><span class="line">crw-rw---- 1 root root 10, 63 Oct 7 21:26 vga_arbiter </span><br><span class="line">crw------- 1 root root 10, 57 Oct 7 21:26 vmci </span><br><span class="line">crw-rw-rw- 1 root root 10, 56 Oct 7 21:27 vsock </span><br><span class="line">crw-rw-rw- 1 root root 1, 5 Oct 7 21:26 zero </span><br></pre></td></tr></table></figure><h3 id="4-inodeåŸºç¡€çŸ¥è¯†">4.inodeåŸºç¡€çŸ¥è¯†</h3><p>æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªinodeï¼Œåœ¨å°†inodeå…³è”åˆ°æ–‡ä»¶åç³»ç»Ÿå°†é€šè¿‡inodeå·æ¥è¯†åˆ«æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ–‡ä»¶åã€‚å¹¶ä¸”è®¿é—®æ–‡ä»¶æ—¶å°†å…ˆæ‰¾åˆ°inodeï¼Œé€šè¿‡inodeä¸­è®°å½•çš„blockä½ç½®æ‰¾åˆ°è¯¥æ–‡ä»¶ã€‚</p><p>Qï¼šä¸ºä»€ä¹ˆè¦è¦é“¾æ¥ï¼Ÿ</p><p>Aï¼šä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è®¿é—®æ–‡ä»¶ï¼Œå¯ä»¥å°†ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•ä¸å¦ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•å»ºç«‹å…³è”ï¼Œä»è€Œå®ç°å¤šä¸ªè·¯å¾„æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„æ•ˆæœã€‚</p><p>Qï¼šä¸ºä»€ä¹ˆéœ€è¦ç¡¬å’Œè½¯ä¸¤ç§é“¾æ¥å‘¢ï¼Ÿ</p><p>Aï¼š</p><ul><li><strong>ç¡¬é“¾æ¥</strong>æ˜¯æŒ‡åœ¨<strong>åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­</strong>ï¼Œå°†ä¸€ä¸ªæ–‡ä»¶åå…³è”åˆ°ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶ä¸Šï¼Œä½¿å¾—è¯¥æ–‡ä»¶åä¹Ÿå¯ä»¥è®¿é—®è¯¥æ–‡ä»¶ã€‚</li><li><strong>è½¯é“¾æ¥</strong>ï¼ˆä¹Ÿç§°ç¬¦å·é“¾æ¥ï¼‰æ˜¯æŒ‡åœ¨<strong>ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¹‹é—´</strong>ï¼Œå°†ä¸€ä¸ªæ–‡ä»¶åå…³è”åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸Šï¼Œä½¿å¾—è¯¥æ–‡ä»¶åä¹Ÿå¯ä»¥è®¿é—®è¯¥æ–‡ä»¶ã€‚</li></ul><h4 id="4-1-ç¡¬é“¾æ¥">4.1 ç¡¬é“¾æ¥</h4><p><strong>æœ¬è´¨ï¼šç¡¬é“¾æ¥å°±æ˜¯å¤šä¸ªæ–‡ä»¶åæŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®å—ã€‚</strong></p><p>è™½ç„¶æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªinodeï¼Œä½†æ˜¯å­˜åœ¨ä¸€ç§å¯èƒ½ï¼šå¤šä¸ªæ–‡ä»¶çš„inodeç›¸åŒï¼Œä¹Ÿå°±å³inodeå·ã€å…ƒæ•°æ®ã€blockä½ç½®éƒ½ç›¸åŒï¼Œè¿™æ˜¯ä¸€ç§ä»€ä¹ˆæ ·çš„æƒ…å†µå‘¢?</p><p>èƒ½å¤Ÿæƒ³è±¡è¿™äº›inodeç›¸åŒçš„æ–‡ä»¶ä½¿ç”¨çš„éƒ½æ˜¯åŒä¸€æ¡inodeè®°å½•ï¼Œæ‰€ä»¥ä»£è¡¨çš„éƒ½æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„data blockä¸­çš„inodeæŒ‡é’ˆç›®çš„åœ°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å„æŒ‡é’ˆå¯¹åº”çš„æ–‡ä»¶åäº’ä¸ç›¸åŒè€Œå·²ã€‚è¿™ç§inodeç›¸åŒçš„æ–‡ä»¶åœ¨Linuxä¸­è¢«ç§°ä¸º&quot;ç¡¬é“¾æ¥&quot;ã€‚</p><p>ç¡¬é“¾æ¥æ–‡ä»¶çš„inodeéƒ½ç›¸åŒï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª&quot;ç¡¬é“¾æ¥æ•°&quot;çš„å±æ€§ï¼Œä½¿ç”¨ls -lçš„ç¬¬äºŒåˆ—å°±æ˜¯è¢«ç¡¬é“¾æ¥æ•°ï¼Œå®ƒè¡¨ç¤ºçš„å°±æ˜¯è¯¥æ–‡ä»¶æœ‰å‡ ä¸ªç¡¬é“¾æ¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">penge@penge-virtual-machine  ~/Desktop/MordenCpp/tmp1  <span class="built_in">ls</span> -l</span><br><span class="line">total 40</span><br><span class="line">-rwxrwxr-x 1 penge penge 18264 4æœˆ  17 13:32 a.out</span><br><span class="line">-rw-rw-r-- 1 penge penge   196 4æœˆ  25 17:11 example.c</span><br><span class="line">-rw-rw-r-- 1 penge penge  4240 4æœˆ  17 13:31 example.o</span><br><span class="line">-rw-rw-r-- 1 penge penge    56 4æœˆ  17 13:31 external.c</span><br><span class="line">-rw-rw-r-- 1 penge penge  2952 4æœˆ  17 13:32 external.o</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">ls</span> -i file1</span><br><span class="line">1055165 file1</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">ls</span> -i file2</span><br><span class="line">1055165 file2</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ä¸‹å›¾æè¿°çš„æ˜¯dir1ç›®å½•ä¸­çš„æ–‡ä»¶name1åŠå…¶ç¡¬é“¾æ¥dir2/name2ï¼Œå³è¾¹åˆ†åˆ«æ˜¯å®ƒä»¬çš„inodeå’Œdatablockã€‚è¿™é‡Œä¹Ÿçœ‹å‡ºäº†ç¡¬é“¾æ¥æ–‡ä»¶ä¹‹é—´å”¯ä¸€ä¸åŒçš„å°±æ˜¯å…¶æ‰€åœ¨ç›®å½•ä¸­çš„è®°å½•ä¸åŒã€‚æ³¨æ„ä¸‹å›¾ä¸­æœ‰ä¸€åˆ—Link Countå°±æ˜¯æ ‡è®°ç¡¬é“¾æ¥æ•°çš„å±æ€§ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426105519520.png" alt="image-20240426105519520"></p><p>æ¯åˆ›å»ºä¸€ä¸ªæ–‡ä»¶çš„ç¡¬é“¾æ¥ï¼Œå®è´¨ä¸Šæ˜¯å¤šä¸€ä¸ªæŒ‡å‘è¯¥inodeè®°å½•çš„inodeæŒ‡é’ˆï¼Œå¹¶ä¸”ç¡¬é“¾æ¥æ•°åŠ 1ã€‚</p><p>åˆ é™¤æ–‡ä»¶çš„å®è´¨æ˜¯åˆ é™¤è¯¥æ–‡ä»¶æ‰€åœ¨ç›®å½•data blockä¸­çš„å¯¹åº”çš„inodeæŒ‡é’ˆï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å‡å°‘ç¡¬é“¾æ¥æ¬¡æ•°ï¼Œç”±äºblockæŒ‡é’ˆæ˜¯å­˜å‚¨åœ¨inodeä¸­çš„ï¼Œæ‰€ä»¥ä¸æ˜¯çœŸçš„åˆ é™¤æ•°æ®ï¼Œå¦‚æœä»æœ‰å…¶ä»–æŒ‡é’ˆæŒ‡å‘è¯¥inodeï¼Œé‚£ä¹ˆè¯¥æ–‡ä»¶çš„blockæŒ‡é’ˆä»ç„¶æ˜¯å¯ç”¨çš„ã€‚å½“ç¡¬é“¾æ¥æ¬¡æ•°ä¸º1æ—¶å†åˆ é™¤æ–‡ä»¶å°±æ˜¯çœŸçš„åˆ é™¤æ–‡ä»¶äº†ï¼Œæ­¤æ—¶inodeè®°å½•ä¸­blockæŒ‡é’ˆä¹Ÿå°†è¢«åˆ é™¤ã€‚</p><p>ä¸èƒ½è·¨åˆ†åŒºåˆ›å»ºç¡¬é“¾æ¥ï¼Œå› ä¸ºä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„inodeå·å¯èƒ½ä¼šç›¸åŒï¼Œå¦‚æœå…è®¸åˆ›å»ºç¡¬é“¾æ¥ï¼Œå¤åˆ¶åˆ°å¦ä¸€ä¸ªåˆ†åŒºæ—¶inodeå¯èƒ½ä¼šå’Œæ­¤åˆ†åŒºå·²ä½¿ç”¨çš„inodeå·å†²çªã€‚</p><p>ç¡¬é“¾æ¥åªèƒ½å¯¹æ–‡ä»¶åˆ›å»ºï¼Œæ— æ³•å¯¹ç›®å½•åˆ›å»ºç¡¬é“¾æ¥ã€‚ã€è¿™é‡Œæˆ‘çš„ç†è§£æ˜¯å¯èƒ½ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨çš„æƒ…å†µã€‘ä¹‹æ‰€ä»¥æ— æ³•å¯¹ç›®å½•åˆ›å»ºç¡¬é“¾æ¥ï¼Œæ˜¯å› ä¸ºæ–‡ä»¶ç³»ç»Ÿå·²ç»æŠŠæ¯ä¸ªç›®å½•çš„ç¡¬é“¾æ¥åˆ›å»ºå¥½äº†ï¼Œå®ƒä»¬å°±æ˜¯ç›¸å¯¹è·¯å¾„ä¸­çš„&quot;.â€œå’Œâ€â€¦&quot;ï¼Œåˆ†åˆ«æ ‡è¯†å½“å‰ç›®å½•çš„ç¡¬é“¾æ¥å’Œä¸Šçº§ç›®å½•çš„ç¡¬é“¾æ¥ã€‚æ¯ä¸€ä¸ªç›®å½•ä¸­éƒ½ä¼šåŒ…å«è¿™ä¸¤ä¸ªç¡¬é“¾æ¥ï¼Œå®ƒåŒ…å«äº†ä¸¤ä¸ªä¿¡æ¯ï¼š</p><p>(1) ä¸€ä¸ªæ²¡æœ‰å­ç›®å½•çš„ç›®å½•æ–‡ä»¶çš„ç¡¬é“¾æ¥æ•°æ˜¯2ï¼Œå…¶ä¸€æ˜¯ç›®å½•æœ¬èº«ï¼Œå³è¯¥ç›®å½•datablockä¸­çš„&quot;.&quot;ï¼Œå…¶äºŒæ˜¯å…¶çˆ¶ç›®å½•datablockä¸­è¯¥ç›®å½•çš„è®°å½•ï¼Œè¿™ä¸¤è€…éƒ½æŒ‡å‘åŒä¸€ä¸ªinodeå·;</p><p>(2) ä¸€ä¸ªåŒ…å«å­ç›®å½•çš„ç›®å½•æ–‡ä»¶ï¼Œå…¶ç¡¬é“¾æ¥æ•°æ˜¯2+å­ç›®å½•æ•°ï¼Œå› ä¸ºæ¯ä¸ªå­ç›®å½•éƒ½å…³è”ä¸€ä¸ªçˆ¶ç›®å½•çš„ç¡¬é“¾æ¥&quot;â€¦â€œã€‚å¾ˆå¤šäººåœ¨è®¡ç®—ç›®å½•çš„ç¡¬é“¾æ¥æ•°æ—¶è®¤ä¸ºç”±äºåŒ…å«äº†â€.â€œå’Œâ€â€¦â€œï¼Œæ‰€ä»¥ç©ºç›®å½•çš„ç¡¬é“¾æ¥æ•°æ˜¯2ï¼Œè¿™æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºâ€â€¦â€œä¸æ˜¯æœ¬ç›®å½•çš„ç¡¬é“¾æ¥ã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç›®å½•åº”è¯¥çº³å…¥è€ƒè™‘ï¼Œå³â€/â€œç›®å½•ï¼Œå®ƒè‡ªèº«æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å…¥å£ï¼Œæ˜¯è‡ªå¼•ç”¨(ä¸‹æ–‡ä¸­ä¼šè§£é‡Šè‡ªå¼•ç”¨)çš„ï¼Œæ‰€ä»¥â€/â€œç›®å½•ä¸‹çš„â€.â€œå’Œâ€â€¦â€œçš„inodeå·ç›¸åŒï¼Œå®ƒè‡ªèº«ä¸å ç”¨ç¡¬é“¾æ¥ï¼Œå› ä¸ºå…¶datablockä¸­åªè®°å½•inodeå·ç›¸åŒçš„â€.â€œå’Œâ€â€¦â€œï¼Œä¸å†åƒå…¶ä»–ç›®å½•ä¸€æ ·è¿˜è®°å½•ä¸€ä¸ªåä¸ºâ€/â€œçš„ç›®å½•ï¼Œæ‰€ä»¥â€/â€œçš„ç¡¬é“¾æ¥æ•°ä¹Ÿæ˜¯2+å­ç›®å½•æ•°ï¼Œä½†è¿™ä¸ª2æ˜¯â€.â€œå’Œâ€â€¦&quot;çš„ç»“æœã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi ~]<span class="comment"># ln /tmp /mydata </span></span><br><span class="line"><span class="built_in">ln</span>: `/tmp<span class="string">&#x27;: hard link not allowed for directory </span></span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆæ–‡ä»¶ç³»ç»Ÿè‡ªå·±åˆ›å»ºå¥½äº†ç›®å½•çš„ç¡¬é“¾æ¥å°±ä¸å…è®¸äººä¸ºåˆ›å»ºå‘¢?ä»&quot;.â€œå’Œâ€â€¦â€œçš„ç”¨æ³•ä¸Šè€ƒè™‘ï¼Œå¦‚æœå½“å‰ç›®å½•ä¸º/usrï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨â€./local&quot;æ¥è¡¨ç¤º/usr/localï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬äººä¸ºåˆ›å»ºäº†/usrç›®å½•çš„ç¡¬é“¾æ¥/tmp/husrï¼Œéš¾é“æˆ‘ä»¬ä¹Ÿè¦ä½¿ç”¨&quot;/tmp/husr/local&quot;æ¥è¡¨ç¤º/usr/localå—?è¿™å…¶å®å·²ç»æ˜¯è½¯é“¾æ¥çš„ä½œç”¨äº†ã€‚è‹¥è¦å°†å…¶è®¤ä¸ºæ˜¯ç¡¬é“¾æ¥çš„åŠŸèƒ½ï¼Œè¿™å¿…å°†å¯¼è‡´ç¡¬é“¾æ¥ç»´æŠ¤çš„æ··ä¹±ã€‚ã€è¿™ä¸ªè§£é‡Šä¹Ÿå¾ˆå¥½ã€‘</p><p>ä¸è¿‡ï¼Œé€šè¿‡mountå·¥å…·çš„&quot;â€“bind&quot;é€‰é¡¹ï¼Œå¯ä»¥å°†ä¸€ä¸ªç›®å½•æŒ‚è½½åˆ°å¦ä¸€ä¸ªç›®å½•ä¸‹ï¼Œå®ç°ä¼ª&quot;ç¡¬é“¾æ¥&quot;ï¼Œå®ƒä»¬çš„å†…å®¹å’Œinodeå·æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚</p><p>ç¡¬é“¾æ¥çš„åˆ›å»ºæ–¹æ³•ï¼š ln file_target link_name ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426140728344.png" alt="image-20240426140728344"></p><h4 id="4-2-è½¯é“¾æ¥">4.2 è½¯é“¾æ¥</h4><p><strong>è½¯é“¾æ¥çš„æœ¬è´¨æ˜¯ä¸€ä¸ªåŒ…å«ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•è·¯å¾„çš„å°æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åƒç¡¬é“¾æ¥ä¸€æ ·ç›´æ¥æŒ‡å‘æ•°æ®å—ã€‚å½“ä½ è®¿é—®è½¯é“¾æ¥æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šæ ¹æ®è¯¥é“¾æ¥ä¸­åŒ…å«çš„è·¯å¾„æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¹¶å°†æ“ä½œé‡å®šå‘åˆ°ç›®æ ‡ã€‚</strong></p><p>è½¯é“¾æ¥å°±æ˜¯å­—ç¬¦é“¾æ¥ï¼Œ<strong>é“¾æ¥æ–‡ä»¶é»˜è®¤æŒ‡çš„å°±æ˜¯å­—ç¬¦é“¾æ¥æ–‡ä»¶(æ³¨æ„ä¸æ˜¯å­—ç¬¦è®¾å¤‡)ï¼Œä½¿ç”¨&quot;l&quot;è¡¨ç¤ºå…¶ç±»å‹ã€‚</strong></p><p>ç¡¬é“¾æ¥ä¸èƒ½è·¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºï¼Œå¦åˆ™inodeå·å¯èƒ½ä¼šå†²çªã€‚äºæ˜¯å®ç°äº†è½¯é“¾æ¥ä»¥ä¾¿è·¨æ–‡ä»¶ç³»ç»Ÿå»ºç«‹é“¾æ¥ã€‚æ—¢ç„¶æ˜¯è·¨æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£ä¹ˆè½¯é“¾æ¥å¿…é¡»å¾—æœ‰è‡ªå·±çš„inodeå·ã€‚</p><p>è½¯é“¾æ¥åœ¨åŠŸèƒ½ä¸Šç­‰ä»·ä¸Windowsç³»ç»Ÿä¸­çš„å¿«æ·æ–¹å¼ï¼Œå®ƒæŒ‡å‘åŸæ–‡ä»¶ï¼ŒåŸæ–‡ä»¶æŸåæˆ–æ¶ˆå¤±ï¼Œè½¯é“¾æ¥æ–‡ä»¶å°±æŸåã€‚å¯ä»¥è®¤ä¸ºè½¯é“¾æ¥inodeè®°å½•ä¸­çš„æŒ‡é’ˆå†…å®¹æ˜¯ç›®æ ‡è·¯å¾„çš„å­—ç¬¦ä¸²ã€‚</p><p>åˆ›å»ºæ–¹å¼ï¼š ln â€“s source_file softlink_name ï¼Œè®°ä½æ˜¯source_file&lt;â€“link_nameçš„æŒ‡å‘å…³ç³»(åç®­å¤´)ï¼Œä»¥å‰æˆ‘è€æé”™ä½ç½®ã€‚</p><p>æŸ¥çœ‹è½¯é“¾æ¥çš„å€¼ï¼š readlink softlink_name</p><p>åœ¨è®¾ç½®è½¯é“¾æ¥çš„æ—¶å€™ï¼Œ<strong>source_fileè™½ç„¶ä¸è¦æ±‚æ˜¯ç»å¯¹è·¯å¾„ï¼Œä½†å»ºè®®ç»™ç»å¯¹è·¯å¾„</strong>ã€‚æ˜¯å¦è¿˜è®°å¾—è½¯é“¾æ¥æ–‡ä»¶çš„å¤§å°?å®ƒæ˜¯æ ¹æ®è½¯é“¾æ¥æ‰€æŒ‡å‘è·¯å¾„çš„å­—ç¬¦æ•°è®¡ç®—çš„ï¼Œä¾‹å¦‚æŸä¸ªç¬¦å·é“¾æ¥çš„æŒ‡å‘æ–¹å¼ä¸º&quot;rmt --&gt; â€¦/sbin/rmt&quot;ï¼Œå®ƒçš„æ–‡ä»¶å¤§å°ä¸º11å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦å»ºç«‹äº†è½¯é“¾æ¥åï¼Œè½¯é“¾æ¥çš„æŒ‡å‘è·¯å¾„æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œä»ç„¶æ˜¯&quot;â€¦/sbin/rmt&quot;ã€‚å¦‚æœæ­¤æ—¶ç§»åŠ¨è½¯é“¾æ¥æ–‡ä»¶æœ¬èº«ï¼Œå®ƒçš„æŒ‡å‘æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œä»ç„¶æ˜¯11ä¸ªå­—ç¬¦çš„&quot;â€¦/sbin/rmt&quot;ï¼Œä½†æ­¤æ—¶è¯¥è½¯é“¾æ¥çˆ¶ç›®å½•ä¸‹å¯èƒ½æ ¹æœ¬å°±ä¸å­˜åœ¨/sbin/rmtï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶è¯¥è½¯é“¾æ¥æ˜¯ä¸€ä¸ªè¢«ç ´åçš„è½¯é“¾æ¥ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426140716839.png" alt="image-20240426140716839"></p><h4 id="4-3-å®æ“">4.3 å®æ“</h4><ul><li><a href="https://zhuanlan.zhihu.com/p/641716217">ã€Linuxã€‘ç¡¬é“¾æ¥ å’Œ è½¯é“¾æ¥</a></li></ul><blockquote><p><strong>ç¡¬é“¾æ¥</strong></p></blockquote><p>å¦‚æœAæ–‡ä»¶å’ŒBæ–‡ä»¶çš„å…³ç³»æ˜¯ç¡¬è¿æ¥çš„å…³ç³»ã€‚å½“ç”¨æˆ·ä¿®æ”¹äº†Aæ–‡ä»¶çš„å†…å®¹ï¼Œé‚£ä¹ˆBæ–‡ä»¶çš„å†…å®¹ä¹Ÿä¼šå‘ç”Ÿæ›´æ”¹ã€‚å¦‚æœä¿®æ”¹çš„Bæ–‡ä»¶ï¼Œé‚£ä¹ˆAæ–‡ä»¶çš„å†…å®¹ä¹Ÿä¼šå‘ç”Ÿæ›´æ”¹ã€‚</p><p>ç‰¹ç‚¹:<br>1ã€ç¡¬è¿æ¥ä¸é™äºä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´ï¼Œå¯ä»¥åœ¨å¤šä¸ªæ–‡ä»¶ä¹‹é—´è¿›è¡Œã€‚ls -lå‘½ä»¤ä¸­æ˜¾ç¤ºäº†æ–‡ä»¶çš„ç¡¬è¿æ¥æ•°</p><p>2ã€ä¸èƒ½å¯¹ç›®å½•åšç¡¬ä»¶è¿æ¥</p><p>3ã€ä¸èƒ½åœ¨ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¹‹é—´åšç¡¬é“¾æ¥ã€”Linuxçš„æ–‡ä»¶ç³»ç»Ÿ: ext4ã€‚xfsç­‰ç­‰)</p><p>4ã€æ‰€æœ‰çš„ç¡¬è¿æ¥ï¼Œå…·å¤‡ç›¸åŒçš„iNodeèŠ‚ç‚¹å·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">touch</span> file1</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">ln</span> file1 file2</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° ll            </span><br><span class="line">total 88K</span><br><span class="line">-rwxrwxr-x 1 penge penge  38K 3æœˆ  10 15:14 a.out</span><br><span class="line">-rw-rw-r-- 2 penge penge    0 4æœˆ  26 14:00 file1</span><br><span class="line">-rw-rw-r-- 2 penge penge    0 4æœˆ  26 14:00 file2</span><br><span class="line">-rw-rw-r-- 1 penge penge 1.6K 3æœˆ  10 15:14 http_conn.cpp</span><br><span class="line">-rw-rw-r-- 1 penge penge  779 3æœˆ  13 11:18 http_conn.h</span><br><span class="line">-rw-rw-r-- 1 penge penge 2.7K 3æœˆ  10 10:52 locker.h</span><br><span class="line">-rwxrwxr-x 1 penge penge  21K 4æœˆ  12 10:39 main</span><br><span class="line">-rw-rw-r-- 1 penge penge    0 4æœˆ  17 13:30 main.cpp</span><br><span class="line">-rw-rw-r-- 1 penge penge 3.6K 3æœˆ  10 10:52 threadpool.h</span><br><span class="line">drwxrwxr-x 2 penge penge 4.0K 4æœˆ  16 14:25 tmp</span><br><span class="line">drwxrwxr-x 2 penge penge 4.0K 4æœˆ  25 16:05 tmp1</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">echo</span> <span class="string">&#x27;aaa&#x27;</span>&gt;file1                                                  </span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file1                                                         </span><br><span class="line">aaa</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file2</span><br><span class="line">aaa</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">echo</span> <span class="string">&#x27;bbb&#x27;</span>&gt;file2</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file2       </span><br><span class="line">bbb</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file2       </span><br><span class="line">bbb</span><br><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° <span class="built_in">cat</span> file1</span><br><span class="line">bbb</span><br></pre></td></tr></table></figure><blockquote><p><strong>è½¯é“¾æ¥</strong></p></blockquote><p>ç±»ä¼¼Windowsä¸­çš„å¿«æ·æ–¹å¼ã€‚ä¸ºä¸€ä¸ªæºæ–‡ä»¶åˆ›å»ºä¸€ä¸ªå¿«æ·æ–¹å¼ã€‚</p><p>1ã€å¦‚æœæºæ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•ä½¿ç”¨è¯¥å¿«æ·æ–¹å¼ã€‚ä¸€æ—¦ä»¥åŒæ ·æ–‡ä»¶ååˆ›å»ºäº†æºæ–‡ä»¶ï¼Œé“¾æ¥å°†ç»§ç»­æŒ‡å‘è¯¥æ–‡ä»¶çš„æ–°æ•°æ®</p><p>2ã€åœ¨ls-lä¸­ï¼Œè½¯é“¾æ¥ä½œä¸ºä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ç±»å‹æ˜¾ç¤ºå‡ºæ¥ï¼Œå…¶ç¬¬ä¸€ä¸ªå­—æ¯æ˜¯lã€‚</p><p>3ã€è½¯é“¾æ¥çš„å¤§å°æ˜¯å…¶é“¾æ¥æ–‡ä»¶çš„è·¯å¾„åä¸­çš„å­—ç¬¦æ•°ã€‚</p><p>pwd -Pæ˜¾ç¤ºæ–‡ä»¶çš„å®é™…è·¯å¾„,è€Œä¸æ˜¯è½¯è¿æ¥çš„è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> penge@penge-virtual-machine î‚° /bin î‚° <span class="built_in">pwd</span> -P</span><br><span class="line">/usr/bin</span><br></pre></td></tr></table></figure><h3 id="5-inodeæ·±å…¥">5.inodeæ·±å…¥</h3><h4 id="5-1-inodeå¤§å°å’Œåˆ’åˆ†">5.1 inodeå¤§å°å’Œåˆ’åˆ†</h4><p>inodeå¤§å°ä¸º128å­—èŠ‚çš„å€æ•°ï¼Œæœ€å°ä¸º128å­—èŠ‚ã€‚å®ƒæœ‰é»˜è®¤å€¼å¤§å°ï¼Œå®ƒçš„é»˜è®¤å€¼ç”±/etc/mke2fs.confæ–‡ä»¶ä¸­æŒ‡å®šã€‚ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿé»˜è®¤å€¼å¯èƒ½ä¸åŒã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi ~]<span class="comment"># cat /etc/mke2fs.conf </span></span><br><span class="line">[defaults] </span><br><span class="line"> base_features = sparse_super,filetype,resize_inode,dir_index,ext_attr </span><br><span class="line"> enable_periodic_fsck = 1 </span><br><span class="line"> blocksize = 4096 </span><br><span class="line"> inode_size = 256 </span><br><span class="line"> inode_ratio = 16384 </span><br><span class="line">[fs_types] </span><br><span class="line"> ext3 = &#123; </span><br><span class="line"> features = has_journal </span><br><span class="line"> &#125; </span><br><span class="line"> ext4 = &#123; </span><br><span class="line"> features = has_journal,extent,huge_file,flex_bg,uninit_bg,dir_nlink,extra_isize </span><br><span class="line"> inode_size = 256 </span><br><span class="line"> &#125; </span><br></pre></td></tr></table></figure><p>åŒæ ·è§‚å¯Ÿåˆ°è¿™ä¸ªæ–‡ä»¶ä¸­è¿˜è®°å½•äº†blocksizeçš„é»˜è®¤å€¼å’Œinodeåˆ†é…æ¯”ç‡inode_ratioã€‚inode_ratio=16384è¡¨ç¤ºæ¯16384ä¸ªå­—èŠ‚å³16KBå°±åˆ†é…ä¸€ä¸ªinodeå·ï¼Œç”±äºé»˜è®¤blocksize=4KBï¼Œæ‰€ä»¥æ¯4ä¸ªblockå°±åˆ†é…ä¸€ä¸ªinodeå·ã€‚å½“ç„¶åˆ†é…çš„è¿™äº›inodeå·åªæ˜¯é¢„åˆ†é…ï¼Œå¹¶ä¸çœŸçš„ä»£è¡¨ä¼šå…¨éƒ¨ä½¿ç”¨ï¼Œæ¯•ç«Ÿæ¯ä¸ªæ–‡ä»¶æ‰ä¼šåˆ†é…ä¸€ä¸ªinodeå·ã€‚ä½†æ˜¯åˆ†é…çš„inodeè‡ªèº«ä¼šå ç”¨blockï¼Œè€Œä¸”å…¶è‡ªèº«å¤§å°256å­—èŠ‚è¿˜ä¸ç®—å°ï¼Œæ‰€ä»¥inodeå·çš„æµªè´¹ä»£è¡¨ç€ç©ºé—´çš„æµªè´¹ã€‚</p><p>æ—¢ç„¶çŸ¥é“äº†inodeåˆ†é…æ¯”ç‡ï¼Œå°±èƒ½è®¡ç®—å‡ºæ¯ä¸ªå—ç»„åˆ†é…å¤šå°‘ä¸ªinodeå·ï¼Œä¹Ÿå°±èƒ½è®¡ç®—å‡ºinode tableå ç”¨å¤šå°‘ä¸ªblockã€‚</p><p>å¦‚æœæ–‡ä»¶ç³»ç»Ÿä¸­å¤§é‡å­˜å‚¨ç”µå½±ç­‰å¤§æ–‡ä»¶ï¼Œinodeå·å°±æµªè´¹å¾ˆå¤šï¼Œinodeå ç”¨çš„ç©ºé—´ä¹Ÿæµªè´¹å¾ˆå¤šã€‚ä½†æ˜¯æ²¡åŠæ³•ï¼Œæ–‡ä»¶ç³»ç»Ÿåˆä¸çŸ¥é“ä½ è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿæ˜¯ç”¨æ¥å­˜ä»€ä¹ˆæ ·çš„æ•°æ®ï¼Œå¤šå¤§çš„æ•°æ®ï¼Œå¤šå°‘æ•°æ®ã€‚</p><p>å½“ç„¶inodesizeã€inodeåˆ†é…æ¯”ä¾‹ã€blocksizeéƒ½å¯ä»¥åœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™äººä¸ºæŒ‡å®šã€‚</p><h4 id="5-2-extæ–‡ä»¶ç³»ç»Ÿé¢„ç•™çš„inodeå·">5.2 extæ–‡ä»¶ç³»ç»Ÿé¢„ç•™çš„inodeå·</h4><p>Exté¢„ç•™äº†ä¸€äº›inodeåšç‰¹æ®Šç‰¹æ€§ä½¿ç”¨ï¼Œå¦‚ä¸‹ï¼šæŸäº›å¯èƒ½å¹¶éæ€»æ˜¯å‡†ç¡®ï¼Œå…·ä½“çš„inodeå·å¯¹åº”ä»€ä¹ˆæ–‡ä»¶å¯ä»¥ä½¿ç”¨&quot;find / -inum NUM&quot;æŸ¥çœ‹ã€‚</p><ul><li>Ext4çš„ç‰¹æ®Šinode</li><li>Inodeå· ç”¨é€”</li><li>0 ä¸å­˜åœ¨0å·inode</li><li>1 è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚/procå’Œ/sys</li><li>2 æ ¹ç›®å½•</li><li>3 ACLç´¢å¼•</li><li>4 ACLæ•°æ®</li><li>5 Boot loader</li><li>6 æœªåˆ é™¤çš„ç›®å½•</li><li>7 é¢„ç•™çš„å—ç»„æè¿°ç¬¦inode</li><li>8 æ—¥å¿—inode</li><li>11 ç¬¬ä¸€ä¸ªéé¢„ç•™çš„inodeï¼Œé€šå¸¸æ˜¯lost+foundç›®å½•</li></ul><p>æ‰€ä»¥åœ¨ext4æ–‡ä»¶ç³»ç»Ÿçš„dumpe2fsä¿¡æ¯ä¸­ï¼Œèƒ½è§‚å¯Ÿåˆ°fisrt inodeå·å¯èƒ½ä¸º11ä¹Ÿå¯èƒ½ä¸º12ã€‚</p><p>å¹¶ä¸”æ³¨æ„åˆ°&quot;/&quot;çš„inodeå·ä¸º2ï¼Œè¿™ä¸ªç‰¹æ€§åœ¨æ–‡ä»¶è®¿é—®æ—¶ä¼šç”¨ä¸Šã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½ä¼šåˆ†é…è‡ªå·±çš„inodeå·ï¼Œä¸åŒæ–‡ä»¶ç³»ç»Ÿä¹‹é—´æ˜¯å¯èƒ½ä¼šå‡ºç°ä½¿ç”¨ç›¸åŒinodeå·æ–‡ä»¶çš„ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi ~]<span class="comment"># find / -ignore_readdir_race -inum 2 -ls </span></span><br><span class="line"> 2 4 dr-xr-xr-x 22 root root 4096 Jun 9 09:56 / </span><br><span class="line"> 2 2 dr-xr-xr-x 5 root root 1024 Feb 25 11:53 /boot </span><br><span class="line"> 2 0 c--------- 1 root root Jun 7 02:13 /dev/pts/ptmx </span><br><span class="line"> 2 0 -rw-r--r-- 1 root root 0 Jun 6 18:13 /proc/sys/fs/binfmt_misc/status </span><br><span class="line"> 2 0 drwxr-xr-x 3 root root 0 Jun 6 18:13 /sys/fs </span><br></pre></td></tr></table></figure><p>ä»ç»“æœä¸­å¯è§ï¼Œé™¤äº†æ ¹çš„Inodeå·ä¸º2ï¼Œè¿˜æœ‰å‡ ä¸ªæ–‡ä»¶çš„inodeå·ä¹Ÿæ˜¯ 2ï¼Œå®ƒä»¬éƒ½å±äºç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæœ‰äº›æ˜¯è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚/procå’Œ/sysã€‚</p><h4 id="5-3-ext2-3çš„inodeç›´æ¥ã€é—´æ¥å¯»å€">5.3 ext2/3çš„inodeç›´æ¥ã€é—´æ¥å¯»å€</h4><p>å‰æ–‡è¯´è¿‡ï¼Œinodeä¸­ä¿å­˜äº†blocksæŒ‡é’ˆï¼Œä½†æ˜¯ä¸€æ¡inodeè®°å½•ä¸­èƒ½ä¿å­˜çš„æŒ‡é’ˆæ•°é‡æ˜¯æœ‰é™çš„ï¼Œå¦åˆ™å°±ä¼šè¶…å‡ºinodeå¤§å°(128å­—èŠ‚æˆ–256å­—èŠ‚)ã€‚</p><p>åœ¨ext2å’Œext3æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªinodeä¸­æœ€å¤šåªèƒ½æœ‰15ä¸ªæŒ‡é’ˆï¼Œæ¯ä¸ªæŒ‡é’ˆä½¿ç”¨i_block[n]è¡¨ç¤ºã€‚</p><p>å‰12ä¸ªæŒ‡é’ˆi_block[0]åˆ°i_block[11]æ˜¯ç›´æ¥å¯»å€æŒ‡é’ˆï¼Œæ¯ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæ•°æ®åŒºçš„blockã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426112610456.png" alt="image-20240426112610456"></p><p>ç¬¬13ä¸ªæŒ‡é’ˆi_block[12]æ˜¯ä¸€çº§é—´æ¥å¯»å€æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªä»ç„¶å­˜å‚¨äº†æŒ‡é’ˆçš„blockå³i_block[12] --&gt; Pointerblock --&gt; datablockã€‚</p><p>ç¬¬14ä¸ªæŒ‡é’ˆi_block[13]æ˜¯äºŒçº§é—´æ¥å¯»å€æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªä»ç„¶å­˜å‚¨äº†æŒ‡é’ˆçš„blockï¼Œä½†æ˜¯è¿™ä¸ªblockä¸­çš„æŒ‡é’ˆè¿˜ç»§ç»­æŒ‡å‘å…¶ä»–å­˜å‚¨æŒ‡é’ˆçš„blockï¼Œå³i_block[13] --&gt; Pointerblock1 --&gt; PointerBlock2 --&gt; datablockã€‚</p><p>ç¬¬15ä¸ªæŒ‡é’ˆi_block[14]æ˜¯ä¸‰çº§é—´æ¥å¯»å€æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªä»»ç„¶å­˜å‚¨äº†æŒ‡é’ˆçš„blockï¼Œè¿™ä¸ªæŒ‡é’ˆblockä¸‹è¿˜æœ‰ä¸¤æ¬¡æŒ‡é’ˆæŒ‡å‘ã€‚å³i_block[13] --&gt; Pointerblock1 --&gt; PointerBlock2 --&gt; PointerBlock3 --&gt; datablockã€‚</p><p>å…¶ä¸­ç”±äºæ¯ä¸ªæŒ‡é’ˆå¤§å°ä¸º4å­—èŠ‚ï¼Œæ‰€ä»¥æ¯ä¸ªæŒ‡é’ˆblockèƒ½å­˜æ”¾çš„æŒ‡é’ˆæ•°é‡ä¸ºBlockSize/4byteã€‚ä¾‹å¦‚blocksizeä¸º4KBï¼Œé‚£ä¹ˆä¸€ä¸ªBlockå¯ä»¥å­˜æ”¾4096/4=1024ä¸ªæŒ‡é’ˆã€‚</p><p>å¦‚ä¸‹å›¾</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426112704312.png" alt="image-20240426112704312"></p><p>ä¸ºä»€ä¹ˆè¦åˆ†é—´æ¥å’Œç›´æ¥æŒ‡é’ˆå‘¢?å¦‚æœä¸€ä¸ªinodeä¸­15ä¸ªæŒ‡é’ˆå…¨æ˜¯ç›´æ¥æŒ‡é’ˆï¼Œå‡å¦‚æ¯ä¸ªblockçš„å¤§å°ä¸º1KBï¼Œé‚£ä¹ˆ15ä¸ªæŒ‡é’ˆåªèƒ½æŒ‡å‘15ä¸ªblockå³15KBçš„å¤§å°ï¼Œç”±äºæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªinodeå·ï¼Œæ‰€ä»¥å°±é™åˆ¶äº†æ¯ä¸ªæ–‡ä»¶æœ€å¤§ä¸º15*1=15KBï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚</p><p>å¦‚æœå­˜å‚¨å¤§äº15KBçš„æ–‡ä»¶è€Œåˆä¸å¤ªå¤§çš„æ—¶å€™ï¼Œå°±å ç”¨ä¸€çº§é—´æ¥æŒ‡é’ˆi_block[12]ï¼Œè¿™æ—¶å¯ä»¥å­˜æ”¾æŒ‡é’ˆæ•°é‡ä¸º1024/4+12=268ï¼Œæ‰€ä»¥èƒ½å­˜æ”¾268KBçš„æ–‡ä»¶ã€‚</p><p>å¦‚æœå­˜å‚¨å¤§äº268K çš„æ–‡ä»¶è€Œåˆä¸å¤ªå¤§çš„æ—¶å€™ï¼Œå°±ç»§ç»­å ç”¨äºŒçº§æŒ‡é’ˆi_block[13]ï¼Œè¿™æ—¶å¯ä»¥å­˜æ”¾æŒ‡é’ˆæ•°é‡ä¸º[1024/4]^2+1024/4+12=65804ï¼Œæ‰€ä»¥èƒ½å­˜æ”¾65804KB=64Må·¦å³çš„æ–‡ä»¶ã€‚</p><p>å¦‚æœå­˜æ”¾çš„æ–‡ä»¶å¤§äº64Mï¼Œé‚£ä¹ˆå°±ç»§ç»­ä½¿ç”¨ä¸‰çº§é—´æ¥æŒ‡é’ˆi_block[14]ï¼Œå­˜æ”¾çš„æŒ‡é’ˆæ•°é‡ä¸º[1024/4]^3+[1024/4]^2+[1024/4]+12=16843020ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥èƒ½å­˜æ”¾16843020KB=16GBå·¦å³çš„æ–‡ä»¶ã€‚</p><p>å¦‚æœblocksize=4KBå‘¢?é‚£ä¹ˆæœ€å¤§èƒ½å­˜æ”¾çš„æ–‡ä»¶å¤§å°ä¸º([4096/4]^3+[4096/4]^2+[4096/4]+12)*4/1024/1024/1024=4Tå·¦å³ã€‚</p><p>å½“ç„¶è¿™æ ·è®¡ç®—å‡ºæ¥çš„ä¸ä¸€å®šå°±æ˜¯æœ€å¤§èƒ½å­˜æ”¾çš„æ–‡ä»¶å¤§å°ï¼Œå®ƒè¿˜å—åˆ°å¦ä¸€ä¸ªæ¡ä»¶çš„é™åˆ¶ã€‚è¿™é‡Œçš„è®¡ç®—åªæ˜¯è¡¨æ˜ä¸€ä¸ªå¤§æ–‡ä»¶æ˜¯å¦‚ä½•å¯»å€å’Œåˆ†é…çš„ã€‚</p><p>å…¶å®çœ‹åˆ°è¿™é‡Œçš„è®¡ç®—æ•°å€¼ï¼Œå°±çŸ¥é“ext2å’Œext3å¯¹è¶…å¤§æ–‡ä»¶çš„å­˜å–æ•ˆç‡æ˜¯ä½ä¸‹çš„ï¼Œå®ƒè¦æ ¸å¯¹å¤ªå¤šçš„æŒ‡é’ˆï¼Œç‰¹åˆ«æ˜¯4KBå¤§å°çš„blocksizeæ—¶ã€‚è€Œext4é’ˆå¯¹è¿™ä¸€ç‚¹å°±è¿›è¡Œäº†ä¼˜åŒ–ï¼Œext4ä½¿ç”¨extentçš„ç®¡ç†æ–¹å¼å–ä»£ext2å’Œext3çš„å—æ˜ å°„ï¼Œå¤§å¤§æé«˜äº†æ•ˆç‡ä¹Ÿé™ä½äº†ç¢ç‰‡ã€‚</p><h3 id="6-å•æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶æ“ä½œçš„åŸç†">6.å•æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶æ“ä½œçš„åŸç†</h3><p>åœ¨Linuxä¸Šæ‰§è¡Œåˆ é™¤ã€å¤åˆ¶ã€é‡å‘½åã€ç§»åŠ¨ç­‰æ“ä½œæ—¶ï¼Œå®ƒä»¬æ˜¯æ€ä¹ˆè¿›è¡Œçš„å‘¢?è¿˜æœ‰è®¿é—®æ–‡ä»¶æ—¶æ˜¯å¦‚ä½•æ‰¾åˆ°å®ƒçš„å‘¢?å…¶å®åªè¦ç†è§£äº†å‰æ–‡ä¸­ä»‹ç»çš„å‡ ä¸ªæœ¯è¯­ä»¥åŠå®ƒä»¬çš„ä½œç”¨å°±å¾ˆå®¹æ˜“çŸ¥é“æ–‡ä»¶æ“ä½œçš„åŸç†äº†ã€‚</p><p>æ³¨ï¼šåœ¨è¿™ä¸€å°èŠ‚æ‰€è§£é‡Šçš„éƒ½æ˜¯åœ¨å•ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸‹çš„è¡Œä¸ºï¼Œåœ¨å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­å¦‚ä½•è¯·çœ‹ä¸‹ä¸€ä¸ªå°èŠ‚ï¼šå¤šæ–‡ä»¶ç³»ç»Ÿå…³è”ã€‚</p><h4 id="6-1-è¯»å–æ–‡ä»¶"><strong>6.1 è¯»å–æ–‡ä»¶</strong></h4><p>å½“æ‰§è¡Œ&quot;<strong>cat /var/log/messages</strong>&quot;å‘½ä»¤åœ¨ç³»ç»Ÿå†…éƒ¨è¿›è¡Œäº†ä»€ä¹ˆæ ·çš„æ­¥éª¤å‘¢?è¯¥å‘½ä»¤èƒ½è¢«æˆåŠŸæ‰§è¡Œæ¶‰åŠäº†catå‘½ä»¤çš„å¯»æ‰¾ã€æƒé™åˆ¤æ–­ä»¥åŠmessagesæ–‡ä»¶çš„å¯»æ‰¾å’Œæƒé™åˆ¤æ–­ç­‰ç­‰å¤æ‚çš„è¿‡ç¨‹ã€‚è¿™é‡Œåªè§£é‡Šå’Œæœ¬èŠ‚å†…å®¹ç›¸å…³çš„å¦‚ä½•å¯»æ‰¾åˆ°è¢«catçš„/var/log/messagesæ–‡ä»¶ã€‚</p><ul><li>æ‰¾åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å—ç»„æè¿°ç¬¦è¡¨æ‰€åœ¨çš„blocksï¼Œè¯»å–GDT(å·²åœ¨å†…å­˜ä¸­)æ‰¾åˆ°inode tableçš„blockå·ã€‚</li></ul><p>å› ä¸ºGDTæ€»æ˜¯å’Œsuperblockåœ¨åŒä¸€ä¸ªå—ç»„ï¼Œè€Œsuperblockæ€»æ˜¯åœ¨åˆ†åŒºçš„ç¬¬1024-2047ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±çŸ¥é“ç¬¬ä¸€ä¸ªGDTæ‰€åœ¨çš„å—ç»„ä»¥åŠGDTåœ¨è¿™ä¸ªå—ç»„ä¸­å ç”¨äº†å“ªäº›blockã€‚</p><p>å…¶å®GDTæ—©å·²ç»åœ¨å†…å­˜ä¸­äº†ï¼Œåœ¨ç³»ç»Ÿå¼€æœºçš„æ—¶å€™ä¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½çš„æ—¶å€™å°±å·²ç»å°†æ‰€æœ‰çš„GDTæ”¾è¿›å†…å­˜ä¸­ã€‚</p><ul><li>åœ¨inode tableçš„blockä¸­å®šä½åˆ°æ ¹&quot;/â€œçš„inodeï¼Œæ‰¾å‡ºâ€/&quot;æŒ‡å‘çš„data blockã€‚</li></ul><p>å‰æ–‡è¯´è¿‡ï¼Œextæ–‡ä»¶ç³»ç»Ÿé¢„ç•™äº†ä¸€äº›inodeå·ï¼Œå…¶ä¸­&quot;/&quot;çš„inodeå·ä¸º2ï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®inodeå·ç›´æ¥å®šä½æ ¹ç›®å½•æ–‡ä»¶çš„data blockã€‚</p><ul><li>åœ¨&quot;/&quot;çš„datablockä¸­è®°å½•äº†varç›®å½•åå’ŒæŒ‡å‘varç›®å½•æ–‡ä»¶inodeçš„æŒ‡é’ˆï¼Œå¹¶æ‰¾åˆ°è¯¥inodeè®°å½•ï¼Œinodeè®°å½•ä¸­å­˜å‚¨äº†æŒ‡å‘varçš„blockæŒ‡é’ˆï¼Œæ‰€ä»¥ä¹Ÿå°±æ‰¾åˆ°äº†varç›®å½•æ–‡ä»¶çš„data blockã€‚</li></ul><p>é€šè¿‡varç›®å½•çš„inodeæŒ‡é’ˆï¼Œå¯ä»¥å¯»æ‰¾åˆ°varç›®å½•çš„inodeè®°å½•ï¼Œä½†æ˜¯æŒ‡é’ˆå®šä½çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦çŸ¥é“è¯¥inodeè®°å½•æ‰€åœ¨çš„å—ç»„ä»¥åŠæ‰€åœ¨çš„inode tableï¼Œæ‰€ä»¥éœ€è¦è¯»å–GDTï¼ŒåŒæ ·ï¼ŒGDTå·²ç»ç¼“å­˜åˆ°äº†å†…å­˜ä¸­ã€‚</p><ul><li>åœ¨varçš„data blockä¸­è®°å½•äº†logç›®å½•åå’Œå…¶inodeæŒ‡é’ˆï¼Œé€šè¿‡è¯¥æŒ‡é’ˆå®šä½åˆ°è¯¥inodeæ‰€åœ¨çš„å—ç»„åŠæ‰€åœ¨çš„inode tableï¼Œå¹¶æ ¹æ®è¯¥inodeè®°å½•æ‰¾åˆ°logçš„data blockã€‚</li><li>åœ¨logç›®å½•æ–‡ä»¶çš„data blockä¸­è®°å½•äº†messagesæ–‡ä»¶åå’Œå¯¹åº”çš„inodeæŒ‡é’ˆï¼Œé€šè¿‡è¯¥æŒ‡é’ˆå®šä½åˆ°è¯¥inodeæ‰€åœ¨çš„å—ç»„åŠæ‰€åœ¨çš„inode tableï¼Œå¹¶æ ¹æ®è¯¥inodeè®°å½•æ‰¾åˆ°messagesçš„data blockã€‚</li><li>æœ€åè¯»å–messageså¯¹åº”çš„datablockã€‚</li></ul><p>å°†ä¸Šè¿°æ­¥éª¤ä¸­GDTéƒ¨åˆ†çš„æ­¥éª¤ç®€åŒ–åæ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚å¦‚ä¸‹:<strong>æ‰¾åˆ°GDTâ€“&gt;æ‰¾åˆ°&quot;/&quot;çš„inodeâ€“&gt;æ‰¾åˆ°/çš„æ•°æ®å—è¯»å–varçš„inodeâ€“&gt;æ‰¾åˆ°varçš„æ•°æ®å—è¯»å–logçš„inodeâ€“&gt;æ‰¾åˆ°logçš„æ•°æ®å—è¯»å–messagesçš„inodeâ€“&gt;æ‰¾åˆ°messagesçš„æ•°æ®å—å¹¶è¯»å–å®ƒä»¬ã€‚</strong></p><h4 id="6-2-åˆ é™¤ã€é‡å‘½åå’Œç§»åŠ¨æ–‡ä»¶">6.2 åˆ é™¤ã€é‡å‘½åå’Œç§»åŠ¨æ–‡ä»¶</h4><p>æ³¨æ„è¿™é‡Œæ˜¯ä¸è·¨è¶Šæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œè¡Œä¸ºã€‚</p><ul><li><strong>åˆ é™¤æ–‡ä»¶åˆ†ä¸ºæ™®é€šæ–‡ä»¶å’Œç›®å½•æ–‡ä»¶</strong>ï¼ŒçŸ¥é“äº†è¿™ä¸¤ç§ç±»å‹çš„æ–‡ä»¶çš„åˆ é™¤åŸç†ï¼Œå°±çŸ¥é“äº†å…¶ä»–ç±»å‹ç‰¹æ®Šæ–‡ä»¶çš„åˆ é™¤æ–¹æ³•ã€‚</li></ul><p>å¯¹äºåˆ é™¤æ™®é€šæ–‡ä»¶ï¼š</p><p>(1) æ‰¾åˆ°æ–‡ä»¶çš„inodeå’Œdata block(æ ¹æ®å‰ä¸€ä¸ªå°èŠ‚ä¸­çš„æ–¹æ³•å¯»æ‰¾);</p><p>(2) å°†inode tableä¸­è¯¥inodeè®°å½•ä¸­çš„data blockæŒ‡é’ˆåˆ é™¤;</p><p>(3) åœ¨imapä¸­å°†è¯¥æ–‡ä»¶çš„inodeå·æ ‡è®°ä¸ºæœªä½¿ç”¨;</p><p>(4) åœ¨å…¶æ‰€åœ¨ç›®å½•çš„data blockä¸­å°†è¯¥æ–‡ä»¶åæ‰€åœ¨çš„è®°å½•è¡Œåˆ é™¤ï¼Œåˆ é™¤äº†è®°å½•å°±ä¸¢å¤±äº†æŒ‡å‘inodeçš„æŒ‡é’ˆ;</p><p>(5) å°†bmapä¸­data blockå¯¹åº”çš„blockå·æ ‡è®°ä¸ºæœªä½¿ç”¨ã€‚</p><p>å¯¹äºåˆ é™¤ç›®å½•æ–‡ä»¶ï¼šæ‰¾åˆ°ç›®å½•å’Œç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ã€å­ç›®å½•ã€å­æ–‡ä»¶çš„inodeå’Œdata block;åœ¨imapä¸­å°†è¿™äº›inodeå·æ ‡è®°ä¸ºæœªä½¿ç”¨;å°†bmapä¸­å°†è¿™äº›æ–‡ä»¶å ç”¨çš„ blockå·æ ‡è®°ä¸ºæœªä½¿ç”¨;åœ¨è¯¥ç›®å½•çš„çˆ¶ç›®å½•çš„data blockä¸­å°†è¯¥ç›®å½•åæ‰€åœ¨çš„è®°å½•è¡Œåˆ é™¤ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ é™¤çˆ¶ç›®å½•data blockä¸­çš„è®°å½•æ˜¯æœ€åä¸€æ­¥ï¼Œå¦‚æœè¯¥æ­¥éª¤æå‰ï¼Œå°†æŠ¥ç›®å½•éç©ºçš„é”™è¯¯ï¼Œå› ä¸ºåœ¨è¯¥ç›®å½•ä¸­è¿˜æœ‰æ–‡ä»¶å ç”¨ã€‚</p><p>å…³äºä¸Šé¢çš„(2)-(5)ï¼šå½“(2)ä¸­åˆ é™¤data blockæŒ‡é’ˆåï¼Œå°†æ— æ³•å†æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶çš„æ•°æ®;å½“(3)æ ‡è®°inodeå·æœªä½¿ç”¨ï¼Œè¡¨ç¤ºè¯¥inodeå·å¯ä»¥è¢«åç»­çš„æ–‡ä»¶é‡ç”¨;å½“(4)åˆ é™¤ç›®å½•data blockä¸­å…³äºè¯¥æ–‡ä»¶çš„è®°å½•ï¼ŒçœŸæ­£çš„åˆ é™¤æ–‡ä»¶ï¼Œå¤–ç•Œå†ä¹Ÿå®šä½ä¹Ÿæ— æ³•çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶äº†;å½“(5)æ ‡è®°data blockä¸ºæœªä½¿ç”¨åï¼Œè¡¨ç¤ºå¼€å§‹é‡Šæ”¾ç©ºé—´ï¼Œè¿™äº›data blockå¯ä»¥è¢«å…¶ä»–æ–‡ä»¶é‡ç”¨ã€‚</p><p>æ³¨æ„ï¼Œåœ¨ç¬¬(5)æ­¥ä¹‹å‰ï¼Œç”±äºdata blockè¿˜æœªè¢«æ ‡è®°ä¸ºæœªä½¿ç”¨ï¼Œåœ¨superblockä¸­ä»ç„¶è®¤ä¸ºè¿™äº›data blockæ˜¯æ­£åœ¨ä½¿ç”¨ä¸­çš„ã€‚è¿™è¡¨ç¤ºå°½ç®¡æ–‡ä»¶å·²ç»è¢«åˆ é™¤äº†ï¼Œä½†ç©ºé—´å´è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œdfä¹Ÿä¼šå°†å…¶ç»Ÿè®¡åˆ°å·²ç”¨ç©ºé—´ä¸­(dfæ˜¯è¯»å–superblockä¸­çš„æ•°æ®å—æ•°é‡ï¼Œå¹¶è®¡ç®—è½¬æ¢ä¸ºç©ºé—´å¤§å°)ã€‚</p><p>ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µå‘¢?å½“ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨å¼•ç”¨æ–‡ä»¶æ—¶å°†è¯¥æ–‡ä»¶åˆ é™¤ï¼Œå°±ä¼šå‡ºç°æ–‡ä»¶å·²åˆ é™¤ä½†ç©ºé—´æœªé‡Šæ”¾çš„æƒ…å†µã€‚è¿™æ—¶æ­¥éª¤å·²ç»è¿›è¡Œåˆ°(4)ï¼Œå¤–ç•Œæ— æ³•å†æ‰¾åˆ°è¯¥æ–‡ä»¶ï¼Œä½†ç”±äºè¿›ç¨‹åœ¨åŠ è½½è¯¥æ–‡ä»¶æ—¶å·²ç»è·å–åˆ°äº†è¯¥æ–‡ä»¶æ‰€æœ‰çš„data blockæŒ‡é’ˆï¼Œè¯¥è¿›ç¨‹å¯ä»¥è·å–åˆ°è¯¥æ–‡ä»¶çš„æ‰€æœ‰æ•°æ®ï¼Œä½†å´æš‚æ—¶ä¸ä¼šé‡Šæ”¾è¯¥æ–‡ä»¶ç©ºé—´ã€‚ç›´åˆ°è¯¥è¿›ç¨‹ç»“æŸï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰å°†æœªæ‰§è¡Œçš„æ­¥éª¤(5)ç»§ç»­å®Œæˆã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™duçš„ç»Ÿè®¡ç»“æœæ¯”dfå°çš„åŸå› ï¼Œå…³äºduå’Œdfç»Ÿè®¡ç»“æœçš„å·®åˆ«ï¼Œè¯¦ç»†å†…å®¹è§ï¼šè¯¦ç»†åˆ†æduå’Œdfçš„ç»Ÿè®¡ç»“æœä¸ºä»€ä¹ˆä¸ä¸€æ ·ã€‚</p><ul><li>é‡å‘½åæ–‡ä»¶åˆ†ä¸ºåŒç›®å½•å†…é‡å‘½åå’ŒéåŒç›®å½•å†…é‡å‘½åã€‚éåŒç›®å½•å†…é‡å‘½åå®é™…ä¸Šæ˜¯ç§»åŠ¨æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œè§ä¸‹æ–‡ã€‚</li></ul><p>åŒç›®å½•å†…é‡å‘½åæ–‡ä»¶çš„åŠ¨ä½œä»…ä»…åªæ˜¯ä¿®æ”¹æ‰€åœ¨ç›®å½•data blockä¸­è¯¥æ–‡ä»¶è®°å½•çš„æ–‡ä»¶åéƒ¨åˆ†ï¼Œä¸æ˜¯åˆ é™¤å†é‡å»ºçš„è¿‡ç¨‹ã€‚</p><p>å¦‚æœé‡å‘½åæ—¶æœ‰æ–‡ä»¶åå†²çª(è¯¥ç›®å½•å†…å·²ç»å­˜åœ¨è¯¥æ–‡ä»¶å)ï¼Œåˆ™æç¤ºæ˜¯å¦è¦†ç›–ã€‚è¦†ç›–çš„è¿‡ç¨‹æ˜¯è¦†ç›–ç›®å½•data blockä¸­å†²çªæ–‡ä»¶çš„è®°å½•ã€‚ä¾‹å¦‚/tmp/ä¸‹æœ‰a.txtå’Œa.logï¼Œè‹¥å°†a.txté‡å‘½åä¸ºa.logï¼Œåˆ™æç¤ºè¦†ç›–ï¼Œè‹¥é€‰æ‹©è¦†ç›–ï¼Œåˆ™/tmpçš„data blockä¸­å…³äºa.logçš„è®°å½•è¢«è¦†ç›–ï¼Œæ­¤æ—¶å®ƒçš„æŒ‡é’ˆæ˜¯æŒ‡å‘a.txtçš„inodeã€‚</p><ul><li>ç§»åŠ¨æ–‡ä»¶</li></ul><p>åŒæ–‡ä»¶ç³»ç»Ÿä¸‹ç§»åŠ¨æ–‡ä»¶å®é™…ä¸Šæ˜¯ä¿®æ”¹ç›®æ ‡æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„data blockï¼Œå‘å…¶ä¸­æ·»åŠ ä¸€è¡ŒæŒ‡å‘inode tableä¸­å¾…ç§»åŠ¨æ–‡ä»¶çš„inodeæŒ‡é’ˆï¼Œå¦‚æœç›®æ ‡è·¯å¾„ä¸‹æœ‰åŒåæ–‡ä»¶ï¼Œåˆ™ä¼šæç¤ºæ˜¯å¦è¦†ç›–ï¼Œå®é™…ä¸Šæ˜¯è¦†ç›–ç›®å½•data blockä¸­å†²çªæ–‡ä»¶çš„è®°å½•ï¼Œç”±äºåŒåæ–‡ä»¶çš„inodeè®°å½•æŒ‡é’ˆè¢«è¦†ç›–ï¼Œæ‰€ä»¥æ— æ³•å†æ‰¾åˆ°è¯¥æ–‡ä»¶çš„data blockï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ–‡ä»¶è¢«æ ‡è®°ä¸ºåˆ é™¤(å¦‚æœå¤šä¸ªç¡¬é“¾æ¥æ•°ï¼Œåˆ™å¦å½“åˆ«è®º)ã€‚</p><p>æ‰€ä»¥åœ¨åŒæ–‡ä»¶ç³»ç»Ÿå†…ç§»åŠ¨æ–‡ä»¶ç›¸å½“å¿«ï¼Œä»…ä»…åœ¨æ‰€åœ¨ç›®å½•data blockä¸­æ·»åŠ æˆ–è¦†ç›–äº†ä¸€æ¡è®°å½•è€Œå·²ã€‚ä¹Ÿå› æ­¤ï¼Œç§»åŠ¨æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶çš„inodeå·æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚</p><p>å¯¹äºä¸åŒæ–‡ä»¶ç³»ç»Ÿå†…çš„ç§»åŠ¨ï¼Œç›¸å½“äºå…ˆå¤åˆ¶å†åˆ é™¤çš„åŠ¨ä½œã€‚è§åæ–‡ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426113825639.png" alt="image-20240426113825639"></p><p>å…³äºæ–‡ä»¶ç§»åŠ¨ï¼Œåœ¨Linuxç¯å¢ƒä¸‹æœ‰ä¸€ä¸ªéå¸¸ç»å…¸ç½‘ä¸Šå´åˆæ²¡ä»»ä½•è§£é‡Šçš„é—®é¢˜ï¼š/tmp/a/aèƒ½è¦†ç›–ä¸º/tmp/aå—?ç­”æ¡ˆæ˜¯ä¸èƒ½ï¼Œä½†windowsèƒ½ã€‚ä¸ºä»€ä¹ˆä¸èƒ½?è§mvçš„ä¸€ä¸ªç»å…¸é—®é¢˜(mvçš„æœ¬è´¨)ã€‚</p><h4 id="6-3-å­˜å‚¨å’Œå¤åˆ¶æ–‡ä»¶">6.3 å­˜å‚¨å’Œå¤åˆ¶æ–‡ä»¶</h4><ul><li>å¯¹äºæ–‡ä»¶å­˜å‚¨</li><li>(1).è¯»å–GDTï¼Œæ‰¾åˆ°å„ä¸ª(æˆ–éƒ¨åˆ†)å—ç»„imapä¸­æœªä½¿ç”¨çš„inodeå·ï¼Œå¹¶ä¸ºå¾…å­˜å‚¨æ–‡ä»¶åˆ†é…inodeå·;</li><li>(2).åœ¨inode tableä¸­å®Œå–„è¯¥inodeå·æ‰€åœ¨è¡Œçš„è®°å½•;</li><li>(3).åœ¨ç›®å½•çš„data blockä¸­æ·»åŠ ä¸€æ¡è¯¥æ–‡ä»¶çš„ç›¸å…³è®°å½•;</li><li>(4).å°†æ•°æ®å¡«å……åˆ°data blockä¸­ã€‚</li><li>æ³¨æ„ï¼Œå¡«å……åˆ°data blockä¸­çš„æ—¶å€™ä¼šè°ƒç”¨blockåˆ†é…å™¨ï¼šä¸€æ¬¡åˆ†é…4KBå¤§å°çš„blockæ•°é‡ï¼Œå½“å¡«å……å®Œ4KBçš„data blockåä¼šç»§ç»­è°ƒç”¨blockåˆ†é…å™¨åˆ†é…4KBçš„blockï¼Œç„¶åå¾ªç¯ç›´åˆ°å¡«å……å®Œæ‰€æœ‰æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå­˜å‚¨ä¸€ä¸ª100Mçš„æ–‡ä»¶éœ€è¦è°ƒç”¨blockåˆ†é…å™¨100*1024/4=25600æ¬¡ã€‚</li><li>å¦ä¸€æ–¹é¢ï¼Œåœ¨blockåˆ†é…å™¨åˆ†é…blockæ—¶ï¼Œblockåˆ†é…å™¨å¹¶ä¸çŸ¥é“çœŸæ­£æœ‰å¤šå°‘blockè¦åˆ†é…ï¼Œåªæ˜¯æ¯æ¬¡éœ€è¦åˆ†é…æ—¶å°±åˆ†é…ï¼Œåœ¨æ¯å­˜å‚¨ä¸€ä¸ªdata blockå‰ï¼Œå°±å»bmapä¸­æ ‡è®°ä¸€æ¬¡è¯¥blockå·²ä½¿ç”¨ï¼Œå®ƒæ— æ³•å®ç°ä¸€æ¬¡æ ‡è®°å¤šä¸ªbmapä½ã€‚è¿™ä¸€ç‚¹åœ¨ext4ä¸­è¿›è¡Œäº†ä¼˜åŒ–ã€‚</li><li>(5)å¡«å……å®Œä¹‹åï¼Œå»inode tableä¸­æ›´æ–°è¯¥æ–‡ä»¶inodeè®°å½•ä¸­æŒ‡å‘data blockçš„å¯»å€æŒ‡é’ˆã€‚</li><li>å¯¹äºå¤åˆ¶ï¼Œå®Œå…¨å°±æ˜¯å¦ä¸€ç§æ–¹å¼çš„å­˜å‚¨æ–‡ä»¶ã€‚æ­¥éª¤å’Œå­˜å‚¨æ–‡ä»¶çš„æ­¥éª¤ä¸€æ ·ã€‚</li></ul><h3 id="7-å¤šæ–‡ä»¶ç³»ç»Ÿå…³è”">7.å¤šæ–‡ä»¶ç³»ç»Ÿå…³è”</h3><p>åœ¨å•ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æ“ä½œå’Œå¤šæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ“ä½œæœ‰æ‰€ä¸åŒã€‚æœ¬æ–‡å°†å¯¹æ­¤åšå‡ºéå¸¸è¯¦ç»†çš„è¯´æ˜ã€‚</p><h4 id="7-1-æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ®Šæ€§">7.1 æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ®Šæ€§</h4><p>è¿™é‡Œè¦æ˜ç¡®çš„æ˜¯ï¼Œä»»ä½•ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè¦åœ¨Linuxä¸Šèƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå¿…é¡»æŒ‚è½½åœ¨æŸä¸ªå·²ç»æŒ‚è½½å¥½çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„æŸä¸ªç›®å½•ä¸‹ï¼Œä¾‹å¦‚/dev/cdromæŒ‚è½½åœ¨/mntä¸Šï¼Œ/mntç›®å½•æœ¬èº«æ˜¯åœ¨&quot;/â€œæ–‡ä»¶ç³»ç»Ÿä¸‹çš„ã€‚è€Œä¸”ä»»æ„æ–‡ä»¶ç³»ç»Ÿçš„ä¸€çº§æŒ‚è½½ç‚¹å¿…é¡»æ˜¯åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŸä¸ªç›®å½•ä¸‹ï¼Œå› ä¸ºåªæœ‰â€/&quot;æ˜¯è‡ªå¼•ç”¨çš„ã€‚è¿™é‡Œè¦è¯´æ˜æŒ‚è½½ç‚¹çš„çº§åˆ«å’Œè‡ªå¼•ç”¨çš„æ¦‚å¿µã€‚</p><p>å‡å¦‚/dev/sdb1æŒ‚è½½åœ¨/mydataä¸Šï¼Œ/dev/cdromæŒ‚è½½åœ¨/mydata/cdromä¸Šï¼Œé‚£ä¹ˆ/mydataå°±æ˜¯ä¸€çº§æŒ‚è½½ç‚¹ï¼Œæ­¤æ—¶/mydataå·²ç»æ˜¯æ–‡ä»¶ç³»ç»Ÿ/dev/sdb1çš„å…¥å£äº†ï¼Œè€Œ/dev/cdromæ‰€æŒ‚è½½çš„ç›®å½•/mydata/cdromæ˜¯æ–‡ä»¶ç³»ç»Ÿ/dev/sdb1ä¸­çš„æŸä¸ªç›®å½•ï¼Œé‚£ä¹ˆ/mydata/cdromå°±æ˜¯äºŒçº§æŒ‚è½½ç‚¹ã€‚ä¸€çº§æŒ‚è½½ç‚¹å¿…é¡»åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸‹ï¼Œæ‰€ä»¥å¯ç®€è¿°ä¸ºï¼šæ–‡ä»¶ç³»ç»Ÿ2æŒ‚è½½åœ¨æ–‡ä»¶ç³»ç»Ÿ1ä¸­çš„æŸä¸ªç›®å½•ä¸‹ï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿ1åˆæŒ‚è½½åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„æŸä¸ªç›®å½•ä¸‹ã€‚</p><p>å†è§£é‡Šè‡ªå¼•ç”¨ã€‚é¦–å…ˆè¦è¯´çš„æ˜¯ï¼Œè‡ªå¼•ç”¨çš„åªèƒ½æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿè¡¨ç°å½¢å¼æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ‰€ä»¥è‡ªå¼•ç”¨æ˜¯æŒ‡è¯¥ç›®å½•çš„data blockä¸­ï¼Œ&quot;.â€œå’Œâ€â€¦&quot;çš„è®°å½•ä¸­çš„inodeæŒ‡é’ˆéƒ½æŒ‡å‘inode tableä¸­åŒä¸€ä¸ªinodeè®°å½•ï¼Œæ‰€ä»¥å®ƒä»¬inodeå·æ˜¯ç›¸åŒçš„ï¼Œå³äº’ä¸ºç¡¬é“¾æ¥ã€‚è€Œæ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯å”¯ä¸€å¯ä»¥è‡ªå¼•ç”¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi /]<span class="comment"># ll -ai / </span></span><br><span class="line">total 102 </span><br><span class="line"> 2 dr-xr-xr-x. 22 root root 4096 Jun 6 18:13 . </span><br><span class="line"> 2 dr-xr-xr-x. 22 root root 4096 Jun 6 18:13 ..  </span><br></pre></td></tr></table></figure><p>ç”±æ­¤ä¹Ÿèƒ½è§£é‡Šcd /.å’Œcd /â€¦çš„ç»“æœéƒ½è¿˜æ˜¯åœ¨æ ¹ä¸‹ï¼Œè¿™æ˜¯è‡ªå¼•ç”¨æœ€ç›´æ¥çš„è¡¨ç°å½¢å¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi tmp]<span class="comment"># cd /. </span></span><br><span class="line">[root@xuexi /]<span class="comment"># </span></span><br><span class="line">[root@xuexi tmp]<span class="comment"># cd /.. </span></span><br><span class="line">[root@xuexi /]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œæ ¹ç›®å½•ä¸‹çš„&quot;.â€œå’Œâ€â€¦â€œéƒ½æ˜¯â€/â€œç›®å½•çš„ç¡¬é“¾æ¥ï¼Œä¸”å…¶datablockä¸­ä¸è®°å½•åä¸ºâ€/&quot;çš„æ¡ç›®ï¼Œå› æ­¤é™¤å»æ ¹ç›®å½•ä¸‹å­ç›®å½•æ•°åçš„ç¡¬é“¾æ¥æ•°ä¸º2ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server2 tmp]<span class="comment"># a=$(ls -ld / | awk &#x27;&#123;print $2&#125;&#x27;) </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># b=$(ls -l / | grep &quot;^d&quot; |wc -l) </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># echo $((a - b)) </span></span><br><span class="line">2</span><br></pre></td></tr></table></figure><h4 id="7-2-æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„ç»†èŠ‚">7.2 æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„ç»†èŠ‚</h4><p>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿåˆ°æŸä¸ªç›®å½•ä¸‹ï¼Œä¾‹å¦‚&quot;mount /dev/cdrom /mnt&quot;ï¼ŒæŒ‚è½½æˆåŠŸå/mntç›®å½•ä¸­çš„æ–‡ä»¶å…¨éƒ½æš‚æ—¶ä¸å¯è§äº†ï¼Œä¸”æŒ‚è½½åæƒé™å’Œæ‰€æœ‰è€…(å¦‚æœæŒ‡å®šå…è®¸æ™®é€šç”¨æˆ·æŒ‚è½½)ç­‰çš„éƒ½æ”¹å˜äº†ï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆå—?</p><p>ä¸‹é¢å°±ä»¥é€šè¿‡&quot;mount /dev/cdrom /mnt&quot;ä¸ºä¾‹ï¼Œè¯¦ç»†è¯´æ˜æŒ‚è½½è¿‡ç¨‹ä¸­æ¶‰åŠçš„ç»†èŠ‚ã€‚</p><p>åœ¨å°†æ–‡ä»¶ç³»ç»Ÿ/dev/cdrom(æ­¤å¤„æš‚ä¸”è®¤ä¸ºå®ƒæ˜¯æ–‡ä»¶ç³»ç»Ÿ)æŒ‚è½½åˆ°æŒ‚è½½ç‚¹/mntä¹‹å‰ï¼ŒæŒ‚è½½ç‚¹/mntæ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªç›®å½•ï¼Œ&quot;/&quot;çš„data blockä¸­è®°å½•äº†/mntçš„ä¸€äº›ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬inodeæŒ‡é’ˆinode_nï¼Œè€Œåœ¨inode tableä¸­ï¼Œ/mntå¯¹åº”çš„inodeè®°å½•ä¸­åˆå­˜å‚¨äº†blockæŒ‡é’ˆblock_nï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªæŒ‡é’ˆè¿˜æ˜¯æ™®é€šçš„æŒ‡é’ˆã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426131810028.png" alt="image-20240426131810028"></p><p>å½“æ–‡ä»¶ç³»ç»Ÿ/dev/cdromæŒ‚è½½åˆ°/mntä¸Šåï¼Œ/mntæ­¤æ—¶å°±å·²ç»æˆä¸ºå¦ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å…¥å£äº†ï¼Œå› æ­¤å®ƒéœ€è¦è¿æ¥ä¸¤è¾¹æ–‡ä»¶ç³»ç»Ÿçš„inodeå’Œdata blockã€‚ä½†æ˜¯å¦‚ä½•è¿æ¥å‘¢ï¼Ÿå¦‚ä¸‹å›¾ã€‚ã€å¥½å›¾ã€‘</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426131959318.png" alt="image-20240426131959318"></p><p>åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„inode tableä¸­ï¼Œä¸º/mnté‡æ–°åˆ†é…ä¸€ä¸ªinodeè®°å½•mï¼Œè¯¥è®°å½•çš„blockæŒ‡é’ˆblock_mæŒ‡å‘æ–‡ä»¶ç³»ç»Ÿ/dev/cdromä¸­çš„data blockã€‚æ—¢ç„¶ä¸º/mntåˆ†é…äº†æ–°çš„inodeè®°å½•mï¼Œé‚£ä¹ˆåœ¨&quot;/&quot;ç›®å½•çš„data blockä¸­ï¼Œä¹Ÿéœ€è¦ä¿®æ”¹å…¶inodeæŒ‡é’ˆä¸ºinode_mä»¥æŒ‡å‘mè®°å½•ã€‚åŒæ—¶ï¼ŒåŸæ¥inode tableä¸­çš„inodeè®°å½•nå°±è¢«æ ‡è®°ä¸ºæš‚æ—¶ä¸å¯ç”¨ã€‚</p><p>block_mæŒ‡å‘çš„æ˜¯æ–‡ä»¶ç³»ç»Ÿ/dev/cdromçš„data blockï¼Œæ‰€ä»¥ä¸¥æ ¼è¯´èµ·æ¥ï¼Œé™¤äº†/mntçš„å…ƒæ•°æ®ä¿¡æ¯å³inodeè®°å½•mè¿˜åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œ/mntçš„data blockå·²ç»æ˜¯åœ¨/dev/cdromä¸­çš„äº†ã€‚è¿™å°±æ˜¯æŒ‚è½½æ–°æ–‡ä»¶ç³»ç»Ÿåå®ç°çš„è·¨æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå°†æŒ‚è½½ç‚¹çš„å…ƒæ•°æ®ä¿¡æ¯å’Œæ•°æ®ä¿¡æ¯åˆ†åˆ«å­˜å‚¨åœ¨ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¸Šã€‚</p><p>æŒ‚è½½å®Œæˆåï¼Œå°†åœ¨/proc/self/{mounts,mountstats,mountinfo}è¿™ä¸‰ä¸ªæ–‡ä»¶ä¸­å†™å…¥æŒ‚è½½è®°å½•å’Œç›¸å…³çš„æŒ‚è½½ä¿¡æ¯ï¼Œå¹¶ä¼šå°†/proc/self/mountsä¸­çš„ä¿¡æ¯åŒæ­¥åˆ°/etc/mtabæ–‡ä»¶ä¸­ï¼Œå½“ç„¶ï¼Œå¦‚æœæŒ‚è½½æ—¶åŠ äº†-nå‚æ•°ï¼Œå°†ä¸ä¼šåŒæ­¥åˆ°/etc/mtabã€‚</p><p>è€Œå¸è½½æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶å®è´¨æ˜¯ç§»é™¤ä¸´æ—¶æ–°å»ºçš„inodeè®°å½•(å½“ç„¶ï¼Œåœ¨ç§»é™¤å‰ä¼šæ£€æŸ¥æ˜¯å¦æ­£åœ¨ä½¿ç”¨)åŠå…¶æŒ‡é’ˆï¼Œå¹¶å°†æŒ‡é’ˆæŒ‡å›åŸæ¥çš„inodeè®°å½•ï¼Œè¿™æ ·inodeè®°å½•ä¸­çš„blockæŒ‡é’ˆä¹Ÿå°±åŒæ—¶ç”Ÿæ•ˆè€Œæ‰¾å›å¯¹åº”çš„data blockäº†ã€‚ç”±äºå¸è½½åªæ˜¯ç§»é™¤inodeè®°å½•ï¼Œæ‰€ä»¥ä½¿ç”¨æŒ‚è½½ç‚¹å’Œæ–‡ä»¶ç³»ç»Ÿéƒ½å¯ä»¥å®ç°å¸è½½ï¼Œå› ä¸ºå®ƒä»¬æ˜¯è”ç³»åœ¨ä¸€èµ·çš„ã€‚</p><p>ä¸‹é¢æ˜¯åˆ†ææˆ–ç»“è®º</p><p>(1).æŒ‚è½½ç‚¹æŒ‚è½½æ—¶çš„inodeè®°å½•æ˜¯æ–°åˆ†é…çš„ã€‚</p><p># æŒ‚è½½å‰æŒ‚è½½ç‚¹/mntçš„inodeå·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server2 tmp]<span class="comment"># ll -id /mnt </span></span><br><span class="line">100663447 drwxr-xr-x. 2 root root 6 Aug 12 2015 /mnt </span><br><span class="line">[root@server2 tmp]<span class="comment"># mount /dev/cdrom /mnt </span></span><br><span class="line"><span class="comment"># æŒ‚è½½åæŒ‚è½½ç‚¹çš„inodeå· </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># ll -id /mnt  </span></span><br><span class="line">1856 dr-xr-xr-x 8 root root 2048 Dec 10 2015 mnt </span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯ä»¥éªŒè¯ï¼Œinodeå·ç¡®å®æ˜¯é‡æ–°åˆ†é…çš„ã€‚</p><p>(2).æŒ‚è½½åï¼ŒæŒ‚è½½ç‚¹çš„å†…å®¹å°†æš‚æ—¶ä¸å¯è§ã€ä¸å¯ç”¨ï¼Œå¸è½½åæ–‡ä»¶åˆå†æ¬¡å¯è§ã€å¯ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨æŒ‚è½½å‰ï¼Œå‘æŒ‚è½½ç‚¹ä¸­åˆ›å»ºå‡ ä¸ªæ–‡ä»¶ </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># touch /mnt/a.txt </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># mkdir /mnt/abcdir </span></span><br><span class="line"><span class="comment"># æŒ‚è½½ </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># mount /dev/cdrom /mnt </span></span><br><span class="line"><span class="comment"># æŒ‚è½½åï¼ŒæŒ‚è½½ç‚¹ä¸­å°†æ‰¾ä¸åˆ°åˆšåˆ›å»ºçš„æ–‡ä»¶ </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># ll /mnt </span></span><br><span class="line">total 636 </span><br><span class="line">-r--r--r-- 1 root root 14 Dec 10 2015 CentOS_BuildTag </span><br><span class="line">dr-xr-xr-x 3 root root 2048 Dec 10 2015 EFI </span><br><span class="line">-r--r--r-- 1 root root 215 Dec 10 2015 EULA </span><br><span class="line">-r--r--r-- 1 root root 18009 Dec 10 2015 GPL </span><br><span class="line">dr-xr-xr-x 3 root root 2048 Dec 10 2015 images </span><br><span class="line">dr-xr-xr-x 2 root root 2048 Dec 10 2015 isolinux </span><br><span class="line">dr-xr-xr-x 2 root root 2048 Dec 10 2015 LiveOS </span><br><span class="line">dr-xr-xr-x 2 root root 612352 Dec 10 2015 Packages </span><br><span class="line">dr-xr-xr-x 2 root root 4096 Dec 10 2015 repodata </span><br><span class="line">-r--r--r-- 1 root root 1690 Dec 10 2015 RPM-GPG-KEY-CentOS-7 </span><br><span class="line">-r--r--r-- 1 root root 1690 Dec 10 2015 RPM-GPG-KEY-CentOS-Testing-7 </span><br><span class="line">-r--r--r-- 1 root root 2883 Dec 10 2015 TRANS.TBL </span><br><span class="line"><span class="comment"># å¸è½½åï¼ŒæŒ‚è½½ç‚¹/mntä¸­çš„æ–‡ä»¶å°†å†æ¬¡å¯è§ </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># umount /mnt </span></span><br><span class="line">[root@server2 tmp]<span class="comment"># ll /mnt </span></span><br><span class="line">total 0 </span><br><span class="line">drwxr-xr-x 2 root root 6 Jun 9 08:18 abcdir </span><br><span class="line">-rw-r--r-- 1 root root 0 Jun 9 08:18 a.txt </span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥ä¼šè¿™æ ·ï¼Œæ˜¯å› ä¸ºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿåï¼ŒæŒ‚è½½ç‚¹åŸæ¥çš„inodeè®°å½•æš‚æ—¶è¢«æ ‡è®°ä¸ºä¸å¯ç”¨ï¼Œå…³é”®æ˜¯æ²¡æœ‰æŒ‡å‘è¯¥inodeè®°å½•çš„inodeæŒ‡é’ˆäº†ã€‚åœ¨å¸è½½æ–‡ä»¶ç³»ç»Ÿåï¼Œåˆé‡æ–°å¯ç”¨æŒ‚è½½ç‚¹åŸæ¥çš„inodeè®°å½•ï¼Œ&quot;/&quot;ç›®å½•ä¸‹çš„mntçš„inodeæŒ‡é’ˆåˆé‡æ–°æŒ‡å‘è¯¥inodeè®°å½•ã€‚</p><p>(3).æŒ‚è½½åï¼ŒæŒ‚è½½ç‚¹çš„å…ƒæ•°æ®å’Œdata blockæ˜¯åˆ†åˆ«å­˜æ”¾åœ¨ä¸åŒæ–‡ä»¶ç³»ç»Ÿä¸Šçš„ã€‚</p><p>(4).æŒ‚è½½ç‚¹å³ä½¿åœ¨æŒ‚è½½åï¼Œä¹Ÿè¿˜æ˜¯å±äºæºæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ã€‚</p><h4 id="7-3-å¤šæ–‡ä»¶ç³»ç»Ÿæ“ä½œå…³è”">7.3 å¤šæ–‡ä»¶ç³»ç»Ÿæ“ä½œå…³è”</h4><p>å‡å¦‚ä¸‹å›¾ä¸­çš„åœ†ä»£è¡¨ä¸€å—ç¡¬ç›˜ï¼Œå…¶ä¸­åˆ’åˆ†äº†3ä¸ªåŒºå³3ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚å…¶ä¸­æ ¹æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œ/mntæ˜¯å¦ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸAçš„å…¥å£ï¼ŒAæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨/mntä¸Šï¼Œ/mnt/cdromä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸBçš„å…¥å£ï¼ŒBæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨/mnt/cdromä¸Šã€‚æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½ç»´æŠ¤äº†ä¸€äº›inode tableï¼Œè¿™é‡Œå‡è®¾å›¾ä¸­çš„inode tableæ˜¯æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæ‰€æœ‰å—ç»„ä¸­çš„inode tableçš„é›†åˆè¡¨ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426132902871.png" alt="image-20240426132902871"></p><p>å¦‚ä½•è¯»å–/var/log/messageså‘¢?è¿™æ˜¯å’Œ&quot;/&quot;åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶è¯»å–ï¼Œåœ¨å‰é¢å•æ–‡ä»¶ç³»ç»Ÿä¸­å·²ç»è¯¦ç»†è¯´æ˜äº†ã€‚</p><p>ä½†å¦‚ä½•è¯»å–Aæ–‡ä»¶ç³»ç»Ÿä¸­çš„/mnt/a.logå‘¢?é¦–å…ˆï¼Œä»æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰¾åˆ°/mntçš„inodeè®°å½•ï¼Œè¿™æ˜¯å•æ–‡ä»¶ç³»ç»Ÿå†…çš„æŸ¥æ‰¾;ç„¶åæ ¹æ®æ­¤inodeè®°å½•çš„blockæŒ‡é’ˆï¼Œå®šä½åˆ°/mntçš„data blockä¸­ï¼Œè¿™äº›blockæ˜¯Aæ–‡ä»¶ç³»ç»Ÿçš„data block;ç„¶åä»/mntçš„data blockä¸­è¯»å–a.logè®°å½•ï¼Œå¹¶æ ¹æ®a.logçš„inodeæŒ‡é’ˆå®šä½åˆ°Aæ–‡ä»¶ç³»ç»Ÿçš„inode tableä¸­å¯¹åº”a.logçš„inodeè®°å½•;æœ€åä»æ­¤inodeè®°å½•çš„blockæŒ‡é’ˆæ‰¾åˆ°a.logçš„data blockã€‚è‡³æ­¤ï¼Œå°±èƒ½è¯»å–åˆ°/mnt/a.logæ–‡ä»¶çš„å†…å®¹ã€‚</p><p>ä¸‹å›¾èƒ½æ›´å®Œæ•´çš„æè¿°ä¸Šè¿°è¿‡ç¨‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133033004.png" alt="image-20240426133033004"></p><p>é‚£ä¹ˆåˆå¦‚ä½•è¯»å–/mnt/cdromä¸­çš„/mnt/cdrom/a.rpmå‘¢?è¿™é‡Œcdromä»£è¡¨çš„æ–‡ä»¶ç³»ç»ŸBæŒ‚è½½ç‚¹ä½äº/mntä¸‹ï¼Œæ‰€ä»¥åˆå¤šäº†ä¸€ä¸ªæ­¥éª¤ã€‚å…ˆæ‰¾åˆ°&quot;/&quot;ï¼Œå†æ‰¾åˆ°æ ¹ä¸­çš„mntï¼Œè¿›å…¥åˆ°mntæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ‰¾åˆ°cdromçš„data blockï¼Œå†è¿›å…¥åˆ°cdromæ‰¾åˆ°a.rpmã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œmntç›®å½•æ–‡ä»¶å­˜æ”¾ä½ç½®æ˜¯æ ¹ï¼Œcdromç›®å½•æ–‡ä»¶å­˜æ”¾ä½ç½®æ˜¯mntï¼Œæœ€åa.rpmå­˜æ”¾çš„ä½ç½®æ‰æ˜¯cdromã€‚</p><p>ç»§ç»­å®Œå–„ä¸Šå›¾ã€‚å¦‚ä¸‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133050365.png" alt="image-20240426133050365"></p><h3 id="8-ext3æ–‡ä»¶ç³»ç»Ÿçš„æ—¥å¿—åŠŸèƒ½">8.ext3æ–‡ä»¶ç³»ç»Ÿçš„æ—¥å¿—åŠŸèƒ½</h3><p>ç›¸æ¯”ext2æ–‡ä»¶ç³»ç»Ÿï¼Œext3å¤šäº†ä¸€ä¸ªæ—¥å¿—åŠŸèƒ½ã€‚</p><p>åœ¨ext2æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œåªæœ‰ä¸¤ä¸ªåŒºï¼šæ•°æ®åŒºå’Œå…ƒæ•°æ®åŒºã€‚å¦‚æœæ­£åœ¨å‘data blockä¸­å¡«å……æ•°æ®æ—¶çªç„¶æ–­ç”µï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡å¯åŠ¨æ—¶å°±ä¼šæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿä¸­æ•°æ®å’ŒçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œè¿™æ®µæ£€æŸ¥å’Œä¿®å¤å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡æ—¶é—´ï¼Œç”šè‡³æ£€æŸ¥åæ— æ³•ä¿®å¤ã€‚ä¹‹æ‰€ä»¥ä¼šè¿™æ ·æ˜¯å› ä¸ºæ–‡ä»¶ç³»ç»Ÿåœ¨çªç„¶æ–­ç”µåï¼Œå®ƒä¸çŸ¥é“ä¸Šæ¬¡æ­£åœ¨å­˜å‚¨çš„æ–‡ä»¶çš„blockä»å“ªé‡Œå¼€å§‹ã€å“ªé‡Œç»“æŸï¼Œæ‰€ä»¥å®ƒä¼šæ‰«ææ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ’é™¤(ä¹Ÿè®¸æ˜¯è¿™æ ·æ£€æŸ¥çš„å§)ã€‚</p><p>è€Œåœ¨åˆ›å»ºext3æ–‡ä»¶ç³»ç»Ÿæ—¶ä¼šåˆ’åˆ†ä¸‰ä¸ªåŒºï¼šæ•°æ®åŒºã€æ—¥å¿—åŒºå’Œå…ƒæ•°æ®åŒºã€‚æ¯æ¬¡å­˜å‚¨æ•°æ®æ—¶ï¼Œå…ˆåœ¨æ—¥å¿—åŒºä¸­è¿›è¡Œext2ä¸­å…ƒæ•°æ®åŒºçš„æ´»åŠ¨ï¼Œç›´åˆ°æ–‡ä»¶å­˜å‚¨å®Œæˆåæ ‡è®°ä¸Šcommitæ‰å°†æ—¥å¿—åŒºä¸­çš„æ•°æ®è½¬å­˜åˆ°å…ƒæ•°æ®åŒºã€‚å½“å­˜å‚¨æ–‡ä»¶æ—¶çªç„¶æ–­ç”µï¼Œä¸‹ä¸€æ¬¡æ£€æŸ¥ä¿®å¤æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œåªéœ€è¦æ£€æŸ¥æ—¥å¿—åŒºçš„è®°å½•ï¼Œå°†bmapå¯¹åº”çš„data blockæ ‡è®°ä¸ºæœªä½¿ç”¨ï¼Œå¹¶æŠŠinodeå·æ ‡è®°æœªä½¿ç”¨ï¼Œè¿™æ ·å°±ä¸éœ€è¦æ‰«ææ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿè€Œè€—è´¹å¤§é‡æ—¶é—´ã€‚</p><p>è™½è¯´ext3ç›¸æ¯”ext2å¤šäº†ä¸€ä¸ªæ—¥å¿—åŒºè½¬å†™å…ƒæ•°æ®åŒºçš„åŠ¨ä½œè€Œå¯¼è‡´ext3ç›¸æ¯”ext2æ€§èƒ½è¦å·®ä¸€ç‚¹ï¼Œç‰¹åˆ«æ˜¯å†™ä¼—å¤šå°æ–‡ä»¶æ—¶ã€‚ä½†æ˜¯ç”±äºext3å…¶ä»–æ–¹é¢çš„ä¼˜åŒ–ä½¿å¾—ext3å’Œext2æ€§èƒ½å‡ ä¹æ²¡æœ‰å·®è·ã€‚</p><h3 id="9-ext4æ–‡ä»¶ç³»ç»Ÿ">9.ext4æ–‡ä»¶ç³»ç»Ÿ</h3><p>å›é¡¾å‰é¢å…³äºext2å’Œext3æ–‡ä»¶ç³»ç»Ÿçš„å­˜å‚¨æ ¼å¼ï¼Œå®ƒä½¿ç”¨blockä¸ºå­˜å‚¨å•å…ƒï¼Œæ¯ä¸ªblockä½¿ç”¨bmapä¸­çš„ä½æ¥æ ‡è®°æ˜¯å¦ç©ºé—²ï¼Œå°½ç®¡ä½¿ç”¨åˆ’åˆ†å—ç»„çš„æ–¹æ³•ä¼˜åŒ–æé«˜äº†æ•ˆç‡ï¼Œä½†æ˜¯ä¸€ä¸ªå—ç»„å†…éƒ¨ä»ç„¶ä½¿ç”¨bmapæ¥æ ‡è®°è¯¥å—ç»„å†…çš„blockã€‚å¯¹äºä¸€ä¸ªå·¨å¤§çš„æ–‡ä»¶ï¼Œæ‰«ææ•´ä¸ªbmapéƒ½å°†æ˜¯ä¸€ä»¶æµ©å¤§çš„å·¥ç¨‹ã€‚å¦å¤–åœ¨inodeå¯»å€æ–¹é¢ï¼Œext2/3ä½¿ç”¨ç›´æ¥å’Œé—´æ¥çš„å¯»å€æ–¹å¼ï¼Œå¯¹äºä¸‰çº§é—´æ¥æŒ‡é’ˆï¼Œå¯èƒ½è¦éå†çš„æŒ‡é’ˆæ•°é‡æ˜¯éå¸¸éå¸¸å·¨å¤§çš„ã€‚</p><p>ext4æ–‡ä»¶ç³»ç»Ÿçš„æœ€å¤§ç‰¹ç‚¹æ˜¯åœ¨ext3çš„åŸºç¡€ä¸Šä½¿ç”¨åŒº(extentï¼Œæˆ–ç§°ä¸ºæ®µ)çš„æ¦‚å¿µæ¥ç®¡ç†ã€‚ä¸€ä¸ªextentå°½å¯èƒ½çš„åŒ…å«ç‰©ç†ä¸Šè¿ç»­çš„ä¸€å †blockã€‚inodeå¯»å€æ–¹é¢ä¹Ÿä¸€æ ·ä½¿ç”¨åŒºæ®µæ ‘çš„æ–¹å¼è¿›è¡Œäº†æ”¹è¿›ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒEXT4ä¸å†ä½¿ç”¨EXT3çš„block mappingåˆ†é…æ–¹å¼ ï¼Œè€Œæ”¹ä¸ºExtentæ–¹å¼åˆ†é…ã€‚</p><p>ä»¥ä¸‹æ˜¯ext4æ–‡ä»¶ç³»ç»Ÿä¸­ä¸€ä¸ªæ–‡ä»¶çš„inodeå±æ€§ç¤ºä¾‹ï¼Œæ³¨æ„æœ€åä¸¤è¡Œçš„EXTENTSã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Inode: 12 Type: regular Mode: 0644 Flags: 0x80000 </span><br><span class="line">Generation: 476513974 Version: 0x00000000:00000001 </span><br><span class="line">User: 0 Group: 0 Size: 11 </span><br><span class="line">File ACL: 0 Directory ACL: 0 </span><br><span class="line">Links: 1 Blockcount: 8 </span><br><span class="line">Fragment: Address: 0 Number: 0 Size: 0 </span><br><span class="line"> ctime: 0x5b628ca0:491d6224 -- Thu Aug 2 12:46:24 2018 </span><br><span class="line"> atime: 0x5b628ca0:491d6224 -- Thu Aug 2 12:46:24 2018 </span><br><span class="line"> mtime: 0x5b628ca0:491d6224 -- Thu Aug 2 12:46:24 2018 </span><br><span class="line">crtime: 0x5b628ca0:491d6224 -- Thu Aug 2 12:46:24 2018 </span><br><span class="line">Size of extra inode fields: 28 </span><br><span class="line">EXTENTS: </span><br><span class="line">(0):33409 </span><br></pre></td></tr></table></figure><p>(1). å…³äºEXT4çš„ç»“æ„ç‰¹å¾</p><p>EXT4åœ¨æ€»ä½“ç»“æ„ä¸Šä¸EXT3ç›¸ä¼¼ï¼Œå¤§çš„åˆ†é…æ–¹å‘éƒ½æ˜¯åŸºäºç›¸åŒå¤§å°çš„å—ç»„ï¼Œæ¯ä¸ªå—ç»„å†…åˆ†é…å›ºå®šæ•°é‡çš„inodeã€å¯èƒ½çš„superblock(æˆ–å¤‡ä»½)åŠGDTã€‚</p><p>EXT4çš„inode ç»“æ„åšäº†é‡å¤§æ”¹å˜ï¼Œä¸ºå¢åŠ æ–°çš„ä¿¡æ¯ï¼Œå¤§å°ç”±EXT3çš„128å­—èŠ‚å¢åŠ åˆ°é»˜è®¤çš„256å­—èŠ‚ï¼ŒåŒæ—¶inodeå¯»å€ç´¢å¼•ä¸å†ä½¿ç”¨EXT3çš„&quot;12ä¸ªç›´æ¥å¯»å€å—+1ä¸ªä¸€çº§é—´æ¥å¯»å€å—+1ä¸ªäºŒçº§é—´æ¥å¯»å€å—+1ä¸ªä¸‰çº§é—´æ¥å¯»å€å—&quot;çš„ç´¢å¼•æ¨¡å¼ï¼Œè€Œæ”¹ä¸º4ä¸ªExtentç‰‡æ–­æµï¼Œæ¯ä¸ªç‰‡æ–­æµè®¾å®šç‰‡æ–­çš„èµ·å§‹blockå·åŠè¿ç»­çš„blockæ•°é‡(æœ‰å¯èƒ½ç›´æ¥æŒ‡å‘æ•°æ®åŒºï¼Œä¹Ÿæœ‰å¯èƒ½æŒ‡å‘ç´¢å¼•å—åŒº)ã€‚</p><p>ç‰‡æ®µæµå³ä¸‹å›¾ä¸­ç´¢å¼•èŠ‚ç‚¹(inde node block)éƒ¨åˆ†çš„ç»¿è‰²åŒºåŸŸï¼Œæ¯ä¸ª15å­—èŠ‚ï¼Œå…±60å­—èŠ‚ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133212168.png" alt="image-20240426133212168"></p><p>(2). EXT4åˆ é™¤æ•°æ®çš„ç»“æ„æ›´æ”¹ã€‚</p><p>EXT4åˆ é™¤æ•°æ®åï¼Œä¼šä¾æ¬¡é‡Šæ”¾æ–‡ä»¶ç³»ç»Ÿbitmapç©ºé—´ä½ã€æ›´æ–°ç›®å½•ç»“æ„ã€é‡Šæ”¾inodeç©ºé—´ä½ã€‚</p><p>(3). ext4ä½¿ç”¨å¤šblockåˆ†é…æ–¹å¼ã€‚</p><p>åœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œext3ä¸­çš„blockåˆ†é…å™¨ä¸€æ¬¡åªèƒ½åˆ†é…4KBå¤§å°çš„Blockæ•°é‡ï¼Œè€Œä¸”æ¯å­˜å‚¨ä¸€ä¸ªblockå‰å°±æ ‡è®°ä¸€æ¬¡bmapã€‚å‡å¦‚å­˜å‚¨1Gçš„æ–‡ä»¶ï¼Œblocksizeæ˜¯4KBï¼Œé‚£ä¹ˆæ¯å­˜å‚¨å®Œä¸€ä¸ªBlockå°±å°†è°ƒç”¨ä¸€æ¬¡blockåˆ†é…å™¨ï¼Œå³è°ƒç”¨çš„æ¬¡æ•°ä¸º1024 * 1024 / 4KB=262144æ¬¡ï¼Œæ ‡è®°bmapçš„æ¬¡æ•°ä¹Ÿä¸º1024 * 1024/4=262144æ¬¡ã€‚</p><p>è€Œåœ¨ext4ä¸­æ ¹æ®åŒºæ®µæ¥åˆ†é…ï¼Œå¯ä»¥å®ç°è°ƒç”¨ä¸€æ¬¡blockåˆ†é…å™¨å°±åˆ†é…ä¸€å †è¿ç»­çš„blockï¼Œå¹¶åœ¨å­˜å‚¨è¿™ä¸€å †blockå‰ä¸€æ¬¡æ€§æ ‡è®°å¯¹åº”çš„bmapã€‚è¿™å¯¹äºå¤§æ–‡ä»¶æ¥è¯´æå¤§çš„æå‡äº†å­˜å‚¨æ•ˆç‡ã€‚</p><h3 id="10-extç±»çš„æ–‡ä»¶ç³»ç»Ÿçš„ç¼ºç‚¹">10.extç±»çš„æ–‡ä»¶ç³»ç»Ÿçš„ç¼ºç‚¹</h3><p>æœ€å¤§çš„ç¼ºç‚¹æ˜¯å®ƒåœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™å°±åˆ’åˆ†å¥½ä¸€åˆ‡éœ€è¦åˆ’åˆ†çš„ä¸œè¥¿ï¼Œä»¥åç”¨åˆ°çš„æ—¶å€™å¯ä»¥ç›´æ¥è¿›è¡Œåˆ†é…ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸æ”¯æŒåŠ¨æ€åˆ’åˆ†å’ŒåŠ¨æ€åˆ†é…ã€‚å¯¹äºè¾ƒå°çš„åˆ†åŒºæ¥è¯´é€Ÿåº¦è¿˜å¥½ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªè¶…å¤§çš„ç£ç›˜ï¼Œé€Ÿåº¦æ˜¯ææ…¢ææ…¢çš„ã€‚ä¾‹å¦‚å°†ä¸€ä¸ªå‡ åTçš„ç£ç›˜é˜µåˆ—æ ¼å¼åŒ–ä¸ºext4æ–‡ä»¶ç³»ç»Ÿï¼Œå¯èƒ½ä½ ä¼šå› æ­¤è€Œå¤±å»ä¸€åˆ‡è€å¿ƒã€‚</p><p>é™¤äº†æ ¼å¼åŒ–é€Ÿåº¦è¶…æ…¢ä»¥å¤–ï¼Œext4æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯éå¸¸å¯å–çš„ã€‚å½“ç„¶ï¼Œä¸åŒå…¬å¸å¼€å‘çš„æ–‡ä»¶ç³»ç»Ÿéƒ½å„æœ‰ç‰¹è‰²ï¼Œæœ€ä¸»è¦çš„è¿˜æ˜¯æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</p><h3 id="11-è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸVFS">11.è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸVFS</h3><p>æ¯ä¸€ä¸ªåˆ†åŒºæ ¼å¼åŒ–åéƒ½å¯ä»¥å»ºç«‹ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ŒLinuxä¸Šå¯ä»¥è¯†åˆ«å¾ˆå¤šç§æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•è¯†åˆ«çš„å‘¢?å¦å¤–ï¼Œåœ¨æˆ‘ä»¬æ“ä½œåˆ†åŒºä¸­çš„æ–‡ä»¶æ—¶ï¼Œå¹¶æ²¡æœ‰æŒ‡å®šè¿‡å®ƒæ˜¯å“ªä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ï¼Œå„ç§ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå¦‚ä½•è¢«æˆ‘ä»¬ç”¨æˆ·ä»¥æ— å·®åˆ«çš„æ–¹å¼æ“ä½œå‘¢?è¿™å°±æ˜¯è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„ä½œç”¨ã€‚</p><p>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸ºç”¨æˆ·æ“ä½œå„ç§æ–‡ä»¶ç³»ç»Ÿæä¾›äº†é€šç”¨æ¥å£ï¼Œä½¿å¾—ç”¨æˆ·æ‰§è¡Œç¨‹åºæ—¶ä¸éœ€è¦è€ƒè™‘æ–‡ä»¶æ˜¯åœ¨å“ªç§ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œåº”è¯¥ä½¿ç”¨ä»€ä¹ˆæ ·çš„ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œè¯¥æ–‡ä»¶ã€‚æœ‰äº†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œåªè¦å°†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ç¨‹åºè°ƒç”¨VFSçš„ç³»ç»Ÿè°ƒç”¨å°±å¯ä»¥äº†ï¼Œå‰©ä¸‹çš„åŠ¨ä½œç”±VFSæ¥å¸®å¿™å®Œæˆã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240426133132195.png" alt="image-20240426133132195"></p><h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3><p>æœ¬æ–‡ç« æ‘˜è‡ªï¼š</p><ul><li><a href="https://www.51cto.com/article/603104.html">EXTæ–‡ä»¶ç³»ç»Ÿæœºåˆ¶åŸç†è¯¦è§£</a></li><li><a href="https://www.yuque.com/yukun-srnyg/gxz6gg/hovdfg">æ“ä½œç³»ç»Ÿ-å“ˆå·¥å¤§ææ²»å†›è€å¸ˆ</a></li></ul><h3 id=""></h3>]]></content>
      
      
      <categories>
          
          <category> æ“ä½œç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ“ä½œç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mallocåŸç†å®ç°</title>
      <link href="/posts/3e3da89f.html"/>
      <url>/posts/3e3da89f.html</url>
      
        <content type="html"><![CDATA[<p>è½¬è½½è‡ªï¼š<a href="https://mp.weixin.qq.com/s/xCqPaYqM5It97KDwCjrYIQ">å†…å­˜åˆ†é…å‡½æ•° malloc åŸç†åŠå®ç°</a></p><h2 id="1-ä»€ä¹ˆæ˜¯malloc"><strong>1.ä»€ä¹ˆæ˜¯malloc</strong></h2><p>æ ¹æ®<strong>æ ‡å‡†Cåº“å‡½æ•°</strong>çš„å®šä¹‰ï¼Œmallocå…·æœ‰å¦‚ä¸‹åŸå‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void* malloc(size_t size);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è¦å®ç°çš„åŠŸèƒ½æ˜¯åœ¨ç³»ç»Ÿä¸­åˆ†é…ä¸€æ®µè¿ç»­çš„å¯ç”¨çš„å†…å­˜ï¼Œå…·ä½“æœ‰å¦‚ä¸‹è¦æ±‚ï¼š</p><ul><li>mallocåˆ†é…çš„å†…å­˜å¤§å°<strong>è‡³å°‘</strong>ä¸ºsizeå‚æ•°æ‰€æŒ‡å®šçš„å­—èŠ‚æ•°</li><li>mallocçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€æ®µå¯ç”¨å†…å­˜çš„èµ·å§‹åœ°å€</li><li>å¤šæ¬¡è°ƒç”¨mallocæ‰€åˆ†é…çš„åœ°å€ä¸èƒ½æœ‰é‡å éƒ¨åˆ†ï¼Œé™¤éæŸæ¬¡mallocæ‰€åˆ†é…çš„åœ°å€è¢«é‡Šæ”¾æ‰</li><li>mallocåº”è¯¥å°½å¿«å®Œæˆå†…å­˜åˆ†é…å¹¶è¿”å›</li><li>å®ç°mallocæ—¶åº”åŒæ—¶å®ç°å†…å­˜å¤§å°è°ƒæ•´å’Œå†…å­˜é‡Šæ”¾å‡½æ•°ï¼ˆå³reallocå’Œfreeï¼‰</li></ul><p>å¯¹äºmallocæ›´å¤šçš„è¯´æ˜å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­é”®å…¥ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man malloc</span><br></pre></td></tr></table></figure><p><strong>mallocå¦‚ä½•åˆ†é…å†…å­˜ï¼Ÿ</strong></p><p>ç¬¬ä¸€ç§ï¼šé€šè¿‡brk()ç³»ç»Ÿè°ƒç”¨ä»å †åˆ†é…å†…å­˜</p><p>ç¬¬äºŒç§ï¼šé€šè¿‡ mmap()ç³»ç»Ÿè°ƒç”¨åœ¨æ–‡ä»¶æ˜ å°„åŒºåŸŸåˆ†é…å†…å­˜;</p><p>ä¸¤ç§æ–¹å¼åº”è¯¥å¦‚ä½•åŒºåˆ†?</p><ol><li><p>å¦‚æœç”¨æˆ·åˆ†é…çš„å†…å­˜å°äº128 KBï¼Œåˆ™é€šè¿‡brk()ç”³è¯·å†…å­˜</p></li><li><p>å¦‚æœç”¨æˆ·åˆ†é…çš„å†…å­˜å¤§äº128 KBï¼Œåˆ™é€šè¿‡mmap()ç”³è¯·å†…å­˜</p></li><li><p>ä¸åŒçš„glibcå½“ä¸­å®šä¹‰çš„é˜ˆå€¼æ˜¯ä¸ä¸€æ ·çš„ã€glibc æ˜¯ C è¯­è¨€çš„è¿è¡Œæ—¶åº“ï¼ŒCè¯­ä¹‰ä¸­å¸¸è§çš„å‡½æ•°printfç­‰å®ç°éƒ½åœ¨ <a href="http://glibc.so">glibc.so</a> ä¸­ã€‘</p></li></ol><h2 id="2-é¢„å¤‡çŸ¥è¯†"><strong>2.é¢„å¤‡çŸ¥è¯†</strong></h2><p>åœ¨å®ç°mallocä¹‹å‰ï¼Œéœ€è¦å…ˆè§£é‡Šä¸€äº›Linuxç³»ç»Ÿå†…å­˜ç›¸å…³çš„çŸ¥è¯†ã€‚</p><h3 id="2-1-Linuxå†…å­˜ç®¡ç†">2.1 Linuxå†…å­˜ç®¡ç†</h3><h4 id="2-1-1-è™šæ‹Ÿå†…å­˜åœ°å€ä¸ç‰©ç†å†…å­˜åœ°å€">2.1.1 è™šæ‹Ÿå†…å­˜åœ°å€ä¸ç‰©ç†å†…å­˜åœ°å€</h4><p>ä¸ºäº†ç®€å•ï¼Œç°ä»£æ“ä½œç³»ç»Ÿåœ¨å¤„ç†å†…å­˜åœ°å€æ—¶ï¼Œæ™®éé‡‡ç”¨è™šæ‹Ÿå†…å­˜åœ°å€æŠ€æœ¯ã€‚å³åœ¨æ±‡ç¼–ç¨‹åºï¼ˆæˆ–æœºå™¨è¯­è¨€ï¼‰å±‚é¢ï¼Œå½“æ¶‰åŠå†…å­˜åœ°å€æ—¶ï¼Œéƒ½æ˜¯ä½¿ç”¨è™šæ‹Ÿå†…å­˜åœ°å€ã€‚é‡‡ç”¨è¿™ç§æŠ€æœ¯æ—¶ï¼Œæ¯ä¸ªè¿›ç¨‹ä»¿ä½›è‡ªå·±ç‹¬äº«ä¸€ç‰‡2Nå­—èŠ‚çš„å†…å­˜ï¼Œå…¶ä¸­Næ˜¯æœºå™¨ä½æ•°ã€‚ä¾‹å¦‚åœ¨64ä½CPUå’Œ64ä½æ“ä½œç³»ç»Ÿä¸‹ï¼Œæ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸º264Byteã€‚</p><p>è¿™ç§è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä½œç”¨ä¸»è¦æ˜¯ç®€åŒ–ç¨‹åºçš„ç¼–å†™åŠæ–¹ä¾¿æ“ä½œç³»ç»Ÿå¯¹è¿›ç¨‹é—´å†…å­˜çš„éš”ç¦»ç®¡ç†ï¼ŒçœŸå®ä¸­çš„è¿›ç¨‹ä¸å¤ªå¯èƒ½ï¼ˆä¹Ÿç”¨ä¸åˆ°ï¼‰å¦‚æ­¤å¤§çš„å†…å­˜ç©ºé—´ï¼Œå®é™…èƒ½ç”¨åˆ°çš„å†…å­˜å–å†³äºç‰©ç†å†…å­˜å¤§å°ã€‚</p><p>ç”±äºåœ¨æœºå™¨è¯­è¨€å±‚é¢éƒ½æ˜¯é‡‡ç”¨è™šæ‹Ÿåœ°å€ï¼Œå½“å®é™…çš„æœºå™¨ç ç¨‹åºæ¶‰åŠåˆ°å†…å­˜æ“ä½œæ—¶ï¼Œéœ€è¦æ ¹æ®å½“å‰è¿›ç¨‹è¿è¡Œçš„å®é™…ä¸Šä¸‹æ–‡å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†å†…å­˜åœ°å€ï¼Œæ‰èƒ½å®ç°å¯¹çœŸå®å†…å­˜æ•°æ®çš„æ“ä½œã€‚è¿™ä¸ªè½¬æ¢ä¸€èˆ¬ç”±ä¸€ä¸ªå«<strong>MMU</strong>[2]ï¼ˆMemory Management Unitï¼‰çš„ç¡¬ä»¶å®Œæˆã€‚</p><h4 id="2-1-2-é¡µä¸åœ°å€æ„æˆ">2.1.2 é¡µä¸åœ°å€æ„æˆ</h4><p>åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸è®ºæ˜¯è™šæ‹Ÿå†…å­˜è¿˜æ˜¯ç‰©ç†å†…å­˜ï¼Œéƒ½ä¸æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œç®¡ç†çš„ï¼Œè€Œæ˜¯ä»¥é¡µï¼ˆPageï¼‰ä¸ºå•ä½ã€‚ä¸€ä¸ªå†…å­˜é¡µæ˜¯ä¸€æ®µå›ºå®šå¤§å°çš„è¿ç»­å†…å­˜åœ°å€çš„æ€»ç§°ï¼Œå…·ä½“åˆ°Linuxä¸­ï¼Œå…¸å‹çš„å†…å­˜é¡µå¤§å°ä¸º4096Byteï¼ˆ4Kï¼‰ã€‚</p><p>æ‰€ä»¥å†…å­˜åœ°å€å¯ä»¥åˆ†ä¸ºé¡µå·å’Œé¡µå†…åç§»é‡ã€‚ä¸‹é¢ä»¥64ä½æœºå™¨ï¼Œ4Gç‰©ç†å†…å­˜ï¼Œ4Ké¡µå¤§å°ä¸ºä¾‹ï¼Œè™šæ‹Ÿå†…å­˜åœ°å€å’Œç‰©ç†å†…å­˜åœ°å€çš„ç»„æˆå¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425171539476.png" alt="image-20240425171539476"></p><p>ä¸Šé¢æ˜¯è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œä¸‹é¢æ˜¯ç‰©ç†å†…å­˜åœ°å€ã€‚ç”±äºé¡µå¤§å°éƒ½æ˜¯4Kï¼Œæ‰€ä»¥é¡µå†…åç§»éƒ½æ˜¯ç”¨ä½12ä½è¡¨ç¤ºï¼Œè€Œå‰©ä¸‹çš„é«˜åœ°å€è¡¨ç¤ºé¡µå·ã€‚</p><p>MMUæ˜ å°„å•ä½å¹¶ä¸æ˜¯å­—èŠ‚ï¼Œè€Œæ˜¯é¡µï¼Œè¿™ä¸ªæ˜ å°„é€šè¿‡æŸ¥ä¸€ä¸ªå¸¸é©»å†…å­˜çš„æ•°æ®ç»“æ„<strong>é¡µè¡¨</strong>[3]æ¥å®ç°ã€‚ç°åœ¨è®¡ç®—æœºå…·ä½“çš„å†…å­˜åœ°å€æ˜ å°„æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†åŠ å¿«é€Ÿåº¦ä¼šå¼•å…¥ä¸€ç³»åˆ—ç¼“å­˜å’Œä¼˜åŒ–ï¼Œä¾‹å¦‚<strong>TLB</strong>[4]ç­‰æœºåˆ¶ã€‚</p><p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªç»è¿‡ç®€åŒ–çš„å†…å­˜åœ°å€ç¿»è¯‘ç¤ºæ„å›¾ï¼Œè™½ç„¶ç»è¿‡äº†ç®€åŒ–ï¼Œä½†æ˜¯åŸºæœ¬åŸç†ä¸ç°ä»£è®¡ç®—æœºçœŸå®çš„æƒ…å†µæ˜¯ä¸€è‡´çš„ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425171620475.png" alt="image-20240425171620475"></p><h4 id="2-1-3-å†…å­˜é¡µä¸ç£ç›˜é¡µ">2.1.3 å†…å­˜é¡µä¸ç£ç›˜é¡µ</h4><p>æˆ‘ä»¬çŸ¥é“ä¸€èˆ¬å°†å†…å­˜çœ‹åšç£ç›˜çš„çš„ç¼“å­˜ï¼Œæœ‰æ—¶MMUåœ¨å·¥ä½œæ—¶ï¼Œä¼šå‘ç°é¡µè¡¨è¡¨æ˜æŸä¸ªå†…å­˜é¡µä¸åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œæ­¤æ—¶ä¼šè§¦å‘ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸ï¼ˆPage Faultï¼‰ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šåˆ°ç£ç›˜ä¸­ç›¸åº”çš„åœ°æ–¹å°†ç£ç›˜é¡µè½½å…¥åˆ°å†…å­˜ä¸­ï¼Œç„¶åé‡æ–°æ‰§è¡Œç”±äºç¼ºé¡µè€Œå¤±è´¥çš„æœºå™¨æŒ‡ä»¤ã€‚å…³äºè¿™éƒ¨åˆ†ï¼Œå› ä¸ºå¯ä»¥çœ‹åšå¯¹mallocå®ç°æ˜¯é€æ˜çš„ï¼Œæ‰€ä»¥ä¸å†è¯¦ç»†è®²è¿°ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹ç›¸å…³ç« èŠ‚ã€‚</p><p>æœ€åé™„ä¸Šä¸€å¼ åœ¨ç»´åŸºç™¾ç§‘æ‰¾åˆ°çš„æ›´åŠ ç¬¦åˆçœŸå®åœ°å€ç¿»è¯‘çš„æµç¨‹ä¾›å¤§å®¶å‚è€ƒï¼Œè¿™å¼ å›¾åŠ å…¥äº†TLBå’Œç¼ºé¡µå¼‚å¸¸çš„æµç¨‹ï¼ˆ<strong>å›¾ç‰‡æ¥æºé¡µ</strong>[5]ï¼‰ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425171626448.png" alt="image-20240425171626448"></p><h3 id="2-2-Linuxè¿›ç¨‹çº§å†…å­˜ç®¡ç†">2.2 Linuxè¿›ç¨‹çº§å†…å­˜ç®¡ç†</h3><h4 id="2-2-1-å†…å­˜æ’å¸ƒ">2.2.1 å†…å­˜æ’å¸ƒ</h4><p>æ˜ç™½äº†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜çš„å…³ç³»åŠç›¸å…³çš„æ˜ å°„æœºåˆ¶ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å…·ä½“åœ¨ä¸€ä¸ªè¿›ç¨‹å†…æ˜¯å¦‚ä½•æ’å¸ƒå†…å­˜çš„ã€‚</p><p>ä»¥Linux 64ä½ç³»ç»Ÿä¸ºä¾‹ã€‚ç†è®ºä¸Šï¼Œ64bitå†…å­˜åœ°å€å¯ç”¨ç©ºé—´ä¸º0x0000000000000000 ~ 0xFFFFFFFFFFFFFFFFï¼Œè¿™æ˜¯ä¸ªç›¸å½“åºå¤§çš„ç©ºé—´ï¼ŒLinuxå®é™…ä¸Šåªç”¨äº†å…¶ä¸­ä¸€å°éƒ¨åˆ†ï¼ˆ256Tï¼‰ã€‚</p><p>æ ¹æ®<strong>Linuxå†…æ ¸ç›¸å…³æ–‡æ¡£</strong>[6]æè¿°ï¼ŒLinux64ä½æ“ä½œç³»ç»Ÿä»…ä½¿ç”¨ä½47ä½ï¼Œé«˜17ä½åšæ‰©å±•ï¼ˆåªèƒ½æ˜¯å…¨0æˆ–å…¨1ï¼‰ã€‚æ‰€ä»¥ï¼Œå®é™…ç”¨åˆ°çš„åœ°å€ä¸ºç©ºé—´ä¸º0x0000000000000000 ~ 0x00007FFFFFFFFFFFå’Œ0xFFFF800000000000 ~ 0xFFFFFFFFFFFFFFFFï¼Œå…¶ä¸­å‰é¢ä¸ºç”¨æˆ·ç©ºé—´ï¼ˆUser Spaceï¼‰ï¼Œåè€…ä¸ºå†…æ ¸ç©ºé—´ï¼ˆKernel Spaceï¼‰ã€‚å›¾ç¤ºå¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425171633158.png" alt="image-20240425171633158"></p><p>å¯¹ç”¨æˆ·æ¥è¯´ï¼Œä¸»è¦å…³æ³¨çš„ç©ºé—´æ˜¯User Spaceã€‚å°†User Spaceæ”¾å¤§åï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢ä¸»è¦åˆ†ä¸ºå¦‚ä¸‹å‡ æ®µï¼š</p><ul><li>Codeï¼šè¿™æ˜¯æ•´ä¸ªç”¨æˆ·ç©ºé—´çš„æœ€ä½åœ°å€éƒ¨åˆ†ï¼Œå­˜æ”¾çš„æ˜¯æŒ‡ä»¤ï¼ˆä¹Ÿå°±æ˜¯ç¨‹åºæ‰€ç¼–è¯‘æˆçš„å¯æ‰§è¡Œæœºå™¨ç ï¼‰</li><li>Dataï¼šè¿™é‡Œå­˜æ”¾çš„æ˜¯åˆå§‹åŒ–è¿‡çš„å…¨å±€å˜é‡</li><li>BSSï¼šè¿™é‡Œå­˜æ”¾çš„æ˜¯æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡</li><li>Heapï¼šå †ï¼Œè¿™æ˜¯æˆ‘ä»¬æœ¬æ–‡é‡ç‚¹å…³æ³¨çš„åœ°æ–¹ï¼Œå †è‡ªä½åœ°å€å‘é«˜åœ°å€å¢é•¿ï¼Œåé¢è¦è®²åˆ°çš„brkç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨å°±æ˜¯ä»è¿™é‡Œåˆ†é…å†…å­˜</li><li>Mapping Areaï¼šè¿™é‡Œæ˜¯ä¸mmapç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„åŒºåŸŸã€‚å¤§å¤šæ•°å®é™…çš„mallocå®ç°ä¼šè€ƒè™‘é€šè¿‡mmapåˆ†é…è¾ƒå¤§å—çš„å†…å­˜åŒºåŸŸï¼Œæœ¬æ–‡ä¸è®¨è®ºè¿™ç§æƒ…å†µã€‚è¿™ä¸ªåŒºåŸŸè‡ªé«˜åœ°å€å‘ä½åœ°å€å¢é•¿</li><li>Stackï¼šè¿™æ˜¯æ ˆåŒºåŸŸï¼Œè‡ªé«˜åœ°å€å‘ä½åœ°å€å¢é•¿</li></ul><p>ä¸‹é¢æˆ‘ä»¬ä¸»è¦å…³æ³¨HeapåŒºåŸŸçš„æ“ä½œã€‚å¯¹æ•´ä¸ªLinuxå†…å­˜æ’å¸ƒæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒå…¶å®ƒèµ„æ–™ã€‚</p><h4 id="2-2-2-Heapå†…å­˜æ¨¡å‹">2.2.2 Heapå†…å­˜æ¨¡å‹</h4><p>ä¸€èˆ¬æ¥è¯´ï¼Œmallocæ‰€ç”³è¯·çš„å†…å­˜ä¸»è¦ä»HeapåŒºåŸŸåˆ†é…ï¼ˆæœ¬æ–‡ä¸è€ƒè™‘é€šè¿‡mmapç”³è¯·å¤§å—å†…å­˜çš„æƒ…å†µï¼‰ã€‚</p><p>ç”±ä¸Šæ–‡çŸ¥é“ï¼Œè¿›ç¨‹æ‰€é¢å¯¹çš„è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´ï¼Œåªæœ‰æŒ‰é¡µæ˜ å°„åˆ°ç‰©ç†å†…å­˜åœ°å€ï¼Œæ‰èƒ½çœŸæ­£ä½¿ç”¨ã€‚å—ç‰©ç†å­˜å‚¨å®¹é‡é™åˆ¶ï¼Œæ•´ä¸ªå †è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸å¯èƒ½å…¨éƒ¨æ˜ å°„åˆ°å®é™…çš„ç‰©ç†å†…å­˜ã€‚Linuxå¯¹å †çš„ç®¡ç†ç¤ºæ„å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425171639162.png" alt="image-20240425171639162"></p><p>Linuxç»´æŠ¤ä¸€ä¸ªbreakæŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘å †ç©ºé—´çš„æŸä¸ªåœ°å€ã€‚ä»å †èµ·å§‹åœ°å€åˆ°breakä¹‹é—´çš„åœ°å€ç©ºé—´ä¸ºæ˜ å°„å¥½çš„ï¼Œå¯ä»¥ä¾›è¿›ç¨‹è®¿é—®ï¼›è€Œä»breakå¾€ä¸Šï¼Œæ˜¯æœªæ˜ å°„çš„åœ°å€ç©ºé—´ï¼Œå¦‚æœè®¿é—®è¿™æ®µç©ºé—´åˆ™ç¨‹åºä¼šæŠ¥é”™ã€‚</p><h4 id="2-2-3-brkä¸sbrk">2.2.3 brkä¸sbrk</h4><p>ç”±ä¸Šæ–‡çŸ¥é“ï¼Œè¦å¢åŠ ä¸€ä¸ªè¿›ç¨‹å®é™…çš„å¯ç”¨å †å¤§å°ï¼Œå°±éœ€è¦å°†breakæŒ‡é’ˆå‘é«˜åœ°å€ç§»åŠ¨ã€‚Linuxé€šè¿‡brkå’Œsbrkç³»ç»Ÿè°ƒç”¨æ“ä½œbreakæŒ‡é’ˆã€‚ä¸¤ä¸ª<strong>ç³»ç»Ÿè°ƒç”¨</strong>çš„åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">brk</span><span class="params">(<span class="type">void</span> *addr)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">sbrk</span><span class="params">(<span class="type">intptr_t</span> increment)</span></span>;</span><br></pre></td></tr></table></figure><p>brkå°†breakæŒ‡é’ˆç›´æ¥è®¾ç½®ä¸ºæŸä¸ªåœ°å€ï¼Œè€Œsbrkå°†breakä»å½“å‰ä½ç½®ç§»åŠ¨incrementæ‰€æŒ‡å®šçš„å¢é‡ã€‚brkåœ¨æ‰§è¡ŒæˆåŠŸæ—¶è¿”å›0ï¼Œå¦åˆ™è¿”å›-1å¹¶è®¾ç½®errnoä¸ºENOMEMï¼›sbrkæˆåŠŸæ—¶è¿”å›breakç§»åŠ¨ä¹‹å‰æ‰€æŒ‡å‘çš„åœ°å€ï¼Œå¦åˆ™è¿”å›(void *)-1ã€‚</p><p>ä¸€ä¸ªå°æŠ€å·§æ˜¯ï¼Œå¦‚æœå°†incrementè®¾ç½®ä¸º0ï¼Œåˆ™å¯ä»¥è·å¾—å½“å‰breakçš„åœ°å€ã€‚</p><p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºLinuxæ˜¯æŒ‰é¡µè¿›è¡Œå†…å­˜æ˜ å°„çš„ï¼Œæ‰€ä»¥å¦‚æœbreakè¢«è®¾ç½®ä¸ºæ²¡æœ‰æŒ‰é¡µå¤§å°å¯¹é½ï¼Œåˆ™ç³»ç»Ÿå®é™…ä¸Šä¼šåœ¨æœ€åæ˜ å°„ä¸€ä¸ªå®Œæ•´çš„é¡µï¼Œä»è€Œå®é™…å·²æ˜ å°„çš„å†…å­˜ç©ºé—´æ¯”breakæŒ‡å‘çš„åœ°æ–¹è¦å¤§ä¸€äº›ã€‚ä½†æ˜¯ä½¿ç”¨breakä¹‹åçš„åœ°å€æ˜¯å¾ˆå±é™©çš„ï¼ˆå°½ç®¡ä¹Ÿè®¸breakä¹‹åç¡®å®æœ‰ä¸€å°å—å¯ç”¨å†…å­˜åœ°å€ï¼‰ã€‚</p><h4 id="2-2-4-èµ„æºé™åˆ¶ä¸rlimit">2.2.4 èµ„æºé™åˆ¶ä¸rlimit</h4><p>ç³»ç»Ÿå¯¹æ¯ä¸€ä¸ªè¿›ç¨‹æ‰€åˆ†é…çš„èµ„æºä¸æ˜¯æ— é™çš„ï¼ŒåŒ…æ‹¬å¯æ˜ å°„çš„å†…å­˜ç©ºé—´ï¼Œå› æ­¤æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªrlimitè¡¨ç¤ºå½“å‰è¿›ç¨‹å¯ç”¨çš„èµ„æºä¸Šé™ã€‚</p><p>è¿™ä¸ªé™åˆ¶å¯ä»¥é€šè¿‡getrlimitç³»ç»Ÿè°ƒç”¨å¾—åˆ°ï¼Œä¸‹é¢ä»£ç è·å–å½“å‰è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´çš„rlimitï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rlimit</span> *limit = (<span class="keyword">struct</span> rlimit *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> rlimit));</span><br><span class="line">    <span class="built_in">getrlimit</span>(RLIMIT_AS, limit);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;soft limit: %ld, hard limit: %ld\n&quot;</span>, limit-&gt;rlim_cur, limit-&gt;rlim_max);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­rlimitæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">rlimit</span> &#123;</span><br><span class="line">    <span class="type">rlim_t</span> rlim_cur;  <span class="comment">/* Soft limit */</span></span><br><span class="line">    <span class="type">rlim_t</span> rlim_max;  <span class="comment">/* Hard limit (ceiling for rlim_cur) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¯ç§èµ„æºæœ‰è½¯é™åˆ¶å’Œç¡¬é™åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡setrlimitå¯¹rlimitè¿›è¡Œæœ‰æ¡ä»¶è®¾ç½®ã€‚å…¶ä¸­ç¡¬é™åˆ¶ä½œä¸ºè½¯é™åˆ¶çš„ä¸Šé™ï¼Œéç‰¹æƒè¿›ç¨‹åªèƒ½è®¾ç½®è½¯é™åˆ¶ï¼Œä¸”ä¸èƒ½è¶…è¿‡ç¡¬é™åˆ¶ã€‚</p><h2 id="3-å®ç°malloc"><strong>3.å®ç°malloc</strong></h2><p>ä¸‹é¢ä¸»è¦æ˜¯ç©ºé—²é“¾è¡¨å®ç°çš„ã€‚</p><h3 id="3-1-ç©å…·å®ç°">3.1 ç©å…·å®ç°</h3><p>åœ¨æ­£å¼å¼€å§‹è®¨è®ºmallocçš„å®ç°å‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸Šè¿°çŸ¥è¯†å®ç°ä¸€ä¸ªç®€å•ä½†å‡ ä¹æ²¡æ³•ç”¨äºçœŸå®çš„ç©å…·mallocï¼Œæƒå½“å¯¹ä¸Šé¢çŸ¥è¯†çš„å¤ä¹ ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä¸€ä¸ªç©å…·malloc */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">void</span> *p;</span><br><span class="line">    p = <span class="built_in">sbrk</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sbrk</span>(size) == (<span class="type">void</span> *)<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªmallocæ¯æ¬¡éƒ½åœ¨å½“å‰breakçš„åŸºç¡€ä¸Šå¢åŠ sizeæ‰€æŒ‡å®šçš„å­—èŠ‚æ•°ï¼Œå¹¶å°†ä¹‹å‰breakçš„åœ°å€è¿”å›ã€‚è¿™ä¸ªmallocç”±äºå¯¹æ‰€åˆ†é…çš„å†…å­˜ç¼ºä¹è®°å½•ï¼Œä¸ä¾¿äºå†…å­˜é‡Šæ”¾ï¼Œæ‰€ä»¥æ— æ³•ç”¨äºçœŸå®åœºæ™¯ã€‚</p><h3 id="3-2-æ­£å¼å®ç°">3.2 æ­£å¼å®ç°</h3><p>ä¸‹é¢ä¸¥è‚ƒç‚¹è®¨è®ºmallocçš„å®ç°æ–¹æ¡ˆã€‚</p><h4 id="3-2-1-æ•°æ®ç»“æ„">3.2.1 æ•°æ®ç»“æ„</h4><p>é¦–å…ˆæˆ‘ä»¬è¦ç¡®å®šæ‰€é‡‡ç”¨çš„æ•°æ®ç»“æ„ã€‚ä¸€ä¸ªç®€å•å¯è¡Œæ–¹æ¡ˆæ˜¯å°†å †å†…å­˜ç©ºé—´ä»¥å—ï¼ˆBlockï¼‰çš„å½¢å¼ç»„ç»‡èµ·æ¥ï¼Œæ¯ä¸ªå—ç”±metaåŒºå’Œæ•°æ®åŒºç»„æˆï¼ŒmetaåŒºè®°å½•æ•°æ®å—çš„å…ƒä¿¡æ¯ï¼ˆæ•°æ®åŒºå¤§å°ã€ç©ºé—²æ ‡å¿—ä½ã€æŒ‡é’ˆç­‰ç­‰ï¼‰ï¼Œæ•°æ®åŒºæ˜¯çœŸå®åˆ†é…çš„å†…å­˜åŒºåŸŸï¼Œå¹¶ä¸”æ•°æ®åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åœ°å€å³ä¸ºmallocè¿”å›çš„åœ°å€ã€‚</p><p>å¯ä»¥ç”¨å¦‚ä¸‹ç»“æ„ä½“å®šä¹‰ä¸€ä¸ªblockï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">s_block</span> *t_block;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">s_block</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">/* æ•°æ®åŒºå¤§å° */</span></span><br><span class="line">  t_block next; <span class="comment">/* æŒ‡å‘ä¸‹ä¸ªå—çš„æŒ‡é’ˆ */</span></span><br><span class="line">  <span class="type">int</span> free; <span class="comment">/* æ˜¯å¦æ˜¯ç©ºé—²å— */</span></span><br><span class="line">  <span class="type">int</span> padding; <span class="comment">/* å¡«å……4å­—èŠ‚ï¼Œä¿è¯metaå—é•¿åº¦ä¸º8çš„å€æ•° */</span></span><br><span class="line">  <span class="type">char</span> data[<span class="number">1</span>] <span class="comment">/* è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿå­—æ®µï¼Œè¡¨ç¤ºæ•°æ®å—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œé•¿åº¦ä¸åº”è®¡å…¥meta */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬åªè€ƒè™‘64ä½æœºå™¨ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬åœ¨ç»“æ„ä½“æœ€åå¡«å……ä¸€ä¸ªintï¼Œä½¿å¾—ç»“æ„ä½“æœ¬èº«çš„é•¿åº¦ä¸º8çš„å€æ•°ï¼Œä»¥ä¾¿å†…å­˜å¯¹é½ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425171646744.png" alt="image-20240425171646744"></p><blockquote><p><strong>è¡¥å……</strong>ï¼šæŸ”æ€§æ•°ç»„</p></blockquote><ul><li><a href="https://zhuanlan.zhihu.com/p/385501987">å¬è¯´æœ‰äººä¸äº†è§£æŸ”æ€§æ•°ç»„ï¼Ÿ</a></li></ul><h4 id="3-2-2-å¯»æ‰¾åˆé€‚çš„block">3.2.2 å¯»æ‰¾åˆé€‚çš„block</h4><p>ç°åœ¨è€ƒè™‘å¦‚ä½•åœ¨blocké“¾ä¸­æŸ¥æ‰¾åˆé€‚çš„blockã€‚ä¸€èˆ¬æ¥è¯´æœ‰ä¸¤ç§æŸ¥æ‰¾ç®—æ³•ï¼š</p><ul><li><strong>First fit</strong>ï¼šä»å¤´å¼€å§‹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ•°æ®åŒºå¤§å°å¤§äºè¦æ±‚sizeçš„å—æ‰€è°“æ­¤æ¬¡åˆ†é…çš„å—</li><li><strong>Best fit</strong>ï¼šä»å¤´å¼€å§‹ï¼Œéå†æ‰€æœ‰å—ï¼Œä½¿ç”¨æ•°æ®åŒºå¤§å°å¤§äºsizeä¸”å·®å€¼æœ€å°çš„å—ä½œä¸ºæ­¤æ¬¡åˆ†é…çš„å—</li></ul><p>ä¸¤ç§æ–¹æ³•å„æœ‰åƒç§‹ï¼Œbest fitå…·æœ‰è¾ƒé«˜çš„å†…å­˜ä½¿ç”¨ç‡ï¼ˆpayloadè¾ƒé«˜ï¼‰ï¼Œè€Œfirst fitå…·æœ‰æ›´å¥½çš„è¿è¡Œæ•ˆç‡ã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨first fitç®—æ³•ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* First fit */</span></span><br><span class="line"><span class="function">t_block <span class="title">find_block</span><span class="params">(t_block *last, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  t_block b = first_block;</span><br><span class="line">  <span class="keyword">while</span>(b &amp;&amp; !(b-&gt;free &amp;&amp; b-&gt;size &gt;= size)) &#123;</span><br><span class="line">     *last = b;</span><br><span class="line">     b = b-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>find_blockä»frist_blockå¼€å§‹ï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„blockå¹¶è¿”å›blockèµ·å§‹åœ°å€ï¼Œå¦‚æœæ‰¾ä¸åˆ°è¿™è¿”å›NULLã€‚</p><p>è¿™é‡Œåœ¨éå†æ—¶ä¼šæ›´æ–°ä¸€ä¸ªå«lastçš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå§‹ç»ˆæŒ‡å‘å½“å‰éå†çš„blockã€‚è¿™æ˜¯ä¸ºäº†å¦‚æœæ‰¾ä¸åˆ°åˆé€‚çš„blockè€Œå¼€è¾Ÿæ–°blockä½¿ç”¨çš„ï¼Œå…·ä½“ä¼šåœ¨æ¥ä¸‹æ¥çš„ä¸€èŠ‚ç”¨åˆ°ã€‚</p><h4 id="3-2-3-å¼€è¾Ÿæ–°çš„block">3.2.3 å¼€è¾Ÿæ–°çš„block</h4><p>å¦‚æœç°æœ‰blockéƒ½ä¸èƒ½æ»¡è¶³sizeçš„è¦æ±‚ï¼Œåˆ™éœ€è¦åœ¨é“¾è¡¨æœ€åå¼€è¾Ÿä¸€ä¸ªæ–°çš„blockã€‚è¿™é‡Œå…³é”®æ˜¯å¦‚ä½•åªä½¿ç”¨sbrkåˆ›å»ºä¸€ä¸ªstructï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE 24 <span class="comment">/* ç”±äºå­˜åœ¨è™šæ‹Ÿçš„dataå­—æ®µï¼Œsizeofä¸èƒ½æ­£ç¡®è®¡ç®—metaé•¿åº¦ï¼Œè¿™é‡Œæ‰‹å·¥è®¾ç½® */</span></span></span><br><span class="line"><span class="function">t_block <span class="title">extend_heap</span><span class="params">(t_block last, <span class="type">size_t</span> s)</span> </span>&#123;</span><br><span class="line">    t_block b;</span><br><span class="line">    b = <span class="built_in">sbrk</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">sbrk</span>(BLOCK_SIZE + s) == (<span class="type">void</span> *)<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    b-&gt;size = s;</span><br><span class="line">    b-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(last)</span><br><span class="line">        last-&gt;next = b;</span><br><span class="line">    b-&gt;free = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-4-åˆ†è£‚block">3.2.4 åˆ†è£‚block</h4><p>First fitæœ‰ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„ç¼ºç‚¹ï¼Œå°±æ˜¯å¯èƒ½ä¼šè®©å¾ˆå°çš„sizeå æ®å¾ˆå¤§çš„ä¸€å—blockï¼Œæ­¤æ—¶ï¼Œä¸ºäº†æé«˜payloadï¼Œåº”è¯¥åœ¨å‰©ä½™æ•°æ®åŒºè¶³å¤Ÿå¤§çš„æƒ…å†µä¸‹ï¼Œå°†å…¶åˆ†è£‚ä¸ºä¸€ä¸ªæ–°çš„blockï¼Œç¤ºæ„å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425171653204.png" alt="image-20240425171653204"></p><p>å®ç°ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">split_block</span><span class="params">(t_block b, <span class="type">size_t</span> s)</span> </span>&#123;</span><br><span class="line">    t_block <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">new</span> = b-&gt;data + s;</span><br><span class="line">    <span class="keyword">new</span>-&gt;size = b-&gt;size - s - BLOCK_SIZE ;</span><br><span class="line">    <span class="keyword">new</span>-&gt;next = b-&gt;next;</span><br><span class="line">    <span class="keyword">new</span>-&gt;free = <span class="number">1</span>;</span><br><span class="line">    b-&gt;size = s;</span><br><span class="line">    b-&gt;next = <span class="keyword">new</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-5-mallocçš„å®ç°">3.2.5 mallocçš„å®ç°</h4><p>æœ‰äº†ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒä»¬æ•´åˆæˆä¸€ä¸ªç®€å•ä½†åˆæ­¥å¯ç”¨çš„mallocã€‚æ³¨æ„é¦–å…ˆæˆ‘ä»¬è¦å®šä¹‰ä¸ªblocké“¾è¡¨çš„å¤´first_blockï¼Œåˆå§‹åŒ–ä¸ºNULLï¼›å¦å¤–ï¼Œæˆ‘ä»¬éœ€è¦å‰©ä½™ç©ºé—´è‡³å°‘æœ‰BLOCK_SIZE + 8æ‰æ‰§è¡Œåˆ†è£‚æ“ä½œã€‚ã€å› ä¸ºBLOCK_SIZEä¿å­˜çš„4ä¸ªINTçš„å†…å­˜å¤§å°ã€‘</p><p>ç”±äºæˆ‘ä»¬å¸Œæœ›mallocåˆ†é…çš„æ•°æ®åŒºæ˜¯æŒ‰8å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥åœ¨sizeä¸ä¸º8çš„å€æ•°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†sizeè°ƒæ•´ä¸ºå¤§äºsizeçš„æœ€å°çš„8çš„å€æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">align8</span><span class="params">(<span class="type">size_t</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s &amp; <span class="number">0x7</span> == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    <span class="keyword">return</span> ((s &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE 24</span></span><br><span class="line"><span class="type">void</span> *first_block=<span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">/* other functions... */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">malloc</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    t_block b, last;</span><br><span class="line">    <span class="type">size_t</span> s;</span><br><span class="line">    <span class="comment">/* å¯¹é½åœ°å€ */</span></span><br><span class="line">    s = <span class="built_in">align8</span>(size);</span><br><span class="line">    <span class="keyword">if</span>(first_block) &#123;</span><br><span class="line">    / *æŸ¥æ‰¾åˆé€‚çš„block */</span><br><span class="line">        last = first_block;</span><br><span class="line">        b = <span class="built_in">find_block</span>(&amp;last, s);</span><br><span class="line">        <span class="keyword">if</span>(b) &#123;</span><br><span class="line">    <span class="comment">/* å¦‚æœå¯ä»¥ï¼Œåˆ™åˆ†è£‚*/</span></span><br><span class="line">            <span class="keyword">if</span> ((b-&gt;size - s) &gt;= ( BLOCK_SIZE + <span class="number">8</span>))</span><br><span class="line">                <span class="built_in">split_block</span>(b, s);</span><br><span class="line">            b-&gt;free = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    / *æ²¡æœ‰åˆé€‚çš„blockï¼Œå¼€è¾Ÿä¸€ä¸ªæ–°çš„ */</span><br><span class="line">        b = <span class="built_in">extend_heap</span>(last, s);</span><br><span class="line">        <span class="keyword">if</span>(!b)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    b = <span class="built_in">extend_heap</span>(<span class="literal">NULL</span>, s);</span><br><span class="line">    <span class="keyword">if</span>(!b)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    first_block = b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> b-&gt;data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-6-callocçš„å®ç°">3.2.6 callocçš„å®ç°</h4><p>æœ‰äº†mallocï¼Œå®ç°callocåªè¦ä¸¤æ­¥ï¼š</p><ol><li>mallocä¸€æ®µå†…å­˜</li><li>å°†æ•°æ®åŒºå†…å®¹ç½®ä¸º0</li></ol><p>ç”±äºæˆ‘ä»¬çš„æ•°æ®åŒºæ˜¯æŒ‰8å­—èŠ‚å¯¹é½çš„ï¼Œæ‰€ä»¥ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥æ¯8å­—èŠ‚ä¸€ç»„ç½®0ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚è®¾ç½®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ–°å»ºä¸€ä¸ªsize_tæŒ‡é’ˆï¼Œå°†å†…å­˜åŒºåŸŸå¼ºåˆ¶çœ‹åšsize_tç±»å‹æ¥å®ç°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">calloc</span><span class="params">(<span class="type">size_t</span> number, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *<span class="keyword">new</span>;</span><br><span class="line">    <span class="type">size_t</span> s8, i;</span><br><span class="line">    <span class="keyword">new</span> = <span class="built_in">malloc</span>(number * size);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">new</span>) &#123;</span><br><span class="line">        s8 = <span class="built_in">align8</span>(number * size) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; s8; i++)</span><br><span class="line">            <span class="keyword">new</span>[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-7-freeçš„å®ç°">3.2.7 freeçš„å®ç°</h4><p>freeçš„å®ç°å¹¶ä¸åƒçœ‹ä¸Šå»é‚£ä¹ˆç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬è¦è§£å†³ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š</p><ol><li>å¦‚ä½•éªŒè¯æ‰€ä¼ å…¥çš„åœ°å€æ˜¯æœ‰æ•ˆåœ°å€ï¼Œå³ç¡®å®æ˜¯é€šè¿‡mallocæ–¹å¼åˆ†é…çš„æ•°æ®åŒºé¦–åœ°å€</li><li>å¦‚ä½•è§£å†³ç¢ç‰‡é—®é¢˜</li></ol><p>é¦–å…ˆæˆ‘ä»¬è¦ä¿è¯ä¼ å…¥freeçš„åœ°å€æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªæœ‰æ•ˆåŒ…æ‹¬ä¸¤æ–¹é¢ï¼š</p><ul><li>åœ°å€åº”è¯¥åœ¨ä¹‹å‰mallocæ‰€åˆ†é…çš„åŒºåŸŸå†…ï¼Œå³åœ¨first_blockå’Œå½“å‰breakæŒ‡é’ˆèŒƒå›´å†…</li><li>è¿™ä¸ªåœ°å€ç¡®å®æ˜¯ä¹‹å‰é€šè¿‡æˆ‘ä»¬è‡ªå·±çš„mallocåˆ†é…çš„</li></ul><p>ç¬¬ä¸€ä¸ªé—®é¢˜æ¯”è¾ƒå¥½è§£å†³ï¼Œåªè¦è¿›è¡Œåœ°å€æ¯”è¾ƒå°±å¯ä»¥äº†ï¼Œå…³é”®æ˜¯ç¬¬äºŒä¸ªé—®é¢˜ã€‚</p><p>è¿™é‡Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼šä¸€æ˜¯åœ¨ç»“æ„ä½“å†…åŸ‹ä¸€ä¸ªmagic numberå­—æ®µï¼Œfreeä¹‹å‰é€šè¿‡ç›¸å¯¹åç§»æ£€æŸ¥ç‰¹å®šä½ç½®çš„å€¼æ˜¯å¦ä¸ºæˆ‘ä»¬è®¾ç½®çš„magic numberï¼Œå¦ä¸€ç§æ–¹æ³•æ˜¯åœ¨ç»“æ„ä½“å†…å¢åŠ ä¸€ä¸ªmagic pointerï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æ•°æ®åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯åœ¨åˆæ³•æ—¶freeæ—¶ä¼ å…¥çš„åœ°å€ï¼‰ï¼Œæˆ‘ä»¬åœ¨freeå‰æ£€æŸ¥magic pointeræ˜¯å¦æŒ‡å‘å‚æ•°æ‰€æŒ‡åœ°å€ã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆï¼š</p><p>é¦–å…ˆæˆ‘ä»¬åœ¨ç»“æ„ä½“ä¸­å¢åŠ magic pointerï¼ˆåŒæ—¶è¦ä¿®æ”¹BLOCK_SIZEï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">s_block</span> *t_block;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">s_block</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> size;  <span class="comment">/* æ•°æ®åŒºå¤§å° */</span></span><br><span class="line">    t_block next; <span class="comment">/* æŒ‡å‘ä¸‹ä¸ªå—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="type">int</span> free;     <span class="comment">/* æ˜¯å¦æ˜¯ç©ºé—²å— */</span></span><br><span class="line">    <span class="type">int</span> padding;  <span class="comment">/* å¡«å……4å­—èŠ‚ï¼Œä¿è¯metaå—é•¿åº¦ä¸º8çš„å€æ•° */</span></span><br><span class="line">    <span class="type">void</span> *ptr;    <span class="comment">/* Magic pointerï¼ŒæŒ‡å‘data */</span></span><br><span class="line">    <span class="type">char</span> data[<span class="number">1</span>]  <span class="comment">/* è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿå­—æ®µï¼Œè¡¨ç¤ºæ•°æ®å—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œé•¿åº¦ä¸åº”è®¡å…¥meta */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å®šä¹‰æ£€æŸ¥åœ°å€åˆæ³•æ€§çš„å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">t_block <span class="title">get_block</span><span class="params">(<span class="type">void</span> *p)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> *tmp;  </span><br><span class="line">    tmp = p;</span><br><span class="line">    <span class="keyword">return</span> (p = tmp -= BLOCK_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">valid_addr</span><span class="params">(<span class="type">void</span> *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(first_block) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p &gt; first_block &amp;&amp; p &lt; <span class="built_in">sbrk</span>(<span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> p == (<span class="built_in">get_block</span>(p))-&gt;ptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å¤šæ¬¡mallocå’Œfreeåï¼Œæ•´ä¸ªå†…å­˜æ± å¯èƒ½ä¼šäº§ç”Ÿå¾ˆå¤šç¢ç‰‡blockï¼Œè¿™äº›blockå¾ˆå°ï¼Œç»å¸¸æ— æ³•ä½¿ç”¨ï¼Œç”šè‡³å‡ºç°è®¸å¤šç¢ç‰‡è¿åœ¨ä¸€èµ·ï¼Œè™½ç„¶æ€»ä½“èƒ½æ»¡è¶³mallocè¦æ±‚ï¼Œä½†æ˜¯ç”±äºåˆ†å‰²æˆäº†å¤šä¸ªå°blockè€Œæ— æ³•fitï¼Œè¿™å°±æ˜¯ç¢ç‰‡é—®é¢˜ã€‚</p><p>ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹å¼æ˜¯å½“freeæŸä¸ªblockæ—¶ï¼Œå¦‚æœå‘ç°å®ƒç›¸é‚»çš„blockä¹Ÿæ˜¯freeçš„ï¼Œåˆ™å°†blockå’Œç›¸é‚»blockåˆå¹¶ã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸ªå®ç°ï¼Œéœ€è¦å°†s_blockæ”¹ä¸ºåŒå‘é“¾è¡¨ã€‚</p><p>ä¿®æ”¹åçš„blockç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">s_block</span> *t_block;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">s_block</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> size;  <span class="comment">/* æ•°æ®åŒºå¤§å° */</span></span><br><span class="line">    t_block prev; <span class="comment">/* æŒ‡å‘ä¸Šä¸ªå—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    t_block next; <span class="comment">/* æŒ‡å‘ä¸‹ä¸ªå—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="type">int</span> free;     <span class="comment">/* æ˜¯å¦æ˜¯ç©ºé—²å— */</span></span><br><span class="line">    <span class="type">int</span> padding;  <span class="comment">/* å¡«å……4å­—èŠ‚ï¼Œä¿è¯metaå—é•¿åº¦ä¸º8çš„å€æ•° */</span></span><br><span class="line">    <span class="type">void</span> *ptr;    <span class="comment">/* Magic pointerï¼ŒæŒ‡å‘data */</span></span><br><span class="line">    <span class="type">char</span> data[<span class="number">1</span>]  <span class="comment">/* è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿå­—æ®µï¼Œè¡¨ç¤ºæ•°æ®å—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œé•¿åº¦ä¸åº”è®¡å…¥meta */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åˆå¹¶æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">t_block <span class="title">fusion</span><span class="params">(t_block b)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (b-&gt;next &amp;&amp; b-&gt;next-&gt;free) &#123;</span><br><span class="line">  b-&gt;size += BLOCK_SIZE + b-&gt;next-&gt;size;</span><br><span class="line">  b-&gt;next = b-&gt;next-&gt;next;</span><br><span class="line">  <span class="keyword">if</span>(b-&gt;next)</span><br><span class="line">  b-&gt;next-&gt;prev = b;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†ä¸Šè¿°æ–¹æ³•ï¼Œfreeçš„å®ç°æ€è·¯å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼šé¦–å…ˆæ£€æŸ¥å‚æ•°åœ°å€çš„åˆæ³•æ€§ï¼Œå¦‚æœä¸åˆæ³•åˆ™ä¸åšä»»ä½•äº‹ï¼›å¦åˆ™ï¼Œå°†æ­¤blockçš„freeæ ‡ä¸º1ï¼Œå¹¶ä¸”åœ¨å¯ä»¥çš„æƒ…å†µä¸‹ä¸åé¢çš„blockè¿›è¡Œåˆå¹¶ã€‚</p><p>å¦‚æœå½“å‰æ˜¯æœ€åä¸€ä¸ªblockï¼Œåˆ™å›é€€breakæŒ‡é’ˆé‡Šæ”¾è¿›ç¨‹å†…å­˜ï¼Œå¦‚æœå½“å‰blockæ˜¯æœ€åä¸€ä¸ªblockï¼Œåˆ™å›é€€breakæŒ‡é’ˆå¹¶è®¾ç½®first_blockä¸ºNULLã€‚å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">(<span class="type">void</span> *p)</span> </span>&#123;</span><br><span class="line">    t_block b;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">valid_addr</span>(p)) &#123;</span><br><span class="line">        b = <span class="built_in">get_block</span>(p);</span><br><span class="line">        b-&gt;free = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(b-&gt;prev &amp;&amp; b-&gt;prev-&gt;free)</span><br><span class="line">            b = <span class="built_in">fusion</span>(b-&gt;prev);</span><br><span class="line">        <span class="keyword">if</span>(b-&gt;next)</span><br><span class="line">            <span class="built_in">fusion</span>(b);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(b-&gt;prev)</span><br><span class="line">                b-&gt;prev-&gt;prev = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                first_block = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="built_in">brk</span>(b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-8-reallocçš„å®ç°">3.2.8 reallocçš„å®ç°</h4><p>ä¸ºäº†å®ç°reallocï¼Œæˆ‘ä»¬é¦–å…ˆè¦å®ç°ä¸€ä¸ªå†…å­˜å¤åˆ¶æ–¹æ³•ã€‚å¦‚åŒcallocä¸€æ ·ï¼Œä¸ºäº†æ•ˆç‡ï¼Œæˆ‘ä»¬ä»¥8å­—èŠ‚ä¸ºå•ä½è¿›è¡Œå¤åˆ¶ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">copy_block</span><span class="params">(t_block src, t_block dst)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *sdata, *ddata;</span><br><span class="line">    <span class="type">size_t</span> i;</span><br><span class="line">    sdata = src-&gt;ptr;</span><br><span class="line">    ddata = dst-&gt;ptr;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; (i * <span class="number">8</span>) &lt; src-&gt;size &amp;&amp; (i * <span class="number">8</span>) &lt; dst-&gt;size; i++)</span><br><span class="line">        ddata[i] = sdata[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å¼€å§‹å®ç°reallocã€‚ä¸€ä¸ªç®€å•ï¼ˆä½†æ˜¯ä½æ•ˆï¼‰çš„æ–¹æ³•æ˜¯mallocä¸€æ®µå†…å­˜ï¼Œç„¶åå°†æ•°æ®å¤åˆ¶è¿‡å»ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åšå¾—æ›´é«˜æ•ˆï¼Œå…·ä½“å¯ä»¥è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ul><li>å¦‚æœå½“å‰blockçš„æ•°æ®åŒºå¤§äºç­‰äºreallocæ‰€è¦æ±‚çš„sizeï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ</li><li>å¦‚æœæ–°çš„sizeå˜å°äº†ï¼Œè€ƒè™‘split</li><li>å¦‚æœå½“å‰blockçš„æ•°æ®åŒºä¸èƒ½æ»¡è¶³sizeï¼Œä½†æ˜¯å…¶åç»§blockæ˜¯freeçš„ï¼Œå¹¶ä¸”åˆå¹¶åå¯ä»¥æ»¡è¶³ï¼Œåˆ™è€ƒè™‘åšåˆå¹¶</li></ul><p>ä¸‹é¢æ˜¯reallocçš„å®ç°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">realloc</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> s;</span><br><span class="line">    t_block b, <span class="keyword">new</span>;</span><br><span class="line">    <span class="type">void</span> *newp;</span><br><span class="line">    <span class="keyword">if</span> (!p)</span><br><span class="line">        <span class="comment">/* æ ¹æ®æ ‡å‡†åº“æ–‡æ¡£ï¼Œå½“pä¼ å…¥NULLæ—¶ï¼Œç›¸å½“äºè°ƒç”¨malloc */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">valid_addr</span>(p)) &#123;</span><br><span class="line">        s = <span class="built_in">align8</span>(size);</span><br><span class="line">        b = <span class="built_in">get_block</span>(p);</span><br><span class="line">        <span class="keyword">if</span>(b-&gt;size &gt;= s) &#123;</span><br><span class="line">            <span class="keyword">if</span>(b-&gt;size - s &gt;= (BLOCK_SIZE + <span class="number">8</span>))</span><br><span class="line">                <span class="built_in">split_block</span>(b,s);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* çœ‹æ˜¯å¦å¯è¿›è¡Œåˆå¹¶ */</span></span><br><span class="line">            <span class="keyword">if</span>(b-&gt;next &amp;&amp; b-&gt;next-&gt;free</span><br><span class="line">                    &amp;&amp; (b-&gt;size + BLOCK_SIZE + b-&gt;next-&gt;size) &gt;= s) &#123;</span><br><span class="line">                <span class="built_in">fusion</span>(b);</span><br><span class="line">                <span class="keyword">if</span>(b-&gt;size - s &gt;= (BLOCK_SIZE + <span class="number">8</span>))</span><br><span class="line">                    <span class="built_in">split_block</span>(b, s);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* æ–°malloc */</span></span><br><span class="line">                newp = <span class="built_in">malloc</span> (s);</span><br><span class="line">                <span class="keyword">if</span> (!newp)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">new</span> = <span class="built_in">get_block</span>(newp);</span><br><span class="line">                <span class="built_in">copy_block</span>(b, <span class="keyword">new</span>);</span><br><span class="line">                <span class="built_in">free</span>(p);</span><br><span class="line">                <span class="keyword">return</span>(newp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Cpp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cpp </tag>
            
            <tag> æ“ä½œç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rediså­¦ä¹ ç¬”è®°</title>
      <link href="/posts/51d1b1e7.html"/>
      <url>/posts/51d1b1e7.html</url>
      
        <content type="html"><![CDATA[<h2 id="ç¬¬ä¸€ç« -å¼•è¨€">ç¬¬ä¸€ç«  å¼•è¨€</h2><p>å­¦æŠ€æœ¯æœ€å¿«é€Ÿçš„æ–¹å¼å°±æ˜¯æ ¹æ®å®˜æ–¹æ–‡æ¡£å­¦ä¹ ï¼š<a href="https://redis.com.cn/documentation.html">redisæŠ€æœ¯æ–‡æ¡£</a></p><p>redisçš„é‡ç‚¹æ˜¯åœ¨å¦‚ä½•ç”¨å¥½å…ˆï¼Œåœ¨è°ˆè®¾è®¡ï¼Œå°±åƒæœ±å“¥è¯´çš„ã€‚</p><h2 id="ç¬¬äºŒç« -ç®€å•åŠ¨æ€å­—ç¬¦ä¸²">ç¬¬äºŒç«  ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</h2><p>Redisæ²¡æœ‰ç›´æ¥ä½¿ç”¨Cè¯­è¨€ä¼ ç»Ÿçš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼ˆä»¥ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼Œä»¥ä¸‹ç®€ç§°Cå­—ç¬¦ä¸²)ï¼Œè€Œæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§åä¸ºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆ simple dynamic stringï¼ŒSDS)çš„æŠ½è±¡ç±»å‹ï¼Œå¹¶å°†SDSç”¨ä½œ Redis çš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p><h3 id="2-1-SDSçš„å®šä¹‰">2.1 SDSçš„å®šä¹‰</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sdshdr</span> &#123;</span><br><span class="line">    <span class="comment">// è®°å½• buf æ•°ç»„ä¸­å·²ä½¿ç”¨å­—èŠ‚çš„æ•°é‡</span></span><br><span class="line">    <span class="comment">// ç­‰äº SDS æ‰€ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="comment">// è®°å½• buf æ•°ç»„ä¸­æœªä½¿ç”¨å­—èŠ‚çš„æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> free;</span><br><span class="line">    <span class="comment">// å­—èŠ‚æ•°ç»„ï¼Œç”¨äºä¿å­˜å­—ç¬¦ä¸²ï¼Œä¼šè‡ªåŠ¨åœ¨æ•°ç»„æœ«å°¾æ·»åŠ ä¸€ä¸ªå­—èŠ‚ï¼Œç”¨äºä¿å­˜&#x27;\0&#x27;ï¼Œä¸è®¡å…¥ len å€¼ä¸­</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424095542031.png" alt="image-20240424095542031"></p><h3 id="2-2-SDSä¸Cå­—ç¬¦ä¸²çš„åŒºåˆ«">2.2 SDSä¸Cå­—ç¬¦ä¸²çš„åŒºåˆ«</h3><p><strong>1.å¸¸æ•°å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦</strong></p><p>é€šè¿‡ä½¿ç”¨SDSè€Œä¸æ˜¯Cå­—ç¬¦ä¸²ï¼ŒRedis å°†è·å–å­—ç¬¦ä¸²é•¿åº¦æ‰€éœ€çš„å¤æ‚åº¦ä»O(N)é™ä½åˆ°äº†O(1)ï¼Œè¿™ç¡®ä¿äº†è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å·¥ä½œä¸ä¼šæˆä¸ºRedisçš„æ€§èƒ½ç“¶é¢ˆã€‚</p><p><strong>2.æœç»ç¼“å†²åŒºæº¢å‡º</strong></p><p>é™¤äº†è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å¤æ‚åº¦é«˜ä¹‹å¤–ï¼ŒCå­—ç¬¦ä¸²ä¸è®°å½•è‡ªèº«é•¿åº¦å¸¦æ¥çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯å®¹æ˜“é€ æˆç¼“å†²åŒºæº¢å‡º ( buffer overflow)ã€‚</p><p>SDSçš„ç©ºé—´åˆ†é…ç­–ç•¥å®Œå…¨æœç»äº†å‘ç”Ÿç¼“å†²åŒºæº¢å‡ºçš„å¯èƒ½æ€§:å½“SDS-APIéœ€è¦å¯¹SDSè¿›è¡Œä¿®æ”¹æ—¶ï¼ŒAPIä¼šå…ˆæ£€æŸ¥SDSçš„ç©ºé—´æ˜¯å¦æ»¡è¶³ä¿®æ”¹æ‰€éœ€çš„è¦æ±‚ï¼Œå¦‚æœä¸æ»¡è¶³çš„è¯ï¼ŒAPIä¼šè‡ªåŠ¨å°†SDSçš„ç©ºé—´æ‰©å±•è‡³æ‰§è¡Œä¿®æ”¹æ‰€éœ€çš„å¤§å°ï¼Œç„¶åæ‰æ‰§è¡Œå®é™…çš„ä¿®æ”¹æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨SDSæ—¢ä¸éœ€è¦æ‰‹åŠ¨ä¿®æ”¹SDSçš„ç©ºé—´å¤§å°ï¼Œä¹Ÿä¸ä¼šå‡ºç°å‰é¢æ‰€è¯´çš„ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ã€‚</p><p><strong>3.å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°</strong></p><p>3.1 é¢„åˆ†é…ç©ºé—´</p><p>ç©ºé—´é¢„åˆ†é…ç”¨äºä¼˜åŒ–SDSå­—ç¬¦ä¸²å¢é•¿æ“ä½œã€‚åœ¨æ‰©å±•SDSç©ºé—´å‰ï¼ŒSDS APIä¼šå…ˆæ£€æŸ¥æœªä½¿ç”¨ç©ºé—´å¤Ÿä¸å¤Ÿï¼Œå¦‚æœä¸å¤Ÿï¼Œåˆ™è¿›è¡Œç©ºé—´é¢„åˆ†é…ã€‚æ­¤æ—¶ï¼Œç¨‹åºä¸ä»…ä¼šä¸ºSDSåˆ†é…ä¿®æ”¹æ‰€å¿…é¡»è¦çš„ç©ºé—´ï¼Œè¿˜ä¸ºå…¶åˆ†é…é¢å¤–æœªä½¿ç”¨çš„ç©ºé—´ã€‚</p><ul><li>ä¿®æ”¹åçš„SDS&lt;1MBï¼Œç¨‹åºåˆ†é…å’Œlenå±æ€§åŒæ ·å¤§å°çš„æœªä½¿ç”¨ç©ºé—´ï¼Œæ­¤æ—¶SDSçš„lenä¸freeå¤§å°ç›¸ç­‰ã€‚æ¯”å¦‚ä¿®æ”¹åå®é™…å­˜å‚¨å­—ç¬¦ä¸²çš„ç©ºé—´å˜ä¸º13å­—èŠ‚ï¼Œé‚£ä¹ˆlen=13ï¼Œfree=13ï¼Œbufæ•°ç»„æ•´ä½“çš„é•¿åº¦=13+13+1ï¼ˆé¢å¤–1å­—èŠ‚ä¿å­˜ç©ºå­—ç¬¦ï¼‰ã€‚</li><li>ä¿®æ”¹åSDS&gt;=1MBã€‚ç¨‹åºä¼šåˆ†é…1MBçš„æœªä½¿ç”¨ç©ºé—´ã€‚æ¯”å¦‚ä¿®æ”¹åå®é™…å­˜å‚¨å­—ç¬¦ä¸²çš„ç©ºé—´å˜ä¸º2MBï¼Œé‚£ä¹ˆlen=2Mï¼Œfree=1MBï¼Œbufæ•°ç»„æ•´ä½“çš„é•¿åº¦=2MB+1MB+1byteã€‚</li></ul><p>é€šè¿‡ç©ºé—´çš„é¢„åˆ†é…ï¼Œå°†è¿ç»­å¢é•¿Næ¬¡å­—ç¬¦ä¸²éœ€è¦çš„å†…å­˜åˆ†é…æ¬¡æ•°ä»ä¸€å®šéœ€è¦Næ¬¡å˜ä¸ºæœ€å¤šNæ¬¡ã€‚å› è€Œå¯ä»¥å‡å°‘è¿ç»­æ‰§è¡Œå­—ç¬¦ä¸²å¢é•¿æ“ä½œæ‰€éœ€çš„å†…å­˜é‡åˆ†é…çš„æ¬¡æ•°ã€‚</p><p>3.2 æƒ°æ€§ç©ºé—´é‡Šæ”¾</p><p>æƒ°æ€§ç©ºé—´é‡Šæ”¾ç”¨äºä¼˜åŒ–SDSçš„å­—ç¬¦ä¸²ç¼©çŸ­æ“ä½œ:å½“SDSçš„APIéœ€è¦ç¼©çŸ­SDSä¿å­˜çš„å­—ç¬¦ä¸²æ—¶ï¼Œç¨‹åºå¹¶ä¸ç«‹å³ä½¿ç”¨å†…å­˜é‡åˆ†é…æ¥å›æ”¶ç¼©çŸ­åå¤šå‡ºæ¥çš„å­—èŠ‚ï¼Œè€Œæ˜¯ä½¿ç”¨freeå±æ€§å°†è¿™äº›å­—èŠ‚çš„æ•°é‡è®°å½•èµ·æ¥ï¼Œå¹¶ç­‰å¾…å°†æ¥ä½¿ç”¨ã€‚</p><p><strong>4.äºŒè¿›åˆ¶å®‰å…¨</strong></p><p>ä¸ºäº†ç¡®ä¿ Redis å¯ä»¥é€‚ç”¨äºå„ç§ä¸åŒçš„é€‚ç”¨åœºæ™¯ï¼ŒSDS çš„ API éƒ½æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œå› æ­¤ä½¿å¾— Redis ä¸ä»…å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œè¿˜å¯ä»¥ä¿å­˜ä»»æ„æ ¼å¼çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå› ä¸º SDS ä½¿ç”¨ len å±æ€§çš„å€¼è€Œä¸æ˜¯ç©ºå­—ç¬¦æ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¾—ç›ŠäºSDSç»“æ„ä½“å­˜å‚¨çš„æ•°æ®ä¿¡æ¯ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424100127306.png" alt="image-20240424100127306"></p><p><strong>5.å…¼å®¹éƒ¨åˆ†Cå­—ç¬¦ä¸²å‡½æ•°</strong></p><p>é€šè¿‡éµå¾ªCå­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„æƒ¯ä¾‹ï¼ŒSDS å¯ä»¥åœ¨æœ‰éœ€è¦æ—¶é‡ç”¨ <code>&lt;string.h&gt;</code> å‡½æ•°åº“ï¼Œä»è€Œé¿å…äº†ä¸å¿…è¦çš„ä»£ç é‡å¤ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424100136783.png" alt="image-20240424100136783"></p><h2 id="ç¬¬ä¸‰ç« -é“¾è¡¨">ç¬¬ä¸‰ç«  é“¾è¡¨</h2><p>é“¾è¡¨åœ¨Redisä¸­çš„åº”ç”¨éå¸¸å¹¿æ³›ï¼Œæ¯”å¦‚åˆ—è¡¨é”®çš„åº•å±‚å®ç°ä¹‹ä¸€å°±æ˜¯é“¾è¡¨ã€‚å½“ä¸€ä¸ªåˆ—è¡¨é”®åŒ…å«äº†æ•°é‡æ¯”è¾ƒå¤šçš„å…ƒç´ ï¼Œåˆæˆ–è€…åˆ—è¡¨ä¸­åŒ…å«çš„å…ƒç´ éƒ½æ˜¯æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶ï¼ŒRediså°±ä¼šä½¿ç”¨é“¾è¡¨ä½œä¸ºåˆ—è¡¨é”®çš„åº•å±‚å®ç°ã€‚</p><p>Redis çš„é“¾è¡¨æ˜¯ç”±ä¸€ä¸ª <code>list</code> ç»“æ„å’Œ n ä¸ª <code>listNode</code> ç»“æ„ç»„æˆï¼Œlist é‡Œé¢å¯ä»¥å­˜å‚¨è¯¥é“¾è¡¨çš„å¤´æŒ‡é’ˆã€å°¾æŒ‡é’ˆã€ä»¥åŠé•¿åº¦è®¡æ•°å™¨å’Œç”¨äºå®ç°å¤šæ€é“¾è¡¨æ‰€éœ€çš„ç±»å‹ç‰¹å®šå‡½æ•°ï¼ŒRedis çš„é“¾è¡¨æ˜¯ <strong>åŒç«¯</strong>ã€<strong>æ— ç¯</strong> çš„.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯ä¸ªé“¾è¡¨èŠ‚ç‚¹ä½¿ç”¨ä¸€ä¸ª adlist.h/listNode</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">listNode</span> &#123;</span><br><span class="line">    <span class="comment">// å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">listNode</span> * prev;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">listNode</span> * next;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    <span class="type">void</span> * value;</span><br><span class="line">&#125;listNode;</span><br><span class="line"><span class="comment">// è™½ç„¶ä»…ä»…ä½¿ç”¨å¤šä¸ªlistNodeç»“æ„å°±å¯ä»¥æ„æˆé“¾è¡¨ï¼Œ</span></span><br><span class="line"><span class="comment">// ä½†ä½¿ç”¨adlist.h/listæ¥æŒæœ‰é“¾è¡¨çš„è¯ï¼Œæ“ä½œèµ·æ¥ä¼šæ›´æ–¹ä¾¿</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">list</span> &#123;</span><br><span class="line">    <span class="comment">// è¡¨å¤´èŠ‚ç‚¹</span></span><br><span class="line">    listNode * head;</span><br><span class="line">    <span class="comment">// è¡¨å°¾èŠ‚ç‚¹</span></span><br><span class="line">    listNode * tail;</span><br><span class="line">    <span class="comment">// é“¾è¡¨æ‰€åŒ…å«çš„èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•°</span></span><br><span class="line">    <span class="type">void</span> *(*dup)(<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•°</span></span><br><span class="line">    <span class="built_in">void</span> (*free)(<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å€¼å¯¹æ¯”å‡½æ•°</span></span><br><span class="line">    <span class="built_in">int</span> (*match)(<span class="type">void</span> *ptr, <span class="type">void</span> *key);</span><br><span class="line">&#125;list;</span><br></pre></td></tr></table></figure><h2 id="ç¬¬å››ç« -å­—å…¸">ç¬¬å››ç«  å­—å…¸</h2><p>å­—å…¸ï¼Œåˆç§°ä¸ºç¬¦å·è¡¨( symbol table)ã€å…³è”æ•°ç»„( associative array)æˆ–æ˜ å°„( map)ï¼Œæ˜¯ä¸€ç§ç”¨äºä¿å­˜é”®å€¼å¯¹( key-value pair)çš„æŠ½è±¡æ•°æ®ç»“æ„ã€‚<br>åœ¨å­—å…¸ä¸­ï¼Œä¸€ä¸ªé”®( key)å¯ä»¥å’Œä¸€ä¸ªå€¼( value)è¿›è¡Œå…³è”ï¼ˆæˆ–è€…è¯´å°†é”®æ˜ å°„ä¸ºå€¼)ï¼Œè¿™äº›å…³è”çš„é”®å’Œå€¼å°±ç§°ä¸ºé”®å€¼å¯¹ã€‚</p><p>Redisçš„å­—å…¸ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œä¸€ä¸ªå“ˆå¸Œè¡¨é‡Œé¢å¯ä»¥æœ‰å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œè€Œæ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å°±ä¿å­˜äº†å­—å…¸ä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹ã€‚å¯ä»¥æƒ³è±¡æˆç±»ä¼¼è¿™ç§ç»“æ„ Map&lt;String,Map&lt;String,T&gt; &gt; MP;</p><h3 id="4-1-å“ˆå¸Œè¡¨">4.1 å“ˆå¸Œè¡¨</h3><ul><li>Redis å­—å…¸æ‰€ä½¿ç”¨çš„å“ˆå¸Œè¡¨ç”± <code>dict.h/dictht</code> ç»“æ„å®šä¹‰ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">dicht</span> &#123;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œè¡¨æ•°ç»„</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œè¡¨å¤§å°</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼</span></span><br><span class="line">    <span class="comment">// æ€»æ˜¯ç­‰äº size - 1</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> sizemask;</span><br><span class="line">    <span class="comment">// è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> used;</span><br><span class="line">&#125;dictht;</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424100659824.png" alt="image-20240424100659824"></p><h3 id="4-2-å“ˆå¸Œè¡¨èŠ‚ç‚¹">4.2 å“ˆå¸Œè¡¨èŠ‚ç‚¹</h3><p>å“ˆå¸Œè¡¨èŠ‚ç‚¹ä½¿ç”¨dictEntryå®ç°ï¼Œæ¯ä¸ªdictEntryéƒ½å­˜å‚¨ç€ä¸€ä¸ªé”®å€¼å¯¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">dictEntry</span>&#123;</span><br><span class="line">    <span class="comment">//é”®</span></span><br><span class="line">    <span class="type">void</span> *key;</span><br><span class="line">    <span class="comment">//å€¼</span></span><br><span class="line">    <span class="keyword">union</span>&#123;</span><br><span class="line">        <span class="type">void</span> *val;</span><br><span class="line">        <span class="type">uint64_t</span> u64;</span><br><span class="line">        <span class="type">int64_t</span> s64;</span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="comment">//æŒ‡å‘ä¸‹ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dictEntry</span> *next;</span><br><span class="line">&#125; dictEntry;</span><br></pre></td></tr></table></figure><p>é”®å€¼å¯¹çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæˆ–ä¸€ä¸ªuint64_tæ•´æ•°ï¼Œæˆ–ä¸€ä¸ªint64_æ•´æ•°ã€‚nextæ˜¯æŒ‡å‘å¦ä¸€ä¸ªå“ˆå¸ŒèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå¯å°†å¤šä¸ªå“ˆå¸Œå€¼ç›¸åŒçš„é”®å€¼å¯¹è¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥æ­¤æ¥è§£å†³å†²çªã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424100809559.png" alt="image-20240424100809559"></p><h3 id="4-3-å­—å…¸">4.3 å­—å…¸</h3><p>Redisä¸­çš„å­—å…¸ç”±<code>dict.h/dict</code>å®ç°ï¼Œç”±è¿™ä¸ªæ•°æ®ç»“æ„å°†å­—å…¸ç»„ç»‡åœ¨ä¸€èµ·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span>&#123;</span></span><br><span class="line">    <span class="comment">//ç±»å‹ç‰¹å®šå‡½æ•°</span></span><br><span class="line">    dictType *type;</span><br><span class="line">    <span class="comment">//ç§æœ‰æ•°æ®</span></span><br><span class="line">    <span class="type">void</span> *privdata;</span><br><span class="line">    <span class="comment">//å“ˆå¸Œè¡¨</span></span><br><span class="line">    dictht ht[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">//rehashç´¢å¼•</span></span><br><span class="line">    <span class="comment">//å½“rehashä¸åœ¨è¿›è¡Œæ—¶ï¼Œå€¼ä¸º-1</span></span><br><span class="line">    <span class="type">int</span> rehashidx;</span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure><p>typeå’Œprivdataå±æ€§æ˜¯é’ˆå¯¹ä¸åŒç±»å‹çš„é”®å€¼å¯¹ï¼Œä¸ºä¸°å¯Œé”®å€¼å¯¹çš„ä½¿ç”¨åœºæ™¯è€Œè®¾ç½®çš„ã€‚</p><ul><li>typeå±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘dictTypeçš„ç»“æ„æŒ‡é’ˆï¼Œæ¯ä¸ªdictTypeç»“æ„ä¿å­˜äº†ä¸€ç°‡ç”¨äºæ“ä½œç‰¹å®šç±»å‹é”®å€¼å¯¹çš„å‡½æ•°ï¼ŒRedisä¸ºç”¨é€”ä¸åŒçš„å­—å…¸è®¾ç½®ä¸åŒç±»å‹ç‰¹å®šå‡½æ•°ã€‚</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">dictType</span>&#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—å“ˆå¸Œå€¼çš„å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="type">unsigned</span> <span class="title">int</span> <span class="params">(*hashFunction)</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *key)</span></span>;</span><br><span class="line">    <span class="comment">// å¤åˆ¶é”®çš„å‡½æ•°</span></span><br><span class="line">    <span class="type">void</span> *(*keyDup)(<span class="type">void</span> *privdata,<span class="type">const</span> <span class="type">void</span> *key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>privdataå±æ€§ä¿å­˜äº†éœ€è¦ä¼ ç»™é‚£äº›ç±»å‹ç‰¹å®šå‡½æ•°çš„å¯é€‰å‚æ•°ã€‚</li><li>htå±æ€§æ˜¯åŒ…å«ä¸¤ä¸ªé¡¹çš„æ•°ç»„ï¼Œæ¯é¡¹éƒ½æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œht[0]å¹³æ—¶ä½¿ç”¨ï¼Œè€Œht[1]ä»…åœ¨rehashæ—¶ä½¿ç”¨ã€‚</li><li>rehashidxè®°å½•äº†rehashçš„è¿›åº¦ï¼Œåˆå§‹ä¸º-1ã€‚</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424100919619.png" alt="image-20240424100919619"></p><h3 id="4-4-å“ˆå¸Œç®—æ³•">4.4 å“ˆå¸Œç®—æ³•</h3><p>Redisè®¡ç®—å“ˆå¸Œå€¼æ–¹æ³•ï¼š hash=dict-&gt;type-&gt;hashFunction(key);<br>è®¡ç®—ç´¢å¼•å€¼çš„æ–¹æ³•ï¼šindex=hash &amp; dict-&gt;ht[x].sizemask;</p><p>å½“å­—å…¸è¢«ç”¨ä½œæ•°æ®åº“çš„åº•å±‚å®ç°æˆ–å“ˆå¸Œé”®çš„åº•å±‚å®ç°æ—¶ï¼ŒRedisä½¿ç”¨<strong>MurmurHash2ç®—æ³•</strong>æ¥è®¡ç®—é”®çš„å“ˆå¸Œå€¼ã€‚ä¼˜ç‚¹åœ¨äºå³ä½¿è¾“å…¥çš„é”®æ˜¯æœ‰è§„å¾‹çš„ï¼Œç®—æ³•ä»ç„¶èƒ½ç»™å‡º<strong>å¾ˆå¥½çš„éšæœºåˆ†å¸ƒæ€§</strong>ï¼Œå¹¶ä¸”è®¡ç®—<strong>é€Ÿåº¦é£å¿«</strong>ã€‚</p><h3 id="4-5-è§£å†³é”®å†²çª">4.5 è§£å†³é”®å†²çª</h3><p>å½“æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„é”®è¢«åˆ†é…åˆ°å“ˆå¸Œè¡¨çš„åŒä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº†å†²çªã€‚Redisä½¿ç”¨é“¾åœ°å€æ³•æ¥è§£å†³å†²çªï¼Œè¢«åˆ†é…åˆ°ç´¢å¼•çš„å¤šä¸ªèŠ‚ç‚¹ä½¿ç”¨é“¾è¡¨è¿æ¥ã€‚ä¸ºäº†æé«˜é€Ÿåº¦ï¼Œæ¯æ¬¡éƒ½æ˜¯å°†æ–°èŠ‚ç‚¹æ·»åŠ åˆ°é“¾è¡¨çš„è¡¨å¤´ä½ç½®ã€‚</p><h3 id="4-6-rehash">4.6 rehash</h3><blockquote><p><strong>æ‰§è¡Œæ‰©å±•æˆ–æ”¶ç¼©æ“ä½œçš„æ¡ä»¶</strong></p></blockquote><p><strong>Dictçš„æ‰©å®¹</strong></p><p>Dictä¸­çš„HashTableå°±æ˜¯æ•°ç»„ç»“åˆå•å‘é“¾è¡¨çš„å®ç°ï¼Œå½“é›†åˆä¸­å…ƒç´ è¾ƒå¤šæ—¶ï¼Œå¿…ç„¶å¯¼è‡´å“ˆå¸Œå†²çªå¢å¤šï¼Œé“¾è¡¨è¿‡é•¿ï¼Œåˆ™æŸ¥è¯¢æ•ˆç‡ä¼šå¤§å¤§é™ä½ã€‚</p><p>Dictåœ¨æ¯æ¬¡æ–°å¢é”®å€¼å¯¹æ—¶éƒ½ä¼šæ£€æŸ¥è´Ÿè½½å› å­ï¼ˆLoadFactorï¼‰ ï¼Œæ»¡è¶³ä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶ä¼šè§¦å‘å“ˆå¸Œè¡¨æ‰©å®¹ã€‚</p><ul><li>æœåŠ¡ç›®å‰æ²¡æœ‰åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 1 ã€‚</li><li>æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡ŒBGSAVEå‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 5 ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ è´Ÿè½½å› å­ = å“ˆå¸Œè¡¨å·²ä¿å­˜çš„èŠ‚ç‚¹æ•°é‡ / å“ˆå¸Œè¡¨å¤§å°</span><br><span class="line">load_factor = ht[0].used / ht[0].size;</span><br></pre></td></tr></table></figure><p><strong>Dictçš„æ”¶ç¼©</strong></p><p>Dicté™¤äº†æ‰©å®¹ä»¥å¤–ï¼Œæ¯æ¬¡åˆ é™¤å…ƒç´ æ—¶ï¼Œä¹Ÿä¼šå¯¹è´Ÿè½½å› å­åšæ£€æŸ¥ï¼Œå½“LoadFactor &lt; 0.1 æ—¶ï¼Œä¼šåšå“ˆå¸Œè¡¨æ”¶ç¼©ã€‚</p><blockquote><p><strong>rehash</strong></p></blockquote><p><strong>Dictçš„rehash</strong></p><p>ä¸ç®¡æ˜¯æ‰©å®¹è¿˜æ˜¯æ”¶ç¼©ï¼Œå¿…å®šä¼šåˆ›å»ºæ–°çš„å“ˆå¸Œè¡¨ï¼Œå¯¼è‡´å“ˆå¸Œè¡¨çš„sizeå’Œsizemaskå˜åŒ–ï¼Œè€Œkeyçš„æŸ¥è¯¢ä¸sizemaskæœ‰å…³ã€‚å› æ­¤å¿…é¡»å¯¹å“ˆå¸Œè¡¨ä¸­çš„æ¯ä¸€ä¸ªkeyé‡æ–°è®¡ç®—ç´¢å¼•ï¼Œæ’å…¥æ–°çš„å“ˆå¸Œè¡¨ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºrehashã€‚è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>è®¡ç®—æ–°hashè¡¨çš„realeSizeï¼Œå€¼å–å†³äºå½“å‰è¦åšçš„æ˜¯æ‰©å®¹è¿˜æ˜¯æ”¶ç¼©ï¼š<br>å¦‚æœæ˜¯æ‰©å®¹ï¼Œ<a href="http://xn--sizedict-309lrnyf93ba308jhyz009bulyebpa.ht">åˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht</a>[0].used + 1çš„2^n<br>å¦‚æœæ˜¯æ”¶ç¼©ï¼Œ<a href="http://xn--sizedict-309lrnyf93ba308jhyz009bulyebpa.ht">åˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht</a>[0].usedçš„2^n ï¼ˆä¸å¾—å°äº4ï¼‰</li><li>æŒ‰ç…§æ–°çš„realeSizeç”³è¯·å†…å­˜ç©ºé—´ï¼Œåˆ›å»ºdicthtï¼Œ<a href="http://xn--dict-9k7fo76ei05chfya.ht">å¹¶èµ‹å€¼ç»™dict.ht</a>[1]</li><li>è®¾ç½®dict.rehashidx = 0ï¼Œæ ‡ç¤ºå¼€å§‹rehash</li><li><a href="http://xn--dict-fw9g.ht">å°†dict.ht</a>[0]<a href="http://xn--dictEntryrehashdict-f673ahz3bw09ldr4l367by3xi.ht">ä¸­çš„æ¯ä¸€ä¸ªdictEntryéƒ½rehashåˆ°dict.ht</a>[1]</li><li><a href="http://xn--dict-fw9g.ht">å°†dict.ht</a>[1]<a href="http://xn--dict-9k7f028vteva.ht">èµ‹å€¼ç»™dict.ht</a>[0]ï¼Œ<a href="http://xn--dict-z95k.ht">ç»™dict.ht</a>[1]åˆå§‹åŒ–ä¸ºç©ºå“ˆå¸Œè¡¨ï¼Œ<a href="http://xn--dict-430gi74gild203bjk5c.ht">é‡Šæ”¾åŸæ¥çš„dict.ht</a>[0]çš„å†…å­˜</li></ul><p>rehashå‰</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424102112213.png" alt="image-20240424102112213"></p><p>rehashå</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424102044457.png" alt="image-20240424102044457"></p><h3 id="4-7-æ¸è¿›å¼rehash">4.7 æ¸è¿›å¼rehash</h3><p>Dictçš„rehashå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆçš„ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœDictä¸­åŒ…å«æ•°ç™¾ä¸‡çš„entryï¼Œè¦åœ¨ä¸€æ¬¡rehashå®Œæˆï¼Œææœ‰å¯èƒ½å¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ã€‚å› æ­¤Dictçš„rehashæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼çš„å®Œæˆï¼Œå› æ­¤ç§°ä¸º<strong>æ¸è¿›å¼rehash</strong>ã€‚æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è®¡ç®—æ–°hashè¡¨çš„sizeï¼Œå€¼å–å†³äºå½“å‰è¦åšçš„æ˜¯æ‰©å®¹è¿˜æ˜¯æ”¶ç¼©ï¼š<br>å¦‚æœæ˜¯æ‰©å®¹ï¼Œ<a href="http://xn--sizedict-309lrnyf93ba308jhyz009bulyebpa.ht">åˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht</a>[0].used + 1çš„2^n<br>å¦‚æœæ˜¯æ”¶ç¼©ï¼Œ<a href="http://xn--sizedict-309lrnyf93ba308jhyz009bulyebpa.ht">åˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht</a>[0].usedçš„2^n ï¼ˆä¸å¾—å°äº4ï¼‰</li><li>æŒ‰ç…§æ–°çš„sizeç”³è¯·å†…å­˜ç©ºé—´ï¼Œåˆ›å»ºdicthtï¼Œ<a href="http://xn--dict-9k7fo76ei05chfya.ht">å¹¶èµ‹å€¼ç»™dict.ht</a>[1]</li><li>è®¾ç½®dict.rehashidx = 0ï¼Œæ ‡ç¤ºå¼€å§‹rehash</li><li><s><a href="http://xn--dict-fw9g.ht">å°†dict.ht</a>[0]<a href="http://xn--dictEntryrehashdict-f673ahz3bw09ldr4l367by3xi.ht">ä¸­çš„æ¯ä¸€ä¸ªdictEntryéƒ½rehashåˆ°dict.ht</a>[1]</s></li><li>æ¯æ¬¡æ‰§è¡Œæ–°å¢ã€æŸ¥è¯¢ã€ä¿®æ”¹ã€åˆ é™¤æ“ä½œæ—¶ï¼Œéƒ½æ£€æŸ¥ä¸€ä¸‹dict.rehashidxæ˜¯å¦å¤§äº-1ï¼Œ<a href="http://xn--dict-fj9fn60b3meqtz33c.ht">å¦‚æœæ˜¯åˆ™å°†dict.ht</a>[0].table[rehashidx]<a href="http://xn--entryrehashdict-df7y2036bukvcc86b.ht">çš„entryé“¾è¡¨rehashåˆ°dict.ht</a>[1]ï¼Œå¹¶ä¸”å°†rehashidx++ã€‚<a href="http://xn--dict-907j085c.ht">ç›´è‡³dict.ht</a>[0]<a href="http://xn--rehashdict-s11qz55mghdu3ijtgvl6e2byf.ht">çš„æ‰€æœ‰æ•°æ®éƒ½rehashåˆ°dict.ht</a>[1]</li><li><a href="http://xn--dict-fw9g.ht">å°†dict.ht</a>[1]<a href="http://xn--dict-9k7f028vteva.ht">èµ‹å€¼ç»™dict.ht</a>[0]ï¼Œ<a href="http://xn--dict-z95k.ht">ç»™dict.ht</a>[1]åˆå§‹åŒ–ä¸ºç©ºå“ˆå¸Œè¡¨ï¼Œ<a href="http://xn--dict-430gi74gild203bjk5c.ht">é‡Šæ”¾åŸæ¥çš„dict.ht</a>[0]çš„å†…å­˜</li><li>å°†rehashidxèµ‹å€¼ä¸º-1ï¼Œä»£è¡¨rehashç»“æŸ<br>åœ¨rehashè¿‡ç¨‹ä¸­ï¼Œæ–°å¢æ“ä½œï¼Œåˆ™ç›´æ¥å†™å…¥ht[1]ï¼ŒæŸ¥è¯¢ã€<a href="http://xn--dict-ue6fy7b90hub348a7phvn7bvk9i.ht">ä¿®æ”¹å’Œåˆ é™¤åˆ™ä¼šåœ¨dict.ht</a>[0]<a href="http://xn--dict-z21g.ht">å’Œdict.ht</a>[1]ä¾æ¬¡æŸ¥æ‰¾å¹¶æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ht[0]çš„æ•°æ®åªå‡ä¸å¢ï¼Œéšç€rehashæœ€ç»ˆä¸ºç©º</li></ul><p><strong>æ€»ç»“</strong>ï¼š</p><p>Qï¼šä¸ºä»€ä¹ˆå“ˆå¸Œè¡¨æ“ä½œå˜æ…¢äº†ï¼Ÿ</p><p>Aï¼šå“ˆå¸Œè¡¨çš„å†²çªé—®é¢˜å’Œ rehash å¯èƒ½å¸¦æ¥çš„æ“ä½œé˜»å¡ã€‚å› æ­¤æå‡ºæ¸è¿›å¼rehash</p><p><strong>æ¸è¿›å¼ rehashä»‹ç»</strong></p><p>ç®€å•æ¥è¯´å°±æ˜¯åœ¨ç¬¬äºŒæ­¥æ‹·è´æ•°æ®æ—¶ï¼ŒRedis ä»ç„¶æ­£å¸¸å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œä»å“ˆå¸Œè¡¨ 1 ä¸­çš„ç¬¬ä¸€ä¸ªç´¢å¼•ä½ç½®å¼€å§‹ï¼Œé¡ºå¸¦ç€å°†è¿™ä¸ªç´¢å¼•ä½ç½®ä¸Šçš„æ‰€æœ‰ entries æ‹·è´åˆ°å“ˆå¸Œè¡¨ 2 ä¸­ï¼›ç­‰å¤„ç†ä¸‹ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå†é¡ºå¸¦æ‹·è´å“ˆå¸Œè¡¨ 1 ä¸­çš„ä¸‹ä¸€ä¸ªç´¢å¼•ä½ç½®çš„ entriesã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425135541925.png" alt="image-20240425135541925"></p><h2 id="ç¬¬äº”ç« -è·³è·ƒè¡¨">ç¬¬äº”ç«  è·³è·ƒè¡¨</h2><p>è·³è·ƒè¡¨ï¼ˆskiplistï¼‰æ˜¯ä¸€ç§æœ‰åºæ•°æ®ç»“æ„ï¼Œå®ƒé€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ç»´æŒå¤šä¸ªæŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œä»è€Œè¾¾åˆ°å¿«é€Ÿè®¿é—®èŠ‚ç‚¹çš„ç›®çš„ã€‚</p><p>è·³è·ƒè¡¨æ”¯æŒå¹³å‡ O(logN) ã€æœ€å O(N) åº¦çš„èŠ‚ç‚¹æŸ¥æ‰¾ï¼Œè¿˜å¯ä»¥é€šè¿‡é¡ºåºæ€§æ“ä½œæ¥æ‰¹é‡å¤„ç†èŠ‚ç‚¹ã€‚Redis åªåœ¨ä¸¤ä¸ªåœ°æ–¹ç”¨åˆ°äº†è·³è·ƒè¡¨ï¼Œä¸€ä¸ªæ˜¯å®ç°æœ‰åºé›†åˆé”®ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­ç”¨ä½œå†…éƒ¨æ•°æ®ç»“æ„ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424102514122.png" alt="image-20240424102514122"></p><p>ä¹‹å‰å®ç°è¿‡è·³è¡¨çš„åŸç†ï¼Œæ¬¢è¿start:<a href="https://github.com/Penge666/SkipList">åŸºäºè·³è¡¨å®ç°çš„K-Vå­˜å‚¨å¼•æ“</a></p><p>æ€»ç»“ï¼š</p><p><strong>è·³è¡¨</strong></p><p>è·³è¡¨åœ¨é“¾è¡¨çš„åŸºç¡€ä¸Šï¼Œ<strong>å¢åŠ äº†å¤šçº§ç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•ä½ç½®çš„å‡ ä¸ªè·³è½¬ï¼Œå®ç°æ•°æ®çš„å¿«é€Ÿå®šä½</strong>ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425135851173.png" alt="image-20240425135851173"></p><p>ç¬¬ä¸€æ¬¡ï¼šå¦‚æœæˆ‘ä»¬è¦åœ¨é“¾è¡¨ä¸­æŸ¥æ‰¾ 33 è¿™ä¸ªå…ƒç´ ï¼Œåªèƒ½ä»å¤´å¼€å§‹éå†é“¾è¡¨ï¼ŒæŸ¥æ‰¾ 6 æ¬¡ï¼Œç›´åˆ°æ‰¾åˆ° 33 ä¸ºæ­¢ã€‚O(N)</p><p>ç¬¬äºŒæ¬¡ï¼šå¢åŠ ä¸€çº§ç´¢å¼•ï¼Œä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œæ¯ä¸¤ä¸ªå…ƒç´ é€‰ä¸€ä¸ªå‡ºæ¥ä½œä¸ºç´¢å¼•ã€‚è¿™äº›ç´¢å¼•å†é€šè¿‡æŒ‡é’ˆæŒ‡å‘åŸå§‹çš„é“¾è¡¨ã€‚ä¾‹å¦‚ï¼Œä»å‰ä¸¤ä¸ªå…ƒç´ ä¸­æŠ½å–å…ƒç´  1 ä½œä¸ºä¸€çº§ç´¢å¼•ï¼Œä»ç¬¬ä¸‰ã€å››ä¸ªå…ƒç´ ä¸­æŠ½å–å…ƒç´  11 ä½œä¸ºä¸€çº§ç´¢å¼•ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ 4 æ¬¡æŸ¥æ‰¾å°±èƒ½å®šä½åˆ°å…ƒç´  33 äº†ã€‚</p><p>ç¬¬ä¸‰æ¬¡ï¼šå¢åŠ äºŒçº§ç´¢å¼•ï¼šä»ä¸€çº§ç´¢å¼•ä¸­ï¼Œå†æŠ½å–éƒ¨åˆ†å…ƒç´ ä½œä¸ºäºŒçº§ç´¢å¼•ã€‚ä¾‹å¦‚ï¼Œä»ä¸€çº§ç´¢å¼•ä¸­æŠ½å– 1ã€27ã€100 ä½œä¸ºäºŒçº§ç´¢å¼•ï¼ŒäºŒçº§ç´¢å¼•æŒ‡å‘ä¸€çº§ç´¢å¼•ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬åªéœ€è¦ 3 æ¬¡æŸ¥æ‰¾ï¼Œå°±èƒ½å®šä½åˆ°å…ƒç´  33 äº†ã€‚</p><p>æ—¶é—´å¤æ‚åº¦ï¼šOï¼ˆlgNï¼‰</p><h2 id="ç¬¬å…­ç« -æ•´æ•°é›†åˆ">ç¬¬å…­ç«  æ•´æ•°é›†åˆ</h2><p>æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯é›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œå½“ä¸€ä¸ªé›†åˆåªåŒ…å«æ•´æ•°å€¼å…ƒç´ ï¼Œå¹¶ä¸”è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼ŒRedis å°±ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚</p><h3 id="6-1-æ•´æ•°é›†åˆçš„å®ç°">6.1 æ•´æ•°é›†åˆçš„å®ç°</h3><p>æ•´æ•°é›†åˆ(intset)æ˜¯ Redisç”¨äºä¿å­˜æ•´æ•°å€¼çš„é›†åˆæŠ½è±¡æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥ä¿å­˜ç±»å‹ä¸ºint16_tã€ int32_tæˆ–è€…int64_tçš„æ•´æ•°å€¼ï¼Œå¹¶ä¸”ä¿è¯é›†åˆä¸­ä¸ä¼šå‡ºç°é‡å¤å…ƒç´ ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">intset</span> &#123;</span><br><span class="line">    <span class="comment">// ç¼–ç æ–¹å¼</span></span><br><span class="line">    <span class="type">uint32_t</span> encoding;</span><br><span class="line">    <span class="comment">// é›†åˆä¸­åŒ…å«çš„å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="type">uint32_t</span> length;</span><br><span class="line">    <span class="comment">// ä¿å­˜å…ƒç´ çš„æ•°ç»„</span></span><br><span class="line">    <span class="type">int8_t</span> contents[];</span><br><span class="line">&#125; intset;</span><br></pre></td></tr></table></figure><p>contentsæ•°ç»„æ˜¯æ•´æ•°é›†åˆçš„åº•å±‚å®ç°ï¼šæ•´æ•°é›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ contentsæ•°ç»„çš„ä¸€ä¸ªæ•°ç»„é¡¹ï¼ˆitemï¼‰ï¼Œå„ä¸ªé¡¹åœ¨æ•°ç»„ä¸­æŒ‰å€¼çš„å¤§å°ä»å°åˆ°å¤§æœ‰åºçš„æ’åˆ—ï¼Œå¹¶ä¸”æ•°ç»„ä¸­ä¸åŒ…å«ä»»ä½•é‡å¤é¡¹ã€‚</p><h3 id="6-2-å‡çº§">6.2 å‡çº§</h3><p>å½“æˆ‘ä»¬è¦å°†ä¸€ä¸ªæ–°å…ƒç´ æ·»åŠ è‡³é›†åˆæ—¶ï¼Œå¹¶ä¸”æ–°å…ƒç´ çš„ç±»å‹æ¯”ç°æœ‰é›†åˆç±»å‹éƒ½é•¿æ—¶ï¼Œæ•´æ•°é›†åˆå°±è¦å‡çº§ã€‚</p><p>æ­¥éª¤ï¼š</p><ol><li>æ ¹æ®æ–°å…ƒç´ ç±»å‹ï¼Œæ‰©å±•æ•°ç»„ç©ºé—´ï¼Œä¸ºæ–°å…ƒç´ åˆ†é…ç©ºé—´ã€‚</li><li>å°†åº•å±‚æ•°ç»„ç°æœ‰æ‰€æœ‰å…ƒç´ éƒ½è½¬ä¸ºæ–°å…ƒç´ ç›¸åŒç±»å‹ï¼Œå¹¶å°†ç±»å‹è½¬æ¢åçš„å…ƒç´ æ”¾åˆ°æ­£ç¡®ä½ç½®ã€‚</li><li>å°†æ–°å…ƒç´ æ·»åŠ åˆ°åº•å±‚æ•°ç»„ã€‚</li></ol><p>ç”±äºæ¯æ¬¡å‘æ•´æ•°é›†åˆæ·»åŠ æ–°å…ƒç´ éƒ½å¯èƒ½ä¼šå¼•èµ·å‡çº§ï¼Œè€Œæ¯æ¬¡å‡çº§éƒ½éœ€è¦å¯¹åº•å±‚æ•°ç»„ä¸­å·²æœ‰å…ƒç´ è¿›è¡Œç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥æ·»åŠ çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ã€‚</p><h3 id="6-3-å‡çº§çš„å¥½å¤„">6.3 å‡çº§çš„å¥½å¤„</h3><ul><li><p>æ•´æ•°é›†åˆçš„å‡çº§ç­–ç•¥æœ‰ä¸¤ä¸ªå¥½å¤„ï¼Œä¸€ä¸ªæ˜¯æå‡æ•´æ•°é›†åˆçš„çµæ´»æ€§ï¼Œå¦ä¸€ä¸ªæ˜¯å°½å¯èƒ½çš„èŠ‚çº¦å†…å­˜ã€‚</p><p>Noteï¼šæ•´æ•°é›†åˆä¸æ”¯æŒé™çº§æ“ä½œï¼Œä¸€æ—¦å¯¹æ•°ç»„è¿›è¡Œäº†å‡çº§ï¼Œç¼–ç å°±ä¼šä¸€ç›´ä¿æŒå‡çº§åçš„çŠ¶æ€ã€‚</p></li></ul><h2 id="ç¬¬ä¸ƒç« -å‹ç¼©åˆ—è¡¨">ç¬¬ä¸ƒç«  å‹ç¼©åˆ—è¡¨</h2><p>ZipList æ˜¯ä¸€ç§ç‰¹æ®Šçš„â€œåŒç«¯é“¾è¡¨â€ ï¼Œç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆã€‚å¯ä»¥åœ¨ä»»æ„ä¸€ç«¯è¿›è¡Œå‹å…¥/å¼¹å‡ºæ“ä½œ, å¹¶ä¸”è¯¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424103109865.png" alt="image-20240424103109865"></p><table><thead><tr><th><strong>å±æ€§</strong></th><th><strong>ç±»å‹</strong></th><th><strong>é•¿åº¦</strong></th><th><strong>ç”¨é€”</strong></th></tr></thead><tbody><tr><td>zlbytes</td><td>uint32_t</td><td>4 å­—èŠ‚</td><td>è®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°</td></tr><tr><td>zltail</td><td>uint32_t</td><td>4 å­—èŠ‚</td><td>è®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»å‹ç¼©åˆ—è¡¨çš„èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼Œé€šè¿‡è¿™ä¸ªåç§»é‡ï¼Œå¯ä»¥ç¡®å®šè¡¨å°¾èŠ‚ç‚¹çš„åœ°å€ã€‚</td></tr><tr><td>zllen</td><td>uint16_t</td><td>2 å­—èŠ‚</td><td>è®°å½•äº†å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ã€‚ æœ€å¤§å€¼ä¸ºUINT16_MAX ï¼ˆ65534ï¼‰ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªå€¼ï¼Œæ­¤å¤„ä¼šè®°å½•ä¸º65535ï¼Œä½†èŠ‚ç‚¹çš„çœŸå®æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è®¡ç®—å¾—å‡ºã€‚</td></tr><tr><td>entry</td><td>åˆ—è¡¨èŠ‚ç‚¹</td><td>ä¸å®š</td><td>å‹ç¼©åˆ—è¡¨åŒ…å«çš„å„ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é•¿åº¦ç”±èŠ‚ç‚¹ä¿å­˜çš„å†…å®¹å†³å®šã€‚</td></tr><tr><td>zlend</td><td>uint8_t</td><td>1 å­—èŠ‚</td><td>ç‰¹æ®Šå€¼ 0xFF ï¼ˆåè¿›åˆ¶ 255 ï¼‰ï¼Œç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯ã€‚</td></tr></tbody></table><p><strong>ZipListEntry</strong></p><p>ZipList ä¸­çš„Entryå¹¶ä¸åƒæ™®é€šé“¾è¡¨é‚£æ ·è®°å½•å‰åèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› ä¸ºè®°å½•ä¸¤ä¸ªæŒ‡é’ˆè¦å ç”¨16ä¸ªå­—èŠ‚ï¼Œæµªè´¹å†…å­˜ã€‚è€Œæ˜¯é‡‡ç”¨äº†ä¸‹é¢çš„ç»“æ„ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424103141314.png" alt="image-20240424103141314"></p><ul><li>previous_entry_lengthï¼šå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦ï¼Œå 1ä¸ªæˆ–5ä¸ªå­—èŠ‚ã€‚<br>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨1ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼<br>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨5ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xfeï¼Œåå››ä¸ªå­—èŠ‚æ‰æ˜¯çœŸå®é•¿åº¦æ•°æ®</li><li>encodingï¼šç¼–ç å±æ€§ï¼Œè®°å½•contentçš„æ•°æ®ç±»å‹ï¼ˆå­—ç¬¦ä¸²è¿˜æ˜¯æ•´æ•°ï¼‰ä»¥åŠé•¿åº¦ï¼Œå ç”¨1ä¸ªã€2ä¸ªæˆ–5ä¸ªå­—èŠ‚</li><li>contentsï¼šè´Ÿè´£ä¿å­˜èŠ‚ç‚¹çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ•´æ•°</li></ul><p><strong>ZipListçš„è¿é”æ›´æ–°é—®é¢˜</strong></p><ul><li>ZipListçš„æ¯ä¸ªEntryéƒ½åŒ…å«previous_entry_lengthæ¥è®°å½•ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°ï¼Œé•¿åº¦æ˜¯1ä¸ªæˆ–5ä¸ªå­—èŠ‚ï¼š<br>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨1ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼<br>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨5ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xfeï¼Œåå››ä¸ªå­—èŠ‚æ‰æ˜¯çœŸå®é•¿åº¦æ•°æ®</li></ul><p>ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æœ‰Nä¸ªè¿ç»­çš„ã€é•¿åº¦ä¸º250~253å­—èŠ‚ä¹‹é—´çš„entryï¼Œå› æ­¤entryçš„previous_entry_lengthå±æ€§ç”¨1ä¸ªå­—èŠ‚å³å¯è¡¨ç¤ºï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424103344907.png" alt="image-20240424103344907"></p><p><strong>ZipListè¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹äº§ç”Ÿçš„è¿ç»­å¤šæ¬¡ç©ºé—´æ‰©å±•æ“ä½œç§°ä¹‹ä¸ºè¿é”æ›´æ–°</strong>ï¼ˆCascade Updateï¼‰ã€‚æ–°å¢ã€åˆ é™¤éƒ½å¯èƒ½å¯¼è‡´è¿é”æ›´æ–°çš„å‘ç”Ÿã€‚</p><h2 id="ç¬¬å…«ç« -å¯¹è±¡">ç¬¬å…«ç«  å¯¹è±¡</h2><p>Redis<strong>æ²¡æœ‰ç›´æ¥ä½¿ç”¨</strong>å‰æ–‡çš„æ•°æ®ç»“æ„æ¥å®ç°é”®å€¼å¯¹æ•°æ®åº“ï¼Œè€Œæ˜¯åŸºäºè¿™äº›æ•°æ®ç»“æ„æ„å»ºäº†ä¸€ä¸ªå¯¹è±¡ç³»ç»Ÿï¼Œé€šè¿‡å¯¹è±¡ç»„ç»‡æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬å­—<strong>ç¬¦ä¸²å¯¹è±¡ï¼Œåˆ—è¡¨å¯¹è±¡ï¼Œå“ˆå¸Œå¯¹è±¡ï¼Œé›†åˆå¯¹è±¡</strong>å’Œ<strong>æœ‰åºé›†åˆå¯¹è±¡è¿™</strong>5ç§å¯¹è±¡ã€‚</p><p>ä½¿ç”¨å¯¹è±¡çš„ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä»¥é’ˆå¯¹ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œä¸ºå¯¹è±¡<strong>è®¾ç½®å¤šç§ä¸åŒçš„æ•°æ®ç»“æ„å®ç°</strong>ï¼Œä»è€Œä¼˜åŒ–å¯¹è±¡åœ¨ä¸åŒåœºæ™¯ä¸‹çš„ä½¿ç”¨æ•ˆç‡ã€‚</p><h3 id="8-1-å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç ">8.1 å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç </h3><p>Redisä½¿ç”¨å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„é”®å’Œå€¼ï¼Œæ¯æ¬¡å½“æˆ‘ä»¬åœ¨Redis çš„æ•°æ®åº“ä¸­æ–°åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œæˆ‘ä»¬è‡³å°‘ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„é”®ï¼ˆé”®å¯¹è±¡)ï¼Œå¦ä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„å€¼ï¼ˆå€¼å¯¹è±¡)ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424103518790.png" alt="image-20240424103518790"></p><p><strong>8.1.1 ç±»å‹</strong></p><p>å¯¹è±¡çš„ typeå±æ€§è®°å½•äº†å¯¹è±¡çš„ç±»å‹ï¼Œå…¶å€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡ã€æœ‰åºé›†åˆå¯¹è±¡ã€‚</p><p>å¯¹äº Redis æ•°æ®åº“ä¿å­˜çš„é”®å€¼å¯¹æ¥è¯´ï¼Œé”®æ€»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œè€Œå€¼åˆ™å¯ä»¥æ˜¯å…¶ä»–ç±»å‹å¯¹è±¡ä¸­çš„ä¸€ç§ï¼Œå› æ­¤ï¼š</p><ul><li>å½“æˆ‘ä»¬ç§°å‘¼ä¸€ä¸ªæ•°æ®åº“é”®ä¸º â€œå­—ç¬¦ä¸²é”®â€ æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯ â€œè¿™ä¸ªæ•°æ®åº“é”®æ‰€å¯¹åº”çš„å€¼ä¸ºå­—ç¬¦ä¸²å¯¹è±¡â€ï¼›</li><li>å½“æˆ‘ä»¬ç§°å‘¼ä¸€ä¸ªé”®ä¸º â€œåˆ—è¡¨é”®â€ æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯ â€œè¿™ä¸ªæ•°æ®åº“é”®æ‰€å¯¹åº”çš„å€¼ä¸ºåˆ—è¡¨å¯¹è±¡â€ ã€‚</li></ul><p>TYPEå‘½ä»¤çš„å®ç°æ–¹å¼ä¹Ÿä¸æ­¤ç±»ä¼¼ï¼Œå½“æˆ‘ä»¬å¯¹ä¸€ä¸ªæ•°æ®åº“é”®æ‰§è¡ŒTYPEå‘½ä»¤æ—¶ï¼Œå‘½ä»¤è¿”å›çš„ç»“æœä¸ºæ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç±»å‹ï¼Œè€Œä¸æ˜¯é”®å¯¹è±¡çš„ç±»å‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424103820248.png" alt=""></p><p><strong>7.1.2 ç¼–ç å’Œåº•å±‚å®ç°</strong></p><p>å¯¹è±¡çš„ ptræŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åº•å±‚å®ç°æ•°æ®ç»“æ„ï¼Œè€Œè¿™äº›æ•°æ®ç»“æ„ç”±å¯¹è±¡çš„ encoding å±æ€§å†³å®šã€‚</p><p>encodingå±æ€§è®°å½•äº†å¯¹è±¡æ‰€ä½¿ç”¨çš„ç¼–ç ï¼Œä¹Ÿå³æ˜¯è¯´è¿™ä¸ªå¯¹è±¡ä½¿ç”¨äº†ä»€ä¹ˆæ•°æ®ç»“æ„ä½œä¸ºå¯¹è±¡çš„åº•å±‚å®ç°ã€‚</p><p>ä½¿ç”¨OBJECT ENCODINGå‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªæ•°æ®åº“é”®çš„å€¼å¯¹è±¡çš„ç¼–ç </p><p>Redisä¸­ä¼šæ ¹æ®å­˜å‚¨çš„æ•°æ®ç±»å‹ä¸åŒï¼Œé€‰æ‹©ä¸åŒçš„ç¼–ç æ–¹å¼ã€‚æ¯ç§æ•°æ®ç±»å‹çš„ä½¿ç”¨çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424104027791.png" alt="image-20240424104027791"></p><h3 id="8-2-å­—ç¬¦ä¸²å¯¹è±¡">8.2 å­—ç¬¦ä¸²å¯¹è±¡</h3><p>å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ int ã€raw ã€æˆ–è€… embstr ã€‚</p><ul><li>å¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯æ•´æ•°å€¼ï¼Œå¹¶ä¸”è¿™ä¸ªæ•´æ•°å€¼å¯ä»¥ç”¨ long ç±»å‹æ¥è¡¨ç¤ºï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡ä¼šå°†æ•´æ•°å€¼ä¿å­˜åœ¨å­—ç¬¦ä¸²å¯¹è±¡ç»“æ„çš„ ptr å±æ€§é‡Œé¢ï¼ˆå°† void* è½¬æ¢æˆ longï¼‰ï¼Œå¹¶å°†å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º intã€‚</li><li>å¦‚æœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”è¿™ä¸ªå­—ç¬¦ä¸²å€¼çš„é•¿åº¦å¤§äº 32 å­—èŠ‚ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡å°†ä½¿ç”¨ä¸€ä¸ªç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º rawã€‚</li><li>å¦‚æœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”è¿™ä¸ªå­—ç¬¦ä¸²å€¼çš„é•¿åº¦å°äºç­‰äº 32 å­—èŠ‚ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡å°†ä½¿ç”¨ embstrç¼–ç çš„æ–¹å¼æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²å€¼ ã€‚</li></ul><p>rawç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424104214996.png" alt="image-20240424104214996"></p><p>embstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424104231320.png" alt="image-20240424104231320"></p><p><strong>raw ä¸ embstr çš„åŒºåˆ«</strong>æ˜¯ï¼šrawç¼–ç ä¼šè°ƒç”¨ä¸¤æ¬¡å†…å­˜åˆ†é…å‡½æ•°æ¥åˆ†åˆ«åˆ›å»º redisObject ç»“æ„å’Œ sdshdr ç»“æ„ï¼Œè€Œ embstrç¼–ç åˆ™é€šè¿‡ä¸€æ¬¡å†…å­˜åˆ†é…å‡½æ•°æ¥åˆ†é…ä¸€å—è¿ç»­çš„ç©ºé—´ï¼Œç©ºé—´ä¸­ä¾æ¬¡åŒ…å« redisObjectå’Œ sdshdr ä¸¤ä¸ªç»“æ„ ã€‚</p><p><strong>ç¼–ç è½¬æ¢</strong></p><p>å¯¹äºintç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬å‘å¯¹è±¡æ‰§è¡Œäº†ä¸€äº›å‘½ä»¤ï¼Œä½¿å¾—è¿™ä¸ªå¯¹è±¡ä¿å­˜çš„ä¸å†æ˜¯æ•´æ•°å€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å°†ä»intå˜ä¸ºrawã€‚</p><p>å¦å¤–ï¼Œå› ä¸ºRedisæ²¡æœ‰ä¸ºembstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ç¼–å†™ä»»ä½•ç›¸åº”çš„ä¿®æ”¹ç¨‹åºï¼ˆåªæœ‰intç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡å’Œrawç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æœ‰è¿™äº›ç¨‹åº)ï¼Œæ‰€ä»¥embstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡å®é™…ä¸Šæ˜¯åªè¯»çš„ã€‚å½“æˆ‘ä»¬å¯¹embstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ‰§è¡Œä»»ä½•ä¿®æ”¹å‘½ä»¤æ—¶ï¼Œç¨‹åºä¼šå…ˆå°†å¯¹è±¡çš„ç¼–ç ä»embstrè½¬æ¢æˆrawï¼Œç„¶åå†æ‰§è¡Œä¿®æ”¹å‘½ä»¤ã€‚å› ä¸ºè¿™ä¸ªåŸå› ï¼Œembstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ‰§è¡Œä¿®æ”¹å‘½ä»¤ä¹‹åï¼Œæ€»ä¼šå˜æˆä¸€ä¸ªrawç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚</p><h3 id="8-3-åˆ—è¡¨å¯¹è±¡">8.3 åˆ—è¡¨å¯¹è±¡</h3><p>åˆ—è¡¨å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ ziplistæˆ–è€… linkedlist ã€‚</p><ul><li>ziplistç¼–ç çš„åˆ—è¡¨å¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯ä¸ªå‹ç¼©åˆ—è¡¨èŠ‚ç‚¹ï¼ˆentryï¼‰ä¿å­˜äº†ä¸€ä¸ªåˆ—è¡¨å…ƒç´ ã€‚</li><li>linkedlistç¼–ç çš„åˆ—è¡¨å¯¹è±¡ä½¿ç”¨åŒç«¯é“¾è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯ä¸ªåŒç«¯é“¾è¡¨èŠ‚ç‚¹ï¼ˆnodeï¼‰éƒ½ä¿å­˜äº†ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œè€Œæ¯ä¸ªå­—ç¬¦ä¸²å¯¹è±¡éƒ½ä¿å­˜äº†ä¸€ä¸ªåˆ—è¡¨å…ƒç´ </li></ul><p><strong>ç¼–ç è½¬æ¢</strong></p><p>å½“åˆ—è¡¨å¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œåˆ—è¡¨å¯¹è±¡ä½¿ç”¨ ziplist ç¼–ç ï¼š</p><ul><li>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº 64 å­—èŠ‚ï¼›</li><li>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 512 ä¸ªï¼›</li></ul><p>ä¸èƒ½æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„åˆ—è¡¨å¯¹è±¡éœ€è¦ä½¿ç”¨ linkedlist ç¼–ç ã€‚æ³¨æ„è¿™ä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚</p><h3 id="8-4-å“ˆå¸Œå¯¹è±¡">8.4 å“ˆå¸Œå¯¹è±¡</h3><p>å“ˆå¸Œå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ ziplistæˆ–è€… hashtable ã€‚</p><p>ä½¿ç”¨ ziplistç¼–ç çš„å“ˆå¸Œå¯¹è±¡æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li>ä¿å­˜äº†åŒä¸€é”®å€¼å¯¹çš„ä¸¤ä¸ªèŠ‚ç‚¹æ€»æ˜¯ç´§æŒ¨åœ¨ä¸€èµ·ï¼Œä¿å­˜é”®çš„èŠ‚ç‚¹åœ¨å‰ï¼Œä¿å­˜å€¼çš„èŠ‚ç‚¹åœ¨åã€‚</li><li>å…ˆæ·»åŠ åˆ°å“ˆå¸Œå¯¹è±¡ä¸­çš„é”®å€¼å¯¹ä¼šè¢«æ”¾åœ¨å‹ç¼©åˆ—è¡¨çš„è¡¨å¤´æ–¹å‘ï¼Œè€Œåæ¥æ·»åŠ åˆ°å“ˆå¸Œå¯¹è±¡ä¸­çš„é”®å€¼å¯¹ä¼šè¢«æ”¾åœ¨å‹ç¼©åˆ—è¡¨çš„è¡¨å°¾æ–¹å‘ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424104719359.png" alt="image-20240424104719359"></p><p>ä½¿ç”¨ hashtableç¼–ç çš„å“ˆå¸Œå¯¹è±¡æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li>å­—å…¸çš„æ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯¹è±¡ä¸­ä¿å­˜äº†é”®å€¼å¯¹çš„é”®ï¼›</li><li>å­—å…¸çš„æ¯ä¸ªå€¼éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯¹è±¡ä¸­ä¿å­˜äº†é”®å€¼å¯¹çš„å€¼ï¼›</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424104728270.png" alt="image-20240424104728270"></p><p><strong>ç¼–ç è½¬æ¢</strong></p><p>å½“å“ˆå¸Œå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå“ˆå¸Œå¯¹è±¡ä½¿ç”¨ ziplist ç¼–ç ï¼š</p><ol><li>å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰é”®å€¼å¯¹çš„é”®å’Œå€¼çš„å­—ç¬¦ä¸²é•¿åº¦éƒ½å°äº 64 å­—èŠ‚ï¼›</li><li>å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å°äº 512 ä¸ªï¼›</li></ol><p>è¿™ä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼ä¹Ÿæ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œä¸æ»¡è¶³æ¡ä»¶çš„å“ˆå¸Œå¯¹è±¡éœ€è¦ä½¿ç”¨ hashtable ç¼–ç ã€‚</p><h3 id="8-5-é›†åˆå¯¹è±¡">8.5 é›†åˆå¯¹è±¡</h3><p>é›†åˆå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ intsetæˆ–è€… hashtable ã€‚</p><ul><li>intset ç¼–ç çš„é›†åˆå¯¹è±¡ä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºåº•å±‚å®ç°ï¼Œé›†åˆå¯¹è±¡åŒ…å«çš„æ‰€æœ‰å…ƒç´ éƒ½è¢«ä¿å­˜åœ¨æ•´æ•°é›†åˆé‡Œé¢ã€‚</li><li>hashtable ç¼–ç çš„é›†åˆå¯¹è±¡ä½¿ç”¨å­—å…¸ä½œä¸ºåº•å±‚å®ç°ï¼Œå­—å…¸çš„æ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²å¯¹è±¡åŒ…å«äº†ä¸€ä¸ªé›†åˆå…ƒç´ ï¼Œè€Œå­—å…¸çš„å€¼åˆ™å…¨éƒ¨è¢«è®¾ç½®ä¸º null ã€‚</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424104835719.png" alt="image-20240424104835719"></p><p><strong>ç¼–ç è½¬æ¢</strong></p><p>å½“é›†åˆå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå¯¹è±¡ä½¿ç”¨ intsetç¼–ç ï¼š</p><ol><li>é›†åˆå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼ï¼›</li><li>é›†åˆå¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡ä¸è¶…è¿‡ 512 ä¸ªï¼›</li></ol><p>ç¬¬äºŒä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œä¸æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„é›†åˆå¯¹è±¡éœ€è¦ä½¿ç”¨ hashtableç¼–ç ã€‚</p><h3 id="8-6-æœ‰åºé›†åˆå¯¹è±¡">8.6 æœ‰åºé›†åˆå¯¹è±¡</h3><p>æœ‰åºé›†åˆçš„ç¼–ç å¯ä»¥æ˜¯ ziplist æˆ–è€… skiplist ã€‚</p><p>ziplist ç¼–ç çš„å‹ç¼©å¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯ä¸ªé›†åˆå…ƒç´ ä½¿ç”¨ä¸¤ä¸ªç´§æŒ¨åœ¨ä¸€èµ·çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¥ä¿å­˜ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„æˆå‘˜ï¼ˆmemberï¼‰ï¼Œè€Œç¬¬äºŒä¸ªå…ƒç´ åˆ™ä¿å­˜å…ƒç´ çš„åˆ†å€¼ï¼ˆscoreï¼‰ï¼Œå‹ç¼©åˆ—è¡¨å†…çš„é›†åˆå…ƒç´ æŒ‰åˆ†å€¼ä»å°åˆ°å¤§è¿›è¡Œæ’åºã€‚</p><p>å› æ­¤ï¼Œzsetåº•å±‚æ•°æ®ç»“æ„å¿…é¡»æ»¡è¶³é”®å€¼å­˜å‚¨ã€é”®å¿…é¡»å”¯ä¸€ã€å¯æ’åºè¿™å‡ ä¸ªéœ€æ±‚ã€‚</p><ul><li>SkipListï¼šå¯ä»¥æ’åºï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶å­˜å‚¨scoreå’Œeleå€¼ï¼ˆmemberï¼‰</li><li>HTï¼ˆDictï¼‰ï¼šå¯ä»¥é”®å€¼å­˜å‚¨ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®keyæ‰¾value</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424105059158.png" alt="image-20240424105059158"></p><p><strong>ç¼–ç è½¬æ¢</strong></p><p>å½“æœ‰åºé›†åˆå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå¯¹è±¡ä½¿ç”¨ ziplistç¼–ç ï¼š</p><ol><li>æœ‰åºé›†åˆä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 128 ä¸ªï¼›</li><li>æœ‰åºé›†åˆä¿å­˜çš„æ‰€æœ‰å…ƒç´ æˆå‘˜é•¿åº¦éƒ½å°äº 64 å­—èŠ‚ï¼›</li></ol><p>ä»¥ä¸Šä¸¤ä¸ªä¸Šé™å€¼éƒ½æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œä¸èƒ½æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„æœ‰åºé›†åˆå¯¹è±¡å°†ä½¿ç”¨ skiplistç¼–ç </p><h3 id="8-7-ç±»å‹æ£€æŸ¥çš„å®ç°">8.7 ç±»å‹æ£€æŸ¥çš„å®ç°</h3><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424105213455.png" alt="image-20240424105213455"></p><h3 id="8-8-å†…å­˜å›æ”¶">8.8 å†…å­˜å›æ”¶</h3><p>å› ä¸ºCè¯­è¨€å¹¶ä¸å…·å¤‡è‡ªåŠ¨å†…å­˜å›æ”¶åŠŸèƒ½ï¼Œæ‰€ä»¥Redisåœ¨è‡ªå·±çš„å¯¹è±¡ç³»ç»Ÿä¸­æ„å»ºäº†ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼ˆ reference counting)æŠ€æœ¯å®ç°çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œé€šè¿‡è¿™ä¸€æœºåˆ¶ï¼Œç¨‹åºå¯ä»¥é€šè¿‡è·Ÿè¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¿¡æ¯ï¼Œåœ¨é€‚å½“çš„æ—¶å€™è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡å¹¶è¿›è¡Œå†…å­˜å›æ”¶ã€‚</p><h3 id="8-9-å¯¹è±¡å…±äº«">8.9 å¯¹è±¡å…±äº«</h3><p>é™¤äº†ç”¨äºå®ç°å¼•ç”¨è®¡æ•°å†…å­˜å›æ”¶æœºåˆ¶ä¹‹å¤–ï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å±æ€§è¿˜å¸¦æœ‰å¯¹è±¡å…±äº«çš„ä½œç”¨ã€‚</p><h3 id="8-10-å¯¹è±¡çš„ç©ºè½¬æ—¶é•¿">8.10 å¯¹è±¡çš„ç©ºè½¬æ—¶é•¿</h3><p>é™¤äº†ä¹‹å‰ä»‹ç»äº† typeã€encoding ã€ptr å’Œ refcount å››ä¸ªå±æ€§ä¹‹å¤–ï¼ŒredisObject ç»“æ„åŒ…å«çš„æœ€åä¸€ä¸ªå±æ€§ä¸º lru å±æ€§ï¼Œè¯¥å±æ€§è®°å½•äº†å¯¹è±¡æœ€åä¸€æ¬¡è¢«å‘½ä»¤ç¨‹åºè®¿é—®çš„æ—¶é—´ã€‚</p><p>ä½¿ç”¨å‘½ä»¤OBJECT IDLETIME ç»™å®šé”® å¯ä»¥æ‰“å°å‡ºç»™å®šé”®çš„ç©ºè½¬æ—¶é•¿ï¼Œè¿™ä¸€ç©ºè½¬æ—¶é•¿å°±æ˜¯é€šè¿‡å°†å½“å‰æ—¶é—´å‡å»é”®çš„å€¼å¯¹è±¡çš„ lru æ—¶é—´è®¡ç®—å¾—å‡ºçš„ã€‚</p><p>æ€»ç»“ï¼š</p><p>å¯¹è±¡ï¼šString,List,Hash,Set,Sorted Set</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425134220304.png" alt="image-20240425134220304"></p><p>ç‰¹ç‚¹ï¼š<strong>ä¸€ä¸ªé”®å¯¹åº”äº†ä¸€ä¸ªé›†åˆçš„æ•°æ®</strong></p><h2 id="ç¬¬ä¹ç« -æ•°æ®åº“">ç¬¬ä¹ç«  æ•°æ®åº“</h2><h3 id="9-1-æœåŠ¡å™¨ä¸­çš„æ•°æ®åº“">9.1 æœåŠ¡å™¨ä¸­çš„æ•°æ®åº“</h3><p>RedisæœåŠ¡å™¨å°†æ‰€æœ‰æ•°æ®åº“éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€redis.h/redisserverç»“æ„çš„dbæ•°ç»„ä¸­ï¼Œdb æ•°ç»„çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ªredis.h/redisDbç»“æ„ï¼Œæ¯ä¸ªredisDbç»“æ„ä»£è¡¨ä¸€ä¸ªæ•°æ®åº“:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">redisServer</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// ä¸€ä¸ªæ•°ç»„ï¼Œä¿å­˜ç€æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ•°æ®åº“</span></span><br><span class="line">    redisDb *db;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æœåŠ¡å™¨æ—¶ï¼Œç¨‹åºä¼šæ ¹æ®æœåŠ¡å™¨çŠ¶æ€çš„ dbnum å±æ€§</span></span><br><span class="line">    <span class="comment">// æ¥å†³å®šåº”è¯¥åˆ›å»ºå¤šå°‘ä¸ªæ•°æ®åº“ï¼Œé»˜è®¤æ˜¯ 16</span></span><br><span class="line">    <span class="type">int</span> dbnum;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>dbnumï¼šæ¥å†³å®šåº”è¯¥åˆ›å»ºå¤šå°‘ä¸ªæ•°æ®åº“ï¼Œé»˜è®¤æ˜¯ 16</p><h3 id="9-2-åˆ‡æ¢æ•°æ®åº“">9.2 åˆ‡æ¢æ•°æ®åº“</h3><p>å¯ä»¥é€šè¿‡å‘½ä»¤SELECT næ¥åˆ‡æ¢åˆ° n å·æ•°æ®åº“ã€‚</p><h3 id="9-3-æ•°æ®åº“é”®ç©ºé—´">9.3 æ•°æ®åº“é”®ç©ºé—´</h3><p>redisDbç»“æ„çš„ dict å­—å…¸ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰é”®å€¼å¯¹ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå­—å…¸ç§°ä¸ºé”®ç©ºé—´ï¼ˆkey spaceï¼‰ã€‚</p><p>é”®ç©ºé—´å’Œç”¨æˆ·æ‰€è§çš„æ•°æ®åº“æ˜¯ç›´æ¥å¯¹åº”çš„</p><ul><li>é”®ç©ºé—´çš„é”®ä¹Ÿå°±æ˜¯æ•°æ®åº“çš„é”®ï¼Œæ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ã€‚</li><li>é”®ç©ºé—´çš„å€¼ä¹Ÿå°±æ˜¯æ•°æ®åº“çš„å€¼ï¼Œæ¯ä¸ªå€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œè¡¨å¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡ä¸­çš„ä»»æ„ä¸€ç§ Redis å¯¹è±¡ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">redisDb</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// æ•°æ®åº“é”®ç©ºé—´ï¼Œä¿å­˜ç€æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹</span></span><br><span class="line">    dict *dict;</span><br><span class="line">    <span class="comment">// è¿‡æœŸå­—å…¸ï¼Œä¿å­˜ç€é”®çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    dict *expires;</span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424105713099.png" alt="image-20240424105713099"></p><h3 id="9-4-é”®çš„ç”Ÿå­˜æ—¶é—´æˆ–è¿‡æœŸæ—¶é—´">9.4 é”®çš„ç”Ÿå­˜æ—¶é—´æˆ–è¿‡æœŸæ—¶é—´</h3><p><strong>ä¿å­˜è¿‡æœŸæ—¶é—´</strong></p><p>redisDb ç»“æ„çš„expireså­—å…¸ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰é”®çš„è¿‡æœŸæ—¶é—´ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªå­—å…¸ä¸ºè¿‡æœŸå­—å…¸ï¼š</p><ul><li>è¿‡æœŸå­—å…¸çš„é”®æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘é”®ç©ºé—´ä¸­æŸä¸ªé”®å¯¹è±¡ï¼ˆä¹Ÿå³æ˜¯æŸä¸ªæ•°æ®åº“é”®ï¼‰ã€‚</li><li>è¿‡æœŸå­—å…¸çš„å€¼æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°ä¿å­˜äº†é”®æ‰€æŒ‡å‘çš„æ•°æ®åº“é”®çš„è¿‡æœŸæ—¶é—´â€“ä¸€ä¸ªæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">redisDb</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// æ•°æ®åº“é”®ç©ºé—´ï¼Œä¿å­˜ç€æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹</span></span><br><span class="line">    dict *dict;</span><br><span class="line">    <span class="comment">// è¿‡æœŸå­—å…¸ï¼Œä¿å­˜ç€é”®çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    dict *expires;</span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424110005819.png" alt="image-20240424110005819"></p><h3 id="9-5-è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥">9.5 è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥</h3><p>æœ‰ä¸‰ç§ä¸åŒçš„åˆ é™¤ç­–ç•¥ï¼š</p><ol><li>å®šæ—¶åˆ é™¤ï¼šåœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼ˆtimerï¼‰ï¼Œè®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´æ¥ä¸´æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œã€‚</li><li>æƒ°æ€§åˆ é™¤ï¼šæ”¾ä»»é”®è¿‡æœŸä¸ç®¡ï¼Œä½†æ˜¯æ¯æ¬¡ä»é”®ç©ºé—´ä¸­è·å–é”®æ—¶ï¼Œéƒ½æ£€æŸ¥å–å¾—çš„é”®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸçš„è¯å°±åˆ é™¤è¯¥é”®ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±è¿”å›è¯¥é”®ã€‚</li><li>å®šæœŸåˆ é™¤ï¼šæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œç¨‹åºå°±å¯¹æ•°æ®åº“è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢çš„è¿‡æœŸé”®ã€‚è‡³äºè¦åˆ é™¤å¤šå°‘è¿‡æœŸé”®ï¼Œä»¥åŠè¦æ£€æŸ¥å¤šå°‘ä¸ªæ•°æ®åº“ï¼Œåˆ™ç”±ç®—æ³•å†³å®šã€‚</li></ol><p>ä¸ºäº†æ›´å¥½æ›´åˆç†çš„åœ¨ CPU æ—¶é—´ä»¥åŠé¿å…æµªè´¹å†…å­˜ç©ºé—´ä¹‹é—´å–å¾—å¹³è¡¡ï¼ŒRedis æœåŠ¡å™¨ä½¿ç”¨ <strong>æƒ°æ€§åˆ é™¤</strong> å’Œ <strong>å®šæœŸåˆ é™¤</strong> ä¸¤ç§ç­–ç•¥ã€‚</p><h3 id="9-6-Redisçš„è¿‡æœŸé”®åˆ é™¤ç­–ç•¥">9.6 Redisçš„è¿‡æœŸé”®åˆ é™¤ç­–ç•¥</h3><h3 id="9-7-AOFã€RDB-å’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç†">9.7 AOFã€RDB å’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç†</h3><p><strong>ç”ŸæˆRDBæ–‡ä»¶</strong></p><p>åœ¨æ‰§è¡ŒSAVEå‘½ä»¤æˆ–è€…BGSAVEå‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„RDBæ–‡ä»¶æ—¶ï¼Œç¨‹åºä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°æ–°åˆ›å»ºçš„RDBæ–‡ä»¶ä¸­ã€‚</p><p><strong>è½½å…¥ RDB æ–‡ä»¶</strong></p><p>åœ¨å¯åŠ¨æœåŠ¡å™¨æ—¶ï¼Œå¦‚æœæœåŠ¡å™¨å¼€å¯äº† RDB åŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†å¯¹ RDB æ–‡ä»¶è¿›è¡Œè½½å…¥ï¼š</p><ul><li>å¦‚æœæœåŠ¡å™¨ä»¥ä¸»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œç¨‹åºä¼šå¯¹æ–‡ä»¶ä¸­ä¿å­˜çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œæœªè¿‡æœŸçš„é”®ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œè€Œè¿‡æœŸé”®åˆ™ä¼šè¢«å¿½ç•¥ï¼Œæ‰€ä»¥è¿‡æœŸé”®å¯¹è½½å…¥ RDB æ–‡ä»¶çš„ä¸»æœåŠ¡å™¨ä¸ä¼šé€ æˆå½±å“ã€‚</li><li>å¦‚æœæœåŠ¡å™¨ä»¥ä»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ä¸­ä¿å­˜çš„æ‰€æœ‰é”®ï¼Œä¸è®ºæ˜¯å¦è¿‡æœŸï¼Œéƒ½ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ä¸è¿‡ï¼Œå› ä¸ºä¸»ä»æœåŠ¡å™¨åœ¨è¿›è¡Œæ•°æ®åŒæ­¥çš„æ—¶å€™ï¼Œä»æœåŠ¡å™¨çš„æ•°æ®åº“å°±ä¼šè¢«æ¸…ç©ºï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è®²ï¼Œè¿‡æœŸé”®å¯¹è½½å…¥ RDB æ–‡ä»¶çš„ä»æœåŠ¡å™¨ä¹Ÿä¸ä¼šé€ æˆå½±å“ã€‚</li></ul><p><strong>AOF æ–‡ä»¶å†™å…¥</strong></p><p>å½“æœåŠ¡å™¨ä»¥ AOF æŒä¹…åŒ–æ¨¡å¼è¿è¡Œæ—¶ï¼Œå¦‚æœæ•°æ®åº“ä¸­çš„æŸä¸ªé”®å·²ç»è¿‡æœŸï¼Œä½†å®ƒè¿˜æ²¡æœ‰è¢«æƒ°æ€§åˆ é™¤æˆ–è€…å®šæœŸåˆ é™¤ï¼Œé‚£ä¹ˆ AOF æ–‡ä»¶ä¸ä¼šå› ä¸ºè¿™ä¸ªè¿‡æœŸé”®è€Œäº§ç”Ÿä»»ä½•å½±å“ã€‚</p><p>å½“è¿‡æœŸé”®è¢«æƒ°æ€§åˆ é™¤æˆ–è€…å®šæœŸåˆ é™¤ä¹‹åï¼Œç¨‹åºå›å‘ AOF æ–‡ä»¶è¿½åŠ ï¼ˆappendï¼‰ä¸€æ¡ DEL å‘½ä»¤ï¼Œæ¥æ˜¾å¼åœ°è®°å½•è¯¥é”®å·²ç»è¢«åˆ é™¤ã€‚</p><p><strong>AOF é‡å†™</strong></p><p>å’Œç”Ÿæˆ RDB æ–‡ä»¶æ—¶ç±»ä¼¼ï¼Œåœ¨æ‰§è¡Œ AOF é‡å†™çš„è¿‡ç¨‹ä¸­ï¼Œç¨‹åºä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°é‡å†™åçš„ AOF æ–‡ä»¶ä¸­ã€‚</p><p><strong>å¤åˆ¶</strong></p><p>å½“æœåŠ¡å™¨è¿è¡Œåœ¨å¤åˆ¶æ¨¡å¼ä¸‹æ—¶ï¼Œä»æœåŠ¡å™¨çš„è¿‡æœŸé”®åˆ é™¤åŠ¨ä½œç”±ä¸»æœåŠ¡å™¨æ§åˆ¶ï¼š</p><ul><li>ä¸»æœåŠ¡å™¨åœ¨åˆ é™¤ä¸€ä¸ªè¿‡æœŸé”®ä¹‹åï¼Œä¼šæ˜¾å¼çš„å‘æ‰€æœ‰ä»æœåŠ¡å™¨å‘é€ä¸€ä¸ªDELå‘½ä»¤ï¼Œå‘ŠçŸ¥ä»æœåŠ¡å™¨åˆ é™¤è¿™ä¸ªè¿‡æœŸé”®ã€‚</li><li>ä»æœåŠ¡å™¨åœ¨æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„è¯»å‘½ä»¤æ—¶ï¼Œå³ä½¿ç¢°åˆ°è¿‡æœŸé”®ä¹Ÿä¸ä¼šå°†è¿‡æœŸé”®åˆ é™¤ï¼Œè€Œæ˜¯ç»§ç»­åƒå¤„ç†æœªè¿‡æœŸçš„é”®ä¸€æ ·æ¥å¤„ç†è¿‡æœŸé”®ã€‚</li><li>ä»æœåŠ¡å™¨åªæœ‰åœ¨æ¥åˆ°ä¸»æœåŠ¡å™¨å‘æ¥çš„ DELå‘½ä»¤ä¹‹åï¼Œæ‰ä¼šåˆ é™¤è¿‡æœŸé”®ã€‚</li></ul><p>é€šè¿‡ç”±ä¸»æœåŠ¡å™¨æ¥æ§åˆ¶ä»æœåŠ¡å™¨ç»Ÿä¸€åœ°åˆ é™¤è¿‡æœŸé”®ï¼Œå¯ä»¥ä¿è¯ä¸»ä»æœåŠ¡å™¨æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œå½“ä¸€ä¸ªè¿‡æœŸé”®ä»ç„¶å­˜åœ¨äºä¸»æœåŠ¡å™¨çš„æ•°æ®åº“æ—¶ï¼Œè¿™ä¸ªè¿‡æœŸé”®åœ¨ä»æœåŠ¡å™¨é‡Œçš„å¤åˆ¶å“ä¹Ÿä¼šç»§ç»­å­˜åœ¨ã€‚</p><p>ä¸‹é¢ç”¨2å¼ å›¾ç®€å•äº†è§£ä¸‹è¿™ä¸ªè¿‡ç¨‹</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424110408994.png" alt="image-20240424110408994"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424110436186.png" alt="image-20240424110436186"></p><p><strong>æ•°æ®åº“é€šçŸ¥</strong></p><p>æ•°æ®åº“é€šçŸ¥æ˜¯Redis 2.8ç‰ˆæœ¬æ–°å¢åŠ çš„åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥è®©å®¢æˆ·ç«¯é€šè¿‡è®¢é˜…ç»™å®šçš„é¢‘é“æˆ–è€…æ¨¡å¼ï¼Œæ¥è·çŸ¥æ•°æ®åº“ä¸­é”®çš„å˜åŒ–ï¼Œä»¥åŠæ•°æ®åº“ä¸­å‘½ä»¤çš„æ‰§è¡Œæƒ…å†µã€‚</p><p>è¿™ä¸€ç±»å…³æ³¨â€œæŸä¸ªé”®æ‰§è¡Œäº†ä»€ä¹ˆå‘½ä»¤â€çš„é€šçŸ¥ç§°ä¸ºé”®ç©ºé—´é€šçŸ¥ï¼ˆ key-space notification ),é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦ä¸€ç±»ç§°ä¸ºé”®äº‹ä»¶é€šçŸ¥( key-event notification )çš„é€šçŸ¥ï¼Œå®ƒä»¬å…³æ³¨çš„æ˜¯â€œæŸä¸ªå‘½ä»¤è¢«ä»€ä¹ˆé”®æ‰§è¡Œäº†â€&quot;ã€‚</p><h2 id="ç¬¬åç« -RDBæŒä¹…åŒ–">ç¬¬åç«  RDBæŒä¹…åŒ–</h2><p>å› ä¸º Redisæ˜¯å†…å­˜æ•°æ®åº“,å®ƒå°†è‡ªå·±çš„æ•°æ®åº“çŠ¶æ€å‚¨å­˜åœ¨å†…å­˜é‡Œé¢,æ‰€ä»¥å¦‚æœä¸æƒ³åŠæ³•å°†å‚¨å­˜åœ¨å†…å­˜ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¿å­˜åˆ°ç£ç›˜é‡Œé¢ï¼Œé‚£ä¹ˆä¸€æ—¦æœåŠ¡å™¨è¿›ç¨‹é€€å‡ºï¼ŒæœåŠ¡å™¨ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¹Ÿä¼šæ¶ˆå¤±ä¸è§ã€‚</p><p>RDBæŒä¹…åŒ–åŠŸèƒ½æ‰€ç”Ÿæˆçš„RDBæ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡è¯¥æ–‡ä»¶å¯ä»¥è¿˜åŸç”ŸæˆRDBæ–‡ä»¶æ—¶çš„æ•°æ®åº“çŠ¶æ€,å¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424110626725.png" alt="image-20240424110626725"></p><h3 id="10-1-RDBæ–‡ä»¶çš„åˆ›å»ºä¸è½½å…¥">10.1 RDBæ–‡ä»¶çš„åˆ›å»ºä¸è½½å…¥</h3><p>æœ‰ä¸¤ä¸ªRediså‘½ä»¤å¯ä»¥ç”¨äºç”ŸæˆRDBæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯SAVEï¼Œå¦ä¸€ä¸ªæ˜¯BGSAVEã€‚</p><ul><li><p>SAVEå‘½ä»¤ä¼šé˜»å¡RedisæœåŠ¡å™¨è¿›ç¨‹ï¼Œç›´åˆ°RDBæ–‡ä»¶åˆ›å»ºå®Œæ¯•ä¸ºæ­¢ï¼Œåœ¨æœåŠ¡å™¨è¿›ç¨‹é˜»å¡æœŸé—´ï¼ŒæœåŠ¡å™¨ä¸èƒ½å¤„ç†ä»»ä½•å‘½ä»¤è¯·æ±‚ã€‚</p></li><li><p>å’ŒSAVEå‘½ä»¤ç›´æ¥é˜»å¡æœåŠ¡å™¨è¿›ç¨‹çš„åšæ³•ä¸åŒï¼ŒBGSAVEå‘½ä»¤ä¼šæ´¾ç”Ÿå‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åç”±å­è¿›ç¨‹è´Ÿè´£åˆ›å»ºRDBæ–‡ä»¶ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</p></li></ul><p>RDB æ–‡ä»¶çš„è½½å…¥å·¥ä½œæ˜¯åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ Redis å¹¶æ²¡æœ‰ä¸“é—¨ç”¨äºè½½å…¥ RDB æ–‡ä»¶çš„å‘½ä»¤ï¼Œåªè¦ Redis æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶æ£€æµ‹åˆ° RDB æ–‡ä»¶å­˜åœ¨ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨è½½å…¥ RDB æ–‡ä»¶ã€‚</p><p>å¦å¤–ï¼Œå› ä¸º AOF æ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é€šå¸¸æ¯” RDB æ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é«˜ï¼Œæ‰€ä»¥ï¼š</p><ul><li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šä¼˜å…ˆä½¿ç”¨ AOF æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ã€‚</li><li>åªæœ‰åœ¨ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºå…³é—­çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨æ‰ä¼šä½¿ç”¨ RDB æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ã€‚</li></ul><p>æœåŠ¡å™¨åœ¨è½½å…¥ RDB æ–‡ä»¶æœŸé—´ï¼Œä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°è½½å…¥å·¥ä½œå®Œæˆä¸ºæ­¢ã€‚</p><h3 id="10-2-è‡ªåŠ¨é—´éš”æ€§ä¿å­˜">10.2 è‡ªåŠ¨é—´éš”æ€§ä¿å­˜</h3><p>å› ä¸º BGSAVEå‘½ä»¤å¯ä»¥åœ¨ä¸é˜»å¡æœåŠ¡å™¨è¿›ç¨‹çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥ Redis å…è®¸ç”¨æˆ·é€šè¿‡è®¾ç½®æœåŠ¡å™¨é…ç½®çš„ save é€‰é¡¹ï¼Œè®©æœåŠ¡å™¨æ¯ä¸ªä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ BGSAVEå‘½ä»¤ã€‚</p><p>ç”¨æˆ·å¯ä»¥é€šè¿‡ saveé€‰é¡¹è®¾ç½®å¤šä¸ªä¿å­˜æ¡ä»¶ï¼Œä½†åªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªæ¡ä»¶è¢«æ»¡è¶³ï¼ŒæœåŠ¡å™¨å°±ä¼šæ‰§è¡Œ BGSAVEå‘½ä»¤ã€‚</p><p>Redis çš„æœåŠ¡å™¨å‘¨æœŸæ€§æ“ä½œå‡½æ•° serverCroné»˜è®¤æ¯ä¸ª 100 æ¯«ç§’å°±ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè¯¥å‡½æ•°ç”¨äºå¯¹æ­£åœ¨è¿è¡Œçš„æœåŠ¡å™¨è¿›è¡Œç»´æŠ¤ï¼Œå®ƒçš„å…¶ä¸­ä¸€é¡¹å·¥ä½œå°±æ˜¯æ£€æŸ¥ saveé€‰é¡¹æ‰€è®¾ç½®çš„ä¿å­˜æ¡ä»¶æ˜¯å¦å·²ç»æ»¡è¶³ï¼Œå¦‚æœæ»¡è¶³çš„è¯ï¼Œå°±æ‰§è¡Œ BGSAVE å‘½ä»¤ã€‚</p><h3 id="10-3-RDBæ–‡ä»¶ç»“æ„">10.3 RDBæ–‡ä»¶ç»“æ„</h3><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424110918715.png" alt="image-20240424110918715"></p><h2 id="ç¬¬åä¸€ç« -AOFæŒä¹…åŒ–">ç¬¬åä¸€ç«  AOFæŒä¹…åŒ–</h2><p>ä¸ RDB æŒä¹…åŒ–é€šè¿‡ä¿å­˜æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ¥è®°å½•æ•°æ®åº“çŠ¶æ€ä¸åŒï¼ŒAOFï¼ˆAppend Only Fileï¼‰æŒä¹…åŒ–æ—¶é€šè¿‡ä¿å­˜ Redis æœåŠ¡å™¨æ‰€æ‰§è¡Œçš„å†™å‘½ä»¤æ¥è®°å½•æ•°æ®åº“çŠ¶æ€çš„ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424111013241.png" alt="image-20240424111013241"></p><p><strong>è¡¥å……</strong>ï¼š</p><p>Qï¼šAOFæ—¥å¿—å†™å…¥æ—¶æœºï¼Ÿ</p><p>Aï¼šAOFæ—¥å¿—æ˜¯å†™åæ—¥å¿—ã€‚</p><p>è§£é‡Šï¼šæˆ‘ä»¬å¸¸å¸¸å†™æ—¥å¿—éƒ½æ˜¯WALæŠ€æœ¯ï¼Œå°±æ˜¯å…ˆè®°å½•ï¼Œå†å†™æ—¥å¿—ã€‚ä½†æ˜¯AOFå†™æ—¥å¿—æ˜¯åçš„ã€‚</p><p>åŸå› ï¼š</p><ol><li>ä¸ä¼šé˜»å¡å½“å‰å‘½ä»¤æ‰§è¡Œ</li><li>å¦‚æœå½“å‰å‘½ä»¤æˆåŠŸæ‰§è¡Œï¼Œä¹Ÿå°±è¯´æ˜è¿™ä¸ªå‘½ä»¤æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆå†™å…¥æ—¥å¿—å¾ˆokã€‚</li></ol><h3 id="11-1-AOFæŒä¹…åŒ–çš„å®ç°">11.1 AOFæŒä¹…åŒ–çš„å®ç°</h3><p>AOFæŒä¹…åŒ–åŠŸèƒ½çš„å®ç°å¯ä»¥åˆ†ä¸ºå‘½ä»¤è¿½åŠ ï¼ˆ append)ã€æ–‡ä»¶å†™å…¥ã€æ–‡ä»¶åŒæ­¥( sync)ä¸‰ä¸ªæ­¥éª¤ã€‚</p><p><strong>å‘½ä»¤è¿½åŠ </strong></p><p>å½“ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œä¼šä»¥åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ aof_bufç¼“å†²åŒºçš„æœ«å°¾ã€‚</p><p><strong>AOFæ–‡ä»¶çš„å†™å…¥ä¸åŒæ­¥</strong></p><p>ä¸ºäº†æé«˜æ–‡ä»¶çš„å†™å…¥æ•ˆç‡ï¼Œåœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨ writeå‡½æ•°ï¼Œå°†ä¸€äº›æ•°æ®å†™å…¥åˆ°æ–‡ä»¶çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä¼šå°†å†™å…¥æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºé‡Œé¢ï¼Œç­‰åˆ°ç¼“å†²åŒºçš„ç©ºé—´è¢«å¡«æ»¡ã€æˆ–è€…è¶…è¿‡äº†æŒ‡å®šçš„æ—¶é™ä¹‹åï¼Œæ‰çœŸæ­£çš„å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜é‡Œé¢ã€‚<br>è¿™ç§åšæ³•è™½ç„¶æé«˜äº†æ•ˆç‡ï¼Œä½†ä¹Ÿä¸ºå†™å…¥æ•°æ®å¸¦æ¥äº†å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå¦‚æœè®¡ç®—æœºå‘ç”Ÿåœæœºï¼Œé‚£ä¹ˆä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºé‡Œé¢çš„å†™å…¥æ•°æ®å°†ä¼šä¸¢å¤±ã€‚</p><p>å› æ­¤ï¼ŒRedis æœåŠ¡å™¨é…ç½® appendfsync é€‰é¡¹çš„å€¼ç›´æ¥å†³å®š AOF æŒä¹…åŒ–åŠŸèƒ½çš„æ•ˆç‡å’Œå®‰å…¨æ€§ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424111144986.png" alt="image-20240424111144986"></p><p>AOF é…ç½®é¡¹ appendfsync çš„ä¸‰ä¸ªå¯é€‰å€¼ã€‚</p><ul><li><p><strong>Always</strong>ï¼ŒåŒæ­¥å†™å›ï¼šæ¯ä¸ªå†™å‘½ä»¤æ‰§è¡Œå®Œï¼Œç«‹é©¬åŒæ­¥åœ°å°†æ—¥å¿—å†™å›ç£ç›˜ï¼›</p></li><li><p><strong>Everysec</strong>ï¼Œæ¯ç§’å†™å›ï¼šæ¯ä¸ªå†™å‘½ä»¤æ‰§è¡Œå®Œï¼Œåªæ˜¯å…ˆæŠŠæ—¥å¿—å†™åˆ° AOF æ–‡ä»¶çš„å†…å­˜ç¼“å†²åŒºï¼Œæ¯éš”ä¸€ç§’æŠŠç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥ç£ç›˜ï¼›</p></li><li><p><strong>No</strong>ï¼Œæ“ä½œç³»ç»Ÿæ§åˆ¶çš„å†™å›ï¼šæ¯ä¸ªå†™å‘½ä»¤æ‰§è¡Œå®Œï¼Œåªæ˜¯å…ˆæŠŠæ—¥å¿—å†™åˆ° AOF æ–‡ä»¶çš„å†…å­˜ç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜ã€‚</p></li></ul><p>ä¸‰ç§ç­–ç•¥çš„å†™å›æ—¶æœº:</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425142848519.png" alt="image-20240425142848519"></p><p>ç®€å•ä¸€å¥è¯ï¼šè¦é«˜æ€§èƒ½ï¼Œé€‰æ‹© No ç­–ç•¥ï¼›è¦é«˜å¯é æ€§ï¼Œé€‰æ‹© Always ç­–ç•¥ï¼›å¦‚æœå…è®¸æ•°æ®æœ‰ä¸€ç‚¹ä¸¢å¤±ï¼Œåˆå¸Œæœ›æ€§èƒ½åˆ«å—å¤ªå¤§å½±å“çš„è¯ï¼Œé‚£ä¹ˆå°±é€‰æ‹© Everysec ç­–ç•¥ã€‚</p><h3 id="11-2-AOF-æ–‡ä»¶çš„è½½å…¥ä¸æ•°æ®è¿˜åŸ">11.2 AOF æ–‡ä»¶çš„è½½å…¥ä¸æ•°æ®è¿˜åŸ</h3><p>å› ä¸º AOF æ–‡ä»¶é‡Œé¢åŒ…å«äº†é‡å»ºæ•°æ®åº“çŠ¶æ€æ‰€éœ€çš„æ‰€æœ‰å†™å‘½ä»¤ï¼Œæ‰€ä»¥æœåŠ¡å™¨åªè¦è¯»å…¥å¹¶é‡æ–°æ‰§è¡Œä¸€é AOF æ–‡ä»¶é‡Œé¢ä¿å­˜çš„å†™å‘½ä»¤ï¼Œå°±å¯ä»¥è¿˜åŸæœåŠ¡å™¨å…³é—­ä¹‹å‰çš„æ•°æ®åº“çŠ¶æ€ã€‚</p><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªä¸å¸¦ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯ï¼ˆfake clientï¼‰</li><li>ä» AOF æ–‡ä»¶ä¸­åˆ†æå¹¶è¯»å–ä¸€æ¡å†™å‘½ä»¤</li><li>ä½¿ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œè¢«è¯»å‡ºçš„å†™å‘½ä»¤</li><li>é‡å¤æ‰§è¡Œæ­¥éª¤ 2 ä¸ æ­¥éª¤ 3 ï¼Œç›´åˆ° AOF ä¸­çš„æ‰€æœ‰å†™å‘½ä»¤éƒ½è¢«å¤„ç†å®Œæ¯•ä¸ºæ­¢ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424111221484.png" alt="image-20240424111221484"></p><h3 id="11-3-AOFé‡å†™">11.3 AOFé‡å†™</h3><p>ä¸ºä»€ä¹ˆè¦é‡å†™ï¼Ÿ</p><p>å› ä¸ºAOFæŒä¹…åŒ–æ˜¯é€šè¿‡ä¿å­˜è¢«æ‰§è¡Œçš„å†™å‘½ä»¤æ¥è®°å½•æ•°æ®åº“çŠ¶æ€çš„ï¼Œæ‰€ä»¥éšç€æœåŠ¡å™¨è¿è¡Œæ—¶é—´çš„æµé€ï¼ŒAOF æ–‡ä»¶ä¸­çš„å†…å®¹ä¼šè¶Šæ¥è¶Šå¤šï¼Œæ–‡ä»¶çš„ä½“ç§¯ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œå¦‚æœä¸åŠ ä»¥æ§åˆ¶çš„è¯ï¼Œä½“ç§¯è¿‡å¤§çš„AOFæ–‡ä»¶å¾ˆå¯èƒ½å¯¹RedisæœåŠ¡å™¨ã€ç”šè‡³æ•´ä¸ªå®¿ä¸»è®¡ç®—æœºé€ æˆå½±å“ï¼Œå¹¶ä¸”AOF æ–‡ä»¶çš„ä½“ç§¯è¶Šå¤§ï¼Œä½¿ç”¨AOF æ–‡ä»¶æ¥è¿›è¡Œæ•°æ®è¿˜åŸæ‰€éœ€çš„æ—¶é—´å°±è¶Šå¤šã€‚</p><p>ä¸ºäº†è§£å†³AOFæ–‡ä»¶ä½“ç§¯è†¨èƒ€çš„é—®é¢˜ï¼ŒRedisæä¾›äº†AOFæ–‡ä»¶é‡å†™ï¼ˆ rewriteï¼‰åŠŸèƒ½ã€‚é€šè¿‡è¯¥åŠŸèƒ½ï¼ŒRedisæœåŠ¡å™¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„AOFæ–‡ä»¶æ¥æ›¿ä»£ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œæ–°æ—§ä¸¤ä¸ªAOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ç›¸åŒï¼Œä½†æ–°AOFæ–‡ä»¶ä¸ä¼šåŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œæ‰€ä»¥æ–°AOFæ–‡ä»¶çš„ä½“ç§¯é€šå¸¸ä¼šæ¯”æ—§AOF æ–‡ä»¶çš„ä½“ç§¯è¦å°å¾—å¤šã€‚</p><p><strong>AOFæ–‡ä»¶é‡å†™å®ç°</strong></p><p>è™½ç„¶ Rediså°†ç”Ÿæˆæ–°AOFæ–‡ä»¶æ›¿æ¢æ—§AOF æ–‡ä»¶çš„åŠŸèƒ½å‘½åä¸ºâ€œAOFæ–‡ä»¶é‡å†™â€ï¼Œ<strong>ä½†å®é™…ä¸Šï¼ŒAOF æ–‡ä»¶é‡å†™å¹¶ä¸éœ€è¦å¯¹ç°æœ‰çš„AOF æ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å–ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯é€šè¿‡è¯»å–æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€æ¥å®ç°çš„ã€‚</strong></p><p>é¦–å…ˆä»æ•°æ®åº“ä¸­è¯»å–é”®ç°åœ¨çš„å€¼ï¼Œç„¶åç”¨ä¸€æ¡å‘½ä»¤å»è®°å½•é”®å€¼å¯¹ï¼Œä»£æ›¿ä¹‹å‰è®°å½•è¿™ä¸ªé”®å€¼å¯¹çš„å¤šæ¡å‘½ä»¤ï¼Œ<strong>è¿™å°±æ˜¯AOFé‡å†™åŠŸèƒ½çš„å®ç°åŸç†</strong>ã€‚</p><p><strong>AOFåå°é‡å†™</strong></p><p>ä¸Šé¢ä»‹ç»çš„AOFé‡å†™ç¨‹åºaof_rewriteå‡½æ•°å¯ä»¥å¾ˆå¥½åœ°å®Œæˆåˆ›å»ºä¸€ä¸ªæ–°AOFæ–‡ä»¶çš„ä»»åŠ¡ï¼Œä½†æ˜¯ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°ä¼šè¿›è¡Œå¤§é‡çš„å†™äººæ“ä½œï¼Œæ‰€ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„çº¿ç¨‹å°†è¢«é•¿æ—¶é—´é˜»å¡,æ‰€ä»¥ Redis å†³å®šå°†AOFé‡å†™ç¨‹åºæ”¾åˆ°å­è¿›ç¨‹é‡Œæ‰§è¡Œã€‚</p><ul><li>å­è¿›ç¨‹è¿›è¡ŒAOFé‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li><li>å­è¿›ç¨‹å¸¦æœ‰æœåŠ¡å™¨è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå¯ä»¥åœ¨é¿å…ä½¿ç”¨é”çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚</li></ul><p>ä¸è¿‡ï¼Œä½¿ç”¨å­è¿›ç¨‹ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼Œå› ä¸ºå­è¿›ç¨‹åœ¨è¿›è¡ŒAOFé‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹è¿˜éœ€è¦ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œè€Œæ–°çš„å‘½ä»¤å¯èƒ½ä¼šå¯¹ç°æœ‰çš„æ•°æ®åº“çŠ¶æ€è¿›è¡Œä¿®æ”¹ï¼Œä»è€Œä½¿å¾—æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€å’Œé‡å†™åçš„AOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ç§æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼ŒRedisæœåŠ¡å™¨è®¾ç½®äº†ä¸€ä¸ªAOFé‡å†™ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºåœ¨æœåŠ¡å™¨åˆ›å»ºå­è¿›ç¨‹ä¹‹åå¼€å§‹ä½¿ç”¨ï¼Œå½“RedisæœåŠ¡å™¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œå®ƒä¼šåŒæ—¶å°†è¿™ä¸ªå†™å‘½ä»¤å‘é€ç»™AOFç¼“å†²åŒºå’ŒAOFé‡å†™ç¼“å†²åŒºï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424112203933.png" alt="image-20240424112203933"></p><p>å½“å­è¿›ç¨‹å®Œæˆ AOF é‡å†™å·¥ä½œä¹‹åï¼Œå®ƒä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œçˆ¶è¿›ç¨‹åœ¨æ¥åˆ°è¯¥ä¿¡å·ä¹‹åï¼Œä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹å·¥ä½œï¼š</p><ol><li>å°† AOF é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ°æ–° AOF æ–‡ä»¶ä¸­ï¼Œè¿™æ—¶æ–° AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€å°†å’ŒæœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚</li><li>å¯¹æ–°çš„ AOF æ–‡ä»¶è¿›è¡Œæ”¹åï¼ŒåŸå­åœ°ï¼ˆatomicï¼‰è¦†ç›–ç°æœ‰çš„ AOF æ–‡ä»¶ï¼Œå®Œæˆæ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶çš„æ›¿æ¢ã€‚</li></ol><p>è¿™ä¸ªä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œçˆ¶è¿›ç¨‹å°±å¯ä»¥ç»§ç»­åƒå¾€å¸¸ä¸€æ ·æ¥å—å‘½ä»¤è¯·æ±‚äº†ã€‚</p><p>åœ¨æ•´ä¸ª AOF åå°é‡å†™è¿‡ç¨‹ä¸­ï¼Œåªæœ‰ä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œæ—¶ä¼šå¯¹æœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰é€ æˆé˜»å¡ï¼Œåœ¨å…¶å®ƒæ—¶å€™ï¼ŒAOF åå°é‡å†™éƒ½ä¸ä¼šé˜»å¡çˆ¶è¿›ç¨‹ï¼Œè¿™å°† AOF é‡å†™å¯¹æœåŠ¡å™¨æ€§èƒ½é€ æˆçš„å½±å“é™åˆ°äº†æœ€ä½ã€‚</p><p><strong>æ€»ç»“</strong>ï¼š</p><p>åœ¨æ‰§è¡ŒBGREWRITEAOFå‘½ä»¤æ—¶ï¼ŒRedisæœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ªAOFé‡å†™ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºä¼šåœ¨å­è¿›ç¨‹åˆ›å»ºæ–°AOFæ–‡ä»¶æœŸé—´ï¼Œè®°å½•æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ã€‚å½“å­è¿›ç¨‹å®Œæˆåˆ›å»ºæ–°AOFæ–‡ä»¶çš„å·¥ä½œåï¼ŒæœåŠ¡å™¨å°±ä¼šé‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–°çš„AOFæ–‡ä»¶çš„æœ«å°¾ï¼Œä½¿å¾—æ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚æœ€åï¼ŒæœåŠ¡å™¨ç”¨æ–°çš„AOFæ–‡ä»¶æ›¿æ¢æ—§çš„AOFæ–‡ä»¶ï¼Œä»¥æ­¤æ¥å®ŒæˆAOFæ–‡ä»¶é‡å†™æ“ä½œã€‚</p><p>è¿™é‡Œï¼Œå¯¹AOFå’Œåšä¸ªæ€»ç»“</p><table><thead><tr><th></th><th><strong>RDB</strong></th><th><strong>AOF</strong></th></tr></thead><tbody><tr><td>æŒä¹…åŒ–æ–¹å¼</td><td>å®šæ—¶å¯¹æ•´ä¸ªå†…å­˜åšå¿«ç…§</td><td>è®°å½•æ¯ä¸€æ¬¡æ‰§è¡Œçš„å‘½ä»¤</td></tr><tr><td>æ•°æ®å®Œæ•´æ€§</td><td>ä¸å®Œæ•´ï¼Œä¸¤æ¬¡å¤‡ä»½ä¹‹é—´ä¼šä¸¢å¤±</td><td>ç›¸å¯¹å®Œæ•´ï¼Œå–å†³äºåˆ·ç›˜ç­–ç•¥</td></tr><tr><td>æ–‡ä»¶å¤§å°</td><td>ä¼šæœ‰å‹ç¼©ï¼Œæ–‡ä»¶ä½“ç§¯å°</td><td>è®°å½•å‘½ä»¤ï¼Œæ–‡ä»¶ä½“ç§¯å¾ˆå¤§</td></tr><tr><td>å®•æœºæ¢å¤é€Ÿåº¦</td><td>å¾ˆå¿«</td><td>æ…¢</td></tr><tr><td>æ•°æ®æ¢å¤ä¼˜å…ˆçº§</td><td>ä½ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§ä¸å¦‚AOF</td><td>é«˜ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§æ›´é«˜</td></tr><tr><td>ç³»ç»Ÿèµ„æºå ç”¨</td><td>é«˜ï¼Œå¤§é‡CPUå’Œå†…å­˜æ¶ˆè€—</td><td>ä½ï¼Œä¸»è¦æ˜¯ç£ç›˜IOèµ„æºä½†AOFé‡å†™æ—¶ä¼šå ç”¨å¤§é‡CPUå’Œå†…å­˜èµ„æº</td></tr><tr><td>ä½¿ç”¨åœºæ™¯</td><td>å¯ä»¥å®¹å¿æ•°åˆ†é’Ÿçš„æ•°æ®ä¸¢å¤±ï¼Œè¿½æ±‚æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦</td><td>å¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜å¸¸è§</td></tr></tbody></table><blockquote><p><strong>æå®¢æ—¶é—´ä¸­é‡å†™æ€»ç»“</strong></p></blockquote><p>é‡å†™çš„è¿‡ç¨‹æ€»ç»“ä¸º<strong>ä¸€ä¸ªæ‹·è´ï¼Œä¸¤å¤„æ—¥å¿—</strong>ã€‚</p><p>é‡å†™è¿‡ç¨‹æ˜¯ç”±åå°çº¿ç¨‹ bgrewriteaof æ¥å®Œæˆçš„ã€‚</p><ol><li>â€œä¸€ä¸ªæ‹·è´â€æ˜¯æŒ‡ä»€ä¹ˆï¼Ÿ</li></ol><ul><li>æ¯æ¬¡æ‰§è¡Œé‡å†™æ—¶ï¼Œä¸»çº¿ç¨‹ fork å‡ºåå°çš„ bgrewriteaof å­è¿›ç¨‹ã€‚æ­¤æ—¶ï¼Œfork ä¼šæŠŠä¸»çº¿ç¨‹çš„å†…å­˜æ‹·è´ä¸€ä»½ç»™ bgrewriteaof å­è¿›ç¨‹ï¼Œè¿™é‡Œé¢å°±åŒ…å«äº†æ•°æ®åº“çš„æœ€æ–°æ•°æ®ã€‚ç„¶åï¼Œbgrewriteaof å­è¿›ç¨‹å°±å¯ä»¥åœ¨ä¸å½±å“ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œé€ä¸€æŠŠæ‹·è´çš„æ•°æ®å†™æˆæ“ä½œï¼Œè®°å…¥é‡å†™æ—¥å¿—ã€‚</li></ul><ol start="2"><li>â€œä¸¤å¤„æ—¥å¿—â€åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</li></ol><ul><li><p>å› ä¸ºä¸»çº¿ç¨‹æœªé˜»å¡ï¼Œä»ç„¶å¯ä»¥å¤„ç†æ–°æ¥çš„æ“ä½œã€‚æ­¤æ—¶ï¼Œå¦‚æœæœ‰å†™æ“ä½œï¼Œç¬¬ä¸€å¤„æ—¥å¿—å°±æ˜¯æŒ‡æ­£åœ¨ä½¿ç”¨çš„ AOF æ—¥å¿—ï¼ŒRedis ä¼šæŠŠè¿™ä¸ªæ“ä½œå†™åˆ°å®ƒçš„ç¼“å†²åŒºã€‚è¿™æ ·ä¸€æ¥ï¼Œå³ä½¿å®•æœºäº†ï¼Œè¿™ä¸ª AOF æ—¥å¿—çš„æ“ä½œä»ç„¶æ˜¯é½å…¨çš„ï¼Œå¯ä»¥ç”¨äºæ¢å¤ã€‚</p></li><li><p>è€Œç¬¬äºŒå¤„æ—¥å¿—ï¼Œå°±æ˜¯æŒ‡æ–°çš„ AOF é‡å†™æ—¥å¿—ã€‚è¿™ä¸ªæ“ä½œä¹Ÿä¼šè¢«å†™åˆ°é‡å†™æ—¥å¿—çš„ç¼“å†²åŒºã€‚è¿™æ ·ï¼Œé‡å†™æ—¥å¿—ä¹Ÿä¸ä¼šä¸¢å¤±æœ€æ–°çš„æ“ä½œã€‚ç­‰åˆ°æ‹·è´æ•°æ®çš„æ‰€æœ‰æ“ä½œè®°å½•é‡å†™å®Œæˆåï¼Œé‡å†™æ—¥å¿—è®°å½•çš„è¿™äº›æœ€æ–°æ“ä½œä¹Ÿä¼šå†™å…¥æ–°çš„ AOF æ–‡ä»¶ï¼Œä»¥ä¿è¯æ•°æ®åº“æœ€æ–°çŠ¶æ€çš„è®°å½•ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æ–°çš„ AOF æ–‡ä»¶æ›¿ä»£æ—§æ–‡ä»¶äº†ã€‚</p></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240425143725321.png" alt="image-20240425143725321"></p><h2 id="ç¬¬åäºŒç« -äº‹ä»¶">ç¬¬åäºŒç«  äº‹ä»¶</h2><p>Redis æœåŠ¡å™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨å™¨ï¼ŒæœåŠ¡å™¨éœ€è¦å¤„ç†ä»¥ä¸‹ä¸¤ç±»äº‹ä»¶ï¼š</p><ul><li>æ–‡ä»¶äº‹ä»¶ï¼ˆfile eventï¼‰ï¼šRedis æœåŠ¡å™¨é€šè¿‡å¥—æ¥å­—ä¸å®¢æˆ·ç«¯ï¼ˆæˆ–è€…å…¶å®ƒ Redis æœåŠ¡å™¨ï¼‰è¿›è¡Œè¿æ¥ï¼Œè€Œæ–‡ä»¶äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹å¥—æ¥å­—æ“ä½œçš„æŠ½è±¡ã€‚æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ï¼ˆæˆ–è€…å…¶å®ƒæœåŠ¡å™¨ï¼‰çš„é€šä¿¡ä¼šäº§ç”Ÿç›¸åº”çš„æ–‡ä»¶äº‹ä»¶ï¼Œè€ŒæœåŠ¡å™¨åˆ™é€šè¿‡ç›‘å¬å¹¶å¤„ç†è¿™äº›äº‹ä»¶æ¥å®Œæˆä¸€ç³»åˆ—ç½‘ç»œé€šä¿¡æ“ä½œã€‚</li><li>æ—¶é—´äº‹ä»¶ï¼ˆtime eventï¼‰ï¼šRedis æœåŠ¡å™¨ä¸­çš„ä¸€äº›æ“ä½œï¼ˆæ¯”å¦‚ serverCron å‡½æ•°ï¼‰éœ€è¦åœ¨ç»™å®šçš„æ—¶é—´ç‚¹æ‰§è¡Œï¼Œè€Œæ—¶é—´äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹è¿™ç±»å®šæ—¶æ“ä½œçš„æŠ½è±¡ã€‚</li></ul><h3 id="12-1-æ–‡ä»¶äº‹ä»¶">12.1 æ–‡ä»¶äº‹ä»¶</h3><p>Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼šè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ï¼š</p><ul><li>æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I / O å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚</li><li>å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ï¼ˆacceptï¼‰ã€è¯»å–ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰ã€å…³é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚</li></ul><p>è™½ç„¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶å®ƒåŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œè¿™ä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ã€‚</p><p>æ–‡ä»¶äº‹ä»¶åˆ†ä¸º AE_READABLEäº‹ä»¶ï¼ˆè¯»äº‹ä»¶ï¼‰å’Œ AE_WRITEABLE äº‹ä»¶ï¼ˆå†™äº‹ä»¶ï¼‰ä¸¤ç±»ã€‚</p><h3 id="12-2-æ—¶é—´äº‹ä»¶">12.2 æ—¶é—´äº‹ä»¶</h3><p>Redis çš„æ—¶é—´äº‹ä»¶åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š</p><ul><li>å®šæ—¶äº‹ä»¶ï¼šè®©ä¸€æ®µç¨‹åºåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åæ‰§è¡Œä¸€æ¬¡ã€‚æ¯”å¦‚è¯´ï¼Œè®©ç¨‹åº X åœ¨å½“å‰æ—¶é—´çš„ 30 æ¯«ç§’ä¹‹åæ‰§è¡Œä¸€æ¬¡ã€‚</li><li>å‘¨æœŸæ€§äº‹ä»¶ï¼šè®©ä¸€æ®µç¨‹åºæ¯éš”æŒ‡å®šæ—¶é—´å°±æ‰§è¡Œä¸€æ¬¡ã€‚æ¯”å¦‚è¯´ï¼Œè®©ç¨‹åº X æ¯éš” 30 æ¯«ç§’å°±æ‰§è¡Œä¸€æ¬¡ã€‚</li></ul><p>æœåŠ¡å™¨åœ¨ä¸€èˆ¬æƒ…å†µä¸‹åªæ‰§è¡Œ serverCron å‡½æ•°ä¸€ä¸ªæ—¶é—´äº‹ä»¶ï¼Œå¹¶ä¸”è¿™ä¸ªäº‹ä»¶æ˜¯å‘¨æœŸæ€§äº‹ä»¶ã€‚</p><p>æ—¶é—´äº‹ä»¶çš„å®é™…å¤„ç†æ—¶é—´é€šå¸¸ä¼šæ¯”è®¾å®šçš„åˆ°è¾¾æ—¶é—´æ™šä¸€äº›ã€‚</p><blockquote><p>æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ä¹‹é—´æ˜¯åˆä½œå…³ç³»ï¼ŒæœåŠ¡å™¨ä¼šè½®æµå¤„ç†è¿™ä¸¤ç§äº‹ä»¶ï¼Œå¹¶ä¸”å¤„ç†äº‹ä»¶çš„è¿‡ç¨‹ä¸­ä¹Ÿä¸ä¼šè¿›è¡ŒæŠ¢å ã€‚</p></blockquote><h2 id="ç¬¬åä¸‰ç« -å®¢æˆ·ç«¯">ç¬¬åä¸‰ç«  å®¢æˆ·ç«¯</h2><h2 id="ç¬¬åå››ç« -æœåŠ¡å™¨">ç¬¬åå››ç«  æœåŠ¡å™¨</h2><p>Qï¼šä¸ºä»€ä¹ˆå•çº¿ç¨‹Redisèƒ½é‚£ä¹ˆå¿«ï¼Ÿ</p><p>Aï¼š</p><p>é¦–å…ˆï¼Œå…ˆç†æ¸…ä¸‹æ¦‚å¿µï¼šRedis æ˜¯å•çº¿ç¨‹ï¼Œä¸»è¦æ˜¯æŒ‡ <strong>Redis çš„ç½‘ç»œ IO å’Œé”®å€¼å¯¹è¯»å†™æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆçš„ï¼Œè¿™ä¹Ÿæ˜¯ Redis å¯¹å¤–æä¾›é”®å€¼å­˜å‚¨æœåŠ¡çš„ä¸»è¦æµç¨‹</strong>ã€‚ä½† Redis çš„å…¶ä»–åŠŸèƒ½ï¼Œæ¯”å¦‚æŒä¹…åŒ–ã€å¼‚æ­¥åˆ é™¤ã€é›†ç¾¤æ•°æ®åŒæ­¥ç­‰ï¼Œå…¶å®æ˜¯ç”±é¢å¤–çš„çº¿ç¨‹æ‰§è¡Œçš„ã€‚</p><p>å¿«å‘¢ï¼Œæœ‰4ç‚¹åŸå› ï¼š</p><ol><li><p>å†…å­˜DB</p></li><li><p>å•çº¿ç¨‹ï¼Œæ²¡æœ‰çº¿ç¨‹åˆ‡æ¢å¼€é”€</p></li><li><p>IOå¤šè·¯å¤ç”¨</p></li><li><p>åº•å±‚æ•°æ®ç»“æ„</p></li></ol><h2 id="ç¬¬åäº”ç« -å¤åˆ¶">ç¬¬åäº”ç«  å¤åˆ¶</h2><p>åœ¨ Redis ä¸­ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ‰§è¡Œ SLAVEOFå‘½ä»¤æˆ–è€…è®¾ç½® slaveofé€‰é¡¹ï¼Œè®©ä¸€ä¸ªæœåŠ¡å™¨å»å¤åˆ¶ï¼ˆreplicateï¼‰å¦ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæˆ‘ä»¬ç§°å‘¼è¢«å¤åˆ¶çš„æœåŠ¡å™¨ä¸ºä¸»æœåŠ¡å™¨ï¼ˆmasterï¼‰ï¼Œè€Œå¯¹ä¸»æœåŠ¡å™¨è¿›è¡Œå¤åˆ¶çš„æœåŠ¡å™¨è¢«ç§°ä¸ºä»æœåŠ¡å™¨ï¼ˆslaveï¼‰ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424112727043.png" alt="image-20240424112727043"></p><blockquote><p>Redisä¸­å¯ä»¥é€šè¿‡ SLAVEOF å‘½ä»¤æ¥è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨ä¸ºä»æœåŠ¡å™¨ï¼Œä»è€Œå¤åˆ¶æŒ‡å®šçš„ä¸»æœåŠ¡å™¨çš„æ•°æ®ã€‚</p></blockquote><h3 id="15-1-æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½çš„å®ç°">15.1 æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½çš„å®ç°</h3><p>æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½åŒ…æ‹¬ åŒæ­¥(sync) å’Œ å‘½ä»¤ä¼ æ’­ ä¸¤ä¸ªæ“ä½œã€‚</p><p><strong>åŒæ­¥</strong></p><p>ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨çš„åŒæ­¥æ“ä½œéœ€è¦å‘é€ SYNCå‘½ä»¤æ¥å®ç°ï¼Œè¯¥å‘½ä»¤çš„æ‰§è¡Œæ­¥éª¤åŒ…æ‹¬ï¼š</p><ol><li>ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€SYNCå‘½ä»¤ï¼›</li><li>ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°å‘½ä»¤åï¼Œæ‰§è¡Œ BGSAVE å‘½ä»¤ï¼Œåœ¨åå°ç”Ÿæˆä¸€ä¸ª RDB æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºæ¥è®°å½•ä»å½“å‰å¼€å§‹çš„å†™å‘½ä»¤ï¼›</li><li>å½“ä¸»æœåŠ¡å™¨çš„ BGSAVEå‘½ä»¤æ‰§è¡Œå®Œæˆåå°±å°† RDB æ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨å¼€å§‹æ¥å—å¹¶ä¸”è½½å…¥è¿™ä¸ªRDB æ–‡ä»¶ï¼›</li><li>ä¸»æœåŠ¡å™¨å°†è®°å½•åœ¨ç¼“å†²åŒºé‡Œé¢çš„æ‰€æœ‰å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨æ‰§è¡Œï¼Œä»æœåŠ¡å™¨æ¥å°†è‡ªå·±çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°ä¸ºä¸»æœåŠ¡å™¨çš„çŠ¶æ€ã€‚</li></ol><p><strong>å‘½ä»¤ä¼ æ’­</strong></p><p>åœ¨åŒæ­¥æ“ä½œå®Œæˆåï¼Œä¸»æœåŠ¡å™¨ä¸€æ—¦æœ‰ä¸€äº›æ–°å‘½ä»¤çš„æ‰§è¡Œå¯¼è‡´æ•°æ®åº“å‘ç”Ÿæ”¹å˜å°±éœ€è¦å°†æ”¹å˜ç«‹åˆ»åŒæ­¥åˆ°ä»æœåŠ¡å™¨ï¼Œå› æ­¤å¯¹äºä¼šå¯¼è‡´æ•°æ®åº“æ›´æ”¹çš„å‘½ä»¤ï¼Œä¸»æœåŠ¡å™¨ä¼šåŒæ ·å‘é€åˆ°ä»æœåŠ¡å™¨ã€‚</p><h3 id="15-2-æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½çš„ç¼ºé™·">15.2 æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½çš„ç¼ºé™·</h3><p>åœ¨Redisä¸­çš„å¤åˆ¶å¯ä»¥åˆ†ä¸ºåˆæ¬¡å¤åˆ¶å’Œæ–­çº¿åçš„é‡å¤åˆ¶ã€‚æ—§ç‰ˆå¤åˆ¶å¯¹äºåˆæ¬¡å¤åˆ¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ–­çº¿åçš„é‡å¤åˆ¶æ•ˆç‡æ¯”è¾ƒä½ã€‚<br>å› ä¸ºå½“å¤åˆ¶è¿‡ç¨‹ä¸­å‡ºç°æ–­çº¿åï¼Œå½“ä»æœåŠ¡å™¨å†æ¬¡è¿æ¥ä¸Šæ—¶ç”±äºæ²¡æœ‰è®°å½•ä¸Šæ¬¡çš„å¤åˆ¶ä½ç½®ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ä»å¤´å¼€å§‹å¤åˆ¶ï¼Œæ‰§è¡ŒSYNC å‘½ä»¤(åˆæ¬¡å¤åˆ¶)ã€‚<br>ä½†æ˜¯ä¸»ä»æœåŠ¡å™¨æ–­å¼€çš„æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œå¯¼è‡´ä¸»æœåŠ¡å™¨åœ¨æ–­çº¿æœŸé—´æ‰§è¡Œçš„å†™å‘½ä»¤è¾ƒå°‘ï¼Œè€Œæ¯æ¬¡æ–­çº¿æ—¶ä¸ºäº†è¿™ç‚¹å‘½ä»¤é€‰æ‹©æ‰§è¡Œ SYNCå‘½ä»¤ï¼Œæ•ˆç‡éå¸¸ä½æ•ˆã€‚</p><p><strong>SYNC å‘½ä»¤æ˜¯ä¸€ç§éå¸¸è€—æ—¶çš„æ“ä½œ</strong></p><ul><li>ä¸»æœåŠ¡å™¨è¦æ‰§è¡Œ BGSAVE æŒ‡ä»¤æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè¿™ä¸ªæ“ä½œä¼šæ¶ˆè€—ä¸»æœåŠ¡å™¨å¤§é‡çš„ CPUã€å†…å­˜å’Œç£ç›˜ I/O èµ„æºã€‚</li><li>ä¸»æœåŠ¡å™¨å°† RDB æ–‡ä»¶å‘é€åˆ°ä»æœåŠ¡å™¨ä¼šæ¶ˆè€—ç½‘ç»œèµ„æºã€‚</li><li>ä»æœåŠ¡å™¨æ¥å— RDB æ–‡ä»¶åä¼šè½½å…¥ï¼Œè¿™ä¸ªæœŸé—´ä»æœåŠ¡å™¨ä¼šé˜»å¡æ²¡æœ‰åŠæ³•å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li></ul><h3 id="15-3-æ–°ç‰ˆå¤åˆ¶åŠŸèƒ½çš„å®ç°">15.3 æ–°ç‰ˆå¤åˆ¶åŠŸèƒ½çš„å®ç°</h3><p>æ–°ç‰ˆå¤åˆ¶é‡‡ç”¨ PSYNC å‘½ä»¤ä»£æ›¿æ—§ç‰ˆçš„ SYNC å‘½ä»¤ã€‚</p><p>è¿™ä¸å°±æ˜¯å¢é‡å¤åˆ¶éº»Qwq</p><p>è¯¥å‘½ä»¤åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>å®Œæ•´é‡åŒæ­¥ï¼šå’Œæ—§ç‰ˆå¤åˆ¶çš„åˆæ¬¡å¤åˆ¶æ“ä½œä¸€æ ·ã€‚</li><li>éƒ¨åˆ†é‡åŒæ­¥ï¼šç”¨äºæ–­çº¿åçš„å¤„ç†ï¼Œé‡‡ç”¨ å¤åˆ¶åç§»é‡ã€å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€æœåŠ¡å™¨è¿è¡ŒIDæ¥å®ç°æç¬‘çš„é‡è¿æ¥å¤åˆ¶æ“ä½œã€‚</li></ul><p><strong>éƒ¨åˆ†é‡åŒæ­¥</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424150947810.png" alt="image-20240424150947810"></p><p>ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨å„ä¿å­˜ä¸€ä»½å¤åˆ¶åç§»é‡ï¼Œæ¯æ¬¡ä¸»æœåŠ¡å™¨å‘é€æ•°æ®å’Œä»æœåŠ¡å™¨æˆåŠŸæ¥å—æ•°æ®å°±å¢åŠ ç›¸åº”çš„åç§»é‡ã€‚é€šè¿‡å¤åˆ¶åç§»é‡èƒ½å¤Ÿç¡®ä¿ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®çŠ¶æ€æ˜¯å¦ä¸€è‡´ã€‚</p><p><strong>å¤åˆ¶ç§¯å‹ç¼“å†²åŒº</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424151008569.png" alt="image-20240424151008569"></p><p>å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„ç‰¹ç‚¹ï¼š</p><ul><li>å¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ˜¯ç”±ä¸»æœåŠ¡å™¨ç»´æŠ¤çš„ä¸€ä¸ª<strong>å›ºå®šé•¿åº¦</strong>çš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º 1MBã€‚</li><li>æ¯å½“ä¸»æœåŠ¡å™¨è¿›è¡Œå‘½ä»¤ä¼ æ’­æ—¶ï¼Œå®ƒä¸ä»…ä¼šå°†æ•°æ®å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè¿˜è¦å°†æ•°æ®å†™å…¥åˆ°å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­ï¼Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºåŒæ—¶è¿˜ä¼šä¸ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå­—èŠ‚è®°å½•ç›¸åº”çš„å¤åˆ¶åç§»é‡ã€‚</li><li>é‚£ä¹ˆå½“ä»æœåŠ¡å™¨æ–­çº¿é‡è¿åï¼Œå®ƒä¼šå°†è‡ªå·±çš„å¤åˆ¶åç§»é‡å‘é€ç»™ä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨å°±ä¼šæ£€æŸ¥è¯¥åç§»é‡ä¹‹åçš„æ•°æ®æ˜¯å¦å…¨éƒ¨å­˜åœ¨äºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­ï¼Œå¦‚æœå…¨éƒ¨å­˜åœ¨å°±æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œï¼›å¦åˆ™å¿…é¡»æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œã€‚</li></ul><p>å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå¤§å°å¯ä»¥åŠ¨æ€è°ƒæ•´ï¼š</p><ul><li>é»˜è®¤å¤§å°æ˜¯ 1MBï¼Œä½†æ˜¯å¦‚æœæ–­çº¿æ—¶é—´è¿‡é•¿ï¼Œæ–­çº¿æ—¶å†™å…¥çš„æ•°æ®è¾ƒå¤šï¼Œå°±ä¼šç”±äºç¼“å†²åŒºå¤§å°å¤ªå°è€Œä¸å¾—ä¸è¿›è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œã€‚</li><li>ç¼“å†²åŒºå¤§å°çš„è®¡ç®—å…¬å¼ï¼šsecond * write_size_per_secondæ¥ä¼°ç®—ï¼Œsecondè¡¨ç¤ºä»æœåŠ¡å™¨æ–­çº¿åé‡æ–°è¿æ¥ä¸Šä¸»æœåŠ¡å™¨æ‰€éœ€çš„æ—¶é—´ï¼›write_size_per_second è¡¨ç¤ºä¸»æœåŠ¡å™¨æ¯ç§’é’Ÿå†™å…¥çš„å‘½ä»¤æ•°æ®é‡ã€‚</li><li>å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ repl-backlog-size é€‰é¡¹è°ƒæ•´ç¼“å†²åŒºå¤§å°ï¼›é€šè¿‡repl-backlog-ttlè°ƒæ•´ç¼“å†²åŒºçš„å­˜æ´»æ—¶é—´ï¼Œè¶…è¿‡ä¼šè¢«é”€æ¯ã€‚</li></ul><p><strong>æœåŠ¡å™¨ID</strong></p><p>æ¯ä¸ªæœåŠ¡å™¨å¯åŠ¨æ—¶éƒ½ä¼šåˆ†é…ä¸€ä¸ªæœåŠ¡å™¨IDï¼Œå½“ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨è¿›è¡Œåˆæ¬¡åŒæ­¥æ“ä½œæ—¶ï¼Œä¸»æœåŠ¡å™¨ä¼šå°†è‡ªå·±çš„æœåŠ¡å™¨IDå‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨ä¼šä¿å­˜èµ·æ¥ã€‚<br>å¦‚æœä»æœåŠ¡å™¨æ–­å¼€åé‡è¿åˆ°ä¸€ä¸ªä¸»æœåŠ¡å™¨ï¼Œå®ƒä¼šå‘é€ä¹‹å‰ä¿å­˜çš„ä¸»æœåŠ¡å™¨IDï¼Œå¦‚æœIDå’Œå½“å‰ä¸»æœåŠ¡å™¨IDç›¸åŒå°±æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œï¼Œå¦åˆ™æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œã€‚</p><p>ä»æœåŠ¡å™¨å‘é€æŒ‡ä»¤ï¼š</p><ul><li>å¦‚æœä»æœåŠ¡å™¨åˆæ¬¡åŒæ­¥ä¸»æœåŠ¡å™¨ï¼Œå®ƒä¼šå‘é€ PSYNC ? -1å‘½ä»¤ï¼Œè¯·æ±‚å®Œæ•´é‡åŒæ­¥æ“ä½œï¼›</li><li>å¦‚æœä»æœåŠ¡å™¨å·²ç»å¤åˆ¶è¿‡æŸä¸ªä¸»æœåŠ¡å™¨åï¼Œå½“å®ƒå¼€å§‹ä¸€æ¬¡æ–°å¤åˆ¶æ—¶ä¼šå‘é€ PSYNC &lt; runid &gt; &lt; offset &gt; å‘½ä»¤ï¼Œrunid æ˜¯ä¸Šæ¬¡ä¸»æœåŠ¡å™¨çš„IDï¼Œ offset æ˜¯è‡ªå·±å½“å‰çš„å¤åˆ¶åç§»é‡ã€‚</li></ul><p>ä¸»æœåŠ¡å™¨å›å¤æŒ‡ä»¤ï¼š</p><ul><li>+FULLRESYNC &lt; runid &gt; &lt; offset &gt;ï¼šä¸»æœåŠ¡å™¨ä¸ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´çš„é‡åŒæ­¥æ“ä½œï¼›</li><li>+CONTINUEï¼šæ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œï¼Œç­‰å¾…ä¸»æœåŠ¡å™¨å‘é€æ•°æ®ï¼›</li><li>-ERRï¼šè¯†åˆ«ä¸äº†å‘½ä»¤ï¼Œå‡ºç°é—®é¢˜ã€‚</li></ul><p>æ˜äº†æ¦‚å¿µ</p><p>ç®€è¿°å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥åŒºåˆ«ï¼Ÿ</p><ul><li>å…¨é‡åŒæ­¥ï¼šmasterå°†å®Œæ•´å†…å­˜æ•°æ®ç”ŸæˆRDBï¼Œå‘é€RDBåˆ°slaveã€‚åç»­å‘½ä»¤åˆ™è®°å½•åœ¨repl_baklogï¼Œé€ä¸ªå‘é€ç»™slaveã€‚</li><li>å¢é‡åŒæ­¥ï¼šslaveæäº¤è‡ªå·±çš„offsetåˆ°masterï¼Œmasterè·å–repl_baklogä¸­ä»offsetä¹‹åçš„å‘½ä»¤ç»™slave</li></ul><p>ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå…¨é‡åŒæ­¥ï¼Ÿ</p><ul><li>slaveèŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥masterèŠ‚ç‚¹æ—¶</li><li>slaveèŠ‚ç‚¹æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_baklogä¸­çš„offsetå·²ç»è¢«è¦†ç›–æ—¶</li></ul><p>ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¢é‡åŒæ­¥ï¼Ÿ</p><ul><li>slaveèŠ‚ç‚¹æ–­å¼€åˆæ¢å¤ï¼Œå¹¶ä¸”åœ¨repl_baklogä¸­èƒ½æ‰¾åˆ°offsetæ—¶</li></ul><h3 id="15-7-å¿ƒè·³æ£€æµ‹">15.7 å¿ƒè·³æ£€æµ‹</h3><p>åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä»æœåŠ¡å™¨é»˜è®¤ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œå‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ REPLCONF ACK &lt;replication_offset&gt; ï¼Œå…¶ä¸­ replication_offset æ˜¯ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡ã€‚</p><p>å‘é€ REPLCONF ACKå‘½ä»¤å¯¹äºä»æœåŠ¡å™¨æœ‰ä¸‰ä¸ªä½œç”¨ï¼š</p><ul><li>æ£€æµ‹ä¸»ä»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€ã€‚</li><li>è¾…åŠ©å®ç° min-slavesé€‰é¡¹ã€‚</li><li>æ£€æµ‹å‘½ä»¤æ˜¯å¦ä¸¢å¤±ã€‚</li></ul><h2 id="ç¬¬åå…­ç« -Sentinel">ç¬¬åå…­ç«  Sentinel</h2><p>è¿™ä¸ªå¤§è‡´æ€è·¯å’Œraftåè®®å¾ˆåƒã€‚</p><p>Sentinelï¼ˆå“¨å²—ã€å“¨å…µï¼‰æ˜¯ Redis çš„é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆï¼šç”±ä¸€ä¸ªæˆ–å¤šä¸ª Sentinel å®ä¾‹ï¼ˆinstanceï¼‰ç»„æˆçš„ Sentinel ç³»ç»Ÿå¯ä»¥ç›‘è§†ä»»æ„å¤šä¸ªä¸»æœåŠ¡å™¨ï¼Œä»¥åŠè¿™äº›ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œå¹¶åœ¨ç›‘è§†çš„ä¸»æœåŠ¡å™¨è¿›å…¥ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œè‡ªåŠ¨å°†ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æŸä¸ªä»æœåŠ¡å™¨å‡çº§ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ï¼Œç„¶åç”±æ–°çš„ä¸»æœåŠ¡å™¨ä»£æ›¿å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</p><p>å“¨å…µçš„ä½œç”¨</p><ul><li>ç›‘æ§ï¼šSentinel ä¼šä¸æ–­æ£€æŸ¥æ‚¨çš„masterå’Œslaveæ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ</li><li>è‡ªåŠ¨æ•…éšœæ¢å¤ï¼šå¦‚æœmasteræ•…éšœï¼ŒSentinelä¼šå°†ä¸€ä¸ªslaveæå‡ä¸ºmasterã€‚å½“æ•…éšœå®ä¾‹æ¢å¤åä¹Ÿä»¥æ–°çš„masterä¸ºä¸»</li><li>é€šçŸ¥ï¼šSentinelå……å½“Rediså®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°æ¥æºï¼Œå½“é›†ç¾¤å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œä¼šå°†æœ€æ–°ä¿¡æ¯æ¨é€ç»™Redisçš„å®¢æˆ·ç«¯</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424113707465.png" alt="image-20240424113707465"></p><p><strong>ä¸»è§‚ä¸‹çº¿</strong></p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSentinel ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘æ‰€æœ‰ä¸å®ƒåˆ›å»ºäº†å‘½ä»¤è¿æ¥çš„å®ä¾‹ï¼ˆåŒ…æ‹¬ä¸»æœåŠ¡å™¨ã€ä»æœåŠ¡å™¨ã€å…¶å®ƒ Sentinel åœ¨å†…ï¼‰å‘é€ PING å‘½ä»¤ï¼Œå¹¶é€šè¿‡å®ä¾‹è¿”å›çš„ PINGå‘½ä»¤å›å¤æ¥åˆ¤æ–­å®ä¾‹æ˜¯å¦åœ¨çº¿ã€‚</p><p>å¦‚æœåœ¨é»˜è®¤é…ç½®çš„é—´éš”æ—¶é—´å†…ï¼Œæœ‰ä¸€æœåŠ¡å™¨å¹¶æ²¡æœ‰è¿›è¡Œæœ‰æ•ˆå›å¤ï¼Œé‚£æ­¤ Sentinel å°±ä¼šå°†æ­¤æœåŠ¡å™¨æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ã€‚</p><p><strong>å®¢è§‚ä¸‹çº¿</strong></p><p>å½“ Sentinel å°†ä¸€ä¸ªæœåŠ¡å™¨åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿ä¹‹åï¼Œä¸ºäº†ç¡®å®šæ­¤æœåŠ¡å™¨æ˜¯å¦æ˜¯çœŸçš„ä¸‹çº¿äº†ï¼Œå®ƒä¼šå»è¯¢é—®å…¶å®ƒ Sentinel æ­¤æœåŠ¡å™¨æ˜¯å¦å·²ä¸‹çº¿ï¼Œå½“å¾—åˆ°è¶³å¤Ÿæ•°é‡çš„ç¡®å®šå›å¤ä¹‹åï¼ŒSentinel å°±ä¼šå°†æ­¤æœåŠ¡å™¨æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿çŠ¶æ€ï¼Œå¦‚æœæ­¤æœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨ï¼Œå°±æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œã€‚</p><p><strong>é€‰ä¸¾é¢†å¤´ Sentinel</strong></p><p>å½“ä¸€ä¸ªä¸»æœåŠ¡å™¨è¢«åˆ¤å®šä¸ºå®¢è§‚ä¸‹çº¿ä¹‹åï¼Œç›‘è§†è¿™ä¸ªä¸‹çº¿ä¸»æœåŠ¡å™¨çš„å„ä¸ª Sentinel ä¼šè¿›è¡Œåå•†ï¼Œé€‰ä¸¾å‡ºä¸€ä¸ªé¢†å¤´ Sentinelï¼Œå¹¶ç”±é¢†å¤´ Sentinel å¯¹ä¸‹çº¿ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œã€‚</p><p><strong>æ•…éšœè½¬ç§»</strong></p><p>åœ¨é€‰ä¸¾äº§ç”Ÿé¢†å¤´ Sentinel ä¹‹åï¼Œé¢†å¤´ Sentinel å°†å¯¹å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>åœ¨å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªä»æœåŠ¡å™¨å°†å…¶è½¬æ¢ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ã€‚</li><li>è®©å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨æ”¹ä¸ºå¤åˆ¶æ–°çš„ä»æœåŠ¡å™¨ã€‚</li><li>å°†å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨è®¾ç½®ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼Œå½“è¿™ä¸ªæ—§çš„ä¸»æœåŠ¡å™¨é‡æ–°ä¸Šçº¿æ—¶ï¼Œä»–å°±ä¼šæˆä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨</li></ol><p><strong>æ€»ç»“</strong></p><p>Sentinelçš„ä¸‰ä¸ªä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>ç›‘æ§</li><li>æ•…éšœè½¬ç§»</li><li>é€šçŸ¥</li></ul><p>Sentinelå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªrediså®ä¾‹æ˜¯å¦å¥åº·ï¼Ÿ</p><ul><li>æ¯éš”1ç§’å‘é€ä¸€æ¬¡pingå‘½ä»¤ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰ç›¸å‘åˆ™è®¤ä¸ºæ˜¯ä¸»è§‚ä¸‹çº¿</li><li>å¦‚æœå¤§å¤šæ•°sentineléƒ½è®¤ä¸ºå®ä¾‹ä¸»è§‚ä¸‹çº¿ï¼Œåˆ™åˆ¤å®šæœåŠ¡ä¸‹çº¿</li></ul><p>æ•…éšœè½¬ç§»æ­¥éª¤æœ‰å“ªäº›ï¼Ÿ</p><ul><li>é¦–å…ˆé€‰å®šä¸€ä¸ªslaveä½œä¸ºæ–°çš„masterï¼Œæ‰§è¡Œslaveof no one</li><li>ç„¶åè®©æ‰€æœ‰èŠ‚ç‚¹éƒ½æ‰§è¡Œslaveof æ–°master</li><li>ä¿®æ”¹æ•…éšœèŠ‚ç‚¹ï¼Œæ‰§è¡Œslaveof æ–°master</li></ul><h2 id="ç¬¬åä¸ƒç« -é›†ç¾¤">ç¬¬åä¸ƒç«  é›†ç¾¤</h2><p>Redis é›†ç¾¤æ˜¯ Redis æä¾›çš„åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆï¼Œé›†ç¾¤é€šè¿‡åˆ†ç‰‡ï¼ˆshardingï¼‰æ¥è¿›è¡Œæ•°æ®å…±äº«ï¼Œå¹¶æä¾›å¤åˆ¶å’Œæ•…éšœè½¬ç§»åŠŸèƒ½ã€‚</p><p>ä¸€ä¸ª Redis é›†ç¾¤é€šå¸¸ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼Œåœ¨åˆšå¼€å§‹çš„æ—¶å€™ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå®ƒä»¬éƒ½å¤„äºä¸€ä¸ªåªåŒ…å«è‡ªå·±çš„é›†ç¾¤å½“ä¸­ï¼Œè¦ç»„å»ºä¸€ä¸ªçœŸæ­£å¯å·¥ä½œçš„é›†ç¾¤ï¼Œæˆ‘ä»¬å¿…é¡»å°†å„ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªåŒ…å«å¤šä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿æ¥å„ä¸ªèŠ‚ç‚¹çš„å·¥ä½œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤æ¥å®Œæˆ</span></span><br><span class="line">CLUSTER MEET  </span><br></pre></td></tr></table></figure><h3 id="æ§½æŒ‡æ´¾">æ§½æŒ‡æ´¾</h3><p>Redisä¼šæŠŠæ¯ä¸€ä¸ªmasterèŠ‚ç‚¹æ˜ å°„åˆ°0~16383å…±16384ä¸ªæ’æ§½ï¼ˆhash slotï¼‰ä¸Šï¼ŒæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯æ—¶å°±èƒ½çœ‹åˆ°ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424114229008.png" alt="image-20240424114229008"></p><p>æ•°æ®keyä¸æ˜¯ä¸èŠ‚ç‚¹ç»‘å®šï¼Œè€Œæ˜¯ä¸æ’æ§½ç»‘å®šã€‚redisä¼šæ ¹æ®keyçš„æœ‰æ•ˆéƒ¨åˆ†è®¡ç®—æ’æ§½å€¼ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š</p><ul><li><p>keyä¸­åŒ…å«&quot;{}&quot;ï¼Œä¸”â€œ{}â€ä¸­è‡³å°‘åŒ…å«1ä¸ªå­—ç¬¦ï¼Œâ€œ{}â€ä¸­çš„éƒ¨åˆ†æ˜¯æœ‰æ•ˆéƒ¨åˆ†</p></li><li><p>keyä¸­ä¸åŒ…å«â€œ{}â€ï¼Œæ•´ä¸ªkeyéƒ½æ˜¯æœ‰æ•ˆéƒ¨åˆ†</p></li></ul><p>ä¾‹å¦‚ï¼škeyæ˜¯numï¼Œé‚£ä¹ˆå°±æ ¹æ®numè®¡ç®—ï¼Œå¦‚æœæ˜¯{itcast}numï¼Œåˆ™æ ¹æ®itcastè®¡ç®—ã€‚è®¡ç®—æ–¹å¼æ˜¯åˆ©ç”¨CRC16ç®—æ³•å¾—åˆ°ä¸€ä¸ªhashå€¼ï¼Œç„¶åå¯¹16384å–ä½™ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯slotå€¼ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424114234608.png" alt="image-20240424114234608"></p><p>Rediså¦‚ä½•åˆ¤æ–­æŸä¸ªkeyåº”è¯¥åœ¨å“ªä¸ªå®ä¾‹ï¼Ÿ</p><ul><li>å°†16384ä¸ªæ’æ§½åˆ†é…åˆ°ä¸åŒçš„å®ä¾‹</li><li>æ ¹æ®keyçš„æœ‰æ•ˆéƒ¨åˆ†è®¡ç®—å“ˆå¸Œå€¼ï¼Œå¯¹16384å–ä½™</li><li>ä½™æ•°ä½œä¸ºæ’æ§½ï¼Œå¯»æ‰¾æ’æ§½æ‰€åœ¨å®ä¾‹å³å¯</li></ul><p>å¦‚ä½•å°†åŒä¸€ç±»æ•°æ®å›ºå®šçš„ä¿å­˜åœ¨åŒä¸€ä¸ªRediså®ä¾‹ï¼Ÿ</p><ul><li>è¿™ä¸€ç±»æ•°æ®ä½¿ç”¨ç›¸åŒçš„æœ‰æ•ˆéƒ¨åˆ†ï¼Œä¾‹å¦‚keyéƒ½ä»¥{typeId}ä¸ºå‰ç¼€</li></ul><h2 id="ç¬¬åå…«ç« -å‘å¸ƒä¸è®¢é˜…">ç¬¬åå…«ç«  å‘å¸ƒä¸è®¢é˜…</h2><p>Redis çš„å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½ç”± PUBLISHã€SUBSCRIBEã€PSUBSCRIBEç­‰å‘½ä»¤ç»„æˆ</p><ul><li>SUBSCRIBEæ˜¯é¢‘é“è®¢é˜…ï¼Œå®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“ï¼Œæˆä¸ºè¿™äº›é¢‘é“çš„è®¢é˜…è€…ï¼ˆsubscriberï¼‰ï¼Œæ¯å½“æœ‰å…¶å®ƒå®¢æˆ·ç«¯å‘è¢«è®¢é˜…çš„é¢‘é“å‘é€æ¶ˆæ¯æ—¶ï¼Œé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°è¿™æ¡æ¶ˆæ¯</li><li>PSUBSCRIBEæ˜¯åŸºäºæ¨¡å¼çš„è®¢é˜…ï¼Œé™¤äº†è®¢é˜…é¢‘é“ä¹‹å¤–ï¼Œå®¢æˆ·ç«¯è¿˜å¯ä»¥é€šè¿‡æ‰§è¡Œ PSUBSCRIBE å‘½ä»¤è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼ï¼Œä»è€Œæˆä¸ºè¿™äº›æ¨¡å¼çš„è®¢é˜…è€…ï¼Œæ¯å½“æœ‰å…¶å®ƒå®¢æˆ·ç«¯å‘æŸä¸ªé¢‘é“å‘é€æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯ä¸ä»…ä¼šè¢«å‘é€ç»™è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œå®ƒè¿˜ä¼šå‘é€ç»™æ‰€æœ‰ä¸è¿™ä¸ªé¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼çš„è®¢é˜…è€…ã€‚</li></ul><p>å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ PUBSUBå‘½ä»¤æ¥æŸ¥çœ‹é¢‘é“æˆ–è€…æ¨¡å¼çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚æŸä¸ªé¢‘é“ç›®å‰æœ‰å¤šå°‘è®¢é˜…è€…ï¼Œåˆæˆ–è€…æŸä¸ªæ¨¡å¼ç›®å‰æœ‰å¤šå°‘è®¢é˜…è€…ç­‰ç­‰ã€‚</p><p>å½“ä¸€ä¸ª Redis å®¢æˆ·ç«¯æ‰§è¡Œ PUBLISH  &lt; channel &gt; &lt; message &gt; å‘½ä»¤å°†æ¶ˆæ¯ message å‘é€ç»™é¢‘é“ channel çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨éœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªåŠ¨ä½œï¼š</p><ol><li>å°†æ¶ˆæ¯ message å‘é€ç»™ channel é¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ã€‚</li><li>å¦‚æœæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼çš„ pattern ä¸é¢‘é“ channel ç›¸åŒ¹é…ï¼Œé‚£ä¹ˆå°†æ¶ˆæ¯ message å‘é€ç»™ pattern æ¨¡å¼çš„è®¢é˜…è€…ã€‚</li></ol><h2 id="ç¬¬åä¹ç« -äº‹åŠ¡">ç¬¬åä¹ç«  äº‹åŠ¡</h2><p>Redisé€šè¿‡MULTIã€EXECã€WATCHç­‰å‘½ä»¤æ¥å®ç°äº‹åŠ¡( transaction)åŠŸèƒ½ã€‚äº‹åŠ¡æä¾›äº†ä¸€ç§å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œå¤šä¸ªå‘½ä»¤çš„æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡è€Œæ”¹å»æ‰§è¡Œå…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼Œå®ƒä¼šå°†äº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åæ‰å»å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ã€‚</p><h3 id="19-1-äº‹åŠ¡çš„å®ç°">19.1 äº‹åŠ¡çš„å®ç°</h3><p>ä¸€ä¸ªäº‹åŠ¡ä»å¼€å§‹åˆ°ç»“æŸé€šå¸¸ä¼šç»å†ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µ:</p><p>1ï¼‰äº‹åŠ¡å¼€å§‹</p><p>2ï¼‰å‘½ä»¤å…¥é˜Ÿ</p><p>3ï¼‰äº‹åŠ¡æ‰§è¡Œ</p><p>æœ¬èŠ‚æ¥ä¸‹æ¥çš„å†…å®¹å°†å¯¹è¿™ä¸‰ä¸ªé˜¶æ®µè¿›è¡Œä»‹ç»ï¼Œè¯´æ˜ä¸€ä¸ªäº‹åŠ¡ä»å¼€å§‹åˆ°ç»“æŸçš„æ•´ä¸ªè¿‡ç¨‹ã€‚</p><p><strong>äº‹åŠ¡å¼€å§‹</strong></p><ol><li>MULTI å‘½ä»¤çš„æ‰§è¡Œä»£è¡¨äº‹åŠ¡çš„å¼€å§‹ï¼ŒMULTIé€šè¿‡å°†å®¢æˆ·ç«¯çŠ¶æ€çš„ flags å±æ€§ä¸­çš„ REDIS_MULTIæ ‡è¯†æ‰“å¼€æ¥å°†æ‰§è¡Œè¯¥å‘½ä»¤çš„å®¢æˆ·ç«¯åˆ‡æ¢è‡³äº‹åŠ¡çŠ¶æ€ã€‚</li><li>æ¯ä¸ªå®¢æˆ·ç«¯éƒ½æœ‰è‡ªå·±çš„äº‹åŠ¡çŠ¶æ€ï¼Œå®ƒä¿å­˜åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„ mstate å±æ€§é‡Œé¢ï¼Œmstate é‡Œé¢åŒ…å«ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ï¼Œä»¥åŠä¸€ä¸ªå·²å…¥é˜Ÿå‘½ä»¤çš„è®¡æ•°å™¨ï¼Œäº‹åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ª multiCmdç±»å‹çš„æ•°ç»„ï¼Œæ¯ä¸ª multiCmd ç»“æ„éƒ½ä¿å­˜ç€ä¸€ä¸ªå·²å…¥é˜Ÿå‘½ä»¤çš„ç›¸å…³ä¿¡æ¯ï¼Œäº‹åŠ¡é˜Ÿåˆ—ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼ä¿å­˜å…¥é˜Ÿå‘½ä»¤ã€‚</li><li>å½“ä¸€ä¸ªå¤„äºäº‹åŠ¡çŠ¶æ€çš„å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ EXECå‘½ä»¤æ—¶ï¼Œè¿™ä¸ª EXECå‘½ä»¤ä¼šç«‹å³è¢«æ‰§è¡Œã€‚æœåŠ¡å™¨ä¼šéå†è¿™ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œé˜Ÿåˆ—ä¸­ä¿å­˜çš„æ‰€æœ‰å‘½ä»¤ï¼Œæœ€åå°†æ‰§è¡Œå‘½ä»¤æ‰€å¾—çš„ç»“æœå…¨éƒ¨è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424142426360.png" alt="image-20240424142426360"></p><h3 id="19-2-WATCHå‘½ä»¤çš„å®ç°">19.2 WATCHå‘½ä»¤çš„å®ç°</h3><p>WATCHå‘½ä»¤æ˜¯ä¸€ä¸ªä¹è§‚é”ï¼ˆ optimistic locking )ï¼Œå®ƒå¯ä»¥åœ¨EXECå‘½ä»¤æ‰§è¡Œä¹‹å‰ï¼Œç›‘è§†ä»»æ„æ•°é‡çš„æ•°æ®åº“é”®ï¼Œå¹¶åœ¨EXECå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ£€æŸ¥è¢«ç›‘è§†çš„é”®æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼ŒæœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›ä»£è¡¨äº‹åŠ¡æ‰§è¡Œå¤±è´¥çš„ç©ºå›å¤ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»ä¸‹watchå‘½ä»¤çš„å®ç°åŸç†ã€‚</p><p>æ¯ä¸ªRedisæ•°æ®åº“éƒ½ä¿å­˜ç€ä¸€ä¸ªwatched_keyså­—å…¸ï¼Œè¿™ä¸ªå­—å…¸çš„é”®æ˜¯æŸä¸ªè¢«WATCHå‘½ä»¤ç›‘è§†çš„æ•°æ®åº“é”®ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­è®°å½•äº†æ‰€æœ‰ç›‘è§†ç›¸åº”æ•°æ®åº“é”®çš„å®¢æˆ·ç«¯:</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424142552387.png" alt="image-20240424142552387"></p><p>ä¸‹å›¾å±•ç¤ºçš„watched_keyså­—å…¸å°†è¢«æ›´æ–°çš„çŠ¶æ€ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424142606928.png" alt="image-20240424142606928"></p><p><strong>ç›‘è§†æœºåˆ¶çš„è§¦å‘</strong></p><p>æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤ï¼Œæ¯”å¦‚SETã€LPUSHã€SADDã€ZREMã€DELã€FLUSHDBç­‰ç­‰ï¼Œåœ¨æ‰§è¡Œä¹‹åéƒ½ä¼šè°ƒç”¨multi.c/touchWatchKeyå‡½æ•°å¯¹watched_keyså­—å…¸è¿›è¡Œæ£€æŸ¥ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å®¢æˆ·ç«¯æ­£åœ¨ç›‘è§†åˆšåˆšè¢«å‘½ä»¤ä¿®æ”¹è¿‡çš„æ•°æ®åº“é”®ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œé‚£ä¹ˆtouchwatchKeyå‡½æ•°ä¼šå°†ç›‘è§†è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„REDIS_DIRTY_CAsæ ‡è¯†æ‰“å¼€ï¼Œè¡¨ç¤ºè¯¥å®¢æˆ·ç«¯çš„äº‹åŠ¡å®‰å…¨æ€§å·²ç»è¢«ç ´åã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240424142724988.png" alt="image-20240424142724988"></p><h3 id="19-3-äº‹åŠ¡çš„ACIDæ€§è´¨">19.3 äº‹åŠ¡çš„ACIDæ€§è´¨</h3><p>åœ¨ Redis ä¸­ï¼Œäº‹åŠ¡æ€»æ˜¯å…·æœ‰åŸå­æ€§(Atomicity )ã€ä¸€è‡´æ€§( Consistency)å’Œéš”ç¦»æ€§( Isolation )ï¼Œå¹¶ä¸”å½“Redisè¿è¡Œåœ¨æŸç§ç‰¹å®šçš„æŒä¹…åŒ–æ¨¡å¼ä¸‹æ—¶ï¼Œäº‹åŠ¡ä¹Ÿå…·æœ‰è€ä¹…æ€§( Durability )ã€‚</p><h2 id="ç¬¬äºŒåç« -Luaè„šæœ¬">ç¬¬äºŒåç«  Luaè„šæœ¬</h2><h2 id="ç¬¬äºŒåä¸€ç« -äºŒè¿›åˆ¶ä½æ•°ç»„">ç¬¬äºŒåä¸€ç«  äºŒè¿›åˆ¶ä½æ•°ç»„</h2><p>Redis æä¾›äº† SETBITã€GETBITã€BITCOUNTã€BITOP å››ä¸ªå‘½ä»¤ç”¨äºå¤„ç†äºŒè¿›åˆ¶ä½æ•°ç»„ï¼Œåˆç§° â€œä½æ•°ç»„â€</p><ul><li>SETBITå‘½ä»¤ç”¨äºä¸ºä½æ•°ç»„æŒ‡å®šåç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½è®¾ç½®å€¼ï¼Œå¯ä»¥æ˜¯ 0 æˆ–è€… 1</li><li>GETBIT ç”¨äºè·å–æŒ‡å®šåç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼</li><li>BITCOUNT ç”¨äºç»Ÿè®¡ä½æ•°ç»„é‡Œé¢ï¼Œå€¼ä¸º 1 çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡</li><li>BITOPå¯ä»¥å¯¹å¤šä¸ªä½æ•°ç»„è¿›è¡ŒæŒ‰ä½ä¸ï¼ˆandï¼‰ã€æŒ‰ä½æˆ–ï¼ˆorï¼‰ã€æŒ‰ä½å¼‚æˆ–ï¼ˆxorï¼‰ã€å–åï¼ˆnotï¼‰è¿ç®—</li></ul><p>Redis ä½¿ç”¨ SDS æ¥ä¿å­˜ä½æ•°ç»„ã€‚</p><h2 id="ç¬¬äºŒåäºŒç« -æ…¢æŸ¥è¯¢æ—¥å¿—">ç¬¬äºŒåäºŒç«  æ…¢æŸ¥è¯¢æ—¥å¿—</h2><ul><li>Redis çš„æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ç”¨äºè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡ç»™å®šæ—¶é•¿çš„å‘½ä»¤è¯·æ±‚ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¿™ä¸ªåŠŸèƒ½äº§ç”Ÿçš„æ—¥å¿—æ¥ç›‘è§†å’Œä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦ã€‚</li></ul><h2 id="ç¬¬äºŒåä¸‰ç« -ç›‘è§†å™¨">ç¬¬äºŒåä¸‰ç«  ç›‘è§†å™¨</h2><ul><li>å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æ‰§è¡Œ MONITOR å‘½ä»¤ï¼Œå°†å®¢æˆ·ç«¯è½¬æ¢æˆç›‘è§†å™¨ï¼Œæ¥æ”¶å¹¶æ‰“å°æœåŠ¡å™¨å¤„ç†çš„æ¯ä¸ªå‘½ä»¤è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯</li><li>å½“ä¸€ä¸ªå®¢æˆ·ç«¯ä»æ™®é€šå®¢æˆ·ç«¯å˜ä¸ºç›‘è§†å™¨æ—¶ï¼Œè¯¥å®¢æˆ·ç«¯çš„ REDIS_MONITORæ ‡è¯†ä¼šè¢«æ‰“å¼€</li><li>æœåŠ¡å™¨å°†æ‰€æœ‰ç›‘è§†å™¨éƒ½è®°å½•åœ¨ monitors é“¾è¡¨ä¸­</li><li>æ¯æ¬¡å¤„ç†å‘½ä»¤æ—¶ï¼ŒæœåŠ¡å™¨éƒ½ä¼šéå† monitors é“¾è¡¨ï¼Œå°†ç›¸å…³ä¿¡æ¯å‘é€ç»™ç›‘è§†å™¨</li></ul>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
          <category> è¯»ä¹¦ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…å­˜å±éšœ</title>
      <link href="/posts/a5a0c60f.html"/>
      <url>/posts/a5a0c60f.html</url>
      
        <content type="html"><![CDATA[<h2 id="CPUç¼“å­˜">CPUç¼“å­˜</h2><p>æ¥ä¸ªé—®é¢˜å…ˆ=-=</p><p>Qï¼šä¸ºä»€ä¹ˆåŠ ç¼“å­˜ï¼Ÿ</p><p>Aï¼šå› ä¸ºCPUå’Œä¸»å­˜çš„é€Ÿåº¦å·®å¼‚ã€‚</p><p>Qï¼šç¼“å­˜çš„è®¾è®¡æ˜¯æ ¹æ®ç¨‹åºå±€éƒ¨æ€§åŸç†</p><p>Aï¼šç¨‹åºå±€éƒ¨æ€§åŒ…æ‹¬æ—¶é—´å±€éƒ¨æ€§å’Œç©ºé—´å±€éƒ¨æ€§ã€‚</p><ol><li>æ—¶é—´å±€éƒ¨æ€§æ˜¯æŒ‡è¢«è®¿é—®è¿‡ä¸€æ¬¡çš„å†…å­˜ä½ç½®å¾ˆå¯èƒ½åœ¨ä¸è¿œçš„å°†æ¥ä¼šè¢«å†æ¬¡è®¿é—®ã€‚</li><li>ç©ºé—´å±€éƒ¨æ€§æ˜¯æŒ‡å¦‚æœä¸€ä¸ªå†…å­˜ä½ç½®è¢«å¼•ç”¨è¿‡ï¼Œé‚£ä¹ˆå®ƒé‚»è¿‘çš„ä½ç½®åœ¨ä¸è¿œçš„å°†æ¥ä¹Ÿæœ‰å¾ˆå¤§æ¦‚ç‡ä¼šè¢«è®¿é—®ã€‚</li></ol><p>å¼€å§‹æ­£é¢˜^-^</p><p>ç¼“å­˜æ˜¯ç”± SRAMï¼ˆé™æ€éšæœºå­˜å‚¨ï¼‰ç»„æˆçš„ï¼Œå®ƒçš„æœ¬è´¨æ˜¯ä¸€ç§æ—¶åºé€»è¾‘ç”µè·¯ï¼Œå…·ä½“çš„æ¯ä¸ªå•å…ƒï¼ˆæ¯”ç‰¹ï¼‰ç”±ä¸€ä¸ªä¸ªé”å­˜å™¨æ„æˆï¼Œé”å­˜å™¨çš„åŠŸèƒ½å°±æ˜¯è®©ç”µè·¯å…·æœ‰è®°å¿†åŠŸèƒ½ã€‚</p><p>ç¼“å­˜é›†æˆåˆ°èŠ¯ç‰‡çš„æ–¹å¼æœ‰å¤šç§ï¼Œåœ¨å¤šæ ¸èŠ¯ç‰‡ä¸Šï¼Œç¼“å­˜é›†æˆçš„æ–¹å¼ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p><ul><li><p><strong>é›†ä¸­å¼ç¼“å­˜</strong>ï¼šä¸€ä¸ªç¼“å­˜å’Œæ‰€æœ‰å¤„ç†å™¨ç›´æ¥ç›¸è¿ï¼Œå¤šä¸ªæ ¸å…±äº«è¿™ä¸€ä¸ªç¼“å­˜</p></li><li><p><strong>åˆ†å¸ƒå¼ç¼“å­˜</strong>ï¼šä¸€ä¸ªå¤„ç†å™¨ä»…å’Œä¸€ä¸ªç¼“å­˜ç›¸è¿ï¼Œä¸€ä¸ªå¤„ç†å™¨å¯¹åº”ä¸€ä¸ªç¼“å­˜</p></li><li><p><strong>æ··åˆå¼ç¼“å­˜</strong>ï¼šåœ¨ L3 é‡‡ç”¨é›†ä¸­å¼ç¼“å­˜ï¼Œåœ¨ L1 å’Œ L2 é‡‡ç”¨åˆ†å¸ƒå¼ç¼“å­˜</p></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423160952647.png" alt="image-20240423160952647"></p><p>è¶Šé è¿‘ CPU æ ¸å¿ƒçš„ç¼“å­˜å…¶è®¿é—®é€Ÿåº¦è¶Šå¿«ï¼ŒCPU è®¿é—® L1 Cache åªéœ€è¦ 2~4ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œè®¿é—® L2 Cache å¤§çº¦ 10~20 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œè®¿é—® L3 Cache å¤§çº¦ 20~60 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œè€Œè®¿é—®å†…å­˜é€Ÿåº¦å¤§æ¦‚åœ¨ 200~300 ä¸ªæ—¶é’Ÿå‘¨æœŸä¹‹é—´ã€‚å¦‚ä¸‹è¡¨æ ¼ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423161038790.png" alt="image-20240423161038790"></p><h3 id="ç¼“å­˜çš„å·¥ä½œåŸç†">ç¼“å­˜çš„å·¥ä½œåŸç†</h3><p><strong>ä»‹ç»</strong></p><p>å…ˆæ¥å­¦ä¹ ä¸‹cache lineï¼ˆç¼“å­˜è¡Œ/ç¼“å­˜å—ï¼‰ï¼Œcache line æ˜¯ç¼“å­˜è¿›è¡Œç®¡ç†çš„ä¸€ä¸ªæœ€å°å­˜å‚¨å•å…ƒï¼Œä¹Ÿå«ç¼“å­˜å—ã€‚ä»å†…å­˜å‘ç¼“å­˜åŠ è½½æ•°æ®ä¹Ÿæ˜¯æŒ‰ç¼“å­˜å—è¿›è¡ŒåŠ è½½çš„ï¼Œä¸€ä¸ªç¼“å­˜å—å’Œä¸€ä¸ªå†…å­˜ä¸­ç›¸åŒå®¹é‡çš„æ•°æ®å—ï¼ˆä¸‹ç§°å†…å­˜å—ï¼‰å¯¹åº”ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423161303297.png" alt=""></p><p>ä¸Šå›¾ä¸­çš„å°æ–¹æ¡†å°±ä»£è¡¨ä¸€ä¸ªç¼“å­˜å—ã€‚</p><p>æ•´ä¸ªç¼“å­˜ç”±ç»„ï¼ˆsetï¼‰æ„æˆï¼Œæ¯ä¸ªç»„ç”±è·¯ï¼ˆwayï¼‰æ„æˆã€‚æ‰€ä»¥æ•´ä¸ªç¼“å­˜å®¹é‡ç­‰äºç»„æ•°ã€è·¯æ•°å’Œç¼“å­˜å—å¤§å°çš„ä¹˜ç§¯ï¼š</p><p>è®¡ç®—å…¬å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ•´ä¸ªç¼“å­˜å®¹é‡=ç»„æ•°Ã—è·¯æ•°Ã—ç¼“å­˜å—å¤§å°</span><br></pre></td></tr></table></figure><p><strong>ç®€å•è®¤è¯†</strong></p><p>CPU Cache çš„æ•°æ®æ˜¯ä»å†…å­˜ä¸­è¯»å–è¿‡æ¥çš„ï¼Œå®ƒæ˜¯ä»¥ä¸€å°å—ä¸€å°å—è¯»å–æ•°æ®çš„ï¼Œè€Œä¸æ˜¯æŒ‰ç…§å•ä¸ªæ•°ç»„å…ƒç´ æ¥è¯»å–æ•°æ®çš„ï¼Œåœ¨ CPU Cache ä¸­çš„ï¼Œè¿™æ ·ä¸€å°å—ä¸€å°å—çš„æ•°æ®ï¼Œç§°ä¸º <strong>Cache Lineï¼ˆç¼“å­˜å—ï¼‰</strong>ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ ¹æ®ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹linux L1 Cacheçš„ç¼“å­˜å¤§å°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> âœ˜ penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° <span class="built_in">cat</span>  /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size </span><br><span class="line">64</span><br></pre></td></tr></table></figure><p>L1 Cache ä¸€æ¬¡è½½å…¥æ•°æ®çš„å¤§å°æ˜¯ 64 å­—èŠ‚ã€‚</p><p>æ¯”å¦‚ï¼Œæœ‰ä¸€ä¸ª int array[100]çš„æ•°ç»„ï¼Œå½“è½½å…¥ array[0]æ—¶ï¼Œç”±äºè¿™ä¸ªæ•°ç»„å…ƒç´ çš„å¤§å°åœ¨å†…å­˜åªå  4 å­—èŠ‚ï¼Œä¸è¶³ 64 å­—èŠ‚ï¼ŒCPU å°±ä¼š<strong>é¡ºåºåŠ è½½</strong>æ•°ç»„å…ƒç´ åˆ° array[15]ï¼Œæ„å‘³ç€ array[0]~array[15] æ•°ç»„å…ƒç´ éƒ½ä¼šè¢«ç¼“å­˜åœ¨ CPU Cache ä¸­äº†ï¼Œå› æ­¤å½“ä¸‹æ¬¡è®¿é—®è¿™äº›æ•°ç»„å…ƒç´ æ—¶ï¼Œä¼šç›´æ¥ä» CPU Cache è¯»å–ï¼Œè€Œä¸ç”¨å†ä»å†…å­˜ä¸­è¯»å–ï¼Œå¤§å¤§æé«˜äº† CPU è¯»å–æ•°æ®çš„æ€§èƒ½ã€‚</p><p><strong>è¯»å–æµç¨‹</strong></p><p>å…ˆæ¥ä¸ªé—®é¢˜ï¼šCPU æ€ä¹ˆçŸ¥é“è¦è®¿é—®çš„å†…å­˜æ•°æ®ï¼Œæ˜¯å¦åœ¨ Cache é‡Œï¼Ÿå¦‚æœåœ¨çš„è¯ï¼Œå¦‚ä½•æ‰¾åˆ° Cache å¯¹åº”çš„æ•°æ®å‘¢ï¼Ÿ</p><p>ä¸ºäº†ç®€åŒ–å¯»å€æ–¹å¼ï¼Œå†…å­˜åœ°å€ç¡®å®šçš„æ•°æ®å—æ€»æ˜¯ä¼šè¢«æ”¾åœ¨ä¸€ä¸ªå›ºå®šçš„ç»„ï¼Œä½†å¯ä»¥æ”¾åœ¨ç»„å†…çš„ä»»æ„è·¯ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºä¸€ä¸ªç‰¹å®šåœ°å€æ•°æ®çš„è®¿é—®ï¼Œå®ƒå¦‚æœè¦è½½å…¥ç¼“å­˜ï¼Œé‚£ä¹ˆå®ƒæ”¾åœ¨ä¸Šå›¾ä¸­çš„è¡Œæ•°æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯å…·ä½“æ”¾åˆ°å“ªä¸€åˆ—æ˜¯ä¸å›ºå®šçš„ã€‚</p><p>æ ¹æ®ç¼“å­˜ä¸­ç»„æ•°å’Œè·¯æ•°çš„ä¸åŒï¼Œç¼“å­˜çš„æ˜ å°„æ–¹å¼åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul><li><p><strong>ç›´æ¥ç›¸è¿æ˜ å°„</strong>ï¼šç¼“å­˜åªæœ‰ä¸€ä¸ªè·¯ï¼Œä¸€ä¸ªå†…å­˜å—åªèƒ½æ”¾ç½®åœ¨ç‰¹å®šçš„ç»„ä¸Š</p><ul><li>é—®é¢˜ï¼šå¯¹äºç›´æ¥ç›¸è¿æ˜ å°„ï¼Œå½“å¤šä¸ªå†…å­˜å—æ˜ å°„åˆ°åŒä¸€ç»„æ—¶ï¼Œä¼šäº§ç”Ÿå†²çªï¼Œå› ä¸ºåªæœ‰ä¸€åˆ—ï¼Œä¼šå¯¼è‡´ç¼“å­˜å—è¢«é¢‘ç¹æ›¿æ¢ã€‚</li></ul></li><li><p><strong>å…¨ç›¸è¿æ˜ å°„</strong>ï¼šç¼“å­˜åªæœ‰ä¸€ä¸ªç»„ï¼Œæ‰€æœ‰çš„å†…å­˜å—éƒ½æ”¾åœ¨è¿™ä¸€ä¸ªç»„çš„ä¸åŒè·¯ä¸Š</p><ul><li>é—®é¢˜ï¼šå½“è¦æŸ¥è¯¢æŸä¸ªç¼“å­˜å—æ—¶ï¼Œéœ€è¦é€ä¸ªéå†æ¯ä¸ªè·¯ã€‚</li></ul></li><li><p><strong>ç»„ç»„ç›¸è¿æ˜ å°„</strong>ï¼šç¼“å­˜åŒæ—¶ç”±å¤šä¸ªç»„å’Œå¤šä¸ªè·¯ã€‚</p></li></ul><p>ä¸‹é¢ä»¥ç›´æ¥ç›¸è¿æ˜ å°„ä¸¾ä¾‹ï¼š</p><p>å¯¹äºç›´æ¥æ˜ å°„ Cache é‡‡ç”¨çš„ç­–ç•¥ï¼Œå°±æ˜¯æŠŠå†…å­˜å—çš„åœ°å€å§‹ç»ˆã€Œæ˜ å°„ã€åœ¨ä¸€ä¸ª CPU Lineï¼ˆç¼“å­˜å—ï¼‰ çš„åœ°å€ï¼Œè‡³äºæ˜ å°„å…³ç³»å®ç°æ–¹å¼ï¼Œåˆ™æ˜¯ä½¿ç”¨ã€Œå–æ¨¡è¿ç®—ã€ï¼Œå–æ¨¡è¿ç®—çš„ç»“æœå°±æ˜¯å†…å­˜å—åœ°å€å¯¹åº”çš„ CPU Lineï¼ˆç¼“å­˜å—ï¼‰ çš„åœ°å€ã€‚</p><p>è¡¥å……ï¼šæˆ‘ä»¬æåˆ° CPU è®¿é—®å†…å­˜æ•°æ®æ—¶ï¼Œæ˜¯ä¸€å°å—ä¸€å°å—æ•°æ®è¯»å–çš„ï¼Œå…·ä½“è¿™ä¸€å°å—æ•°æ®çš„å¤§å°ï¼Œå–å†³äº coherency_line_sizeçš„å€¼ï¼Œä¸€èˆ¬ 64 å­—èŠ‚ã€‚åœ¨å†…å­˜ä¸­ï¼Œè¿™ä¸€å—çš„æ•°æ®æˆ‘ä»¬ç§°ä¸º<strong>å†…å­˜å—ï¼ˆBockï¼‰</strong>ï¼Œè¯»å–çš„æ—¶å€™æˆ‘ä»¬è¦æ‹¿åˆ°æ•°æ®æ‰€åœ¨å†…å­˜å—çš„åœ°å€ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå†…å­˜å…±è¢«åˆ’åˆ†ä¸º 32 ä¸ªå†…å­˜å—ï¼ŒCPU Cache å…±æœ‰ 8 ä¸ª CPU Lineï¼Œå‡è®¾ CPU æƒ³è¦è®¿é—®ç¬¬ 15 å·å†…å­˜å—ï¼Œå¦‚æœ 15 å·å†…å­˜å—ä¸­çš„æ•°æ®å·²ç»ç¼“å­˜åœ¨ CPU Line ä¸­çš„è¯ï¼Œåˆ™æ˜¯ä¸€å®šæ˜ å°„åœ¨ 7 å· CPU Line ä¸­ï¼Œå› ä¸º 15 % 8çš„å€¼æ˜¯ 7ã€‚</p><p>æœºæ™ºçš„ä½ è‚¯å®šå‘ç°äº†ï¼Œä½¿ç”¨å–æ¨¡æ–¹å¼æ˜ å°„çš„è¯ï¼Œå°±ä¼šå‡ºç°å¤šä¸ªå†…å­˜å—å¯¹åº”åŒä¸€ä¸ª CPU Lineï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œé™¤äº† 15 å·å†…å­˜å—æ˜¯æ˜ å°„åœ¨ 7 å· CPU Line ä¸­ï¼Œè¿˜æœ‰ 7 å·ã€23 å·ã€31 å·å†…å­˜å—éƒ½æ˜¯æ˜ å°„åˆ° 7 å· CPU Line ä¸­ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423162615794.png" alt="image-20240423162615794"></p><p>å› æ­¤ï¼Œä¸ºäº†åŒºåˆ«ä¸åŒçš„å†…å­˜å—ï¼Œåœ¨å¯¹åº”çš„ CPU Line ä¸­æˆ‘ä»¬è¿˜ä¼šå­˜å‚¨ä¸€ä¸ª<strong>ç»„æ ‡è®°ï¼ˆTagï¼‰</strong>ã€‚è¿™ä¸ªç»„æ ‡è®°ä¼šè®°å½•å½“å‰ CPU Line ä¸­å­˜å‚¨çš„æ•°æ®å¯¹åº”çš„å†…å­˜å—ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªç»„æ ‡è®°æ¥åŒºåˆ†ä¸åŒçš„å†…å­˜å—ã€‚</p><p>é™¤äº†ç»„æ ‡è®°ä¿¡æ¯å¤–ï¼ŒCPU Line è¿˜æœ‰ä¸¤ä¸ªä¿¡æ¯ï¼š</p><ul><li>ä¸€ä¸ªæ˜¯ï¼Œä»å†…å­˜åŠ è½½è¿‡æ¥çš„å®é™…å­˜æ”¾<strong>æ•°æ®ï¼ˆDataï¼‰</strong>ã€‚</li><li>å¦ä¸€ä¸ªæ˜¯ï¼Œ<strong>æœ‰æ•ˆä½ï¼ˆValid bitï¼‰</strong>ï¼Œå®ƒæ˜¯ç”¨æ¥æ ‡è®°å¯¹åº”çš„ CPU Line ä¸­çš„æ•°æ®æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœæœ‰æ•ˆä½æ˜¯ 0ï¼Œæ— è®º CPU Line ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼ŒCPU éƒ½ä¼šç›´æ¥è®¿é—®å†…å­˜ï¼Œé‡æ–°åŠ è½½æ•°æ®ã€‚</li></ul><p>CPU åœ¨ä» CPU Cache è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯è¯»å– CPU Line ä¸­çš„æ•´ä¸ªæ•°æ®å—ï¼Œè€Œæ˜¯è¯»å– CPU æ‰€éœ€è¦çš„ä¸€ä¸ªæ•°æ®ç‰‡æ®µï¼Œè¿™æ ·çš„æ•°æ®ç»Ÿç§°ä¸ºä¸€ä¸ª<strong>å­—ï¼ˆWordï¼‰</strong>ã€‚é‚£æ€ä¹ˆåœ¨å¯¹åº”çš„ CPU Line ä¸­æ•°æ®å—ä¸­æ‰¾åˆ°æ‰€éœ€çš„å­—å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œéœ€è¦ä¸€ä¸ª<strong>åç§»é‡ï¼ˆOffsetï¼‰</strong>ã€‚</p><p>å› æ­¤ï¼Œä¸€ä¸ªå†…å­˜çš„è®¿é—®åœ°å€ï¼ŒåŒ…æ‹¬<strong>ç»„æ ‡è®°ã€CPU Line ç´¢å¼•ã€åç§»é‡</strong>è¿™ä¸‰ç§ä¿¡æ¯ï¼Œäºæ˜¯ CPU å°±èƒ½é€šè¿‡è¿™äº›ä¿¡æ¯ï¼Œåœ¨ CPU Cache ä¸­æ‰¾åˆ°ç¼“å­˜çš„æ•°æ®ã€‚è€Œå¯¹äº CPU Cache é‡Œçš„æ•°æ®ç»“æ„ï¼Œåˆ™æ˜¯ç”±<strong>ç´¢å¼• + æœ‰æ•ˆä½ + ç»„æ ‡è®° + æ•°æ®å—</strong>ç»„æˆã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423162643672.png" alt="image-20240423162643672"></p><p>å¦‚æœå†…å­˜ä¸­çš„æ•°æ®å·²ç»åœ¨ CPU Cahe ä¸­äº†ï¼Œé‚£ CPU è®¿é—®ä¸€ä¸ªå†…å­˜åœ°å€çš„æ—¶å€™ï¼Œä¼šç»å†è¿™ 4 ä¸ªæ­¥éª¤ï¼š</p><ol><li>æ ¹æ®å†…å­˜åœ°å€ä¸­ç´¢å¼•ä¿¡æ¯ï¼Œè®¡ç®—åœ¨ CPU Cahe ä¸­çš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯æ‰¾å‡ºå¯¹åº”çš„ CPU Line çš„åœ°å€ï¼›</li><li>æ‰¾åˆ°å¯¹åº” CPU Line åï¼Œåˆ¤æ–­ CPU Line ä¸­çš„æœ‰æ•ˆä½ï¼Œç¡®è®¤ CPU Line ä¸­æ•°æ®æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœæ˜¯æ— æ•ˆçš„ï¼ŒCPU å°±ä¼šç›´æ¥è®¿é—®å†…å­˜ï¼Œå¹¶é‡æ–°åŠ è½½æ•°æ®ï¼Œå¦‚æœæ•°æ®æœ‰æ•ˆï¼Œåˆ™å¾€ä¸‹æ‰§è¡Œï¼›</li><li>å¯¹æ¯”å†…å­˜åœ°å€ä¸­ç»„æ ‡è®°å’Œ CPU Line ä¸­çš„ç»„æ ‡è®°ï¼Œç¡®è®¤ CPU Line ä¸­çš„æ•°æ®æ˜¯ä¸æ˜¯æˆ‘ä»¬è¦è®¿é—®çš„å†…å­˜æ•°æ®ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼ŒCPU å°±ä¼šç›´æ¥è®¿é—®å†…å­˜ï¼Œå¹¶é‡æ–°åŠ è½½æ•°æ®ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™å¾€ä¸‹æ‰§è¡Œï¼›</li><li>æ ¹æ®å†…å­˜åœ°å€ä¸­åç§»é‡ä¿¡æ¯ï¼Œä» CPU Line çš„æ•°æ®å—ä¸­ï¼Œè¯»å–å¯¹åº”çš„å­—ã€‚</li></ol><p><strong>ç¨‹åºä¼˜åŒ–</strong></p><p>å¦‚æœä¸‹æ¬¡è®¿é—®å†…å­˜æ—¶ï¼Œæ•°æ®å·²ç»åœ¨ç¼“å­˜ä¸­äº†ï¼Œè¿™å°±æ˜¯ç¼“å­˜å‘½ä¸­ï¼Œå®ƒè·å–ç›®æ ‡æ•°æ®çš„é€Ÿåº¦éå¸¸å¿«ã€‚å¦‚æœæ•°æ®æ²¡åœ¨ç¼“å­˜ä¸­ï¼Œè¿™å°±æ˜¯ç¼“å­˜ç¼ºå¤±ï¼Œæ­¤æ—¶è¦å¯åŠ¨å†…å­˜æ•°æ®ä¼ è¾“ï¼Œè€Œå†…å­˜çš„è®¿é—®é€Ÿåº¦ç›¸æ¯”ç¼“å­˜å·®å¾ˆå¤šã€‚</p><p>ä¸‹é¢ï¼Œå°†ä¸¾å‡ºä¸€äº›å’Œç¼“å­˜ç›¸å…³çš„ä¾‹å­ï¼ŒåŠ æ·±åœ¨ç¨‹åºä¸Šé¢çš„åº”ç”¨ã€‚</p><blockquote><p>ä¾‹å­</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a[N][N];</span><br><span class="line"><span class="comment">// pro1:</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;=n;j++)&#123;</span><br><span class="line">a[i][j]++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// pro2:</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;=n;j++)&#123;</span><br><span class="line">a[j][i]++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œpro1çš„æ‰§è¡Œæ—¶é—´æ›´çŸ­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸å¸¸è¯´çš„ç¨‹åºå±€éƒ¨ä¸€è‡´æ€§åŸç†ã€‚</p><p>ä¸ºä»€ä¹ˆpr2çš„æ€§èƒ½ä¸å¤Ÿå¥½å‘¢ï¼Ÿ</p><p>åŸå› ï¼šä¸»è¦åŸå› æ˜¯å½“æŒ‰è¡Œè®¿é—®æ—¶åœ°å€æ˜¯è¿ç»­çš„ï¼Œä¸‹æ¬¡è®¿é—®çš„å…ƒç´ å’Œå½“å‰å¤§æ¦‚ç‡åœ¨åŒä¸€ä¸ª cache lineï¼ˆä¸€ä¸ªå…ƒç´  8 å­—èŠ‚ï¼Œè€Œä¸€ä¸ª cache line å¯ä»¥å®¹çº³ 8 ä¸ªå…ƒç´ ï¼‰ï¼Œä½†æ˜¯å½“æŒ‰åˆ—è®¿é—®æ—¶ï¼Œç”±äºåœ°å€è·¨åº¦å¤§ï¼Œä¸‹æ¬¡è®¿é—®çš„å…ƒç´ åŸºæœ¬ä¸å¯èƒ½è¿˜åœ¨åŒä¸€ä¸ª cache lineï¼Œå› æ­¤å°±ä¼šå¢åŠ  cache line è¢«æ›¿æ¢çš„æ¬¡æ•°ï¼Œæ‰€ä»¥æ€§èƒ½åŠ£åŒ–ã€‚</p><blockquote><p>ä¾‹å­2</p></blockquote><p>ä¼ªå…±äº«ï¼ˆfalse-sharingï¼‰çš„æ„æ€æ˜¯è¯´ï¼Œ<strong>å½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å„è‡ªä¿®æ”¹ä¸¤ä¸ªç›¸é‚»çš„å˜é‡ï¼Œç”±äºç¼“å­˜æ˜¯æŒ‰ç¼“å­˜å—æ¥ç»„ç»‡çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªç¼“å­˜å—æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå¿…é¡»ä½¿å…¶ä»–çº¿ç¨‹å«æœ‰å¯¹åº”æ•°æ®çš„ç¼“å­˜å—æ— æ•ˆã€‚è¿™æ ·ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šåŒæ—¶ä½¿å¯¹æ–¹çš„ç¼“å­˜å—æ— æ•ˆï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™</strong>ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">S</span>&#123;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> a;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> b;</span><br><span class="line">&#125; s;</span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">thread1</span><span class="params">(<span class="type">void</span> *args)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; <span class="number">100000000</span>; i++)&#123;</span><br><span class="line">        s.a++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">thread2</span><span class="params">(<span class="type">void</span> *args)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; <span class="number">100000000</span>; i++)&#123;</span><br><span class="line">        s.b++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1, t2;</span><br><span class="line">    s.a = <span class="number">0</span>;</span><br><span class="line">    s.b = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1, <span class="literal">NULL</span>, thread1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2, <span class="literal">NULL</span>, thread2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a = %lld, b = %lld\n&quot;</span>, s.a, s.b);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œmain å‡½æ•°ä¸­åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«ä¿®æ”¹ç»“æ„ä½“ S ä¸­çš„ a ã€b å˜é‡ã€‚a ã€b å‡ä¸º long long ç±»å‹ï¼Œéƒ½å  8 å­—èŠ‚ï¼Œæ‰€ä»¥ a ã€b åœ¨åŒä¸€ä¸ª cache line ä¸­ï¼Œå› æ­¤ä¼šå‘ç”Ÿä¸ºä¼ªå…±äº«çš„æƒ…å†µã€‚</p><p>æ ¹æ®ä¸Šè¿°çŸ¥è¯†ï¼ŒçŸ¥é“è§£å†³ä¼ªå…±äº«çš„åŠæ³•æ˜¯ï¼Œå°† a ã€b ä¸è¦æ”¾åœ¨åŒä¸€ä¸ª cache lineï¼Œè¿™æ ·ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«æ“ä½œä¸åŒçš„ cache line ä¸ä¼šç›¸äº’å½±å“ã€‚</p><p>å°†ç»“æ„ä½“ä¿®æ”¹æˆ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">S</span>&#123;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> a;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> nop_0;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> nop_1;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> nop_2;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> nop_3;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> nop_4;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> nop_5;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> nop_6;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> nop_7;</span><br><span class="line">   <span class="type">long</span> <span class="type">long</span> b;</span><br><span class="line">&#125; s;</span><br></pre></td></tr></table></figure><p>å› ä¸ºåœ¨ aã€b ä¸­é—´æ’å…¥äº† 8 ä¸ª long long ç±»å‹çš„å˜é‡ï¼Œä¸­é—´éš”äº† 64 å­—èŠ‚ï¼Œæ‰€ä»¥ aã€b ä¼šè¢«æ˜ å°„åˆ°ä¸åŒçš„ç¼“å­˜å—ã€‚</p><p>åˆ†åˆ«è¿è¡Œä¸Šè¿°çš„ç¨‹åºï¼Œå…·ä½“è¿è¡Œæ—¶é—´å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° ./main                        </span><br><span class="line">a = 100000000, b = 100000000</span><br><span class="line">520934.0000000000%</span><br><span class="line">penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° g++ example.c -o main -pthread</span><br><span class="line">penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° ./main                        </span><br><span class="line">a = 100000000, b = 100000000</span><br><span class="line">342973.0000000000%   </span><br></pre></td></tr></table></figure><h2 id="ç¼“å­˜ä¸€è‡´æ€§åè®®MESI">ç¼“å­˜ä¸€è‡´æ€§åè®®MESI</h2><blockquote><p>åŸºæœ¬æœ¯è¯­</p></blockquote><p><strong>ç¼“å­˜å’Œå†…å­˜çš„æ›´æ–°ç­–ç•¥</strong></p><ul><li><p>å†™å› ï¼ˆ Write Backï¼‰ï¼šå¯¹ç¼“å­˜çš„ä¿®æ”¹ä¸ä¼šç«‹åˆ»ä¼ æ’­åˆ°ä¸»å­˜ï¼Œåªæœ‰å½“ç¼“å­˜å—è¢«æ›¿æ¢æ—¶ï¼Œè¿™äº›è¢«ä¿®æ”¹çš„ç¼“å­˜å—ï¼Œæ‰ä¼šå†™å›å¹¶è¦†ç›–å†…å­˜ä¸­è¿‡æ—¶çš„æ•°æ®</p></li><li><p>å†™ç›´è¾¾ ï¼ˆWrite Throughï¼‰ï¼šç¼“å­˜ä¸­ä»»ä½•ä¸€ä¸ªå­—èŠ‚çš„ä¿®æ”¹ï¼Œéƒ½ä¼šç«‹åˆ»ä¼ æ’­åˆ°å†…å­˜</p></li></ul><p><strong>å†™ç¼“å­˜æ—¶ CPU ä¹‹é—´çš„æ›´æ–°ç­–ç•¥</strong></p><ul><li>å†™æ›´æ–°ï¼ˆWrite Updateï¼‰ï¼šå¦‚æœ CPU é‡‡å–å†™æ›´æ–°ç­–ç•¥ï¼Œæ¯æ¬¡å®ƒçš„ç¼“å­˜å†™å…¥æ–°çš„å€¼ï¼Œè¯¥ CPU éƒ½å¿…é¡»å‘èµ·ä¸€æ¬¡æ€»çº¿è¯·æ±‚ï¼Œé€šçŸ¥å…¶ä»– CPU å°†å®ƒä»¬çš„ç¼“å­˜å€¼æ›´æ–°ä¸ºåˆšå†™å…¥çš„å€¼ï¼Œæ‰€ä»¥å†™æ›´æ–°ä¼šå¾ˆå ç”¨æ€»çº¿å¸¦å®½ã€‚</li><li>å†™æ— æ•ˆï¼ˆWrite Invalidateï¼‰ï¼šå¦‚æœåœ¨ä¸€ä¸ª CPU ä¿®æ”¹ç¼“å­˜æ—¶ï¼Œå°†å…¶ä»– CPU ä¸­çš„ç¼“å­˜å…¨éƒ¨è®¾ç½®ä¸ºæ— æ•ˆ</li></ul><p><strong>ä»å†™ç¼“å­˜æ—¶æ•°æ®æ˜¯å¦è¢«åŠ è½½</strong></p><ul><li>å†™åˆ†é…ï¼ˆWrite Allocateï¼‰ï¼šåœ¨å†™å…¥æ•°æ®å‰å°†æ•°æ®è¯»å…¥ç¼“å­˜</li><li>å†™ä¸åˆ†é…ï¼ˆNot Write Allocateï¼‰ï¼šåœ¨å†™å…¥æ•°æ®æ—¶ï¼Œç›´æ¥å°†è¦å†™å…¥çš„æ•°æ®ä¼ æ’­å†…å­˜ï¼Œè€Œå¹¶ä¸å°†æ•°æ®å—è¯»å…¥ç¼“å­˜</li></ul><p>å¼€å§‹æ­£é¢˜ï¼š</p><p>Qï¼šä¸ºä»€ä¹ˆè¦è®¾è®¡è¿™ä¸ªåè®®å‘¢ï¼Ÿ</p><p>Aï¼šå› ä¸ºå½“å¤šæ ¸CPUå¯¹ç¼“å­˜æ•°æ®è¿›è¡Œè¯»å†™æ“ä½œçš„æ—¶å€™ï¼Œå¯¼è‡´ä¸ä¸€è‡´æ€§ã€‚å› æ­¤å¼•å…¥è¿™ä¸ªåè®®ä¿è¯ä¸è®©ç³»ç»Ÿæ•°æ®æ··ä¹±ã€‚</p><p>MESI æ˜¯æŒ‡4ä¸­çŠ¶æ€çš„é¦–å­—æ¯ã€‚æ¯ä¸ªCache lineæœ‰4ä¸ªçŠ¶æ€ï¼Œå¯ç”¨2ä¸ªbitè¡¨ç¤ºï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p><blockquote><p>ç¼“å­˜è¡Œï¼ˆCache lineï¼‰:ç¼“å­˜å­˜å‚¨æ•°æ®çš„å•å…ƒã€‚</p></blockquote><table><thead><tr><th>çŠ¶æ€</th><th>æè¿°</th><th>ç›‘å¬ä»»åŠ¡</th></tr></thead><tbody><tr><td>M ä¿®æ”¹ (Modified)</td><td>è¯¥Cache lineæœ‰æ•ˆï¼Œæ•°æ®è¢«ä¿®æ”¹äº†ï¼Œå’Œå†…å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ï¼Œæ•°æ®åªå­˜åœ¨äºæœ¬Cacheä¸­ã€‚</td><td>ç¼“å­˜è¡Œå¿…é¡»æ—¶åˆ»ç›‘å¬æ‰€æœ‰è¯•å›¾è¯»è¯¥ç¼“å­˜è¡Œç›¸å¯¹å°±ä¸»å­˜çš„æ“ä½œï¼Œè¿™ç§æ“ä½œå¿…é¡»åœ¨ç¼“å­˜å°†è¯¥ç¼“å­˜è¡Œå†™å›ä¸»å­˜å¹¶å°†çŠ¶æ€å˜æˆSï¼ˆå…±äº«ï¼‰çŠ¶æ€ä¹‹å‰è¢«å»¶è¿Ÿæ‰§è¡Œã€‚</td></tr><tr><td>E ç‹¬äº«ã€äº’æ–¥ (Exclusive)</td><td>è¯¥Cache lineæœ‰æ•ˆï¼Œæ•°æ®å’Œå†…å­˜ä¸­çš„æ•°æ®ä¸€è‡´ï¼Œæ•°æ®åªå­˜åœ¨äºæœ¬Cacheä¸­ã€‚</td><td>ç¼“å­˜è¡Œä¹Ÿå¿…é¡»ç›‘å¬å…¶å®ƒç¼“å­˜è¯»ä¸»å­˜ä¸­è¯¥ç¼“å­˜è¡Œçš„æ“ä½œï¼Œä¸€æ—¦æœ‰è¿™ç§æ“ä½œï¼Œè¯¥ç¼“å­˜è¡Œéœ€è¦å˜æˆSï¼ˆå…±äº«ï¼‰çŠ¶æ€ã€‚</td></tr><tr><td>S å…±äº« (Shared)</td><td>è¯¥Cache lineæœ‰æ•ˆï¼Œæ•°æ®å’Œå†…å­˜ä¸­çš„æ•°æ®ä¸€è‡´ï¼Œæ•°æ®å­˜åœ¨äºå¾ˆå¤šCacheä¸­ã€‚</td><td>ç¼“å­˜è¡Œä¹Ÿå¿…é¡»ç›‘å¬å…¶å®ƒç¼“å­˜ä½¿è¯¥ç¼“å­˜è¡Œæ— æ•ˆæˆ–è€…ç‹¬äº«è¯¥ç¼“å­˜è¡Œçš„è¯·æ±‚ï¼Œå¹¶å°†è¯¥ç¼“å­˜è¡Œå˜æˆæ— æ•ˆï¼ˆInvalidï¼‰ã€‚</td></tr><tr><td>I æ— æ•ˆ (Invalid)</td><td>è¯¥Cache lineæ— æ•ˆã€‚</td><td>æ— </td></tr></tbody></table><p><strong>MESIçŠ¶æ€è½¬æ¢</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423155851866.png" alt="image-20240423155851866"></p><p>è§¦å‘äº‹ä»¶ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423155500901.png" alt=""></p><p>å„ä¸ªçŠ¶æ€è½¬ç§»æƒ…å†µ</p><ul><li>MçŠ¶æ€</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423160109457.png" alt="image-20240423160109457"></p><ul><li>EçŠ¶æ€</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423160152951.png" alt="image-20240423160152951"></p><ul><li>SçŠ¶æ€</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423160251531.png" alt="image-20240423160251531"></p><ul><li>IçŠ¶æ€</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423160319450.png" alt="image-20240423160319450"></p><p><strong>æ€»ç»“</strong></p><p>MESIåè®®ï¼šå½“CPUå†™æ•°æ®(M)æ—¶ï¼Œå¦‚æœå‘ç°æ“ä½œçš„å˜é‡æ˜¯å…±äº«å˜é‡(s) ï¼Œä¼šå‘å‡ºä¿¡å·é€šçŸ¥å…¶ä»–CPUå°†è¯¥å˜é‡çš„ç¼“å­˜è¡Œç½®ä¸ºæ— æ•ˆçŠ¶æ€(1) ï¼Œå› æ­¤å½“å…¶ä»–CPUéœ€è¦è¯»å–è¿™ä¸ªå˜é‡æ—¶ï¼Œå‘ç°è‡ªå·±ç¼“å­˜ä¸­ç¼“å­˜è¯¥å˜é‡çš„ç¼“å­˜è¡Œæ˜¯æ— æ•ˆçš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä»å†…å­˜é‡æ–°è¯»å–ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚</p><h2 id="å†…å­˜æ¨¡å‹">å†…å­˜æ¨¡å‹</h2><p>åœ¨ä¸Šé¢çš„ç« èŠ‚æˆ‘ä»¬å­¦ä¹ åˆ°ï¼Œåœ¨ Share çŠ¶æ€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªæ ¸æƒ³ç‹¬å ç¼“å­˜è¿›è¡Œä¿®æ”¹ï¼Œå°±éœ€è¦å…ˆç»™æ‰€æœ‰ Share çŠ¶æ€çš„åŒä¼´å‘å‡º Invalid æ¶ˆæ¯ï¼Œç­‰æ‰€æœ‰åŒä¼´ç¡®è®¤å¹¶å›å¤å®ƒâ€œInvalid acknowledgementâ€ä»¥åï¼Œå®ƒæ‰èƒ½æŠŠè¿™å—ç¼“å­˜çš„çŠ¶æ€æ›´æ”¹ä¸º Modifiedï¼Œè¿™æ˜¯ä¿æŒå¤šæ ¸ä¿¡æ¯åŒæ­¥çš„å¿…ç„¶è¦æ±‚ã€‚ä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹æ˜¯å¾ˆè€—è´¹æ—¶é—´çš„ã€‚ã€ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªCPUæ¯æ¬¡çš„ä¿®æ”¹éƒ½è¦ç­‰å¾…å¦å¤–çš„CPUçš„ç¡®è®¤ä¿¡æ¯ï¼Œè¿™æ˜¯æ¯”è¾ƒè€—è´¹æ—¶é—´çš„ã€‘</p><p>é‚£å°±ç»§ç»­ä¼˜åŒ–ï¼ï¼ï¼</p><h3 id="å†™ç¼“å†²ä¸å†™å±éšœ">å†™ç¼“å†²ä¸å†™å±éšœ</h3><p>CPU çš„è®¾è®¡è€…ä¸ºæ¯ä¸ªæ ¸éƒ½æ·»åŠ äº†ä¸€ä¸ªåä¸º <strong>store buffer</strong> çš„ç»“æ„ï¼Œstore buffer æ˜¯ç¡¬ä»¶å®ç°çš„ç¼“å†²åŒºï¼Œå®ƒçš„è¯»å†™é€Ÿåº¦æ¯”ç¼“å­˜çš„é€Ÿåº¦æ›´å¿«ï¼Œæ‰€æœ‰é¢å‘ç¼“å­˜çš„å†™æ“ä½œéƒ½ä¼šå…ˆç»è¿‡ store bufferã€‚</p><p>å¢åŠ äº† store buffer ä»¥åçš„ CPU ç¼“å­˜ç»“æ„</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423164905953.png" alt=""></p><p>è¿™é‡Œï¼Œå¦‚æœ CPU çš„æŸä¸ªæ ¸å†è¦å¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œèµ‹å€¼ï¼Œå®ƒå°±ä¸å¿…ç­‰åˆ°æ‰€æœ‰çš„åŒä¼´éƒ½ç¡®è®¤å®Œï¼Œè€Œæ˜¯ç›´æ¥æŠŠæ–°çš„å€¼æ”¾å…¥ store bufferï¼Œç„¶åå†ç”± store buffer æ…¢æ…¢åœ°å»åšæ ¸é—´åŒæ­¥ï¼Œå¹¶ä¸”å°†æ–°çš„å€¼åˆ·å…¥åˆ° cache ä¸­å»å°±å¥½äº†ã€‚è€Œä¸”ï¼Œæ¯ä¸ªæ ¸çš„ store buffer éƒ½æ˜¯ç§æœ‰çš„ï¼Œå…¶ä»–æ ¸ä¸å¯è§ã€‚</p><p>ä½†æ˜¯æœ‰ä¸ªBugï¼šå°±æ˜¯<strong>å®ƒå¹¶ä¸èƒ½ä¿è¯å˜é‡å†™å…¥ç¼“å­˜å’Œä¸»å­˜çš„é¡ºåº</strong>ã€‚</p><p>æ¥ä¸ªçœ‹ç»å…¸çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CPU0</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    a = <span class="number">1</span>;</span><br><span class="line">    b = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// CPU1</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (b == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="built_in">assert</span>(a == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423170726938.png" alt="image-20240423170726938"></p><p>åœ¨è¿™ä¸ªä»£ç å—ä¸­ï¼ŒCPU0 æ‰§è¡Œ foo å‡½æ•°ï¼ŒCPU1 æ‰§è¡Œ bar å‡½æ•°ã€‚ä½†åœ¨å¯¹å˜é‡ a å’Œ b è¿›è¡Œèµ‹å€¼çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´å®ƒä»¬çš„èµ‹å€¼é¡ºåºè¢«æ‰“ä¹±ã€‚</p><p><strong>ç¬¬ä¸€ç§æƒ…å†µæ˜¯ CPU çš„ä¹±åºæ‰§è¡Œ</strong>ã€‚å¯èƒ½ä¼šbå…ˆæ‰§è¡Œï¼Œç„¶åå†æ‰§è¡Œaã€‚è¿™æ˜¯å› ä¸ºCPU ä¸ºäº†æå‡è¿è¡Œæ•ˆç‡å’Œæé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Œé‡‡ç”¨äº†ä¹±åºæ‰§è¡Œã€‚</p><p><strong>ç¬¬äºŒç§æƒ…å†µæ˜¯ store buffer åœ¨å†™å…¥æ—¶ï¼Œæœ‰å¯èƒ½ b æ‰€å¯¹åº”çš„ç¼“å­˜è¡Œä¼šå…ˆäº a æ‰€å¯¹åº”çš„ç¼“å­˜è¡Œè¿›å…¥ç‹¬å çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ b ä¼šå…ˆå†™å…¥ç¼“å­˜ã€‚</strong>ã€store bufferå°†å˜é‡æ”¾è¿›ç¼“å­˜çš„é¡ºåºä¸ä¸€è‡´ã€‘</p><p>ç®€å•æ¥è¯´å°±æ˜¯å› ä¸ºStore Bufferçš„å­˜åœ¨ï¼Œæœ€åç»“æœä¸ç¡®å®šã€‚</p><ol><li>açš„å€¼å¯èƒ½å› ä¸ºæ˜¯Shareï¼ˆå…±äº«ï¼‰å…ˆè¢«å†™å…¥äº†Store Bufferï¼Œå¹¶å‘é€é€šçŸ¥å…¶ä»–cpuç½®ä¸ºInvalid(å¤±æ•ˆ)ã€‚</li><li>bçš„å€¼ï¼Œå¯èƒ½å› ä¸ºåœ¨cacheä¸­å·²ç»å­˜åœ¨å¹¶ä¸”æ˜¯Exclusiveï¼ˆç‹¬å ï¼‰ç›´æ¥è¢«å†™è¿›cacheä¸­ã€‚</li><li>è¯»å–çš„æ—¶å€™å› ä¸ºå…ˆè¯»bçš„å€¼ï¼Œbè¢«åˆ·è¿›ä¸»å­˜ä¾›è¯»å–ã€‚</li><li>åé¢è¦è¯»aï¼Œå› ä¸ºè¿˜æ²¡æ”¶åˆ°å¤±æ•ˆé€šçŸ¥ï¼Œä»cacheä¸­ç›´æ¥æ‹¿åˆ°aï¼Œæ–­è¨€å¤±è´¥ã€‚</li></ol><p>ä¸ºæ­¤ï¼ŒCPU è®¾è®¡è€…å°±å¼•å…¥äº†<strong>å†…å­˜å±éšœï¼Œå±éšœçš„ä½œç”¨æ˜¯å‰è¾¹çš„è¯»å†™æ“ä½œæœªå®Œæˆçš„æƒ…å†µä¸‹ï¼Œåé¢çš„è¯»å†™æ“ä½œä¸èƒ½å‘ç”Ÿ</strong>ã€‚</p><p>æ¥çœ‹çœ‹åŠ äº†å†…å­˜å±éšœçš„ä»£ç </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CPU0</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    a = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">smp_mb</span>();</span><br><span class="line">    b = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// CPU1</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (b == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="built_in">assert</span>(a == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>smp_mb å°±ä»£è¡¨äº†å¤šæ ¸ä½“ç³»ç»“æ„ä¸Šçš„å†…å­˜å±éšœã€‚ç”±äºåœ¨ä¸åŒçš„ä½“ç³»ç»“æ„ä¸Šï¼ŒæŒ‡ä»¤å„ä¸ç›¸åŒï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå‡½æ•°å¯¹å®ƒè¿›è¡Œå°è£…ã€‚åŠ ä¸Šè¿™ä¸€é“å±éšœä»¥åï¼ŒCPU ä¼šä¿è¯ a å’Œ b çš„èµ‹å€¼æŒ‡ä»¤ä¸ä¼šä¹±åºæ‰§è¡Œï¼ŒåŒæ—¶å†™å…¥ cache çš„é¡ºåºä¹Ÿä¸ç¨‹åºä»£ç ä¿æŒä¸€è‡´ã€‚</p><p><strong>æ‰€ä»¥è¯´ï¼Œå†…å­˜å±éšœä¿è¯äº†ï¼Œå…¶ä»– CPU èƒ½è§‚å¯Ÿåˆ° CPU0 æŒ‰ç…§æˆ‘ä»¬æœŸæœ›çš„é¡ºåºæ›´æ–°å˜é‡</strong>ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œstore buffer çš„å­˜åœ¨æ˜¯ä¸ºæå‡å†™æ€§èƒ½ï¼Œæ”¾å¼ƒäº†ç¼“å­˜çš„é¡ºåºä¸€è‡´æ€§ï¼Œæˆ‘ä»¬æŠŠè¿™ç§ç°è±¡ç§°ä¸º<strong>å¼±ç¼“å­˜ä¸€è‡´æ€§</strong>ã€‚</p><h3 id="å¤±æ•ˆé˜Ÿåˆ—ä¸è¯»å±éšœ">å¤±æ•ˆé˜Ÿåˆ—ä¸è¯»å±éšœ</h3><p>ä¸Šè¿°è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨é—®é¢˜ï¼Œå½“ä¸€ä¸ª CPU å‘åŒä¼´å‘å‡º Invalid æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒçš„åŒä¼´è¦å…ˆæŠŠè‡ªå·±çš„ç¼“å­˜ç½®ä¸º Invalidï¼Œç„¶åå†å‘å‡º acknowledgementã€‚è¿™ä¸ªä»â€œæŠŠç¼“å­˜ç½®ä¸º Invalidâ€åˆ°â€œå‘å‡º acknowledgementâ€çš„è¿‡ç¨‹æ‰€éœ€è¦çš„æ—¶é—´ä¹Ÿæ˜¯æ¯”è¾ƒé•¿çš„ã€‚ç”±äº store buffer çš„å­˜åœ¨æå‡äº†å†™å…¥é€Ÿåº¦ï¼Œé‚£ä¹ˆ invalid æ¶ˆæ¯ç¡®è®¤é€Ÿåº¦ç›¸æ¯”èµ·æ¥å°±æ…¢äº†ï¼Œè¿™å°±å¸¦æ¥äº†é€Ÿåº¦çš„ä¸åŒ¹é…ã€‚å¾ˆå®¹æ˜“å¯¼è‡´ store buffer çš„å†…å®¹è¿˜æ²¡æœ‰åŠæ—¶æ›´æ–°åˆ° cache é‡Œï¼Œè‡ªå·±çš„å®¹é‡å°±è¢«æ’‘çˆ†äº†ï¼Œä»è€Œå¤±å»äº†åŠ é€Ÿçš„ä½œç”¨ã€‚</p><p>ä¸ºæ­¤ï¼Œå¼•å…¥äº†å¤±æ•ˆé˜Ÿåˆ—ï¼ˆinvalid queueï¼‰ã€‚</p><p>å¤±æ•ˆé˜Ÿåˆ—å·¥ä½œæµç¨‹ï¼šæ”¶åˆ° Invalid æ¶ˆæ¯çš„ CPUï¼Œæ¯”å¦‚æˆ‘ä»¬ç§°å®ƒä¸º CPU1ï¼Œåœ¨æ”¶åˆ° Invalid æ¶ˆæ¯æ—¶ç«‹å³å‘ CPU0 å‘å›ç¡®è®¤æ¶ˆæ¯ï¼Œä½†è¿™ä¸ªæ—¶å€™ CPU1 å¹¶æ²¡æœ‰æŠŠè‡ªå·±çš„ cache ç”± Share ç½®ä¸º Invalidï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªå¤±æ•ˆçš„æ¶ˆæ¯æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç­‰åˆ°ç©ºé—²çš„æ—¶å€™å†å»å¤„ç†å¤±æ•ˆæ¶ˆæ¯ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯ invalid queueã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240423172524418.png" alt="image-20240423172524418"></p><p>è¿è¡Œä¸Šé¢å¢åŠ å†…å­˜å±éšœçš„ä»£ç ï¼Œç¬¬ 11 è¡Œçš„æ–­è¨€åˆå¯èƒ½å¤±è´¥äº†ã€‚</p><p>æ ¸å¿ƒ0 ä¸­ a æ‰€å¯¹åº”çš„ç¼“å­˜è¡Œæ˜¯ <strong>S</strong> çŠ¶æ€ï¼Œb æ‰€å¯¹åº”çš„ç¼“å­˜è¡Œæ˜¯ <strong>E</strong> çŠ¶æ€ï¼›æ ¸å¿ƒ1ä¸­ a æ‰€å¯¹åº”çš„ç¼“å­˜è¡Œæ˜¯ <strong>S</strong> çŠ¶æ€ï¼Œb æ‰€å¯¹åº”çš„ç¼“å­˜è¡Œæ˜¯ <strong>I</strong> çŠ¶æ€ï¼›</p><ul><li>å› ä¸ºæœ‰å†…å­˜å±éšœåœ¨ï¼Œa å’Œ bçš„å†™å…¥ç¼“å­˜çš„é¡ºåºä¸ä¼šä¹±ã€‚</li><li>a å…ˆå‘å…¶ä»–æ ¸å¿ƒå‘é€ Invalid æ¶ˆæ¯ï¼Œå¹¶ä¸”ç­‰å¾… Invalid ç¡®è®¤æ¶ˆæ¯ï¼›</li><li>Invalid æ¶ˆæ¯å…ˆå…¥ æ ¸å¿ƒ1 å¯¹åº”çš„ Invalid Queue å¹¶ç«‹åˆ»è¿”å›ç¡®è®¤æ¶ˆæ¯ï¼Œç­‰å¾… æ ¸å¿ƒ1 å¤„ç†ï¼›</li><li>æ ¸å¿ƒ0 æ”¶åˆ°ç¡®è®¤æ¶ˆæ¯åæŠŠ a å†™å…¥ç¼“å­˜ï¼Œç»§ç»­å¤„ç† b çš„å†™å…¥ï¼Œç”±äº b æ˜¯ <strong>E</strong> çŠ¶æ€ï¼Œç›´æ¥å†™å…¥ç¼“å­˜ï¼›</li><li>æ ¸å¿ƒ1 å‘é€ BusRd æ¶ˆæ¯ï¼Œè¯»å–åˆ°æ–°çš„ b å€¼ï¼Œç„¶åè·å– aï¼ˆ<strong>S</strong> çŠ¶æ€ï¼‰å€¼æ˜¯0ï¼Œå› ä¸ºä½¿å…¶æ— æ•ˆçš„æ¶ˆæ¯è¿˜åœ¨ Invalid Queue ä¸­ï¼Œç¬¬ 11 è¡Œæ–­è¨€å¤±è´¥ã€‚</li></ul><p>å¼•å…¥ Invalid Queue åï¼Œå¯¹æ ¸å¿ƒ1 æ¥è¯´çœ‹åˆ°çš„ a å’Œ b çš„å†™å…¥åˆå‡ºç°ä¹±åºäº†ã€‚</p><p>è§£å†³åŠæ³•æ˜¯ç»§ç»­åŠ å†…å­˜å±éšœï¼Œæ ¸å¿ƒ1 æƒ³è¶Šè¿‡å±éšœå¿…é¡»æ¸…ç©º Invalid Queueï¼ŒåŠæ—¶å¤„ç†äº†å¯¹ a çš„æ— æ•ˆï¼Œç„¶åè¯»å–åˆ°æ–°çš„ a å€¼ï¼Œå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">0</span>, b = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// CPU0</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    a = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">smp_mb</span>();</span><br><span class="line">    b = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// CPU1</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (b == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="built_in">smp_mb</span>(); <span class="comment">//ç»§ç»­åŠ å†…å­˜å±éšœ</span></span><br><span class="line">    <span class="built_in">assert</span>(a == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨çš„å†…å­˜å±éšœæ˜¯<strong>å…¨å±éšœ</strong>ï¼ŒåŒ…æ‹¬è¯»å†™å±éšœï¼Œè¿‡äºä¸¥æ ¼äº†ï¼Œä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œæ‰€ä»¥æœ‰äº†ç»†ç²’åº¦çš„<strong>è¯»å±éšœ</strong>å’Œ<strong>å†™å±éšœ</strong>ã€‚</p><h3 id="è¯»å†™å±éšœåˆ†ç¦»">è¯»å†™å±éšœåˆ†ç¦»</h3><p>å®Œå…¨éµå®ˆMESIåè®®CPUæ€§èƒ½ä¸‹é™ï¼Œä½†æ˜¯å¢åŠ äº†è¿™ä¸¤ä¸ªé˜Ÿåˆ—å°±æ— æ³•ä¿è¯ä¸€è‡´æ€§ã€‚</p><p>åˆ†ç¦»çš„å†™å±éšœå’Œè¯»å±éšœçš„å‡ºç°ï¼Œæ˜¯ä¸ºäº†æ›´åŠ ç²¾ç»†åœ°æ§åˆ¶ Store Buffer å’Œ Invalid Queue çš„é¡ºåºã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´</p><ul><li>å†™å±éšœä¹‹å‰çš„å†™æ“ä½œä¸€å®šä¼šæ¯”ä¹‹åçš„å†™æ“ä½œå…ˆå†™åˆ°ç¼“å­˜ä¸­ã€‚</li><li>å±éšœå‰åçš„è¯»æ“ä½œéƒ½ä¸èƒ½ç¿»è¿‡å±éšœã€‚</li></ul><p>ã€store bufferå†™è¿›ç¼“å­˜é¡ºåºå†™ï¼Œå¤±æ•ˆé˜Ÿåˆ—æ¶ˆè´¹å®Œæˆäº†å†è¯»ã€‘</p><p>ä¼˜åŒ–å‰é¢çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">0</span>, b = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// CPU0</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    a = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">smp_wmb</span>(); <span class="comment">//å†™å±éšœ</span></span><br><span class="line">    b = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// CPU1</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (b == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="built_in">smp_rmb</span>(); <span class="comment">//è¯»å±éšœ</span></span><br><span class="line">    <span class="built_in">assert</span>(a == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œè¿™ç§ä¿®æ”¹åªæœ‰åœ¨åŒºåˆ†è¯»å†™å±éšœçš„ä½“ç³»ç»“æ„é‡Œæ‰ä¼šæœ‰ä½œç”¨ï¼Œæ¯”å¦‚ alpha ç»“æ„ã€‚è€Œåœ¨ X86 å’Œ Arm ä¸­æ˜¯æ²¡æœ‰ä½œç”¨çš„ï¼Œè¿™æ˜¯å› ä¸º X86 é‡‡ç”¨çš„ TSO æ¨¡å‹ä¸å­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œè€Œ Arm åˆ™æ˜¯é‡‡ç”¨äº†å¦ä¸€ç§ç§°ä¸ºå•å‘å±éšœçš„åˆ†ç±»æ–¹å¼ã€‚</p><h3 id="å•å‘å±éšœ">å•å‘å±éšœ</h3><p>å•å‘å±éšœ (<strong>half-way barrier</strong>) ä¹Ÿæ˜¯ä¸€ç§å†…å­˜å±éšœï¼Œä½†å®ƒä¸æ˜¯ä»¥è¯»å†™æ¥åŒºåˆ†çš„ï¼Œè€Œæ˜¯åƒå•è¡Œé“ä¸€æ ·ï¼Œåªå…è®¸å•å‘é€šè¡Œï¼Œä¾‹å¦‚ ARM ä¸­çš„ stlr å’Œ ldar æŒ‡ä»¤å°±æ˜¯è¿™æ ·ã€‚</p><ul><li><strong>stlr</strong> çš„å…¨ç§°æ˜¯ store release registerï¼ŒåŒ…æ‹¬ StoreStore barrier å’Œ LoadStore barrierï¼ˆåœºæ™¯å°‘ï¼‰ï¼Œé€šå¸¸ä½¿ç”¨ release è¯­ä¹‰å°†å¯„å­˜å™¨çš„å€¼å†™å…¥å†…å­˜ï¼›</li><li><strong>ldar</strong> çš„å…¨ç§°æ˜¯ load acquire registerï¼ŒåŒ…æ‹¬ LoadLoad barrier å’Œ LoadStore barrierï¼ˆå¯¹ï¼Œä½ æ²¡çœ‹é”™ï¼Œæˆ‘æ²¡å†™é”™ï¼‰ï¼Œé€šå¸¸ä½¿ç”¨ acquire è¯­ä¹‰ä»å†…å­˜ä¸­å°†å€¼åŠ è½½å…¥å¯„å­˜å™¨ï¼›</li><li><strong>release</strong> è¯­ä¹‰çš„å†…å­˜å±éšœåªä¸å…è®¸å…¶å‰é¢çš„è¯»å†™å‘åè¶Šè¿‡å±éšœï¼Œ<strong>æŒ¡å‰ä¸æŒ¡å</strong>ï¼›</li><li><strong>acquire</strong> è¯­ä¹‰çš„å†…å­˜å±éšœåªä¸å…è®¸å…¶åé¢çš„è¯»å†™å‘å‰è¶Šè¿‡å±éšœï¼Œ<strong>æŒ¡åä¸æŒ¡å‰;</strong></li><li>StoreLoad barrier å°±åªèƒ½ä½¿ç”¨ <strong>dmb</strong>ï¼ˆå…¨å±éšœï¼‰ ä»£æ›¿äº†ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://blog.csdn.net/rong_toa/article/details/109274448">CPU Cache Lineï¼šCPUç¼“å­˜è¡Œ/ç¼“å­˜å—</a></li><li><a href="https://www.bilibili.com/video/BV1fK4y1E7NC/?spm_id_from=333.337.search-card.all.click&amp;vd_source=d6efee335659a376be8deb6c0654e9f7">ç¼“å­˜ä¸€è‡´æ€§åè®®MESI</a></li><li><a href="https://zhuanlan.zhihu.com/p/467782159">å…¨çŸ¥ä¹æœ€è¯¦ç»†çš„å¹¶å‘ç ”ç©¶ä¹‹CPUç¼“å­˜ä¸€è‡´æ€§åè®®(MESI)æœ‰è¿™ä¸€ç¯‡å°±å¤Ÿäº†ï¼</a></li><li>[é‡‘é˜¶ä¹‹è·¯ï¼šå†…å­˜å±éšœï¼ˆMemory Barriersï¼‰](<a href="https://zhuanlan.zhihu.com/p/606658179">é‡‘é˜¶ä¹‹è·¯ï¼šå†…å­˜å±éšœï¼ˆMemory Barriersï¼‰ - çŸ¥ä¹ (zhihu.com)</a>)</li><li>ã€Šæå®¢æ—¶é—´ã€‹</li></ul>]]></content>
      
      
      <categories>
          
          <category> Cpp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cpp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLå®æˆ˜45è®²</title>
      <link href="/posts/cc27ac8a.html"/>
      <url>/posts/cc27ac8a.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æå®¢æ—¶é—´ã€ŠMySQLå®æˆ˜45è®²ã€‹å­¦ä¹ ç¬”è®°</p><h2 id="01-åŸºç¡€æ¶æ„ï¼š-ä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„"><strong>01 | åŸºç¡€æ¶æ„ï¼š</strong> <strong>ä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ ?</strong></h2><p>MySQLåŸºæœ¬æ¶æ„ç¤ºæ„å›¾ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421185512876.png" alt="image-20240421185512876"></p><p>MySQLå¯ä»¥åˆ†ä¸ºServerå±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¸¤éƒ¨åˆ†ã€‚</p><ul><li><p>Serverå±‚åŒ…æ‹¬è¿æ¥å™¨ã€æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰ï¼Œæ¶µç›–MySQLçš„å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œä»¥åŠæ‰€æœ‰çš„å†…ç½®å‡½æ•°ï¼ˆå¦‚æ—¥æœŸã€æ—¶é—´ã€æ•°å­¦å’ŒåŠ å¯†å‡½æ•°ç­‰ï¼‰ï¼Œæ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½éƒ½åœ¨è¿™ä¸€å±‚å®ç°ï¼Œæ¯”å¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚</p></li><li><p>å­˜å‚¨å¼•æ“å±‚è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œæå–ã€‚å…¶æ¶æ„æ¨¡å¼æ˜¯æ’ä»¶å¼çš„ï¼Œæ”¯æŒInnoDBã€MyISAMã€Memoryç­‰å¤šä¸ªå­˜å‚¨å¼•æ“ã€‚ç°åœ¨æœ€å¸¸ç”¨çš„å­˜å‚¨å¼•æ“æ˜¯InnoDBï¼Œå®ƒä»MySQL 5.5.5ç‰ˆæœ¬å¼€å§‹æˆä¸ºäº†é»˜è®¤å­˜å‚¨å¼•æ“ã€‚</p></li></ul><p><strong>è¿æ¥å™¨</strong></p><p>ç¬¬ä¸€æ­¥ï¼Œä¼šå…ˆè¿æ¥åˆ°è¿™ä¸ªæ•°æ®åº“ä¸Šï¼Œ è¿™æ—¶å€™æ¥å¾…ä½ çš„å°±æ˜¯è¿æ¥å™¨ã€‚ è¿æ¥å™¨è´Ÿè´£è·Ÿå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ã€ è·å–æƒé™ã€ ç»´æŒå’Œç®¡ç†è¿æ¥ã€‚</p><blockquote><p><strong>é•¿è¿æ¥</strong></p></blockquote><p>æ•°æ®åº“ä¸­<strong>é•¿è¿æ¥</strong>æ˜¯æŒ‡è¿æ¥æˆåŠŸåï¼Œå¦‚æœå®¢æˆ·ç«¯æŒç»­æœ‰è¯·æ±‚ï¼Œåˆ™ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ã€‚çŸ­è¿æ¥åˆ™æ˜¯æŒ‡æ¯æ¬¡æ‰§è¡Œå®Œå¾ˆå°‘çš„å‡ æ¬¡æŸ¥è¯¢å°±æ–­å¼€è¿æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†é‡æ–°å»ºç«‹ä¸€ä¸ªã€‚</p><p>é—®é¢˜ï¼šMySQLåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸´æ—¶ä½¿ç”¨çš„å†…å­˜æ˜¯ç®¡ç†åœ¨è¿æ¥å¯¹è±¡é‡Œé¢çš„ï¼Œå¯èƒ½å¯¼è‡´MySQLå ç”¨å†…å­˜æ¶¨å¾—ç‰¹åˆ«å¿«ã€‚è¿™äº›èµ„æºä¼šåœ¨è¿æ¥æ–­å¼€çš„æ—¶å€™æ‰é‡Šæ”¾ã€‚æ‰€ä»¥å¦‚æœé•¿è¿æ¥ç´¯ç§¯ä¸‹æ¥ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜å ç”¨å¤ªå¤§ï¼Œè¢«ç³»ç»Ÿå¼ºè¡Œæ€æ‰ï¼ˆOOMï¼‰ï¼Œä»ç°è±¡çœ‹å°±æ˜¯MySQLå¼‚å¸¸é‡å¯äº†ã€‚</p><p>è§£å†³æ–¹æ³•ï¼š</p><ol><li>å®šæœŸæ–­å¼€é•¿è¿æ¥ã€‚ä½¿ç”¨ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç¨‹åºé‡Œé¢åˆ¤æ–­æ‰§è¡Œè¿‡ä¸€ä¸ªå ç”¨å†…å­˜çš„å¤§æŸ¥è¯¢åï¼Œæ–­å¼€è¿æ¥ï¼Œä¹‹åè¦æŸ¥è¯¢å†é‡è¿ã€‚</li><li>MySQL 5.7åŠä»¥ä¸Šï¼Œå¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ“ä½œåï¼Œé€šè¿‡æ‰§è¡Œ mysql_reset_connectionæ¥é‡æ–°åˆå§‹åŒ–è¿æ¥èµ„æºã€‚è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦é‡è¿å’Œé‡æ–°åšæƒé™éªŒè¯ï¼Œä½†æ˜¯ä¼šå°†è¿æ¥æ¢å¤åˆ°åˆšåˆšåˆ›å»ºå®Œæ—¶çš„çŠ¶æ€ã€‚</li></ol><p><strong>æŸ¥è¯¢ç¼“å­˜</strong></p><p>MySQLæ‹¿åˆ°ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚åï¼Œ ä¼šå…ˆåˆ°æŸ¥è¯¢ç¼“å­˜çœ‹çœ‹ï¼Œ ä¹‹å‰æ˜¯ä¸æ˜¯æ‰§è¡Œè¿‡è¿™æ¡è¯­å¥ã€‚ ä¹‹å‰æ‰§è¡Œè¿‡çš„è¯­å¥åŠå…¶ç»“æœå¯èƒ½ä¼šä»¥key-valueå¯¹çš„å½¢å¼ï¼Œ è¢«ç›´æ¥ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚ keyæ˜¯æŸ¥è¯¢çš„è¯­å¥ï¼Œ valueæ˜¯æŸ¥è¯¢çš„ç»“æœã€‚ å¦‚æœä½ çš„æŸ¥è¯¢èƒ½å¤Ÿç›´æ¥åœ¨è¿™ä¸ªç¼“å­˜ä¸­æ‰¾åˆ°keyï¼Œ é‚£ä¹ˆè¿™ä¸ªvalueå°±ä¼šè¢«ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>æŸ¥è¯¢ç¼“å­˜å¾€å¾€å¼Šå¤§äºåˆ© ï¼Œå¤§å¤šæ•°æ—¶å€™å»ºè®®ä¸è¦ä½¿ç”¨ã€‚</p><p>åŸå› ï¼šæŸ¥è¯¢ç¼“å­˜çš„å¤±æ•ˆé¢‘ç¹ï¼Œåªè¦æœ‰å¯¹ä¸€ä¸ªè¡¨çš„æ›´æ–°ï¼Œè¿™ä¸ªè¡¨ä¸Šæ‰€æœ‰çš„æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šè¢«æ¸…ç©ºã€‚</p><p><strong>åˆ†æå™¨</strong></p><p>å¦‚æœæ²¡æœ‰å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œ å°±è¦å¼€å§‹çœŸæ­£æ‰§è¡Œè¯­å¥äº†ã€‚ åˆ†æå™¨å…ˆä¼šåšâ€œè¯æ³•åˆ†æâ€ã€‚ ä½ è¾“å…¥çš„æ˜¯ç”±å¤šä¸ªå­—ç¬¦ä¸²å’Œç©ºæ ¼ç»„æˆçš„ä¸€æ¡SQLè¯­å¥ï¼Œ MySQLéœ€è¦è¯†åˆ«å‡ºé‡Œé¢çš„å­—ç¬¦ä¸²åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œ ä»£è¡¨ä»€ä¹ˆ ã€‚åšå®Œäº†è¿™äº›è¯†åˆ«ä»¥åï¼Œ å°±è¦åšâ€œè¯­æ³•åˆ†æâ€ã€‚ æ ¹æ®è¯æ³•åˆ†æçš„ç»“æœï¼Œ è¯­æ³•åˆ†æå™¨ä¼šæ ¹æ®è¯­æ³•è§„åˆ™ï¼Œåˆ¤æ–­ä½ è¾“å…¥çš„è¿™ä¸ªSQLè¯­å¥æ˜¯å¦æ»¡è¶³MySQLè¯­æ³•ã€‚</p><p><strong>ä¼˜åŒ–å™¨</strong></p><p>åœ¨å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œ è¿˜è¦å…ˆç»è¿‡ä¼˜åŒ–å™¨çš„å¤„ç†ã€‚ä¼˜åŒ–å™¨æ˜¯åœ¨è¡¨é‡Œé¢æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œ å†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼› æˆ–è€…åœ¨ä¸€ä¸ªè¯­å¥æœ‰å¤šè¡¨å…³è”ï¼ˆjoinï¼‰çš„æ—¶å€™ï¼Œ å†³å®šå„ä¸ªè¡¨çš„è¿æ¥é¡ºåºã€‚</p><p><strong>æ‰§è¡Œå™¨</strong></p><p>å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œ è¦å…ˆåˆ¤æ–­ä¸€ä¸‹ä½ å¯¹è¿™ä¸ªè¡¨Tæœ‰æ²¡æœ‰æ‰§è¡ŒæŸ¥è¯¢çš„æƒé™ ã€‚å¦‚æœæœ‰æƒé™ï¼Œ å°±æ‰“å¼€è¡¨ç»§ç»­æ‰§è¡Œã€‚ æ‰“å¼€è¡¨çš„æ—¶å€™ï¼Œ æ‰§è¡Œå™¨å°±ä¼šæ ¹æ®è¡¨çš„å¼•æ“å®šä¹‰ï¼Œ å»ä½¿ç”¨è¿™ä¸ªå¼•æ“æä¾›çš„æ¥å£ã€‚</p><h2 id="02-æ—¥å¿—ç³»ç»Ÿï¼š-ä¸€æ¡SQLæ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ"><strong>02 | æ—¥å¿—ç³»ç»Ÿï¼š</strong> <strong>ä¸€æ¡SQLæ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ</strong></h2><p>ä¸æŸ¥è¯¢æµç¨‹ä¸ä¸€æ ·çš„æ˜¯ï¼Œ æ›´æ–°æµç¨‹è¿˜æ¶‰åŠä¸¤ä¸ªé‡è¦çš„æ—¥å¿—æ¨¡å—ï¼š redo logï¼ˆé‡åšæ—¥å¿—ï¼‰ å’Œ binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰ã€‚ å½“æœ‰ä¸€æ¡è®°å½•éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼Œ InnoDBå¼•æ“å°±ä¼šå…ˆæŠŠè®°å½•å†™åˆ°redo logé‡Œé¢ï¼Œ å¹¶æ›´æ–°å†…å­˜ï¼Œ è¿™ä¸ªæ—¶å€™æ›´æ–°å°±ç®—å®Œæˆäº†ã€‚ç„¶åServerå±‚æ›´æ–°binlog,åˆ·åˆ°ç£ç›˜ã€‚ åŒæ—¶ï¼Œ InnoDBå¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼Œ å°†è¿™ä¸ªæ“ä½œè®°å½•æ›´æ–°åˆ°ç£ç›˜é‡Œé¢ã€‚</p><p><strong>Redo log</strong></p><p>æ–‡ä¸­ä¸¾äº†ã€Šå­”ä¹™å·±ã€‹ç²‰æ¿å’Œè´¦æœ¬é…åˆçš„æ•…äº‹ï¼Œå³å¯¹åº”MySQLä¸­çš„WALæŠ€æœ¯ï¼ŒWALçš„å…¨ç§°æ˜¯Write-Ahead Loggingï¼Œå®ƒçš„å…³é”®ç‚¹å°±æ˜¯å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå½“æœ‰ä¸€æ¡è®°å½•éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼ŒInnoDBå¼•æ“å°±ä¼šå…ˆæŠŠè®°å½•å†™åˆ°redo logï¼ˆç²‰æ¿ï¼‰é‡Œé¢ï¼Œå¹¶æ›´æ–°å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™æ›´æ–°å°±ç®—å®Œæˆäº†ã€‚åŒæ—¶ï¼ŒInnoDBå¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼Œå°†è¿™ä¸ªæ“ä½œè®°å½•æ›´æ–°åˆ°ç£ç›˜é‡Œé¢ï¼Œè€Œè¿™ä¸ªæ›´æ–°å¾€å¾€æ˜¯åœ¨ç³»ç»Ÿæ¯”è¾ƒç©ºé—²çš„æ—¶å€™åšï¼Œè¿™å°±åƒæ‰“çƒŠä»¥åæŒæŸœåšçš„äº‹ã€‚</p><p>è¿™é‡Œæ¥ä»‹ç»ä¸‹redo logï¼š</p><p>InnoDBçš„redo logæ˜¯å›ºå®šå¤§å°çš„ï¼Œ æ¯”å¦‚å¯ä»¥é…ç½®ä¸ºä¸€ç»„4ä¸ªæ–‡ä»¶ï¼Œ æ¯ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯1GBï¼Œ é‚£ä¹ˆè¿™å—â€œç²‰æ¿â€æ€»å…±å°±å¯ä»¥è®°å½•4GBçš„æ“ä½œã€‚ ä»å¤´å¼€å§‹å†™ï¼Œ å†™åˆ°æœ«å°¾å°±åˆå›åˆ°å¼€å¤´å¾ªç¯å†™ï¼Œ å¦‚ä¸‹é¢è¿™ä¸ªå›¾æ‰€ç¤ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421190252047.png" alt="image-20240421190252047"></p><p>write posæ˜¯å½“å‰è®°å½•çš„ä½ç½®ï¼Œ ä¸€è¾¹å†™ä¸€è¾¹åç§»ï¼Œ å†™åˆ°ç¬¬3å·æ–‡ä»¶æœ«å°¾åå°±å›åˆ°0å·æ–‡ä»¶å¼€å¤´ã€‚checkpointæ˜¯å½“å‰è¦æ“¦é™¤çš„ä½ç½®ï¼Œ ä¹Ÿæ˜¯å¾€åæ¨ç§»å¹¶ä¸”å¾ªç¯çš„ï¼Œ æ“¦é™¤è®°å½•å‰è¦æŠŠè®°å½•æ›´æ–°åˆ°æ•°æ®æ–‡ä»¶ã€‚write poså’Œcheckpointä¹‹é—´çš„æ˜¯â€œç²‰æ¿â€ä¸Šè¿˜ç©ºç€çš„éƒ¨åˆ†ï¼Œ å¯ä»¥ç”¨æ¥è®°å½•æ–°çš„æ“ä½œã€‚ å¦‚æœwrite posè¿½ä¸Šcheckpointï¼Œ è¡¨ç¤ºâ€œç²‰æ¿â€æ»¡äº†ï¼Œ è¿™æ—¶å€™ä¸èƒ½å†æ‰§è¡Œæ–°çš„æ›´æ–°ï¼Œ å¾—åœä¸‹æ¥å…ˆæ“¦æ‰ä¸€äº›è®°å½•ï¼Œ æŠŠcheckpointæ¨è¿›ä¸€ä¸‹ã€‚</p><blockquote><p><strong>è¡¥å……</strong></p></blockquote><p>redo logå…¶å®æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼Œä¸€éƒ¨åˆ†æ˜¯é‡åšæ—¥å¿—ç¼“å†²ï¼ˆredo log bufferï¼‰ï¼Œè¿™éƒ¨åˆ†æ˜¯ç¡®å®å­˜åœ¨äºå†…å­˜ä¸­çš„ï¼›è€Œå¦ä¸€éƒ¨åˆ†åˆ™æ˜¯é‡åšæ—¥å¿—æ–‡ä»¶ï¼ˆredo log fileï¼‰ï¼Œè¿™éƒ¨åˆ†æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸­çš„ã€‚å½“äº‹åŠ¡æäº¤åï¼Œæ‰€æœ‰ä¿®æ”¹çš„ä¿¡æ¯ä¼šå…ˆå­˜åˆ°å†…å­˜ä¸­çš„é‡åšæ—¥å¿—ç¼“å†²ï¼Œç„¶åå†è¢«å†™å…¥åˆ°ç£ç›˜çš„é‡åšæ—¥å¿—æ–‡ä»¶ä¸­ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸èƒ½ç®€å•åœ°è¯´redo logæ˜¯åœ¨å†…å­˜è¿˜æ˜¯åœ¨ç£ç›˜ï¼Œå®ƒå…¶å®æ˜¯åŒæ—¶åœ¨å†…å­˜å’Œç£ç›˜ä¸­éƒ½æœ‰å­˜åœ¨çš„éƒ¨åˆ†</p><p><strong>Binlog</strong></p><p>å¦å¤–ä¸€ä¸ªæ—¥å¿—å°±æ˜¯Binlogå•¦ï¼Œå…ˆçœ‹çœ‹å’Œredo logæœ‰å•¥å·®å¼‚ã€‚</p><p><strong>æ€è€ƒ</strong>ï¼šä¸ºå•¥è¦æœ‰è¿™ä¸ªbinlogæ—¥å¿—å‘¢ï¼Œæˆ‘è®¤ä¸ºæ˜¯ç”¨äºå¤‡ä»½ç”¨çš„ï¼Œå³ä¸»ä»å¤‡ä»½ï¼Œåˆ†å¸ƒå¼rafté‚£ä¸€å¥—ã€‚è€Œredo logæ˜¯ç”¨äºä¼˜åŒ–æ•ˆç‡ç”¨çš„ã€‚</p><p>æœ‰ä»¥ä¸‹ä¸‰ç‚¹ä¸åŒ</p><ol><li><p>redo logæ˜¯InnoDBå¼•æ“ç‰¹æœ‰çš„ï¼› binlogæ˜¯MySQLçš„Serverå±‚å®ç°çš„ï¼Œ æ‰€æœ‰å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ã€‚</p></li><li><p>redo logæ˜¯ç‰©ç†æ—¥å¿—ï¼Œ è®°å½•çš„æ˜¯â€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€ï¼› binlogæ˜¯é€»è¾‘æ—¥å¿—ï¼Œ è®°å½•çš„æ˜¯è¿™ä¸ªè¯­å¥çš„åŸå§‹é€»è¾‘ï¼Œ æ¯”å¦‚â€œç»™ID=2è¿™ä¸€è¡Œçš„cå­—æ®µåŠ 1 â€ã€‚</p></li><li><p>redo logæ˜¯å¾ªç¯å†™çš„ï¼Œ ç©ºé—´å›ºå®šä¼šç”¨å®Œï¼› binlogæ˜¯å¯ä»¥è¿½åŠ å†™å…¥çš„ã€‚ â€œè¿½åŠ å†™â€æ˜¯æŒ‡binlogæ–‡ä»¶å†™åˆ°ä¸€å®šå¤§å°åä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªï¼Œ å¹¶ä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—ã€‚</p></li></ol><p>æ¥ä¸‹æ¥ï¼Œçœ‹çœ‹ä¸‹é¢è¿™æ¡update SQLçš„æ‰§è¡Œæµç¨‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> T <span class="keyword">set</span> c<span class="operator">=</span>c<span class="operator">+</span><span class="number">1</span> <span class="keyword">where</span> ID<span class="operator">=</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæµç¨‹å›¾</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421191135808.png" alt="image-20240421191135808"></p><p>è§£é‡Šï¼š</p><ol><li>æ‰§è¡Œå™¨å…ˆæ‰¾å¼•æ“å–ID=2è¿™ä¸€è¡Œã€‚IDæ˜¯ä¸»é”®ï¼Œå¼•æ“ç›´æ¥ç”¨æ ‘æœç´¢æ‰¾åˆ°è¿™ä¸€è¡Œã€‚å¦‚æœID=2è¿™ä¸€è¡Œæ‰€åœ¨çš„æ•°æ®é¡µæœ¬æ¥å°±åœ¨å†…å­˜ä¸­ï¼Œå°±ç›´æ¥è¿”å›ç»™æ‰§è¡Œå™¨ï¼›å¦åˆ™ï¼Œéœ€è¦å…ˆä»ç£ç›˜è¯»å…¥å†…å­˜ï¼Œç„¶åå†è¿”å›ã€‚</li><li>æ‰§è¡Œå™¨æ‹¿åˆ°å¼•æ“ç»™çš„è¡Œæ•°æ®ï¼ŒæŠŠè¿™ä¸ªå€¼åŠ ä¸Š1ï¼Œæ¯”å¦‚åŸæ¥æ˜¯Nï¼Œç°åœ¨å°±æ˜¯N+1ï¼Œå¾—åˆ°æ–°çš„ä¸€è¡Œæ•°æ®ï¼Œå†è°ƒç”¨å¼•æ“æ¥å£å†™å…¥è¿™è¡Œæ–°æ•°æ®ã€‚</li><li>å¼•æ“å°†è¿™è¡Œæ–°æ•°æ®æ›´æ–°åˆ°å†…å­˜ä¸­ï¼ŒåŒæ—¶å°†è¿™ä¸ªæ›´æ–°æ“ä½œè®°å½•åˆ°redo logé‡Œé¢ï¼Œæ­¤æ—¶redo logå¤„äºprepareçŠ¶æ€ã€‚ç„¶åå‘ŠçŸ¥æ‰§è¡Œå™¨æ‰§è¡Œå®Œæˆäº†ï¼Œéšæ—¶å¯ä»¥æäº¤äº‹åŠ¡ã€‚</li><li>æ‰§è¡Œå™¨ç”Ÿæˆè¿™ä¸ªæ“ä½œçš„binlogï¼Œå¹¶æŠŠbinlogå†™å…¥ç£ç›˜ã€‚</li><li>æ‰§è¡Œå™¨è°ƒç”¨å¼•æ“çš„æäº¤äº‹åŠ¡æ¥å£ï¼Œå¼•æ“æŠŠåˆšåˆšå†™å…¥çš„redo logæ”¹æˆæäº¤ï¼ˆcommitï¼‰çŠ¶æ€ï¼Œæ›´æ–°å®Œæˆã€‚</li></ol><p><strong>ä¸¤é˜¶æ®µæäº¤</strong></p><p>è¿™ä¸ªä¸¤é˜¶æ®µæäº¤åœ¨åˆ†å¸ƒå¼ä¹Ÿæä¸ºå¸¸è§çš„æ¦‚å¿µï¼Œ2é˜¶æ®µæäº¤çš„<strong>2é˜¶æ®µ</strong>åˆ†åˆ«æ˜¯<strong>æäº¤è¯·æ±‚é˜¶æ®µ</strong>å’Œ<strong>æäº¤æ‰§è¡Œé˜¶æ®µ</strong>ã€‚</p><p><strong>æ€æ ·è®©æ•°æ®åº“æ¢å¤åˆ°åŠä¸ªæœˆå†…ä»»æ„ä¸€ç§’çš„çŠ¶æ€ï¼Ÿ</strong></p><ul><li>é¦–å…ˆï¼Œæ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œä»è¿™ä¸ªå¤‡ä»½æ¢å¤åˆ°ä¸´æ—¶åº“ã€‚</li><li>ç„¶åï¼Œä»å¤‡ä»½çš„æ—¶é—´ç‚¹å¼€å§‹ï¼Œå°†å¤‡ä»½çš„binlogä¾æ¬¡å–å‡ºæ¥ï¼Œé‡æ”¾åˆ°è¯¯åˆ è¡¨ä¹‹å‰çš„é‚£ä¸ªæ—¶åˆ»ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆéœ€è¦2é˜¶æ®µæäº¤å‘¢ï¼Ÿ</strong></p><p>è¿™é‡Œé€šè¿‡åè¯æ˜æ³•è¯´æ˜ã€‚</p><p>ç”±äºredo logå’Œbinlogæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„é€»è¾‘ï¼Œ å¦‚æœä¸ç”¨ä¸¤é˜¶æ®µæäº¤ï¼Œ è¦ä¹ˆå°±æ˜¯å…ˆå†™å®Œredo logå†å†™binlogï¼Œ æˆ–è€…é‡‡ç”¨åè¿‡æ¥çš„é¡ºåºã€‚ä»ç„¶ç”¨å‰é¢çš„updateè¯­å¥æ¥åšä¾‹å­ã€‚ å‡è®¾å½“å‰ID=2çš„è¡Œï¼Œ å­—æ®µcçš„å€¼æ˜¯0ï¼Œ å†å‡è®¾æ‰§è¡Œupdateè¯­å¥è¿‡ç¨‹ä¸­åœ¨å†™å®Œç¬¬ä¸€ä¸ªæ—¥å¿—åï¼Œ ç¬¬äºŒä¸ªæ—¥å¿—è¿˜æ²¡æœ‰å†™å®ŒæœŸé—´å‘ç”Ÿäº†crashï¼Œ ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p><p><strong>å…ˆå†™redo logåå†™binlogã€‚</strong> å‡è®¾åœ¨redo logå†™å®Œï¼Œ binlogè¿˜æ²¡æœ‰å†™å®Œçš„æ—¶å€™ï¼Œ MySQLè¿›ç¨‹å¼‚å¸¸é‡å¯ã€‚ ç”±redo logå†™å®Œä¹‹åï¼Œ ç³»ç»Ÿå³ä½¿å´©æºƒï¼Œ ä»ç„¶èƒ½å¤ŸæŠŠæ•°æ®æ¢å¤å›æ¥ï¼Œ æ‰€ä»¥æ¢å¤åè¿™ä¸€è¡Œcçš„å€¼æ˜¯1ã€‚ä½†æ˜¯ç”±äºbinlogæ²¡å†™å®Œå°±crashäº†ï¼Œ è¿™æ—¶å€™binlogé‡Œé¢å°±æ²¡æœ‰è®°å½•è¿™ä¸ªè¯­å¥ã€‚ å› æ­¤ï¼Œ ä¹‹åå¤‡ä»½æ—¥å¿—çš„æ—¶å€™ï¼Œ å­˜èµ·æ¥çš„binlogé‡Œé¢å°±æ²¡æœ‰è¿™æ¡è¯­å¥ã€‚å¦‚æœéœ€è¦ç”¨è¿™ä¸ªbinlogæ¥æ¢å¤ä¸´æ—¶åº“çš„è¯ï¼Œæ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œcçš„å€¼å°±æ˜¯0ï¼Œ ä¸åŸåº“çš„å€¼ä¸åŒã€‚</p><p><strong>å…ˆå†™binlogåå†™redo logã€‚</strong> å¦‚æœåœ¨binlogå†™å®Œä¹‹åcrashï¼Œ ç”±äºredo logè¿˜æ²¡å†™ï¼Œ å´©æºƒæ¢å¤ä»¥åè¿™ä¸ªäº‹åŠ¡æ— æ•ˆï¼Œ æ‰€ä»¥è¿™ä¸€è¡Œcçš„å€¼æ˜¯0ã€‚ ä½†æ˜¯binlogé‡Œé¢å·²ç»è®°å½•äº†â€œæŠŠcä»0æ”¹æˆ1â€è¿™ä¸ªæ—¥å¿—ã€‚ æ‰€ä»¥ï¼Œ åœ¨ä¹‹åç”¨binlogæ¥æ¢å¤çš„æ—¶å€™å°±å¤šäº†ä¸€ä¸ªäº‹åŠ¡å‡ºæ¥ï¼Œ æ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œcçš„å€¼å°±æ˜¯1ï¼Œ ä¸åŸåº“çš„å€¼ä¸åŒã€‚</p><p>ç®€å•è¯´ï¼Œ redo logå’Œbinlogéƒ½å¯ä»¥ç”¨äºè¡¨ç¤ºäº‹åŠ¡çš„æäº¤çŠ¶æ€ï¼Œ è€Œä¸¤é˜¶æ®µæäº¤å°±æ˜¯è®©è¿™ä¸¤ä¸ªçŠ¶æ€ä¿æŒé€»è¾‘ä¸Šçš„ä¸€è‡´ã€‚</p><h2 id="03-äº‹åŠ¡éš”ç¦»ï¼š-ä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§ï¼Ÿ"><strong>03 | äº‹åŠ¡éš”ç¦»ï¼š</strong> <strong>ä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§ï¼Ÿ</strong></h2><p>ç®€å•æ¥è¯´ï¼Œ äº‹åŠ¡å°±æ˜¯è¦ä¿è¯ä¸€ç»„æ•°æ®åº“æ“ä½œï¼Œ è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œ è¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚ åœ¨MySQLä¸­ï¼Œ <strong>äº‹åŠ¡æ”¯æŒæ˜¯åœ¨å¼•æ“å±‚å®ç°çš„</strong>ã€‚ ä½ ç°åœ¨çŸ¥é“ï¼Œ MySQLæ˜¯ä¸€ä¸ªæ”¯æŒå¤šå¼•æ“çš„ç³»ç»Ÿï¼Œ ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„å¼•æ“éƒ½æ”¯æŒäº‹åŠ¡ã€‚ æ¯”å¦‚MySQLåŸç”Ÿçš„MyISAMå¼•æ“å°±ä¸æ”¯æŒäº‹åŠ¡ï¼Œ è¿™ä¹Ÿæ˜¯MyISAMè¢«InnoDBå–ä»£çš„é‡è¦åŸå› ä¹‹ä¸€ã€‚</p><p><strong>éš”ç¦»æ€§ä¸éš”ç¦»çº§åˆ«</strong></p><p>æåˆ°äº‹åŠ¡ï¼Œè„‘æµ·é‡Œè‚¯å®šæœ‰ACIDï¼ˆAtomicityã€Consistencyã€Isolationã€Durabilityï¼Œå³åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ï¼‰ã€‚è¿™é‡Œé‡ç‚¹è¯´éš”ç¦»æ€§ã€‚</p><p>å½“æ•°æ®åº“ä¸Šæœ‰å¤šä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œçš„æ—¶å€™ï¼Œ å°±å¯èƒ½å‡ºç°è„è¯»ï¼ˆdirtyreadï¼‰ ã€ ä¸å¯é‡å¤è¯»ï¼ˆnon repeatable readï¼‰ ã€ å¹»è¯»ï¼ˆ phantom readï¼‰ çš„é—®é¢˜ï¼Œ ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œ å°±æœ‰äº†â€œéš”ç¦»çº§åˆ«â€çš„æ¦‚å¿µã€‚SQLæ ‡å‡†çš„äº‹åŠ¡éš”ç¦»çº§åˆ«åŒ…æ‹¬ï¼š è¯»æœªæäº¤ï¼ˆ read uncommittedï¼‰ ã€è¯»æäº¤ï¼ˆread committedï¼‰ ã€ å¯é‡å¤è¯»ï¼ˆ repeatable readï¼‰ å’Œä¸²è¡ŒåŒ–ï¼ˆ serializable ï¼‰ ã€‚</p><ul><li>è¯»æœªæäº¤æ˜¯æŒ‡ï¼Œ ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œ å®ƒåšçš„å˜æ›´å°±èƒ½è¢«åˆ«çš„äº‹åŠ¡çœ‹åˆ°ã€‚</li><li>è¯»æäº¤æ˜¯æŒ‡ï¼Œ ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œ å®ƒåšçš„å˜æ›´æ‰ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚<br>å¯é‡å¤è¯»æ˜¯æŒ‡ï¼Œ ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œ æ€»æ˜¯è·Ÿè¿™ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚ å½“ç„¶åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œ æœªæäº¤å˜æ›´å¯¹å…¶ä»–äº‹åŠ¡ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚</li><li>ä¸²è¡ŒåŒ–ï¼Œ é¡¾åæ€ä¹‰æ˜¯å¯¹äºåŒä¸€è¡Œè®°å½•ï¼Œ â€œå†™â€ä¼šåŠ â€œå†™é”â€ï¼Œ â€œè¯»â€ä¼šåŠ â€œè¯»é”â€ã€‚ å½“å‡ºç°è¯»å†™é”å†²çªçš„æ—¶å€™ï¼Œ åè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œ æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</li></ul><p>å‡è®¾æ•°æ®è¡¨Tä¸­åªæœ‰ä¸€åˆ—ï¼Œ å…¶ä¸­ä¸€è¡Œçš„å€¼ä¸º1ï¼Œ ä¸‹é¢æ˜¯æŒ‰ç…§æ—¶é—´é¡ºåºæ‰§è¡Œä¸¤ä¸ªäº‹åŠ¡çš„è¡Œä¸ºã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> T(c <span class="type">int</span>) engine<span class="operator">=</span>InnoDB;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> T(c) <span class="keyword">values</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421191725626.png" alt="image-20240421191725626"></p><ul><li>è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œè¯»æœªæäº¤â€ï¼Œ åˆ™V1çš„å€¼å°±æ˜¯2ã€‚ è¿™æ—¶å€™äº‹åŠ¡Bè™½ç„¶è¿˜æ²¡æœ‰æäº¤ï¼Œ ä½†æ˜¯ç»“æœå·²ç»è¢«Açœ‹åˆ°äº†ã€‚ å› æ­¤ï¼Œ V2ã€ V3ä¹Ÿéƒ½æ˜¯2ã€‚</li><li>è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œè¯»æäº¤â€ï¼Œ åˆ™V1æ˜¯1ï¼Œ V2çš„å€¼æ˜¯2ã€‚ äº‹åŠ¡Bçš„æ›´æ–°åœ¨æäº¤åæ‰èƒ½è¢«Açœ‹åˆ°ã€‚ æ‰€ä»¥ï¼ŒV3çš„å€¼ä¹Ÿæ˜¯2ã€‚</li><li>è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œå¯é‡å¤è¯»â€ï¼Œ åˆ™V1ã€ V2æ˜¯1ï¼Œ V3æ˜¯2ã€‚ ä¹‹æ‰€ä»¥V2è¿˜æ˜¯1ï¼Œ éµå¾ªçš„å°±æ˜¯è¿™ä¸ªè¦æ±‚ï¼šäº‹åŠ¡åœ¨æ‰§è¡ŒæœŸé—´çœ‹åˆ°çš„æ•°æ®å‰åå¿…é¡»æ˜¯ä¸€è‡´çš„ã€‚</li><li>è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œä¸²è¡ŒåŒ–â€ï¼Œ åˆ™åœ¨äº‹åŠ¡Bæ‰§è¡Œâ€œå°†1æ”¹æˆ2â€çš„æ—¶å€™ï¼Œ ä¼šè¢«é”ä½ã€‚ ç›´åˆ°äº‹åŠ¡Aæäº¤åï¼Œäº‹åŠ¡Bæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚ æ‰€ä»¥ä»Açš„è§’åº¦çœ‹ï¼Œ V1ã€ V2å€¼æ˜¯1ï¼Œ V3çš„å€¼æ˜¯2ã€‚</li></ul><p>åœ¨å®ç°ä¸Šï¼Œ æ•°æ®åº“é‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œ è®¿é—®çš„æ—¶å€™ä»¥è§†å›¾çš„é€»è¾‘ç»“æœä¸ºå‡†ã€‚</p><ul><li>åœ¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œ è¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œ æ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾ã€‚</li><li>åœ¨â€œè¯»æäº¤â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œ è¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ªSQLè¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ</li><li>â€œè¯»æœªæäº¤â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥è¿”å›è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œ æ²¡æœ‰è§†å›¾æ¦‚å¿µã€‚</li><li>â€œä¸²è¡ŒåŒ–â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥ç”¨åŠ é”çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®ã€‚</li></ul><p>Noteï¼šOracleæ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯â€œè¯»æäº¤â€ï¼ŒMySQLæ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ã€‚å› æ­¤ï¼Œä»Oracleè¿ç§»åˆ°MySQLçš„åº”ç”¨ï¼Œä¸ºä¿è¯æ•°æ®åº“éš”ç¦»çº§åˆ«çš„ä¸€è‡´ï¼Œä¸€å®šè¦å°†MySQLçš„éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºâ€œè¯»æäº¤â€ã€‚</p><p><strong>äº‹åŠ¡éš”ç¦»çš„å®ç°</strong></p><p>å¯é‡å¤è¯» ï¼šåœ¨MySQLä¸­ï¼Œ å®é™…ä¸Šæ¯æ¡è®°å½•åœ¨æ›´æ–°çš„æ—¶å€™éƒ½ä¼šåŒæ—¶è®°å½•ä¸€æ¡å›æ»šæ“ä½œã€‚ è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œ é€šè¿‡å›æ»šæ“ä½œï¼Œ éƒ½å¯ä»¥å¾—åˆ°å‰ä¸€ä¸ªçŠ¶æ€çš„å€¼ã€‚å‡è®¾ä¸€ä¸ªå€¼ä»1è¢«æŒ‰é¡ºåºæ”¹æˆäº†2ã€ 3ã€ 4ï¼Œ åœ¨å›æ»šæ—¥å¿—é‡Œé¢å°±ä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„è®°å½•ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192045780.png" alt="image-20240421192045780"></p><p><strong>ä¸ºä»€ä¹ˆå»ºè®®ä½ å°½é‡ä¸è¦ä½¿ç”¨é•¿äº‹åŠ¡</strong></p><ul><li>é•¿äº‹åŠ¡æ„å‘³ç€ç³»ç»Ÿé‡Œé¢ä¼šå­˜åœ¨å¾ˆè€çš„äº‹åŠ¡è§†å›¾ã€‚ç”±äºè¿™äº›äº‹åŠ¡éšæ—¶å¯èƒ½è®¿é—®æ•°æ®åº“é‡Œé¢çš„ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªäº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ•°æ®åº“é‡Œé¢å®ƒå¯èƒ½ç”¨åˆ°çš„å›æ»šè®°å½•éƒ½å¿…é¡»ä¿ç•™ï¼Œè¿™å°±ä¼šå¯¼è‡´å¤§é‡å ç”¨å­˜å‚¨ç©ºé—´ã€‚</li><li>é•¿äº‹åŠ¡è¿˜å ç”¨é”èµ„æºï¼Œä¹Ÿå¯èƒ½æ‹–å®æ•´ä¸ªåº“ã€‚</li></ul><p><strong>äº‹åŠ¡çš„å¯åŠ¨æ–¹å¼</strong></p><ol><li><p>æ˜¾å¼å¯åŠ¨äº‹åŠ¡è¯­å¥ï¼Œ begin æˆ– start transactionã€‚ é…å¥—çš„æäº¤è¯­å¥æ˜¯commitï¼Œ å›æ»šè¯­å¥æ˜¯rollbackã€‚</p></li><li><p>set autocommit=0ï¼Œ è¿™ä¸ªå‘½ä»¤ä¼šå°†è¿™ä¸ªçº¿ç¨‹çš„è‡ªåŠ¨æäº¤å…³æ‰ã€‚ æ„å‘³ç€å¦‚æœä½ åªæ‰§è¡Œä¸€ä¸ªselectè¯­å¥ï¼Œ è¿™ä¸ªäº‹åŠ¡å°±å¯åŠ¨äº†ï¼Œ è€Œä¸”å¹¶ä¸ä¼šè‡ªåŠ¨æäº¤ã€‚ è¿™ä¸ªäº‹åŠ¡æŒç»­å­˜åœ¨ç›´åˆ°ä½ ä¸»åŠ¨æ‰§è¡Œcommit æˆ– rollback è¯­å¥ï¼Œ æˆ–è€…æ–­å¼€è¿æ¥ã€‚å› æ­¤ï¼Œå»ºè®®æ€»æ˜¯ä½¿ç”¨set autocommit=1, é€šè¿‡æ˜¾å¼è¯­å¥çš„æ–¹å¼æ¥å¯åŠ¨äº‹åŠ¡ã€‚</p></li></ol><h2 id="04-æ·±å…¥æµ…å‡ºç´¢å¼•ï¼ˆä¸Šï¼‰"><strong>04 | æ·±å…¥æµ…å‡ºç´¢å¼•ï¼ˆä¸Šï¼‰</strong></h2><ul><li><a href="https://mp.weixin.qq.com/s?__biz=MzIzNjg4OTcyNA==&amp;mid=2247484419&amp;idx=1&amp;sn=534c25b454a48d182849c551e4e063d0&amp;chksm=e8d1b710dfa63e06a7d807c873ee6ce432e2c1b48b82560ccd14ea2ab3e22a2eb26df73ca410&amp;cur_album_id=2138177096085471232&amp;scene=189#wechat_redirect">MySQLç´¢å¼•ç»å…¸15é—®ï¼</a></li></ul><p>ç´¢å¼•çš„å‡ºç°å…¶å®å°±æ˜¯ä¸ºäº†æé«˜æ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ï¼Œ å°±åƒä¹¦çš„ç›®å½•ä¸€æ ·ã€‚</p><p><strong>ç´¢å¼•çš„å¸¸è§æ¨¡å‹</strong></p><p>å“ˆå¸Œè¡¨ã€ æœ‰åºæ•°ç»„å’Œæœç´¢æ ‘ã€‚</p><p><strong>å“ˆå¸Œè¡¨</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192109123.png" alt="image-20240421192109123"></p><p>å“ˆå¸Œè¡¨è¿™ç§ç»“æ„é€‚ç”¨äºåªæœ‰ç­‰å€¼æŸ¥è¯¢çš„åœºæ™¯ã€‚</p><p><strong>æœ‰åºæ•°ç»„</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192116542.png" alt="image-20240421192116542"></p><p>æœ‰åºæ•°ç»„åœ¨ç­‰å€¼æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢åœºæ™¯ä¸­çš„æ€§èƒ½å°±éƒ½éå¸¸ä¼˜ç§€ã€‚ä½†æ˜¯æœ‰åºæ•°ç»„ç´¢å¼•åªé€‚ç”¨äºé™æ€å­˜å‚¨å¼•æ“ã€‚</p><p><strong>æœç´¢æ ‘</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192123739.png" alt="image-20240421192123739"></p><p><strong>InnoDBçš„ç´¢å¼•æ¨¡å‹</strong></p><p>InnoDBä¸­ï¼Œ è¡¨éƒ½æ˜¯æ ¹æ®ä¸»é”®é¡ºåºä»¥ç´¢å¼•çš„å½¢å¼å­˜æ”¾çš„ï¼Œ è¿™ç§å­˜å‚¨æ–¹å¼çš„è¡¨ç§°ä¸ºç´¢å¼•ç»„ç»‡è¡¨ã€‚åˆå› ä¸ºå‰é¢æˆ‘ä»¬æåˆ°çš„ï¼Œ InnoDBä½¿ç”¨äº†B+æ ‘ç´¢å¼•æ¨¡å‹ï¼Œ æ‰€ä»¥æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨B+æ ‘ä¸­çš„ã€‚æ¯ä¸€ä¸ªç´¢å¼•åœ¨InnoDBé‡Œé¢å¯¹åº”ä¸€æ£µB+æ ‘ã€‚<br>å‡è®¾ï¼Œ æˆ‘ä»¬æœ‰ä¸€ä¸ªä¸»é”®åˆ—ä¸ºIDçš„è¡¨ï¼Œ è¡¨ä¸­æœ‰å­—æ®µkï¼Œ å¹¶ä¸”åœ¨kä¸Šæœ‰ç´¢å¼•ã€‚<br>è¿™ä¸ªè¡¨çš„å»ºè¡¨è¯­å¥æ˜¯ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> T(</span><br><span class="line">id <span class="type">int</span> <span class="keyword">primary</span> key, </span><br><span class="line">k <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">name <span class="type">varchar</span>(<span class="number">16</span>),</span><br><span class="line">index (k))engine<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure><p>è¡¨ä¸­R1~R5çš„(ID,k)å€¼åˆ†åˆ«ä¸º(100,1)ã€ (200,2)ã€ (300,3)ã€ (500,5)å’Œ(600,6)ï¼Œ ä¸¤æ£µæ ‘çš„ç¤ºä¾‹ç¤ºæ„å›¾å¦‚ä¸‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192319244.png" alt="image-20240421192319244"></p><p>ä»å›¾ä¸­ä¸éš¾çœ‹å‡ºï¼Œ æ ¹æ®å¶å­èŠ‚ç‚¹çš„å†…å®¹ï¼Œ ç´¢å¼•ç±»å‹åˆ†ä¸ºä¸»é”®ç´¢å¼•å’Œéä¸»é”®ç´¢å¼•ã€‚ä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜çš„æ˜¯æ•´è¡Œæ•°æ®ã€‚ åœ¨InnoDBé‡Œï¼Œ ä¸»é”®ç´¢å¼•ä¹Ÿè¢«ç§°ä¸ºèšç°‡ç´¢å¼•ï¼ˆclustered indexï¼‰ ã€‚éä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å†…å®¹æ˜¯ä¸»é”®çš„å€¼ã€‚ åœ¨InnoDBé‡Œï¼Œ éä¸»é”®ç´¢å¼•ä¹Ÿè¢«ç§°ä¸ºäºŒçº§ç´¢å¼•ï¼ˆsecondaryindexï¼‰ã€‚</p><p><strong>åŸºäºä¸»é”®ç´¢å¼•å’Œæ™®é€šç´¢å¼•çš„æŸ¥è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p><p>å¦‚æœè¯­å¥æ˜¯select * from Twhere ID=500ï¼Œ å³ä¸»é”®æŸ¥è¯¢æ–¹å¼ï¼Œ åˆ™åªéœ€è¦æœç´¢IDè¿™æ£µB+æ ‘ï¼›</p><p>å¦‚æœè¯­å¥æ˜¯select * from Twhere k=5ï¼Œ å³æ™®é€šç´¢å¼•æŸ¥è¯¢æ–¹å¼ï¼Œ åˆ™éœ€è¦å…ˆæœç´¢kç´¢å¼•æ ‘ï¼Œ å¾—åˆ°IDçš„å€¼ä¸º500ï¼Œ å†åˆ°IDç´¢å¼•æ ‘æœç´¢ä¸€æ¬¡ã€‚ è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå›è¡¨ã€‚</p><p><strong>ç´¢å¼•ç»´æŠ¤</strong></p><p>ä¸»è¦æ˜¯ç”±äºé¡µåˆ†è£‚å’Œåˆå¹¶ã€‚</p><p>è‡ªå¢ä¸»é”®æ˜¯æŒ‡è‡ªå¢åˆ—ä¸Šå®šä¹‰çš„ä¸»é”®ï¼Œåœ¨å»ºè¡¨è¯­å¥ä¸­ä¸€èˆ¬æ˜¯è¿™ä¹ˆå®šä¹‰çš„ï¼š NOT NULL PRIMARY KEY AUTO_INCREMENTã€‚</p><p>è‡ªå¢ä¸»é”®çš„æ’å…¥æ•°æ®æ¨¡å¼ï¼Œç¬¦åˆé€’å¢æ’å…¥çš„åœºæ™¯ã€‚æ¯æ¬¡æ’å…¥ä¸€æ¡æ–°è®°å½•ï¼Œéƒ½æ˜¯è¿½åŠ æ“ä½œï¼Œéƒ½ä¸æ¶‰åŠåˆ°æŒªåŠ¨å…¶ä»–è®°å½•ï¼Œä¹Ÿä¸ä¼šè§¦å‘å¶å­èŠ‚ç‚¹çš„åˆ†è£‚ã€‚</p><p>æ˜¾ç„¶ï¼Œ ä¸»é”®é•¿åº¦è¶Šå°ï¼Œ æ™®é€šç´¢å¼•çš„å¶å­èŠ‚ç‚¹å°±è¶Šå°ï¼Œ æ™®é€šç´¢å¼•å ç”¨çš„ç©ºé—´ä¹Ÿå°±è¶Šå°ã€‚</p><p><strong>å¦‚ä½•é¿å…é•¿äº‹åŠ¡å¯¹ä¸šåŠ¡çš„å½±å“</strong> <strong>ï¼Ÿ</strong></p><p>é¦–å…ˆï¼Œ ä»åº”ç”¨å¼€å‘ç«¯æ¥çœ‹ï¼š</p><ol><li>ç¡®è®¤æ˜¯å¦ä½¿ç”¨äº†set autocommit=0ã€‚ è¿™ä¸ªç¡®è®¤å·¥ä½œå¯ä»¥åœ¨æµ‹è¯•ç¯å¢ƒä¸­å¼€å±•ï¼Œ æŠŠMySQLçš„general_logå¼€èµ·æ¥ï¼Œ ç„¶åéšä¾¿è·‘ä¸€ä¸ªä¸šåŠ¡é€»è¾‘ï¼Œ é€šè¿‡general_logçš„æ—¥å¿—æ¥ç¡®è®¤ã€‚ ä¸€èˆ¬æ¡†æ¶å¦‚æœä¼šè®¾ç½®è¿™ä¸ªå€¼ï¼Œ ä¹Ÿå°±ä¼šæä¾›å‚æ•°æ¥æ§åˆ¶è¡Œä¸ºï¼Œ ä½ çš„ç›®æ ‡å°±æ˜¯æŠŠå®ƒæ”¹æˆ1ã€‚</li><li>ç¡®è®¤æ˜¯å¦æœ‰ä¸å¿…è¦çš„åªè¯»äº‹åŠ¡ã€‚ æœ‰äº›æ¡†æ¶ä¼šä¹ æƒ¯ä¸ç®¡ä»€ä¹ˆè¯­å¥å…ˆç”¨begin/commitæ¡†èµ·æ¥ã€‚ æˆ‘è§è¿‡æœ‰äº›æ˜¯ä¸šåŠ¡å¹¶æ²¡æœ‰è¿™ä¸ªéœ€è¦ï¼Œ ä½†æ˜¯ä¹ŸæŠŠå¥½å‡ ä¸ªselectè¯­å¥æ”¾åˆ°äº†äº‹åŠ¡ä¸­ã€‚ è¿™ç§åªè¯»äº‹åŠ¡å¯ä»¥å»æ‰ã€‚</li><li>ä¸šåŠ¡è¿æ¥æ•°æ®åº“çš„æ—¶å€™ï¼Œ æ ¹æ®ä¸šåŠ¡æœ¬èº«çš„é¢„ä¼°ï¼Œ é€šè¿‡SETMAX_EXECUTION_TIMEå‘½ä»¤ï¼Œæ¥æ§åˆ¶æ¯ä¸ªè¯­å¥æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ï¼Œ é¿å…å•ä¸ªè¯­å¥æ„å¤–æ‰§è¡Œå¤ªé•¿æ—¶é—´ã€‚ ï¼ˆä¸ºä»€ä¹ˆä¼šæ„å¤–ï¼Ÿ åœ¨åç»­çš„æ–‡ç« ä¸­ä¼šæåˆ°è¿™ç±»æ¡ˆä¾‹ï¼‰</li></ol><p><strong>å…¶æ¬¡ï¼Œ</strong> <strong>ä»æ•°æ®åº“ç«¯æ¥çœ‹</strong></p><ol><li>ç›‘æ§ information_schema.Innodb_trxè¡¨ï¼Œ è®¾ç½®é•¿äº‹åŠ¡é˜ˆå€¼ï¼Œ è¶…è¿‡å°±æŠ¥è­¦/æˆ–è€…killï¼›</li><li>Perconaçš„pt-killè¿™ä¸ªå·¥å…·ä¸é”™ï¼Œ æ¨èä½¿ç”¨ï¼›</li><li>åœ¨ä¸šåŠ¡åŠŸèƒ½æµ‹è¯•é˜¶æ®µè¦æ±‚è¾“å‡ºæ‰€æœ‰çš„general_logï¼Œ åˆ†ææ—¥å¿—è¡Œä¸ºæå‰å‘ç°é—®é¢˜ï¼›</li><li>å¦‚æœä½¿ç”¨çš„æ˜¯MySQL 5.6æˆ–è€…æ›´æ–°ç‰ˆæœ¬ï¼Œ æŠŠinnodb_undo_tablespacesè®¾ç½®æˆ2ï¼ˆæˆ–æ›´å¤§çš„å€¼ï¼‰ ã€‚ å¦‚æœçœŸçš„å‡ºç°å¤§äº‹åŠ¡å¯¼è‡´å›æ»šæ®µè¿‡å¤§ï¼Œ è¿™æ ·è®¾ç½®åæ¸…ç†èµ·æ¥æ›´æ–¹ä¾¿ã€‚</li></ol><h2 id="05-æ·±å…¥æµ…å‡ºç´¢å¼•ï¼ˆä¸‹ï¼‰"><strong>05 | æ·±å…¥æµ…å‡ºç´¢å¼•ï¼ˆä¸‹ï¼‰</strong></h2><p>æ‰§è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> Twhere k <span class="keyword">between</span> <span class="number">3</span> <span class="keyword">and</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ‰§è¡Œå‡ æ¬¡æ ‘çš„æœç´¢æ“ä½œï¼Œä¼šæ‰«æå¤šå°‘è¡Œï¼Ÿ</p><p>è¡¨çš„åˆå§‹åŒ–è¯­å¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> T (</span><br><span class="line">ID <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">k <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>, </span><br><span class="line">s <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">index k(k))</span><br><span class="line">engine<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> T <span class="keyword">values</span>(<span class="number">100</span>,<span class="number">1</span>, <span class="string">&#x27;aa&#x27;</span>),(<span class="number">200</span>,<span class="number">2</span>,<span class="string">&#x27;bb&#x27;</span>),(<span class="number">300</span>,<span class="number">3</span>,<span class="string">&#x27;cc&#x27;</span>),(<span class="number">500</span>,<span class="number">5</span>,<span class="string">&#x27;ee&#x27;</span>),(<span class="number">600</span>,<span class="number">6</span>,<span class="string">&#x27;ff&#x27;</span>),(<span class="number">700</span>,<span class="number">7</span>,<span class="string">&#x27;gg&#x27;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192628068.png" alt="image-20240421192628068"></p><p>æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹è¿™æ¡SQLæŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæµç¨‹ï¼š</p><ol><li>åœ¨kç´¢å¼•æ ‘ä¸Šæ‰¾åˆ°k=3çš„è®°å½•ï¼Œå–å¾— ID = 300ï¼›</li><li>å†åˆ°IDç´¢å¼•æ ‘æŸ¥åˆ°ID=300å¯¹åº”çš„R3ï¼›</li><li>åœ¨kç´¢å¼•æ ‘å–ä¸‹ä¸€ä¸ªå€¼k=5ï¼Œå–å¾—ID=500ï¼›</li><li>å†å›åˆ°IDç´¢å¼•æ ‘æŸ¥åˆ°ID=500å¯¹åº”çš„R4ï¼›</li><li>åœ¨kç´¢å¼•æ ‘å–ä¸‹ä¸€ä¸ªå€¼k=6ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œå¾ªç¯ç»“æŸã€‚</li></ol><p>å›åˆ°ä¸»é”®ç´¢å¼•æ ‘æœç´¢çš„è¿‡ç¨‹ï¼Œ æˆ‘ä»¬ç§°ä¸ºå›è¡¨ã€‚</p><p><strong>è¦†ç›–ç´¢å¼•</strong></p><p>ç”±äºè¦†ç›–ç´¢å¼•å¯ä»¥å‡å°‘æ ‘çš„æœç´¢æ¬¡æ•°ï¼Œ æ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œ æ‰€ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚</p><p><strong>æœ€å·¦å‰ç¼€åŸåˆ™</strong></p><p>å¦‚æœä¸ºæ¯ä¸€ç§æŸ¥è¯¢éƒ½è®¾è®¡ä¸€ä¸ªç´¢å¼•ï¼Œ ç´¢å¼•æ˜¯ä¸æ˜¯å¤ªå¤šäº†ã€‚B+æ ‘è¿™ç§ç´¢å¼•ç»“æ„ï¼Œ å¯ä»¥åˆ©ç”¨ç´¢å¼•çš„â€œæœ€å·¦å‰ç¼€â€ï¼Œ æ¥å®šä½è®°å½•ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192809647.png" alt="image-20240421192809647"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œ ç´¢å¼•é¡¹æ˜¯æŒ‰ç…§ç´¢å¼•å®šä¹‰é‡Œé¢å‡ºç°çš„å­—æ®µé¡ºåºæ’åºçš„ã€‚</p><p><strong>ç´¢å¼•ä¸‹æ¨</strong></p><p>ä»€ä¹ˆæ˜¯ç´¢å¼•ä¸‹æ¨ï¼Ÿæ‹¿åˆ°ç´¢å¼•ä¹‹åæ ¹æ®whereæ¡ä»¶çœ‹çœ‹èƒ½ä¸èƒ½å†è¿›è¡Œè¿‡æ»¤ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tuser <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;å¼ %&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">10</span> <span class="keyword">and</span> ismale<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>åœ¨MySQL 5.6ä¹‹å‰ï¼Œ åªèƒ½ä»ID3å¼€å§‹ä¸€ä¸ªä¸ªå›è¡¨ã€‚ åˆ°ä¸»é”®ç´¢å¼•ä¸Šæ‰¾å‡ºæ•°æ®è¡Œï¼Œ å†å¯¹æ¯”å­—æ®µå€¼ã€‚<br>è€ŒMySQL 5.6 å¼•å…¥çš„ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–ï¼ˆindexcondition pushdown)ï¼Œ å¯ä»¥åœ¨ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œ å¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œ ç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œ å‡å°‘å›è¡¨æ¬¡æ•°ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192816713.png" alt="image-20240421192816713"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192822945.png" alt="image-20240421192822945"></p><p>åŒºåˆ«æ˜¯ï¼Œ InnoDBåœ¨(name,age)ç´¢å¼•å†…éƒ¨å°±åˆ¤æ–­äº†ageæ˜¯å¦ç­‰äº10ï¼Œ å¯¹äºä¸ç­‰äº10çš„è®°å½•ï¼Œ ç›´æ¥åˆ¤æ–­å¹¶è·³è¿‡ã€‚ åœ¨æˆ‘ä»¬çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œ åªéœ€è¦å¯¹ID4ã€ ID5è¿™ä¸¤æ¡è®°å½•å›è¡¨å–æ•°æ®åˆ¤æ–­ï¼Œ å°±åªéœ€è¦å›è¡¨2æ¬¡ã€‚</p><h2 id="06-å…¨å±€é”å’Œè¡¨é”-ï¼š-ç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆæœ‰è¿™ä¹ˆå¤šé˜»ç¢ï¼Ÿ"><strong>06 | å…¨å±€é”å’Œè¡¨é”</strong> <strong>ï¼š</strong> <strong>ç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆæœ‰è¿™ä¹ˆå¤šé˜»ç¢ï¼Ÿ</strong></h2><p>æ•°æ®åº“é”è®¾è®¡çš„åˆè¡·æ˜¯å¤„ç†å¹¶å‘é—®é¢˜ã€‚</p><p>æ ¹æ®åŠ é”çš„èŒƒå›´ï¼Œ MySQLé‡Œé¢çš„é”å¤§è‡´å¯ä»¥åˆ†æˆå…¨å±€é”ã€ è¡¨çº§é”å’Œè¡Œé”ä¸‰ç±»ã€‚</p><p><strong>å…¨å±€é”</strong></p><p>å½“ä½ éœ€è¦è®©æ•´ä¸ªåº“å¤„äºåªè¯»çŠ¶æ€çš„æ—¶å€™ï¼Œ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œ ä¹‹åå…¶ä»–çº¿ç¨‹çš„ä»¥ä¸‹è¯­å¥ä¼šè¢«é˜»å¡ï¼š æ•°æ®æ›´æ–°è¯­å¥ï¼ˆæ•°æ®çš„å¢åˆ æ”¹ï¼‰ ã€ æ•°æ®å®šä¹‰è¯­å¥ï¼ˆåŒ…æ‹¬å»ºè¡¨ã€ ä¿®æ”¹è¡¨ç»“æ„ç­‰ï¼‰ å’Œæ›´æ–°ç±»äº‹åŠ¡çš„æäº¤è¯­å¥ã€‚</p><p><strong>å…¨å±€é”çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œ åšå…¨åº“é€»è¾‘å¤‡ä»½ã€‚</strong></p><p>ä½†æ˜¯è®©æ•´åº“éƒ½åªè¯»ï¼Œ å¬ä¸Šå»å°±å¾ˆå±é™©ï¼š<br>å¦‚æœä½ åœ¨ä¸»åº“ä¸Šå¤‡ä»½ï¼Œ é‚£ä¹ˆåœ¨å¤‡ä»½æœŸé—´éƒ½ä¸èƒ½æ‰§è¡Œæ›´æ–°ï¼Œ ä¸šåŠ¡åŸºæœ¬ä¸Šå°±å¾—åœæ‘†ï¼›<br>å¦‚æœä½ åœ¨ä»åº“ä¸Šå¤‡ä»½ï¼Œ é‚£ä¹ˆå¤‡ä»½æœŸé—´ä»åº“ä¸èƒ½æ‰§è¡Œä¸»åº“åŒæ­¥è¿‡æ¥çš„binlogï¼Œ ä¼šå¯¼è‡´ä¸»ä»å»¶è¿Ÿ ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421192903605.png" alt="image-20240421192903605"></p><p>è¿™ä¸ªå¤‡ä»½ç»“æœé‡Œï¼Œ ç”¨æˆ·Açš„æ•°æ®çŠ¶æ€æ˜¯â€œè´¦æˆ·ä½™é¢æ²¡æ‰£ï¼Œ ä½†æ˜¯ç”¨æˆ·è¯¾ç¨‹è¡¨é‡Œé¢å·²ç»å¤šäº†ä¸€é—¨è¯¾â€ã€‚ å¦‚æœåé¢ç”¨è¿™ä¸ªå¤‡ä»½æ¥æ¢å¤æ•°æ®çš„è¯ï¼Œ ç”¨æˆ·Aå°±å‘ç°ï¼Œ è‡ªå·±èµšäº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¤‡ä»½è¡¨çš„é¡ºåºåè¿‡æ¥ï¼Œå…ˆå¤‡ä»½ç”¨æˆ·è¯¾ç¨‹è¡¨å†å¤‡ä»½è´¦æˆ·ä½™é¢è¡¨ï¼Œåˆå¯èƒ½ä¼šå‡ºç°ä»€ä¹ˆç»“æœã€ç‹—å¤´ã€‘ã€‚</p><p>å®˜æ–¹è‡ªå¸¦çš„é€»è¾‘å¤‡ä»½å·¥å…·æ˜¯mysqldumpã€‚å½“mysqldumpä½¿ç”¨å‚æ•°â€“single-transactionçš„æ—¶å€™ï¼Œå¯¼æ•°æ®ä¹‹å‰å°±ä¼šå¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œæ¥ç¡®ä¿æ‹¿åˆ°ä¸€è‡´æ€§è§†å›¾ã€‚è€Œç”±äºMVCCçš„æ”¯æŒï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ•°æ®æ˜¯å¯ä»¥æ­£å¸¸æ›´æ–°çš„ã€‚</p><p><strong>è¡¨çº§é”</strong></p><p>MySQLé‡Œé¢è¡¨çº§åˆ«çš„é”æœ‰ä¸¤ç§ï¼š ä¸€ç§æ˜¯è¡¨é”ï¼Œ ä¸€ç§æ˜¯å…ƒæ•°æ®é”ï¼ˆmeta data lockï¼Œ MDL) ã€‚</p><p>è¡¨é”çš„è¯­æ³•æ˜¯ lock tables â€¦read/writeã€‚ä¸¾ä¸ªä¾‹å­, å¦‚æœåœ¨æŸä¸ªçº¿ç¨‹Aä¸­æ‰§è¡Œlock tables t1 read, t2 write; è¿™ä¸ªè¯­å¥ï¼Œ åˆ™å…¶ä»–çº¿ç¨‹å†™t1ã€ è¯»å†™t2çš„è¯­å¥éƒ½ä¼šè¢«é˜»å¡ã€‚ åŒæ—¶ï¼Œ çº¿ç¨‹Aåœ¨æ‰§è¡Œunlock tablesä¹‹å‰ï¼Œ ä¹Ÿåªèƒ½æ‰§è¡Œè¯»t1ã€ è¯»å†™t2çš„æ“ä½œã€‚ è¿å†™t1éƒ½ä¸å…è®¸ï¼Œ è‡ªç„¶ä¹Ÿä¸èƒ½è®¿é—®å…¶ä»–è¡¨ã€‚</p><p>å¦ä¸€ç±»è¡¨çº§çš„é”æ˜¯MDLï¼ˆ metadata lock)ã€‚ MDLä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ï¼Œ åœ¨è®¿é—®ä¸€ä¸ªè¡¨çš„æ—¶å€™ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šã€‚ MDLçš„ä½œç”¨æ˜¯ï¼Œ ä¿è¯è¯»å†™çš„æ­£ç¡®æ€§ã€‚ ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œ å¦‚æœä¸€ä¸ªæŸ¥è¯¢æ­£åœ¨éå†ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œ è€Œæ‰§è¡ŒæœŸé—´å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªè¡¨ç»“æ„åšå˜æ›´ï¼Œ åˆ äº†ä¸€åˆ—ï¼Œ é‚£ä¹ˆæŸ¥è¯¢çº¿ç¨‹æ‹¿åˆ°çš„ç»“æœè·Ÿè¡¨ç»“æ„å¯¹ä¸ä¸Šï¼Œ è‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚</p><p>MDLè¯»é”ä¹‹é—´ä¸äº’æ–¥ï¼Œ å› æ­¤ä½ å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹ä¸€å¼ è¡¨å¢åˆ æ”¹æŸ¥ã€‚</p><p>è¯»å†™é”ä¹‹é—´ã€ å†™é”ä¹‹é—´æ˜¯äº’æ–¥çš„ï¼Œ ç”¨æ¥ä¿è¯å˜æ›´è¡¨ç»“æ„æ“ä½œçš„å®‰å…¨æ€§ã€‚</p><p>å› æ­¤ï¼Œ å¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹è¦åŒæ—¶ç»™ä¸€ä¸ªè¡¨åŠ å­—æ®µï¼Œ å…¶ä¸­ä¸€ä¸ªè¦ç­‰å¦ä¸€ä¸ªæ‰§è¡Œå®Œæ‰èƒ½å¼€å§‹æ‰§è¡Œã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421193106335.png" alt="image-20240421193106335"></p><ol><li>session Aå…ˆå¯åŠ¨ï¼Œå¯¹è¡¨tåŠ ä¸€ä¸ªMDLè¯»é”ã€‚</li><li>ç”±äºsession Béœ€è¦çš„ä¹Ÿæ˜¯MDLè¯»é”ã€‚</li><li>session Cä¼šè¢«blockedï¼Œæ˜¯å› ä¸ºsession Açš„MDLè¯»é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œè€Œsession Céœ€è¦MDLå†™é”ï¼Œå› æ­¤åªèƒ½è¢«é˜»å¡ã€‚</li><li>é—®é¢˜æ¥äº†ï¼Œä¹‹åæ‰€æœ‰è¦åœ¨è¡¨tä¸Šæ–°ç”³è¯·MDLè¯»é”çš„è¯·æ±‚ä¹Ÿä¼šè¢«session Cé˜»å¡ã€‚ç­‰äºè¿™ä¸ªè¡¨ç°åœ¨å®Œå…¨ä¸å¯è¯»å†™äº†ã€‚</li></ol><p>ä¸Šé¢çš„ä¾‹å­å¦‚æœæŸä¸ªè¡¨ä¸Šçš„æŸ¥è¯¢è¯­å¥é¢‘ç¹ï¼Œè€Œä¸”å®¢æˆ·ç«¯æœ‰é‡è¯•æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è¶…æ—¶åä¼šå†èµ·ä¸€ä¸ªæ–°sessionå†è¯·æ±‚çš„è¯ï¼Œè¿™ä¸ªåº“çš„çº¿ç¨‹å¾ˆå¿«å°±ä¼šçˆ†æ»¡ã€‚</p><p><strong>äº‹åŠ¡ä¸­çš„MDLé”ï¼Œåœ¨è¯­å¥æ‰§è¡Œå¼€å§‹æ—¶ç”³è¯·ï¼Œä½†æ˜¯è¯­å¥ç»“æŸåå¹¶ä¸ä¼šé©¬ä¸Šé‡Šæ”¾ï¼Œè€Œä¼šç­‰åˆ°æ•´ä¸ªäº‹åŠ¡æäº¤åå†é‡Šæ”¾ã€‚</strong></p><p><strong>pro1:å¦‚ä½•å®‰å…¨åœ°ç»™å°è¡¨åŠ å­—æ®µï¼Ÿ</strong></p><p>**solution1:**é¦–å…ˆæˆ‘ä»¬è¦è§£å†³é•¿äº‹åŠ¡ï¼Œäº‹åŠ¡ä¸æäº¤ï¼Œå°±ä¼šä¸€ç›´å ç€MDLé”ã€‚åœ¨MySQLçš„information_schema åº“çš„ innodb_trx è¡¨ä¸­ï¼Œä½ å¯ä»¥æŸ¥åˆ°å½“å‰æ‰§è¡Œä¸­çš„äº‹åŠ¡ã€‚å¦‚æœä½ è¦åšDDLå˜æ›´çš„è¡¨åˆšå¥½æœ‰é•¿äº‹åŠ¡åœ¨æ‰§è¡Œï¼Œè¦è€ƒè™‘å…ˆæš‚åœDDLï¼Œæˆ–è€…killæ‰è¿™ä¸ªé•¿äº‹åŠ¡ã€‚</p><p><strong>pro2:ä½ è¦å˜æ›´çš„è¡¨æ˜¯ä¸€ä¸ªçƒ­ç‚¹è¡¨ï¼Œè™½ç„¶æ•°æ®é‡ä¸å¤§ï¼Œä½†æ˜¯ä¸Šé¢çš„è¯·æ±‚å¾ˆé¢‘ç¹ï¼Œè€Œä½ ä¸å¾—ä¸åŠ ä¸ªå­—æ®µï¼Œä½ è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</strong></p><p>è¿™æ—¶å€™killå¯èƒ½æœªå¿…ç®¡ç”¨ï¼Œå› ä¸ºæ–°çš„è¯·æ±‚é©¬ä¸Šå°±æ¥äº†ã€‚æ¯”è¾ƒç†æƒ³çš„æœºåˆ¶æ˜¯ï¼Œåœ¨alter tableè¯­å¥é‡Œé¢è®¾å®šç­‰å¾…æ—¶é—´ï¼Œå¦‚æœåœ¨è¿™ä¸ªæŒ‡å®šçš„ç­‰å¾…æ—¶é—´é‡Œé¢èƒ½å¤Ÿæ‹¿åˆ°MDLå†™é”æœ€å¥½ï¼Œæ‹¿ä¸åˆ°ä¹Ÿä¸è¦é˜»å¡åé¢çš„ä¸šåŠ¡è¯­å¥ï¼Œå…ˆæ”¾å¼ƒã€‚ä¹‹åå¼€å‘äººå‘˜æˆ–è€…DBAå†é€šè¿‡é‡è¯•å‘½ä»¤é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚</p><h2 id="07-è¡Œé”åŠŸè¿‡ï¼š-æ€ä¹ˆå‡å°‘è¡Œé”å¯¹æ€§èƒ½çš„å½±å“ï¼Ÿ"><strong>07 | è¡Œé”åŠŸè¿‡ï¼š</strong> <strong>æ€ä¹ˆå‡å°‘è¡Œé”å¯¹æ€§èƒ½çš„å½±å“ï¼Ÿ</strong></h2><p>MySQLçš„è¡Œé”æ˜¯åœ¨å¼•æ“å±‚ç”±å„ä¸ªå¼•æ“è‡ªå·±å®ç°çš„ã€‚ ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„å¼•æ“éƒ½æ”¯æŒè¡Œé”ã€‚ InnoDBæ˜¯æ”¯æŒè¡Œé”çš„ã€‚MyISAMå¼•æ“å°±ä¸æ”¯æŒè¡Œé”ã€‚</p><p><strong>ä»ä¸¤é˜¶æ®µé”è¯´èµ·</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421194317901.png" alt="image-20240421194317901"></p><p>å®é™…ä¸Šäº‹åŠ¡Bçš„updateè¯­å¥ä¼šè¢«é˜»å¡ï¼Œ ç›´åˆ°äº‹åŠ¡Aæ‰§è¡Œcommitä¹‹åï¼Œ äº‹åŠ¡Bæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚ åœ¨InnoDBäº‹åŠ¡ä¸­ï¼Œ è¡Œé”æ˜¯åœ¨éœ€è¦çš„æ—¶å€™æ‰åŠ ä¸Šçš„ï¼Œ ä½†å¹¶ä¸æ˜¯ä¸éœ€è¦äº†å°±ç«‹åˆ»é‡Šæ”¾ï¼Œ è€Œæ˜¯è¦ç­‰åˆ°äº‹åŠ¡ç»“æŸæ—¶æ‰é‡Šæ”¾ã€‚ è¿™ä¸ªå°±æ˜¯ä¸¤é˜¶æ®µé”åè®®ã€‚</p><p><strong>åœ¨InnoDBäº‹åŠ¡ä¸­ï¼Œè¡Œé”æ˜¯åœ¨éœ€è¦çš„æ—¶å€™æ‰åŠ ä¸Šçš„ï¼Œä½†å¹¶ä¸æ˜¯ä¸éœ€è¦äº†å°±ç«‹åˆ»é‡Šæ”¾ï¼Œè€Œæ˜¯è¦ç­‰åˆ°äº‹åŠ¡ç»“æŸæ—¶æ‰é‡Šæ”¾ã€‚è¿™ä¸ªå°±æ˜¯ä¸¤é˜¶æ®µé”åè®®ã€‚</strong></p><p><strong>ç»“è®º</strong>ï¼šå¦‚æœä½ çš„äº‹åŠ¡ä¸­éœ€è¦é”å¤šä¸ªè¡Œï¼Œè¦æŠŠæœ€å¯èƒ½é€ æˆé”å†²çªã€æœ€å¯èƒ½å½±å“å¹¶å‘åº¦çš„é”å°½é‡å¾€åæ”¾ã€‚</p><p><strong>æ­»é”å’Œæ­»é”æ£€æµ‹</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421194324791.png" alt="image-20240421194324791"></p><p>è¿™æ—¶å€™ï¼Œ äº‹åŠ¡Aåœ¨ç­‰å¾…äº‹åŠ¡Bé‡Šæ”¾id=2çš„è¡Œé”ï¼Œ è€Œäº‹åŠ¡Båœ¨ç­‰å¾…äº‹åŠ¡Aé‡Šæ”¾id=1çš„è¡Œé”ã€‚ äº‹åŠ¡Aå’Œäº‹åŠ¡Båœ¨äº’ç›¸ç­‰å¾…å¯¹æ–¹çš„èµ„æºé‡Šæ”¾ï¼Œ å°±æ˜¯è¿›å…¥äº†æ­»é”çŠ¶æ€ã€‚</p><p>å½“å‡ºç°æ­»é”ä»¥åï¼Œ æœ‰ä¸¤ç§ç­–ç•¥ï¼š</p><ul><li>ä¸€ç§ç­–ç•¥æ˜¯ï¼Œ ç›´æ¥è¿›å…¥ç­‰å¾…ï¼Œ ç›´åˆ°è¶…æ—¶ã€‚ è¿™ä¸ªè¶…æ—¶æ—¶é—´å¯ä»¥é€šè¿‡å‚æ•°innodb_lock_wait_timeoutæ¥è®¾ç½®ã€‚<ul><li>åœ¨InnoDBä¸­ï¼Œinnodb_lock_wait_timeoutçš„é»˜è®¤å€¼æ˜¯50sã€‚æ„å‘³ç€å½“å‡ºç°æ­»é”ä»¥åï¼Œç¬¬ä¸€ä¸ªè¢«é”ä½çš„çº¿ç¨‹è¦è¿‡50sæ‰ä¼šè¶…æ—¶é€€å‡ºï¼Œç„¶åå…¶ä»–çº¿ç¨‹æ‰æœ‰å¯èƒ½ç»§ç»­æ‰§è¡Œã€‚å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªæ—¶é—´è®¾ç½®æˆä¸€ä¸ªå¾ˆå°çš„å€¼ï¼Œæ¯”å¦‚1sï¼Œä¼šä¼¤å®³åˆ°æ™®é€šçš„é”ç­‰å¾…ã€‚</li></ul></li><li>å¦ä¸€ç§ç­–ç•¥æ˜¯ï¼Œ å‘èµ·æ­»é”æ£€æµ‹ï¼Œ å‘ç°æ­»é”åï¼Œ ä¸»åŠ¨å›æ»šæ­»é”é“¾æ¡ä¸­çš„æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè®©å…¶ä»–äº‹åŠ¡å¾—ä»¥ç»§ç»­æ‰§è¡Œã€‚ å°†å‚æ•°innodb_deadlock_detectè®¾ç½®ä¸ºonï¼Œ è¡¨ç¤ºå¼€å¯è¿™ä¸ªé€»è¾‘ã€‚</li></ul><p>èƒŒæ™¯ï¼š</p><p>æ¯å½“ä¸€ä¸ªäº‹åŠ¡è¢«é”çš„æ—¶å€™ï¼Œå°±è¦çœ‹çœ‹å®ƒæ‰€ä¾èµ–çš„çº¿ç¨‹æœ‰æ²¡æœ‰è¢«åˆ«äººé”ä½ï¼Œå¦‚æ­¤å¾ªç¯ï¼Œæœ€ååˆ¤æ–­æ˜¯å¦å‡ºç°äº†å¾ªç¯ç­‰å¾…ï¼Œä¹Ÿå°±æ˜¯æ­»é”ã€‚</p><p>é‚£å¦‚æœæ˜¯æˆ‘ä»¬ä¸Šé¢è¯´åˆ°çš„æ‰€æœ‰äº‹åŠ¡éƒ½è¦æ›´æ–°åŒä¸€è¡Œçš„åœºæ™¯å‘¢ï¼Ÿ</p><p>æ¯ä¸ªæ–°æ¥çš„è¢«å µä½çš„çº¿ç¨‹ï¼Œéƒ½è¦åˆ¤æ–­ä¼šä¸ä¼šç”±äºè‡ªå·±çš„åŠ å…¥å¯¼è‡´äº†æ­»é”ï¼Œè¿™æ˜¯ä¸€ä¸ªæ—¶é—´å¤æ‚åº¦æ˜¯O(n)çš„æ“ä½œã€‚å‡è®¾æœ‰1000ä¸ªå¹¶å‘çº¿ç¨‹è¦åŒæ—¶æ›´æ–°åŒä¸€è¡Œï¼Œé‚£ä¹ˆæ­»é”æ£€æµ‹æ“ä½œå°±æ˜¯100ä¸‡è¿™ä¸ªé‡çº§çš„ã€‚è™½ç„¶æœ€ç»ˆæ£€æµ‹çš„ç»“æœæ˜¯æ²¡æœ‰æ­»é”ï¼Œä½†æ˜¯è¿™æœŸé—´è¦æ¶ˆè€—å¤§é‡çš„CPUèµ„æºã€‚å› æ­¤ï¼Œä½ å°±ä¼šçœ‹åˆ°CPUåˆ©ç”¨ç‡å¾ˆé«˜ï¼Œä½†æ˜¯æ¯ç§’å´æ‰§è¡Œä¸äº†å‡ ä¸ªäº‹åŠ¡ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹ï¼Œæ€ä¹ˆè§£å†³ç”±è¿™ç§çƒ­ç‚¹è¡Œæ›´æ–°å¯¼è‡´çš„æ€§èƒ½é—®é¢˜å‘¢ï¼Ÿ</p><p>é—®é¢˜ï¼š</p><p>é—®é¢˜çš„å…³é”®åœ¨äºæ­»é”æ£€æµ‹è¦è€—è´¹å¤§é‡çš„CPUèµ„æºã€‚</p><p>è§£å†³æ–¹æ³•ï¼š</p><ol><li>å¦‚æœä½ èƒ½ç¡®ä¿è¿™ä¸ªä¸šåŠ¡ä¸€å®šä¸ä¼šå‡ºç°æ­»é”ï¼Œå¯ä»¥ä¸´æ—¶æŠŠæ­»é”æ£€æµ‹å…³æ‰ã€‚</li><li>æ§åˆ¶å¹¶å‘åº¦ã€‚æ¯”å¦‚åŒä¸€è¡ŒåŒæ—¶æœ€å¤šåªæœ‰10ä¸ªçº¿ç¨‹åœ¨æ›´æ–°ï¼Œé‚£ä¹ˆæ­»é”æ£€æµ‹çš„æˆæœ¬å¾ˆä½ï¼Œå°±ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚</li></ol><h2 id="08-äº‹åŠ¡åˆ°åº•æ˜¯éš”ç¦»çš„è¿˜æ˜¯ä¸éš”ç¦»çš„ï¼Ÿ"><strong>08 | äº‹åŠ¡åˆ°åº•æ˜¯éš”ç¦»çš„è¿˜æ˜¯ä¸éš”ç¦»çš„ï¼Ÿ</strong></h2><p>è¿™éƒ¨åˆ†ä¸»è¦æ˜¯MVCCåŸç†ï¼Œå¯ä»¥åˆ°Bç«™ä¸Šå­¦ä¹ ä¸‹ã€‚</p><p>ç½‘ä¸Šçœ‹åˆ°ä¸é”™çš„ä½œå›¾ï¼Œè´´åœ¨è¿™é‡Œå•¦~</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421194150016.png" alt="image-20240421194150016"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421194201861.png" alt="image-20240421194201861"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421194212043.png" alt="image-20240421194212043"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421194233781.png" alt="image-20240421194233781"></p><p><a href="https://www.processon.com/view/link/65eaae60eaba490be1941ae3">https://www.processon.com/view/link/65eaae60eaba490be1941ae3</a></p><p>å¥½æ–‡æ¨è</p><ul><li><a href="https://mp.weixin.qq.com/s/yyMI3uPvovEr1EgndGro5g">çœ‹ä¸€éå°±æ‡‚ï¼šMVCCåŸç†è¯¦è§£</a></li></ul><p>å¦‚æœæ˜¯å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼Œ äº‹åŠ¡Tå¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾read-viewï¼Œ ä¹‹åäº‹åŠ¡Tæ‰§è¡ŒæœŸé—´ï¼Œ å³ä½¿æœ‰å…¶ä»–äº‹åŠ¡ä¿®æ”¹äº†æ•°æ®ï¼Œ äº‹åŠ¡Tçœ‹åˆ°çš„ä»ç„¶è·Ÿåœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„ä¸€æ ·ã€‚</p><p>begin/start transaction å‘½ä»¤å¹¶ä¸æ˜¯ä¸€ä¸ªäº‹åŠ¡çš„èµ·ç‚¹ï¼Œ åœ¨æ‰§è¡Œåˆ°å®ƒä»¬ä¹‹åçš„ç¬¬ä¸€ä¸ªæ“ä½œInnoDBè¡¨çš„è¯­å¥ï¼Œ äº‹åŠ¡æ‰çœŸæ­£å¯åŠ¨ã€‚ å¦‚æœä½ æƒ³è¦é©¬ä¸Šå¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œ å¯ä»¥ä½¿ç”¨start transaction withconsistent snapshot è¿™ä¸ªå‘½ä»¤ã€‚</p><p>åœ¨MySQLé‡Œï¼Œ æœ‰ä¸¤ä¸ªâ€œè§†å›¾â€çš„æ¦‚å¿µï¼šä¸€ä¸ªæ˜¯viewã€‚ å®ƒæ˜¯ä¸€ä¸ªç”¨æŸ¥è¯¢è¯­å¥å®šä¹‰çš„è™šæ‹Ÿè¡¨ï¼Œ åœ¨è°ƒç”¨çš„æ—¶å€™æ‰§è¡ŒæŸ¥è¯¢è¯­å¥å¹¶ç”Ÿæˆç»“æœã€‚åˆ›å»ºè§†å›¾çš„è¯­æ³•æ˜¯create view â€¦ï¼Œ è€Œå®ƒçš„æŸ¥è¯¢æ–¹æ³•ä¸è¡¨ä¸€æ ·ã€‚å¦ä¸€ä¸ªæ˜¯InnoDBåœ¨å®ç°MVCCæ—¶ç”¨åˆ°çš„ä¸€è‡´æ€§è¯»è§†å›¾ï¼Œ å³consistent read viewï¼Œ ç”¨äºæ”¯æŒRCï¼ˆRead Committedï¼Œ è¯»æäº¤ï¼‰ å’ŒRRï¼ˆ Repeatable Readï¼Œ å¯é‡å¤è¯»ï¼‰ éš”ç¦»çº§åˆ«çš„å®ç°ã€‚</p><p><strong>â€œå¿«ç…§â€åœ¨MVCCé‡Œæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ</strong></p><p>InnoDBé‡Œé¢æ¯ä¸ªäº‹åŠ¡æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡IDï¼Œ å«ä½œtransaction idã€‚ å®ƒæ˜¯åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å‘InnoDBçš„äº‹åŠ¡ç³»ç»Ÿç”³è¯·çš„ï¼Œ æ˜¯æŒ‰ç”³è¯·é¡ºåºä¸¥æ ¼é€’å¢çš„ã€‚è€Œæ¯è¡Œæ•°æ®ä¹Ÿéƒ½æ˜¯æœ‰å¤šä¸ªç‰ˆæœ¬çš„ã€‚ æ¯æ¬¡äº‹åŠ¡æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œ éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œ å¹¶ä¸”æŠŠtransaction idèµ‹å€¼ç»™è¿™ä¸ªæ•°æ®ç‰ˆæœ¬çš„äº‹åŠ¡IDï¼Œ è®°ä¸ºrow trx_idã€‚ åŒæ—¶ï¼Œ æ—§çš„æ•°æ®ç‰ˆæœ¬è¦ä¿ç•™ï¼Œå¹¶ä¸”åœ¨æ–°çš„æ•°æ®ç‰ˆæœ¬ä¸­ï¼Œ èƒ½å¤Ÿæœ‰ä¿¡æ¯å¯ä»¥ç›´æ¥æ‹¿åˆ°å®ƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ æ•°æ®è¡¨ä¸­çš„ä¸€è¡Œè®°å½•ï¼Œ å…¶å®å¯èƒ½æœ‰å¤šä¸ªç‰ˆæœ¬(row)ï¼Œ æ¯ä¸ªç‰ˆæœ¬æœ‰è‡ªå·±çš„row trx_idã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421194335011.png" alt="image-20240421194335011"></p><p>å®é™…ä¸Šï¼Œ å›¾2ä¸­çš„ä¸‰ä¸ªè™šçº¿ç®­å¤´ï¼Œ å°±æ˜¯undo logï¼› è€ŒV1ã€ V2ã€ V3å¹¶ä¸æ˜¯ç‰©ç†ä¸ŠçœŸå®å­˜åœ¨çš„ï¼Œ è€Œæ˜¯æ¯æ¬¡éœ€è¦çš„æ—¶å€™æ ¹æ®å½“å‰ç‰ˆæœ¬å’Œundo logè®¡ç®—å‡ºæ¥çš„ã€‚ æ¯”å¦‚ï¼Œ éœ€è¦V2çš„æ—¶å€™ï¼Œ å°±æ˜¯é€šè¿‡V4ä¾æ¬¡æ‰§è¡ŒU3ã€ U2ç®—å‡ºæ¥ã€‚</p><p>InnoDBä¸ºæ¯ä¸ªäº‹åŠ¡æ„é€ äº†ä¸€ä¸ªæ•°ç»„ï¼Œ ç”¨æ¥ä¿å­˜è¿™ä¸ªäº‹åŠ¡å¯åŠ¨ç¬é—´ï¼Œ å½“å‰æ­£åœ¨â€œæ´»è·ƒâ€çš„æ‰€æœ‰äº‹åŠ¡IDã€‚ â€œæ´»è·ƒâ€æŒ‡çš„å°±æ˜¯ï¼Œ å¯åŠ¨äº†ä½†è¿˜æ²¡æäº¤ã€‚</p><p>æ›´æ–°æ•°æ®éƒ½æ˜¯å…ˆè¯»åå†™çš„ï¼Œ è€Œè¿™ä¸ªè¯»ï¼Œ åªèƒ½è¯»å½“å‰çš„å€¼ï¼Œ ç§°ä¸ºâ€œå½“å‰è¯»â€ï¼ˆ current readï¼‰ ã€‚</p><p>InnoDBçš„è¡Œæ•°æ®æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œ æ¯ä¸ªæ•°æ®ç‰ˆæœ¬æœ‰è‡ªå·±çš„row trx_idï¼Œ æ¯ä¸ªäº‹åŠ¡æˆ–è€…è¯­å¥æœ‰è‡ªå·±çš„ä¸€è‡´æ€§è§†å›¾ã€‚ æ™®é€šæŸ¥è¯¢è¯­å¥æ˜¯ä¸€è‡´æ€§è¯»ï¼Œ ä¸€è‡´æ€§è¯»ä¼šæ ¹æ®row trx_idå’Œä¸€è‡´æ€§è§†å›¾ç¡®å®šæ•°æ®ç‰ˆæœ¬çš„å¯è§æ€§ã€‚</p><p>ï¿® å¯¹äºå¯é‡å¤è¯»ï¼Œ æŸ¥è¯¢åªæ‰¿è®¤åœ¨äº‹åŠ¡å¯åŠ¨å‰å°±å·²ç»æäº¤å®Œæˆçš„æ•°æ®ï¼›</p><p>ï¿® å¯¹äºè¯»æäº¤ï¼Œ æŸ¥è¯¢åªæ‰¿è®¤åœ¨è¯­å¥å¯åŠ¨å‰å°±å·²ç»æäº¤å®Œæˆçš„æ•°æ®ï¼›</p><p>ï¿® è€Œå½“å‰è¯»ï¼Œ æ€»æ˜¯è¯»å–å·²ç»æäº¤å®Œæˆçš„æœ€æ–°ç‰ˆæœ¬ã€‚</p><h2 id="09-æ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•ï¼Œ-åº”è¯¥æ€ä¹ˆé€‰æ‹©ï¼Ÿ"><strong>09 | æ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•ï¼Œ</strong> <strong>åº”è¯¥æ€ä¹ˆé€‰æ‹©ï¼Ÿ</strong></h2><p>ä»æ€§èƒ½çš„è§’åº¦è€ƒè™‘ï¼Œ ä½ é€‰æ‹©å”¯ä¸€ç´¢å¼•è¿˜æ˜¯æ™®é€šç´¢å¼•å‘¢ï¼Ÿ é€‰æ‹©çš„ä¾æ®æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421194340923.png" alt="image-20240421194340923"></p><p><strong>æŸ¥è¯¢è¿‡ç¨‹</strong></p><p>å‡è®¾ï¼Œæ‰§è¡ŒæŸ¥è¯¢çš„è¯­å¥æ˜¯ select id from T where k=5ã€‚è¿™ä¸ªæŸ¥è¯¢è¯­å¥åœ¨ç´¢å¼•æ ‘ä¸ŠæŸ¥æ‰¾çš„è¿‡ç¨‹ï¼Œå…ˆæ˜¯é€šè¿‡B+æ ‘ä»æ ‘æ ¹å¼€å§‹ï¼ŒæŒ‰å±‚æœç´¢åˆ°å¶å­èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­å³ä¸‹è§’çš„è¿™ä¸ªæ•°æ®é¡µï¼Œç„¶åå¯ä»¥è®¤ä¸ºæ•°æ®é¡µå†…éƒ¨é€šè¿‡äºŒåˆ†æ³•æ¥å®šä½è®°å½•ã€‚</p><ul><li>å¯¹äºæ™®é€šç´¢å¼•æ¥è¯´ï¼ŒæŸ¥æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªè®°å½•(5,500)åï¼Œéœ€è¦æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè®°å½•ï¼Œç›´åˆ°ç¢°åˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³k=5æ¡ä»¶çš„è®°å½•ã€‚</li><li>å¯¹äºå”¯ä¸€ç´¢å¼•æ¥è¯´ï¼Œç”±äºç´¢å¼•å®šä¹‰äº†å”¯ä¸€æ€§ï¼ŒæŸ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„è®°å½•åï¼Œå°±ä¼šåœæ­¢ç»§ç»­æ£€ç´¢ã€‚</li></ul><p>é‚£ä¹ˆï¼Œè¿™ä¸ªä¸åŒå¸¦æ¥çš„æ€§èƒ½å·®è·ä¼šæœ‰å¤šå°‘å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œå¾®ä¹å…¶å¾®ã€‚</p><p>InnoDBçš„æ•°æ®æ˜¯æŒ‰æ•°æ®é¡µä¸ºå•ä½æ¥è¯»å†™çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“éœ€è¦è¯»ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯å°†è¿™ä¸ªè®°å½•æœ¬èº«ä»ç£ç›˜è¯»å‡ºæ¥ï¼Œè€Œæ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œå°†å…¶æ•´ä½“è¯»å…¥å†…å­˜ã€‚åœ¨InnoDBä¸­ï¼Œæ¯ä¸ªæ•°æ®é¡µçš„å¤§å°é»˜è®¤æ˜¯16KBã€‚</p><p>å› ä¸ºå¼•æ“æ˜¯æŒ‰é¡µè¯»å†™çš„ï¼Œæ‰€ä»¥è¯´ï¼Œå½“æ‰¾åˆ°k=5çš„è®°å½•çš„æ—¶å€™ï¼Œå®ƒæ‰€åœ¨çš„æ•°æ®é¡µå°±éƒ½åœ¨å†…å­˜é‡Œäº†ã€‚é‚£ä¹ˆï¼Œå¯¹äºæ™®é€šç´¢å¼•æ¥è¯´ï¼Œè¦å¤šåšçš„é‚£ä¸€æ¬¡â€œæŸ¥æ‰¾å’Œåˆ¤æ–­ä¸‹ä¸€æ¡è®°å½•â€çš„æ“ä½œï¼Œå°±åªéœ€è¦ä¸€æ¬¡æŒ‡é’ˆå¯»æ‰¾å’Œä¸€æ¬¡è®¡ç®—ã€‚</p><p><strong>æ›´æ–°è¿‡ç¨‹</strong></p><p>å…ˆä»‹ç»ä¸€ä¸‹change bufferã€‚</p><p>å½“éœ€è¦æ›´æ–°ä¸€ä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœæ•°æ®é¡µåœ¨å†…å­˜ä¸­å°±ç›´æ¥æ›´æ–°ï¼Œè€Œå¦‚æœè¿™ä¸ªæ•°æ®é¡µè¿˜æ²¡æœ‰åœ¨å†…å­˜ä¸­çš„è¯ï¼Œåœ¨ä¸å½±å“æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹ï¼ŒInooDBä¼šå°†è¿™äº›æ›´æ–°æ“ä½œç¼“å­˜åœ¨change bufferä¸­ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä»ç£ç›˜ä¸­è¯»å…¥è¿™ä¸ªæ•°æ®é¡µäº†ã€‚åœ¨ä¸‹æ¬¡æŸ¥è¯¢éœ€è¦è®¿é—®è¿™ä¸ªæ•°æ®é¡µçš„æ—¶å€™ï¼Œå°†æ•°æ®é¡µè¯»å…¥å†…å­˜ï¼Œç„¶åæ‰§è¡Œchange bufferä¸­ä¸è¿™ä¸ªé¡µæœ‰å…³çš„æ“ä½œã€‚é€šè¿‡è¿™ç§æ–¹å¼å°±èƒ½ä¿è¯è¿™ä¸ªæ•°æ®é€»è¾‘çš„æ­£ç¡®æ€§ã€‚</p><p>è™½ç„¶åå­—å«ä½œchange bufferï¼Œå®é™…ä¸Šå®ƒæ˜¯å¯ä»¥æŒä¹…åŒ–çš„æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œchange bufferåœ¨å†…å­˜ä¸­æœ‰æ‹·è´ï¼Œä¹Ÿä¼šè¢«å†™å…¥åˆ°ç£ç›˜ä¸Šã€‚</p><p>å°†change bufferä¸­çš„æ“ä½œåº”ç”¨åˆ°åŸæ•°æ®é¡µï¼Œå¾—åˆ°æœ€æ–°ç»“æœçš„è¿‡ç¨‹ç§°ä¸ºmergeã€‚é™¤äº†è®¿é—®è¿™ä¸ªæ•°æ®é¡µä¼šè§¦å‘mergeå¤–ï¼Œç³»ç»Ÿæœ‰åå°çº¿ç¨‹ä¼šå®šæœŸmergeã€‚åœ¨æ•°æ®åº“æ­£å¸¸å…³é—­ï¼ˆshutdownï¼‰çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šæ‰§è¡Œmergeæ“ä½œã€‚</p><p><strong>pro</strong>:ä»€ä¹ˆæ¡ä»¶ä¸‹å¯ä»¥ä½¿ç”¨change bufferå‘¢ï¼Ÿ</p><p><strong>ans</strong>ï¼šå”¯ä¸€ç´¢å¼•çš„æ›´æ–°å°±ä¸èƒ½ä½¿ç”¨change bufferï¼Œå®é™…ä¸Šä¹Ÿåªæœ‰æ™®é€šç´¢å¼•å¯ä»¥ä½¿ç”¨ã€‚</p><p>ä»‹ç»å®Œchange buffer,æ¥è¯´è¯´æ›´æ–°è¿‡ç¨‹ï¼Œåˆ†ä¸º2ä¸ªcaseã€‚</p><p>ç¬¬ä¸€ç§æƒ…å†µæ˜¯ï¼Œ<strong>è¿™ä¸ªè®°å½•è¦æ›´æ–°çš„ç›®æ ‡é¡µåœ¨å†…å­˜ä¸­</strong>ã€‚è¿™æ—¶ï¼ŒInnoDBçš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å¯¹äºå”¯ä¸€ç´¢å¼•æ¥è¯´ï¼Œæ‰¾åˆ°3å’Œ5ä¹‹é—´çš„ä½ç½®ï¼Œåˆ¤æ–­åˆ°æ²¡æœ‰å†²çªï¼Œæ’å…¥è¿™ä¸ªå€¼ï¼Œè¯­å¥æ‰§è¡Œç»“æŸï¼›</li><li>å¯¹äºæ™®é€šç´¢å¼•æ¥è¯´ï¼Œæ‰¾åˆ°3å’Œ5ä¹‹é—´çš„ä½ç½®ï¼Œæ’å…¥è¿™ä¸ªå€¼ï¼Œè¯­å¥æ‰§è¡Œç»“æŸã€‚</li></ul><p>è¿™æ ·çœ‹æ¥ï¼Œæ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•å¯¹æ›´æ–°è¯­å¥æ€§èƒ½å½±å“çš„å·®åˆ«ï¼Œåªæ˜¯ä¸€ä¸ªåˆ¤æ–­ï¼Œåªä¼šè€—è´¹å¾®å°çš„CPUæ—¶é—´ã€‚</p><p>ç¬¬äºŒç§æƒ…å†µæ˜¯ï¼Œ<strong>è¿™ä¸ªè®°å½•è¦æ›´æ–°çš„ç›®æ ‡é¡µä¸åœ¨å†…å­˜ä¸­</strong>ã€‚è¿™æ—¶ï¼ŒInnoDBçš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å¯¹äºå”¯ä¸€ç´¢å¼•æ¥è¯´ï¼Œéœ€è¦å°†æ•°æ®é¡µè¯»å…¥å†…å­˜ï¼Œåˆ¤æ–­åˆ°æ²¡æœ‰å†²çªï¼Œæ’å…¥è¿™ä¸ªå€¼ï¼Œè¯­å¥æ‰§è¡Œç»“æŸï¼›</li><li>å¯¹äºæ™®é€šç´¢å¼•æ¥è¯´ï¼Œåˆ™æ˜¯å°†æ›´æ–°è®°å½•åœ¨change bufferï¼Œè¯­å¥æ‰§è¡Œå°±ç»“æŸäº†ã€‚</li></ul><p>å°†æ•°æ®ä»ç£ç›˜è¯»å…¥å†…å­˜æ¶‰åŠéšæœºIOçš„è®¿é—®ï¼Œæ˜¯æ•°æ®åº“é‡Œé¢æˆæœ¬æœ€é«˜çš„æ“ä½œä¹‹ä¸€ã€‚change bufferå› ä¸ºå‡å°‘äº†éšæœºç£ç›˜è®¿é—®ï¼Œæ‰€ä»¥å¯¹æ›´æ–°æ€§èƒ½çš„æå‡æ˜¯ä¼šå¾ˆæ˜æ˜¾çš„ã€‚</p><p><strong>change bufferä½¿ç”¨åœºæ™¯</strong></p><p>å…ˆæ¥ä¸€ä¸ªé—®é¢˜ï¼šæ™®é€šç´¢å¼•çš„æ‰€æœ‰åœºæ™¯ï¼Œä½¿ç”¨change bufferéƒ½å¯ä»¥èµ·åˆ°åŠ é€Ÿä½œç”¨å—ï¼Ÿ</p><p>å¿ƒä¸­æœ‰ä¸ªæœ€åˆçš„åŸåˆ™ï¼šchange bufferçš„ä¸»è¦ç›®çš„å°±æ˜¯å°†è®°å½•çš„å˜æ›´åŠ¨ä½œç¼“å­˜ä¸‹æ¥ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªæ•°æ®é¡µåšmergeä¹‹å‰ï¼Œchange bufferè®°å½•çš„å˜æ›´è¶Šå¤šï¼ˆä¹Ÿå°±æ˜¯è¿™ä¸ªé¡µé¢ä¸Šè¦æ›´æ–°çš„æ¬¡æ•°è¶Šå¤šï¼‰ï¼Œæ”¶ç›Šå°±è¶Šå¤§ã€‚</p><p>å› æ­¤ï¼Œå¯¹äºå†™å¤šè¯»å°‘çš„ä¸šåŠ¡æ¥è¯´ï¼Œé¡µé¢åœ¨å†™å®Œä»¥åé©¬ä¸Šè¢«è®¿é—®åˆ°çš„æ¦‚ç‡æ¯”è¾ƒå°ï¼Œæ­¤æ—¶change bufferçš„ä½¿ç”¨æ•ˆæœæœ€å¥½ã€‚</p><p>æœ‰å¥½çš„åœºæ™¯å½“ç„¶ä¹Ÿæœ‰ä¸å¥½çš„åœºæ™¯ã€‚</p><p>ä¸å¥½çš„åœºæ™¯å°±æ˜¯å‡è®¾ä¸€ä¸ªä¸šåŠ¡çš„æ›´æ–°æ¨¡å¼æ˜¯å†™å…¥ä¹‹åé©¬ä¸Šä¼šåšæŸ¥è¯¢ï¼Œé‚£ä¹ˆå³ä½¿æ»¡è¶³äº†æ¡ä»¶ï¼Œå°†æ›´æ–°å…ˆè®°å½•åœ¨change bufferï¼Œä½†ä¹‹åç”±äºé©¬ä¸Šè¦è®¿é—®è¿™ä¸ªæ•°æ®é¡µï¼Œä¼šç«‹å³è§¦å‘mergeè¿‡ç¨‹ã€‚è¿™æ ·éšæœºè®¿é—®IOçš„æ¬¡æ•°ä¸ä¼šå‡å°‘ï¼Œåè€Œå¢åŠ äº†change bufferçš„ç»´æŠ¤ä»£ä»·ã€‚æ‰€ä»¥ï¼Œå¯¹äºè¿™ç§ä¸šåŠ¡æ¨¡å¼æ¥è¯´ï¼Œchange bufferåè€Œèµ·åˆ°äº†å‰¯ä½œç”¨ã€‚</p><p><strong>ç´¢å¼•é€‰æ‹©å’Œå®è·µ</strong></p><p>æ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•åº”è¯¥æ€ä¹ˆé€‰æ‹©ã€‚å…¶å®ï¼Œè¿™ä¸¤ç±»ç´¢å¼•åœ¨æŸ¥è¯¢èƒ½åŠ›ä¸Šæ˜¯æ²¡å·®åˆ«çš„ï¼Œä¸»è¦è€ƒè™‘çš„æ˜¯å¯¹æ›´æ–°æ€§èƒ½çš„å½±å“ã€‚æ‰€ä»¥ï¼Œå»ºè®®ä½ å°½é‡é€‰æ‹©æ™®é€šç´¢å¼•</p><p>å¦‚æœæ‰€æœ‰çš„æ›´æ–°åé¢ï¼Œéƒ½é©¬ä¸Šä¼´éšç€å¯¹è¿™ä¸ªè®°å½•çš„æŸ¥è¯¢ï¼Œé‚£ä¹ˆä½ åº”è¯¥å…³é—­change bufferã€‚è€Œåœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œchange bufferéƒ½èƒ½æå‡æ›´æ–°æ€§èƒ½ã€‚</p><p><strong>change buffer å’Œ redo log</strong></p><p>æ¥ä¸‹æ¥å…¶å®ä¸»è¦å°±æ˜¯åŒºåˆ†redo logå’Œchange bufferã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬è¦åœ¨è¡¨ä¸Šæ‰§è¡Œè¿™ä¸ªæ’å…¥è¯­å¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t(id,k) <span class="keyword">values</span>(id1,k1),(id2,k2);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘ä»¬å‡è®¾å½“å‰kç´¢å¼•æ ‘çš„çŠ¶æ€ï¼ŒæŸ¥æ‰¾åˆ°ä½ç½®åï¼Œk1æ‰€åœ¨çš„æ•°æ®é¡µåœ¨å†…å­˜(InnoDB buffer pool)ä¸­ï¼Œk2æ‰€åœ¨çš„æ•°æ®é¡µä¸åœ¨å†…å­˜ä¸­ã€‚å¦‚å›¾2æ‰€ç¤ºæ˜¯å¸¦change bufferçš„æ›´æ–°çŠ¶æ€å›¾ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421195152846.png" alt="image-20240421195152846"></p><p>åˆ†æè¿™æ¡æ›´æ–°è¯­å¥ï¼Œä½ ä¼šå‘ç°å®ƒæ¶‰åŠäº†å››ä¸ªéƒ¨åˆ†ï¼šå†…å­˜ã€redo logï¼ˆib_log_fileXï¼‰ã€ æ•°æ®è¡¨ç©ºé—´ï¼ˆt.ibdï¼‰ã€ç³»ç»Ÿè¡¨ç©ºé—´ï¼ˆibdata1ï¼‰ã€‚</p><p>è¿™æ¡æ›´æ–°è¯­å¥åšäº†å¦‚ä¸‹çš„æ“ä½œï¼ˆæŒ‰ç…§å›¾ä¸­çš„æ•°å­—é¡ºåºï¼‰ï¼š</p><ol><li>Page 1åœ¨å†…å­˜ä¸­ï¼Œç›´æ¥æ›´æ–°å†…å­˜ï¼›</li><li>Page 2æ²¡æœ‰åœ¨å†…å­˜ä¸­ï¼Œå°±åœ¨å†…å­˜çš„change bufferåŒºåŸŸï¼Œè®°å½•ä¸‹â€œæˆ‘è¦å¾€Page 2æ’å…¥ä¸€è¡Œâ€è¿™ä¸ªä¿¡æ¯</li><li>å°†ä¸Šè¿°ä¸¤ä¸ªåŠ¨ä½œè®°å…¥redo logä¸­ï¼ˆå›¾ä¸­3å’Œ4ï¼‰ã€‚</li></ol><p>åšå®Œä¸Šé¢è¿™äº›ï¼Œäº‹åŠ¡å°±å¯ä»¥å®Œæˆäº†ã€‚æ‰€ä»¥ï¼Œä½ ä¼šçœ‹åˆ°ï¼Œæ‰§è¡Œè¿™æ¡æ›´æ–°è¯­å¥çš„æˆæœ¬å¾ˆä½ï¼Œå°±æ˜¯å†™äº†ä¸¤å¤„å†…å­˜ï¼Œç„¶åå†™äº†ä¸€å¤„ç£ç›˜ï¼ˆä¸¤æ¬¡æ“ä½œåˆåœ¨ä¸€èµ·å†™äº†ä¸€æ¬¡ç£ç›˜ï¼‰ï¼Œè€Œä¸”è¿˜æ˜¯é¡ºåºå†™çš„ã€‚</p><p>åŒæ—¶ï¼Œå›¾ä¸­çš„ä¸¤ä¸ªè™šçº¿ç®­å¤´ï¼Œæ˜¯åå°æ“ä½œï¼Œä¸å½±å“æ›´æ–°çš„å“åº”æ—¶é—´ã€‚</p><p>ç°åœ¨è¦æ‰§è¡Œ select * from t where k in (k1, k2)ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421195257043.png" alt="image-20240421195257043"></p><ol><li>è¯»Page 1çš„æ—¶å€™ï¼Œç›´æ¥ä»å†…å­˜è¿”å›ã€‚æœ‰å‡ ä½åŒå­¦åœ¨å‰é¢æ–‡ç« çš„è¯„è®ºä¸­é—®åˆ°ï¼ŒWALä¹‹åå¦‚æœè¯»æ•°æ®ï¼Œæ˜¯ä¸æ˜¯ä¸€å®šè¦è¯»ç›˜ï¼Œæ˜¯ä¸æ˜¯ä¸€å®šè¦ä»redo logé‡Œé¢æŠŠæ•°æ®æ›´æ–°ä»¥åæ‰å¯ä»¥è¿”å›ï¼Ÿå…¶å®æ˜¯ä¸ç”¨çš„ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹å›¾3çš„è¿™ä¸ªçŠ¶æ€ï¼Œè™½ç„¶ç£ç›˜ä¸Šè¿˜æ˜¯ä¹‹å‰çš„æ•°æ®ï¼Œä½†æ˜¯è¿™é‡Œç›´æ¥ä»å†…å­˜è¿”å›ç»“æœï¼Œç»“æœæ˜¯æ­£ç¡®çš„ã€‚</li><li>è¦è¯»Page 2çš„æ—¶å€™ï¼Œéœ€è¦æŠŠPage 2ä»ç£ç›˜è¯»å…¥å†…å­˜ä¸­ï¼Œç„¶ååº”ç”¨change bufferé‡Œé¢çš„æ“ä½œæ—¥å¿—ï¼Œç”Ÿæˆä¸€ä¸ªæ­£ç¡®çš„ç‰ˆæœ¬å¹¶è¿”å›ç»“æœã€‚</li></ol><p>å¯ä»¥çœ‹åˆ°ï¼Œç›´åˆ°éœ€è¦è¯»Page 2çš„æ—¶å€™ï¼Œè¿™ä¸ªæ•°æ®é¡µæ‰ä¼šè¢«è¯»å…¥å†…å­˜ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœè¦ç®€å•åœ°å¯¹æ¯”è¿™ä¸¤ä¸ªæœºåˆ¶åœ¨æå‡æ›´æ–°æ€§èƒ½ä¸Šçš„æ”¶ç›Šçš„è¯ï¼Œ<strong>redo log ä¸»è¦èŠ‚çœçš„æ˜¯éšæœºå†™ç£ç›˜çš„IOæ¶ˆè€—ï¼ˆè½¬æˆé¡ºåºå†™ï¼‰ï¼Œè€Œchange bufferä¸»è¦èŠ‚çœçš„åˆ™æ˜¯éšæœºè¯»ç£ç›˜çš„IOæ¶ˆè€—ã€‚</strong></p><p>**æ¥ä¸ªé—®é¢˜ï¼š**å¦‚æœæŸæ¬¡å†™å…¥ä½¿ç”¨äº†change bufferæœºåˆ¶ï¼Œä¹‹åä¸»æœºå¼‚å¸¸é‡å¯ï¼Œæ˜¯å¦ä¼šä¸¢å¤±change bufferå’Œæ•°æ®ã€‚</p><p>è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯ä¸ä¼šä¸¢å¤±ã€‚è™½ç„¶æ˜¯åªæ›´æ–°å†…å­˜ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠchange bufferçš„æ“ä½œä¹Ÿè®°å½•åˆ°redo logé‡Œäº†ï¼Œæ‰€ä»¥å´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œchange bufferä¹Ÿèƒ½æ‰¾å›æ¥ã€‚</p><h2 id="10-MySQLä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¼šé€‰é”™ç´¢å¼•ï¼Ÿ"><strong>10 | MySQLä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¼šé€‰é”™ç´¢å¼•ï¼Ÿ</strong></h2><p>ã€ä¼˜åŒ–å™¨å·¥ä½œåŸç†ã€‘</p><p>ä¸€ç§æ–¹æ³•æ˜¯ï¼Œ åƒæˆ‘ä»¬ç¬¬ä¸€ä¸ªä¾‹å­ä¸€æ ·ï¼Œ é‡‡ç”¨force indexå¼ºè¡Œé€‰æ‹©ä¸€ä¸ªç´¢å¼•ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯ï¼Œ æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¿®æ”¹ è¯­å¥ï¼Œ å¼•å¯¼MySQLä½¿ç”¨æˆ‘ä»¬æœŸæœ›çš„ç´¢å¼•ã€‚ æ¯”å¦‚ï¼Œ åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œ æ˜¾ç„¶æŠŠâ€œorder byb limit 1â€ æ”¹æˆ â€œorder byb,a limit 1â€ ï¼Œ è¯­ä¹‰çš„é€»è¾‘æ˜¯ç›¸åŒçš„ã€‚</p><p>ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ï¼Œ åœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œ æˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªæ›´åˆé€‚çš„ç´¢å¼•ï¼Œ æ¥æä¾›ç»™ä¼˜åŒ–å™¨åšé€‰æ‹©ï¼Œ æˆ–åˆ æ‰è¯¯ç”¨çš„ç´¢å¼•ã€‚</p><h2 id="11-æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µåŠ ç´¢å¼•ï¼Ÿ"><strong>11 | æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µåŠ ç´¢å¼•ï¼Ÿ</strong></h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> SUser <span class="keyword">add</span> index index1(email);</span><br><span class="line">æˆ–</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> SUser <span class="keyword">add</span> index index2(email(<span class="number">6</span>));</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªè¯­å¥åˆ›å»ºçš„index1ç´¢å¼•é‡Œé¢ï¼Œ åŒ…å«äº†æ¯ä¸ªè®°å½•çš„æ•´ä¸ªå­—ç¬¦ä¸²ï¼› è€Œç¬¬äºŒä¸ªè¯­å¥åˆ›å»ºçš„index2ç´¢å¼•é‡Œé¢ï¼Œ å¯¹äºæ¯ä¸ªè®°å½•éƒ½æ˜¯åªå–å‰6ä¸ªå­—èŠ‚ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421195513438.png" alt="image-20240421195513438"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421195518185.png" alt="image-20240421195518185"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,email <span class="keyword">from</span> SUser <span class="keyword">where</span> email<span class="operator">=</span><span class="string">&#x27;zhangssxyz@xxx.com&#x27;</span>;</span><br></pre></td></tr></table></figure><p><strong>å¦‚æœä½¿ç”¨çš„æ˜¯index1</strong>ï¼ˆå³emailæ•´ä¸ªå­—ç¬¦ä¸²çš„ç´¢å¼•ç»“æ„ï¼‰ï¼Œæ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š</p><ol><li>ä»index1ç´¢å¼•æ ‘æ‰¾åˆ°æ»¡è¶³ç´¢å¼•å€¼æ˜¯â€™zhangssxyz@xxx.comâ€™çš„è¿™æ¡è®°å½•ï¼Œå–å¾—ID2çš„å€¼ï¼›</li><li>åˆ°ä¸»é”®ä¸ŠæŸ¥åˆ°ä¸»é”®å€¼æ˜¯ID2çš„è¡Œï¼Œåˆ¤æ–­emailçš„å€¼æ˜¯æ­£ç¡®çš„ï¼Œå°†è¿™è¡Œè®°å½•åŠ å…¥ç»“æœé›†ï¼›</li><li>å–index1ç´¢å¼•æ ‘ä¸ŠåˆšåˆšæŸ¥åˆ°çš„ä½ç½®çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œå‘ç°å·²ç»ä¸æ»¡è¶³email='zhangssxyz@xxx.comâ€™çš„æ¡ä»¶äº†ï¼Œå¾ªç¯ç»“æŸã€‚</li></ol><p>è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªéœ€è¦å›ä¸»é”®ç´¢å¼•å–ä¸€æ¬¡æ•°æ®ï¼Œæ‰€ä»¥ç³»ç»Ÿè®¤ä¸ºåªæ‰«æäº†ä¸€è¡Œã€‚</p><p><strong>å¦‚æœä½¿ç”¨çš„æ˜¯index2</strong>ï¼ˆå³email(6)ç´¢å¼•ç»“æ„ï¼‰ï¼Œæ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š</p><ol><li>ä»index2ç´¢å¼•æ ‘æ‰¾åˆ°æ»¡è¶³ç´¢å¼•å€¼æ˜¯â€™zhangsâ€™çš„è®°å½•ï¼Œæ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªæ˜¯ID1ï¼›</li><li>åˆ°ä¸»é”®ä¸ŠæŸ¥åˆ°ä¸»é”®å€¼æ˜¯ID1çš„è¡Œï¼Œåˆ¤æ–­å‡ºemailçš„å€¼ä¸æ˜¯â€™zhangssxyz@xxx.comâ€™ï¼Œè¿™è¡Œè®°å½•ä¸¢å¼ƒï¼›</li><li>å–index2ä¸ŠåˆšåˆšæŸ¥åˆ°çš„ä½ç½®çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œå‘ç°ä»ç„¶æ˜¯â€™zhangsâ€™ï¼Œå–å‡ºID2ï¼Œå†åˆ°IDç´¢å¼•ä¸Šå–æ•´è¡Œç„¶ååˆ¤æ–­ï¼Œè¿™æ¬¡å€¼å¯¹äº†ï¼Œå°†è¿™è¡Œè®°å½•åŠ å…¥ç»“æœé›†ï¼›</li><li>é‡å¤ä¸Šä¸€æ­¥ï¼Œç›´åˆ°åœ¨idxe2ä¸Šå–åˆ°çš„å€¼ä¸æ˜¯â€™zhangsâ€™æ—¶ï¼Œå¾ªç¯ç»“æŸã€‚</li></ol><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¦å›ä¸»é”®ç´¢å¼•å–4æ¬¡æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ‰«æäº†4è¡Œã€‚</p><p>é€šè¿‡è¿™ä¸ªå¯¹æ¯”ï¼Œä½ å¾ˆå®¹æ˜“å°±å¯ä»¥å‘ç°ï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•åï¼Œå¯èƒ½ä¼šå¯¼è‡´æŸ¥è¯¢è¯­å¥è¯»æ•°æ®çš„æ¬¡æ•°å˜å¤šã€‚</p><p><strong>ç»“è®ºï¼šä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼Œå®šä¹‰å¥½é•¿åº¦ï¼Œå°±å¯ä»¥åšåˆ°æ—¢èŠ‚çœç©ºé—´ï¼Œåˆä¸ç”¨é¢å¤–å¢åŠ å¤ªå¤šçš„æŸ¥è¯¢æˆæœ¬ã€‚</strong></p><p>æ¥ä¸ªé—®é¢˜ï¼šå½“è¦ç»™å­—ç¬¦ä¸²åˆ›å»ºå‰ç¼€ç´¢å¼•æ—¶ï¼Œæœ‰ä»€ä¹ˆæ–¹æ³•èƒ½å¤Ÿç¡®å®šæˆ‘åº”è¯¥ä½¿ç”¨å¤šé•¿çš„å‰ç¼€å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨å»ºç«‹ç´¢å¼•æ—¶å…³æ³¨çš„æ˜¯åŒºåˆ†åº¦ï¼ŒåŒºåˆ†åº¦è¶Šé«˜è¶Šå¥½ã€‚å› ä¸ºåŒºåˆ†åº¦è¶Šé«˜ï¼Œæ„å‘³ç€é‡å¤çš„é”®å€¼è¶Šå°‘ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»Ÿè®¡ç´¢å¼•ä¸Šæœ‰å¤šå°‘ä¸ªä¸åŒçš„å€¼æ¥åˆ¤æ–­è¦ä½¿ç”¨å¤šé•¿çš„å‰ç¼€ã€‚</p><p>å¸¸ç”¨æ–¹æ³•</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> email) <span class="keyword">as</span> L <span class="keyword">from</span> SUser;</span><br><span class="line"><span class="comment">-----</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> </span><br><span class="line">  <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email,<span class="number">4</span>)ï¼‰<span class="keyword">as</span> L4,</span><br><span class="line">  <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email,<span class="number">5</span>)ï¼‰<span class="keyword">as</span> L5,</span><br><span class="line">  <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email,<span class="number">6</span>)ï¼‰<span class="keyword">as</span> L6,</span><br><span class="line">  <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email,<span class="number">7</span>)ï¼‰<span class="keyword">as</span> L7,</span><br><span class="line"><span class="keyword">from</span> SUser;</span><br></pre></td></tr></table></figure><p><strong>å‰ç¼€ç´¢å¼•å¯¹è¦†ç›–ç´¢å¼•çš„å½±å“</strong></p><p>å…ˆæ¥çœ‹çœ‹è¿™ä¸ªSQLè¯­å¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,email <span class="keyword">from</span> SUser <span class="keyword">where</span> email<span class="operator">=</span><span class="string">&#x27;zhangssxyz@xxx.com&#x27;</span>;</span><br></pre></td></tr></table></figure><p>ä¸å‰é¢ä¾‹å­ä¸­çš„SQLè¯­å¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,email <span class="keyword">from</span> SUser <span class="keyword">where</span> email<span class="operator">=</span><span class="string">&#x27;zhangssxyz@xxx.com&#x27;</span>;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨index1ï¼ˆå³emailæ•´ä¸ªå­—ç¬¦ä¸²çš„ç´¢å¼•ç»“æ„ï¼‰çš„è¯ï¼Œå¯ä»¥åˆ©ç”¨è¦†ç›–ç´¢å¼•ï¼Œä»index1æŸ¥åˆ°ç»“æœåç›´æ¥å°±è¿”å›äº†ï¼Œä¸éœ€è¦å›åˆ°IDç´¢å¼•å†å»æŸ¥ä¸€æ¬¡ã€‚è€Œå¦‚æœä½¿ç”¨index2ï¼ˆå³email(6)ç´¢å¼•ç»“æ„ï¼‰çš„è¯ï¼Œå°±ä¸å¾—ä¸å›åˆ°IDç´¢å¼•å†å»åˆ¤æ–­emailå­—æ®µçš„å€¼ã€‚</p><p>å³ä½¿ä½ å°†index2çš„å®šä¹‰ä¿®æ”¹ä¸ºemail(18)çš„å‰ç¼€ç´¢å¼•ï¼Œè¿™æ—¶å€™è™½ç„¶index2å·²ç»åŒ…å«äº†æ‰€æœ‰çš„ä¿¡æ¯ï¼Œä½†InnoDBè¿˜æ˜¯è¦å›åˆ°idç´¢å¼•å†æŸ¥ä¸€ä¸‹ï¼Œå› ä¸ºç³»ç»Ÿå¹¶ä¸ç¡®å®šå‰ç¼€ç´¢å¼•çš„å®šä¹‰æ˜¯å¦æˆªæ–­äº†å®Œæ•´ä¿¡æ¯ã€‚</p><p><strong>ä½¿ç”¨å‰ç¼€ç´¢å¼•å°±ç”¨ä¸ä¸Šè¦†ç›–ç´¢å¼•å¯¹æŸ¥è¯¢æ€§èƒ½çš„ä¼˜åŒ–</strong>äº†ï¼Œ è¿™ä¹Ÿæ˜¯ä½ åœ¨é€‰æ‹©æ˜¯å¦ä½¿ç”¨å‰ç¼€ç´¢å¼•æ—¶éœ€è¦è€ƒè™‘çš„ä¸€ä¸ªå› ç´ ã€‚</p><p><strong>å…¶ä»–æ–¹å¼</strong></p><p>ç¬¬ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨å€’åºå­˜å‚¨ã€‚</p><p>ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨hashå­—æ®µã€‚</p><p>é¦–å…ˆï¼Œ å®ƒä»¬çš„ç›¸åŒç‚¹æ˜¯ï¼Œ éƒ½ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€‚ å€’åºå­˜å‚¨çš„å­—æ®µä¸Šåˆ›å»ºçš„ç´¢å¼•æ˜¯æŒ‰ç…§å€’åºå­—ç¬¦ä¸²çš„æ–¹å¼æ’åºçš„ï¼Œ å·²ç»æ²¡æœ‰åŠæ³•åˆ©ç”¨ç´¢å¼•æ–¹å¼æŸ¥å‡ºèº«ä»½è¯å·ç åœ¨[ID_X, ID_Y]çš„æ‰€æœ‰å¸‚æ°‘äº†ã€‚ åŒæ ·åœ°ï¼Œ hashå­—æ®µçš„æ–¹å¼ä¹Ÿåªèƒ½æ”¯æŒç­‰å€¼æŸ¥è¯¢ã€‚</p><p>å®ƒä»¬çš„åŒºåˆ«ï¼Œ ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š</p><ol><li>ä»å ç”¨çš„é¢å¤–ç©ºé—´æ¥çœ‹ï¼Œå€’åºå­˜å‚¨æ–¹å¼åœ¨ä¸»é”®ç´¢å¼•ä¸Šï¼Œä¸ä¼šæ¶ˆè€—é¢å¤–çš„å­˜å‚¨ç©ºé—´ï¼Œè€Œhashå­—æ®µæ–¹æ³•éœ€è¦å¢åŠ ä¸€ä¸ªå­—æ®µã€‚å½“ç„¶ï¼Œå€’åºå­˜å‚¨æ–¹å¼ä½¿ç”¨4ä¸ªå­—èŠ‚çš„å‰ç¼€é•¿åº¦åº”è¯¥æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚æœå†é•¿ä¸€ç‚¹ï¼Œè¿™ä¸ªæ¶ˆè€—è·Ÿé¢å¤–è¿™ä¸ªhashå­—æ®µä¹Ÿå·®ä¸å¤šæŠµæ¶ˆäº†ã€‚</li><li>åœ¨CPUæ¶ˆè€—æ–¹é¢ï¼Œå€’åºæ–¹å¼æ¯æ¬¡å†™å’Œè¯»çš„æ—¶å€™ï¼Œéƒ½éœ€è¦é¢å¤–è°ƒç”¨ä¸€æ¬¡reverseå‡½æ•°ï¼Œè€Œhashå­—æ®µçš„æ–¹å¼éœ€è¦é¢å¤–è°ƒç”¨ä¸€æ¬¡crc32()å‡½æ•°ã€‚å¦‚æœåªä»è¿™ä¸¤ä¸ªå‡½æ•°çš„è®¡ç®—å¤æ‚åº¦æ¥çœ‹çš„è¯ï¼Œreverseå‡½æ•°é¢å¤–æ¶ˆè€—çš„CPUèµ„æºä¼šæ›´å°äº›ã€‚</li><li>ä»æŸ¥è¯¢æ•ˆç‡ä¸Šçœ‹ï¼Œä½¿ç”¨hashå­—æ®µæ–¹å¼çš„æŸ¥è¯¢æ€§èƒ½ç›¸å¯¹æ›´ç¨³å®šä¸€äº›ã€‚å› ä¸ºcrc32ç®—å‡ºæ¥çš„å€¼è™½ç„¶æœ‰å†²çªçš„æ¦‚ç‡ï¼Œä½†æ˜¯æ¦‚ç‡éå¸¸å°ï¼Œå¯ä»¥è®¤ä¸ºæ¯æ¬¡æŸ¥è¯¢çš„å¹³å‡æ‰«æè¡Œæ•°æ¥è¿‘1ã€‚è€Œå€’åºå­˜å‚¨æ–¹å¼æ¯•ç«Ÿè¿˜æ˜¯ç”¨çš„å‰ç¼€ç´¢å¼•çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜æ˜¯ä¼šå¢åŠ æ‰«æè¡Œæ•°ã€‚</li></ol><p><strong>æ€»ç»“</strong></p><ol><li>ç›´æ¥åˆ›å»ºå®Œæ•´ç´¢å¼•ï¼Œè¿™æ ·å¯èƒ½æ¯”è¾ƒå ç”¨ç©ºé—´ï¼›</li><li>åˆ›å»ºå‰ç¼€ç´¢å¼•ï¼ŒèŠ‚çœç©ºé—´ï¼Œä½†ä¼šå¢åŠ æŸ¥è¯¢æ‰«ææ¬¡æ•°ï¼Œå¹¶ä¸”ä¸èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼›</li><li>å€’åºå­˜å‚¨ï¼Œå†åˆ›å»ºå‰ç¼€ç´¢å¼•ï¼Œç”¨äºç»•è¿‡å­—ç¬¦ä¸²æœ¬èº«å‰ç¼€çš„åŒºåˆ†åº¦ä¸å¤Ÿçš„é—®é¢˜ï¼›</li><li>åˆ›å»ºhashå­—æ®µç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šï¼Œæœ‰é¢å¤–çš„å­˜å‚¨å’Œè®¡ç®—æ¶ˆè€—ï¼Œè·Ÿç¬¬ä¸‰ç§æ–¹å¼ä¸€æ ·ï¼Œéƒ½ä¸æ”¯æŒèŒƒå›´æ‰«æã€‚</li></ol><h2 id="12-ä¸ºä»€ä¹ˆæˆ‘çš„MySQLä¼šâ€œæŠ–â€ä¸€ä¸‹ï¼Ÿ"><strong>12 | ä¸ºä»€ä¹ˆæˆ‘çš„MySQLä¼šâ€œæŠ–â€ä¸€ä¸‹ï¼Ÿ</strong></h2><p>ã€æ•°æ®åº“ä»£ç ã€‘</p><p>å½“å†…å­˜æ•°æ®é¡µè·Ÿç£ç›˜æ•°æ®é¡µå†…å®¹ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œ æˆ‘ä»¬ç§°è¿™ä¸ªå†…å­˜é¡µä¸ºâ€œè„é¡µâ€ã€‚ å†…å­˜æ•°æ®å†™å…¥åˆ°ç£ç›˜åï¼Œ å†…å­˜å’Œç£ç›˜ä¸Šçš„æ•°æ®é¡µçš„å†…å®¹å°±ä¸€è‡´äº†ï¼Œ ç§°ä¸ºâ€œå¹²å‡€é¡µâ€ã€‚</p><p>ä»€ä¹ˆæ—¶å€™flushï¼Ÿ</p><p>1ï¼šæ˜¯InnoDBçš„redo logå†™æ»¡äº†ã€‚ è¿™æ—¶å€™ç³»ç»Ÿä¼šåœæ­¢æ‰€æœ‰æ›´æ–°æ“ä½œï¼Œ æŠŠ:checkpointå¾€å‰æ¨è¿›ï¼Œ redo logç•™å‡ºç©ºé—´å¯ä»¥ç»§ç»­å†™ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421195941651.png" alt="image-20240421195941651"></p><p>checkpointå¯ä¸æ˜¯éšä¾¿å¾€å‰ä¿®æ”¹ä¸€ä¸‹ä½ç½®å°±å¯ä»¥çš„ã€‚ æ¯”å¦‚å›¾ä¸­ï¼Œ æŠŠcheckpointä½ç½®ä»CPæ¨è¿›åˆ°CPâ€™ï¼Œ å°±éœ€è¦å°†ä¸¤ä¸ªç‚¹ä¹‹é—´çš„æ—¥å¿—ï¼ˆæµ…ç»¿è‰²éƒ¨åˆ†ï¼‰ ï¼Œ å¯¹åº”çš„æ‰€æœ‰è„é¡µéƒ½flushåˆ°ç£ç›˜ä¸Šã€‚ ä¹‹åï¼Œ å›¾ä¸­ä»write posåˆ°CPâ€™ä¹‹é—´å°±æ˜¯å¯ä»¥å†å†™å…¥çš„redo logçš„åŒºåŸŸã€‚</p><p>2ï¼šç³»ç»Ÿå†…å­˜ä¸è¶³ã€‚ å½“éœ€è¦æ–°çš„å†…å­˜é¡µï¼Œ è€Œå†…å­˜ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œ å°±è¦æ·˜æ±°ä¸€äº›æ•°æ®é¡µï¼Œ ç©ºå‡ºå†…å­˜ç»™åˆ«çš„æ•°æ®é¡µä½¿ç”¨ã€‚ å¦‚æœæ·˜æ±°çš„æ˜¯â€œè„é¡µâ€ï¼Œ å°±è¦å…ˆå°†è„é¡µå†™åˆ°ç£ç›˜ã€‚</p><p>3ï¼šMySQLè®¤ä¸ºç³»ç»Ÿâ€œç©ºé—²â€çš„æ—¶å€™ã€‚</p><p>4ï¼šMySQLæ­£å¸¸å…³é—­çš„æƒ…å†µã€‚ è¿™æ—¶å€™ï¼Œ MySQLä¼šæŠŠå†…å­˜çš„è„é¡µéƒ½flushåˆ°ç£ç›˜ä¸Šï¼Œ è¿™æ ·ä¸‹æ¬¡MySQLå¯åŠ¨çš„æ—¶å€™ï¼Œ å°±å¯ä»¥ç›´æ¥ä»ç£ç›˜ä¸Šè¯»æ•°æ®ï¼Œ å¯åŠ¨é€Ÿåº¦ä¼šå¾ˆå¿«ã€‚</p><p>ç¬¬ä¸€ç§æ˜¯â€œredo logå†™æ»¡äº†ï¼Œ è¦flushè„é¡µâ€ï¼Œ è¿™ç§æƒ…å†µæ˜¯InnoDBè¦å°½é‡é¿å…çš„ã€‚ å› ä¸ºå‡ºç°è¿™ç§æƒ…å†µçš„æ—¶å€™ï¼Œ æ•´ä¸ªç³»ç»Ÿå°±ä¸èƒ½å†æ¥å—æ›´æ–°äº†ï¼Œ æ‰€æœ‰çš„æ›´æ–°éƒ½å¿…é¡»å µä½ã€‚</p><p>ç¬¬äºŒç§æ˜¯â€œå†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œ è¦å…ˆå°†è„é¡µå†™åˆ°ç£ç›˜â€ï¼Œ è¿™ç§æƒ…å†µå…¶å®æ˜¯å¸¸æ€ã€‚InnoDBç”¨ç¼“å†²æ± ï¼ˆ buffer poolï¼‰ ç®¡ç†å†…å­˜ï¼Œ ç¼“å†²æ± ä¸­çš„å†…å­˜é¡µæœ‰ä¸‰ç§çŠ¶æ€ï¼šç¬¬ä¸€ç§æ˜¯ï¼Œ è¿˜æ²¡æœ‰ä½¿ç”¨çš„ï¼›ç¬¬äºŒç§æ˜¯ï¼Œ ä½¿ç”¨äº†å¹¶ä¸”æ˜¯å¹²å‡€é¡µï¼›ç¬¬ä¸‰ç§æ˜¯ï¼Œ ä½¿ç”¨äº†å¹¶ä¸”æ˜¯è„é¡µã€‚</p><p>InnoDBçš„åˆ·ç›˜é€Ÿåº¦å°±æ˜¯è¦å‚è€ƒè¿™ä¸¤ä¸ªå› ç´ ï¼š ä¸€ä¸ªæ˜¯è„é¡µæ¯”ä¾‹ï¼Œ ä¸€ä¸ªæ˜¯redo logå†™ç›˜é€Ÿåº¦ã€‚ InnoDBä¼šæ ¹æ®è¿™ä¸¤ä¸ªå› ç´ å…ˆå•ç‹¬ç®—å‡ºä¸¤ä¸ªæ•°å­—ã€‚</p><p>InnoDBæ¯æ¬¡å†™å…¥çš„æ—¥å¿—éƒ½æœ‰ä¸€ä¸ªåºå·ï¼Œ å½“å‰å†™å…¥çš„åºå·è·Ÿcheckpointå¯¹åº”çš„åºå·ä¹‹é—´çš„å·®å€¼ï¼Œæˆ‘ä»¬å‡è®¾ä¸ºNã€‚ InnoDBä¼šæ ¹æ®è¿™ä¸ªNç®—å‡ºä¸€ä¸ªèŒƒå›´åœ¨0åˆ°100ä¹‹é—´çš„æ•°å­—ï¼Œ è¿™ä¸ªè®¡ç®—å…¬å¼å¯ä»¥è®°ä¸ºF2(N)ã€‚ F2(N)ç®—æ³•æ¯”è¾ƒå¤æ‚ï¼Œ ä½ åªè¦çŸ¥é“Nè¶Šå¤§ï¼Œ ç®—å‡ºæ¥çš„å€¼è¶Šå¤§å°±å¥½äº†ã€‚ç„¶åï¼Œ æ ¹æ®ä¸Šè¿°ç®—å¾—çš„F1(M)å’ŒF2(N)ä¸¤ä¸ªå€¼ï¼Œ å–å…¶ä¸­è¾ƒå¤§çš„å€¼è®°ä¸ºRï¼Œ ä¹‹åå¼•æ“å°±å¯ä»¥æŒ‰ç…§innodb_io_capacityå®šä¹‰çš„èƒ½åŠ›ä¹˜ä»¥R%æ¥æ§åˆ¶åˆ·è„é¡µçš„é€Ÿåº¦ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421195954851.png" alt="image-20240421195954851"></p><p>ç°åœ¨ä½ çŸ¥é“äº†ï¼Œ InnoDBä¼šåœ¨åå°åˆ·è„é¡µï¼Œ è€Œåˆ·è„é¡µçš„è¿‡ç¨‹æ˜¯è¦å°†å†…å­˜é¡µå†™å…¥ç£ç›˜ã€‚ æ‰€ä»¥ï¼Œ æ— è®ºæ˜¯ä½ çš„æŸ¥è¯¢è¯­å¥åœ¨éœ€è¦å†…å­˜çš„æ—¶å€™å¯èƒ½è¦æ±‚æ·˜æ±°ä¸€ä¸ªè„é¡µï¼Œ è¿˜æ˜¯ç”±äºåˆ·è„é¡µçš„é€»è¾‘ä¼šå ç”¨IOèµ„æºå¹¶å¯èƒ½å½±å“åˆ°äº†ä½ çš„æ›´æ–°è¯­å¥</p><p>è€ŒMySQLä¸­çš„ä¸€ä¸ªæœºåˆ¶ï¼Œ å¯èƒ½è®©ä½ çš„æŸ¥è¯¢ä¼šæ›´æ…¢ï¼š åœ¨å‡†å¤‡åˆ·ä¸€ä¸ªè„é¡µçš„æ—¶å€™ï¼Œ å¦‚æœè¿™ä¸ªæ•°æ®é¡µæ—è¾¹çš„æ•°æ®é¡µåˆšå¥½æ˜¯è„é¡µï¼Œ å°±ä¼šæŠŠè¿™ä¸ªâ€œé‚»å±…â€ä¹Ÿå¸¦ç€ä¸€èµ·åˆ·æ‰ï¼› è€Œä¸”è¿™ä¸ªæŠŠâ€œé‚»å±…â€æ‹–ä¸‹æ°´çš„é€»è¾‘è¿˜å¯ä»¥ç»§ç»­è”“å»¶ï¼Œ ä¹Ÿå°±æ˜¯å¯¹äºæ¯ä¸ªé‚»å±…æ•°æ®é¡µï¼Œ å¦‚æœè·Ÿå®ƒç›¸é‚»çš„æ•°æ®é¡µä¹Ÿè¿˜æ˜¯è„é¡µçš„è¯ï¼Œ ä¹Ÿä¼šè¢«æ”¾åˆ°ä¸€èµ·åˆ·</p><h2 id="13-ä¸ºä»€ä¹ˆè¡¨æ•°æ®åˆ æ‰ä¸€åŠï¼Œ-è¡¨æ–‡ä»¶å¤§å°ä¸å˜ï¼Ÿ"><strong>13 | ä¸ºä»€ä¹ˆè¡¨æ•°æ®åˆ æ‰ä¸€åŠï¼Œ</strong> <strong>è¡¨æ–‡ä»¶å¤§å°ä¸å˜ï¼Ÿ</strong></h2><p>ã€B+æ ‘ä»£ç ã€‘</p><p>InnoDBå¼•æ“åªä¼šæŠŠR4è¿™ä¸ªè®°å½•æ ‡è®°ä¸ºåˆ é™¤ã€‚ å¦‚æœä¹‹åè¦å†æ’å…¥ä¸€ä¸ªIDåœ¨300å’Œ600ä¹‹é—´çš„è®°å½•æ—¶ï¼Œ å¯èƒ½ä¼šå¤ç”¨è¿™ä¸ªä½ç½®ã€‚ ä½†æ˜¯ï¼Œ ç£ç›˜æ–‡ä»¶çš„å¤§å°å¹¶ä¸ä¼šç¼©å°ã€‚</p><p>deleteå‘½ä»¤å…¶å®åªæ˜¯æŠŠè®°å½•çš„ä½ç½®ï¼Œ æˆ–è€…æ•°æ®é¡µæ ‡è®°ä¸ºäº†â€œå¯å¤ç”¨â€ï¼Œ ä½†ç£ç›˜æ–‡ä»¶çš„å¤§å°æ˜¯ä¸ä¼šå˜çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œ é€šè¿‡deleteå‘½ä»¤æ˜¯ä¸èƒ½å›æ”¶è¡¨ç©ºé—´çš„ã€‚ è¿™äº›å¯ä»¥å¤ç”¨ï¼Œ è€Œæ²¡æœ‰è¢«ä½¿ç”¨çš„ç©ºé—´ï¼Œ çœ‹èµ·æ¥å°±åƒæ˜¯â€œç©ºæ´â€ã€‚</p><p>ä¸æ­¢æ˜¯åˆ é™¤æ•°æ®ä¼šé€ æˆç©ºæ´ï¼Œ æ’å…¥æ•°æ®ä¹Ÿä¼šã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421200036775.png" alt="image-20240421200036775"></p><p>page Aæ»¡äº†ï¼Œ å†æ’å…¥ä¸€ä¸ªIDæ˜¯550çš„æ•°æ®æ—¶ï¼Œ å°±ä¸å¾—ä¸å†ç”³è¯·ä¸€ä¸ªæ–°çš„é¡µé¢page Bæ¥ä¿å­˜æ•°æ®äº†ã€‚ é¡µåˆ†è£‚å®Œæˆåï¼Œ page Açš„æœ«å°¾å°±ç•™ä¸‹äº†ç©ºæ´ï¼ˆæ³¨æ„ï¼š å®é™…ä¸Šï¼Œ å¯èƒ½ä¸æ­¢1ä¸ªè®°å½•çš„ä½ç½®æ˜¯ç©ºæ´ï¼‰ ã€‚</p><p><strong>é‡å»ºè¡¨</strong></p><p>ä½ å¯ä»¥æ–°å»ºä¸€ä¸ªä¸è¡¨Aç»“æ„ç›¸åŒçš„è¡¨Bï¼Œ ç„¶åæŒ‰ç…§ä¸»é”®IDé€’å¢çš„é¡ºåºï¼Œ æŠŠæ•°æ®ä¸€è¡Œä¸€è¡Œåœ°ä»è¡¨Aé‡Œè¯»å‡ºæ¥å†æ’å…¥åˆ°è¡¨Bä¸­ã€‚ç”±äºè¡¨Bæ˜¯æ–°å»ºçš„è¡¨ï¼Œ æ‰€ä»¥è¡¨Aä¸»é”®ç´¢å¼•ä¸Šçš„ç©ºæ´ï¼Œ åœ¨è¡¨Bä¸­å°±éƒ½ä¸å­˜åœ¨äº†ã€‚ æ˜¾ç„¶åœ°ï¼Œ è¡¨Bçš„ä¸»é”®ç´¢å¼•æ›´ç´§å‡‘ï¼Œ æ•°æ®é¡µçš„åˆ©ç”¨ç‡ä¹Ÿæ›´é«˜ã€‚ å¦‚æœæˆ‘ä»¬æŠŠè¡¨Bä½œä¸ºä¸´æ—¶è¡¨ï¼Œ æ•°æ®ä»è¡¨Aå¯¼å…¥è¡¨Bçš„æ“ä½œå®Œæˆåï¼Œ ç”¨è¡¨Bæ›¿æ¢Aï¼Œä»æ•ˆæœä¸Šçœ‹ï¼Œ å°±èµ·åˆ°äº†æ”¶ç¼©è¡¨Aç©ºé—´çš„ä½œç”¨ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421200044232.png" alt="image-20240421200044232"></p><p>å¼•å…¥äº†Online DDLä¹‹åï¼Œ é‡å»ºè¡¨çš„æµç¨‹ï¼š</p><ol><li>å»ºç«‹ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œæ‰«æè¡¨Aä¸»é”®çš„æ‰€æœ‰æ•°æ®é¡µï¼›</li><li>ç”¨æ•°æ®é¡µä¸­è¡¨Açš„è®°å½•ç”ŸæˆB+æ ‘ï¼Œå­˜å‚¨åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼›</li><li>ç”Ÿæˆä¸´æ—¶æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå°†æ‰€æœ‰å¯¹Açš„æ“ä½œè®°å½•åœ¨ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼ˆrow logï¼‰ä¸­ï¼Œå¯¹åº”çš„æ˜¯å›¾ä¸­state2çš„çŠ¶æ€ï¼›</li><li>ä¸´æ—¶æ–‡ä»¶ç”Ÿæˆåï¼Œå°†æ—¥å¿—æ–‡ä»¶ä¸­çš„æ“ä½œåº”ç”¨åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œå¾—åˆ°ä¸€ä¸ªé€»è¾‘æ•°æ®ä¸Šä¸è¡¨Aç›¸åŒçš„æ•°æ®æ–‡ä»¶ï¼Œå¯¹åº”çš„å°±æ˜¯å›¾ä¸­state3çš„çŠ¶æ€ï¼›</li><li>ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢è¡¨Açš„æ•°æ®æ–‡ä»¶ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421200108974.png" alt="image-20240421200108974"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421200122892.png" alt="image-20240421200122892"></p><h2 id="14-count-è¿™ä¹ˆæ…¢ï¼Œ-æˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ"><strong>14 | count(*)è¿™ä¹ˆæ…¢ï¼Œ</strong> <strong>æˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ</strong></h2><p>ã€ä¸åŒå¼•æ“å·¥ä½œä»¥åŠå¸¸è§countã€‘</p><p><strong>count(*)çš„å®ç°æ–¹å¼</strong></p><p>åœ¨ä¸åŒçš„MySQLå¼•æ“ä¸­ï¼Œ count( * )æœ‰ä¸åŒçš„å®ç°æ–¹å¼ã€‚</p><ul><li>MyISAMå¼•æ“æŠŠä¸€ä¸ªè¡¨çš„æ€»è¡Œæ•°å­˜åœ¨äº†ç£ç›˜ä¸Šï¼Œ å› æ­¤æ‰§è¡Œcount( * )çš„æ—¶å€™ä¼šç›´æ¥è¿”å›è¿™ä¸ªæ•°ï¼Œæ•ˆç‡å¾ˆé«˜</li><li>InnoDBå¼•æ“å°±éº»çƒ¦äº†ï¼Œ å®ƒæ‰§è¡Œcount(*)çš„æ—¶å€™ï¼Œ éœ€è¦æŠŠæ•°æ®ä¸€è¡Œä¸€è¡Œåœ°ä»å¼•æ“é‡Œé¢è¯»å‡ºæ¥ï¼Œ ç„¶åç´¯ç§¯è®¡æ•°</li></ul><p>é‚£ä¸ºä»€ä¹ˆInnoDBä¸è·ŸMyISAMä¸€æ ·ï¼Œ ä¹ŸæŠŠæ•°å­—å­˜èµ·æ¥å‘¢ï¼Ÿ <strong>è¿™æ˜¯å› ä¸ºå³ä½¿æ˜¯åœ¨åŒä¸€ä¸ªæ—¶åˆ»çš„å¤šä¸ªæŸ¥è¯¢ï¼Œ ç”±äºå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ çš„åŸå› </strong>ï¼Œ InnoDBè¡¨â€œåº”è¯¥è¿”å›å¤šå°‘è¡Œâ€ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ã€‚ è¿™é‡Œï¼Œ æˆ‘ç”¨ä¸€ä¸ªç®—count(*)çš„ä¾‹å­æ¥ä¸ºä½ è§£é‡Šä¸€ä¸‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421200223518.png" alt="image-20240421200223518"></p><p>è¿™å’ŒInnoDBçš„äº‹åŠ¡è®¾è®¡æœ‰å…³ç³»ï¼Œ å¯é‡å¤è¯»æ˜¯å®ƒé»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼Œ åœ¨ä»£ç ä¸Šå°±æ˜¯é€šè¿‡å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œ ä¹Ÿå°±æ˜¯MVCCæ¥å®ç°çš„ã€‚ æ¯ä¸€è¡Œè®°å½•éƒ½è¦åˆ¤æ–­è‡ªå·±æ˜¯å¦å¯¹è¿™ä¸ªä¼šè¯å¯è§ï¼Œ å› æ­¤å¯¹äºcount(*)è¯·æ±‚æ¥è¯´ï¼Œ InnoDBåªå¥½æŠŠæ•°æ®ä¸€è¡Œä¸€è¡Œåœ°è¯»å‡ºä¾æ¬¡åˆ¤æ–­ï¼Œ å¯è§çš„è¡Œæ‰èƒ½å¤Ÿç”¨äºè®¡ç®—â€œåŸºäºè¿™ä¸ªæŸ¥è¯¢â€çš„è¡¨çš„æ€»è¡Œæ•°ã€‚</p><p><strong>ä¸åŒçš„countç”¨æ³•</strong></p><p><strong>å¯¹äºcount(ä¸»é”®id)æ¥è¯´</strong>ï¼ŒInnoDBå¼•æ“ä¼šéå†æ•´å¼ è¡¨ï¼ŒæŠŠæ¯ä¸€è¡Œçš„idå€¼éƒ½å–å‡ºæ¥ï¼Œè¿”å›ç»™serverå±‚ã€‚serverå±‚æ‹¿åˆ°idåï¼Œåˆ¤æ–­æ˜¯ä¸å¯èƒ½ä¸ºç©ºçš„ï¼Œå°±æŒ‰è¡Œç´¯åŠ ã€‚</p><p><strong>å¯¹äºcount(1)æ¥è¯´</strong>ï¼ŒInnoDBå¼•æ“éå†æ•´å¼ è¡¨ï¼Œä½†ä¸å–å€¼ã€‚serverå±‚å¯¹äºè¿”å›çš„æ¯ä¸€è¡Œï¼Œæ”¾ä¸€ä¸ªæ•°å­—â€œ1â€è¿›å»ï¼Œåˆ¤æ–­æ˜¯ä¸å¯èƒ½ä¸ºç©ºçš„ï¼ŒæŒ‰è¡Œç´¯åŠ ã€‚</p><p><strong>å¯¹äºcount(å­—æ®µ)æ¥è¯´</strong>ï¼š</p><ol><li>å¦‚æœè¿™ä¸ªâ€œå­—æ®µâ€æ˜¯å®šä¹‰ä¸ºnot nullçš„è¯ï¼Œä¸€è¡Œè¡Œåœ°ä»è®°å½•é‡Œé¢è¯»å‡ºè¿™ä¸ªå­—æ®µï¼Œåˆ¤æ–­ä¸èƒ½ä¸ºnullï¼ŒæŒ‰è¡Œç´¯åŠ ï¼›</li><li>å¦‚æœè¿™ä¸ªâ€œå­—æ®µâ€å®šä¹‰å…è®¸ä¸ºnullï¼Œé‚£ä¹ˆæ‰§è¡Œçš„æ—¶å€™ï¼Œåˆ¤æ–­åˆ°æœ‰å¯èƒ½æ˜¯nullï¼Œè¿˜è¦æŠŠå€¼å–å‡ºæ¥å†åˆ¤æ–­ä¸€ä¸‹ï¼Œä¸æ˜¯nullæ‰ç´¯åŠ ã€‚</li></ol><p><strong>ä½†æ˜¯count(*)æ˜¯ä¾‹å¤–</strong>ï¼Œå¹¶ä¸ä¼šæŠŠå…¨éƒ¨å­—æ®µå–å‡ºæ¥ï¼Œè€Œæ˜¯ä¸“é—¨åšäº†ä¼˜åŒ–ï¼Œä¸å–å€¼ã€‚count(*)è‚¯å®šä¸æ˜¯nullï¼ŒæŒ‰è¡Œç´¯åŠ ã€‚</p><p><strong>ç»“è®ºæ˜¯</strong>ï¼šæŒ‰ç…§æ•ˆç‡æ’åºçš„è¯ï¼Œcount(å­—æ®µ)&lt;count(ä¸»é”®id)&lt;count(1)â‰ˆcount(<em>)ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä½ ï¼Œå°½é‡ä½¿ç”¨count(</em>)ã€‚</p><h2 id="15-ç­”ç–‘æ–‡ç« ï¼ˆä¸€ï¼‰-ï¼š-æ—¥å¿—å’Œç´¢å¼•ç›¸å…³é—®é¢˜"><strong>15 | ç­”ç–‘æ–‡ç« ï¼ˆä¸€ï¼‰</strong> <strong>ï¼š</strong> <strong>æ—¥å¿—å’Œç´¢å¼•ç›¸å…³é—®é¢˜</strong></h2><p>è¿™ä¸ªéƒ¨åˆ†å¥½å¥½çœ‹çœ‹å¹³å°æ–‡ç« ã€‚</p><p><strong>æ—¥å¿—ç›¸å…³é—®é¢˜</strong></p><p><strong>åœ¨ä¸¤é˜¶æ®µæäº¤çš„ä¸åŒç¬é—´ï¼ŒMySQLå¦‚æœå‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œæ˜¯æ€ä¹ˆä¿è¯æ•°æ®å®Œæ•´æ€§çš„ï¼Ÿ</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421200445846.png" alt="image-20240421200445846"></p><p>å´©æºƒæ¢å¤æ—¶çš„åˆ¤æ–­è§„åˆ™ã€‚</p><ol><li>å¦‚æœredo logé‡Œé¢çš„äº‹åŠ¡æ˜¯å®Œæ•´çš„ï¼Œä¹Ÿå°±æ˜¯å·²ç»æœ‰äº†commitæ ‡è¯†ï¼Œåˆ™ç›´æ¥æäº¤ï¼›</li><li>å¦‚æœredo logé‡Œé¢çš„äº‹åŠ¡åªæœ‰å®Œæ•´çš„prepareï¼Œåˆ™åˆ¤æ–­å¯¹åº”çš„äº‹åŠ¡binlogæ˜¯å¦å­˜åœ¨å¹¶å®Œæ•´ï¼š<br>a. å¦‚æœæ˜¯ï¼Œåˆ™æäº¤äº‹åŠ¡ï¼›<br>b. å¦åˆ™ï¼Œå›æ»šäº‹åŠ¡ã€‚</li></ol><p><strong>MySQLæ€ä¹ˆçŸ¥é“binlogæ˜¯å®Œæ•´çš„?</strong></p><p>å›ç­”ï¼šä¸€ä¸ªäº‹åŠ¡çš„binlogæ˜¯æœ‰å®Œæ•´æ ¼å¼çš„ï¼š</p><ul><li>statementæ ¼å¼çš„binlogï¼Œæœ€åä¼šæœ‰COMMITï¼›</li><li>rowæ ¼å¼çš„binlogï¼Œæœ€åä¼šæœ‰ä¸€ä¸ªXID eventã€‚</li></ul><p>å¦å¤–ï¼Œåœ¨MySQL 5.6.2ç‰ˆæœ¬ä»¥åï¼Œè¿˜å¼•å…¥äº†binlog-checksumå‚æ•°ï¼Œç”¨æ¥éªŒè¯binlogå†…å®¹çš„æ­£ç¡®æ€§ã€‚å¯¹äºbinlogæ—¥å¿—ç”±äºç£ç›˜åŸå› ï¼Œå¯èƒ½ä¼šåœ¨æ—¥å¿—ä¸­é—´å‡ºé”™çš„æƒ…å†µï¼ŒMySQLå¯ä»¥é€šè¿‡æ ¡éªŒchecksumçš„ç»“æœæ¥å‘ç°ã€‚æ‰€ä»¥ï¼ŒMySQLè¿˜æ˜¯æœ‰åŠæ³•éªŒè¯äº‹åŠ¡binlogçš„å®Œæ•´æ€§çš„ã€‚</p><p><strong>redo log å’Œ binlogæ˜¯æ€ä¹ˆå…³è”èµ·æ¥çš„?</strong></p><p>å›ç­”ï¼š å®ƒä»¬æœ‰ä¸€ä¸ªå…±åŒçš„æ•°æ®å­—æ®µï¼Œ å«XIDã€‚ å´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œ ä¼šæŒ‰é¡ºåºæ‰«æredo logï¼š<br>å¦‚æœç¢°åˆ°æ—¢æœ‰prepareã€ åˆæœ‰commitçš„redo logï¼Œ å°±ç›´æ¥æäº¤ï¼›<br>å¦‚æœç¢°åˆ°åªæœ‰parepareã€ è€Œæ²¡æœ‰commitçš„redo logï¼Œ å°±æ‹¿ç€XIDå»binlogæ‰¾å¯¹åº”çš„äº‹åŠ¡ã€‚</p><p><strong>redo logä¸€èˆ¬è®¾ç½®å¤šå¤§ï¼Ÿ</strong></p><p>redo logå¤ªå°çš„è¯ï¼Œ ä¼šå¯¼è‡´å¾ˆå¿«å°±è¢«å†™æ»¡ï¼Œ ç„¶åä¸å¾—ä¸å¼ºè¡Œåˆ·redo logï¼Œ è¿™æ ·WALæœºåˆ¶çš„èƒ½åŠ›å°±å‘æŒ¥ä¸å‡ºæ¥äº†ã€‚æ‰€ä»¥ï¼Œ å¦‚æœæ˜¯ç°åœ¨å¸¸è§çš„å‡ ä¸ªTBçš„ç£ç›˜çš„è¯ï¼Œ å°±ä¸è¦å¤ªå°æ°”äº†ï¼Œ ç›´æ¥å°†redo logè®¾ç½®ä¸º4ä¸ªæ–‡ä»¶ã€ æ¯ä¸ªæ–‡ä»¶1GBå§ã€‚</p><p><strong>redo log bufferæ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å…ˆä¿®æ”¹å†…å­˜ï¼Œè¿˜æ˜¯å…ˆå†™redo logæ–‡ä»¶ï¼Ÿ</strong></p><p>åœ¨ä¸€ä¸ªäº‹åŠ¡çš„æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæ—¥å¿—æ˜¯è¦å†™å¤šæ¬¡çš„ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªäº‹åŠ¡ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 ...</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t2 ...</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªäº‹åŠ¡è¦å¾€ä¸¤ä¸ªè¡¨ä¸­æ’å…¥è®°å½•ï¼Œæ’å…¥æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œç”Ÿæˆçš„æ—¥å¿—éƒ½å¾—å…ˆä¿å­˜èµ·æ¥ï¼Œä½†åˆä¸èƒ½åœ¨è¿˜æ²¡commitçš„æ—¶å€™å°±ç›´æ¥å†™åˆ°redo logæ–‡ä»¶é‡Œã€‚</p><p>æ‰€ä»¥ï¼Œredo log bufferå°±æ˜¯ä¸€å—å†…å­˜ï¼Œç”¨æ¥å…ˆå­˜redoæ—¥å¿—çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ‰§è¡Œç¬¬ä¸€ä¸ªinsertçš„æ—¶å€™ï¼Œæ•°æ®çš„å†…å­˜è¢«ä¿®æ”¹äº†ï¼Œredo log bufferä¹Ÿå†™å…¥äº†æ—¥å¿—ã€‚</p><p>ä½†æ˜¯ï¼ŒçœŸæ­£æŠŠæ—¥å¿—å†™åˆ°redo logæ–‡ä»¶ï¼ˆæ–‡ä»¶åæ˜¯ ib_logfile+æ•°å­—ï¼‰ï¼Œæ˜¯åœ¨æ‰§è¡Œcommitè¯­å¥çš„æ—¶å€™åšçš„ã€‚</p><h2 id="16-â€œorder-byâ€æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ"><strong>16 | â€œorder byâ€æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ</strong></h2><p>ã€æµç¨‹åŠå…¶ä¼˜åŒ–ã€‘</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> city,name,age <span class="keyword">from</span> t <span class="keyword">where</span> city<span class="operator">=</span><span class="string">&#x27;æ­å·&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> name limit <span class="number">1000</span>  ;</span><br></pre></td></tr></table></figure><p><strong>å…¨å­—æ®µæ’åº</strong></p><p>ä¸ºé¿å…å…¨è¡¨æ‰«æï¼Œ æˆ‘ä»¬éœ€è¦åœ¨cityå­—æ®µåŠ ä¸Šç´¢å¼•ã€‚åœ¨cityå­—æ®µä¸Šåˆ›å»ºç´¢å¼•ä¹‹åï¼Œ æˆ‘ä»¬ç”¨explainå‘½ä»¤æ¥çœ‹çœ‹è¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæƒ…å†µã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421200729385.png" alt="image-20240421200729385"></p><p>Extraè¿™ä¸ªå­—æ®µä¸­çš„â€œUsing filesortâ€è¡¨ç¤ºçš„å°±æ˜¯éœ€è¦æ’åºï¼ŒMySQLä¼šç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€å—å†…å­˜ç”¨äºæ’åºï¼Œç§°ä¸ºsort_bufferã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421200739061.png" alt="image-20240421200739061"></p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè¯­å¥æ‰§è¡Œæµç¨‹å¦‚ä¸‹æ‰€ç¤º ï¼š</p><ol><li>åˆå§‹åŒ–sort_bufferï¼Œç¡®å®šæ”¾å…¥nameã€cityã€ageè¿™ä¸‰ä¸ªå­—æ®µï¼›</li><li>ä»ç´¢å¼•cityæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³city='æ­å·â€™æ¡ä»¶çš„ä¸»é”®idï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„ID_Xï¼›</li><li>åˆ°ä¸»é”®idç´¢å¼•å–å‡ºæ•´è¡Œï¼Œå–nameã€cityã€ageä¸‰ä¸ªå­—æ®µçš„å€¼ï¼Œå­˜å…¥sort_bufferä¸­ï¼›</li><li>ä»ç´¢å¼•cityå–ä¸‹ä¸€ä¸ªè®°å½•çš„ä¸»é”®idï¼›</li><li>é‡å¤æ­¥éª¤3ã€4ç›´åˆ°cityçš„å€¼ä¸æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ä¸ºæ­¢ï¼Œå¯¹åº”çš„ä¸»é”®idä¹Ÿå°±æ˜¯å›¾ä¸­çš„ID_Yï¼›</li><li>å¯¹sort_bufferä¸­çš„æ•°æ®æŒ‰ç…§å­—æ®µnameåšå¿«é€Ÿæ’åºï¼›</li><li>æŒ‰ç…§æ’åºç»“æœå–å‰1000è¡Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421200817067.png" alt="image-20240421200817067"></p><p><strong>è¿™é‡Œï¼Œæˆ‘ä»¬è¦ç†Ÿæ‚‰OPTIMIZER_TRACEå‘½ï¼Œexplainä»¥åŠæ…¢æŸ¥è¯¢æŸ¥çœ‹ç»“æœã€‚</strong></p><p><strong>rowidæ’åº</strong></p><p>æ–°çš„ç®—æ³•æ”¾å…¥sort_bufferçš„å­—æ®µï¼Œ åªæœ‰è¦æ’åºçš„åˆ—ï¼ˆ å³nameå­—æ®µï¼‰ å’Œä¸»é”®idã€‚ä½†è¿™æ—¶ï¼Œ æ’åºçš„ç»“æœå°±å› ä¸ºå°‘äº†cityå’Œageå­—æ®µçš„å€¼ï¼Œ ä¸èƒ½ç›´æ¥è¿”å›äº†ï¼Œ æ•´ä¸ªæ‰§è¡Œæµç¨‹å°±å˜æˆå¦‚<br>ä¸‹æ‰€ç¤ºçš„æ ·å­ï¼š</p><ol><li>åˆå§‹åŒ–sort_bufferï¼Œç¡®å®šæ”¾å…¥ä¸¤ä¸ªå­—æ®µï¼Œå³nameå’Œidï¼›</li><li>ä»ç´¢å¼•cityæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³city='æ­å·â€™æ¡ä»¶çš„ä¸»é”®idï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„ID_Xï¼›</li><li>åˆ°ä¸»é”®idç´¢å¼•å–å‡ºæ•´è¡Œï¼Œå–nameã€idè¿™ä¸¤ä¸ªå­—æ®µï¼Œå­˜å…¥sort_bufferä¸­ï¼›</li><li>ä»ç´¢å¼•cityå–ä¸‹ä¸€ä¸ªè®°å½•çš„ä¸»é”®idï¼›</li><li>é‡å¤æ­¥éª¤3ã€4ç›´åˆ°ä¸æ»¡è¶³city='æ­å·â€™æ¡ä»¶ä¸ºæ­¢ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„ID_Yï¼›</li><li>å¯¹sort_bufferä¸­çš„æ•°æ®æŒ‰ç…§å­—æ®µnameè¿›è¡Œæ’åºï¼›</li><li>éå†æ’åºç»“æœï¼Œå–å‰1000è¡Œï¼Œå¹¶æŒ‰ç…§idçš„å€¼å›åˆ°åŸè¡¨ä¸­å–å‡ºcityã€nameå’Œageä¸‰ä¸ªå­—æ®µè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421201012251.png" alt="image-20240421201012251"></p><p><strong>å…¨å­—æ®µæ’åº VS rowidæ’åº</strong></p><p>ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–ä»è€Œä¼˜åŒ–æ’åºã€‚</p><h2 id="17-å¦‚ä½•æ­£ç¡®åœ°æ˜¾ç¤ºéšæœºæ¶ˆæ¯ï¼Ÿ"><strong>17 | å¦‚ä½•æ­£ç¡®åœ°æ˜¾ç¤ºéšæœºæ¶ˆæ¯ï¼Ÿ</strong></h2><p>ã€å­¦ä¹ SQLæ‰§è¡Œè¿‡ç¨‹ã€‘</p><p><strong>èƒŒæ™¯</strong></p><p>è¿™ä¸ªè‹±è¯­å­¦ä¹ Appé¦–é¡µæœ‰ä¸€ä¸ªéšæœºæ˜¾ç¤ºå•è¯çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®æ¯ä¸ªç”¨æˆ·çš„çº§åˆ«æœ‰ä¸€ä¸ªå•è¯è¡¨ï¼Œç„¶åè¿™ä¸ªç”¨æˆ·æ¯æ¬¡è®¿é—®é¦–é¡µçš„æ—¶å€™ï¼Œéƒ½ä¼šéšæœºæ»šåŠ¨æ˜¾ç¤ºä¸‰ä¸ªå•è¯ã€‚ä»–ä»¬å‘ç°éšç€å•è¯è¡¨å˜å¤§ï¼Œé€‰å•è¯è¿™ä¸ªé€»è¾‘å˜å¾—è¶Šæ¥è¶Šæ…¢ï¼Œç”šè‡³å½±å“åˆ°äº†é¦–é¡µçš„æ‰“å¼€é€Ÿåº¦ã€‚</p><p>ç°åœ¨å¯¹è¿™ä¸ªä¾‹å­è¿›è¡Œäº†ç®€åŒ–ï¼šå»æ‰æ¯ä¸ªçº§åˆ«çš„ç”¨æˆ·éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„å•è¯è¡¨è¿™ä¸ªé€»è¾‘ï¼Œç›´æ¥å°±æ˜¯ä»ä¸€ä¸ªå•è¯è¡¨ä¸­éšæœºé€‰å‡ºä¸‰ä¸ªå•è¯ã€‚</p><p><strong>å†…å­˜ä¸´æ—¶è¡¨</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> word <span class="keyword">from</span> words <span class="keyword">order</span> <span class="keyword">by</span> rand() limit <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¯­å¥çš„æ„æ€å¾ˆç›´ç™½ï¼Œéšæœºæ’åºå–å‰3ä¸ªã€‚ä½¿ç”¨explainå‘½ä»¤æ¥çœ‹çœ‹è¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæƒ…å†µã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421201253209.png" alt="image-20240421201253209"></p><p>å¯¹äºå†…å­˜è¡¨ï¼Œ å›è¡¨è¿‡ç¨‹åªæ˜¯ç®€å•åœ°æ ¹æ®æ•°æ®è¡Œçš„ä½ç½®ï¼Œ ç›´æ¥è®¿é—®å†…å­˜å¾—åˆ°æ•°æ®ï¼Œ æ ¹æœ¬ä¸ä¼šå¯¼è‡´å¤šè®¿é—®ç£ç›˜ã€‚</p><p>è¿™æ¡è¯­å¥çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ã€‚è¿™ä¸ªä¸´æ—¶è¡¨ä½¿ç”¨çš„æ˜¯memoryå¼•æ“ï¼Œè¡¨é‡Œæœ‰ä¸¤ä¸ªå­—æ®µï¼Œç¬¬ä¸€ä¸ªå­—æ®µæ˜¯doubleç±»å‹ï¼Œä¸ºäº†åé¢æè¿°æ–¹ä¾¿ï¼Œè®°ä¸ºå­—æ®µRï¼Œç¬¬äºŒä¸ªå­—æ®µæ˜¯varchar(64)ç±»å‹ï¼Œè®°ä¸ºå­—æ®µWã€‚å¹¶ä¸”ï¼Œè¿™ä¸ªè¡¨æ²¡æœ‰å»ºç´¢å¼•ã€‚</li><li>ä»wordsè¡¨ä¸­ï¼ŒæŒ‰ä¸»é”®é¡ºåºå–å‡ºæ‰€æœ‰çš„wordå€¼ã€‚å¯¹äºæ¯ä¸€ä¸ªwordå€¼ï¼Œè°ƒç”¨rand()å‡½æ•°ç”Ÿæˆä¸€ä¸ªå¤§äº0å°äº1çš„éšæœºå°æ•°ï¼Œå¹¶æŠŠè¿™ä¸ªéšæœºå°æ•°å’Œwordåˆ†åˆ«å­˜å…¥ä¸´æ—¶è¡¨çš„Rå’ŒWå­—æ®µä¸­ï¼Œåˆ°æ­¤ï¼Œæ‰«æè¡Œæ•°æ˜¯10000ã€‚</li><li>ç°åœ¨ä¸´æ—¶è¡¨æœ‰10000è¡Œæ•°æ®äº†ï¼Œæ¥ä¸‹æ¥ä½ è¦åœ¨è¿™ä¸ªæ²¡æœ‰ç´¢å¼•çš„å†…å­˜ä¸´æ—¶è¡¨ä¸Šï¼ŒæŒ‰ç…§å­—æ®µRæ’åºã€‚</li><li>åˆå§‹åŒ– sort_bufferã€‚sort_bufferä¸­æœ‰ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯doubleç±»å‹ï¼Œå¦ä¸€ä¸ªæ˜¯æ•´å‹ã€‚</li><li>ä»å†…å­˜ä¸´æ—¶è¡¨ä¸­ä¸€è¡Œä¸€è¡Œåœ°å–å‡ºRå€¼å’Œä½ç½®ä¿¡æ¯ï¼ˆæˆ‘åé¢ä¼šå’Œä½ è§£é‡Šè¿™é‡Œä¸ºä»€ä¹ˆæ˜¯â€œä½ç½®ä¿¡æ¯â€ï¼‰ï¼Œåˆ†åˆ«å­˜å…¥sort_bufferä¸­çš„ä¸¤ä¸ªå­—æ®µé‡Œã€‚è¿™ä¸ªè¿‡ç¨‹è¦å¯¹å†…å­˜ä¸´æ—¶è¡¨åšå…¨è¡¨æ‰«æï¼Œæ­¤æ—¶æ‰«æè¡Œæ•°å¢åŠ 10000ï¼Œå˜æˆäº†20000ã€‚</li><li>åœ¨sort_bufferä¸­æ ¹æ®Rçš„å€¼è¿›è¡Œæ’åºã€‚æ³¨æ„ï¼Œè¿™ä¸ªè¿‡ç¨‹æ²¡æœ‰æ¶‰åŠåˆ°è¡¨æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šå¢åŠ æ‰«æè¡Œæ•°ã€‚</li><li>æ’åºå®Œæˆåï¼Œå–å‡ºå‰ä¸‰ä¸ªç»“æœçš„ä½ç½®ä¿¡æ¯ï¼Œä¾æ¬¡åˆ°å†…å­˜ä¸´æ—¶è¡¨ä¸­å–å‡ºwordå€¼ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè®¿é—®äº†è¡¨çš„ä¸‰è¡Œæ•°æ®ï¼Œæ€»æ‰«æè¡Œæ•°å˜æˆäº†20003ã€‚</li></ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆslow logï¼‰æ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬åˆ†æå¾—åˆ°çš„æ‰«æè¡Œæ•°æ˜¯å¦æ­£ç¡®ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Query_time: <span class="number">0.900376</span>  Lock_time: <span class="number">0.000347</span> Rows_sent: <span class="number">3</span> Rows_examined: <span class="number">20003</span></span><br><span class="line"><span class="keyword">SET</span> <span class="type">timestamp</span><span class="operator">=</span><span class="number">1541402277</span>;</span><br><span class="line"><span class="keyword">select</span> word <span class="keyword">from</span> words <span class="keyword">order</span> <span class="keyword">by</span> rand() limit <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼ŒRows_examinedï¼š20003å°±è¡¨ç¤ºè¿™ä¸ªè¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰«æäº†20003è¡Œï¼Œä¹Ÿå°±éªŒè¯äº†æˆ‘ä»¬åˆ†æå¾—å‡ºçš„ç»“è®ºã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421201352186.png" alt="image-20240421201352186"></p><p><strong>æ€»ç»“ï¼šorder by rand()ä½¿ç”¨äº†å†…å­˜ä¸´æ—¶è¡¨ï¼Œå†…å­˜ä¸´æ—¶è¡¨æ’åºçš„æ—¶å€™ä½¿ç”¨äº†rowidæ’åºæ–¹æ³•ã€‚</strong></p><p>MySQLçš„è¡¨æ˜¯ç”¨ä»€ä¹ˆæ–¹æ³•æ¥å®šä½â€œä¸€è¡Œæ•°æ®â€çš„ã€‚ å¦‚æœä½ åˆ›å»ºçš„è¡¨æ²¡æœ‰ä¸»é”®ï¼Œ æˆ–è€…æŠŠä¸€ä¸ªè¡¨çš„ä¸»é”®åˆ æ‰äº†ï¼Œ é‚£ä¹ˆInnoDBä¼šè‡ªå·±ç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸º6å­—èŠ‚çš„rowidæ¥ä½œä¸ºä¸»é”®</p><h2 id="18-ä¸ºä»€ä¹ˆè¿™äº›SQLè¯­å¥é€»è¾‘ç›¸åŒï¼Œ-æ€§èƒ½å´å·®å¼‚å·¨å¤§ï¼Ÿ"><strong>18 | ä¸ºä»€ä¹ˆè¿™äº›SQLè¯­å¥é€»è¾‘ç›¸åŒï¼Œ</strong> <strong>æ€§èƒ½å´å·®å¼‚å·¨å¤§ï¼Ÿ</strong></h2><p>ã€ç´¢å¼•å¤±æ•ˆã€‘</p><p>æ¡ˆä¾‹ä¸€ï¼š æ¡ä»¶å­—æ®µå‡½æ•°æ“ä½œ</p><p>å¯¹ç´¢å¼•å­—æ®µåšå‡½æ•°æ“ä½œï¼Œ å¯èƒ½ä¼šç ´åç´¢å¼•å€¼çš„æœ‰åºæ€§ï¼Œ å› æ­¤ä¼˜åŒ–å™¨å°±å†³å®šæ”¾å¼ƒèµ°æ ‘æœç´¢åŠŸèƒ½ã€‚</p><p>æ¡ˆä¾‹äºŒï¼š éšå¼ç±»å‹è½¬æ¢</p><p>æ•°æ®ç±»å‹è½¬æ¢çš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ<br>ä¸ºä»€ä¹ˆæœ‰æ•°æ®ç±»å‹è½¬æ¢ï¼Œ å°±éœ€è¦èµ°å…¨ç´¢å¼•æ‰«æï¼Ÿ</p><p>åœ¨MySQLä¸­ï¼Œ å­—ç¬¦ä¸²å’Œæ•°å­—åšæ¯”è¾ƒçš„è¯ï¼Œ æ˜¯å°†å­—ç¬¦ä¸²è½¬æ¢æˆæ•°å­—</p><p>æ¡ˆä¾‹ä¸‰ï¼š éšå¼å­—ç¬¦ç¼–ç è½¬æ¢</p><p>å…¶å®æ˜¯åœ¨è¯´åŒä¸€ä»¶äº‹å„¿ï¼Œ å³ï¼š å¯¹ç´¢å¼•å­—æ®µåšå‡½æ•°æ“ä½œï¼Œ å¯èƒ½ä¼šç ´åç´¢å¼•å€¼çš„æœ‰åºæ€§ï¼Œ å› æ­¤ä¼˜åŒ–å™¨å°±å†³å®šæ”¾å¼ƒèµ°æ ‘æœç´¢åŠŸèƒ½ã€‚</p><h2 id="19-ä¸ºä»€ä¹ˆæˆ‘åªæŸ¥ä¸€è¡Œçš„è¯­å¥ï¼Œ-ä¹Ÿæ‰§è¡Œè¿™ä¹ˆæ…¢ï¼Ÿ"><strong>19 | ä¸ºä»€ä¹ˆæˆ‘åªæŸ¥ä¸€è¡Œçš„è¯­å¥ï¼Œ</strong> <strong>ä¹Ÿæ‰§è¡Œè¿™ä¹ˆæ…¢ï¼Ÿ</strong></h2><p>ã€é”ä½äº†oré•¿äº‹åŠ¡ã€‘</p><p>å¥—è·¯ï¼šåˆ†æé—®é¢˜ï¼ŒéªŒè¯é—®é¢˜ï¼Œè§£å†³é—®é¢˜ã€‚</p><p>æœ‰äº›æƒ…å†µä¸‹ï¼Œ â€œæŸ¥ä¸€è¡Œâ€ï¼Œ ä¹Ÿä¼šæ‰§è¡Œå¾—ç‰¹åˆ«æ…¢ã€‚</p><p><strong>ç¬¬ä¸€ç±»ï¼š</strong> <strong>æŸ¥è¯¢é•¿æ—¶é—´ä¸è¿”å›</strong></p><p>å¦‚å›¾1æ‰€ç¤ºï¼Œ åœ¨è¡¨tæ‰§è¡Œä¸‹é¢çš„SQLè¯­å¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœé•¿æ—¶é—´ä¸è¿”å›ã€‚ä¸€èˆ¬ç¢°åˆ°è¿™ç§æƒ…å†µçš„è¯ï¼Œ å¤§æ¦‚ç‡æ˜¯è¡¨tè¢«é”ä½äº†ã€‚</p><p>æ¥ä¸‹æ¥åˆ†æåŸå› çš„æ—¶å€™ï¼Œ ä¸€èˆ¬éƒ½æ˜¯é¦–å…ˆæ‰§è¡Œä¸€ä¸‹show processlistå‘½ä»¤ï¼Œ çœ‹çœ‹å½“å‰è¯­å¥å¤„äºä»€ä¹ˆçŠ¶æ€ã€‚ç„¶åæˆ‘ä»¬å†é’ˆå¯¹æ¯ç§çŠ¶æ€ï¼Œ å»åˆ†æå®ƒä»¬äº§ç”Ÿçš„åŸå› ã€ å¦‚ä½•å¤ç°ï¼Œ ä»¥åŠå¦‚ä½•å¤„ç†ã€‚</p><p><strong>ç­‰MDLé”</strong></p><p>ä½¿ç”¨show processlistå‘½ä»¤æŸ¥çœ‹Waiting for table metadata lockã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421201745437.png" alt="image-20240421201745437"></p><p>å‡ºç°è¿™ä¸ªçŠ¶æ€è¡¨ç¤ºçš„æ˜¯ï¼Œ ç°åœ¨æœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¡¨tä¸Šè¯·æ±‚æˆ–è€…æŒæœ‰MDLå†™é”ï¼Œ æŠŠselectè¯­å¥å µä½äº†ã€‚</p><p>è§£å†³æ–¹æ³•ï¼šå°±æ˜¯æ‰¾åˆ°è°æŒæœ‰MDLå†™é”ï¼Œç„¶åæŠŠå®ƒkillæ‰ã€‚</p><p>é€šè¿‡æŸ¥è¯¢sys.schema_table_lock_waitsè¿™å¼ è¡¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ‰¾å‡ºé€ æˆé˜»å¡çš„process idï¼ŒæŠŠè¿™ä¸ªè¿æ¥ç”¨kill å‘½ä»¤æ–­å¼€å³å¯ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421201712264.png" alt="image-20240421201712264"></p><p><strong>ç­‰flush</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.processlist <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421201753947.png" alt="image-20240421201753947"></p><p>ä½¿ç”¨show processlistæ’æŸ¥ã€‚</p><p><strong>ç­‰è¡Œé”</strong></p><p>ç°åœ¨ï¼Œ ç»è¿‡äº†è¡¨çº§é”çš„è€ƒéªŒï¼Œ æˆ‘ä»¬çš„select è¯­å¥ç»ˆäºæ¥åˆ°å¼•æ“é‡Œäº†ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> lock <span class="keyword">in</span> share mode;</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421201839042.png" alt="image-20240421201839042"></p><p>è§£å†³æ–¹æ³•ï¼š</p><p>é€šè¿‡sys.innodb_lock_waits è¡¨æŸ¥å‡ºæ˜¯è°å ç€è¿™ä¸ªå†™é”</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t sys.innodb_lock_waits <span class="keyword">where</span> locked_table<span class="operator">=</span>`<span class="string">&#x27;test&#x27;</span>.<span class="string">&#x27;t&#x27;</span>`\G</span><br></pre></td></tr></table></figure><p>ç„¶åç›´æ¥æ–­å¼€è¿™ä¸ªè¿æ¥ã€‚</p><p><strong>ç¬¬äºŒç±»ï¼š</strong> <strong>æŸ¥è¯¢æ…¢</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>ï¼›</span><br></pre></td></tr></table></figure><p>è™½ç„¶æ‰«æè¡Œæ•°æ˜¯1ï¼Œ ä½†æ‰§è¡Œæ—¶é—´å´é•¿è¾¾800æ¯«ç§’ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421202203454.png" alt="image-20240421202203454"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> lock <span class="keyword">in</span> share mode</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæ—¶æ‰«æè¡Œæ•°ä¹Ÿæ˜¯1è¡Œï¼Œ æ‰§è¡Œæ—¶é—´æ˜¯0.2æ¯«ç§’ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421202228245.png" alt="image-20240421202228245"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421202237859.png" alt="image-20240421202237859"></p><p>å…ˆçŒœæµ‹ä¸‹ï¼Œå†å¾€ä¸‹çœ‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421202245363.png" alt="image-20240421202245363"></p><p>session Aå…ˆç”¨start transaction with consistent snapshotå‘½ä»¤å¯åŠ¨äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œ ä¹‹åsession Bæ‰å¼€å§‹æ‰§è¡Œupdate è¯­å¥ã€‚</p><p>session Bæ‰§è¡Œå®Œ100ä¸‡æ¬¡updateè¯­å¥åï¼Œ id=1è¿™ä¸€è¡Œå¤„äºä»€ä¹ˆçŠ¶æ€å‘¢ï¼Ÿ</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421202312908.png" alt="image-20240421202312908"></p><p>session Bæ›´æ–°å®Œ100ä¸‡æ¬¡ï¼Œç”Ÿæˆäº†100ä¸‡ä¸ªå›æ»šæ—¥å¿—(undo log)ã€‚</p><p>å¸¦lock in share modeçš„SQLè¯­å¥ï¼Œæ˜¯å½“å‰è¯»ï¼Œå› æ­¤ä¼šç›´æ¥è¯»åˆ°1000001è¿™ä¸ªç»“æœï¼Œæ‰€ä»¥é€Ÿåº¦å¾ˆå¿«ï¼›è€Œselect * from t where id=1è¿™ä¸ªè¯­å¥ï¼Œæ˜¯ä¸€è‡´æ€§è¯»ï¼Œå› æ­¤éœ€è¦ä»1000001å¼€å§‹ï¼Œä¾æ¬¡æ‰§è¡Œundo logï¼Œæ‰§è¡Œäº†100ä¸‡æ¬¡ä»¥åï¼Œæ‰å°†1è¿™ä¸ªç»“æœè¿”å›ã€‚</p><h2 id="20-å¹»è¯»æ˜¯ä»€ä¹ˆï¼Œ-å¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ"><strong>20 | å¹»è¯»æ˜¯ä»€ä¹ˆï¼Œ</strong> <strong>å¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong></h2><p>ã€æ˜¯ä»€ä¹ˆï¼Ÿä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿæ•°æ®åº“åˆæ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿã€‘</p><p>å‰æï¼šå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹çš„ï¼Œé—´éš™é”æ‰ä¼šå‘ç”Ÿã€‚</p><p><strong>å¹»è¯»æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `d` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `c` (`c`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),(<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>),(<span class="number">15</span>,<span class="number">15</span>,<span class="number">15</span>),(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>),(<span class="number">25</span>,<span class="number">25</span>,<span class="number">25</span>);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¡¨é™¤äº†ä¸»é”®idå¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç´¢å¼•cï¼Œåˆå§‹åŒ–è¯­å¥åœ¨è¡¨ä¸­æ’å…¥äº†6è¡Œæ•°æ®ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹ï¼Œå¦‚æœåªåœ¨id=5è¿™ä¸€è¡ŒåŠ é”ï¼Œè€Œå…¶ä»–è¡Œçš„ä¸åŠ é”çš„è¯ï¼Œä¼šæ€ä¹ˆæ ·ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421202441948.png" alt="image-20240421202441948"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œ session Aé‡Œæ‰§è¡Œäº†ä¸‰æ¬¡æŸ¥è¯¢ï¼Œ åˆ†åˆ«æ˜¯Q1ã€ Q2å’ŒQ3ã€‚ å®ƒä»¬çš„SQLè¯­å¥ç›¸åŒï¼Œ éƒ½æ˜¯select * from t where d=5 for updateã€‚ æŸ¥æ‰€æœ‰d=5çš„è¡Œï¼Œ è€Œä¸”ä½¿ç”¨çš„æ˜¯å½“å‰è¯»ï¼Œ å¹¶ä¸”åŠ ä¸Šå†™é”ã€‚</p><ol><li>Q1åªè¿”å›id=5è¿™ä¸€è¡Œï¼›</li><li>åœ¨T2æ—¶åˆ»ï¼Œsession BæŠŠid=0è¿™ä¸€è¡Œçš„då€¼æ”¹æˆäº†5ï¼Œå› æ­¤T3æ—¶åˆ»Q2æŸ¥å‡ºæ¥çš„æ˜¯id=0å’Œid=5è¿™ä¸¤è¡Œï¼›</li><li>åœ¨T4æ—¶åˆ»ï¼Œsession Cåˆæ’å…¥ä¸€è¡Œï¼ˆ1,1,5ï¼‰ï¼Œå› æ­¤T5æ—¶åˆ»Q3æŸ¥å‡ºæ¥çš„æ˜¯id=0ã€id=1å’Œid=5çš„è¿™ä¸‰è¡Œã€‚</li></ol><p>å…¶ä¸­ï¼Œ Q3è¯»åˆ°id=1è¿™ä¸€è¡Œçš„ç°è±¡ï¼Œ è¢«ç§°ä¸ºâ€œå¹»è¯»â€ã€‚</p><p><strong>å¹»è¯»æŒ‡çš„æ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨å‰åä¸¤æ¬¡æŸ¥è¯¢åŒä¸€ä¸ªèŒƒå›´çš„æ—¶å€™ï¼Œ åä¸€æ¬¡æŸ¥è¯¢çœ‹åˆ°äº†å‰ä¸€æ¬¡æŸ¥è¯¢æ²¡æœ‰çœ‹åˆ°çš„è¡Œã€‚</strong></p><p><strong>è¯´æ˜</strong></p><ol><li>åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ™®é€šçš„æŸ¥è¯¢æ˜¯å¿«ç…§è¯»ï¼Œæ˜¯ä¸ä¼šçœ‹åˆ°åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®çš„ã€‚å› æ­¤ï¼Œå¹»è¯»åœ¨â€œå½“å‰è¯»â€ä¸‹æ‰ä¼šå‡ºç°ã€‚</li><li>ä¸Šé¢session Bçš„ä¿®æ”¹ç»“æœï¼Œè¢«session Aä¹‹åçš„selectè¯­å¥ç”¨â€œå½“å‰è¯»â€çœ‹åˆ°ï¼Œä¸èƒ½ç§°ä¸ºå¹»è¯»ã€‚<strong>å¹»è¯»ä»…ä¸“æŒ‡â€œæ–°æ’å…¥çš„è¡Œâ€ã€‚</strong></li></ol><p><strong>å¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong></p><p>ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p><p>ä¸‹é¢è¿™ä¸ªä¾‹å­éå¸¸å¥½ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421202546044.png" alt="image-20240421202546044"></p><p>åˆ†æä¸€ä¸‹ä¸Šå›¾</p><ol><li>ç»è¿‡T1æ—¶åˆ»ï¼Œid=5è¿™ä¸€è¡Œå˜æˆ (5,5,100)ï¼Œå½“ç„¶è¿™ä¸ªç»“æœæœ€ç»ˆæ˜¯åœ¨T6æ—¶åˆ»æ­£å¼æäº¤çš„;</li><li>ç»è¿‡T2æ—¶åˆ»ï¼Œid=0è¿™ä¸€è¡Œå˜æˆ(0,5,5);</li><li>ç»è¿‡T4æ—¶åˆ»ï¼Œè¡¨é‡Œé¢å¤šäº†ä¸€è¡Œ(1,5,5);</li><li>å…¶ä»–è¡Œè·Ÿè¿™ä¸ªæ‰§è¡Œåºåˆ—æ— å…³ï¼Œä¿æŒä¸å˜ã€‚</li></ol><p>è¿™äº›æ•°æ®ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬æ¥çœ‹çœ‹binlogé‡Œé¢çš„å†…å®¹ã€‚</p><ol><li>T2æ—¶åˆ»ï¼Œsession Bäº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›</li><li>T4æ—¶åˆ»ï¼Œsession Cäº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›</li><li>T6æ—¶åˆ»ï¼Œsession Aäº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†update t set d=100 where d=5 è¿™æ¡è¯­å¥ã€‚</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> t <span class="keyword">set</span> d<span class="operator">=</span><span class="number">5</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">0</span>; <span class="comment">/*(0,0,5)*/</span></span><br><span class="line"><span class="keyword">update</span> t <span class="keyword">set</span> c<span class="operator">=</span><span class="number">5</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">0</span>; <span class="comment">/*(0,5,5)*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="number">5</span>); <span class="comment">/*(1,1,5)*/</span></span><br><span class="line"><span class="keyword">update</span> t <span class="keyword">set</span> c<span class="operator">=</span><span class="number">5</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>; <span class="comment">/*(1,5,5)*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t <span class="keyword">set</span> d<span class="operator">=</span><span class="number">100</span> <span class="keyword">where</span> d<span class="operator">=</span><span class="number">5</span>;<span class="comment">/*æ‰€æœ‰d=5çš„è¡Œï¼Œdæ”¹æˆ100*/</span></span><br></pre></td></tr></table></figure><p>å¥½ï¼Œä½ åº”è¯¥çœ‹å‡ºé—®é¢˜äº†ã€‚è¿™ä¸ªè¯­å¥åºåˆ—ï¼Œä¸è®ºæ˜¯æ‹¿åˆ°å¤‡åº“å»æ‰§è¡Œï¼Œè¿˜æ˜¯ä»¥åç”¨binlogæ¥å…‹éš†ä¸€ä¸ªåº“ï¼Œè¿™ä¸‰è¡Œçš„ç»“æœï¼Œéƒ½å˜æˆäº† (0,5,100)ã€(1,5,100)å’Œ(5,5,100)ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œid=0å’Œid=1è¿™ä¸¤è¡Œï¼Œå‘ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´ã€‚è¿™ä¸ªé—®é¢˜å¾ˆä¸¥é‡ï¼Œæ˜¯ä¸è¡Œçš„ã€‚</p><p><strong>å¦‚ä½•è§£å†³å¹»è¯»ï¼Ÿ</strong></p><p>è¡Œé”åªèƒ½é”ä½è¡Œï¼Œ ä½†æ˜¯æ–°æ’å…¥è®°å½•è¿™ä¸ªåŠ¨ä½œï¼Œ è¦æ›´æ–°çš„æ˜¯è®°å½•ä¹‹é—´çš„â€œé—´éš™â€ã€‚ å› æ­¤ï¼Œ ä¸ºäº†è§£å†³å¹»è¯»é—®é¢˜ï¼Œ InnoDBåªå¥½å¼•å…¥æ–°çš„é”ï¼Œ ä¹Ÿå°±æ˜¯é—´éš™é”(Gap Lock)ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421202915584.png" alt="image-20240421202915584"></p><p>è§£å†³åŠæ³•ï¼šæ‰§è¡Œ select * from t where d=5 for updateçš„æ—¶å€™ï¼Œ å°±ä¸æ­¢æ˜¯ç»™æ•°æ®åº“ä¸­å·²æœ‰çš„6ä¸ªè®°å½•åŠ ä¸Šäº†è¡Œé”ï¼Œ è¿˜åŒæ—¶åŠ äº†7ä¸ªé—´éš™é”ã€‚ è¿™æ ·å°±ç¡®ä¿äº†æ— æ³•å†æ’å…¥æ–°çš„è®°å½•ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™æ—¶å€™ï¼Œ åœ¨ä¸€è¡Œè¡Œæ‰«æçš„è¿‡ç¨‹ä¸­ï¼Œ ä¸ä»…å°†ç»™è¡ŒåŠ ä¸Šäº†è¡Œé”ï¼Œ è¿˜ç»™è¡Œä¸¤è¾¹çš„ç©ºéš™ï¼Œ ä¹ŸåŠ ä¸Šäº†é—´éš™é”ã€‚</p><p><strong>è·Ÿé—´éš™é”å­˜åœ¨å†²çªå…³ç³»çš„ï¼Œ æ˜¯â€œå¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•â€è¿™ä¸ªæ“ä½œã€‚ é—´éš™é”ä¹‹é—´éƒ½ä¸å­˜åœ¨å†²çªå…³ç³»</strong>ã€‚</p><p>é—´éš™é”å’Œè¡Œé”åˆç§°next-keylockï¼Œ æ¯ä¸ªnext-keylockæ˜¯å‰å¼€åé—­åŒºé—´ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œ æˆ‘ä»¬çš„è¡¨tåˆå§‹åŒ–ä»¥åï¼Œ å¦‚æœç”¨select * from t for updateè¦æŠŠæ•´ä¸ªè¡¨æ‰€æœ‰è®°å½•é”èµ·æ¥ï¼Œ å°±å½¢æˆäº†7ä¸ªnext-key lockï¼Œ åˆ†åˆ«æ˜¯ (-âˆ,0]ã€ (0,5]ã€ (5,10]ã€ (10,15]ã€ (15,20]ã€ (20, 25]ã€ (25, +supremum]ã€‚</p><p>ä½†æ˜¯å¯èƒ½ä¼šæœ‰æ­»é”çš„æƒ…å†µå‘ç”Ÿã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421203059813.png" alt="image-20240421203059813"></p><p>ä½ çœ‹åˆ°äº†ï¼Œå…¶å®éƒ½ä¸éœ€è¦ç”¨åˆ°åé¢çš„updateè¯­å¥ï¼Œå°±å·²ç»å½¢æˆæ­»é”äº†ã€‚æˆ‘ä»¬æŒ‰è¯­å¥æ‰§è¡Œé¡ºåºæ¥åˆ†æä¸€ä¸‹ï¼š</p><ol><li>session A æ‰§è¡Œselect â€¦ for updateè¯­å¥ï¼Œç”±äºid=9è¿™ä¸€è¡Œå¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤ä¼šåŠ ä¸Šé—´éš™é”(5,10);</li><li>session B æ‰§è¡Œselect â€¦ for updateè¯­å¥ï¼ŒåŒæ ·ä¼šåŠ ä¸Šé—´éš™é”(5,10)ï¼Œé—´éš™é”ä¹‹é—´ä¸ä¼šå†²çªï¼Œå› æ­¤è¿™ä¸ªè¯­å¥å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼›</li><li>session B è¯•å›¾æ’å…¥ä¸€è¡Œ(9,9,9)ï¼Œè¢«session Açš„é—´éš™é”æŒ¡ä½äº†ï¼Œåªå¥½è¿›å…¥ç­‰å¾…ï¼›</li><li>session Aè¯•å›¾æ’å…¥ä¸€è¡Œ(9,9,9)ï¼Œè¢«session Bçš„é—´éš™é”æŒ¡ä½äº†ã€‚</li></ol><p>è‡³æ­¤ï¼Œä¸¤ä¸ªsessionè¿›å…¥äº’ç›¸ç­‰å¾…çŠ¶æ€ï¼Œå½¢æˆæ­»é”ã€‚å½“ç„¶ï¼ŒInnoDBçš„æ­»é”æ£€æµ‹é©¬ä¸Šå°±å‘ç°äº†è¿™å¯¹æ­»é”å…³ç³»ï¼Œè®©session Açš„insertè¯­å¥æŠ¥é”™è¿”å›äº†ã€‚</p><p>æœ€åï¼Œè¿™èŠ‚åˆ†æçš„é—®é¢˜éƒ½æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹çš„ï¼Œé—´éš™é”æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹æ‰ä¼šç”Ÿæ•ˆçš„ã€‚æ‰€ä»¥ï¼Œä½ å¦‚æœæŠŠéš”ç¦»çº§åˆ«è®¾ç½®ä¸ºè¯»æäº¤çš„è¯ï¼Œå°±æ²¡æœ‰é—´éš™é”äº†ã€‚ä½†åŒæ—¶ï¼Œä½ è¦è§£å†³å¯èƒ½å‡ºç°çš„æ•°æ®å’Œæ—¥å¿—ä¸ä¸€è‡´é—®é¢˜ï¼Œéœ€è¦æŠŠbinlogæ ¼å¼è®¾ç½®ä¸ºrowã€‚è¿™ä¹Ÿæ˜¯ç°åœ¨ä¸å°‘å…¬å¸ä½¿ç”¨çš„é…ç½®ç»„åˆã€‚</p><h2 id="21-ä¸ºä»€ä¹ˆæˆ‘åªæ”¹ä¸€è¡Œçš„è¯­å¥ï¼Œ-é”è¿™ä¹ˆå¤šï¼Ÿ"><strong>21 | ä¸ºä»€ä¹ˆæˆ‘åªæ”¹ä¸€è¡Œçš„è¯­å¥ï¼Œ</strong> <strong>é”è¿™ä¹ˆå¤šï¼Ÿ</strong></h2><p>ã€é‡ç‚¹ã€‘</p><p><strong>ä»¥ä¸‹é»˜è®¤æ˜¯å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ã€‚</strong></p><ol><li>åŸåˆ™1ï¼šåŠ é”çš„åŸºæœ¬å•ä½æ˜¯next-key lockã€‚å¸Œæœ›ä½ è¿˜è®°å¾—ï¼Œnext-key lockæ˜¯å‰å¼€åé—­åŒºé—´ã€‚</li><li>åŸåˆ™2ï¼šæŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ã€‚</li><li>ä¼˜åŒ–1ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œç»™å”¯ä¸€ç´¢å¼•åŠ é”çš„æ—¶å€™ï¼Œnext-key locké€€åŒ–ä¸ºè¡Œé”ã€‚</li><li>ä¼˜åŒ–2ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œå‘å³éå†æ—¶ä¸”æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶çš„æ—¶å€™ï¼Œnext-key locké€€åŒ–ä¸ºé—´éš™é”ã€‚</li><li>ä¸€ä¸ªbugï¼šå”¯ä¸€ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚</li></ol><p>è¯¥èŠ‚æœ‰è®¸å¤šç»å…¸æ¡ˆä¾‹ï¼Œå›åˆ°å¹³å°æ–‡ç« ç»†çœ‹ï¼Œå°±ä¸å†è¿™é‡Œä¸€ä¸€åˆ—ä¸¾ã€‚</p><h2 id="22-MySQLæœ‰å“ªäº›â€œé¥®é¸©æ­¢æ¸´â€æé«˜æ€§èƒ½çš„æ–¹æ³•ï¼Ÿ"><strong>22 | MySQLæœ‰å“ªäº›â€œé¥®é¸©æ­¢æ¸´â€æé«˜æ€§èƒ½çš„æ–¹æ³•ï¼Ÿ</strong></h2><p>ç¬¬ä¸€ç§æ–¹æ³•ï¼š å…ˆå¤„ç†æ‰é‚£äº›å ç€è¿æ¥ä½†æ˜¯ä¸å·¥ä½œçš„çº¿ç¨‹ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•ï¼š å‡å°‘è¿æ¥è¿‡ç¨‹çš„æ¶ˆè€—ã€‚</p><p><strong>æ…¢æŸ¥è¯¢æ€§èƒ½é—®é¢˜</strong></p><p>å¯¼è‡´æ…¢æŸ¥è¯¢çš„ç¬¬ä¸€ç§å¯èƒ½æ˜¯ï¼Œ ç´¢å¼•æ²¡æœ‰è®¾è®¡å¥½ã€‚</p><p>å¯¼è‡´æ…¢æŸ¥è¯¢çš„ç¬¬äºŒç§å¯èƒ½æ˜¯ï¼Œ è¯­å¥æ²¡å†™å¥½ã€‚</p><p><strong>QPSçªå¢é—®é¢˜</strong></p><ol><li>ä¸€ç§æ˜¯ç”±å…¨æ–°ä¸šåŠ¡çš„bugå¯¼è‡´çš„ã€‚å‡è®¾ä½ çš„DBè¿ç»´æ˜¯æ¯”è¾ƒè§„èŒƒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç™½åå•æ˜¯ä¸€ä¸ªä¸ªåŠ çš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä½ èƒ½å¤Ÿç¡®å®šä¸šåŠ¡æ–¹ä¼šä¸‹æ‰è¿™ä¸ªåŠŸèƒ½ï¼Œåªæ˜¯æ—¶é—´ä¸Šæ²¡é‚£ä¹ˆå¿«ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»æ•°æ®åº“ç«¯ç›´æ¥æŠŠç™½åå•å»æ‰ã€‚</li><li>å¦‚æœè¿™ä¸ªæ–°åŠŸèƒ½ä½¿ç”¨çš„æ˜¯å•ç‹¬çš„æ•°æ®åº“ç”¨æˆ·ï¼Œå¯ä»¥ç”¨ç®¡ç†å‘˜è´¦å·æŠŠè¿™ä¸ªç”¨æˆ·åˆ æ‰ï¼Œç„¶åæ–­å¼€ç°æœ‰è¿æ¥ã€‚è¿™æ ·ï¼Œè¿™ä¸ªæ–°åŠŸèƒ½çš„è¿æ¥ä¸æˆåŠŸï¼Œç”±å®ƒå¼•å‘çš„QPSå°±ä¼šå˜æˆ0ã€‚</li><li>å¦‚æœè¿™ä¸ªæ–°å¢çš„åŠŸèƒ½è·Ÿä¸»ä½“åŠŸèƒ½æ˜¯éƒ¨ç½²åœ¨ä¸€èµ·çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªèƒ½é€šè¿‡å¤„ç†è¯­å¥æ¥é™åˆ¶ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šé¢æåˆ°çš„æŸ¥è¯¢é‡å†™åŠŸèƒ½ï¼ŒæŠŠå‹åŠ›æœ€å¤§çš„SQLè¯­å¥ç›´æ¥é‡å†™æˆ&quot;select 1&quot;è¿”å›ã€‚</li></ol><h2 id="23-MySQLæ˜¯æ€ä¹ˆä¿è¯æ•°æ®ä¸ä¸¢çš„ï¼Ÿ"><strong>23 | MySQLæ˜¯æ€ä¹ˆä¿è¯æ•°æ®ä¸ä¸¢çš„ï¼Ÿ</strong></h2><p>ã€æ—¥å¿—ã€‘</p><p>åªè¦redo logå’Œbinlogä¿è¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œ å°±èƒ½ç¡®ä¿MySQLå¼‚å¸¸é‡å¯åï¼Œ æ•°æ®å¯ä»¥æ¢å¤ã€‚</p><p><strong>binlogçš„å†™å…¥æœºåˆ¶</strong></p><p>äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ å…ˆæŠŠæ—¥å¿—å†™åˆ°binlog cacheï¼Œ äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œ å†æŠŠbinlog cacheå†™åˆ°binlogæ–‡ä»¶ä¸­ã€‚</p><p>ä¸€ä¸ªäº‹åŠ¡çš„binlogæ˜¯ä¸èƒ½è¢«æ‹†å¼€çš„ï¼Œ å› æ­¤ä¸è®ºè¿™ä¸ªäº‹åŠ¡å¤šå¤§ï¼Œ ä¹Ÿè¦ç¡®ä¿ä¸€æ¬¡æ€§å†™å…¥ã€‚</p><p>ç³»ç»Ÿç»™binlog cacheåˆ†é…äº†ä¸€ç‰‡å†…å­˜ï¼Œ æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªï¼Œ å‚æ•° binlog_cache_sizeç”¨äºæ§åˆ¶å•ä¸ªçº¿ç¨‹å†…binlog cacheæ‰€å å†…å­˜çš„å¤§å°ã€‚ å¦‚æœè¶…è¿‡äº†è¿™ä¸ªå‚æ•°è§„å®šçš„å¤§å°ï¼Œ å°±è¦æš‚å­˜åˆ°ç£ç›˜ã€‚äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œ æ‰§è¡Œå™¨æŠŠbinlog cacheé‡Œçš„å®Œæ•´äº‹åŠ¡å†™å…¥åˆ°binlogä¸­ï¼Œ å¹¶æ¸…ç©ºbinlog cacheã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421203459314.png" alt="image-20240421203459314"></p><p><strong>æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±binlog cacheï¼Œ ä½†æ˜¯å…±ç”¨åŒä¸€ä»½binlogæ–‡ä»¶ã€‚</strong></p><p>å›¾ä¸­çš„writeï¼Œ æŒ‡çš„å°±æ˜¯æŒ‡æŠŠæ—¥å¿—å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„page cacheï¼Œ å¹¶æ²¡æœ‰æŠŠæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œ æ‰€ä»¥é€Ÿåº¦æ¯”è¾ƒå¿«ã€‚</p><p>å›¾ä¸­çš„fsyncï¼Œ æ‰æ˜¯å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜çš„æ“ä½œã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ æˆ‘ä»¬è®¤ä¸ºfsyncæ‰å ç£ç›˜çš„IOPSã€‚</p><p><strong>redo logçš„å†™å…¥æœºåˆ¶</strong></p><p>äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ ç”Ÿæˆçš„redologæ˜¯è¦å…ˆå†™åˆ°redo log bufferçš„ã€‚ redo log bufferé‡Œé¢çš„å†…å®¹ï¼Œ æ˜¯ä¸æ˜¯æ¯æ¬¡ç”Ÿæˆåéƒ½è¦ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œ ä¸éœ€è¦ã€‚å¦‚æœäº‹åŠ¡æ‰§è¡ŒæœŸé—´MySQLå‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œ é‚£è¿™éƒ¨åˆ†æ—¥å¿—å°±ä¸¢äº†ã€‚ ç”±äºäº‹åŠ¡å¹¶æ²¡æœ‰æäº¤ï¼Œ æ‰€ä»¥è¿™æ—¶æ—¥å¿—ä¸¢äº†ä¹Ÿä¸ä¼šæœ‰æŸå¤±ã€‚äº‹åŠ¡è¿˜æ²¡æäº¤çš„æ—¶å€™ï¼Œ redo log bufferä¸­çš„éƒ¨åˆ†æ—¥å¿—æœ‰æ²¡æœ‰å¯èƒ½è¢«æŒä¹…åŒ–åˆ°ç£ç›˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œ ç¡®å®ä¼šæœ‰ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421203632190.png" alt="image-20240421203632190"></p><p>è¿™ä¸‰ç§çŠ¶æ€åˆ†åˆ«æ˜¯ï¼š</p><ol><li>å­˜åœ¨redo log bufferä¸­ï¼Œç‰©ç†ä¸Šæ˜¯åœ¨MySQLè¿›ç¨‹å†…å­˜ä¸­ï¼Œå°±æ˜¯å›¾ä¸­çš„çº¢è‰²éƒ¨åˆ†ï¼›</li><li>å†™åˆ°ç£ç›˜(write)ï¼Œä½†æ˜¯æ²¡æœ‰æŒä¹…åŒ–ï¼ˆfsync)ï¼Œç‰©ç†ä¸Šæ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿçš„page cacheé‡Œé¢ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„é»„è‰²éƒ¨åˆ†ï¼›</li><li>æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå¯¹åº”çš„æ˜¯hard diskï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„ç»¿è‰²éƒ¨åˆ†ã€‚</li></ol><p>æ—¥å¿—å†™åˆ°redo log bufferæ˜¯å¾ˆå¿«çš„ï¼Œ wirteåˆ°page cacheä¹Ÿå·®ä¸å¤šï¼Œ ä½†æ˜¯æŒä¹…åŒ–åˆ°ç£ç›˜çš„é€Ÿåº¦å°±æ…¢å¤šäº†ã€‚</p><p>ä¸ºäº†æ§åˆ¶redo logçš„å†™å…¥ç­–ç•¥ï¼ŒInnoDBæä¾›äº†innodb_flush_log_at_trx_commitå‚æ•°ï¼Œå®ƒæœ‰ä¸‰ç§å¯èƒ½å–å€¼ï¼š</p><ol><li>è®¾ç½®ä¸º0çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠredo logç•™åœ¨redo log bufferä¸­;</li><li>è®¾ç½®ä¸º1çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½å°†redo logç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ï¼›</li><li>è®¾ç½®ä¸º2çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠredo logå†™åˆ°page cacheã€‚</li></ol><p>InnoDBæœ‰ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œæ¯éš”1ç§’ï¼Œå°±ä¼šæŠŠredo log bufferä¸­çš„æ—¥å¿—ï¼Œè°ƒç”¨writeå†™åˆ°æ–‡ä»¶ç³»ç»Ÿçš„page cacheï¼Œç„¶åè°ƒç”¨fsyncæŒä¹…åŒ–åˆ°ç£ç›˜ã€‚</p><p>æ³¨æ„ï¼Œäº‹åŠ¡æ‰§è¡Œä¸­é—´è¿‡ç¨‹çš„redo logä¹Ÿæ˜¯ç›´æ¥å†™åœ¨redo log bufferä¸­çš„ï¼Œè¿™äº›redo logä¹Ÿä¼šè¢«åå°çº¿ç¨‹ä¸€èµ·æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæ²¡æœ‰æäº¤çš„äº‹åŠ¡çš„redo logï¼Œä¹Ÿæ˜¯å¯èƒ½å·²ç»æŒä¹…åŒ–åˆ°ç£ç›˜çš„ã€‚</p><p>å®é™…ä¸Šï¼Œé™¤äº†åå°çº¿ç¨‹æ¯ç§’ä¸€æ¬¡çš„è½®è¯¢æ“ä½œå¤–ï¼Œè¿˜æœ‰ä¸¤ç§åœºæ™¯ä¼šè®©ä¸€ä¸ªæ²¡æœ‰æäº¤çš„äº‹åŠ¡çš„redo logå†™å…¥åˆ°ç£ç›˜ä¸­ã€‚</p><ul><li><strong>ä¸€ç§æ˜¯ï¼Œredo log bufferå ç”¨çš„ç©ºé—´å³å°†è¾¾åˆ° innodb_log_buffer_sizeä¸€åŠçš„æ—¶å€™ï¼Œåå°çº¿ç¨‹ä¼šä¸»åŠ¨å†™ç›˜ã€‚</strong></li><li><strong>å¦ä¸€ç§æ˜¯ï¼Œå¹¶è¡Œçš„äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œé¡ºå¸¦å°†è¿™ä¸ªäº‹åŠ¡çš„redo log bufferæŒä¹…åŒ–åˆ°ç£ç›˜ã€‚</strong></li></ul><p>å¦‚æœæŠŠinnodb_flush_log_at_trx_commitè®¾ç½®æˆ1ï¼Œé‚£ä¹ˆredo logåœ¨prepareé˜¶æ®µå°±è¦æŒä¹…åŒ–ä¸€æ¬¡ï¼Œå› ä¸ºæœ‰ä¸€ä¸ªå´©æºƒæ¢å¤é€»è¾‘æ˜¯è¦ä¾èµ–äºprepare çš„redo logï¼Œå†åŠ ä¸Šbinlogæ¥æ¢å¤çš„ã€‚</p><p>æ¯ç§’ä¸€æ¬¡åå°è½®è¯¢åˆ·ç›˜ï¼Œå†åŠ ä¸Šå´©æºƒæ¢å¤è¿™ä¸ªé€»è¾‘ï¼ŒInnoDBå°±è®¤ä¸ºredo logåœ¨commitçš„æ—¶å€™å°±ä¸éœ€è¦fsyncäº†ï¼Œåªä¼šwriteåˆ°æ–‡ä»¶ç³»ç»Ÿçš„page cacheä¸­å°±å¤Ÿäº†ã€‚</p><p><strong>é€šå¸¸æˆ‘ä»¬è¯´MySQLçš„â€œåŒ1â€é…ç½®ï¼ŒæŒ‡çš„å°±æ˜¯sync_binlogå’Œinnodb_flush_log_at_trx_commitéƒ½è®¾ç½®æˆ 1ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡å®Œæ•´æäº¤å‰ï¼Œéœ€è¦ç­‰å¾…ä¸¤æ¬¡åˆ·ç›˜ï¼Œä¸€æ¬¡æ˜¯redo logï¼ˆprepare é˜¶æ®µï¼‰ï¼Œä¸€æ¬¡æ˜¯binlogã€‚</strong></p><p>å…¶å®åˆ°è¿™é‡Œï¼Œæˆ‘çš„ç†è§£æ˜¯æœ¬è´¨å°±æ˜¯2æ¬¡åˆ·ç›˜ç£ç›˜ï¼Œä½†æ˜¯åŠ äº†bufferè¿›è¡Œä¼˜åŒ–ï¼Œæé«˜æ•ˆç‡ã€‚</p><p><strong>ç»„æäº¤</strong></p><p>ä¸‰ä¸ªå¹¶å‘äº‹åŠ¡(trx1, trx2, trx3)åœ¨prepare é˜¶æ®µï¼Œ éƒ½å†™å®Œredo log bufferï¼Œ æŒä¹…åŒ–åˆ°ç£ç›˜çš„è¿‡ç¨‹ï¼Œ å¯¹åº”çš„LSNåˆ†åˆ«æ˜¯50ã€ 120 å’Œ160ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421203939757.png" alt="image-20240421203939757"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ</p><ol><li>trx1æ˜¯ç¬¬ä¸€ä¸ªåˆ°è¾¾çš„ï¼Œä¼šè¢«é€‰ä¸ºè¿™ç»„çš„ leaderï¼›</li><li>ç­‰trx1è¦å¼€å§‹å†™ç›˜çš„æ—¶å€™ï¼Œè¿™ä¸ªç»„é‡Œé¢å·²ç»æœ‰äº†ä¸‰ä¸ªäº‹åŠ¡ï¼Œè¿™æ—¶å€™LSNä¹Ÿå˜æˆäº†160ï¼›</li><li>trx1å»å†™ç›˜çš„æ—¶å€™ï¼Œå¸¦çš„å°±æ˜¯LSN=160ï¼Œå› æ­¤ç­‰trx1è¿”å›æ—¶ï¼Œæ‰€æœ‰LSNå°äºç­‰äº160çš„redo logï¼Œéƒ½å·²ç»è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ï¼›</li><li>è¿™æ—¶å€™trx2å’Œtrx3å°±å¯ä»¥ç›´æ¥è¿”å›äº†ã€‚</li></ol><p>æ‰€ä»¥ï¼Œä¸€æ¬¡ç»„æäº¤é‡Œé¢ï¼Œç»„å‘˜è¶Šå¤šï¼ŒèŠ‚çº¦ç£ç›˜IOPSçš„æ•ˆæœè¶Šå¥½ã€‚</p><p>WALæœºåˆ¶ä¸»è¦å¾—ç›Šäºä¸¤ä¸ªæ–¹é¢ï¼š</p><ol><li>redo log å’Œ binlogéƒ½æ˜¯é¡ºåºå†™ï¼Œç£ç›˜çš„é¡ºåºå†™æ¯”éšæœºå†™é€Ÿåº¦è¦å¿«ï¼›</li><li>ç»„æäº¤æœºåˆ¶ï¼Œå¯ä»¥å¤§å¹…åº¦é™ä½ç£ç›˜çš„IOPSæ¶ˆè€—ã€‚ã€ç£ç›˜IOPSï¼šç£ç›˜IOPSæ˜¯æŒ‡ä¸€ç§’å†…ç£ç›˜è¿›è¡Œå¤šå°‘æ¬¡I/Oè¯»å†™ï¼›ã€‘</li></ol><p><strong>å¦‚æœä½ çš„MySQLç°åœ¨å‡ºç°äº†æ€§èƒ½ç“¶é¢ˆï¼Œ</strong> <strong>è€Œä¸”ç“¶é¢ˆåœ¨IOä¸Šï¼Œ</strong> <strong>å¯ä»¥é€šè¿‡å“ªäº›æ–¹æ³•æ¥æå‡æ€§èƒ½å‘¢ï¼Ÿ</strong></p><ol><li>è®¾ç½® binlog_group_commit_sync_delay å’Œ binlog_group_commit_sync_no_delay_countå‚æ•°ï¼Œå‡å°‘binlogçš„å†™ç›˜æ¬¡æ•°ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯åŸºäºâ€œé¢å¤–çš„æ•…æ„ç­‰å¾…â€æ¥å®ç°çš„ï¼Œå› æ­¤å¯èƒ½ä¼šå¢åŠ è¯­å¥çš„å“åº”æ—¶é—´ï¼Œä½†æ²¡æœ‰ä¸¢å¤±æ•°æ®çš„é£é™©ã€‚</li><li>å°†sync_binlog è®¾ç½®ä¸ºå¤§äº1çš„å€¼ï¼ˆæ¯”è¾ƒå¸¸è§æ˜¯100~1000ï¼‰ã€‚è¿™æ ·åšçš„é£é™©æ˜¯ï¼Œä¸»æœºæ‰ç”µæ—¶ä¼šä¸¢binlogæ—¥å¿—ã€‚</li><li>å°†innodb_flush_log_at_trx_commitè®¾ç½®ä¸º2ã€‚è¿™æ ·åšçš„é£é™©æ˜¯ï¼Œä¸»æœºæ‰ç”µçš„æ—¶å€™ä¼šä¸¢æ•°æ®ã€‚</li></ol><h2 id="24-MySQLæ˜¯æ€ä¹ˆä¿è¯ä¸»å¤‡ä¸€è‡´çš„ï¼Ÿ"><strong>24 | MySQLæ˜¯æ€ä¹ˆä¿è¯ä¸»å¤‡ä¸€è‡´çš„ï¼Ÿ</strong></h2><p>ã€æ—¥å¿—ã€‘</p><p>binlogå¯¹ä¸»å¤‡ä¸€è‡´è´¡çŒ®éå¸¸çš„å¤§ã€‚</p><p><strong>MySQLä¸»å¤‡çš„åŸºæœ¬åŸç†</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421204119341.png" alt="image-20240421204119341"></p><p>èŠ‚ç‚¹Aåˆ°Bè¿™æ¡çº¿çš„å†…éƒ¨æµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421204125172.png" alt="image-20240421204125172"></p><p>ä¸»åº“æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ›´æ–°è¯·æ±‚åï¼Œæ‰§è¡Œå†…éƒ¨äº‹åŠ¡çš„æ›´æ–°é€»è¾‘ï¼ŒåŒæ—¶å†™binlogã€‚</p><p>å¤‡åº“Bè·Ÿä¸»åº“Aä¹‹é—´ç»´æŒäº†ä¸€ä¸ªé•¿è¿æ¥ã€‚ä¸»åº“Aå†…éƒ¨æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸“é—¨ç”¨äºæœåŠ¡å¤‡åº“Bçš„è¿™ä¸ªé•¿è¿æ¥ã€‚ä¸€ä¸ªäº‹åŠ¡æ—¥å¿—åŒæ­¥çš„å®Œæ•´è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>åœ¨å¤‡åº“Bä¸Šé€šè¿‡change masterå‘½ä»¤ï¼Œè®¾ç½®ä¸»åº“Açš„IPã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ï¼Œä»¥åŠè¦ä»å“ªä¸ªä½ç½®å¼€å§‹è¯·æ±‚binlogï¼Œè¿™ä¸ªä½ç½®åŒ…å«æ–‡ä»¶åå’Œæ—¥å¿—åç§»é‡ã€‚</li><li>åœ¨å¤‡åº“Bä¸Šæ‰§è¡Œstart slaveå‘½ä»¤ï¼Œè¿™æ—¶å€™å¤‡åº“ä¼šå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œå°±æ˜¯å›¾ä¸­çš„io_threadå’Œsql_threadã€‚å…¶ä¸­io_threadè´Ÿè´£ä¸ä¸»åº“å»ºç«‹è¿æ¥ã€‚</li><li>ä¸»åº“Aæ ¡éªŒå®Œç”¨æˆ·åã€å¯†ç åï¼Œå¼€å§‹æŒ‰ç…§å¤‡åº“Bä¼ è¿‡æ¥çš„ä½ç½®ï¼Œä»æœ¬åœ°è¯»å–binlogï¼Œå‘ç»™Bã€‚</li><li>å¤‡åº“Bæ‹¿åˆ°binlogåï¼Œå†™åˆ°æœ¬åœ°æ–‡ä»¶ï¼Œç§°ä¸ºä¸­è½¬æ—¥å¿—ï¼ˆrelay logï¼‰ã€‚</li><li>sql_threadè¯»å–ä¸­è½¬æ—¥å¿—ï¼Œè§£æå‡ºæ—¥å¿—é‡Œçš„å‘½ä»¤ï¼Œå¹¶æ‰§è¡Œã€‚</li></ol><p><strong>binlogçš„ä¸‰ç§æ ¼å¼</strong></p><p>å½“binlog_format=statementæ—¶ï¼Œ binlogé‡Œé¢è®°å½•çš„å°±æ˜¯SQLè¯­å¥çš„åŸæ–‡ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421204210641.png" alt="image-20240421204210641"></p><p>æŠŠbinlogçš„æ ¼å¼æ”¹ä¸ºbinlog_format=â€˜rowâ€™</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421204223526.png" alt="image-20240421204223526"></p><p>rowæ ¼å¼çš„binlogé‡Œæ²¡æœ‰äº†SQLè¯­å¥çš„åŸæ–‡ï¼Œ è€Œæ˜¯æ›¿æ¢æˆäº†ä¸¤ä¸ªeventï¼š Table_mapå’ŒDelete_rows</p><p><strong>ä¸ºä»€ä¹ˆä¼šæœ‰mixedè¿™ç§binlogæ ¼å¼çš„å­˜åœ¨åœºæ™¯ï¼Ÿ</strong></p><ul><li>å› ä¸ºæœ‰äº›statementæ ¼å¼çš„binlogå¯èƒ½ä¼šå¯¼è‡´ä¸»å¤‡ä¸ä¸€è‡´ï¼Œæ‰€ä»¥è¦ä½¿ç”¨rowæ ¼å¼ã€‚</li><li>ä½†rowæ ¼å¼çš„ç¼ºç‚¹æ˜¯ï¼Œå¾ˆå ç©ºé—´ã€‚æ¯”å¦‚ä½ ç”¨ä¸€ä¸ªdeleteè¯­å¥åˆ æ‰10ä¸‡è¡Œæ•°æ®ï¼Œç”¨statementçš„è¯å°±æ˜¯ä¸€ä¸ªSQLè¯­å¥è¢«è®°å½•åˆ°binlogä¸­ï¼Œå ç”¨å‡ åä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚ä½†å¦‚æœç”¨rowæ ¼å¼çš„binlogï¼Œå°±è¦æŠŠè¿™10ä¸‡æ¡è®°å½•éƒ½å†™åˆ°binlogä¸­ã€‚è¿™æ ·åšï¼Œä¸ä»…ä¼šå ç”¨æ›´å¤§çš„ç©ºé—´ï¼ŒåŒæ—¶å†™binlogä¹Ÿè¦è€—è´¹IOèµ„æºï¼Œå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚</li><li>æ‰€ä»¥ï¼ŒMySQLå°±å–äº†ä¸ªæŠ˜ä¸­æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯æœ‰äº†mixedæ ¼å¼çš„binlogã€‚<strong>mixedæ ¼å¼çš„æ„æ€æ˜¯ï¼ŒMySQLè‡ªå·±ä¼šåˆ¤æ–­è¿™æ¡SQLè¯­å¥æ˜¯å¦å¯èƒ½å¼•èµ·ä¸»å¤‡ä¸ä¸€è‡´ï¼Œå¦‚æœæœ‰å¯èƒ½ï¼Œå°±ç”¨rowæ ¼å¼ï¼Œå¦åˆ™å°±ç”¨statementæ ¼å¼ã€‚</strong></li></ul><p><strong>å¾ªç¯å¤åˆ¶é—®é¢˜</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421204300198.png" alt="image-20240421204300198"></p><p>åŒMç»“æ„å’ŒM-Sç»“æ„ï¼Œ å…¶å®åŒºåˆ«åªæ˜¯å¤šäº†ä¸€æ¡çº¿ï¼Œ å³ï¼š èŠ‚ç‚¹Aå’ŒBä¹‹é—´æ€»æ˜¯äº’ä¸ºä¸»å¤‡å…³ç³»ã€‚ è¿™æ ·åœ¨åˆ‡æ¢çš„æ—¶å€™å°±ä¸ç”¨å†ä¿®æ”¹ä¸»å¤‡å…³ç³»ã€‚</p><p>ä¸šåŠ¡é€»è¾‘åœ¨èŠ‚ç‚¹Aä¸Šæ›´æ–°äº†ä¸€æ¡è¯­å¥ï¼Œ ç„¶åå†æŠŠç”Ÿæˆçš„binlog å‘ç»™èŠ‚ç‚¹Bï¼Œ èŠ‚ç‚¹Bæ‰§è¡Œå®Œè¿™æ¡æ›´æ–°è¯­å¥åä¹Ÿä¼šç”Ÿæˆbinlogã€‚å¦‚æœèŠ‚ç‚¹AåŒæ—¶æ˜¯èŠ‚ç‚¹Bçš„å¤‡åº“ï¼Œ ç›¸å½“äºåˆæŠŠèŠ‚ç‚¹Bæ–°ç”Ÿæˆçš„binlogæ‹¿è¿‡æ¥æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œ ç„¶åèŠ‚ç‚¹Aå’ŒBé—´ï¼Œ ä¼šä¸æ–­åœ°å¾ªç¯æ‰§è¡Œè¿™ä¸ªæ›´æ–°è¯­å¥ï¼Œ ä¹Ÿå°±æ˜¯å¾ªç¯å¤åˆ¶äº†ã€‚ è¿™ä¸ªè¦æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><p>MySQLåœ¨binlogä¸­è®°å½•äº†è¿™ä¸ªå‘½ä»¤ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶æ‰€åœ¨å®ä¾‹çš„serveridã€‚ å› æ­¤ï¼Œ æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„é€»è¾‘ï¼Œ æ¥è§£å†³ä¸¤ä¸ªèŠ‚ç‚¹é—´çš„å¾ªç¯å¤åˆ¶çš„é—®é¢˜ï¼š</p><ol><li>è§„å®šä¸¤ä¸ªåº“çš„server idå¿…é¡»ä¸åŒï¼Œå¦‚æœç›¸åŒï¼Œåˆ™å®ƒä»¬ä¹‹é—´ä¸èƒ½è®¾å®šä¸ºä¸»å¤‡å…³ç³»ï¼›</li><li>ä¸€ä¸ªå¤‡åº“æ¥åˆ°binlogå¹¶åœ¨é‡æ”¾çš„è¿‡ç¨‹ä¸­ï¼Œç”Ÿæˆä¸åŸbinlogçš„server idç›¸åŒçš„æ–°çš„binlogï¼›</li><li>æ¯ä¸ªåº“åœ¨æ”¶åˆ°ä»è‡ªå·±çš„ä¸»åº“å‘è¿‡æ¥çš„æ—¥å¿—åï¼Œå…ˆåˆ¤æ–­server idï¼Œå¦‚æœè·Ÿè‡ªå·±çš„ç›¸åŒï¼Œè¡¨ç¤ºè¿™ä¸ªæ—¥å¿—æ˜¯è‡ªå·±ç”Ÿæˆçš„ï¼Œå°±ç›´æ¥ä¸¢å¼ƒè¿™ä¸ªæ—¥å¿—ã€‚</li></ol><p>æŒ‰ç…§è¿™ä¸ªé€»è¾‘ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†åŒMç»“æ„ï¼Œæ—¥å¿—çš„æ‰§è¡Œæµå°±ä¼šå˜æˆè¿™æ ·ï¼š</p><ol><li>ä»èŠ‚ç‚¹Aæ›´æ–°çš„äº‹åŠ¡ï¼Œbinlogé‡Œé¢è®°çš„éƒ½æ˜¯Açš„server idï¼›</li><li>ä¼ åˆ°èŠ‚ç‚¹Bæ‰§è¡Œä¸€æ¬¡ä»¥åï¼ŒèŠ‚ç‚¹Bç”Ÿæˆçš„binlog çš„server idä¹Ÿæ˜¯Açš„server idï¼›</li><li>å†ä¼ å›ç»™èŠ‚ç‚¹Aï¼ŒAåˆ¤æ–­åˆ°è¿™ä¸ªserver idä¸è‡ªå·±çš„ç›¸åŒï¼Œå°±ä¸ä¼šå†å¤„ç†è¿™ä¸ªæ—¥å¿—ã€‚æ‰€ä»¥ï¼Œæ­»å¾ªç¯åœ¨è¿™é‡Œå°±æ–­æ‰äº†ã€‚</li></ol><h2 id="25-MySQLæ˜¯æ€ä¹ˆä¿è¯é«˜å¯ç”¨çš„ï¼Ÿ"><strong>25 | MySQLæ˜¯æ€ä¹ˆä¿è¯é«˜å¯ç”¨çš„ï¼Ÿ</strong></h2><p>ã€å°±æ˜¯ä¸»å¤‡ä½å»¶æ—¶ã€‘</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œ åªè¦ä¸»åº“æ‰§è¡Œæ›´æ–°ç”Ÿæˆçš„æ‰€æœ‰binlogï¼Œ éƒ½å¯ä»¥ä¼ åˆ°å¤‡åº“å¹¶è¢«æ­£ç¡®åœ°æ‰§è¡Œï¼Œ å¤‡åº“å°±èƒ½è¾¾åˆ°è·Ÿä¸»åº“ä¸€è‡´çš„çŠ¶æ€ï¼Œ è¿™å°±æ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><p><strong>ä¸»å¤‡å»¶è¿Ÿ</strong></p><p>ä¸»å¤‡åˆ‡æ¢å¯èƒ½æ˜¯ä¸€ä¸ªä¸»åŠ¨è¿ç»´åŠ¨ä½œï¼Œ æ¯”å¦‚è½¯ä»¶å‡çº§ã€ ä¸»åº“æ‰€åœ¨æœºå™¨æŒ‰è®¡åˆ’ä¸‹çº¿ç­‰ï¼Œ ä¹Ÿå¯èƒ½æ˜¯è¢«åŠ¨æ“ä½œï¼Œ æ¯”å¦‚ä¸»åº“æ‰€åœ¨æœºå™¨æ‰ç”µã€‚</p><p>ä¸æ•°æ®åŒæ­¥æœ‰å…³çš„æ—¶é—´ç‚¹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªï¼š</p><ol><li>ä¸»åº“Aæ‰§è¡Œå®Œæˆä¸€ä¸ªäº‹åŠ¡ï¼Œå†™å…¥binlogï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ—¶åˆ»è®°ä¸ºT1;</li><li>ä¹‹åä¼ ç»™å¤‡åº“Bï¼Œæˆ‘ä»¬æŠŠå¤‡åº“Bæ¥æ”¶å®Œè¿™ä¸ªbinlogçš„æ—¶åˆ»è®°ä¸ºT2;</li><li>å¤‡åº“Bæ‰§è¡Œå®Œæˆè¿™ä¸ªäº‹åŠ¡ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ—¶åˆ»è®°ä¸ºT3ã€‚</li></ol><p>æ‰€è°“ä¸»å¤‡å»¶è¿Ÿï¼Œ å°±æ˜¯åŒä¸€ä¸ªäº‹åŠ¡ï¼Œ åœ¨å¤‡åº“æ‰§è¡Œå®Œæˆçš„æ—¶é—´å’Œä¸»åº“æ‰§è¡Œå®Œæˆçš„æ—¶é—´ä¹‹é—´çš„å·®å€¼ï¼Œ ä¹Ÿå°±æ˜¯T3-T1ã€‚</p><p>ä½ å¯ä»¥åœ¨å¤‡åº“ä¸Šæ‰§è¡Œshow slave statuså‘½ä»¤ï¼Œå®ƒçš„è¿”å›ç»“æœé‡Œé¢ä¼šæ˜¾ç¤ºseconds_behind_masterï¼Œç”¨äºè¡¨ç¤ºå½“å‰å¤‡åº“å»¶è¿Ÿäº†å¤šå°‘ç§’ã€‚</p><p><strong>seconds_behind_master</strong>çš„è®¡ç®—æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>æ¯ä¸ªäº‹åŠ¡çš„binlog é‡Œé¢éƒ½æœ‰ä¸€ä¸ªæ—¶é—´å­—æ®µï¼Œç”¨äºè®°å½•ä¸»åº“ä¸Šå†™å…¥çš„æ—¶é—´ï¼›</li><li>å¤‡åº“å–å‡ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡çš„æ—¶é—´å­—æ®µçš„å€¼ï¼Œè®¡ç®—å®ƒä¸å½“å‰ç³»ç»Ÿæ—¶é—´çš„å·®å€¼ï¼Œå¾—åˆ°seconds_behind_masterã€‚</li></ol><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®seconds_behind_masterè¿™ä¸ªå‚æ•°è®¡ç®—çš„å°±æ˜¯T3-T1ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨seconds_behind_masteræ¥ä½œä¸ºä¸»å¤‡å»¶è¿Ÿçš„å€¼ï¼Œè¿™ä¸ªå€¼çš„æ—¶é—´ç²¾åº¦æ˜¯ç§’ã€‚</p><p><strong>ä¸»å¤‡å»¶è¿Ÿæœ€ç›´æ¥çš„è¡¨ç°æ˜¯ï¼Œå¤‡åº“æ¶ˆè´¹ä¸­è½¬æ—¥å¿—ï¼ˆrelay logï¼‰çš„é€Ÿåº¦ï¼Œæ¯”ä¸»åº“ç”Ÿäº§binlogçš„é€Ÿåº¦è¦æ…¢ã€‚</strong></p><p>ä¸‹é¢æ¥è¯´è¯´å¸¸è§çš„ä¾‹å­ã€‚</p><p><strong>ä¸»å¤‡å»¶è¿Ÿçš„æ¥æº</strong></p><ol><li><p>å¤‡åº“æ‰€åœ¨æœºå™¨çš„æ€§èƒ½è¦æ¯”ä¸»åº“æ‰€åœ¨çš„æœºå™¨æ€§èƒ½å·®ã€‚</p></li><li><p>å¤‡åº“çš„å‹åŠ›å¤§ï¼šå¤‡åº“ä¸Šçš„æŸ¥è¯¢è€—è´¹äº†å¤§é‡çš„CPUèµ„æºï¼Œ å½±å“äº†åŒæ­¥é€Ÿåº¦ï¼Œ é€ æˆä¸»å¤‡å»¶è¿Ÿ</p></li></ol><ul><li>ä¸€ä¸»å¤šä»ã€‚é™¤äº†å¤‡åº“å¤–ï¼Œå¯ä»¥å¤šæ¥å‡ ä¸ªä»åº“ï¼Œè®©è¿™äº›ä»åº“æ¥åˆ†æ‹…è¯»çš„å‹åŠ›ã€‚</li><li>é€šè¿‡binlogè¾“å‡ºåˆ°å¤–éƒ¨ç³»ç»Ÿï¼Œæ¯”å¦‚Hadoopè¿™ç±»ç³»ç»Ÿï¼Œè®©å¤–éƒ¨ç³»ç»Ÿæä¾›ç»Ÿè®¡ç±»æŸ¥è¯¢çš„èƒ½åŠ›ã€‚</li></ul><ol start="3"><li>å¤§äº‹åŠ¡</li></ol><p><strong>å¯é æ€§ä¼˜å…ˆç­–ç•¥</strong></p><p>åŒMç»“æ„ä¸‹ï¼Œ ä»çŠ¶æ€1åˆ°çŠ¶æ€2åˆ‡æ¢çš„è¯¦ç»†è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>åˆ¤æ–­å¤‡åº“Bç°åœ¨çš„seconds_behind_masterï¼Œå¦‚æœå°äºæŸä¸ªå€¼ï¼ˆæ¯”å¦‚5ç§’ï¼‰ç»§ç»­ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™æŒç»­é‡è¯•è¿™ä¸€æ­¥ï¼›</li><li>æŠŠä¸»åº“Aæ”¹æˆåªè¯»çŠ¶æ€ï¼Œå³æŠŠreadonlyè®¾ç½®ä¸ºtrueï¼›</li><li>åˆ¤æ–­å¤‡åº“Bçš„seconds_behind_masterçš„å€¼ï¼Œç›´åˆ°è¿™ä¸ªå€¼å˜æˆ0ä¸ºæ­¢ï¼›</li><li>æŠŠå¤‡åº“Bæ”¹æˆå¯è¯»å†™çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æŠŠreadonly è®¾ç½®ä¸ºfalseï¼›</li><li>æŠŠä¸šåŠ¡è¯·æ±‚åˆ‡åˆ°å¤‡åº“Bã€‚</li></ol><p>è¿™ä¸ªåˆ‡æ¢æµç¨‹ï¼Œ ä¸€èˆ¬æ˜¯ç”±ä¸“é—¨çš„HAç³»ç»Ÿæ¥å®Œæˆçš„ï¼Œ æˆ‘ä»¬æš‚æ—¶ç§°ä¹‹ä¸ºå¯é æ€§ä¼˜å…ˆæµç¨‹ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421204637780.png" alt="image-20240421204637780"></p><p><strong>å¯ç”¨æ€§ä¼˜å…ˆç­–ç•¥</strong></p><p>å¼ºè¡ŒæŠŠæ­¥éª¤4ã€ 5è°ƒæ•´åˆ°æœ€å¼€å§‹æ‰§è¡Œï¼Œ ä¹Ÿå°±æ˜¯è¯´ä¸ç­‰ä¸»å¤‡æ•°æ®åŒæ­¥ï¼Œ ç›´æ¥æŠŠè¿æ¥åˆ‡åˆ°å¤‡åº“Bï¼Œ å¹¶ä¸”è®©å¤‡åº“Bå¯ä»¥è¯»å†™ï¼Œ é‚£ä¹ˆç³»ç»Ÿå‡ ä¹å°±æ²¡æœ‰ä¸å¯ç”¨æ—¶é—´äº†ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ªåˆ‡æ¢æµç¨‹ï¼Œ æš‚æ—¶ç§°ä½œ<strong>å¯ç”¨æ€§ä¼˜å…ˆ</strong>æµç¨‹ã€‚ è¿™ä¸ªåˆ‡æ¢æµç¨‹çš„ä»£ä»·ï¼Œ å°±æ˜¯å¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><p><strong>å¯ç”¨æ€§ä¼˜å…ˆç­–ç•¥ï¼Œä¸”binlog_format=mixed</strong>æ—¶çš„åˆ‡æ¢æµç¨‹å’Œæ•°æ®ç»“æœã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421204731138.png" alt="image-20240421204731138"></p><p>ç°åœ¨ï¼Œæˆ‘ä»¬ä¸€èµ·åˆ†æä¸‹è¿™ä¸ªåˆ‡æ¢æµç¨‹ï¼š</p><ol><li>æ­¥éª¤2ä¸­ï¼Œä¸»åº“Aæ‰§è¡Œå®Œinsertè¯­å¥ï¼Œæ’å…¥äº†ä¸€è¡Œæ•°æ®ï¼ˆ4,4ï¼‰ï¼Œä¹‹åå¼€å§‹è¿›è¡Œä¸»å¤‡åˆ‡æ¢ã€‚</li><li>æ­¥éª¤3ä¸­ï¼Œç”±äºä¸»å¤‡ä¹‹é—´æœ‰5ç§’çš„å»¶è¿Ÿï¼Œæ‰€ä»¥å¤‡åº“Bè¿˜æ²¡æ¥å¾—åŠåº”ç”¨â€œæ’å…¥c=4â€è¿™ä¸ªä¸­è½¬æ—¥å¿—ï¼Œå°±å¼€å§‹æ¥æ”¶å®¢æˆ·ç«¯â€œæ’å…¥ c=5â€çš„å‘½ä»¤ã€‚</li><li>æ­¥éª¤4ä¸­ï¼Œå¤‡åº“Bæ’å…¥äº†ä¸€è¡Œæ•°æ®ï¼ˆ4,5ï¼‰ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªbinlogå‘ç»™ä¸»åº“Aã€‚</li><li>æ­¥éª¤5ä¸­ï¼Œå¤‡åº“Bæ‰§è¡Œâ€œæ’å…¥c=4â€è¿™ä¸ªä¸­è½¬æ—¥å¿—ï¼Œæ’å…¥äº†ä¸€è¡Œæ•°æ®ï¼ˆ5,4ï¼‰ã€‚è€Œç›´æ¥åœ¨å¤‡åº“Bæ‰§è¡Œçš„â€œæ’å…¥c=5â€è¿™ä¸ªè¯­å¥ï¼Œä¼ åˆ°ä¸»åº“Aï¼Œå°±æ’å…¥äº†ä¸€è¡Œæ–°æ•°æ®ï¼ˆ5,5ï¼‰ã€‚</li></ol><p>æœ€åçš„ç»“æœå°±æ˜¯ï¼Œä¸»åº“Aå’Œå¤‡åº“Bä¸Šå‡ºç°äº†ä¸¤è¡Œä¸ä¸€è‡´çš„æ•°æ®ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ•°æ®ä¸ä¸€è‡´ï¼Œæ˜¯ç”±å¯ç”¨æ€§ä¼˜å…ˆæµç¨‹å¯¼è‡´çš„ã€‚</p><p><strong>å¯ç”¨æ€§ä¼˜å…ˆç­–ç•¥ï¼Œä½†è®¾ç½®binlog_format=row</strong>æ—¶çš„åˆ‡æ¢æµç¨‹å’Œæ•°æ®ç»“æœã€‚</p><p>å› ä¸ºrowæ ¼å¼åœ¨è®°å½•binlogçš„æ—¶å€™ï¼Œä¼šè®°å½•æ–°æ’å…¥çš„è¡Œçš„æ‰€æœ‰å­—æ®µå€¼ï¼Œæ‰€ä»¥æœ€ååªä¼šæœ‰ä¸€è¡Œä¸ä¸€è‡´ã€‚è€Œä¸”ï¼Œä¸¤è¾¹çš„ä¸»å¤‡åŒæ­¥çš„åº”ç”¨çº¿ç¨‹ä¼šæŠ¥é”™duplicate key errorå¹¶åœæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¤‡åº“Bçš„(5,4)å’Œä¸»åº“Açš„(5,5)è¿™ä¸¤è¡Œæ•°æ®ï¼Œéƒ½ä¸ä¼šè¢«å¯¹æ–¹æ‰§è¡Œã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421204815379.png" alt="image-20240421204815379"></p><p>ç»“è®ºï¼š</p><ol><li>ä½¿ç”¨rowæ ¼å¼çš„binlogæ—¶ï¼Œæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜æ›´å®¹æ˜“è¢«å‘ç°ã€‚è€Œä½¿ç”¨mixedæˆ–è€…statementæ ¼å¼çš„binlogæ—¶ï¼Œæ•°æ®å¾ˆå¯èƒ½æ‚„æ‚„åœ°å°±ä¸ä¸€è‡´äº†ã€‚å¦‚æœä½ è¿‡äº†å¾ˆä¹…æ‰å‘ç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå¾ˆå¯èƒ½è¿™æ—¶çš„æ•°æ®ä¸ä¸€è‡´å·²ç»ä¸å¯æŸ¥ï¼Œæˆ–è€…è¿å¸¦é€ æˆäº†æ›´å¤šçš„æ•°æ®é€»è¾‘ä¸ä¸€è‡´ã€‚</li><li>ä¸»å¤‡åˆ‡æ¢çš„å¯ç”¨æ€§ä¼˜å…ˆç­–ç•¥ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚å› æ­¤ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘éƒ½å»ºè®®ä½ ä½¿ç”¨å¯é æ€§ä¼˜å…ˆç­–ç•¥ã€‚æ¯•ç«Ÿå¯¹æ•°æ®æœåŠ¡æ¥è¯´çš„è¯ï¼Œæ•°æ®çš„å¯é æ€§ä¸€èˆ¬è¿˜æ˜¯è¦ä¼˜äºå¯ç”¨æ€§çš„ã€‚</li></ol><p>MySQLé«˜å¯ç”¨ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œæ˜¯ä¾èµ–äºä¸»å¤‡å»¶è¿Ÿçš„ã€‚å»¶è¿Ÿçš„æ—¶é—´è¶Šå°ï¼Œåœ¨ä¸»åº“æ•…éšœçš„æ—¶å€™ï¼ŒæœåŠ¡æ¢å¤éœ€è¦çš„æ—¶é—´å°±è¶ŠçŸ­ï¼Œå¯ç”¨æ€§å°±è¶Šé«˜ã€‚</p><h2 id="26-å¤‡åº“ä¸ºä»€ä¹ˆä¼šå»¶è¿Ÿå¥½å‡ ä¸ªå°æ—¶ï¼Ÿ"><strong>26 | å¤‡åº“ä¸ºä»€ä¹ˆä¼šå»¶è¿Ÿå¥½å‡ ä¸ªå°æ—¶ï¼Ÿ</strong></h2><p>ã€ä¸­è½¬æ—¥å¿—æ¶ˆè´¹ä¸å¤Ÿå¿«ã€‘</p><p>å¦‚æœå¤‡åº“æ‰§è¡Œæ—¥å¿—çš„é€Ÿåº¦æŒç»­ä½äºä¸»åº“ç”Ÿæˆæ—¥å¿—çš„é€Ÿåº¦ï¼Œ é‚£è¿™ä¸ªå»¶è¿Ÿå°±æœ‰å¯èƒ½æˆäº†å°æ—¶çº§åˆ«ã€‚ è€Œä¸”å¯¹äºä¸€ä¸ªå‹åŠ›æŒç»­æ¯”è¾ƒé«˜çš„ä¸»åº“æ¥è¯´ï¼Œ å¤‡åº“å¾ˆå¯èƒ½æ°¸è¿œéƒ½è¿½ä¸ä¸Šä¸»åº“çš„èŠ‚å¥ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421205013154.png" alt="image-20240421205013154"></p><p>coordinatoråœ¨åˆ†å‘çš„æ—¶å€™ï¼Œ éœ€è¦æ»¡è¶³ä»¥ä¸‹è¿™ä¸¤ä¸ªåŸºæœ¬è¦æ±‚ï¼š</p><ol><li>ä¸èƒ½é€ æˆæ›´æ–°è¦†ç›–ã€‚ è¿™å°±è¦æ±‚æ›´æ–°åŒä¸€è¡Œçš„ä¸¤ä¸ªäº‹åŠ¡ï¼Œ å¿…é¡»è¢«åˆ†å‘åˆ°åŒä¸€ä¸ªworkerä¸­ã€‚</li><li>åŒä¸€ä¸ªäº‹åŠ¡ä¸èƒ½è¢«æ‹†å¼€ï¼Œ å¿…é¡»æ”¾åˆ°åŒä¸€ä¸ªworkerä¸­ã€‚</li></ol><p><strong>MySQL 5.5ç‰ˆæœ¬çš„å¹¶è¡Œå¤åˆ¶ç­–ç•¥</strong></p><p><strong>æŒ‰è¡¨åˆ†å‘ç­–ç•¥</strong></p><p>æŒ‰è¡¨åˆ†å‘äº‹åŠ¡çš„åŸºæœ¬æ€è·¯æ˜¯ï¼Œ å¦‚æœä¸¤ä¸ªäº‹åŠ¡æ›´æ–°ä¸åŒçš„è¡¨ï¼Œ å®ƒä»¬å°±å¯ä»¥å¹¶è¡Œã€‚ å› ä¸ºæ•°æ®æ˜¯å­˜å‚¨åœ¨è¡¨é‡Œçš„ï¼Œ æ‰€ä»¥æŒ‰è¡¨åˆ†å‘ï¼Œ å¯ä»¥ä¿è¯ä¸¤ä¸ªworkerä¸ä¼šæ›´æ–°åŒä¸€è¡Œã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421205026348.png" alt="image-20240421205026348"></p><p><strong>æŒ‰è¡Œåˆ†å‘ç­–ç•¥</strong></p><p>è¦è§£å†³çƒ­ç‚¹è¡¨çš„å¹¶è¡Œå¤åˆ¶é—®é¢˜ï¼Œ å°±éœ€è¦ä¸€ä¸ªæŒ‰è¡Œå¹¶è¡Œå¤åˆ¶çš„æ–¹æ¡ˆã€‚ æŒ‰è¡Œå¤åˆ¶çš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼š å¦‚æœä¸¤ä¸ªäº‹åŠ¡æ²¡æœ‰æ›´æ–°ç›¸åŒçš„è¡Œï¼Œ å®ƒä»¬åœ¨å¤‡åº“ä¸Šå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚ æ˜¾ç„¶ï¼Œ è¿™ä¸ªæ¨¡å¼è¦æ±‚binlogæ ¼å¼å¿…é¡»æ˜¯rowã€‚</p><p>ç›¸æ¯”äºæŒ‰è¡¨å¹¶è¡Œåˆ†å‘ç­–ç•¥ï¼Œ æŒ‰è¡Œå¹¶è¡Œç­–ç•¥åœ¨å†³å®šçº¿ç¨‹åˆ†å‘çš„æ—¶å€™ï¼Œ éœ€è¦æ¶ˆè€—æ›´å¤šçš„è®¡ç®—èµ„æºã€‚</p><p><strong>MySQL 5.6ç‰ˆæœ¬çš„å¹¶è¡Œå¤åˆ¶ç­–ç•¥</strong></p><p>å®˜æ–¹MySQL5.6ç‰ˆæœ¬ï¼Œ æ”¯æŒäº†å¹¶è¡Œå¤åˆ¶ï¼Œ åªæ˜¯æ”¯æŒçš„ç²’åº¦æ˜¯æŒ‰åº“å¹¶è¡Œã€‚è¿™ä¸ªç­–ç•¥çš„å¹¶è¡Œæ•ˆæœï¼Œ å–å†³äºå‹åŠ›æ¨¡å‹ã€‚ å¦‚æœåœ¨ä¸»åº“ä¸Šæœ‰å¤šä¸ªDBï¼Œ å¹¶ä¸”å„ä¸ªDBçš„å‹åŠ›å‡è¡¡ï¼Œ ä½¿ç”¨è¿™ä¸ªç­–ç•¥çš„æ•ˆæœä¼šå¾ˆå¥½ã€‚</p><p><strong>MySQL 5.7çš„å¹¶è¡Œå¤åˆ¶ç­–ç•¥</strong></p><p>MySQL 5.7å¹¶è¡Œå¤åˆ¶ç­–ç•¥çš„æ€æƒ³æ˜¯ï¼š</p><ol><li>åŒæ—¶å¤„äºprepareçŠ¶æ€çš„äº‹åŠ¡ï¼Œ åœ¨å¤‡åº“æ‰§è¡Œæ—¶æ˜¯å¯ä»¥å¹¶è¡Œçš„ï¼›</li><li>å¤„äºprepareçŠ¶æ€çš„äº‹åŠ¡ï¼Œ ä¸å¤„äºcommitçŠ¶æ€çš„äº‹åŠ¡ä¹‹é—´ï¼Œ åœ¨å¤‡åº“æ‰§è¡Œæ—¶ä¹Ÿæ˜¯å¯ä»¥å¹¶è¡Œçš„ã€‚</li></ol><p>ä¸ºä»€ä¹ˆè¦æœ‰å¤šçº¿ç¨‹å¤åˆ¶å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºå•çº¿ç¨‹å¤åˆ¶çš„èƒ½åŠ›å…¨é¢ä½äºå¤šçº¿ç¨‹å¤åˆ¶ï¼Œ å¯¹äºæ›´æ–°å‹åŠ›è¾ƒå¤§çš„ä¸»åº“ï¼Œ å¤‡åº“æ˜¯å¯èƒ½ä¸€ç›´è¿½ä¸ä¸Šä¸»åº“çš„ã€‚ ä»ç°è±¡ä¸Šçœ‹å°±æ˜¯ï¼Œ å¤‡åº“ä¸Šseconds_behind_masterçš„å€¼è¶Šæ¥è¶Šå¤§ã€‚</p><h2 id="27-ä¸»åº“å‡ºé—®é¢˜äº†ï¼Œ-ä»åº“æ€ä¹ˆåŠï¼Ÿ"><strong>27 | ä¸»åº“å‡ºé—®é¢˜äº†ï¼Œ</strong> <strong>ä»åº“æ€ä¹ˆåŠï¼Ÿ</strong></h2><p>ã€ä¸»å¤‡åˆ‡æ¢ï¼Œæ—¥å¿—ä»å“ªå¼€å§‹åŒæ­¥é—®é¢˜ã€‘</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421205036452.png" alt="image-20240421205036452"></p><p>å›¾ä¸­ï¼Œ è™šçº¿ç®­å¤´è¡¨ç¤ºçš„æ˜¯ä¸»å¤‡å…³ç³»ï¼Œ ä¹Ÿå°±æ˜¯Aå’ŒAâ€™äº’ä¸ºä¸»å¤‡ï¼Œ ä»åº“Bã€ Cã€ DæŒ‡å‘çš„æ˜¯ä¸»åº“Aã€‚ä¸€ä¸»å¤šä»çš„è®¾ç½®ï¼Œ ä¸€èˆ¬ç”¨äºè¯»å†™åˆ†ç¦»ï¼Œ ä¸»åº“è´Ÿè´£æ‰€æœ‰çš„å†™å…¥å’Œä¸€éƒ¨åˆ†è¯»ï¼Œ å…¶ä»–çš„è¯»è¯·æ±‚åˆ™ç”±ä»åº“åˆ†æ‹…ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421205046203.png" alt="image-20240421205046203"></p><p>ç›¸æ¯”äºä¸€ä¸»ä¸€å¤‡çš„åˆ‡æ¢æµç¨‹ï¼Œ ä¸€ä¸»å¤šä»ç»“æ„åœ¨åˆ‡æ¢å®Œæˆåï¼Œ Aâ€™ä¼šæˆä¸ºæ–°çš„ä¸»åº“ï¼Œ ä»åº“Bã€ Cã€ Dä¹Ÿè¦æ”¹æ¥åˆ°Aâ€™ã€‚ æ­£æ˜¯ç”±äºå¤šäº†ä»åº“Bã€ Cã€ Dé‡æ–°æŒ‡å‘çš„è¿™ä¸ªè¿‡ç¨‹ï¼Œ æ‰€ä»¥ä¸»å¤‡åˆ‡æ¢çš„å¤æ‚æ€§ä¹Ÿç›¸åº”å¢åŠ äº†ã€‚</p><p><strong>åŸºäºä½ç‚¹çš„ä¸»å¤‡åˆ‡æ¢</strong></p><p>ä¹‹æ‰€ä»¥éœ€è¦è¿™ä¸ªï¼Œæ˜¯å› ä¸ºä»åº“è¦æ¢è¿æ¥çš„ä¸»åº“ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªä½ç‚¹æ˜¯ä¹‹åå¤‡åº“Aâ€˜å’Œä»åº“å¼€å§‹åŒæ­¥çš„ä½ç½®ã€‚</p><p>ä¸€ç§å–åŒæ­¥ä½ç‚¹çš„æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>ç­‰å¾…æ–°ä¸»åº“Aâ€™æŠŠä¸­è½¬æ—¥å¿—ï¼ˆrelay logï¼‰å…¨éƒ¨åŒæ­¥å®Œæˆï¼›</li><li>åœ¨Aâ€™ä¸Šæ‰§è¡Œshow master statuså‘½ä»¤ï¼Œå¾—åˆ°å½“å‰Aâ€™ä¸Šæœ€æ–°çš„File å’Œ Positionï¼›</li><li>å–åŸä¸»åº“Aæ•…éšœçš„æ—¶åˆ»Tï¼›</li><li>ç”¨mysqlbinlogå·¥å…·è§£æAâ€™çš„Fileï¼Œå¾—åˆ°Tæ—¶åˆ»çš„ä½ç‚¹ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog File --stop-datetime=T --start-datetime=T</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421205402957.png" alt="image-20240421205402957"></p><p>å½“ç„¶è¿™ä¸ªå€¼å¹¶ä¸ç²¾ç¡®ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ä½ å¯ä»¥è®¾æƒ³æœ‰è¿™ä¹ˆä¸€ç§æƒ…å†µï¼Œå‡è®¾åœ¨Tè¿™ä¸ªæ—¶åˆ»ï¼Œä¸»åº“Aå·²ç»æ‰§è¡Œå®Œæˆäº†ä¸€ä¸ªinsert è¯­å¥æ’å…¥äº†ä¸€è¡Œæ•°æ®Rï¼Œå¹¶ä¸”å·²ç»å°†binlogä¼ ç»™äº†Aâ€™å’ŒBï¼Œç„¶ååœ¨ä¼ å®Œçš„ç¬é—´ä¸»åº“Açš„ä¸»æœºå°±æ‰ç”µäº†ã€‚</p><p>é‚£ä¹ˆï¼Œè¿™æ—¶å€™ç³»ç»Ÿçš„çŠ¶æ€æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>åœ¨ä»åº“Bä¸Šï¼Œç”±äºåŒæ­¥äº†binlogï¼Œ Rè¿™ä¸€è¡Œå·²ç»å­˜åœ¨ï¼›</li><li>åœ¨æ–°ä¸»åº“Aâ€™ä¸Šï¼Œ Rè¿™ä¸€è¡Œä¹Ÿå·²ç»å­˜åœ¨ï¼Œæ—¥å¿—æ˜¯å†™åœ¨123è¿™ä¸ªä½ç½®ä¹‹åçš„ï¼›</li><li>æˆ‘ä»¬åœ¨ä»åº“Bä¸Šæ‰§è¡Œchange masterå‘½ä»¤ï¼ŒæŒ‡å‘Aâ€™çš„Fileæ–‡ä»¶çš„123ä½ç½®ï¼Œå°±ä¼šæŠŠæ’å…¥Rè¿™ä¸€è¡Œæ•°æ®çš„binlogåˆåŒæ­¥åˆ°ä»åº“Bå»æ‰§è¡Œã€‚</li></ol><p>è¿™æ—¶å€™ï¼Œä»åº“Bçš„åŒæ­¥çº¿ç¨‹å°±ä¼šæŠ¥å‘Š Duplicate entry â€˜id_of_Râ€™ for key â€˜PRIMARYâ€™ é”™è¯¯ï¼Œæç¤ºå‡ºç°äº†ä¸»é”®å†²çªï¼Œç„¶ååœæ­¢åŒæ­¥ã€‚</p><p>å› æ­¤ï¼Œ<strong>æˆ‘ä»¬åœ¨åˆ‡æ¢ä»»åŠ¡çš„æ—¶å€™ï¼Œè¦å…ˆä¸»åŠ¨è·³è¿‡è¿™äº›é”™è¯¯ï¼Œæœ‰ä¸¤ç§å¸¸ç”¨çš„æ–¹æ³•ã€‚</strong></p><p><strong>ä¸€ç§åšæ³•æ˜¯</strong>ï¼Œä¸»åŠ¨è·³è¿‡ä¸€ä¸ªäº‹åŠ¡ã€‚è·³è¿‡å‘½ä»¤çš„å†™æ³•æ˜¯ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> global <span class="attribute">sql_slave_skip_counter</span>=1;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure><p>å› ä¸ºåˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šä¸æ­¢é‡å¤æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ä»åº“Båˆšå¼€å§‹æ¥åˆ°æ–°ä¸»åº“Aâ€™æ—¶ï¼ŒæŒç»­è§‚å¯Ÿï¼Œæ¯æ¬¡ç¢°åˆ°è¿™äº›é”™è¯¯å°±åœä¸‹æ¥ï¼Œæ‰§è¡Œä¸€æ¬¡è·³è¿‡å‘½ä»¤ï¼Œç›´åˆ°ä¸å†å‡ºç°åœä¸‹æ¥çš„æƒ…å†µï¼Œä»¥æ­¤æ¥è·³è¿‡å¯èƒ½æ¶‰åŠçš„æ‰€æœ‰äº‹åŠ¡ã€‚</p><p>**å¦å¤–ä¸€ç§æ–¹å¼æ˜¯ï¼Œ**é€šè¿‡è®¾ç½®slave_skip_errorså‚æ•°ï¼Œç›´æ¥è®¾ç½®è·³è¿‡æŒ‡å®šçš„é”™è¯¯ã€‚</p><p>åœ¨æ‰§è¡Œä¸»å¤‡åˆ‡æ¢æ—¶ï¼Œæœ‰è¿™ä¹ˆä¸¤ç±»é”™è¯¯ï¼Œæ˜¯ç»å¸¸ä¼šé‡åˆ°çš„ï¼š</p><ul><li>1062é”™è¯¯æ˜¯æ’å…¥æ•°æ®æ—¶å”¯ä¸€é”®å†²çªï¼›</li><li>1032é”™è¯¯æ˜¯åˆ é™¤æ•°æ®æ—¶æ‰¾ä¸åˆ°è¡Œã€‚</li></ul><p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠslave_skip_errors è®¾ç½®ä¸º â€œ1032,1062â€ï¼Œè¿™æ ·ä¸­é—´ç¢°åˆ°è¿™ä¸¤ä¸ªé”™è¯¯æ—¶å°±ç›´æ¥è·³è¿‡ã€‚</p><p><strong>GTID</strong></p><p>çŸ¥é“GTIDçš„æ¦‚å¿µè¿™éƒ¨åˆ†å°±éå¸¸å¥½ç†è§£äº†ã€‚</p><p><a href="https://www.bilibili.com/video/BV1rr4y1Q7uy?p=11&amp;vd_source=d6efee335659a376be8deb6c0654e9f7">MySQL5.7 é›†ç¾¤ç®¡ç†ï¼ˆä¸»ä»å¤åˆ¶ã€MHAã€GTIDã€PXCï¼‰</a></p><ol><li><p>å…¨å±€äº‹åŠ¡æ ‡è¯†âˆ¶ global transaction identifiersã€‚</p></li><li><p>GTIDä¸äº‹åŠ¡â€”â€”å¯¹åº”ï¼Œå¹¶ä¸”å…¨å±€å”¯ä¸€IDã€‚</p></li><li><p>ä¸€ä¸ªGTIDåœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šåªæ‰§è¡Œä¸€æ¬¡ã€‚</p></li><li><p>MySQL-5.6.5å¼€å§‹æ”¯æŒGTIDã€‚</p></li></ol><p>ç»„æˆï¼šGTID = server_uuid : transaction_id</p><p>binlogå’ŒGTIDçš„å…³ç³»</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421205708126.png" alt="image-20240421205708126"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421205835872.png" alt="image-20240421205835872"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421205853616.png" alt="image-20240421205853616"></p><h2 id="28-è¯»å†™åˆ†ç¦»æœ‰å“ªäº›å‘ï¼Ÿ"><strong>28 | è¯»å†™åˆ†ç¦»æœ‰å“ªäº›å‘ï¼Ÿ</strong></h2><p>ã€ä»åº“æ²¡æœ‰åŒæ­¥åˆ°ä½ã€‘</p><p>ç”±äºä¸»ä»å¯èƒ½å­˜åœ¨å»¶è¿Ÿï¼Œå®¢æˆ·ç«¯æ‰§è¡Œå®Œä¸€ä¸ªæ›´æ–°äº‹åŠ¡åé©¬ä¸Šå‘èµ·æŸ¥è¯¢ï¼Œå¦‚æœæŸ¥è¯¢é€‰æ‹©çš„æ˜¯ä»åº“çš„è¯ï¼Œå°±æœ‰å¯èƒ½è¯»åˆ°åˆšåˆšçš„äº‹åŠ¡æ›´æ–°ä¹‹å‰çš„çŠ¶æ€ã€‚æˆ‘ä»¬ç§°è¿™ç§è¯»ä¸ºè¿‡æœŸè¯»ã€‚</p><p><strong>å¼ºåˆ¶èµ°ä¸»åº“æ–¹æ¡ˆ</strong></p><p>æˆ‘ä»¬å¯ä»¥å°†æŸ¥è¯¢è¯·æ±‚åˆ†ä¸ºè¿™ä¹ˆä¸¤ç±»ï¼š</p><ol><li><p>å¯¹äºå¿…é¡»è¦æ‹¿åˆ°æœ€æ–°ç»“æœçš„è¯·æ±‚ï¼Œ å¼ºåˆ¶å°†å…¶å‘åˆ°ä¸»åº“ä¸Šã€‚ æ¯”å¦‚ï¼Œ åœ¨ä¸€ä¸ªäº¤æ˜“å¹³å°ä¸Šï¼Œ å–å®¶å‘å¸ƒå•†å“ä»¥åï¼Œ é©¬ä¸Šè¦è¿”å›ä¸»é¡µé¢ï¼Œ çœ‹å•†å“æ˜¯å¦å‘å¸ƒæˆåŠŸã€‚ é‚£ä¹ˆï¼Œ è¿™ä¸ªè¯·æ±‚éœ€è¦æ‹¿åˆ°æœ€æ–°çš„ç»“æœï¼Œ å°±å¿…é¡»èµ°ä¸»åº“ã€‚</p></li><li><p>å¯¹äºå¯ä»¥è¯»åˆ°æ—§æ•°æ®çš„è¯·æ±‚ï¼Œ æ‰å°†å…¶å‘åˆ°ä»åº“ä¸Šã€‚ åœ¨è¿™ä¸ªäº¤æ˜“å¹³å°ä¸Šï¼Œ ä¹°å®¶æ¥é€›å•†é“ºé¡µé¢ï¼Œå°±ç®—æ™šå‡ ç§’çœ‹åˆ°æœ€æ–°å‘å¸ƒçš„å•†å“ï¼Œ ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚ é‚£ä¹ˆï¼Œ è¿™ç±»è¯·æ±‚å°±å¯ä»¥èµ°ä»åº“ã€‚</p></li></ol><p><strong>Sleep æ–¹æ¡ˆ</strong></p><p>ä¸»åº“æ›´æ–°åï¼Œ è¯»ä»åº“ä¹‹å‰å…ˆsleepä¸€ä¸‹ã€‚</p><p><strong>åˆ¤æ–­ä¸»å¤‡æ— å»¶è¿Ÿæ–¹æ¡ˆ</strong></p><p>ç¬¬ä¸€ç§ç¡®ä¿ä¸»å¤‡æ— å»¶è¿Ÿçš„æ–¹æ³•æ˜¯ï¼Œ æ¯æ¬¡ä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚å‰ï¼Œ å…ˆåˆ¤æ–­seconds_behind_masteræ˜¯å¦å·²ç»ç­‰äº0ã€‚ å¦‚æœè¿˜ä¸ç­‰äº0 ï¼Œ é‚£å°±å¿…é¡»ç­‰åˆ°è¿™ä¸ªå‚æ•°å˜ä¸º0æ‰èƒ½æ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚ ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•ï¼Œ å¯¹æ¯”ä½ç‚¹ç¡®ä¿ä¸»å¤‡æ— å»¶è¿Ÿ ã€‚</p><p>ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œ å¯¹æ¯”GTIDé›†åˆç¡®ä¿ä¸»å¤‡æ— å»¶è¿Ÿ ã€‚</p><p><strong>ç­‰ä¸»åº“ä½ç‚¹æ–¹æ¡ˆ</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> master_pos_wait(file, pos[, timeout]);</span><br></pre></td></tr></table></figure><p>è¿™æ¡å‘½ä»¤çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>å®ƒæ˜¯åœ¨ä»åº“æ‰§è¡Œçš„ï¼›</li><li>å‚æ•°fileå’ŒposæŒ‡çš„æ˜¯ä¸»åº“ä¸Šçš„æ–‡ä»¶åå’Œä½ç½®ï¼›</li><li>timeoutå¯é€‰ï¼Œè®¾ç½®ä¸ºæ­£æ•´æ•°Nè¡¨ç¤ºè¿™ä¸ªå‡½æ•°æœ€å¤šç­‰å¾…Nç§’ã€‚</li></ol><p>è¿™ä¸ªå‘½ä»¤æ­£å¸¸è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªæ­£æ•´æ•°Mï¼Œè¡¨ç¤ºä»å‘½ä»¤å¼€å§‹æ‰§è¡Œï¼Œåˆ°åº”ç”¨å®Œfileå’Œposè¡¨ç¤ºçš„binlogä½ç½®ï¼Œæ‰§è¡Œäº†å¤šå°‘äº‹åŠ¡ã€‚</p><p>ä½¿ç”¨é€»è¾‘ï¼š</p><ol><li>trx1äº‹åŠ¡æ›´æ–°å®Œæˆåï¼Œé©¬ä¸Šæ‰§è¡Œshow master statuså¾—åˆ°å½“å‰ä¸»åº“æ‰§è¡Œåˆ°çš„Fileå’ŒPositionï¼›</li><li>é€‰å®šä¸€ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼›</li><li>åœ¨ä»åº“ä¸Šæ‰§è¡Œselect master_pos_wait(File, Position, 1)ï¼›</li><li>å¦‚æœè¿”å›å€¼æ˜¯&gt;=0çš„æ­£æ•´æ•°ï¼Œåˆ™åœ¨è¿™ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼›</li><li>å¦åˆ™ï¼Œåˆ°ä¸»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421210118844.png" alt="image-20240421210118844"></p><p><strong>GTIDæ–¹æ¡ˆ</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">wait_for_executed_gtid_set</span>(<span class="params">gtid_set, <span class="number">1</span></span>)</span>;</span><br></pre></td></tr></table></figure><p>è¿™æ¡å‘½ä»¤çš„é€»è¾‘æ˜¯ï¼š</p><ol><li>ç­‰å¾…ï¼Œç›´åˆ°è¿™ä¸ªåº“æ‰§è¡Œçš„äº‹åŠ¡ä¸­åŒ…å«ä¼ å…¥çš„gtid_setï¼Œè¿”å›0ï¼›</li><li>è¶…æ—¶è¿”å›1ã€‚</li></ol><p>ç­‰GTIDçš„æ‰§è¡Œæµç¨‹å°±å˜æˆäº†ï¼š</p><ol><li>trx1äº‹åŠ¡æ›´æ–°å®Œæˆåï¼Œä»è¿”å›åŒ…ç›´æ¥è·å–è¿™ä¸ªäº‹åŠ¡çš„GTIDï¼Œè®°ä¸ºgtid1ï¼›</li><li>é€‰å®šä¸€ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼›</li><li>åœ¨ä»åº“ä¸Šæ‰§è¡Œ select wait_for_executed_gtid_set(gtid1, 1)ï¼›</li><li>å¦‚æœè¿”å›å€¼æ˜¯0ï¼Œåˆ™åœ¨è¿™ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼›</li><li>å¦åˆ™ï¼Œåˆ°ä¸»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ã€‚</li></ol><p>è·Ÿç­‰ä¸»åº“ä½ç‚¹çš„æ–¹æ¡ˆä¸€æ ·ï¼Œç­‰å¾…è¶…æ—¶åæ˜¯å¦ç›´æ¥åˆ°ä¸»åº“æŸ¥è¯¢ï¼Œéœ€è¦ä¸šåŠ¡å¼€å‘åŒå­¦æ¥åšé™æµè€ƒè™‘ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421210204444.png" alt="image-20240421210204444"></p><h2 id="29-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæ•°æ®åº“æ˜¯ä¸æ˜¯å‡ºé—®é¢˜äº†ï¼Ÿ"><strong>29 | å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæ•°æ®åº“æ˜¯ä¸æ˜¯å‡ºé—®é¢˜äº†ï¼Ÿ</strong></h2><p>ä¸»å¤‡åˆ‡æ¢æœ‰ä¸¤ç§åœºæ™¯ï¼Œ ä¸€ç§æ˜¯ä¸»åŠ¨åˆ‡æ¢ï¼Œ ä¸€ç§æ˜¯è¢«åŠ¨åˆ‡æ¢ã€‚ è€Œå…¶ä¸­è¢«åŠ¨åˆ‡æ¢ï¼Œ å¾€å¾€æ˜¯å› ä¸ºä¸»åº“å‡ºé—®é¢˜äº†ï¼Œ ç”±HAç³»ç»Ÿå‘èµ·çš„ã€‚</p><p><strong>select 1åˆ¤æ–­</strong></p><p>å®é™…ä¸Šï¼Œselect 1æˆåŠŸè¿”å›ï¼Œåªèƒ½è¯´æ˜è¿™ä¸ªåº“çš„è¿›ç¨‹è¿˜åœ¨ï¼Œå¹¶ä¸èƒ½è¯´æ˜ä¸»åº“æ²¡é—®é¢˜ã€‚</p><p><strong>æŸ¥è¡¨åˆ¤æ–­</strong></p><p>ä¸ºäº†èƒ½å¤Ÿæ£€æµ‹InnoDBå¹¶å‘çº¿ç¨‹æ•°è¿‡å¤šå¯¼è‡´çš„ç³»ç»Ÿä¸å¯ç”¨æƒ…å†µï¼Œ æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªè®¿é—®InnoDBçš„åœºæ™¯ã€‚ ä¸€èˆ¬çš„åšæ³•æ˜¯ï¼Œ åœ¨ç³»ç»Ÿåº“ï¼ˆmysqlåº“ï¼‰ é‡Œåˆ›å»ºä¸€ä¸ªè¡¨ï¼Œ æ¯”å¦‚å‘½åä¸ºhealth_checkï¼Œ é‡Œé¢åªæ”¾ä¸€è¡Œæ•°æ®ï¼Œ ç„¶åå®šæœŸæ‰§è¡Œï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.health_check;</span><br></pre></td></tr></table></figure><p>å¯èƒ½å‡ºç°è¯»æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å†™å­˜åœ¨é—®é¢˜ï¼Œè¿˜æ˜¯æ’æŸ¥ä¸å¤Ÿå½»åº•ã€‚</p><p><strong>æ›´æ–°åˆ¤æ–­</strong></p><p>æ—¢ç„¶è¦æ›´æ–°ï¼Œå°±è¦æ”¾ä¸ªæœ‰æ„ä¹‰çš„å­—æ®µï¼Œå¸¸è§åšæ³•æ˜¯æ”¾ä¸€ä¸ªtimestampå­—æ®µï¼Œç”¨æ¥è¡¨ç¤ºæœ€åä¸€æ¬¡æ‰§è¡Œæ£€æµ‹çš„æ—¶é—´ã€‚è¿™æ¡æ›´æ–°è¯­å¥ç±»ä¼¼äºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> mysql.health_check <span class="keyword">set</span> t_modified<span class="operator">=</span>now();</span><br></pre></td></tr></table></figure><p>èŠ‚ç‚¹å¯ç”¨æ€§çš„æ£€æµ‹éƒ½åº”è¯¥åŒ…å«ä¸»åº“å’Œå¤‡åº“ã€‚å¦‚æœç”¨æ›´æ–°æ¥æ£€æµ‹ä¸»åº“çš„è¯ï¼Œé‚£ä¹ˆå¤‡åº“ä¹Ÿè¦è¿›è¡Œæ›´æ–°æ£€æµ‹ã€‚</p><p>ä½†æ˜¯è¿™éƒ½æ˜¯å¤–éƒ¨æä¾›ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨æ•°æ®åº“å‘Šè¯‰æˆ‘ä»¬å†…éƒ¨çš„çœŸå®æƒ…å†µã€‚</p><p><strong>å†…éƒ¨ç»Ÿè®¡</strong></p><p>MySQL 5.6ç‰ˆæœ¬ä»¥åæä¾›çš„performance_schemaåº“ï¼Œå°±åœ¨file_summary_by_event_nameè¡¨é‡Œç»Ÿè®¡äº†æ¯æ¬¡IOè¯·æ±‚çš„æ—¶é—´ã€‚</p><h2 id="30-ç­”ç–‘æ–‡ç« ï¼ˆäºŒï¼‰-ï¼š-ç”¨åŠ¨æ€çš„è§‚ç‚¹çœ‹åŠ é”"><strong>30 | ç­”ç–‘æ–‡ç« ï¼ˆäºŒï¼‰</strong> <strong>ï¼š</strong> <strong>ç”¨åŠ¨æ€çš„è§‚ç‚¹çœ‹åŠ é”</strong></h2><p>åŸåˆ™1ï¼š åŠ é”çš„åŸºæœ¬å•ä½æ˜¯next-keylockã€‚ å¸Œæœ›ä½ è¿˜è®°å¾—ï¼Œ next-keylockæ˜¯å‰å¼€åé—­åŒºé—´ã€‚<br>åŸåˆ™2ï¼š æŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ã€‚<br>ä¼˜åŒ–1ï¼š ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œ ç»™å”¯ä¸€ç´¢å¼•åŠ é”çš„æ—¶å€™ï¼Œ next-keylocké€€åŒ–ä¸ºè¡Œé”ã€‚<br>ä¼˜åŒ–2ï¼š ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œ å‘å³éå†æ—¶ä¸”æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶çš„æ—¶å€™ï¼Œ next-keylocké€€åŒ–ä¸ºé—´éš™é”ã€‚<br>ä¸€ä¸ªbugï¼š å”¯ä¸€ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚</p><h2 id="31-è¯¯åˆ æ•°æ®åé™¤äº†è·‘è·¯ï¼Œ-è¿˜èƒ½æ€ä¹ˆåŠï¼Ÿ"><strong>31 | è¯¯åˆ æ•°æ®åé™¤äº†è·‘è·¯ï¼Œ</strong> <strong>è¿˜èƒ½æ€ä¹ˆåŠï¼Ÿ</strong></h2><p>å…ˆå¯¹å’ŒMySQLç›¸å…³çš„è¯¯åˆ æ•°æ®ï¼Œ åšä¸‹åˆ†ç±»ï¼š</p><ol><li>ä½¿ç”¨deleteè¯­å¥è¯¯åˆ æ•°æ®è¡Œï¼›</li><li>ä½¿ç”¨drop tableæˆ–è€…truncate tableè¯­å¥è¯¯åˆ æ•°æ®è¡¨ï¼›</li><li>ä½¿ç”¨drop databaseè¯­å¥è¯¯åˆ æ•°æ®åº“ï¼›</li><li>ä½¿ç”¨rmå‘½ä»¤è¯¯åˆ æ•´ä¸ªMySQLå®ä¾‹ã€‚</li></ol><p>å…¶å®ä¸»è¦å°±æ˜¯é æ•°æ®åº“è®°å½•çš„æ—¥å¿—æ¢å¤ã€‚</p><p><strong>è¯¯åˆ è¡Œ</strong></p><p>å…·ä½“æ¢å¤æ•°æ®æ—¶ï¼Œ å¯¹å•ä¸ªäº‹åŠ¡åšå¦‚ä¸‹å¤„ç†ï¼š</p><ol><li>å¯¹äºinsertè¯­å¥ï¼Œå¯¹åº”çš„binlog eventç±»å‹æ˜¯Write_rows eventï¼ŒæŠŠå®ƒæ”¹æˆDelete_rows eventå³å¯ï¼›</li><li>åŒç†ï¼Œå¯¹äºdeleteè¯­å¥ï¼Œä¹Ÿæ˜¯å°†Delete_rows eventæ”¹ä¸ºWrite_rows eventï¼›</li><li>è€Œå¦‚æœæ˜¯Update_rowsçš„è¯ï¼Œbinlogé‡Œé¢è®°å½•äº†æ•°æ®è¡Œä¿®æ”¹å‰å’Œä¿®æ”¹åçš„å€¼ï¼Œå¯¹è°ƒè¿™ä¸¤è¡Œçš„ä½ç½®å³å¯ã€‚</li></ol><p><strong>è¯¯åˆ åº“/è¡¨</strong></p><p>è¿™ç§æƒ…å†µä¸‹ï¼Œ è¦æƒ³æ¢å¤æ•°æ®ï¼Œ å°±éœ€è¦ä½¿ç”¨å…¨é‡å¤‡ä»½ï¼Œ åŠ å¢é‡æ—¥å¿—çš„æ–¹å¼äº†ã€‚ è¿™ä¸ªæ–¹æ¡ˆè¦æ±‚çº¿ä¸Šæœ‰å®šæœŸçš„å…¨é‡å¤‡ä»½ï¼Œ å¹¶ä¸”å®æ—¶å¤‡ä»½binlogã€‚åœ¨è¿™ä¸¤ä¸ªæ¡ä»¶éƒ½å…·å¤‡çš„æƒ…å†µä¸‹ï¼Œ å‡å¦‚æœ‰äººä¸­åˆ12ç‚¹è¯¯åˆ äº†ä¸€ä¸ªåº“ï¼Œ æ¢å¤æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>å–æœ€è¿‘ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œ å‡è®¾è¿™ä¸ªåº“æ˜¯ä¸€å¤©ä¸€å¤‡ï¼Œ ä¸Šæ¬¡å¤‡ä»½æ˜¯å½“å¤©0ç‚¹ï¼›</p></li><li><p>ç”¨å¤‡ä»½æ¢å¤å‡ºä¸€ä¸ªä¸´æ—¶åº“ï¼›</p></li><li><p>ä»æ—¥å¿—å¤‡ä»½é‡Œé¢ï¼Œ å–å‡ºå‡Œæ™¨0ç‚¹ä¹‹åçš„æ—¥å¿—ï¼›</p></li><li><p>æŠŠè¿™äº›æ—¥å¿—ï¼Œ é™¤äº†è¯¯åˆ é™¤æ•°æ®çš„è¯­å¥å¤–ï¼Œ å…¨éƒ¨åº”ç”¨åˆ°ä¸´æ—¶åº“ã€‚</p></li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421211155332.png" alt="image-20240421211155332"></p><p><strong>å»¶è¿Ÿå¤åˆ¶å¤‡åº“</strong></p><p>æˆ‘ä»¬å¯ä»¥è€ƒè™‘**æ­å»ºå»¶è¿Ÿå¤åˆ¶çš„å¤‡åº“ã€‚**è¿™ä¸ªåŠŸèƒ½æ˜¯MySQL 5.6ç‰ˆæœ¬å¼•å…¥çš„ã€‚</p><p>ä¸€èˆ¬çš„ä¸»å¤‡å¤åˆ¶ç»“æ„å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœä¸»åº“ä¸Šæœ‰ä¸ªè¡¨è¢«è¯¯åˆ äº†ï¼Œè¿™ä¸ªå‘½ä»¤å¾ˆå¿«ä¹Ÿä¼šè¢«å‘ç»™æ‰€æœ‰ä»åº“ï¼Œè¿›è€Œå¯¼è‡´æ‰€æœ‰ä»åº“çš„æ•°æ®è¡¨ä¹Ÿéƒ½ä¸€èµ·è¢«è¯¯åˆ äº†ã€‚</p><p>å»¶è¿Ÿå¤åˆ¶çš„å¤‡åº“æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¤‡åº“ï¼Œé€šè¿‡ CHANGE MASTER TO MASTER_DELAY = Nå‘½ä»¤ï¼Œå¯ä»¥æŒ‡å®šè¿™ä¸ªå¤‡åº“æŒç»­ä¿æŒè·Ÿä¸»åº“æœ‰Nç§’çš„å»¶è¿Ÿã€‚</p><p>æ¯”å¦‚ä½ æŠŠNè®¾ç½®ä¸º3600ï¼Œè¿™å°±ä»£è¡¨äº†å¦‚æœä¸»åº“ä¸Šæœ‰æ•°æ®è¢«è¯¯åˆ äº†ï¼Œå¹¶ä¸”åœ¨1å°æ—¶å†…å‘ç°äº†è¿™ä¸ªè¯¯æ“ä½œå‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤å°±è¿˜æ²¡æœ‰åœ¨è¿™ä¸ªå»¶è¿Ÿå¤åˆ¶çš„å¤‡åº“æ‰§è¡Œã€‚è¿™æ—¶å€™åˆ°è¿™ä¸ªå¤‡åº“ä¸Šæ‰§è¡Œstop slaveï¼Œå†é€šè¿‡ä¹‹å‰ä»‹ç»çš„æ–¹æ³•ï¼Œè·³è¿‡è¯¯æ“ä½œå‘½ä»¤ï¼Œå°±å¯ä»¥æ¢å¤å‡ºéœ€è¦çš„æ•°æ®ã€‚</p><p>è¿™æ ·çš„è¯ï¼Œä½ å°±éšæ—¶å¯ä»¥å¾—åˆ°ä¸€ä¸ªï¼Œåªéœ€è¦æœ€å¤šå†è¿½1å°æ—¶ï¼Œå°±å¯ä»¥æ¢å¤å‡ºæ•°æ®çš„ä¸´æ—¶å®ä¾‹ï¼Œä¹Ÿå°±ç¼©çŸ­äº†æ•´ä¸ªæ•°æ®æ¢å¤éœ€è¦çš„æ—¶é—´ã€‚</p><p><strong>é¢„é˜²è¯¯åˆ åº“/è¡¨çš„æ–¹æ³•</strong></p><p>ç¬¬ä¸€æ¡å»ºè®®æ˜¯ï¼Œè´¦å·åˆ†ç¦»ã€‚ç¬¬äºŒæ¡å»ºè®®æ˜¯ï¼Œåˆ¶å®šæ“ä½œè§„èŒƒã€‚</p><p><strong>rmåˆ é™¤æ•°æ®</strong></p><p>åªè¦ä¸æ˜¯æ¶æ„åœ°æŠŠæ•´ä¸ªé›†ç¾¤åˆ é™¤ï¼Œ è€Œåªæ˜¯åˆ æ‰äº†å…¶ä¸­æŸä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®çš„è¯ï¼Œ HAç³»ç»Ÿå°±ä¼šå¼€å§‹å·¥ä½œï¼Œ é€‰å‡ºä¸€ä¸ªæ–°çš„ä¸»åº“ï¼Œ ä»è€Œä¿è¯æ•´ä¸ªé›†ç¾¤çš„æ­£å¸¸å·¥ä½œã€‚è¿™æ—¶ï¼Œ ä½ è¦åšçš„å°±æ˜¯åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸ŠæŠŠæ•°æ®æ¢å¤å›æ¥ï¼Œ å†æ¥å…¥æ•´ä¸ªé›†ç¾¤</p><h2 id="32-ä¸ºä»€ä¹ˆè¿˜æœ‰killä¸æ‰çš„è¯­å¥ï¼Ÿ"><strong>32 | ä¸ºä»€ä¹ˆè¿˜æœ‰killä¸æ‰çš„è¯­å¥ï¼Ÿ</strong></h2><p>åœ¨MySQLä¸­æœ‰ä¸¤ä¸ªkillå‘½ä»¤ï¼š ä¸€ä¸ªæ˜¯kill query+çº¿ç¨‹idï¼Œ è¡¨ç¤ºç»ˆæ­¢è¿™ä¸ªçº¿ç¨‹ä¸­æ­£åœ¨æ‰§è¡Œçš„è¯­å¥ï¼› ä¸€ä¸ªæ˜¯kill connection +çº¿ç¨‹idï¼Œ è¿™é‡Œconnectionå¯ç¼ºçœï¼Œ è¡¨ç¤ºæ–­å¼€è¿™ä¸ªçº¿ç¨‹çš„è¿æ¥ï¼Œ å½“ç„¶å¦‚æœè¿™ä¸ªçº¿ç¨‹æœ‰è¯­å¥æ­£åœ¨æ‰§è¡Œï¼Œ ä¹Ÿæ˜¯è¦å…ˆåœæ­¢æ­£åœ¨æ‰§è¡Œçš„è¯­å¥çš„ã€‚ä¸çŸ¥é“ä½ åœ¨ä½¿ç”¨MySQLçš„æ—¶å€™ï¼Œ æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„ç°è±¡ï¼š ä½¿ç”¨äº†killå‘½ä»¤ï¼Œ å´æ²¡èƒ½æ–­å¼€è¿™ä¸ªè¿æ¥ã€‚ å†æ‰§è¡Œshow processlistå‘½ä»¤ï¼Œ çœ‹åˆ°è¿™æ¡è¯­å¥çš„Commandåˆ—æ˜¾ç¤ºçš„æ˜¯Killedã€‚</p><p>killå¹¶ä¸æ˜¯é©¬ä¸Šåœæ­¢çš„æ„æ€ï¼Œ è€Œæ˜¯å‘Šè¯‰æ‰§è¡Œçº¿ç¨‹è¯´ï¼Œ è¿™æ¡è¯­å¥å·²ç»ä¸éœ€è¦ç»§ç»­æ‰§è¡Œäº†ï¼Œå¯ä»¥å¼€å§‹â€œæ‰§è¡Œåœæ­¢çš„é€»è¾‘äº†â€ã€‚</p><p>MySQLå®¢æˆ·ç«¯å‘é€è¯·æ±‚åï¼Œ æ¥æ”¶æœåŠ¡ç«¯è¿”å›ç»“æœçš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ol><li><p>ä¸€ç§æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œ ä¹Ÿå°±æ˜¯åœ¨æœ¬åœ°å¼€ä¸€ç‰‡å†…å­˜ï¼Œ å…ˆæŠŠç»“æœå­˜èµ·æ¥ã€‚ å¦‚æœä½ ç”¨APIå¼€å‘ï¼Œ å¯¹åº”çš„å°±æ˜¯mysql_store_result æ–¹æ³•ã€‚</p></li><li><p>å¦ä¸€ç§æ˜¯ä¸ç¼“å­˜ï¼Œ è¯»ä¸€ä¸ªå¤„ç†ä¸€ä¸ªã€‚ å¦‚æœä½ ç”¨APIå¼€å‘ï¼Œ å¯¹åº”çš„å°±æ˜¯mysql_use_resultæ–¹æ³•ã€‚</p></li></ol><h2 id="33-æˆ‘æŸ¥è¿™ä¹ˆå¤šæ•°æ®ï¼Œ-ä¼šä¸ä¼šæŠŠæ•°æ®åº“å†…å­˜æ‰“çˆ†ï¼Ÿ"><strong>33 | æˆ‘æŸ¥è¿™ä¹ˆå¤šæ•°æ®ï¼Œ</strong> <strong>ä¼šä¸ä¼šæŠŠæ•°æ®åº“å†…å­˜æ‰“çˆ†ï¼Ÿ</strong></h2><p>å…¶å®è¿™ç¯‡æ–‡ç« ä¸»è¦è¯´çš„æ˜¯MySQLæ˜¯è¾¹è¯»è¾¹å‘çš„ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºå’ŒDBMSçš„buffer poolä¹Ÿæœ‰å…³ç³»ã€‚</p><p><strong>å…¨è¡¨æ‰«æå¯¹serverå±‚çš„å½±å“</strong></p><p>InnoDBçš„æ•°æ®æ˜¯ä¿å­˜åœ¨ä¸»é”®ç´¢å¼•ä¸Šçš„ï¼Œ æ‰€ä»¥å…¨è¡¨æ‰«æå®é™…ä¸Šæ˜¯ç›´æ¥æ‰«æè¡¨tçš„ä¸»é”®ç´¢å¼•ã€‚ è¿™æ¡æŸ¥è¯¢è¯­å¥ç”±äºæ²¡æœ‰å…¶ä»–çš„åˆ¤æ–­æ¡ä»¶ï¼Œ æ‰€ä»¥æŸ¥åˆ°çš„æ¯ä¸€è¡Œéƒ½å¯ä»¥ç›´æ¥æ”¾åˆ°ç»“æœé›†é‡Œé¢ï¼Œ ç„¶åè¿”å›ç»™å®¢æˆ·ç«¯</p><p>å®é™…ä¸Šï¼Œ æœåŠ¡ç«¯å¹¶ä¸éœ€è¦ä¿å­˜ä¸€ä¸ªå®Œæ•´çš„ç»“æœé›†ã€‚ å–æ•°æ®å’Œå‘æ•°æ®çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li><p>è·å–ä¸€è¡Œï¼Œ å†™åˆ°net_bufferä¸­ã€‚ è¿™å—å†…å­˜çš„å¤§å°æ˜¯ç”±å‚æ•°net_buffer_lengthå®šä¹‰çš„ï¼Œ é»˜è®¤æ˜¯16kã€‚</p></li><li><p>é‡å¤è·å–è¡Œï¼Œ ç›´åˆ°net_bufferå†™æ»¡ï¼Œ è°ƒç”¨ç½‘ç»œæ¥å£å‘å‡ºå»ã€‚</p></li><li><p>å¦‚æœå‘é€æˆåŠŸï¼Œ å°±æ¸…ç©ºnet_bufferï¼Œ ç„¶åç»§ç»­å–ä¸‹ä¸€è¡Œï¼Œ å¹¶å†™å…¥net_bufferã€‚</p></li><li><p>å¦‚æœå‘é€å‡½æ•°è¿”å›EAGAINæˆ–WSAEWOULDBLOCKï¼Œ å°±è¡¨ç¤ºæœ¬åœ°ç½‘ç»œæ ˆï¼ˆsocket send bufferï¼‰ å†™æ»¡äº†ï¼Œ è¿›å…¥ç­‰å¾…ã€‚ ç›´åˆ°ç½‘ç»œæ ˆé‡æ–°å¯å†™ï¼Œ å†ç»§ç»­å‘é€ã€‚</p></li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421211458092.png" alt="image-20240421211458092"></p><p><strong>MySQLæ˜¯â€œè¾¹è¯»è¾¹å‘çš„â€</strong>ï¼Œè¿™ä¸ªæ¦‚å¿µå¾ˆé‡è¦ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœå®¢æˆ·ç«¯æ¥æ”¶å¾—æ…¢ï¼Œä¼šå¯¼è‡´MySQLæœåŠ¡ç«¯ç”±äºç»“æœå‘ä¸å‡ºå»ï¼Œè¿™ä¸ªäº‹åŠ¡çš„æ‰§è¡Œæ—¶é—´å˜é•¿ã€‚</p><p>åœ¨show processlistå‘½ä»¤ä¸­çš„Stateåˆ—çš„å€¼ä¸€ç›´å¤„äº**â€œSending to clientâ€**ï¼Œå°±è¡¨ç¤ºæœåŠ¡å™¨ç«¯çš„ç½‘ç»œæ ˆå†™æ»¡äº†ã€‚</p><p><strong>å¯¹äºæ­£å¸¸çš„çº¿ä¸Šä¸šåŠ¡æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªæŸ¥è¯¢çš„è¿”å›ç»“æœä¸ä¼šå¾ˆå¤šçš„è¯ï¼Œæˆ‘éƒ½å»ºè®®ä½ ä½¿ç”¨mysql_store_resultè¿™ä¸ªæ¥å£ï¼Œç›´æ¥æŠŠæŸ¥è¯¢ç»“æœä¿å­˜åˆ°æœ¬åœ°å†…å­˜ã€‚</strong></p><p><strong>Sending data</strong>ï¼šå®ƒçš„æ„æ€åªæ˜¯â€œæ­£åœ¨æ‰§è¡Œâ€ã€‚</p><p><strong>å…¨è¡¨æ‰«æå¯¹InnoDBçš„å½±å“</strong></p><p>InnoDBå†…å­˜ç®¡ç†ç”¨çš„æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨ (Least RecentlyUsed, LRU)ç®—æ³•ï¼Œ è¿™ä¸ªç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯æ·˜æ±°æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421211510369.png" alt="image-20240421211510369"></p><p>InnoDBä¸èƒ½ç›´æ¥ä½¿ç”¨è¿™ä¸ªLRUç®—æ³•ã€‚ å®é™…ä¸Šï¼Œ InnoDBå¯¹LRUç®—æ³•åšäº†æ”¹è¿›ã€‚åœ¨InnoDBå®ç°ä¸Šï¼Œ æŒ‰ç…§5:3çš„æ¯”ä¾‹æŠŠæ•´ä¸ªLRUé“¾è¡¨åˆ†æˆäº†youngåŒºåŸŸå’ŒoldåŒºåŸŸã€‚ å›¾ä¸­LRU_oldæŒ‡å‘çš„å°±æ˜¯oldåŒºåŸŸçš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œ æ˜¯æ•´ä¸ªé“¾è¡¨çš„5/8å¤„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œ é è¿‘é“¾è¡¨å¤´éƒ¨çš„5/8æ˜¯youngåŒºåŸŸï¼Œ é è¿‘é“¾è¡¨å°¾éƒ¨çš„3/8æ˜¯oldåŒºåŸŸã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421211516058.png" alt="image-20240421211516058"></p><p>æ”¹è¿›åçš„LRUç®—æ³•æ‰§è¡Œæµç¨‹å˜æˆäº†ä¸‹é¢è¿™æ ·ã€‚</p><ol><li><p>å›¾7ä¸­çŠ¶æ€1ï¼Œ è¦è®¿é—®æ•°æ®é¡µP3ï¼Œ ç”±äºP3åœ¨youngåŒºåŸŸï¼Œ å› æ­¤å’Œä¼˜åŒ–å‰çš„LRUç®—æ³•ä¸€æ ·ï¼Œ å°†å…¶ç§»åˆ°é“¾è¡¨å¤´éƒ¨ï¼Œ å˜æˆçŠ¶æ€2ã€‚</p></li><li><p>ä¹‹åè¦è®¿é—®ä¸€ä¸ªæ–°çš„ä¸å­˜åœ¨äºå½“å‰é“¾è¡¨çš„æ•°æ®é¡µï¼Œ è¿™æ—¶å€™ä¾ç„¶æ˜¯æ·˜æ±°æ‰æ•°æ®é¡µPmï¼Œ ä½†æ˜¯æ–°æ’å…¥çš„æ•°æ®é¡µPxï¼Œ æ˜¯æ”¾åœ¨LRU_oldå¤„ã€‚</p></li><li><p>å¤„äºoldåŒºåŸŸçš„æ•°æ®é¡µï¼Œ æ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™éƒ½è¦åšä¸‹é¢è¿™ä¸ªåˆ¤æ–­ï¼šè‹¥è¿™ä¸ªæ•°æ®é¡µåœ¨LRUé“¾è¡¨ä¸­å­˜åœ¨çš„æ—¶é—´è¶…è¿‡äº†1ç§’ï¼Œ å°±æŠŠå®ƒç§»åŠ¨åˆ°é“¾è¡¨å¤´éƒ¨ï¼›å¦‚æœè¿™ä¸ªæ•°æ®é¡µåœ¨LRUé“¾è¡¨ä¸­å­˜åœ¨çš„æ—¶é—´çŸ­äº1ç§’ï¼Œ ä½ç½®ä¿æŒä¸å˜ã€‚ 1ç§’è¿™ä¸ªæ—¶é—´ï¼Œ æ˜¯ç”±å‚æ•°innodb_old_blocks_timeæ§åˆ¶çš„ã€‚ å…¶é»˜è®¤å€¼æ˜¯1000ï¼Œ å•ä½æ¯«ç§’ã€‚</p></li></ol><p>æˆ‘ä»¬çœ‹çœ‹æ”¹è¿›åçš„LRUç®—æ³•çš„æ“ä½œé€»è¾‘ï¼š</p><ol><li><p>æ‰«æè¿‡ç¨‹ä¸­ï¼Œ éœ€è¦æ–°æ’å…¥çš„æ•°æ®é¡µï¼Œ éƒ½è¢«æ”¾åˆ°oldåŒºåŸŸ;</p></li><li><p>ä¸€ä¸ªæ•°æ®é¡µé‡Œé¢æœ‰å¤šæ¡è®°å½•ï¼Œ è¿™ä¸ªæ•°æ®é¡µä¼šè¢«å¤šæ¬¡è®¿é—®åˆ°ï¼Œ ä½†ç”±äºæ˜¯é¡ºåºæ‰«æï¼Œ è¿™ä¸ªæ•°æ®é¡µç¬¬ä¸€æ¬¡è¢«è®¿é—®å’Œæœ€åä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´é—´éš”ä¸ä¼šè¶…è¿‡1ç§’ï¼Œ å› æ­¤è¿˜æ˜¯ä¼šè¢«ä¿ç•™åœ¨oldåŒºåŸŸï¼›</p></li><li><p>å†ç»§ç»­æ‰«æåç»­çš„æ•°æ®ï¼Œ ä¹‹å‰çš„è¿™ä¸ªæ•°æ®é¡µä¹‹åä¹Ÿä¸ä¼šå†è¢«è®¿é—®åˆ°ï¼Œ äºæ˜¯å§‹ç»ˆæ²¡æœ‰æœºä¼šç§»åˆ°é“¾è¡¨å¤´éƒ¨ï¼ˆä¹Ÿå°±æ˜¯youngåŒºåŸŸï¼‰ ï¼Œ å¾ˆå¿«å°±ä¼šè¢«æ·˜æ±°å‡ºå»ã€‚</p></li></ol><h2 id="34-åˆ°åº•å¯ä¸å¯ä»¥ä½¿ç”¨joinï¼Ÿ"><strong>34 | åˆ°åº•å¯ä¸å¯ä»¥ä½¿ç”¨joinï¼Ÿ</strong></h2><p>åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œ å…³äºjoinè¯­å¥ä½¿ç”¨çš„é—®é¢˜ï¼Œ ä¸€èˆ¬ä¼šé›†ä¸­åœ¨ä»¥ä¸‹ä¸¤ç±»ï¼š</p><ol><li><p>æˆ‘ä»¬DBAä¸è®©ä½¿ç”¨joinï¼Œ ä½¿ç”¨joinæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p></li><li><p>å¦‚æœæœ‰ä¸¤ä¸ªå¤§å°ä¸åŒçš„è¡¨åšjoinï¼Œ åº”è¯¥ç”¨å“ªä¸ªè¡¨åšé©±åŠ¨è¡¨å‘¢ï¼Ÿ</p></li></ol><p><strong>Index Nested-Loop Join</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 straight_join t2 <span class="keyword">on</span> (t1.a<span class="operator">=</span>t2.a);</span><br></pre></td></tr></table></figure><p>å¦‚æœç›´æ¥ä½¿ç”¨joinè¯­å¥ï¼Œ MySQLä¼˜åŒ–å™¨å¯èƒ½ä¼šé€‰æ‹©è¡¨t1æˆ–t2ä½œä¸ºé©±åŠ¨è¡¨ï¼Œ è¿™æ ·ä¼šå½±å“æˆ‘ä»¬åˆ†æSQLè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹ã€‚ æ‰€ä»¥ï¼Œ ä¸ºäº†ä¾¿äºåˆ†ææ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ€§èƒ½é—®é¢˜ï¼Œ æˆ‘æ”¹ç”¨straight_joinè®©MySQLä½¿ç”¨å›ºå®šçš„è¿æ¥æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ï¼Œ è¿™æ ·ä¼˜åŒ–å™¨åªä¼šæŒ‰ç…§æˆ‘ä»¬æŒ‡å®šçš„æ–¹å¼å»joinã€‚ åœ¨è¿™ä¸ªè¯­å¥é‡Œï¼Œ t1 æ˜¯é©±åŠ¨è¡¨ï¼Œ t2æ˜¯è¢«é©±åŠ¨è¡¨ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421212736792.png" alt="image-20240421212736792"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œ åœ¨è¿™æ¡è¯­å¥é‡Œï¼Œ è¢«é©±åŠ¨è¡¨t2çš„å­—æ®µaä¸Šæœ‰ç´¢å¼•ï¼Œ joinè¿‡ç¨‹ç”¨ä¸Šäº†è¿™ä¸ªç´¢å¼•ï¼Œ å› æ­¤è¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li><p>ä»è¡¨t1ä¸­è¯»å…¥ä¸€è¡Œæ•°æ® Rï¼›</p></li><li><p>ä»æ•°æ®è¡ŒRä¸­ï¼Œ å–å‡ºaå­—æ®µåˆ°è¡¨t2é‡Œå»æŸ¥æ‰¾ï¼›</p></li><li><p>å–å‡ºè¡¨t2ä¸­æ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œ è·ŸRç»„æˆä¸€è¡Œï¼Œ ä½œä¸ºç»“æœé›†çš„ä¸€éƒ¨åˆ†ï¼›</p></li><li><p>é‡å¤æ‰§è¡Œæ­¥éª¤1åˆ°3ï¼Œ ç›´åˆ°è¡¨t1çš„æœ«å°¾å¾ªç¯ç»“æŸã€‚</p></li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421212800908.png" alt="image-20240421212800908"></p><p>å¯¹æ¯”ç”¨å•è¡¨æŸ¥è¯¢æ€ä¹ˆå®ç°ã€‚</p><ol><li>æ‰§è¡Œselect * from t1ï¼ŒæŸ¥å‡ºè¡¨t1çš„æ‰€æœ‰æ•°æ®ï¼Œè¿™é‡Œæœ‰100è¡Œï¼›</li><li>å¾ªç¯éå†è¿™100è¡Œæ•°æ®ï¼š<ul><li>ä»æ¯ä¸€è¡ŒRå–å‡ºå­—æ®µaçš„å€¼$R.aï¼›</li><li>æ‰§è¡Œselect * from t2 where a=$R.aï¼›</li><li>æŠŠè¿”å›çš„ç»“æœå’ŒRæ„æˆç»“æœé›†çš„ä¸€è¡Œã€‚</li></ul></li></ol><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªæŸ¥è¯¢è¿‡ç¨‹ï¼Œä¹Ÿæ˜¯æ‰«æäº†200è¡Œï¼Œä½†æ˜¯æ€»å…±æ‰§è¡Œäº†101æ¡è¯­å¥ï¼Œæ¯”ç›´æ¥joinå¤šäº†100æ¬¡äº¤äº’ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®¢æˆ·ç«¯è¿˜è¦è‡ªå·±æ‹¼æ¥SQLè¯­å¥å’Œç»“æœã€‚</p><p>ç»“è®ºï¼š</p><ol><li><p>ä½¿ç”¨joinè¯­å¥ï¼Œ æ€§èƒ½æ¯”å¼ºè¡Œæ‹†æˆå¤šä¸ªå•è¡¨æ‰§è¡ŒSQLè¯­å¥çš„æ€§èƒ½è¦å¥½ï¼›</p></li><li><p>å¦‚æœä½¿ç”¨joinè¯­å¥çš„è¯ï¼Œ éœ€è¦è®©å°è¡¨åšé©±åŠ¨è¡¨ã€‚</p></li></ol><p><strong>Simple Nested-Loop Join</strong></p><p>ç”±äºè¡¨çš„å­—æ®µbä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œ å› æ­¤å†ç”¨å›¾çš„æ‰§è¡Œæµç¨‹æ—¶ï¼Œ æ¯æ¬¡åˆ°t2å»åŒ¹é…çš„æ—¶å€™ï¼Œ å°±è¦åšä¸€æ¬¡å…¨è¡¨æ‰«æ ã€‚</p><p><strong>Block Nested-Loop Join</strong></p><p>è¿™æ—¶å€™ï¼Œ è¢«é©±åŠ¨è¡¨ä¸Šæ²¡æœ‰å¯ç”¨çš„ç´¢å¼•ï¼Œ ç®—æ³•çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li><p>æŠŠè¡¨t1çš„æ•°æ®è¯»å…¥çº¿ç¨‹å†…å­˜join_bufferä¸­ï¼Œ ç”±äºæˆ‘ä»¬è¿™ä¸ªè¯­å¥ä¸­å†™çš„æ˜¯select *ï¼Œ å› æ­¤æ˜¯æŠŠæ•´ä¸ªè¡¨t1æ”¾å…¥äº†å†…å­˜ï¼›</p></li><li><p>æ‰«æè¡¨t2ï¼Œ æŠŠè¡¨t2ä¸­çš„æ¯ä¸€è¡Œå–å‡ºæ¥ï¼Œ è·Ÿjoin_bufferä¸­çš„æ•°æ®åšå¯¹æ¯”ï¼Œ æ»¡è¶³joinæ¡ä»¶çš„ï¼Œ ä½œä¸ºç»“æœé›†çš„ä¸€éƒ¨åˆ†è¿”å›ã€‚</p></li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421212952835.png" alt="image-20240421212952835"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421213046975.png" alt="image-20240421213046975"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¯¹è¡¨t1å’Œt2éƒ½åšäº†ä¸€æ¬¡å…¨è¡¨æ‰«æï¼Œå› æ­¤æ€»çš„æ‰«æè¡Œæ•°æ˜¯1100ã€‚ç”±äºjoin_bufferæ˜¯ä»¥æ— åºæ•°ç»„çš„æ–¹å¼ç»„ç»‡çš„ï¼Œå› æ­¤å¯¹è¡¨t2ä¸­çš„æ¯ä¸€è¡Œï¼Œéƒ½è¦åš100æ¬¡åˆ¤æ–­ï¼Œæ€»å…±éœ€è¦åœ¨å†…å­˜ä¸­åšçš„åˆ¤æ–­æ¬¡æ•°æ˜¯ï¼š100*1000=10ä¸‡æ¬¡ã€‚</p><p>å‡è®¾å°è¡¨çš„è¡Œæ•°æ˜¯Nï¼Œå¤§è¡¨çš„è¡Œæ•°æ˜¯Mï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªç®—æ³•é‡Œï¼š</p><ol><li>ä¸¤ä¸ªè¡¨éƒ½åšä¸€æ¬¡å…¨è¡¨æ‰«æï¼Œæ‰€ä»¥æ€»çš„æ‰«æè¡Œæ•°æ˜¯M+Nï¼›</li><li>å†…å­˜ä¸­çš„åˆ¤æ–­æ¬¡æ•°æ˜¯M*Nã€‚</li></ol><p>å¯ä»¥çœ‹åˆ°ï¼Œè°ƒæ¢è¿™ä¸¤ä¸ªç®—å¼ä¸­çš„Må’ŒNæ²¡å·®åˆ«ï¼Œå› æ­¤è¿™æ—¶å€™é€‰æ‹©å¤§è¡¨è¿˜æ˜¯å°è¡¨åšé©±åŠ¨è¡¨ï¼Œæ‰§è¡Œè€—æ—¶æ˜¯ä¸€æ ·çš„ã€‚</p><p>åˆ†æ®µæ”¾ï¼šjoin_bufferçš„å¤§å°æ˜¯ç”±å‚æ•°join_buffer_sizeè®¾å®šçš„ï¼Œ é»˜è®¤å€¼æ˜¯256kã€‚ <strong>å¦‚æœæ”¾ä¸ä¸‹è¡¨t1çš„æ‰€æœ‰æ•°æ®è¯ï¼Œ ç­–ç•¥å¾ˆç®€å•ï¼Œ å°±æ˜¯åˆ†æ®µæ”¾</strong>ã€‚ æˆ‘æŠŠjoin_buffer_sizeæ”¹æˆ1200ï¼Œ å†æ‰§è¡Œï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 straight_join t2 <span class="keyword">on</span> (t1.a<span class="operator">=</span>t2.b);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¿‡ç¨‹å°±å˜æˆäº†ï¼š</p><ol><li><p>æ‰«æè¡¨t1ï¼Œ é¡ºåºè¯»å–æ•°æ®è¡Œæ”¾å…¥join_bufferä¸­ï¼Œ æ”¾å®Œç¬¬88è¡Œjoin_bufferæ»¡äº†ï¼Œ ç»§ç»­ç¬¬2æ­¥ï¼›</p></li><li><p>æ‰«æè¡¨t2ï¼Œ æŠŠt2ä¸­çš„æ¯ä¸€è¡Œå–å‡ºæ¥ï¼Œ è·Ÿjoin_bufferä¸­çš„æ•°æ®åšå¯¹æ¯”ï¼Œ æ»¡è¶³joinæ¡ä»¶çš„ï¼Œ ä½œä¸ºç»“æœé›†çš„ä¸€éƒ¨åˆ†è¿”å›ï¼›</p></li><li><p>æ¸…ç©ºjoin_bufferï¼›</p></li><li><p>ç»§ç»­æ‰«æè¡¨t1ï¼Œ é¡ºåºè¯»å–æœ€åçš„12è¡Œæ•°æ®æ”¾å…¥join_bufferä¸­ï¼Œ ç»§ç»­æ‰§è¡Œç¬¬2æ­¥ã€‚</p></li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421213008023.png" alt="image-20240421213008023"></p><p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹ï¼Œ åœ¨è¿™ç§æƒ…å†µä¸‹é©±åŠ¨è¡¨çš„é€‰æ‹©é—®é¢˜ã€‚</p><p>å‡è®¾ï¼Œ é©±åŠ¨è¡¨çš„æ•°æ®è¡Œæ•°æ˜¯Nï¼Œ éœ€è¦åˆ†Kæ®µæ‰èƒ½å®Œæˆç®—æ³•æµç¨‹ï¼Œ è¢«é©±åŠ¨è¡¨çš„æ•°æ®è¡Œæ•°æ˜¯Mã€‚æ³¨æ„ï¼Œ è¿™é‡Œçš„Kä¸æ˜¯å¸¸æ•°ï¼Œ Nè¶Šå¤§Kå°±ä¼šè¶Šå¤§ï¼Œ å› æ­¤æŠŠKè¡¨ç¤ºä¸ºÎ» * Nï¼Œ æ˜¾ç„¶Î»çš„å–å€¼èŒƒå›´æ˜¯(0,1)ã€‚æ‰€ä»¥ï¼Œ åœ¨è¿™ä¸ªç®—æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼š</p><ol><li><p>æ‰«æè¡Œæ•°æ˜¯ N+Î» * N * Mï¼›</p></li><li><p>å†…å­˜åˆ¤æ–­ N * Mæ¬¡ã€‚</p><p>æ˜¾ç„¶ï¼Œ å†…å­˜åˆ¤æ–­æ¬¡æ•°æ˜¯ä¸å—é€‰æ‹©å“ªä¸ªè¡¨ä½œä¸ºé©±åŠ¨è¡¨å½±å“çš„ã€‚ è€Œè€ƒè™‘åˆ°æ‰«æè¡Œæ•°ï¼Œ åœ¨Må’ŒNå¤§å°ç¡®å®šçš„æƒ…å†µä¸‹ï¼Œ Nå°ä¸€äº›ï¼Œ æ•´ä¸ªç®—å¼çš„ç»“æœä¼šæ›´å°ã€‚æ‰€ä»¥ç»“è®ºæ˜¯ï¼Œ åº”è¯¥è®©å°è¡¨å½“é©±åŠ¨è¡¨ã€‚å½“ç„¶ï¼Œ ä½ ä¼šå‘ç°ï¼Œ åœ¨N+Î»<em>N</em>Mè¿™ä¸ªå¼å­é‡Œï¼Œ Î»æ‰æ˜¯å½±å“æ‰«æè¡Œæ•°çš„å…³é”®å› ç´ ï¼Œ è¿™ä¸ªå€¼è¶Šå°è¶Šå¥½ã€‚</p></li></ol><p><strong>å›ç­”æ–‡ç« å¼€å¤´çš„ä¸¤ä¸ªé—®é¢˜</strong>ã€‚</p><p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šèƒ½ä¸èƒ½ä½¿ç”¨joinè¯­å¥ï¼Ÿ</p><ol><li>å¦‚æœå¯ä»¥ä½¿ç”¨Index Nested-Loop Joinç®—æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥ç”¨ä¸Šè¢«é©±åŠ¨è¡¨ä¸Šçš„ç´¢å¼•ï¼Œå…¶å®æ˜¯æ²¡é—®é¢˜çš„ï¼›</li><li>å¦‚æœä½¿ç”¨Block Nested-Loop Joinç®—æ³•ï¼Œæ‰«æè¡Œæ•°å°±ä¼šè¿‡å¤šã€‚å°¤å…¶æ˜¯åœ¨å¤§è¡¨ä¸Šçš„joinæ“ä½œï¼Œè¿™æ ·å¯èƒ½è¦æ‰«æè¢«é©±åŠ¨è¡¨å¾ˆå¤šæ¬¡ï¼Œä¼šå ç”¨å¤§é‡çš„ç³»ç»Ÿèµ„æºã€‚æ‰€ä»¥è¿™ç§joinå°½é‡ä¸è¦ç”¨ã€‚</li></ol><p>æ‰€ä»¥ä½ åœ¨åˆ¤æ–­è¦ä¸è¦ä½¿ç”¨joinè¯­å¥æ—¶ï¼Œå°±æ˜¯çœ‹explainç»“æœé‡Œé¢ï¼ŒExtraå­—æ®µé‡Œé¢æœ‰æ²¡æœ‰å‡ºç°â€œBlock Nested Loopâ€å­—æ ·ã€‚</p><p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼šå¦‚æœè¦ä½¿ç”¨joinï¼Œåº”è¯¥é€‰æ‹©å¤§è¡¨åšé©±åŠ¨è¡¨è¿˜æ˜¯é€‰æ‹©å°è¡¨åšé©±åŠ¨è¡¨ï¼Ÿ</p><ol><li>å¦‚æœæ˜¯Index Nested-Loop Joinç®—æ³•ï¼Œåº”è¯¥é€‰æ‹©å°è¡¨åšé©±åŠ¨è¡¨ï¼›</li><li>å¦‚æœæ˜¯Block Nested-Loop Joinç®—æ³•ï¼š<ul><li>åœ¨join_buffer_sizeè¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œæ˜¯ä¸€æ ·çš„ï¼›</li><li>åœ¨join_buffer_sizeä¸å¤Ÿå¤§çš„æ—¶å€™ï¼ˆè¿™ç§æƒ…å†µæ›´å¸¸è§ï¼‰ï¼Œåº”è¯¥é€‰æ‹©å°è¡¨åšé©±åŠ¨è¡¨ã€‚</li></ul></li></ol><p>æ‰€ä»¥ï¼Œè¿™ä¸ªé—®é¢˜çš„ç»“è®ºå°±æ˜¯ï¼Œæ€»æ˜¯åº”è¯¥ä½¿ç”¨å°è¡¨åšé©±åŠ¨è¡¨ã€‚</p><p>åœ¨å†³å®šå“ªä¸ªè¡¨åšé©±åŠ¨è¡¨çš„æ—¶å€™ï¼Œ åº”è¯¥æ˜¯ä¸¤ä¸ªè¡¨æŒ‰ç…§å„è‡ªçš„æ¡ä»¶è¿‡æ»¤ï¼Œ è¿‡æ»¤å®Œæˆä¹‹åï¼Œ è®¡ç®—å‚ä¸joinçš„å„ä¸ªå­—æ®µçš„æ€»æ•°æ®é‡ï¼Œ æ•°æ®é‡å°çš„é‚£ä¸ªè¡¨ï¼Œ å°±æ˜¯â€œå°è¡¨â€ï¼Œ åº”è¯¥ä½œä¸ºé©±åŠ¨è¡¨ã€‚</p><p><strong>æ€»ç»“</strong></p><p>é€šè¿‡å¯¹Index Nested-Loop Joinå’ŒBlock Nested-Loop Joinä¸¤ä¸ªç®—æ³•æ‰§è¡Œè¿‡ç¨‹çš„åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿå¾—åˆ°äº†æ–‡ç« å¼€å¤´ä¸¤ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼š</p><ol><li>å¦‚æœå¯ä»¥ä½¿ç”¨è¢«é©±åŠ¨è¡¨çš„ç´¢å¼•ï¼Œjoinè¯­å¥è¿˜æ˜¯æœ‰å…¶ä¼˜åŠ¿çš„ï¼›</li><li>ä¸èƒ½ä½¿ç”¨è¢«é©±åŠ¨è¡¨çš„ç´¢å¼•ï¼Œåªèƒ½ä½¿ç”¨Block Nested-Loop Joinç®—æ³•ï¼Œè¿™æ ·çš„è¯­å¥å°±å°½é‡ä¸è¦ä½¿ç”¨ï¼›</li><li>åœ¨ä½¿ç”¨joinçš„æ—¶å€™ï¼Œåº”è¯¥è®©å°è¡¨åšé©±åŠ¨è¡¨ã€‚</li></ol><h2 id="35-joinè¯­å¥æ€ä¹ˆä¼˜åŒ–ï¼Ÿ"><strong>35 | joinè¯­å¥æ€ä¹ˆä¼˜åŒ–ï¼Ÿ</strong></h2><p><strong>Multi-Range Readä¼˜åŒ–</strong></p><p>ã€ä¸»è¦æ˜¯æ ¹æ®å±€éƒ¨ä¸€è‡´æ€§åŸç†è¿›è¡Œä¼˜åŒ–çš„ã€‘</p><p>Multi-Range Readä¼˜åŒ– (MRR)ã€‚ è¿™ä¸ªä¼˜åŒ–çš„ä¸»è¦ç›®çš„æ˜¯å°½é‡ä½¿ç”¨é¡ºåºè¯»ç›˜ã€‚</p><p>ä¸»é”®ç´¢å¼•æ˜¯ä¸€æ£µB+æ ‘ï¼Œ åœ¨è¿™æ£µæ ‘ä¸Šï¼Œ æ¯æ¬¡åªèƒ½æ ¹æ®ä¸€ä¸ªä¸»é”®idæŸ¥åˆ°ä¸€è¡Œæ•°æ®ã€‚ å› æ­¤ï¼Œ å›è¡¨è‚¯å®šæ˜¯ä¸€è¡Œè¡Œæœç´¢ä¸»é”®ç´¢å¼•çš„</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421213400293.png" alt="image-20240421213400293"></p><p>å¦‚æœéšç€açš„å€¼é€’å¢é¡ºåºæŸ¥è¯¢çš„è¯ï¼Œ idçš„å€¼å°±å˜æˆéšæœºçš„ï¼Œ é‚£ä¹ˆå°±ä¼šå‡ºç°éšæœºè®¿é—®ï¼Œ æ€§èƒ½ç›¸å¯¹è¾ƒå·®ã€‚ è™½ç„¶â€œæŒ‰è¡ŒæŸ¥â€è¿™ä¸ªæœºåˆ¶ä¸èƒ½æ”¹ï¼Œ ä½†æ˜¯è°ƒæ•´æŸ¥è¯¢çš„é¡ºåºï¼Œ è¿˜æ˜¯èƒ½å¤ŸåŠ é€Ÿçš„ã€‚å› ä¸ºå¤§å¤šæ•°çš„æ•°æ®éƒ½æ˜¯æŒ‰ç…§ä¸»é”®é€’å¢é¡ºåºæ’å…¥å¾—åˆ°çš„ï¼Œ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¤ä¸ºï¼Œ å¦‚æœæŒ‰ç…§ä¸»é”®çš„é€’å¢é¡ºåºæŸ¥è¯¢çš„è¯ï¼Œ å¯¹ç£ç›˜çš„è¯»æ¯”è¾ƒæ¥è¿‘é¡ºåºè¯»ï¼Œ èƒ½å¤Ÿæå‡è¯»æ€§èƒ½ã€‚</p><p>è¿™å°±æ˜¯MRRä¼˜åŒ–çš„è®¾è®¡æ€è·¯ã€‚ æ­¤æ—¶ï¼Œ è¯­å¥çš„æ‰§è¡Œæµç¨‹å˜æˆäº†è¿™æ ·ï¼š</p><ol><li><p>æ ¹æ®ç´¢å¼•aï¼Œ å®šä½åˆ°æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œ å°†idå€¼æ”¾å…¥read_rnd_bufferä¸­;</p></li><li><p>å°†read_rnd_bufferä¸­çš„idè¿›è¡Œé€’å¢æ’åºï¼›</p></li><li><p>æ’åºåçš„idæ•°ç»„ï¼Œ ä¾æ¬¡åˆ°ä¸»é”®idç´¢å¼•ä¸­æŸ¥è®°å½•ï¼Œ å¹¶ä½œä¸ºç»“æœè¿”å›ã€‚</p></li></ol><p><strong>Batched Key Access</strong></p><p>NLJç®—æ³•æ‰§è¡Œçš„é€»è¾‘æ˜¯ï¼š ä»é©±åŠ¨è¡¨t1ï¼Œ ä¸€è¡Œè¡Œåœ°å–å‡ºaçš„å€¼ï¼Œ å†åˆ°è¢«é©±åŠ¨è¡¨t2å»åšjoinã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œ å¯¹äºè¡¨t2æ¥è¯´ï¼Œ æ¯æ¬¡éƒ½æ˜¯åŒ¹é…ä¸€ä¸ªå€¼ã€‚ è¿™æ—¶ï¼Œ MRRçš„ä¼˜åŠ¿å°±ç”¨ä¸ä¸Šäº†ã€‚</p><p><strong>BNLç®—æ³•çš„æ€§èƒ½é—®é¢˜</strong></p><p>å¤§è¡¨joinæ“ä½œè™½ç„¶å¯¹IOæœ‰å½±å“ï¼Œ ä½†æ˜¯åœ¨è¯­å¥æ‰§è¡Œç»“æŸåï¼Œ å¯¹IOçš„å½±å“ä¹Ÿå°±ç»“æŸäº†ã€‚ ä½†æ˜¯ï¼Œå¯¹Buffer Poolçš„å½±å“å°±æ˜¯æŒç»­æ€§çš„ï¼Œ éœ€è¦ä¾é åç»­çš„æŸ¥è¯¢è¯·æ±‚æ…¢æ…¢æ¢å¤å†…å­˜å‘½ä¸­ç‡ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ BNLç®—æ³•å¯¹ç³»ç»Ÿçš„å½±å“ä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢ï¼š</p><ol><li><p>å¯èƒ½ä¼šå¤šæ¬¡æ‰«æè¢«é©±åŠ¨è¡¨ï¼Œ å ç”¨ç£ç›˜IOèµ„æºï¼›</p></li><li><p>åˆ¤æ–­joinæ¡ä»¶éœ€è¦æ‰§è¡ŒM*Næ¬¡å¯¹æ¯”ï¼ˆMã€ Nåˆ†åˆ«æ˜¯ä¸¤å¼ è¡¨çš„è¡Œæ•°ï¼‰ ï¼Œ å¦‚æœæ˜¯å¤§è¡¨å°±ä¼šå ç”¨éå¸¸å¤šçš„CPUèµ„æºï¼›</p></li><li><p>å¯èƒ½ä¼šå¯¼è‡´Buffer Poolçš„çƒ­æ•°æ®è¢«æ·˜æ±°ï¼Œ å½±å“å†…å­˜å‘½ä¸­ç‡ã€‚</p></li></ol><h2 id="36-ä¸ºä»€ä¹ˆä¸´æ—¶è¡¨å¯ä»¥é‡åï¼Ÿ"><strong>36 | ä¸ºä»€ä¹ˆä¸´æ—¶è¡¨å¯ä»¥é‡åï¼Ÿ</strong></h2><p><strong>å†…å­˜è¡¨å’Œä¸´æ—¶è¡¨çš„æ¦‚å¿µ</strong></p><ul><li><p>å†…å­˜è¡¨ï¼Œ æŒ‡çš„æ˜¯ä½¿ç”¨Memoryå¼•æ“çš„è¡¨ï¼Œ å»ºè¡¨è¯­æ³•æ˜¯create table engine=memoryã€‚ è¿™ç§è¡¨çš„æ•°æ®éƒ½ä¿å­˜åœ¨å†…å­˜é‡Œï¼Œ ç³»ç»Ÿé‡å¯çš„æ—¶å€™ä¼šè¢«æ¸…ç©ºï¼Œ ä½†æ˜¯è¡¨ç»“æ„è¿˜åœ¨ã€‚ é™¤äº†è¿™ä¸¤ä¸ªç‰¹æ€§çœ‹ä¸Šå»æ¯”è¾ƒâ€œå¥‡æ€ªâ€å¤–ï¼Œ ä»å…¶ä»–çš„ç‰¹å¾ä¸Šçœ‹ï¼Œ å®ƒå°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„è¡¨ã€‚</p></li><li><p>ä¸´æ—¶è¡¨ï¼Œ å¯ä»¥ä½¿ç”¨å„ç§å¼•æ“ç±»å‹ ã€‚ å¦‚æœæ˜¯ä½¿ç”¨InnoDBå¼•æ“æˆ–è€…MyISAMå¼•æ“çš„ä¸´æ—¶è¡¨ï¼Œ å†™æ•°æ®çš„æ—¶å€™æ˜¯å†™åˆ°ç£ç›˜ä¸Šçš„ã€‚ å½“ç„¶ï¼Œ ä¸´æ—¶è¡¨ä¹Ÿå¯ä»¥ä½¿ç”¨Memoryå¼•æ“ã€‚</p></li></ul><p><strong>ä¸´æ—¶è¡¨çš„ç‰¹æ€§</strong></p><p>ä¸´æ—¶è¡¨åœ¨ä½¿ç”¨ä¸Šæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p><ol><li><p>å»ºè¡¨è¯­æ³•æ˜¯create temporary table â€¦ã€‚</p></li><li><p>ä¸€ä¸ªä¸´æ—¶è¡¨åªèƒ½è¢«åˆ›å»ºå®ƒçš„sessionè®¿é—®ï¼Œ å¯¹å…¶ä»–çº¿ç¨‹ä¸å¯è§ã€‚</p></li><li><p>ä¸´æ—¶è¡¨å¯ä»¥ä¸æ™®é€šè¡¨åŒåã€‚</p></li><li><p>session Aå†…æœ‰åŒåçš„ä¸´æ—¶è¡¨å’Œæ™®é€šè¡¨çš„æ—¶å€™ï¼Œ show createè¯­å¥ï¼Œ ä»¥åŠå¢åˆ æ”¹æŸ¥è¯­å¥è®¿é—®çš„æ˜¯ä¸´æ—¶è¡¨ã€‚</p></li><li><p>show tableså‘½ä»¤ä¸æ˜¾ç¤ºä¸´æ—¶è¡¨ã€‚</p></li></ol><p><strong>ä¸´æ—¶è¡¨çš„åº”ç”¨</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421213557334.png" alt="image-20240421213557334"></p><p><strong>ä¸ºä»€ä¹ˆä¸´æ—¶è¡¨å¯ä»¥é‡åï¼Ÿ</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span> <span class="keyword">create</span> temporary <span class="keyword">table</span> temp_t(id <span class="type">int</span> <span class="keyword">primary</span> key)engine<span class="operator">=</span>innodb;</span><br></pre></td></tr></table></figure><p>MySQLè¦ç»™è¿™ä¸ªInnoDBè¡¨åˆ›å»ºä¸€ä¸ªfrmæ–‡ä»¶ä¿å­˜è¡¨ç»“æ„å®šä¹‰ï¼Œ è¿˜è¦æœ‰åœ°æ–¹ä¿å­˜è¡¨æ•°æ®ã€‚è¿™ä¸ªfrmæ–‡ä»¶æ”¾åœ¨ä¸´æ—¶æ–‡ä»¶ç›®å½•ä¸‹ï¼Œ æ–‡ä»¶åçš„åç¼€æ˜¯.frmï¼Œ å‰ç¼€æ˜¯â€œ#sql{è¿›ç¨‹id}_{çº¿ç¨‹id}_åºåˆ—å·â€ã€‚ ä½ å¯ä»¥ä½¿ç”¨select @@tmpdirå‘½ä»¤ï¼Œ æ¥æ˜¾ç¤ºå®ä¾‹çš„ä¸´æ—¶æ–‡ä»¶ç›®å½•ã€‚</p><h2 id="37-ä»€ä¹ˆæ—¶å€™ä¼šä½¿ç”¨å†…éƒ¨ä¸´æ—¶è¡¨ï¼Ÿ"><strong>37 | ä»€ä¹ˆæ—¶å€™ä¼šä½¿ç”¨å†…éƒ¨ä¸´æ—¶è¡¨ï¼Ÿ</strong></h2><p><strong>union æ‰§è¡Œæµç¨‹</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span> (<span class="keyword">select</span> <span class="number">1000</span> <span class="keyword">as</span> f) <span class="keyword">union</span> (<span class="keyword">select</span> id <span class="keyword">from</span> t1 <span class="keyword">order</span> <span class="keyword">by</span> id <span class="keyword">desc</span> limit <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421213647330.png" alt="image-20240421213647330"></p><ol><li><p>åˆ›å»ºä¸€ä¸ªå†…å­˜ä¸´æ—¶è¡¨ï¼Œ è¿™ä¸ªä¸´æ—¶è¡¨åªæœ‰ä¸€ä¸ªæ•´å‹å­—æ®µfï¼Œ å¹¶ä¸”fæ˜¯ä¸»é”®å­—æ®µã€‚</p></li><li><p>æ‰§è¡Œç¬¬ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œ å¾—åˆ°1000è¿™ä¸ªå€¼ï¼Œ å¹¶å­˜å…¥ä¸´æ—¶è¡¨ä¸­ã€‚</p></li><li><p>æ‰§è¡Œç¬¬äºŒä¸ªå­æŸ¥è¯¢ï¼š</p><p>i. æ‹¿åˆ°ç¬¬ä¸€è¡Œid=1000ï¼Œ è¯•å›¾æ’å…¥ä¸´æ—¶è¡¨ä¸­ã€‚ ä½†ç”±äº1000è¿™ä¸ªå€¼å·²ç»å­˜åœ¨äºä¸´æ—¶è¡¨äº†ï¼Œ è¿åäº†å”¯ä¸€æ€§çº¦æŸï¼Œ æ‰€ä»¥æ’å…¥å¤±è´¥ï¼Œ ç„¶åç»§ç»­æ‰§è¡Œï¼›</p><p>Sii. å–åˆ°ç¬¬äºŒè¡Œid=999ï¼Œ æ’å…¥ä¸´æ—¶è¡¨æˆåŠŸã€‚</p></li><li><p>ä»ä¸´æ—¶è¡¨ä¸­æŒ‰è¡Œå–å‡ºæ•°æ®ï¼Œ è¿”å›ç»“æœï¼Œ å¹¶åˆ é™¤ä¸´æ—¶è¡¨ï¼Œ ç»“æœä¸­åŒ…å«ä¸¤è¡Œæ•°æ®åˆ†åˆ«æ˜¯1000å’Œ999ã€‚</p></li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421213702537.png" alt="image-20240421213702537"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œ è¿™é‡Œçš„å†…å­˜ä¸´æ—¶è¡¨èµ·åˆ°äº†æš‚å­˜æ•°æ®çš„ä½œç”¨ï¼Œ è€Œä¸”è®¡ç®—è¿‡ç¨‹è¿˜ç”¨ä¸Šäº†ä¸´æ—¶è¡¨ä¸»é”®idçš„å”¯ä¸€æ€§çº¦æŸï¼Œ å®ç°äº†unionçš„è¯­ä¹‰ã€‚</p><p><strong>group by æ‰§è¡Œæµç¨‹</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span> <span class="keyword">select</span> id<span class="operator">%</span><span class="number">10</span> <span class="keyword">as</span> m, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> c <span class="keyword">from</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> m;</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421213717901.png" alt="image-20240421213717901"></p><p>åœ¨Extraå­—æ®µé‡Œé¢ï¼Œ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªä¿¡æ¯ï¼š</p><ul><li><p>Using indexï¼Œ è¡¨ç¤ºè¿™ä¸ªè¯­å¥ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œ é€‰æ‹©äº†ç´¢å¼•aï¼Œ ä¸éœ€è¦å›è¡¨ï¼›</p></li><li><p>Using temporaryï¼Œ è¡¨ç¤ºä½¿ç”¨äº†ä¸´æ—¶è¡¨ï¼›</p></li><li><p>Using filesortï¼Œ è¡¨ç¤ºéœ€è¦æ’åºã€‚</p></li></ul><p>è¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li><p>åˆ›å»ºå†…å­˜ä¸´æ—¶è¡¨ï¼Œ è¡¨é‡Œæœ‰ä¸¤ä¸ªå­—æ®µmå’Œcï¼Œ ä¸»é”®æ˜¯mï¼›</p></li><li><p>æ‰«æè¡¨t1çš„ç´¢å¼•aï¼Œ ä¾æ¬¡å–å‡ºå¶å­èŠ‚ç‚¹ä¸Šçš„idå€¼ï¼Œ è®¡ç®—id%10çš„ç»“æœï¼Œ è®°ä¸ºxï¼›</p></li></ol><ul><li><p>å¦‚æœä¸´æ—¶è¡¨ä¸­æ²¡æœ‰ä¸»é”®ä¸ºxçš„è¡Œï¼Œ å°±æ’å…¥ä¸€ä¸ªè®°å½•(x,1);</p></li><li><p>å¦‚æœè¡¨ä¸­æœ‰ä¸»é”®ä¸ºxçš„è¡Œï¼Œ å°±å°†xè¿™ä¸€è¡Œçš„cå€¼åŠ 1ï¼›</p></li></ul><ol start="3"><li>éå†å®Œæˆåï¼Œ å†æ ¹æ®å­—æ®µmåšæ’åºï¼Œ å¾—åˆ°ç»“æœé›†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421213743352.png" alt="image-20240421213743352"></p><p><strong>æŒ‡å¯¼åŸåˆ™</strong></p><ol><li><p>å¦‚æœå¯¹group byè¯­å¥çš„ç»“æœæ²¡æœ‰æ’åºè¦æ±‚ï¼Œ è¦åœ¨è¯­å¥åé¢åŠ  order bynullï¼›</p></li><li><p>å°½é‡è®©group byè¿‡ç¨‹ç”¨ä¸Šè¡¨çš„ç´¢å¼•ï¼Œ ç¡®è®¤æ–¹æ³•æ˜¯explainç»“æœé‡Œæ²¡æœ‰Using temporaryå’Œ Using filesortï¼›</p></li><li><p>å¦‚æœgroup byéœ€è¦ç»Ÿè®¡çš„æ•°æ®é‡ä¸å¤§ï¼Œ å°½é‡åªä½¿ç”¨å†…å­˜ä¸´æ—¶è¡¨ï¼› ä¹Ÿå¯ä»¥é€šè¿‡é€‚å½“è°ƒå¤§tmp_table_sizeå‚æ•°ï¼Œ æ¥é¿å…ç”¨åˆ°ç£ç›˜ä¸´æ—¶è¡¨ï¼›</p></li><li><p>å¦‚æœæ•°æ®é‡å®åœ¨å¤ªå¤§ï¼Œ ä½¿ç”¨SQL_BIG_RESULTè¿™ä¸ªæç¤ºï¼Œ æ¥å‘Šè¯‰ä¼˜åŒ–å™¨ç›´æ¥ä½¿ç”¨æ’åºç®—æ³•å¾—åˆ°group byçš„ç»“æœã€‚</p></li></ol><p><strong>æ•°æ®åº“ä¸­å·²ç»è®¾ç½®bufferï¼Œä¸ºä»€ä¹ˆè¿˜è¦æœ‰ä¸´æ—¶è¡¨è¿™ä¸ªä¸œè¥¿ï¼Œé™¤äº†å­˜å‚¨åœ¨ç£ç›˜ä¸Šè¿˜æœ‰å…¶ä»–çš„å¥½å¤„å—</strong>?</p><ol><li><strong>ç¼“å†²åŒºï¼ˆBufferï¼‰</strong>ï¼šç¼“å†²åŒºæ˜¯ç”¨æ¥å­˜å‚¨æ•°æ®é¡µçš„å†…å­˜åŒºåŸŸï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æé«˜æ•°æ®åº“çš„æ€§èƒ½ã€‚å½“æ•°æ®åº“éœ€è¦è¯»å–æˆ–å†™å…¥æ•°æ®æ—¶ï¼Œé¦–å…ˆå°†æ•°æ®é¡µåŠ è½½åˆ°å†…å­˜çš„ç¼“å†²åŒºä¸­ï¼Œè¿™æ ·æ•°æ®åº“å¯ä»¥ç›´æ¥åœ¨å†…å­˜ä¸­è¿›è¡Œæ“ä½œï¼Œè€Œä¸å¿…æ¯æ¬¡éƒ½è®¿é—®ç£ç›˜ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å‡å°‘äº†ç£ç›˜I/Oæ“ä½œçš„æ¬¡æ•°ï¼ŒåŠ å¿«äº†æ•°æ®çš„è®¿é—®é€Ÿåº¦ï¼Œæé«˜äº†æ•°æ®åº“çš„æ€§èƒ½ã€‚</li><li><strong>ä¸´æ—¶è¡¨ï¼ˆTemporary Tableï¼‰</strong>ï¼šä¸´æ—¶è¡¨æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„è¡¨ï¼Œå®ƒåœ¨æ•°æ®åº“ä¸­çš„ç”Ÿå‘½å‘¨æœŸé€šå¸¸æ¯”æ™®é€šè¡¨çŸ­æš‚ï¼Œå®ƒçš„æ•°æ®é€šå¸¸ä¸ä¼šæŒä¹…ä¿å­˜ï¼Œè€Œæ˜¯åœ¨ä¼šè¯ç»“æŸæˆ–è€…äº‹åŠ¡æäº¤åè¢«åˆ é™¤ã€‚ä¸´æ—¶è¡¨é€šå¸¸ç”¨äºä¸´æ—¶å­˜å‚¨æ•°æ®ã€ä¸­é—´è®¡ç®—ç»“æœç­‰ï¼Œå®ƒä»¬å¯ä»¥å¸®åŠ©ç®€åŒ–å¤æ‚çš„æŸ¥è¯¢æˆ–è€…æ“ä½œï¼Œæé«˜æŸ¥è¯¢çš„å¯è¯»æ€§å’Œæ€§èƒ½ã€‚</li></ol><h2 id="38-éƒ½è¯´InnoDBå¥½ï¼Œ-é‚£è¿˜è¦ä¸è¦ä½¿ç”¨Memoryå¼•æ“ï¼Ÿ"><strong>38 | éƒ½è¯´InnoDBå¥½ï¼Œ</strong> <strong>é‚£è¿˜è¦ä¸è¦ä½¿ç”¨Memoryå¼•æ“ï¼Ÿ</strong></h2><p><strong>å†…å­˜è¡¨çš„æ•°æ®ç»„ç»‡ç»“æ„</strong></p><p>å‡è®¾æœ‰ä»¥ä¸‹çš„ä¸¤å¼ è¡¨t1 å’Œ t2ï¼Œ å…¶ä¸­è¡¨t1ä½¿ç”¨Memoryå¼•æ“ï¼Œ è¡¨t2ä½¿ç”¨InnoDBå¼•æ“ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421214154359.png" alt="image-20240421214154359"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œ å†…å­˜è¡¨t1çš„è¿”å›ç»“æœé‡Œé¢0åœ¨æœ€åä¸€è¡Œï¼Œ è€ŒInnoDBè¡¨t2çš„è¿”å›ç»“æœé‡Œ0åœ¨ç¬¬ä¸€è¡Œã€‚è¡¨t2ç”¨çš„æ˜¯InnoDBå¼•æ“ï¼Œ å®ƒçš„ä¸»é”®ç´¢å¼•idçš„ç»„ç»‡æ–¹å¼ï¼Œ ä½ å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼š InnoDBè¡¨çš„æ•°æ®å°±æ”¾åœ¨ä¸»é”®ç´¢å¼•æ ‘ä¸Šï¼Œ ä¸»é”®ç´¢å¼•æ˜¯B+æ ‘ã€‚ æ‰€ä»¥è¡¨t2çš„æ•°æ®ç»„ç»‡æ–¹å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421214201995.png" alt="image-20240421214201995"></p><p>ä¸InnoDBå¼•æ“ä¸åŒï¼Œ Memoryå¼•æ“çš„æ•°æ®å’Œç´¢å¼•æ˜¯åˆ†å¼€çš„ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421214207021.png" alt="image-20240421214207021"></p><p>å¯è§ï¼Œ InnoDBå’ŒMemoryå¼•æ“çš„æ•°æ®ç»„ç»‡æ–¹å¼æ˜¯ä¸åŒçš„ï¼š</p><ul><li>InnoDBå¼•æ“æŠŠæ•°æ®æ”¾åœ¨ä¸»é”®ç´¢å¼•ä¸Šï¼Œ å…¶ä»–ç´¢å¼•ä¸Šä¿å­˜çš„æ˜¯ä¸»é”®idã€‚ è¿™ç§æ–¹å¼ï¼Œ æˆ‘ä»¬ç§°ä¹‹ä¸ºç´¢å¼•ç»„ç»‡è¡¨ï¼ˆIndexOrganizied Tableï¼‰</li><li>è€ŒMemoryå¼•æ“é‡‡ç”¨çš„æ˜¯æŠŠæ•°æ®å•ç‹¬å­˜æ”¾ï¼Œ ç´¢å¼•ä¸Šä¿å­˜æ•°æ®ä½ç½®çš„æ•°æ®ç»„ç»‡å½¢å¼ï¼Œ æˆ‘ä»¬ç§°ä¹‹ä¸ºå †ç»„ç»‡è¡¨ï¼ˆHeap Organizied Tableï¼‰</li></ul><p>ä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ è¿™ä¸¤ä¸ªå¼•æ“çš„ä¸€äº›å…¸å‹ä¸åŒ</p><ol><li><p>InnoDBè¡¨çš„æ•°æ®æ€»æ˜¯æœ‰åºå­˜æ”¾çš„ï¼Œ è€Œå†…å­˜è¡¨çš„æ•°æ®å°±æ˜¯æŒ‰ç…§å†™å…¥é¡ºåºå­˜æ”¾çš„ï¼›</p></li><li><p>å½“æ•°æ®æ–‡ä»¶æœ‰ç©ºæ´çš„æ—¶å€™ï¼Œ InnoDBè¡¨åœ¨æ’å…¥æ–°æ•°æ®çš„æ—¶å€™ï¼Œ ä¸ºäº†ä¿è¯æ•°æ®æœ‰åºæ€§ï¼Œ åªèƒ½åœ¨å›ºå®šçš„ä½ç½®å†™å…¥æ–°å€¼ï¼Œ è€Œå†…å­˜è¡¨æ‰¾åˆ°ç©ºä½å°±å¯ä»¥æ’å…¥æ–°å€¼ï¼›</p></li><li><p>æ•°æ®ä½ç½®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œ InnoDBè¡¨åªéœ€è¦ä¿®æ”¹ä¸»é”®ç´¢å¼•ï¼Œ è€Œå†…å­˜è¡¨éœ€è¦ä¿®æ”¹æ‰€æœ‰ç´¢å¼•ï¼›</p></li><li><p>InnoDBè¡¨ç”¨ä¸»é”®ç´¢å¼•æŸ¥è¯¢æ—¶éœ€è¦èµ°ä¸€æ¬¡ç´¢å¼•æŸ¥æ‰¾ï¼Œ ç”¨æ™®é€šç´¢å¼•æŸ¥è¯¢çš„æ—¶å€™ï¼Œ éœ€è¦èµ°ä¸¤æ¬¡ç´¢å¼•æŸ¥æ‰¾ã€‚ è€Œå†…å­˜è¡¨æ²¡æœ‰è¿™ä¸ªåŒºåˆ«ï¼Œ æ‰€æœ‰ç´¢å¼•çš„â€œåœ°ä½â€éƒ½æ˜¯ç›¸åŒçš„ã€‚</p></li><li><p>InnoDBæ”¯æŒå˜é•¿æ•°æ®ç±»å‹ï¼Œ ä¸åŒè®°å½•çš„é•¿åº¦å¯èƒ½ä¸åŒï¼› å†…å­˜è¡¨ä¸æ”¯æŒBlob å’Œ Textå­—æ®µï¼Œ å¹¶ä¸”å³ä½¿å®šä¹‰äº†varchar(N)ï¼Œ å®é™…ä¹Ÿå½“ä½œchar(N)ï¼Œ ä¹Ÿå°±æ˜¯å›ºå®šé•¿åº¦å­—ç¬¦ä¸²æ¥å­˜å‚¨ï¼Œ å› æ­¤å†…å­˜è¡¨çš„æ¯è¡Œæ•°æ®é•¿åº¦ç›¸åŒã€‚</p></li></ol><p><strong>hashç´¢å¼•å’ŒB-Treeç´¢å¼•</strong></p><p>å­˜è¡¨ä¹Ÿæ˜¯æ”¯B-Treeç´¢å¼•çš„ã€‚ åœ¨idåˆ—ä¸Šåˆ›å»ºä¸€ä¸ªB-Treeç´¢å¼•ï¼Œ SQLè¯­å¥å¯ä»¥è¿™ä¹ˆå†™ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 <span class="keyword">add</span> index a_btree_index <span class="keyword">using</span> btree (id);</span><br></pre></td></tr></table></figure><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421214257739.png" alt="image-20240421214257739"></p><p><strong>å†…å­˜è¡¨çš„é”</strong></p><p>å†…å­˜è¡¨ä¸æ”¯æŒè¡Œé”ï¼Œ åªæ”¯æŒè¡¨é”ã€‚ å› æ­¤ï¼Œ ä¸€å¼ è¡¨åªè¦æœ‰æ›´æ–°ï¼Œ å°±ä¼šå µä½å…¶ä»–æ‰€æœ‰åœ¨è¿™ä¸ªè¡¨ä¸Šçš„è¯»å†™æ“ä½œã€‚</p><p><strong>æ•°æ®æŒä¹…æ€§é—®é¢˜</strong></p><p>æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œ æ˜¯å†…å­˜è¡¨çš„ä¼˜åŠ¿ï¼Œ ä½†ä¹Ÿæ˜¯ä¸€ä¸ªåŠ£åŠ¿ã€‚ å› ä¸ºï¼Œ æ•°æ®åº“é‡å¯çš„æ—¶å€™ï¼Œ æ‰€æœ‰çš„å†…å­˜è¡¨éƒ½ä¼šè¢«æ¸…ç©ºã€‚å†…å­˜è¡¨å¹¶ä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸Šä½œä¸ºæ™®é€šæ•°æ®è¡¨ä½¿ç”¨ ã€‚</p><ol><li><p>å¦‚æœä½ çš„è¡¨æ›´æ–°é‡å¤§ï¼Œ é‚£ä¹ˆå¹¶å‘åº¦æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å‚è€ƒæŒ‡æ ‡ï¼Œ InnoDBæ”¯æŒè¡Œé”ï¼Œ å¹¶å‘åº¦æ¯”å†…å­˜è¡¨å¥½ï¼›</p></li><li><p>èƒ½æ”¾åˆ°å†…å­˜è¡¨çš„æ•°æ®é‡éƒ½ä¸å¤§ã€‚ å¦‚æœä½ è€ƒè™‘çš„æ˜¯è¯»çš„æ€§èƒ½ï¼Œ ä¸€ä¸ªè¯»QPSå¾ˆé«˜å¹¶ä¸”æ•°æ®é‡ä¸å¤§çš„è¡¨ï¼Œ å³ä½¿æ˜¯ä½¿ç”¨InnoDBï¼Œ æ•°æ®ä¹Ÿæ˜¯éƒ½ä¼šç¼“å­˜åœ¨InnoDB Buffer Poolé‡Œçš„ã€‚ å› æ­¤ï¼Œ ä½¿ç”¨InnoDBè¡¨çš„è¯»æ€§èƒ½ä¹Ÿä¸ä¼šå·®ã€‚</p></li></ol><p>å»ºè®®ä½ æŠŠæ™®é€šå†…å­˜è¡¨éƒ½ç”¨InnoDBè¡¨æ¥ä»£æ›¿</p><p>å†…å­˜ä¸´æ—¶è¡¨åˆšå¥½å¯ä»¥æ— è§†å†…å­˜è¡¨çš„ä¸¤ä¸ªä¸è¶³ï¼Œ ä¸»è¦æ˜¯ä¸‹é¢çš„ä¸‰ä¸ªåŸå› ï¼š</p><ol><li><p>ä¸´æ—¶è¡¨ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹è®¿é—®ï¼Œ æ²¡æœ‰å¹¶å‘æ€§çš„é—®é¢˜ï¼›</p></li><li><p>ä¸´æ—¶è¡¨é‡å¯åä¹Ÿæ˜¯éœ€è¦åˆ é™¤çš„ï¼Œ æ¸…ç©ºæ•°æ®è¿™ä¸ªé—®é¢˜ä¸å­˜åœ¨ï¼›</p></li><li><p>å¤‡åº“çš„ä¸´æ—¶è¡¨ä¹Ÿä¸ä¼šå½±å“ä¸»åº“çš„ç”¨æˆ·çº¿ç¨‹ã€‚</p></li></ol><h2 id="39-è‡ªå¢ä¸»é”®ä¸ºä»€ä¹ˆä¸æ˜¯è¿ç»­çš„ï¼Ÿ"><strong>39 | è‡ªå¢ä¸»é”®ä¸ºä»€ä¹ˆä¸æ˜¯è¿ç»­çš„ï¼Ÿ</strong></h2><p><strong>è‡ªå¢å€¼ä¿å­˜åœ¨å“ªå„¿ï¼Ÿ</strong></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421214411507.png" alt="image-20240421214411507"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œ è¡¨å®šä¹‰é‡Œé¢å‡ºç°äº†ä¸€ä¸ªAUTO_INCREMENT=2ï¼Œ è¡¨ç¤ºä¸‹ä¸€æ¬¡æ’å…¥æ•°æ®æ—¶ï¼Œ å¦‚æœéœ€è¦è‡ªåŠ¨ç”Ÿæˆè‡ªå¢å€¼ï¼Œ ä¼šç”Ÿæˆid=2ã€‚å…¶å®ï¼Œ è¿™ä¸ªè¾“å‡ºç»“æœå®¹æ˜“å¼•èµ·è¿™æ ·çš„è¯¯è§£ï¼š è‡ªå¢å€¼æ˜¯ä¿å­˜åœ¨è¡¨ç»“æ„å®šä¹‰é‡Œçš„ã€‚ å®é™…ä¸Šï¼Œ è¡¨çš„ç»“æ„å®šä¹‰å­˜æ”¾åœ¨åç¼€åä¸º.frmçš„æ–‡ä»¶ä¸­ï¼Œ ä½†æ˜¯å¹¶ä¸ä¼šä¿å­˜è‡ªå¢å€¼ã€‚</p><p>ä¸åŒçš„å¼•æ“å¯¹äºè‡ªå¢å€¼çš„ä¿å­˜ç­–<strong>ç•¥ä¸åŒã€‚MyISAMå¼•æ“çš„è‡ªå¢å€¼ä¿å­˜åœ¨æ•°æ®æ–‡ä»¶ä¸­ã€‚InnoDBå¼•æ“çš„è‡ªå¢å€¼ï¼Œ å…¶å®æ˜¯ä¿å­˜åœ¨äº†å†…å­˜é‡Œï¼Œ å¹¶ä¸”åˆ°äº†MySQL 8.0ç‰ˆæœ¬åï¼Œ æ‰æœ‰äº†â€œè‡ªå¢å€¼æŒä¹…åŒ–â€çš„èƒ½åŠ›ï¼Œ ä¹Ÿå°±æ˜¯æ‰å®ç°äº†â€œå¦‚æœå‘ç”Ÿé‡å¯ï¼Œ è¡¨çš„è‡ªå¢å€¼å¯ä»¥æ¢å¤ä¸ºMySQLé‡å¯å‰çš„å€¼â€</strong>ã€‚</p><p><strong>è‡ªå¢å€¼ä¿®æ”¹æœºåˆ¶</strong></p><p>åœ¨MySQLé‡Œé¢ï¼Œå¦‚æœå­—æ®µidè¢«å®šä¹‰ä¸ºAUTO_INCREMENTï¼Œåœ¨æ’å…¥ä¸€è¡Œæ•°æ®çš„æ—¶å€™ï¼Œè‡ªå¢å€¼çš„è¡Œä¸ºå¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœæ’å…¥æ•°æ®æ—¶idå­—æ®µæŒ‡å®šä¸º0ã€null æˆ–æœªæŒ‡å®šå€¼ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªè¡¨å½“å‰çš„ AUTO_INCREMENTå€¼å¡«åˆ°è‡ªå¢å­—æ®µï¼›</li><li>å¦‚æœæ’å…¥æ•°æ®æ—¶idå­—æ®µæŒ‡å®šäº†å…·ä½“çš„å€¼ï¼Œå°±ç›´æ¥ä½¿ç”¨è¯­å¥é‡ŒæŒ‡å®šçš„å€¼ã€‚</li></ol><p><strong>è‡ªå¢å€¼çš„ä¿®æ”¹æ—¶æœº</strong></p><p><strong>å”¯ä¸€é”®å†²çªå¯¼è‡´è‡ªå¢ä¸»é”®idä¸è¿ç»­</strong></p><p>å‡è®¾ï¼Œè¡¨té‡Œé¢å·²ç»æœ‰äº†(1,1,1)è¿™æ¡è®°å½•ï¼Œè¿™æ—¶æˆ‘å†æ‰§è¡Œä¸€æ¡æ’å…¥æ•°æ®å‘½ä»¤ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">1</span>, <span class="number">1</span>); </span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæµç¨‹å°±æ˜¯ï¼š</p><ol><li>æ‰§è¡Œå™¨è°ƒç”¨InnoDBå¼•æ“æ¥å£å†™å…¥ä¸€è¡Œï¼Œä¼ å…¥çš„è¿™ä¸€è¡Œçš„å€¼æ˜¯(0,1,1);</li><li>InnoDBå‘ç°ç”¨æˆ·æ²¡æœ‰æŒ‡å®šè‡ªå¢idçš„å€¼ï¼Œè·å–è¡¨tå½“å‰çš„è‡ªå¢å€¼2ï¼›</li><li>å°†ä¼ å…¥çš„è¡Œçš„å€¼æ”¹æˆ(2,1,1);</li><li>å°†è¡¨çš„è‡ªå¢å€¼æ”¹æˆ3ï¼›</li><li>ç»§ç»­æ‰§è¡Œæ’å…¥æ•°æ®æ“ä½œï¼Œç”±äºå·²ç»å­˜åœ¨c=1çš„è®°å½•ï¼Œæ‰€ä»¥æŠ¥Duplicate key errorï¼Œè¯­å¥è¿”å›ã€‚</li></ol><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421214727022.png" alt="image-20240421214727022"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªè¡¨çš„è‡ªå¢å€¼æ”¹æˆ3ï¼Œæ˜¯åœ¨çœŸæ­£æ‰§è¡Œæ’å…¥æ•°æ®çš„æ“ä½œä¹‹å‰ã€‚è¿™ä¸ªè¯­å¥çœŸæ­£æ‰§è¡Œçš„æ—¶å€™ï¼Œå› ä¸ºç¢°åˆ°å”¯ä¸€é”®cå†²çªï¼Œæ‰€ä»¥id=2è¿™ä¸€è¡Œå¹¶æ²¡æœ‰æ’å…¥æˆåŠŸï¼Œä½†ä¹Ÿæ²¡æœ‰å°†è‡ªå¢å€¼å†æ”¹å›å»ã€‚</p><p><strong>äº‹åŠ¡å›æ»šå¯¼è‡´è‡ªå¢ä¸»é”®idä¸è¿ç»­</strong></p><p>åŒæ ·é“ç†ã€‚</p><p>æ€è€ƒï¼šä¸ºä»€ä¹ˆ<strong>è‡ªå¢å€¼ä¸ºä»€ä¹ˆä¸èƒ½å›é€€ï¼Ÿ</strong></p><p>ã€ç®€å•æ¥è¯´ï¼Œåœ¨å¤šäº‹åŠ¡æ‰§è¡Œä¸‹å›é€€ä¼šå‡ºç°é‡å¤ã€‘</p><p>ä¸‹é¢ä¸¾ä¾‹å­è¯´æ˜ã€‚</p><p>å‡è®¾æœ‰ä¸¤ä¸ªå¹¶è¡Œæ‰§è¡Œçš„äº‹åŠ¡ï¼Œåœ¨ç”³è¯·è‡ªå¢å€¼çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…ä¸¤ä¸ªäº‹åŠ¡ç”³è¯·åˆ°ç›¸åŒçš„è‡ªå¢idï¼Œè‚¯å®šè¦åŠ é”ï¼Œç„¶åé¡ºåºç”³è¯·ã€‚</p><ol><li>å‡è®¾äº‹åŠ¡Aç”³è¯·åˆ°äº†id=2ï¼Œ äº‹åŠ¡Bç”³è¯·åˆ°id=3ï¼Œé‚£ä¹ˆè¿™æ—¶å€™è¡¨tçš„è‡ªå¢å€¼æ˜¯4ï¼Œä¹‹åç»§ç»­æ‰§è¡Œã€‚</li><li>äº‹åŠ¡Bæ­£ç¡®æäº¤äº†ï¼Œä½†äº‹åŠ¡Aå‡ºç°äº†å”¯ä¸€é”®å†²çªã€‚</li><li>å¦‚æœå…è®¸äº‹åŠ¡AæŠŠè‡ªå¢idå›é€€ï¼Œä¹Ÿå°±æ˜¯æŠŠè¡¨tçš„å½“å‰è‡ªå¢å€¼æ”¹å›2ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼šè¡¨é‡Œé¢å·²ç»æœ‰id=3çš„è¡Œï¼Œè€Œå½“å‰çš„è‡ªå¢idå€¼æ˜¯2ã€‚</li><li>æ¥ä¸‹æ¥ï¼Œç»§ç»­æ‰§è¡Œçš„å…¶ä»–äº‹åŠ¡å°±ä¼šç”³è¯·åˆ°id=2ï¼Œç„¶åå†ç”³è¯·åˆ°id=3ã€‚è¿™æ—¶ï¼Œå°±ä¼šå‡ºç°æ’å…¥è¯­å¥æŠ¥é”™â€œä¸»é”®å†²çªâ€ã€‚</li></ol><p>è€Œä¸ºäº†è§£å†³è¿™ä¸ªä¸»é”®å†²çªï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ol><li>æ¯æ¬¡ç”³è¯·idä¹‹å‰ï¼Œå…ˆåˆ¤æ–­è¡¨é‡Œé¢æ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ªidã€‚å¦‚æœå­˜åœ¨ï¼Œå°±è·³è¿‡è¿™ä¸ªidã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•çš„æˆæœ¬å¾ˆé«˜ã€‚å› ä¸ºï¼Œæœ¬æ¥ç”³è¯·idæ˜¯ä¸€ä¸ªå¾ˆå¿«çš„æ“ä½œï¼Œç°åœ¨è¿˜è¦å†å»ä¸»é”®ç´¢å¼•æ ‘ä¸Šåˆ¤æ–­idæ˜¯å¦å­˜åœ¨ã€‚</li><li>æŠŠè‡ªå¢idçš„é”èŒƒå›´æ‰©å¤§ï¼Œå¿…é¡»ç­‰åˆ°ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆå¹¶æäº¤ï¼Œä¸‹ä¸€ä¸ªäº‹åŠ¡æ‰èƒ½å†ç”³è¯·è‡ªå¢idã€‚è¿™ä¸ªæ–¹æ³•çš„é—®é¢˜ï¼Œå°±æ˜¯é”çš„ç²’åº¦å¤ªå¤§ï¼Œç³»ç»Ÿå¹¶å‘èƒ½åŠ›å¤§å¤§ä¸‹é™ã€‚</li></ol><p>å¯è§ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚</p><p><strong>MySQLå†…éƒ¨æœºåˆ¶</strong></p><p>å¯¹äºæ‰¹é‡æ’å…¥æ•°æ®çš„è¯­å¥ï¼ŒMySQLæœ‰ä¸€ä¸ªæ‰¹é‡ç”³è¯·è‡ªå¢idçš„ç­–ç•¥ï¼š</p><ol><li>è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸€æ¬¡ç”³è¯·è‡ªå¢idï¼Œä¼šåˆ†é…1ä¸ªï¼›</li><li>1ä¸ªç”¨å®Œä»¥åï¼Œè¿™ä¸ªè¯­å¥ç¬¬äºŒæ¬¡ç”³è¯·è‡ªå¢idï¼Œä¼šåˆ†é…2ä¸ªï¼›</li><li>2ä¸ªç”¨å®Œä»¥åï¼Œè¿˜æ˜¯è¿™ä¸ªè¯­å¥ï¼Œç¬¬ä¸‰æ¬¡ç”³è¯·è‡ªå¢idï¼Œä¼šåˆ†é…4ä¸ªï¼›</li><li>ä¾æ­¤ç±»æ¨ï¼ŒåŒä¸€ä¸ªè¯­å¥å»ç”³è¯·è‡ªå¢idï¼Œæ¯æ¬¡ç”³è¯·åˆ°çš„è‡ªå¢idä¸ªæ•°éƒ½æ˜¯ä¸Šä¸€æ¬¡çš„ä¸¤å€ã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ä¸‹é¢çš„è¿™ä¸ªè¯­å¥åºåˆ—ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">3</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">4</span>,<span class="number">4</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2 <span class="keyword">like</span> t;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t2(c,d) <span class="keyword">select</span> c,d <span class="keyword">from</span> t;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t2 <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="number">5</span>,<span class="number">5</span>);</span><br></pre></td></tr></table></figure><p>insertâ€¦selectï¼Œå®é™…ä¸Šå¾€è¡¨t2ä¸­æ’å…¥äº†4è¡Œæ•°æ®ã€‚ä½†æ˜¯ï¼Œè¿™å››è¡Œæ•°æ®æ˜¯åˆ†ä¸‰æ¬¡ç”³è¯·çš„è‡ªå¢idï¼Œç¬¬ä¸€æ¬¡ç”³è¯·åˆ°äº†id=1ï¼Œç¬¬äºŒæ¬¡è¢«åˆ†é…äº†id=2å’Œid=3ï¼Œ ç¬¬ä¸‰æ¬¡è¢«åˆ†é…åˆ°id=4åˆ°id=7ã€‚</p><p>ç”±äºè¿™æ¡è¯­å¥å®é™…åªç”¨ä¸Šäº†4ä¸ªidï¼Œæ‰€ä»¥id=5åˆ°id=7å°±è¢«æµªè´¹æ‰äº†ã€‚ä¹‹åï¼Œå†æ‰§è¡Œinsert into t2 values(null, 5,5)ï¼Œå®é™…ä¸Šæ’å…¥çš„æ•°æ®å°±æ˜¯ï¼ˆ8,5,5)ã€‚</p><h2 id="40-insertè¯­å¥çš„é”ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤šï¼Ÿ"><strong>40 | insertè¯­å¥çš„é”ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤šï¼Ÿ</strong></h2><p>insert â€¦select æ˜¯å¾ˆå¸¸è§çš„åœ¨ä¸¤ä¸ªè¡¨ä¹‹é—´æ‹·è´æ•°æ®çš„æ–¹æ³•ã€‚ ä½ éœ€è¦æ³¨æ„ï¼Œ åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œ è¿™ä¸ªè¯­å¥ä¼šç»™selectçš„è¡¨é‡Œæ‰«æåˆ°çš„è®°å½•å’Œé—´éš™åŠ è¯»é”ã€‚</p><p>è€Œå¦‚æœinsertå’Œselectçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªè¡¨ï¼Œ åˆ™æœ‰å¯èƒ½ä¼šé€ æˆå¾ªç¯å†™å…¥ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼Œ æˆ‘ä»¬éœ€è¦å¼•å…¥ç”¨æˆ·ä¸´æ—¶è¡¨æ¥åšä¼˜åŒ–ã€‚<br>insert è¯­å¥å¦‚æœå‡ºç°å”¯ä¸€é”®å†²çªï¼Œ ä¼šåœ¨å†²çªçš„å”¯ä¸€å€¼ä¸ŠåŠ å…±äº«çš„next-keylock(Sé”)ã€‚ å› æ­¤ï¼Œ ç¢°åˆ°ç”±äºå”¯ä¸€é”®çº¦æŸå¯¼è‡´æŠ¥é”™åï¼Œ è¦å°½å¿«æäº¤æˆ–å›æ»šäº‹åŠ¡ï¼Œ é¿å…åŠ é”æ—¶é—´è¿‡é•¿ã€‚</p><h2 id="41-æ€ä¹ˆæœ€å¿«åœ°å¤åˆ¶ä¸€å¼ è¡¨ï¼Ÿ"><strong>41 | æ€ä¹ˆæœ€å¿«åœ°å¤åˆ¶ä¸€å¼ è¡¨ï¼Ÿ</strong></h2><p><strong>mysqldumpæ–¹æ³•</strong></p><p>SQL mysqldump -h$host -P$port -u$user --add-locks=0 --no-create-info --single-transaction --set-gtid-purged=OFF db1</p><p>è¿™æ¡å‘½ä»¤ä¸­ï¼Œ ä¸»è¦å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p><ol><li><p>â€“single-transactionçš„ä½œç”¨æ˜¯ï¼Œ åœ¨å¯¼å‡ºæ•°æ®çš„æ—¶å€™ä¸éœ€è¦å¯¹è¡¨db1.tåŠ è¡¨é”ï¼Œ è€Œæ˜¯ä½¿ç”¨STARTTRANSACTION WITH CONSISTENTSNAPSHOTçš„æ–¹æ³•ï¼›</p></li><li><p>â€“add-locksè®¾ç½®ä¸º0ï¼Œ è¡¨ç¤ºåœ¨è¾“å‡ºçš„æ–‡ä»¶ç»“æœé‡Œï¼Œ ä¸å¢åŠ &quot; LOCKTABLES t WRITE;&quot;ï¼›</p></li><li><p>â€“no-create-infoçš„æ„æ€æ˜¯ï¼Œ ä¸éœ€è¦å¯¼å‡ºè¡¨ç»“æ„ï¼›</p></li><li><p>â€“set-gtid-purged=offè¡¨ç¤ºçš„æ˜¯ï¼Œ ä¸è¾“å‡ºè·ŸGTIDç›¸å…³çš„ä¿¡æ¯ï¼›</p></li><li><p>â€“result-fileæŒ‡å®šäº†è¾“å‡ºæ–‡ä»¶çš„è·¯å¾„ï¼Œ å…¶ä¸­clientè¡¨ç¤ºç”Ÿæˆçš„æ–‡ä»¶æ˜¯åœ¨å®¢æˆ·ç«¯æœºå™¨ä¸Šçš„ã€‚<br>é€šè¿‡è¿™æ¡mysqldumpå‘½ä»¤ç”Ÿæˆçš„t.sqlæ–‡ä»¶ä¸­å°±åŒ…å«äº†å¦‚å›¾1æ‰€ç¤ºçš„INSERTè¯­å¥ã€‚</p></li></ol><p><strong>å¯¼å‡ºCSVæ–‡ä»¶</strong></p><p>å¦ä¸€ç§æ–¹æ³•æ˜¯ç›´æ¥å°†ç»“æœå¯¼å‡ºæˆ.csvæ–‡ä»¶ã€‚ MySQLæä¾›äº†ä¸‹é¢çš„è¯­æ³•ï¼Œ ç”¨æ¥å°†æŸ¥è¯¢ç»“æœå¯¼å‡ºåˆ°æœåŠ¡ç«¯æœ¬åœ°ç›®å½•ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> db1.t <span class="keyword">where</span> a<span class="operator">&gt;</span><span class="number">900</span> <span class="keyword">into</span> outfile <span class="string">&#x27;/server_tmp/t.csv&#x27;</span>;</span><br></pre></td></tr></table></figure><p><strong>ç‰©ç†æ‹·è´</strong></p><h2 id="42-grantä¹‹åè¦è·Ÿç€flush-privilegeså—ï¼Ÿ"><strong>42 | grantä¹‹åè¦è·Ÿç€flush privilegeså—ï¼Ÿ</strong></h2><p>grantä¹‹åçœŸçš„éœ€è¦æ‰§è¡Œflush privilegeså—ï¼Ÿ</p><p>å¦‚æœæ²¡æœ‰æ‰§è¡Œè¿™ä¸ªflushå‘½ä»¤çš„è¯ï¼Œ èµ‹æƒè¯­å¥çœŸçš„ä¸èƒ½ç”Ÿæ•ˆå—ï¼Ÿgrantè¯­å¥ä¼šåŒæ—¶ä¿®æ”¹æ•°æ®è¡¨å’Œå†…å­˜ï¼Œ åˆ¤æ–­æƒé™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯å†…å­˜æ•°æ®ã€‚ å› æ­¤ï¼Œ è§„èŒƒåœ°ä½¿ç”¨grantå’Œrevokeè¯­å¥ï¼Œ æ˜¯ä¸éœ€è¦éšååŠ ä¸Šflush privilegesè¯­å¥çš„ã€‚flush privilegesè¯­å¥æœ¬èº«ä¼šç”¨æ•°æ®è¡¨çš„æ•°æ®é‡å»ºä¸€ä»½å†…å­˜æƒé™æ•°æ®ï¼Œ æ‰€ä»¥åœ¨æƒé™æ•°æ®å¯èƒ½å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µä¸‹å†ä½¿ç”¨ã€‚ è€Œè¿™ç§ä¸ä¸€è‡´å¾€å¾€æ˜¯ç”±äºç›´æ¥ç”¨DMLè¯­å¥æ“ä½œç³»ç»Ÿæƒé™è¡¨å¯¼è‡´çš„ï¼Œ æ‰€ä»¥æˆ‘ä»¬å°½é‡ä¸è¦ä½¿ç”¨è¿™ç±»è¯­å¥ã€‚</p><h2 id="43-è¦ä¸è¦ä½¿ç”¨åˆ†åŒºè¡¨ï¼Ÿ"><strong>43 | è¦ä¸è¦ä½¿ç”¨åˆ†åŒºè¡¨ï¼Ÿ</strong></h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t` (</span><br><span class="line">  `ftime` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  KEY (`ftime`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>latin1</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(ftime))</span><br><span class="line">(<span class="keyword">PARTITION</span> p_2017 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2017</span>) ENGINE <span class="operator">=</span> InnoDB,</span><br><span class="line"> <span class="keyword">PARTITION</span> p_2018 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2018</span>) ENGINE <span class="operator">=</span> InnoDB,</span><br><span class="line"> <span class="keyword">PARTITION</span> p_2019 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2019</span>) ENGINE <span class="operator">=</span> InnoDB,</span><br><span class="line"><span class="keyword">PARTITION</span> p_others <span class="keyword">VALUES</span> LESS THAN MAXVALUE ENGINE <span class="operator">=</span> InnoDB);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="string">&#x27;2017-4-1&#x27;</span>,<span class="number">1</span>),(<span class="string">&#x27;2018-4-1&#x27;</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>åœ¨è¡¨tä¸­åˆå§‹åŒ–æ’å…¥äº†ä¸¤è¡Œè®°å½•ï¼Œ æŒ‰ç…§å®šä¹‰çš„åˆ†åŒºè§„åˆ™ï¼Œ è¿™ä¸¤è¡Œè®°å½•åˆ†åˆ«è½åœ¨p_2018å’Œp_2019è¿™ä¸¤ä¸ªåˆ†åŒºä¸Šã€‚å¯ä»¥çœ‹åˆ°ï¼Œ è¿™ä¸ªè¡¨åŒ…å«äº†ä¸€ä¸ª.frmæ–‡ä»¶å’Œ4ä¸ª.ibdæ–‡ä»¶ï¼Œ æ¯ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ª.ibdæ–‡ä»¶ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼šå¯¹äºå¼•æ“å±‚æ¥è¯´ï¼Œ è¿™æ˜¯4ä¸ªè¡¨ï¼›å¯¹äºServerå±‚æ¥è¯´ï¼Œ è¿™æ˜¯1ä¸ªè¡¨ã€‚</p><p><strong>åˆ†åŒºç­–ç•¥</strong></p><ul><li><p>MyISAMåˆ†åŒºè¡¨ä½¿ç”¨çš„åˆ†åŒºç­–ç•¥ï¼Œ æˆ‘ä»¬ç§°ä¸ºé€šç”¨åˆ†åŒºç­–ç•¥ï¼ˆgeneric partitioningï¼‰ ï¼Œ æ¯æ¬¡è®¿é—®åˆ†åŒºéƒ½ç”±serverå±‚æ§åˆ¶ã€‚ é€šç”¨åˆ†åŒºç­–ç•¥ï¼Œ æ˜¯MySQLä¸€å¼€å§‹æ”¯æŒåˆ†åŒºè¡¨çš„æ—¶å€™å°±å­˜åœ¨çš„ä»£ç ï¼Œ åœ¨æ–‡ä»¶ç®¡ç†ã€ è¡¨ç®¡ç†çš„å®ç°ä¸Šå¾ˆç²—ç³™ï¼Œ å› æ­¤æœ‰æ¯”è¾ƒä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚</p></li><li><p>ä»MySQL 5.7.9å¼€å§‹ï¼Œ InnoDBå¼•æ“å¼•å…¥äº†æœ¬åœ°åˆ†åŒºç­–ç•¥ï¼ˆnative partitioningï¼‰ ã€‚ è¿™ä¸ªç­–ç•¥æ˜¯åœ¨InnoDBå†…éƒ¨è‡ªå·±ç®¡ç†æ‰“å¼€åˆ†åŒºçš„è¡Œä¸ºã€‚</p></li><li><p>MySQLä»5.7.17å¼€å§‹ï¼Œ å°†MyISAMåˆ†åŒºè¡¨æ ‡è®°ä¸ºå³å°†å¼ƒç”¨(deprecated)ï¼Œ æ„æ€æ˜¯â€œä»è¿™ä¸ªç‰ˆæœ¬å¼€å§‹ä¸å»ºè®®è¿™ä¹ˆä½¿ç”¨ï¼Œ è¯·ä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆã€‚ åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­ä¼šåºŸå¼ƒè¿™ä¸ªåŠŸèƒ½â€ã€‚</p></li><li><p>ä»MySQL 8.0ç‰ˆæœ¬å¼€å§‹ï¼Œ å°±ä¸å…è®¸åˆ›å»ºMyISAMåˆ†åŒºè¡¨äº†ï¼Œ åªå…è®¸åˆ›å»ºå·²ç»å®ç°äº†æœ¬åœ°åˆ†åŒºç­–ç•¥çš„å¼•æ“ã€‚ ç›®å‰æ¥çœ‹ï¼Œ åªæœ‰InnoDBå’ŒNDBè¿™ä¸¤ä¸ªå¼•æ“æ”¯æŒäº†æœ¬åœ°åˆ†åŒºç­–ç•¥ã€‚</p></li></ul><p><strong>åˆ†åŒºè¡¨çš„serverå±‚è¡Œä¸º</strong></p><p>å¦‚æœä»serverå±‚çœ‹çš„è¯ï¼Œ ä¸€ä¸ªåˆ†åŒºè¡¨å°±åªæ˜¯ä¸€ä¸ªè¡¨ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421215158558.png" alt="image-20240421215158558"></p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240421215203807.png" alt="image-20240421215203807"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œ è™½ç„¶session Båªéœ€è¦æ“ä½œp_2107è¿™ä¸ªåˆ†åŒºï¼Œ ä½†æ˜¯ç”±äºsession AæŒæœ‰æ•´ä¸ªè¡¨tçš„MDLé”ï¼Œ å°±å¯¼è‡´äº†session Bçš„alterè¯­å¥è¢«å µä½ã€‚</p><ol><li><p>MySQLåœ¨ç¬¬ä¸€æ¬¡æ‰“å¼€åˆ†åŒºè¡¨çš„æ—¶å€™ï¼Œ éœ€è¦è®¿é—®æ‰€æœ‰çš„åˆ†åŒºï¼›</p></li><li><p>åœ¨serverå±‚ï¼Œ è®¤ä¸ºè¿™æ˜¯åŒä¸€å¼ è¡¨ï¼Œ å› æ­¤æ‰€æœ‰åˆ†åŒºå…±ç”¨åŒä¸€ä¸ªMDLé”ï¼›</p></li><li><p>åœ¨å¼•æ“å±‚ï¼Œ è®¤ä¸ºè¿™æ˜¯ä¸åŒçš„è¡¨ï¼Œ å› æ­¤MDLé”ä¹‹åçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œ ä¼šæ ¹æ®åˆ†åŒºè¡¨è§„åˆ™ï¼Œåªè®¿é—®å¿…è¦çš„åˆ†åŒºã€‚</p></li></ol><p>æœ‰ä¸¤ä¸ªé—®é¢˜éœ€è¦æ³¨æ„ï¼š</p><ol><li>åˆ†åŒºå¹¶ä¸æ˜¯è¶Šç»†è¶Šå¥½ã€‚ å®é™…ä¸Šï¼Œ å•è¡¨æˆ–è€…å•åˆ†åŒºçš„æ•°æ®ä¸€åƒä¸‡è¡Œï¼Œ åªè¦æ²¡æœ‰ç‰¹åˆ«å¤§çš„ç´¢å¼•ï¼Œå¯¹äºç°åœ¨çš„ç¡¬ä»¶èƒ½åŠ›æ¥è¯´éƒ½å·²ç»æ˜¯å°è¡¨äº†ã€‚</li><li>åˆ†åŒºä¹Ÿä¸è¦æå‰é¢„ç•™å¤ªå¤šï¼Œ åœ¨ä½¿ç”¨ä¹‹å‰é¢„å…ˆåˆ›å»ºå³å¯ã€‚ æ¯”å¦‚ï¼Œ å¦‚æœæ˜¯æŒ‰æœˆåˆ†åŒºï¼Œ æ¯å¹´å¹´åº•æ—¶å†æŠŠä¸‹ä¸€å¹´åº¦çš„12ä¸ªæ–°åˆ†åŒºåˆ›å»ºä¸Šå³å¯ã€‚ å¯¹äºæ²¡æœ‰æ•°æ®çš„å†å²åˆ†åŒºï¼Œ è¦åŠæ—¶çš„dropæ‰ã€‚</li></ol><p>è‡³äºåˆ†åŒºè¡¨çš„å…¶ä»–é—®é¢˜ï¼Œ æ¯”å¦‚æŸ¥è¯¢éœ€è¦è·¨å¤šä¸ªåˆ†åŒºå–æ•°æ®ï¼Œ æŸ¥è¯¢æ€§èƒ½å°±ä¼šæ¯”è¾ƒæ…¢ï¼Œ åŸºæœ¬ä¸Šå°±ä¸æ˜¯åˆ†åŒºè¡¨æœ¬èº«çš„é—®é¢˜ï¼Œ è€Œæ˜¯æ•°æ®é‡çš„é—®é¢˜æˆ–è€…è¯´æ˜¯ä½¿ç”¨æ–¹å¼çš„é—®é¢˜äº†ã€‚</p><h2 id="44-ç­”ç–‘æ–‡ç« ï¼ˆä¸‰ï¼‰-ï¼š-è¯´ä¸€è¯´è¿™äº›å¥½é—®é¢˜"><strong>44 | ç­”ç–‘æ–‡ç« ï¼ˆä¸‰ï¼‰</strong> <strong>ï¼š</strong> <strong>è¯´ä¸€è¯´è¿™äº›å¥½é—®é¢˜</strong></h2><h2 id="45-è‡ªå¢idç”¨å®Œæ€ä¹ˆåŠï¼Ÿ"><strong>45 | è‡ªå¢idç”¨å®Œæ€ä¹ˆåŠï¼Ÿ</strong></h2><p>MySQLé‡Œé¢çš„å‡ ç§è‡ªå¢idï¼Œ ä¸€èµ·åˆ†æä¸€ä¸‹å®ƒä»¬çš„å€¼è¾¾åˆ°ä¸Šé™ä»¥åï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µã€‚2^32 -1ï¼ˆ4294967295ï¼‰ ä¸æ˜¯ä¸€ä¸ªç‰¹åˆ«å¤§çš„æ•°ï¼Œ å¯¹äºä¸€ä¸ªé¢‘ç¹æ’å…¥åˆ é™¤æ•°æ®çš„è¡¨æ¥è¯´ï¼Œ æ˜¯å¯èƒ½ä¼šè¢«ç”¨å®Œçš„ã€‚ å› æ­¤åœ¨å»ºè¡¨çš„æ—¶å€™ä½ éœ€è¦è€ƒå¯Ÿä½ çš„è¡¨æ˜¯å¦æœ‰å¯èƒ½è¾¾åˆ°è¿™ä¸ªä¸Šé™ï¼Œ å¦‚æœæœ‰å¯èƒ½ï¼Œ å°±åº”è¯¥åˆ›å»ºæˆ8ä¸ªå­—èŠ‚çš„bigint unsignedã€‚</p><p><strong>InnoDBç³»ç»Ÿè‡ªå¢row_id</strong></p><p>å¦‚æœä½ åˆ›å»ºçš„InnoDBè¡¨æ²¡æœ‰æŒ‡å®šä¸»é”®ï¼Œ é‚£ä¹ˆInnoDBä¼šç»™ä½ åˆ›å»ºä¸€ä¸ªä¸å¯è§çš„ï¼Œ é•¿åº¦ä¸º6ä¸ªå­—èŠ‚çš„row_idã€‚ InnoDBç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€çš„dict_sys.row_idå€¼ï¼Œ æ‰€æœ‰æ— ä¸»é”®çš„InnoDBè¡¨ï¼Œ æ¯æ’å…¥ä¸€è¡Œæ•°æ®ï¼Œ éƒ½å°†å½“å‰çš„dict_sys.row_idå€¼ä½œä¸ºè¦æ’å…¥æ•°æ®çš„row_idï¼Œ ç„¶åæŠŠdict_sys.row_idçš„å€¼åŠ 1ã€‚</p><p>æ¯ç§è‡ªå¢idæœ‰å„è‡ªçš„åº”ç”¨åœºæ™¯ï¼Œ åœ¨è¾¾åˆ°ä¸Šé™åçš„è¡¨ç°ä¹Ÿä¸åŒï¼š</p><ol><li><p>è¡¨çš„è‡ªå¢idè¾¾åˆ°ä¸Šé™åï¼Œ å†ç”³è¯·æ—¶å®ƒçš„å€¼å°±ä¸ä¼šæ”¹å˜ï¼Œ è¿›è€Œå¯¼è‡´ç»§ç»­æ’å…¥æ•°æ®æ—¶æŠ¥ä¸»é”®å†²çªçš„é”™è¯¯ã€‚</p></li><li><p>row_idè¾¾åˆ°ä¸Šé™åï¼Œ åˆ™ä¼šå½’0å†é‡æ–°é€’å¢ï¼Œ å¦‚æœå‡ºç°ç›¸åŒçš„row_idï¼Œ åå†™çš„æ•°æ®ä¼šè¦†ç›–ä¹‹å‰çš„æ•°æ®ã€‚</p></li><li><p>Xidåªéœ€è¦ä¸åœ¨åŒä¸€ä¸ªbinlogæ–‡ä»¶ä¸­å‡ºç°é‡å¤å€¼å³å¯ã€‚ è™½ç„¶ç†è®ºä¸Šä¼šå‡ºç°é‡å¤å€¼ï¼Œ ä½†æ˜¯æ¦‚ç‡æå°ï¼Œ å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p></li><li><p>InnoDBçš„max_trx_id é€’å¢å€¼æ¯æ¬¡MySQLé‡å¯éƒ½ä¼šè¢«ä¿å­˜èµ·æ¥ï¼Œ æ‰€ä»¥æˆ‘ä»¬æ–‡ç« ä¸­æåˆ°çš„è„è¯»çš„ä¾‹å­å°±æ˜¯ä¸€ä¸ªå¿…ç°çš„bugï¼Œ å¥½åœ¨ç•™ç»™æˆ‘ä»¬çš„æ—¶é—´è¿˜å¾ˆå……è£•ã€‚</p></li><li><p>thread_idæ˜¯æˆ‘ä»¬ä½¿ç”¨ä¸­æœ€å¸¸è§çš„ï¼Œ è€Œä¸”ä¹Ÿæ˜¯å¤„ç†å¾—æœ€å¥½çš„ä¸€ä¸ªè‡ªå¢idé€»è¾‘äº†ã€‚</p></li></ol><h2 id="é¢è¯•é«˜é¢‘çŸ¥è¯†"><strong>é¢è¯•é«˜é¢‘çŸ¥è¯†</strong></h2><p>æ¬è¿è‡ªçŸ¥ä¹</p><p>1ã€ä¸€æ¡ sql è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œä»å®¢æˆ·ç«¯æ‰§è¡Œäº†ä¸€æ¡ sql å‘½ä»¤ï¼ŒæœåŠ¡ç«¯ä¼šè¿›è¡Œå“ªäº›å¤„ç†ï¼Ÿï¼ˆä¾‹å¦‚éªŒè¯èº«ä»½ï¼Œæ˜¯å¦å¯ç”¨ç¼“å­˜å•¥çš„ï¼‰</p><p>2ã€ç´¢å¼•ç›¸å…³ï¼šç´¢å¼•æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå¤šç§å¼•æ“çš„å®ç°åŒºåˆ«ï¼Ÿèšæ—ç´¢å¼•ï¼Œéèšæ—ç´¢å¼•ï¼ŒäºŒçº§ç´¢å¼•ï¼Œå”¯ä¸€ç´¢å¼•ã€æœ€å·¦åŒ¹é…åŸåˆ™ç­‰ç­‰ï¼ˆéå¸¸é‡è¦ï¼‰</p><p>3ã€äº‹åŠ¡ç›¸å…³ï¼šä¾‹å¦‚äº‹åŠ¡çš„éš”ç¦»æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿäº‹åŠ¡æ˜¯å¦‚ä½•ä¿è¯åŸå­æ€§ï¼Ÿä¸åŒçš„äº‹åŠ¡çœ‹åˆ°çš„æ•°æ®æ€ä¹ˆå°±ä¸ä¸€æ ·äº†ï¼Ÿéš¾é“æ¯ä¸ªäº‹åŠ¡éƒ½æ‹·è´ä¸€ä»½è§†å›¾ï¼ŸMVCC çš„å®ç°åŸç†ï¼ˆé‡è¦ï¼‰ç­‰ç­‰ã€‚</p><p>4ã€å„ç§é”ç›¸å…³ï¼šä¾‹å¦‚è¡¨é”ï¼Œè¡Œé”ï¼Œé—´éš™é”ï¼Œå…±äº«é”ï¼Œæ’ä»–é”ã€‚è¿™äº›é”çš„å‡ºç°ä¸»è¦æ˜¯ç”¨æ¥è§£å†³å“ªäº›é—®é¢˜ï¼Ÿï¼ˆé‡è¦ï¼‰</p><p>5ã€æ—¥å¿—ç›¸å…³ï¼šredologï¼Œbinlogï¼Œundologï¼Œè¿™äº›æ—¥å¿—çš„å®ç°åŸç†ï¼Œä¸ºäº†è§£å†³æ€ä¹ˆé—®é¢˜ï¼Ÿæ—¥å¿—ä¹Ÿæ˜¯éå¸¸é‡è¦çš„å§ï¼Œé¢è¯•ä¹Ÿé—®çš„æŒºå¤šã€‚</p><p>6ã€æ•°æ®åº“çš„ä¸»ä»å¤‡ä»½ã€å¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€å¦‚ä½•ä¿è¯é«˜å¯ç”¨ç­‰ç­‰ã€‚</p><p>7ã€ä¸€äº›æ•…éšœæ’æŸ¥çš„å‘½ä»¤ï¼Œä¾‹å¦‚æ…¢æŸ¥è¯¢ï¼Œsql çš„æ‰§è¡Œè®¡åˆ’ï¼Œç´¢å¼•ç»Ÿè®¡çš„åˆ·æ–°ç­‰ç­‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CppåŸºç¡€çŸ¥è¯†</title>
      <link href="/posts/4772239d.html"/>
      <url>/posts/4772239d.html</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>å†…åŠŸå­¦ä¹ æ¨è</p><ul><li>CSAPP ç¬¬ä¸ƒç« ï¼šé“¾æ¥</li><li>ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ï¼šç¬¬2ï¼Œ3ï¼Œ4ï¼Œ6ç« </li></ul><h1>åŸºç¡€çŸ¥è¯†</h1><h2 id="å½¢å‚å¸¦é»˜è®¤å€¼">å½¢å‚å¸¦é»˜è®¤å€¼</h2><p>å½¢å‚å¸¦é»˜è®¤å€¼çš„å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sum</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sum1</span><span class="params">(<span class="type">int</span> a=<span class="number">2</span>, <span class="type">int</span> b=<span class="number">4</span>)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> b = <span class="number">20</span>;</span><br><span class="line"><span class="type">int</span> ret = <span class="built_in">sum</span>(a, b);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;ret:&quot;</span> &lt;&lt; ret &lt;&lt; endl;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>Note1</strong></p></blockquote><p>è‹¥æ˜¯ä¼ å…¥å®å‚ï¼Œåˆ™ä½¿ç”¨çš„å°±æ˜¯ä½ çš„å®å‚ã€‚æ²¡æœ‰ä¼ å…¥å°±ä½¿ç”¨å½¢å‚çš„é»˜è®¤å€¼ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">fun</span><span class="params">(<span class="type">int</span> a=<span class="number">1</span>,<span class="type">int</span> b)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a+b;</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">cout&lt;&lt;<span class="built_in">fun</span>(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bug</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span><span class="number">5</span>E<span class="operator">:</span>\CPP\<span class="number">996.</span>cpp[<span class="literal">Error</span>] <span class="keyword">default</span> argument missing <span class="keyword">for</span> parameter <span class="number">2</span> <span class="keyword">of</span> <span class="symbol">&#x27;int</span> <span class="keyword">fun</span>(<span class="type">int</span>, <span class="type">int</span>)&#x27;</span><br></pre></td></tr></table></figure><p>Noteï¼šå½¢å‚ç»™é»˜è®¤å€¼çš„æ—¶å€™ï¼Œåªèƒ½ä»å³å‘å·¦ç»™ã€‚å› ä¸ºå‹æ ˆçš„æ—¶å€™æ˜¯ä»å³å‘å·¦å‹çš„ã€‚</p><blockquote><p><strong>Note2</strong></p></blockquote><p>è°ƒç”¨å½¢å‚å¸¦é»˜è®¤å€¼çš„å‡½æ•°ï¼Œå…¶æ•ˆç‡ä¸ä¸å¸¦çš„æ¯”è¾ƒï¼Ÿ</p><ul><li>æ•ˆç‡æ˜¯å¢é•¿äº†ï¼Œæ¯•ç«Ÿå°‘äº†movæŒ‡ä»¤</li></ul><p>æ±‡ç¼–æŸ¥çœ‹</p><ul><li>pre</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">01112156  mov         eax,dword ptr [b]  ã€ebp-8ã€‘</span><br><span class="line">01112159  push        eax  </span><br><span class="line">0111215A  mov         ecx,dword ptr [a]  ã€ebp-4ã€‘</span><br><span class="line">0111215D  push        ecx  </span><br><span class="line">0111215E  call        sum (01111406h)  </span><br></pre></td></tr></table></figure><ul><li>now</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0111217A  push        14h  </span><br><span class="line">0111217C  push        0Ah  </span><br><span class="line">0111217E  call        sum (01111406h)  </span><br></pre></td></tr></table></figure><blockquote><p><strong>Note3</strong></p></blockquote><p>å‡½æ•°å½¢å‚å˜é‡ç»™é»˜è®¤å€¼ï¼Œå®šä¹‰å¤„å¯ä»¥å£°æ˜ä¹Ÿå¯ä»¥ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sum</span><span class="params">(<span class="type">int</span> a = <span class="number">10</span>, <span class="type">int</span> b = <span class="number">20</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> b = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> ret = <span class="built_in">sum</span>(a, b);</span><br><span class="line"></span><br><span class="line">ret = <span class="built_in">sum</span>(a);</span><br><span class="line"></span><br><span class="line">ret = <span class="built_in">sum</span>();</span><br><span class="line"></span><br><span class="line">ret = <span class="built_in">sum</span>(a, <span class="number">40</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sum</span><span class="params">(<span class="type">int</span> a , <span class="type">int</span> b )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>Note4</strong></p></blockquote><p>å‡½æ•°å£°æ˜å¯ä»¥å¾ˆå¤šæ¬¡ï¼Œå®šä¹‰åªæœ‰ä¸€æ¬¡ã€‚ä½†æ˜¯å½¢å‚ç»™é»˜è®¤å€¼ï¼Œä¸ç®¡æ˜¯åœ¨å®šä¹‰å¤„è¿˜æ˜¯å£°æ˜å¤„ç»™ï¼Œå½¢å‚é»˜è®¤å€¼åªèƒ½å‡ºç°ä¸€æ¬¡ã€‚</p><h2 id="å†…è”inline">å†…è”inline</h2><p>å†…è”å‡½æ•°å’Œæ™®é€šå‡½æ•°çš„åŒºåˆ«ï¼š</p><ol><li>inlineå‡½æ•°åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚åœ¨å‡½æ•°è°ƒç”¨ç‚¹ï¼ˆint ret = sum(a, b);ï¼‰ç›´æ¥æŠŠå‡½æ•°çš„ä»£ç è¿›è¡Œå±•å¼€å¤„ç†ã€‚</li><li>inlineå‡½æ•°(å†…è”æˆåŠŸ)ä¸ä¼šåœ¨ç¬¦å·è¡¨ä¸­ç”Ÿæˆç›¸åº”çš„å‡½æ•°ç¬¦å·ã€‚</li><li>inlineåªæ˜¯å»ºè®®ç¼–è¯‘å™¨æŠŠè¿™ä¸ªå‡½æ•°å¤„ç†ä¸ºå†…è”å‡½æ•°ï¼Œä½†æ˜¯ç¼–è¯‘å™¨æœ€ç»ˆå†³å®šæ˜¯å¦å¤„ç†ä¸ºå†…è”å‡½æ•°çš„ã€‚</li><li>å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹ï¼šobjdump -t main.oã€‚å°±çœ‹åœ¨ç¬¦å·è¡¨é‡Œé¢æœ‰æ²¡æœ‰äº§ç”Ÿç¬¦å·ï¼Œè‹¥å†…è”æˆåŠŸè‚¯å®šæ²¡æœ‰ç¬¦å·ã€‚</li><li>åœ¨debugç‰ˆæœ¬ä¸Šï¼Œinlineæ˜¯ä¸èµ·ä½œç”¨çš„(ä¹Ÿæœ‰æ™®é€šå‡½æ•°çš„è°ƒç”¨å¼€é”€)ï¼Œå› ä¸ºæ˜¯debugç‰ˆæœ¬éœ€è¦è°ƒè¯•çš„ã€‚</li></ol><p>Noteï¼šé€’å½’ä¸ä¼šäº§ç”Ÿå†…è”ã€‚</p><p>å…·ä½“ä»£ç è§„èŒƒå‚è€ƒã€ŠGoogle Style C++ã€‹</p><h2 id="å‡½æ•°é‡è½½">å‡½æ•°é‡è½½</h2><blockquote><p>pro1ï¼šC++ä¸ºä»€ä¹ˆæ”¯æŒå‡½æ•°é‡è½½ï¼Œä½†æ˜¯Cè¯­è¨€ä¸æ”¯æŒï¼Ÿ</p></blockquote><p>ç¼–è¯‘å™¨ç¼–è¯‘ä»£ç äº§ç”Ÿç¬¦å·çš„è§„åˆ™ä¸åŒã€‚</p><ol><li>C++ä»£ç äº§ç”Ÿå‡½æ•°ç¬¦å·çš„æ—¶å€™ï¼Œæ˜¯ç”± <strong>å‡½æ•°å+å‚æ•°åˆ—è¡¨ç±»å‹</strong> ç»„æˆçš„ã€‚</li><li>Cè¯­è¨€äº§ç”Ÿå‡½æ•°ç¬¦å·çš„æ—¶å€™ï¼Œæ˜¯åªç”±å‡½æ•°åæ¥å†³å®šçš„ã€‚ï¼ˆåœ¨Cè¯­è¨€ä¸­ï¼Œå‡½æ•°åç›¸åŒï¼Œæ‰€ä»¥å°±ä¼šäº§ç”Ÿé“¾æ¥é”™è¯¯ï¼šæ‰¾åˆ°å¤šä¸ªå‡½æ•°çš„å®šä¹‰ï¼‰</li></ol><blockquote><p>pro2ï¼šå‡½æ•°é‡è½½éœ€è¦æ³¨æ„äº›ä»€ä¹ˆï¼Ÿ</p></blockquote><p>å‡½æ•°é‡è½½ï¼šä¸€ç»„å‡½æ•°ï¼Œå…¶å‡½æ•°åç›¸åŒï¼Œå‚æ•°åˆ—è¡¨çš„ä¸ªæ•°æˆ–è€…ç±»å‹ä¸åŒï¼Œé‚£ä¹ˆè¿™ä¸€ç»„å‡½æ•°å°±å¯ä»¥ç§°ä½œä¸ºå‡½æ•°é‡è½½ã€‚ä¸€ç»„å‡½æ•°è¦ç§°å¾—ä¸Šé‡è½½ï¼Œä¸€å®šå¾—å…ˆå¤„äºåŒä¸€ä¸ªä½œç”¨åŸŸå½“ä¸­çš„ã€‚é‡è½½å‡½æ•°åå­—éƒ½ä¸€æ ·ï¼Œåœ¨ç¼–è¯‘å™¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ä¼šæ ¹æ®å‡½æ•°è°ƒç”¨çš„æ—¶å€™ ä¼ å…¥çš„å®å‚çš„ç±»å‹æ¥é€‰æ‹©åˆé€‚çš„å‡½æ•°é‡è½½ç‰ˆæœ¬ã€‚</p><p>æ³¨æ„ç‚¹</p><ol><li>å‡½æ•°é‡è½½å®šä¹‰ï¼š<strong>ä¸€ç»„å‡½æ•°ï¼Œå…¶å‡½æ•°åç›¸åŒï¼Œå‚æ•°åˆ—è¡¨çš„ä¸ªæ•°æˆ–è€…ç±»å‹ä¸åŒ</strong>ï¼Œé‚£ä¹ˆè¿™ä¸€ç»„å‡½æ•°å°±å¯ä»¥ç§°ä½œä¸ºå‡½æ•°é‡è½½ã€‚</li><li>ä¸€ç»„å‡½æ•°è¦ç§°å¾—ä¸Šé‡è½½ï¼Œ<strong>ä¸€å®šå¾—å…ˆå¤„äºåŒä¸€ä¸ªä½œç”¨åŸŸå½“ä¸­çš„</strong>ï¼ˆä»å‡½æ•°è°ƒç”¨ç‚¹æ¥çœ‹ï¼Œè¿™ç»„å‡½æ•°æ˜¯å¤„äºåŒä¸€ä¸ªä½œç”¨åŸŸ ã€‚æ³¨ï¼šåœ¨å‡½æ•°ä¸­ä¸å¯ä»¥å®šä¹‰å‡½æ•°ï¼Œå¯ä»¥å£°æ˜å‡½æ•°ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„å…¶ä¸­çš„ä½œç”¨åŸŸé—®é¢˜ï¼‰</li><li>å½“ç»™å‚æ•°åŠ ä¸Šconstæˆ–è€…volatileï¼ˆæ ‡å‡†çš„C/C++çš„å…³é”®å­—ï¼‰çš„æ—¶å€™ï¼Œæ˜¯æ€ä¹ˆå½±å“å½¢å‚ç±»å‹çš„ï¼Ÿ(ä¸‹é¢ä¼šè¿›è¡Œè¯¦è§£)</li><li>ä¸€ç»„å‡½æ•°ï¼Œå‡½æ•°åç›¸åŒï¼Œå‚æ•°åˆ—è¡¨ä¹Ÿç›¸åŒï¼Œä»…ä»…æ˜¯è¿”å›å€¼ä¸åŒï¼Ÿ<strong>è¿™ä¸æ˜¯é‡è½½</strong> ã€‚</li></ol><ul><li><strong>è¿”å›å€¼ç›¸ä¸ç›¸åŒå’Œå‡½æ•°é‡è½½æ²¡æœ‰ä»»ä½•å…³ç³»</strong>ï¼Œå‡½æ•°é‡è½½çš„ä¸»è¦åŸå› å°±æ˜¯ï¼šè™½ç„¶çœ‹èµ·æ¥å‡½æ•°åç›¸åŒä½†æœ€ç»ˆç”Ÿæˆçš„ç¬¦å·æ˜¯ä¸åŒçš„ã€‚å› ä¸ºç¬¦å·æ˜¯å‡½æ•°å+å½¢å‚åˆ—è¡¨ã€‚</li></ul><p>ç¨‹åº1</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">compare</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;compare_int_int&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="keyword">return</span> a &gt; b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">compare</span><span class="params">(<span class="type">double</span> a, <span class="type">double</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;compare_double_double&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="keyword">return</span> a &gt; b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">compare</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* a, <span class="type">const</span> <span class="type">char</span>* b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;compare_const char*_const char*&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">strcmp</span>(a, b) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">compare</span>(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line"><span class="built_in">compare</span>(<span class="number">10.0</span>, <span class="number">20.0</span>);</span><br><span class="line"><span class="built_in">compare</span>(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compare_int_int</span><br><span class="line">compare_double_double</span><br><span class="line">compare_const char*_const char*</span><br></pre></td></tr></table></figure><p>ç¨‹åº2ï¼šä¸åŒä½œç”¨åŸŸ</p><p><strong>åœ¨Cå’ŒC++é‡Œé¢ï¼Œåœ¨å‡½æ•°é‡Œé¢å†å®šä¹‰ä¸€ä¸ªå‡½æ•°æ˜¯ä¸è¡Œçš„ï¼Œä½†æ˜¯å£°æ˜ä¸€ä¸ªå‡½æ•°æ˜¯å¯ä»¥çš„ã€‚</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">compare</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;compare_int_int&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="keyword">return</span> a &gt; b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">compare</span><span class="params">(<span class="type">double</span> a, <span class="type">double</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;compare_double_double&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="keyword">return</span> a &gt; b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">compare</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* a, <span class="type">const</span> <span class="type">char</span>* b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;compare_const char*_const char*&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">strcmp</span>(a, b) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   <span class="function"><span class="type">bool</span> <span class="title">compare</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"><span class="built_in">compare</span>(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line"><span class="built_in">compare</span>(<span class="number">10.0</span>, <span class="number">20.0</span>);</span><br><span class="line"><span class="built_in">compare</span>(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2420E:\CPP\996.cpp[Error] invalid conversion from <span class="string">&#x27;const char*&#x27;</span> to <span class="string">&#x27;int&#x27;</span> [-fpermissive]</span><br></pre></td></tr></table></figure><p>åˆ†æï¼šåœ¨Cè¯­è¨€å’ŒC++ä¸­ï¼Œéƒ½æ˜¯åˆ†ä½œç”¨åŸŸçš„ã€‚åœ¨å‡½æ•°é‡Œé¢ä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªå’Œå…¨å±€å˜é‡åŒåçš„å±€éƒ¨å˜é‡ï¼Œä½œç”¨åŸŸä¸åŒ æ˜¯å¯ä»¥å®šä¹‰åŒåå˜é‡ã€‚<strong>åœ¨ä½¿ç”¨è¿™ä¸ªå˜é‡çš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆä½¿ç”¨åœ¨å½“å‰æœ€è¿‘çš„ä½œç”¨åŸŸä¸‹æ‰¾è¿™ä¸ªå˜é‡ã€‚</strong></p><p>ç¨‹åº3ï¼šå½“ç»™å‚æ•°åŠ ä¸Šconstæˆ–è€…volatile</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">func</span><span class="params">(<span class="type">int</span> a)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">func</span><span class="params">(<span class="type">const</span> <span class="type">int</span> a)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">cout&lt;&lt;<span class="built_in">fun</span>(<span class="number">1</span>); </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">65E:\CPP\996.cpp[Error] redefinition of <span class="string">&#x27;int func(int)&#x27;</span></span><br></pre></td></tr></table></figure><p>å¯¹äºç¼–è¯‘å™¨è€Œè¨€ï¼Œä¸¤ä¸ªfuncçš„å½¢å‚ç±»å‹éƒ½æ˜¯intã€‚ç›¸å½“äºå‡½æ•°é‡å®šä¹‰äº†</p><blockquote><p>**è¡¥å……ï¼š**C++å’ŒCè¯­è¨€ä»£ç ä¹‹é—´å¦‚ä½•ç›¸äº’è°ƒç”¨ï¼Ÿ</p></blockquote><p>åœ¨è¯´è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ä¸‹ä¸¤è€…ä¹‹é—´çš„å·®å¼‚ã€‚</p><p>æœ€å¤§çš„å·®å¼‚æ˜¯C++æ”¯æŒå‡½æ•°é‡è½½ï¼Œè€ŒCè¯­è¨€ä¸æ”¯æŒã€‚ä¸ºäº†ä½¿å‡½æ•°æ”¯æŒé‡è½½ï¼ŒC++åœ¨Cè¯­è¨€çš„åŸºç¡€ä¸Šï¼Œå°†å‡½æ•°åæ·»åŠ ä¸Šè¿”å›å€¼å’Œå‚æ•°çš„ç±»å‹ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œint add(int, int)è¿™ä¸ªå‡½æ•°ï¼Œé€šè¿‡C++ç¼–è¯‘å™¨ç¼–è¯‘åï¼Œå¯èƒ½å‘ˆç°çš„å‡½æ•°åä¸ºint int_add_int_int(int, int)ã€‚å› æ­¤è°ƒç”¨è¿‡ç¨‹åœ¨é“¾æ¥é˜¶æ®µå¯èƒ½ä¼šå‡ºç°é”™è¯¯ã€‚</p><blockquote><p><strong>Cè°ƒç”¨C++</strong></p></blockquote><ol><li>å°†å‡½æ•°ç”¨extern &quot;C&quot;å£°æ˜ã€‚</li><li>Cä»£ç ä¸­ä¸è¦include C++çš„å¤´æ–‡ä»¶, è€Œé‡‡ç”¨ç›´æ¥åœ¨Cä¸­å¢åŠ å‡½æ•°å£°æ˜çš„æ–¹å¼ã€‚</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*C++ code*/</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// your code</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*C code*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">int</span>)</span></span>;  <span class="comment">// ä¸å¼•å…¥, è€Œåªæ˜¯ç›´æ¥å£°æ˜</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cc</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">f</span>(i);  <span class="comment">//è°ƒç”¨</span></span><br><span class="line"><span class="comment">// other code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>C++è°ƒç”¨C</strong></p></blockquote><p>cfun.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --------------cfun.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __C_FUN_20180228_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __C_FUN_20180228_H__</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// __cplusplus</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfun</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>#ifdef __cplusplusï¼Œ è¡¨ç¤ºå¦‚æœæ˜¯C++æ¥è°ƒç”¨è¯¥æ¥å£ï¼Œåˆ™è¯¥å‡½æ•°æ¥å£ç»ç¼–è¯‘åçš„å‡½æ•°ç¬¦å·ç”Ÿæˆè§„åˆ™æŒ‰ç…§Cé£æ ¼èµ°, å¦åˆ™æ²¡æœ‰extern â€œCâ€ ï¼Œ è¿™æ ·æä¾›çš„æ¥å£åŒæ—¶æ”¯æŒCå’ŒC++ä¸¤è€…çš„è°ƒç”¨ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --------------cfun.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cfun.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfun</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;hello world.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --------------main.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cfun.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">cfun</span>();</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="constä¿®é¥°">constä¿®é¥°</h2><h3 id="ä»‹ç»">ä»‹ç»</h3><blockquote><p><strong>constæ˜¯ä»€ä¹ˆï¼Ÿ</strong></p></blockquote><p>constä¿®é¥°çš„å˜é‡ä¸èƒ½å†ä½œä¸ºä½æ²»ï¼Œåˆå§‹åŒ–å®Œæˆï¼Œå€¼ä¸èƒ½ä¿®æ”¹ï¼</p><blockquote><p><strong>conståœ¨Cå’ŒC++ä¸­çš„åŒºåˆ«ï¼Ÿ</strong></p></blockquote><ol><li><p>åˆå§‹åŒ–</p><ul><li>C++ä¸­çš„constï¼Œå¿…é¡»åˆå§‹åŒ–</li></ul></li><li><p>ç¼–è¯‘æ–¹å¼ä¸ä¸€æ ·ï¼š</p><ul><li>Cä¸­ï¼Œconstå°±æ˜¯å½“ä½œä¸€ä¸ªå˜é‡[å¸¸å˜é‡]æ¥ç¼–è¯‘ç”ŸæˆæŒ‡ä»¤</li></ul></li></ol><ul><li>C++ä¸­ï¼Œæ‰€æœ‰å‡ºç°constå¸¸é‡åå­—çš„åœ°æ–¹ï¼Œéƒ½ä¼šå¸¸é‡çš„åˆå§‹å€¼ä»£æ›¿</li></ul><h3 id="constå’Œä¸€çº§æŒ‡é’ˆ">constå’Œä¸€çº§æŒ‡é’ˆ</h3><h3 id="constå’ŒäºŒçº§æŒ‡é’ˆ">constå’ŒäºŒçº§æŒ‡é’ˆ</h3><h1>é¢å‘å¯¹è±¡</h1><h1>æ¨¡æ¿ç¼–ç¨‹</h1><h1>è¿ç®—ç¬¦é‡è½½</h1><h1>ç»§æ‰¿ä¸å¤šæ€</h1><h1>STLåº“</h1>]]></content>
      
      
      <categories>
          
          <category> Cpp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cpp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é™æ€é“¾æ¥&amp;&amp;åŠ¨æ€é“¾æ¥</title>
      <link href="/posts/4551c130.html"/>
      <url>/posts/4551c130.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ç¨‹åºçŒ¿åœ¨ç¼–ç¨‹çš„ä»£ç æ— éæ˜¯ç”±å‡½æ•°å’Œå„ç§å˜é‡ï¼Œä»¥åŠå¯¹è¿™äº›å˜é‡çš„è¯»ã€å†™ã€‚ä¸ç®¡æ˜¯å˜é‡è¿˜æ˜¯å‡½æ•°ï¼Œå®ƒä»¬æœ€ç»ˆéƒ½è¦å­˜å‚¨åœ¨å†…å­˜é‡Œã€‚ä¸ºæ¯ä¸ªå˜é‡å’Œå‡½æ•°æ­£ç¡®åœ°åˆ†é…å†…å­˜ç©ºé—´ï¼Œè®°å½•å®ƒä»¬çš„åœ°å€ï¼Œå¹¶æŠŠè¿™ä¸ªåœ°å€å¤å†™å›è°ƒç”¨æˆ–å¼•ç”¨å®ƒä»¬çš„åœ°æ–¹ã€‚</p><p>è€Œè´Ÿè´£<strong>å°†è¿™äº›ç¬¦å·è½¬æ¢æˆåœ°å€å°±æ˜¯ç”±é“¾æ¥å™¨</strong>å®Œæˆçš„ ~~~</p><p>é€šå¸¸åˆ†æˆ3ç§æƒ…å†µï¼š</p><p><strong>é™æ€é“¾æ¥</strong>ï¼š</p><ul><li>ç”ŸæˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ä¸­ã€‚</li></ul><p><strong>åŠ¨æ€é“¾æ¥</strong>ï¼š</p><ul><li>åœ¨äºŒè¿›åˆ¶æ–‡ä»¶è¢«åŠ è½½è¿›å†…å­˜æ—¶ã€‚åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¿ç•™ç¬¦å·ï¼Œåœ¨åŠ è½½æ—¶å†æŠŠç¬¦å·è§£ææˆçœŸå®çš„å†…å­˜åœ°å€</li><li>åœ¨è¿è¡ŒæœŸé—´è§£æç¬¦å·ã€‚è¿™ç§æƒ…å†µä¼šæŠŠç¬¦å·çš„è§£æå»¶è¿Ÿåˆ°æœ€åä¸å¾—ä¸åšæ—¶æ‰å»åšç¬¦å·çš„è§£æ</li></ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»è¿™2ç§é“¾æ¥çš„å…·ä½“å·¥ä½œåŸç†ã€‚</p><h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h2><p>è¿™éƒ¨åˆ†ä¸»è¦è®°å½•ELFæ–‡ä»¶æ ¼å¼ï¼Œå·²ç»ä¼šçš„å¯ä»¥ç›´æ¥è·³åˆ°é“¾æ¥éƒ¨åˆ†ã€‚</p><p><strong>ELFï¼šå¯æ‰§è¡Œå’Œé“¾æ¥æ ¼å¼</strong></p><p>ELFæ ¼å¼æ–‡ä»¶ä¸ä»…ç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿˜å¯ä»¥å­˜å‚¨å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ã€åŠ¨æ€åº“æ–‡ä»¶ç­‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒELFæ–‡ä»¶æ—¢è¦æ‰¿è½½ç¼–è¯‘çš„è¾“å‡º(å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶)ï¼Œåˆè¦æ‰¿è½½é“¾æ¥çš„è¾“å‡º(å¯æ‰§è¡Œæ–‡ä»¶)ï¼Œå› æ­¤å…¶æ–‡ä»¶æ ¼å¼éœ€è¦åŒæ—¶æ»¡è¶³è¿™ä¸¤ä¸ªåŠŸèƒ½ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240416143913414.png" alt="image-20240416143913414"></p><h3 id="å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶æ ¼å¼">å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶æ ¼å¼</h3><p><strong>å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶æ ¼å¼</strong></p><p>å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸»è¦åŒ…å«ä»£ç éƒ¨åˆ†å’Œæ•°æ®éƒ¨åˆ†ï¼Œå®ƒå¯ä»¥ä¸å…¶ä»–å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶é“¾æ¥ï¼Œä»è€Œåˆ›å»ºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ã€å…±äº«åº“æ–‡ä»¶ã€‚</p><ul><li><p>å¯è¢«é“¾æ¥ï¼ˆåˆå¹¶ï¼‰ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«ç›®æ ‡æ–‡ä»¶ï¼›</p></li><li><p>é™æ€é“¾æ¥åº“æ–‡ä»¶ç”±è‹¥å¹²ä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ç»„æˆï¼›</p></li><li><p>åŒ…å«ä»£ç ã€æ•°æ®ï¼ˆå·²åˆå§‹åŒ–å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡.dataå’Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡.bssï¼‰</p></li><li><p>åŒ…å«é‡å®šä½ä¿¡æ¯ï¼ˆæŒ‡å‡ºå“ªäº›ç¬¦å·å¼•ç”¨å¤„éœ€è¦é‡å®šä½ï¼‰</p></li><li><p>æ–‡ä»¶æ‰©å±•åä¸º.oï¼ˆç›¸å½“äºWindowsä¸­çš„ .objæ–‡ä»¶ï¼‰</p><p>æ ¼å¼å¦‚ä¸‹ï¼šç”±ELFå¤´ï¼ŒèŠ‚ï¼ŒèŠ‚å¤´è¡¨ç»„æˆã€‚</p></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240415162724175.png" alt=""></p><p><strong>ï¼ˆ1ï¼‰ELFå¤´</strong></p><p>readelf -h å‘½ä»¤å¯¹æŸä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„ ELF å¤´è¿›è¡Œè§£æ</p><p>æµ…æµ…æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp î‚° readelf -h main.o</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              REL (Relocatable file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x0</span></span><br><span class="line"><span class="string">  Start of program headers:          0 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          848 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           0 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         0</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         13</span></span><br><span class="line"><span class="string">  Section header string table index: 12</span></span><br></pre></td></tr></table></figure><p><strong>ELF å¤´</strong>ä½äºç›®æ ‡æ–‡ä»¶çš„èµ·å§‹ä½ç½®ï¼ŒåŒ…å«æ–‡ä»¶ç»“æ„è¯´æ˜ä¿¡æ¯ã€‚åˆ†32ä½ç‰ˆæœ¬å’Œ64ä½ç‰ˆæœ¬ã€‚</p><p>32ä½ç³»ç»Ÿå¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œå…±å  52ï¼ˆ0x34ï¼‰ å­—èŠ‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">char</span> e_ident[EI_NIDENT]; <span class="comment">// å¼€å§‹çš„å››ä¸ªå­—èŠ‚æ˜¯é­”æ•°ï¼Œåé¢çš„16ä¸ªå­—èŠ‚åŒ…å«ä¸€äº›æ ‡è¯†ä¿¡æ¯ï¼Œå¦‚å­—èŠ‚åºã€32/64ä½ã€ç‰ˆæœ¬å·ç­‰</span></span><br><span class="line">   Elf32_Half e_type;      <span class="comment">// ç›®æ ‡æ–‡ä»¶ç±»å‹ï¼ˆå¯é‡å®šä½æ–‡ä»¶ã€å¯æ‰§è¡Œæ–‡ä»¶ã€å…±äº«åº“æ–‡ä»¶è¿˜æ˜¯å…¶ä»–ç±»å‹æ–‡ä»¶ï¼‰</span></span><br><span class="line">   Elf32_Half e_machine;   <span class="comment">// æœºå™¨ç»“æ„ç±»å‹ï¼ˆå¦‚ IA-32ã€AMD 64ç­‰ï¼‰</span></span><br><span class="line">   Elf32_Word e_version;   <span class="comment">// ç›®æ ‡æ–‡ä»¶ç‰ˆæœ¬</span></span><br><span class="line">   Elf32_Addr e_entry;     <span class="comment">// æŒ‡å®šç³»ç»Ÿå°†æ§åˆ¶æƒè½¬ç§»åˆ°çš„èµ·å§‹è™šæ‹Ÿåœ°å€ï¼ˆç¨‹åºå…¥å£ç‚¹ï¼‰ï¼Œå¦‚æœæ²¡æœ‰å…³è”å…¥å£ç‚¹åˆ™ä¸º0ï¼Œæ¯”å¦‚å¯é‡å®šä½æ–‡ä»¶å°±æ˜¯0</span></span><br><span class="line">   Elf32_Off e_phoff;</span><br><span class="line">   Elf32_Off e_shoff;      <span class="comment">// èŠ‚å¤´è¡¨åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span></span><br><span class="line">   Elf32_Word e_flags;</span><br><span class="line">   Elf32_Half e_ehsize;    <span class="comment">// ELF å¤´çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span></span><br><span class="line">   Elf32_Half e_phentsize; </span><br><span class="line">   Elf32_Half e_phnum;</span><br><span class="line">   Elf32_Half e_shentsize; <span class="comment">// èŠ‚å¤´è¡¨ä¸­ä¸€ä¸ªè¡¨é¡¹çš„å¤§å°ï¼Œæ‰€æœ‰è¡¨é¡¹å¤§å°ç›¸åŒ</span></span><br><span class="line">   Elf32_Half e_shnum;     <span class="comment">// èŠ‚å¤´è¡¨é¡¹çš„ä¸ªæ•°</span></span><br><span class="line">   Elf32_Half e_shstrndx;</span><br><span class="line">&#125; Elf32_Ehdr;</span><br></pre></td></tr></table></figure><ul><li><p>é­”æ•°ï¼šæ–‡ä»¶å¼€å¤´å‡ ä¸ªå­—èŠ‚é€šå¸¸ç”¨æ¥ç¡®å®šæ–‡ä»¶çš„ç±»å‹æˆ–æ ¼å¼ã€‚</p><ul><li>a.outçš„é­”æ•°ï¼š01H 07H</li><li>PEæ ¼å¼é­”æ•°ï¼š4DH 5AH</li><li>åŠ è½½æˆ–è¯»å–æ–‡ä»¶æ—¶ï¼Œå¯ç”¨é­”æ•°ç¡®è®¤æ–‡ä»¶ç±»å‹æ˜¯å¦æ­£ç¡®</li></ul></li><li><p>ä»… ELF å¤´åœ¨æ–‡ä»¶ä¸­å…·æœ‰å›ºå®šä½ç½®ï¼Œå³æ€»æ˜¯åœ¨å¼€å¤´ä½ç½®ï¼Œå…¶ä½™éƒ¨åˆ†çš„ä½ç½®ç”± ELF å¤´å’ŒèŠ‚å¤´è¡¨æŒ‡å‡ºã€‚</p></li><li><p>å› ä¸ºæ˜¯å¯é‡å®šä½æ–‡ä»¶ï¼Œ<strong>æ‰€ä»¥å­—æ®µ e_entry ä¸º0ï¼Œæ— ç¨‹åºå¤´è¡¨</strong>ï¼ˆSize of program headers = 0ï¼‰ã€‚</p></li></ul><p><strong>ï¼ˆ2ï¼‰èŠ‚</strong></p><p>èŠ‚æ˜¯ ELF æ–‡ä»¶ä¸­çš„ä¸»ä½“ä¿¡æ¯ï¼ŒåŒ…å«äº†é“¾æ¥è¿‡ç¨‹æ‰€ç”¨çš„ç›®æ ‡ä»£ç ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒ‡ä»¤ã€æ•°æ®ã€ç¬¦å·è¡¨å’Œé‡å®šä½ä¿¡æ¯ç­‰ã€‚</p><table><thead><tr><th style="text-align:center">èŠ‚å</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">.text</td><td style="text-align:left">å·²ç¼–è¯‘ç¨‹åºçš„æœºå™¨ä»£ç </td></tr><tr><td style="text-align:center">.rodata</td><td style="text-align:left">åªè¯»æ•°æ®ï¼Œå¦‚ printf è¯­å¥ä¸­çš„æ ¼å¼ä¸²ã€å¼€å…³è¯­å¥ï¼ˆswitch-caseï¼‰çš„è·³è½¬è¡¨ç­‰</td></tr><tr><td style="text-align:center">.data</td><td style="text-align:left">å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡</td></tr><tr><td style="text-align:center">.bss</td><td style="text-align:left">æœªåˆå§‹åŒ–çš„å…¨å±€å’Œé™æ€å˜é‡ï¼Œä»¥åŠæ‰€æœ‰è¢«åˆå§‹åŒ–ä¸º 0 çš„å…¨å±€æˆ–é™æ€å˜é‡ã€‚<strong>åœ¨ç›®æ ‡æ–‡ä»¶ä¸­è¿™ä¸ªèŠ‚ä¸å æ®å®é™…çš„ç©ºé—´</strong>ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œä¸ºäº†èŠ‚çœç©ºé—´ã€‚åœ¨è¿è¡Œæ—¶ï¼Œåœ¨å†…å­˜ä¸­å°†è¿™äº›å˜é‡åˆå§‹åŒ–ä¸º 0ã€‚</td></tr><tr><td style="text-align:center">.symtab</td><td style="text-align:left">ç¬¦å·è¡¨ï¼ˆsymbol tableï¼‰,ç¨‹åºä¸­å®šä¹‰çš„å‡½æ•°åå’Œå…¨å±€é™æ€å˜é‡åéƒ½å±äº<strong>ç¬¦å·</strong>ï¼Œä¸è¿™äº›ç¬¦å·ç›¸å…³çš„ä¿¡æ¯ä¿å­˜åœ¨ç¬¦å·è¡¨ä¸­ã€‚æ¯ä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª .symtab èŠ‚ã€‚å’Œç¼–è¯‘å™¨ä¸­çš„ç¬¦å·è¡¨ä¸åŒï¼Œ .symtab ç¬¦å·è¡¨ä¸åŒ…å«å±€éƒ¨å˜é‡çš„æ¡ç›®ã€‚</td></tr><tr><td style="text-align:center">.rel.text</td><td style="text-align:left">.text èŠ‚ç›¸å…³çš„é‡å®šä½ä¿¡æ¯ã€‚å½“é“¾æ¥å™¨åˆå¹¶ç›®æ ‡æ–‡ä»¶æ—¶ï¼Œ.text ä¸­çš„ä»£ç åˆå¹¶åéƒ¨åˆ†ä½ç½®çš„æ•°æ®éœ€è¦ä¿®æ”¹ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä»»ä½•è°ƒç”¨å¤–éƒ¨å‡½æ•°æˆ–è€…å¼•ç”¨å…¨å±€å˜é‡çš„æŒ‡ä»¤éƒ½éœ€è¦ä¿®æ”¹å®šä½ä¿¡æ¯ã€‚å¦ä¸€æ–¹é¢ï¼Œè°ƒç”¨æœ¬åœ°å‡½æ•°çš„æŒ‡ä»¤åˆ™ä¸éœ€è¦ä¿®æ”¹ã€‚ TIPï¼šå¯æ‰§è¡Œæ–‡ä»¶ä¸­å¹¶ä¸éœ€è¦é‡å®šä½ä¿¡æ¯ã€‚</td></tr><tr><td style="text-align:center">.rel.data</td><td style="text-align:left">.data èŠ‚ç›¸å…³çš„å¯é‡å®šä½ä¿¡æ¯ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä»»ä½•å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œå¦‚æœå®ƒçš„åˆå§‹å€¼æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡åœ°å€æˆ–è€…å¤–éƒ¨å®šä¹‰å‡½æ•°çš„åœ°å€ï¼Œéƒ½éœ€è¦è¢«ä¿®æ”¹ã€‚</td></tr><tr><td style="text-align:center">.debug</td><td style="text-align:left">è°ƒè¯•ç”¨ç¬¦å·è¡¨ã€‚å…¶æ¡ç›®æ˜¯ç¨‹åºä¸­å®šä¹‰çš„å…¨å±€å˜é‡å’Œç±»å‹å®šä¹‰ï¼Œç¨‹åºä¸­å®šä¹‰å’Œå¼•ç”¨çš„å…¨å±€å˜é‡ï¼Œä»¥åŠåŸå§‹çš„ C æºæ–‡ä»¶ã€‚</td></tr><tr><td style="text-align:center">.line</td><td style="text-align:left">C æºç¨‹åºä¸­çš„è¡Œå·å’Œ .text èŠ‚ä¸­æœºå™¨æŒ‡ä»¤ä¹‹é—´çš„æ˜ å°„ã€‚</td></tr><tr><td style="text-align:center">.strtab</td><td style="text-align:left">å­—ç¬¦ä¸²è¡¨ã€‚åŒ…æ‹¬ .symtab èŠ‚å’Œ .debug èŠ‚ä¸­çš„ç¬¦å·ä»¥åŠèŠ‚å¤´è¡¨ä¸­çš„èŠ‚åã€‚å­—ç¬¦ä¸²è¡¨å°±æ˜¯ä»¥ null ç»“å°¾çš„å­—ç¬¦åºåˆ—ã€‚</td></tr></tbody></table><p><strong>ï¼ˆ3ï¼‰èŠ‚å¤´è¡¨</strong></p><p>èŠ‚å¤´è¡¨ï¼ˆSection Header Tableï¼‰ç”±è‹¥å¹²è¡¨é¡¹ç»„æˆï¼Œæ¯ä¸ªè¡¨é¡¹æè¿°ç›¸åº”çš„ä¸€ä¸ªèŠ‚çš„èŠ‚åã€åœ¨æ–‡ä»¶ä¸­çš„åç§»ã€å¤§å°ã€è®¿é—®å±æ€§ã€å¯¹é½æ–¹å¼ç­‰ï¼Œç›®æ ‡æ–‡ä»¶ä¸­çš„æ¯ä¸ªèŠ‚éƒ½æœ‰ä¸€ä¸ªè¡¨é¡¹ä¸ä¹‹å¯¹åº”ã€‚</p><ul><li>é™¤ELFå¤´ä¹‹å¤–ï¼ŒèŠ‚å¤´è¡¨æ˜¯ELFå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸­æœ€é‡è¦çš„éƒ¨åˆ†å†…å®¹ã€‚</li></ul><p>ä»¥ä¸‹æ˜¯ 32 ä½ç³»ç»Ÿå¯¹åº”çš„æ•°æ®ç»“æ„ï¼ˆæ¯ä¸ªè¡¨é¡¹å 40Bï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">   Elf32_Word sh_name;  <span class="comment">// èŠ‚åå­—ç¬¦ä¸²åœ¨.strtabä¸­çš„åç§»</span></span><br><span class="line">   Elf32_Word sh_type;  <span class="comment">// èŠ‚ç±»å‹ï¼šæ— æ•ˆ/ä»£ç æˆ–æ•°æ®/ç¬¦å·/å­—ç¬¦ä¸²/â€¦</span></span><br><span class="line">   Elf32_Word sh_flags; <span class="comment">// èŠ‚æ ‡å¿—ï¼šè¯¥èŠ‚åœ¨è™šæ‹Ÿç©ºé—´ä¸­çš„è®¿é—®å±æ€§</span></span><br><span class="line">   Elf32_Addr sh_addr;  <span class="comment">// è™šæ‹Ÿåœ°å€ï¼šè‹¥å¯è¢«åŠ è½½ï¼Œåˆ™å¯¹åº”è™šæ‹Ÿåœ°å€</span></span><br><span class="line">   Elf32_Off sh_offset; <span class="comment">// åœ¨æ–‡ä»¶ä¸­çš„åç§»åœ°å€ï¼Œå¯¹.bssèŠ‚è€Œè¨€åˆ™æ— æ„ä¹‰</span></span><br><span class="line">   Elf32_Word sh_size;  <span class="comment">// èŠ‚åœ¨æ–‡ä»¶ä¸­æ‰€å çš„é•¿åº¦</span></span><br><span class="line">   Elf32_Word sh_link;  <span class="comment">// sh_linkå’Œsh_infoç”¨äºä¸é“¾æ¥ç›¸å…³çš„èŠ‚ï¼ˆå¦‚.rel.textèŠ‚ã€.rel.dataèŠ‚ã€.symtabèŠ‚ç­‰ï¼‰</span></span><br><span class="line">   Elf32_Word sh_info;</span><br><span class="line">   Elf32_Word sh_addralign;   <span class="comment">// èŠ‚çš„å¯¹é½è¦æ±‚</span></span><br><span class="line">   Elf32_Word sh_entsize;     <span class="comment">// èŠ‚ä¸­æ¯ä¸ªè¡¨é¡¹çš„é•¿åº¦ï¼Œ0è¡¨ç¤ºæ— å›ºå®šé•¿åº¦è¡¨é¡¹</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>æ¯”è¾ƒç‰¹æ®Šçš„ä¸€ä¸ªåœ°æ–¹ï¼š.bss åœ¨æ–‡ä»¶ä¸­ä¸å ç”¨ç©ºé—´ï¼Œä½†èŠ‚å¤´è¡¨è®°å½•äº† .bss èŠ‚çš„é•¿åº¦ä¸º 0x0c = 12ï¼Œå› æ­¤éœ€è¦åœ¨ä¸»å­˜ä¸­ç»™ .bss èŠ‚åˆ†é… 12 å­—èŠ‚ç©ºé—´ã€‚</li></ul><p><strong>æ•´ä½“å°±æ˜¯é€šè¿‡ ELF å¤´è¿æ¥äº†èŠ‚å¤´è¡¨ï¼Œå†é€šè¿‡èŠ‚å¤´è¡¨æŠŠæ¯ä¸€ä¸ªèŠ‚è¿æ¥èµ·æ¥äº†ã€‚</strong></p><h3 id="å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶æ ¼å¼">å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶æ ¼å¼</h3><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240415164614632.png" alt="image-20240415164614632"></p><p>ä¸å¯é‡å®šæ–‡ä»¶ç¨æœ‰ä¸åŒï¼š</p><ul><li>ELFå¤´ä¸­å­—æ®µ e_entry ç»™å‡ºæ‰§è¡Œç¨‹åºæ—¶ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œè€Œåœ¨å¯é‡å®šä½æ–‡ä»¶ä¸­ï¼Œæ­¤å­—æ®µä¸º0ï¼›</li><li>å¤šä¸€ä¸ª<strong>ç¨‹åºå¤´è¡¨</strong>ï¼Œä¹Ÿç§°æ®µå¤´è¡¨ï¼ˆsegment header tableï¼‰ï¼Œæ˜¯ä¸€ä¸ªç»“æ„æ•°ç»„ï¼Œç”¨æ¥è¯´æ˜æ®µä¿¡æ¯ï¼›</li><li>å¤šä¸€ä¸ª.initèŠ‚ï¼Œç”¨äºå®šä¹‰_initå‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨æ¥è¿›è¡Œå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶å¼€å§‹æ‰§è¡Œæ—¶çš„åˆå§‹åŒ–å·¥ä½œï¼›</li><li>å°‘ä¸¤ä¸ª.relèŠ‚ï¼ˆæ— éœ€é‡å®šä½ï¼‰ã€‚</li></ul><p>åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ŒELF å¤´ã€ç¨‹åºå¤´è¡¨ã€.init èŠ‚ã€.fini èŠ‚ã€.text èŠ‚å’Œ .rodata èŠ‚åˆèµ·æ¥å¯æ„æˆä¸€ä¸ª<strong>åªè¯»ä»£ç æ®µ</strong>ï¼›.data èŠ‚å’Œ .bss èŠ‚åˆèµ·æ¥å¯æ„æˆä¸€ä¸ª<strong>å¯è¯»å†™æ•°æ®æ®µ</strong>ã€‚æ˜¾ç„¶ï¼Œåœ¨å¯æ‰§è¡Œæ–‡ä»¶å¯åŠ¨æ‰§è¡Œæ—¶ï¼Œè¿™ä¸¤ä¸ªæ®µå¿…é¡»è£…å…¥å†…å­˜ï¼Œå› è€Œç§°ä¸º<strong>å¯è£…å…¥æ®µ</strong>ã€‚</p><h2 id="é™æ€é“¾æ¥">é™æ€é“¾æ¥</h2><h3 id="è®¤çŸ¥">è®¤çŸ¥</h3><p>å…ˆå¯¹é“¾æ¥å™¨çš„çš„ä¸¤æ­¥é“¾æ¥æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†ï¼š</p><p><strong>ç¬¬ä¸€æ­¥æ˜¯ï¼Œé“¾æ¥å™¨éœ€è¦å¯¹ç¼–è¯‘å™¨ç”Ÿæˆçš„å¤šä¸ªç›®æ ‡ï¼ˆ.o) æ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œé‡‡å–çš„ç­–ç•¥æ˜¯ç›¸ä¼¼æ®µçš„åˆå¹¶ï¼Œæœ€ç»ˆç”Ÿæˆå…±äº«æ–‡ä»¶ (.so) æˆ–è€…å¯æ‰§è¡Œæ–‡ä»¶</strong>ã€‚è¿™ä¸ªé˜¶æ®µä¸­ï¼Œé“¾æ¥å™¨å¯¹è¾“å…¥çš„å„ä¸ªç›®æ ‡æ–‡ä»¶è¿›è¡Œæ‰«æï¼Œè·å–å„ä¸ªæ®µçš„å¤§å°ï¼Œå¹¶ä¸”åŒæ—¶ä¼šæ”¶é›†æ‰€æœ‰çš„ç¬¦å·å®šä¹‰ä»¥åŠå¼•ç”¨ä¿¡æ¯ï¼Œæ„å»ºä¸€ä¸ªå…¨å±€çš„ç¬¦å·è¡¨ã€‚å½“é“¾æ¥å™¨æ„é€ å¥½äº†æœ€ç»ˆçš„æ–‡ä»¶å¸ƒå±€ä»¥åŠè™šæ‹Ÿå†…å­˜å¸ƒå±€åï¼Œæˆ‘ä»¬æ ¹æ®ç¬¦å·è¡¨ï¼Œä¹Ÿå°±èƒ½ç¡®å®šäº†æ¯ä¸ªç¬¦å·çš„è™šæ‹Ÿåœ°å€äº†ã€‚</p><p><strong>ç¬¬äºŒæ­¥æ˜¯ï¼Œé“¾æ¥å™¨ä¼šå¯¹æ•´ä¸ªæ–‡ä»¶å†è¿›è¡Œç¬¬äºŒéæ‰«æï¼Œè¿™ä¸€é˜¶æ®µï¼Œä¼šåˆ©ç”¨ç¬¬ä¸€éæ‰«æå¾—åˆ°çš„ç¬¦å·è¡¨ä¿¡æ¯ï¼Œä¾æ¬¡å¯¹æ–‡ä»¶ä¸­æ¯ä¸ªç¬¦å·å¼•ç”¨çš„åœ°æ–¹è¿›è¡Œåœ°å€æ›¿æ¢ã€‚ä¹Ÿå°±æ˜¯å¯¹ç¬¦å·çš„è§£æä»¥åŠé‡å®šä½è¿‡ç¨‹</strong>ã€‚</p><p>ç®€å•æ¥è®²å°±æ˜¯è¿›è¡Œä¸¤éæ‰«æï¼šç¬¬ä¸€éæ‰«æå®Œæˆæ–‡ä»¶åˆå¹¶ã€è™šæ‹Ÿå†…å­˜å¸ƒå±€çš„åˆ†é…ä»¥åŠç¬¦å·ä¿¡æ¯æ”¶é›†ï¼›ç¬¬äºŒéæ‰«æåˆ™æ˜¯å®Œæˆäº†ç¬¦å·çš„é‡å®šä½è¿‡ç¨‹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°†åˆ†ç±»è®¨è®ºå„ç§ç¬¦å·çš„å¤„ç†æ–¹å¼ã€‚</p><p>åœ¨å®æ“ä¹‹å‰ï¼Œå…ˆè¯´<strong>æ€»ç»“</strong>ï¼š</p><ol><li>é™æ€å‡½æ•°ä¸éœ€è¦é‡å®šä½å› ä¸ºå’Œæ‰§è¡Œå•å…ƒä»£ç éƒ½åœ¨.textæ®µï¼Œç›¸å¯¹ä½ç½®åœ¨ç¼–è¯‘çš„æ—¶å€™å°±èƒ½ç¡®å®šäº†ï¼Œå› ä¸ºé“¾æ¥å™¨åˆå¹¶ä¸­é—´æ–‡ä»¶æ—¶ç›¸å¯¹ä½ç½®ä¸ä¼šå˜ã€‚</li><li>é™æ€å˜é‡éœ€è¦é‡å®šä½ï¼Œå› ä¸ºå’Œç¼–è¯‘å•å…ƒä»£ç æ®µ.textåˆ†å±ä¸åŒçš„sectionï¼Œåœ¨.dataï¼Œé“¾æ¥å™¨åˆå¹¶æ–‡ä»¶æ—¶ä¼šé‡æ–°æ’å¸ƒï¼Œæ‰€ä»¥éœ€è¦é‡å®šä½ã€‚</li><li>å…¨å±€å˜é‡/å‡½æ•°ï¼Œå¤–éƒ¨å˜é‡/å‡½æ•°éƒ½æ˜¯éœ€è¦è¢«é‡å®šä½çš„ï¼Œå¤§è‡´æ–¹æ³•å°±æ˜¯ï¼šç¼–è¯‘å™¨å…ˆç”¨0å ä½ç¬¦å·ã€é“¾æ¥é‡å®šä½è¡¨æ‰¾ç¬¦å·ã€å®šä½ç¬¦å·åœ°å€ã€ç„¶ååœ¨å½“å‰ä»£ç æ®µè®¡ç®—RIPç›¸å¯¹åç§»ä½ç½®å¡«ä¸Šã€‚</li></ol><h3 id="å®æ“">å®æ“</h3><p>å¼€å§‹å®æ“</p><p>å·¥å…·ï¼šreadelf æŸ¥çœ‹ elf æ–‡ä»¶ å’Œ objdump æŸ¥çœ‹åæ±‡ç¼–ã€‚</p><ul><li>objdumpï¼šå¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œåæ±‡ç¼–</li><li>readelf ï¼šè§£æäºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯</li></ul><p>ä¾‹å­ï¼š</p><p>example.c</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// example.c</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> extern_var;</span><br><span class="line"><span class="type">int</span> global_var = <span class="number">1</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> static_var = <span class="number">2</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="type">int</span> <span class="title">extern_func</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">global_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">static_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> var0 = extern_var;</span><br><span class="line">    <span class="type">int</span> var1 = global_var;</span><br><span class="line">    <span class="type">int</span> var2 = static_var;</span><br><span class="line">    <span class="type">int</span> var3 = <span class="built_in">extern_func</span>();</span><br><span class="line">    <span class="type">int</span> var4 = <span class="built_in">global_func</span>();</span><br><span class="line">    <span class="type">int</span> var5 = <span class="built_in">static_func</span>();</span><br><span class="line">    <span class="keyword">return</span> var0 + var1 + var2 + var3 + var4 + var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>external.c</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// external.c</span></span><br><span class="line"><span class="type">int</span> extern_var = <span class="number">3</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">extern_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">30</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âš™ penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° gcc example.c -c -o example.o -fno-PIC -g</span><br><span class="line">âš™ penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° gcc external.c -c -o external.o -fno-PIC -g</span><br><span class="line">âš™ penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° gcc external.o example.o -o a.out -no-pie</span><br></pre></td></tr></table></figure><ul><li>-fno-PIC ï¼šå‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦ç”Ÿæˆ PIC çš„ä»£ç ã€‚</li></ul><p>æˆ‘ä»¬å°†ä¸¤ä¸ª.o æ–‡ä»¶é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc external.o example.o -o a.out -no-pie</span><br></pre></td></tr></table></figure><ul><li>-no-pie è¡¨ç¤ºå…³é—­ pie çš„æ¨¡å¼ã€‚gcc ä¼šé»˜è®¤æ‰“å¼€ pie æ¨¡å¼ï¼Œä¹Ÿå°±æ„å‘³ç€ç³»ç»Ÿ loader å¯¹åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶æ—¶çš„èµ·å§‹åœ°å€ï¼Œä¼šéšæœºåŠ è½½ã€‚å…³é—­ pie ä¹‹åï¼Œåœ¨ Linux 64 ä½çš„ç³»ç»Ÿä¸‹ï¼Œé»˜è®¤çš„åŠ è½½èµ·å§‹åœ°å€æ˜¯ 0x400000ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° objdump -S example.o</span><br><span class="line"></span><br><span class="line">example.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;global_func&gt;:</span><br><span class="line">extern int extern_var;</span><br><span class="line">int global_var = 1;</span><br><span class="line">static int static_var = 2;</span><br><span class="line">extern int extern_func();</span><br><span class="line">int global_func()</span><br><span class="line">&#123;</span><br><span class="line">   0:f3 0f 1e fa          endbr64 </span><br><span class="line">   4:55                   push   %rbp</span><br><span class="line">   5:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">    return 10;</span><br><span class="line">   8:b8 0a 00 00 00       mov    $0xa,%eax</span><br><span class="line">&#125;</span><br><span class="line">   d:5d                   pop    %rbp</span><br><span class="line">   e:c3                   retq   </span><br><span class="line"></span><br><span class="line">000000000000000f &lt;static_func&gt;:</span><br><span class="line">static int static_func()</span><br><span class="line">&#123;</span><br><span class="line">   f:f3 0f 1e fa          endbr64 </span><br><span class="line">  13:55                   push   %rbp</span><br><span class="line">  14:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">    return 20;</span><br><span class="line">  17:b8 14 00 00 00       mov    $0x14,%eax</span><br><span class="line">&#125;</span><br><span class="line">  1c:5d                   pop    %rbp</span><br><span class="line">  1d:c3                   retq   </span><br><span class="line"></span><br><span class="line">000000000000001e &lt;main&gt;:</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">  1e:f3 0f 1e fa          endbr64 </span><br><span class="line">  22:55                   push   %rbp</span><br><span class="line">  23:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">  26:48 83 ec 20          sub    $0x20,%rsp</span><br><span class="line">    int var0 = extern_var;</span><br><span class="line">  2a:8b 05 00 00 00 00    mov    0x0(%rip),%eax        # 30 &lt;main+0x12&gt;</span><br><span class="line">  30:89 45 e8             mov    %eax,-0x18(%rbp)</span><br><span class="line">    int var1 = global_var;</span><br><span class="line">  33:8b 05 00 00 00 00    mov    0x0(%rip),%eax        # 39 &lt;main+0x1b&gt;</span><br><span class="line">  39:89 45 ec             mov    %eax,-0x14(%rbp)</span><br><span class="line">    int var2 = static_var;</span><br><span class="line">  3c:8b 05 00 00 00 00    mov    0x0(%rip),%eax        # 42 &lt;main+0x24&gt;</span><br><span class="line">  42:89 45 f0             mov    %eax,-0x10(%rbp)</span><br><span class="line">    int var3 = extern_func();</span><br><span class="line">  45:b8 00 00 00 00       mov    $0x0,%eax</span><br><span class="line">  4a:e8 00 00 00 00       callq  4f &lt;main+0x31&gt;</span><br><span class="line">  4f:89 45 f4             mov    %eax,-0xc(%rbp)</span><br><span class="line">    int var4 = global_func();</span><br><span class="line">  52:b8 00 00 00 00       mov    $0x0,%eax</span><br><span class="line">  57:e8 00 00 00 00       callq  5c &lt;main+0x3e&gt;</span><br><span class="line">  5c:89 45 f8             mov    %eax,-0x8(%rbp)</span><br><span class="line">    int var5 = static_func();</span><br><span class="line">  5f:b8 00 00 00 00       mov    $0x0,%eax</span><br><span class="line">  64:e8 a6 ff ff ff       callq  f &lt;static_func&gt;</span><br><span class="line">  69:89 45 fc             mov    %eax,-0x4(%rbp)</span><br><span class="line">    return var0 + var1 + var2 + var3 + var4 + var5;</span><br><span class="line">  6c:8b 55 e8             mov    -0x18(%rbp),%edx</span><br><span class="line">  6f:8b 45 ec             mov    -0x14(%rbp),%eax</span><br><span class="line">  72:01 c2                add    %eax,%edx</span><br><span class="line">  74:8b 45 f0             mov    -0x10(%rbp),%eax</span><br><span class="line">  77:01 c2                add    %eax,%edx</span><br><span class="line">  79:8b 45 f4             mov    -0xc(%rbp),%eax</span><br><span class="line">  7c:01 c2                add    %eax,%edx</span><br><span class="line">  7e:8b 45 f8             mov    -0x8(%rbp),%eax</span><br><span class="line">  81:01 c2                add    %eax,%edx</span><br><span class="line">  83:8b 45 fc             mov    -0x4(%rbp),%eax</span><br><span class="line">  86:01 d0                add    %edx,%eax</span><br><span class="line">&#125;</span><br><span class="line">  88:c9                   leaveq </span><br><span class="line">  89:c3                   retq</span><br></pre></td></tr></table></figure><p><strong>å„ç§ç¬¦å·çš„å¤„ç†æ–¹å¼</strong></p><p><strong>å±€éƒ¨å˜é‡</strong></p><p>ä»åæ±‡ç¼–çš„ç»“æœé‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå±€éƒ¨å˜é‡åœ¨ç¨‹åºä¸­çš„åœ°å€ï¼Œéƒ½æ˜¯åŸºäº %rbpçš„åç§»è¿™ç§å½¢å¼ï¼Œrbp å¯„å­˜å™¨å­˜æ”¾çš„æ˜¯å½“å‰å‡½æ•°æ ˆå¸§çš„åŸºåœ°å€ã€‚è¿™äº›å±€éƒ¨å˜é‡çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾ï¼Œéƒ½æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡ %rbp çš„æ”¹å˜æ¥è¿›è¡Œçš„ï¼Œå› æ­¤ï¼Œå±€éƒ¨å˜é‡çš„å†…å­˜åœ°å€ä¸éœ€è¦é“¾æ¥å™¨æ¥æ“å¿ƒã€‚</p><p><strong>é™æ€å‡½æ•°</strong></p><p>å®ƒæ˜¯å”¯ä¸€ä¸éœ€è¦é‡å®šä½çš„ç±»å‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> int var5 = static_func();</span><br><span class="line">5f:b8 00 00 00 00       mov    $0x0,%eax</span><br><span class="line">64:e8 a6 ff ff ff       callq  f &lt;static_func&gt;</span><br></pre></td></tr></table></figure><p>e8æ˜¯callqæŒ‡ä»¤çš„ç¼–ç ï¼Œåè¾¹ 4ä¸ªå­—èŠ‚å°±å¯¹åº”è¢«è°ƒå‡½æ•°çš„åœ°å€ã€‚</p><p>å¦‚æœé‡‡ç”¨å°ç«¯çš„å­—èŠ‚åºæ•°å€¼æ¥è¡¨ç¤º0x ff ff ff a6ä¹Ÿå°±æ˜¯å¯¹åº”åè¿›åˆ¶çš„-90ã€‚</p><p>æ­¤æ—¶ï¼Œå½“ CPUæ‰§è¡Œåˆ° callqè¿™æ¡æŒ‡ä»¤æ—¶ï¼Œrip å¯„å­˜å™¨çš„å€¼æŒ‡å‘çš„æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„å†…å­˜åœ°å€ï¼Œä¹Ÿå°±æ˜¯ 5dè¿™æ¡æŒ‡ä»¤çš„å†…å­˜åœ°å€ï¼Œé€šè¿‡è®¡ç®—0x69 â€“ 90å¯ä»¥å¾—åˆ° 0xfã€‚ä»åæ±‡ç¼–ä¸­å¯ä»¥å¾—åˆ°ï¼Œ0xf åˆšå¥½æ˜¯ static_fun çš„åœ°å€ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240419135448453.png" alt="image-20240419135448453"></p><p>åŒä¸€ä¸ªç¼–è¯‘å•å…ƒå†…éƒ¨ï¼Œstatic_func ä¸ main å‡½æ•°çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šä¸å˜çš„ï¼Œå³ä¾¿é“¾æ¥çš„è¿‡ç¨‹ä¸­ä¼šå¯¹ä¸åŒ.o æ–‡ä»¶ä¸­çš„ä»£ç æ®µè¿›è¡Œåˆå¹¶ï¼Œä½†æ˜¯åŒä¸€ä¸ª.o æ–‡ä»¶å†…éƒ¨ä¸åŒå‡½æ•°ä¹‹é—´çš„ä½ç½®ä¹Ÿä¼šä¿æŒä¸å˜ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°±èƒ½ç¡®å®šå¯¹é™æ€å‡½æ•°è°ƒç”¨çš„åç§»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé™æ€å‡½æ•°çš„è°ƒç”¨åœ°å€åœ¨ç¼–è¯‘é˜¶æ®µå°±å¯ä»¥ç¡®å®šä¸‹æ¥ã€‚</p><p><strong>å¤–éƒ¨å˜é‡ï¼Œå…¨å±€å˜é‡ä»¥åŠé™æ€å˜é‡</strong></p><p>ä»åæ±‡ç¼–ç»“æœä¸­çœ‹åˆ°ï¼Œå‰ä¸‰æ¡è¯­å¥å¯¹ extern_varã€global_var å’Œ static_var çš„è®¿é—®ï¼Œéƒ½ç”Ÿæˆäº†ä¸€æ¡ mov 0x0(%rip)ï¼Œ%eax çš„æŒ‡ä»¤ã€‚è¿™æ˜¯å› ä¸ºåœ¨è¿™ä¸ªæ—¶å€™ï¼Œç¼–è¯‘å™¨è¿˜æ— æ³•ç¡®å®šè¿™ä¸‰ä¸ªå˜é‡çš„åœ°å€ï¼Œå› æ­¤ï¼Œå…ˆé€šè¿‡ 0 æ¥è¿›è¡Œå ä½ï¼Œä»¥åé“¾æ¥å™¨ä¼šå°†çœŸæ­£çš„åœ°å€å›å¡«åœ¨è¿™é‡Œã€‚</p><p><strong>extern_func å’Œ global_func çš„è°ƒç”¨</strong></p><p>call æŒ‡ä»¤åŒæ ·æ˜¯é€šè¿‡ 0 æ¥è¿›è¡Œå ä½ï¼Œå’Œå…¨å±€å˜é‡çš„å¤„ç†æ–¹å¼ä¸€æ ·ã€‚</p><p><strong>å¤„ç†å ä½ç¬¦ã€æ ¸å¿ƒã€‘</strong></p><p>ç”±äºåœ¨æ— æ³•ç¡®å®šå˜é‡çš„çœŸå®åœ°å€æ—¶ï¼Œç¼–è¯‘å™¨å…ˆé€šè¿‡ 0 æ¥è¿›è¡Œå ä½ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿™é‡Œç»§ç»­è§‚å¯Ÿé“¾æ¥å™¨å¯¹ extern_varï¼Œstatic_varï¼Œglobal_varï¼Œglobal_func ä»¥åŠ extern_func çš„é‡å®šä½è¿‡ç¨‹ã€‚æˆ‘ä»¬æ¥æŸ¥çœ‹å ä½ç¬¦æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° readelf -S example.o</span><br><span class="line"></span><br><span class="line">There are 21 section headers, starting at offset 0xb50:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       000000000000008a  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000760</span><br><span class="line">       0000000000000078  0000000000000018   I      18     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  000000cc</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  000000d4</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 5] .debug_info       PROGBITS         0000000000000000  000000d4</span><br><span class="line">       0000000000000126  0000000000000000           0     0     1</span><br><span class="line">  [ 6] .rela.debug_info  RELA             0000000000000000  000007d8</span><br><span class="line">       0000000000000228  0000000000000018   I      18     5     8</span><br><span class="line">  [ 7] .debug_abbrev     PROGBITS         0000000000000000  000001fa</span><br><span class="line">       00000000000000a4  0000000000000000           0     0     1</span><br><span class="line">  [ 8] .debug_aranges    PROGBITS         0000000000000000  0000029e</span><br><span class="line">       0000000000000030  0000000000000000           0     0     1</span><br><span class="line">  [ 9] .rela.debug_arang RELA             0000000000000000  00000a00</span><br><span class="line">       0000000000000030  0000000000000018   I      18     8     8</span><br><span class="line">  [10] .debug_line       PROGBITS         0000000000000000  000002ce</span><br><span class="line">       0000000000000067  0000000000000000           0     0     1</span><br><span class="line">  [11] .rela.debug_line  RELA             0000000000000000  00000a30</span><br><span class="line">       0000000000000018  0000000000000018   I      18    10     8</span><br><span class="line">  [12] .debug_str        PROGBITS         0000000000000000  00000335</span><br><span class="line">       000000000000011f  0000000000000001  MS       0     0     1</span><br><span class="line">  [13] .comment          PROGBITS         0000000000000000  00000454</span><br><span class="line">       0000000000000024  0000000000000001  MS       0     0     1</span><br><span class="line">  [14] .note.GNU-stack   PROGBITS         0000000000000000  00000478</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [15] .note.gnu.propert NOTE             0000000000000000  00000478</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     8</span><br><span class="line">  [16] .eh_frame         PROGBITS         0000000000000000  00000498</span><br><span class="line">       0000000000000078  0000000000000000   A       0     0     8</span><br><span class="line">  [17] .rela.eh_frame    RELA             0000000000000000  00000a48</span><br><span class="line">       0000000000000048  0000000000000018   I      18    16     8</span><br><span class="line">  [18] .symtab           SYMTAB           0000000000000000  00000510</span><br><span class="line">       00000000000001f8  0000000000000018          19    16     8</span><br><span class="line">  [19] .strtab           STRTAB           0000000000000000  00000708</span><br><span class="line">       0000000000000055  0000000000000000           0     0     1</span><br><span class="line">  [20] .shstrtab         STRTAB           0000000000000000  00000a90</span><br><span class="line">       00000000000000bb  0000000000000000           0     0     1</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„ readelf -Sé€‰é¡¹æ˜¯æ‰“å°å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰€æœ‰ section-headerçš„ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ° example.oé‡Œæ€»å…±åŒ…å«äº† 12 ä¸ª sectionï¼Œé‡ç‚¹çœ‹.rela.text æ®µã€‚</p><p>ä» section-headerçš„ä¿¡æ¯é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ.rela.text æ®µçš„ç±»å‹æ˜¯ RELA ç±»å‹ï¼Œä¹Ÿå°±æ˜¯é‡å®šä½è¡¨ã€‚</p><p>é“¾æ¥å™¨åœ¨å¤„ç†ç›®æ ‡æ–‡ä»¶çš„æ—¶å€™ï¼Œéœ€è¦å¯¹ç›®æ ‡æ–‡ä»¶é‡Œä»£ç æ®µå’Œæ•°æ®æ®µå¼•ç”¨åˆ°çš„ç¬¦å·è¿›è¡Œé‡å®šä½ï¼Œè€Œè¿™äº›é‡å®šä½çš„ä¿¡æ¯éƒ½è®°å½•åœ¨å¯¹åº”çš„é‡å®šä½è¡¨é‡Œã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œé‡å®šä½è¡¨çš„åå­—éƒ½æ˜¯ä»¥ .rela å¼€å¤´ï¼Œæ¯”å¦‚ .rela.text å°±æ˜¯å¯¹ .text æ®µçš„é‡å®šä½è¡¨ï¼Œ.rela.data æ˜¯å¯¹ .data æ®µçš„é‡å®šä½è¡¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp/tmp1 î‚° readelf -r example.o </span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rela.text&#x27;</span> at offset 0x760 contains 5 entries:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">00000000002c  001300000002 R_X86_64_PC32     0000000000000000 extern_var - 4</span><br><span class="line">000000000035  001000000002 R_X86_64_PC32     0000000000000000 global_var - 4</span><br><span class="line">00000000003e  000300000002 R_X86_64_PC32     0000000000000000 .data + 0</span><br><span class="line">00000000004b  001400000004 R_X86_64_PLT32    0000000000000000 extern_func - 4</span><br><span class="line">000000000058  001100000004 R_X86_64_PLT32    0000000000000000 global_func - 4</span><br></pre></td></tr></table></figure><p>.rela.text çš„é‡å®šä½è¡¨é‡Œå­˜æ”¾äº†textæ®µä¸­éœ€è¦è¿›è¡Œé‡å®šä½çš„æ¯ä¸€å¤„ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œæ¯ä¸ªé‡å®šä½é¡¹éƒ½ä¼šåŒ…å«éœ€è¦é‡å®šä½çš„åç§»ã€é‡å®šä½ç±»å‹å’Œé‡å®šä½ç¬¦å·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Addrâ€º   r_offset; <span class="comment">/* é‡å®šä½è¡¨é¡¹çš„åç§»åœ°å€ */</span></span><br><span class="line">    Elf64_Xwordâ€º  r_info;   <span class="comment">/* é‡å®šä½çš„ç±»å‹ä»¥åŠé‡å®šä½ç¬¦å·çš„ç´¢å¼• */</span></span><br><span class="line">    Elf64_Sxwordâ€º r_addend; <span class="comment">/* é‡å®šä½è¿‡ç¨‹ä¸­éœ€è¦çš„è¾…åŠ©ä¿¡æ¯ */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œr_info çš„é«˜ 32bit å­˜æ”¾çš„æ˜¯é‡å®šä½ç¬¦å·åœ¨ç¬¦å·è¡¨çš„ç´¢å¼•ï¼Œr_info çš„ä½ 32bit å­˜æ”¾çš„æ˜¯é‡å®šä½çš„ç±»å‹çš„ç´¢å¼•ã€‚ç¬¦å·è¡¨å°±æ˜¯.symtab æ®µï¼Œå¯ä»¥æŠŠå®ƒçœ‹æˆæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œè¿™ä¸ªå­—å…¸ä»¥æ•´æ•°ä¸º key ï¼Œä»¥ç¬¦å·åä¸º valueã€‚</p><p>æŸ¥çœ‹é‡å®šä½è¡¨ä¸­çš„å››é¡¹ï¼Œ<strong>å®ƒä»¬çš„ç±»å‹éƒ½æ˜¯ R_X86_64_PC32ã€‚è¿™ç§ç±»å‹çš„é‡å®šä½è®¡ç®—æ–¹å¼ä¸ºï¼šS + A â€“ P</strong>ã€‚</p><ul><li>S è¡¨ç¤ºå®Œæˆé“¾æ¥åè¯¥ç¬¦å·çš„å®é™…åœ°å€ã€‚åœ¨é“¾æ¥å™¨å°†å¤šä¸ªä¸­é—´æ–‡ä»¶çš„æ®µåˆå¹¶ä»¥åï¼Œæ¯ä¸ªç¬¦å·å°±æŒ‰å…ˆåé¡ºåºä¾æ¬¡éƒ½ä¼šåˆ†é…åˆ°ä¸€ä¸ªåœ°å€ï¼Œè¿™å°±æ˜¯å®ƒçš„æœ€ç»ˆåœ°å€ Sã€‚</li><li>A è¡¨ç¤º Addend çš„å€¼ï¼Œå®ƒä»£è¡¨äº†å ä½ç¬¦çš„é•¿åº¦ã€‚</li><li>P è¡¨ç¤ºè¦è¿›è¡Œé‡å®šä½ä½ç½®çš„åœ°å€æˆ–åç§»ï¼Œå¯ä»¥é€šè¿‡ r_offset çš„å€¼è·å–åˆ°ï¼Œè¿™æ˜¯å¼•ç”¨ç¬¦å·çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦å›å¡«åœ°å€çš„åœ°æ–¹ï¼Œç®€å•è¯´ï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡æåˆ°çš„ç”¨ 0 å¡«å……çš„å ä½ç¬¦çš„åœ°å€ã€‚</li></ul><p>è¿™<strong>é‡Œ S ä¸ P æ‰€è¡¨ç¤ºçš„åœ°å€éƒ½æ˜¯æ–‡ä»¶åˆå¹¶ä¹‹åæœ€ç»ˆçš„è™šæ‹Ÿåœ°å€</strong>ã€‚</p><p>ä»¥extern_varä¸ºä¾‹è¿›åˆ¶æ¼”ç®—ï¼šã€ä¸‹é¢çš„ä¾‹å­çš„åœ°å€å’Œä¸Šé¢ç¨‹åºæ— å…³ã€‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00000000004004ad &lt;main&gt;:</span><br><span class="line">  4004ad:       55                      push   %rbp</span><br><span class="line">  4004ae:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  4004b1:       48 83 ec 20             sub    $0x20,%rsp</span><br><span class="line">  4004b5:       8b 05 75 0b 20 00       mov    0x200b75(%rip),%eax        # 601030 &lt;extern_var&gt;</span><br><span class="line">  4004bb:       89 45 e8                mov    %eax,-0x18(%rbp)</span><br></pre></td></tr></table></figure><ul><li><p>S æ˜¯å…¶æœ€ç»ˆç¬¦å·çš„çœŸå®åœ°å€ï¼Œå¦‚ä¸Šæ±‡ç¼–é‡Œè¾¹çš„æ³¨é‡Šæ‰€ç¤º  ä¹Ÿå°±æ˜¯ä¸Šé¢æ³¨é‡Šçš„ 0x601030 è¿™ä¸ªåœ°å€ï¼›</p></li><li><p>A æ˜¯ Addend çš„å€¼ï¼Œå¯ä»¥ä»é‡å®šä½è¡¨é‡ŒæŸ¥åˆ°æ˜¯ -4ï¼Œå¯¹äº A çš„å…·ä½“å«ä¹‰æˆ‘è¿˜ä¼šè¿›ä¸€æ­¥è§£é‡Šï¼›</p></li><li><p>P æ˜¯é‡å®šä½ offset çš„åœ°å€ï¼Œè¿™é‡Œæ˜¯ 0x4004b7ã€‚</p></li></ul><p>æ ¹æ®å…¬å¼ï¼Œæˆ‘ä»¬ç®—å‡ºé‡å®šä½å¤„éœ€è¦å¡«å†™çš„å€¼åº”è¯¥æ˜¯ 0x601030 + (-4) â€“ 0x4004b7 = 0x200b75ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶ä¸­è¿™æ¡ mov æŒ‡ä»¤é‡Œçš„å€¼ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬ä»æˆ‘ä»¬å†ä» CPU çš„è§’åº¦éªŒè¯å–å€¼å…³ç³»ã€‚ä»ä¸Šé¢ main å‡½æ•°çš„åç¼–è¯‘çš„ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æœ€ç»ˆå¯¹ extern_var çš„è®¿é—®ç”Ÿæˆçš„æ±‡ç¼–æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov    0x200b75(%rip), %eax</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€æ¡ PC ç›¸å¯¹åç§»çš„å¯»å€æ–¹å¼ã€‚å½“  CPU æ‰§è¡Œåˆ°è¿™æ¡æŒ‡ä»¤çš„æ—¶å€™ï¼Œ%rip çš„å€¼å­˜æ”¾çš„æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯  0x4004bbã€‚è¿™æ—¶å€™å¯ä»¥ç®—å‡º 0x4004bb + 0x200b75 = 0x601030ï¼Œåˆšå¥½æ˜¯ extern_var  çš„å®é™…åœ°å€ã€‚</p><p>ç»è¿‡æ­£é¢åˆ†æè¿™ä¸ªé‡å®šä½çš„å€¼çš„ä½œç”¨åï¼Œè¿™é‡Œæˆ‘ä»¬å†æ¥ç†è§£ä¸€ä¸‹ S+A-P è¿™ä¸ªå…¬å¼çš„ä½œç”¨ã€‚é“¾æ¥å™¨æœ‰äº†æ•´ä½“çš„è™šæ‹Ÿå†…å­˜å¸ƒå±€åï¼ŒçŸ¥é“çš„ä¿¡æ¯æ˜¯ï¼šéœ€è¦é‡å®šä½ç¬¦å·çš„åœ°å€ S çš„å€¼æ˜¯ (0x601030)ï¼Œä»¥åŠéœ€è¦é‡å®šä½çš„ä½ç½®åœ°å€ P çš„å€¼æ˜¯ (0x4004b7)ã€‚</p><p>å…¶å®ï¼Œåˆ°è¿™é‡Œä¸ç…§æœ¬å®£ç§‘çš„æƒ³ä¸€ä¸‹æ›´åŠ æ¯”è¾ƒå®¹æ˜“çš„æƒ³Â·æ‡‚ã€‚</p><p><strong>é™æ€å˜é‡</strong></p><p><strong>static_var çš„æœ€ç»ˆåœ°å€å°±æ˜¯æœ¬ç¼–è¯‘å•å…ƒçš„.data æ®µçš„æœ€ç»ˆåœ°å€</strong>ã€‚</p><h2 id="åŠ¨æ€é“¾æ¥">åŠ¨æ€é“¾æ¥</h2><p>å›é¡¾ä¸‹é™æ€é“¾æ¥çš„è¿‡ç¨‹ï¼šæºæ–‡ä»¶ç»è¿‡ç¼–è¯‘ç”Ÿæˆå¯é‡å®šä½æ–‡ä»¶ï¼ˆ.oæ–‡ä»¶ï¼‰ï¼Œå†ç»è¿‡é™æ€é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œçš„ELFæ–‡ä»¶ï¼Œæœ€ç»ˆè¿è¡Œæ—¶ï¼Œé€šè¿‡é¡µåŠ è½½å’Œé¡µé”™è¯¯çš„æ–¹å¼ï¼Œä¿è¯è¿›ç¨‹çš„æ­£å¸¸è¿è¡Œã€‚</p><p>å‡å¦‚åƒprintfï¼Œscanfï¼Œstrlenç­‰åŸºç¡€å‡½æ•°ï¼Œæ¯ä¸ªåº”ç”¨ä¸­éƒ½ä¼šä½¿ç”¨åˆ°ï¼Œé‚£ä¹ˆä¸åŒçš„ç¨‹åºä¸­ä¸€å®šä¼šåŒ…å«å®ƒä»¬çš„æŒ‡ä»¤éƒ¨åˆ†ã€‚è¿™å°±å¯¼è‡´è¿™äº›ç¨‹åºåœ¨ç£ç›˜ä¿å­˜æ—¶ï¼Œéƒ½æœ‰è¿™äº›åŸºç¡€å‡½æ•°çš„å‰¯æœ¬ã€‚è¿è¡Œæ—¶ï¼Œä¹Ÿä¼šå°†è¿™äº›å‰¯æœ¬åŠ è½½åˆ°å¯¹åº”è¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´å†…å­˜ä¸­å»ã€‚è¿™å°±å¯¼è‡´äº†<strong>æµªè´¹ç£ç›˜å’Œå†…å­˜</strong>ã€‚</p><p>é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥å°±è¦å¼•å‡ºä¸‹é¢çš„ä¸»è§’äº†ï¼Œ<strong>åŠ¨æ€é“¾æ¥</strong>ã€‚</p><p><strong>è€ŒåŠ¨æ€é“¾æ¥çš„é‡å®šä½çš„æ—¶æœºåˆå¯ä»¥åˆ†æˆï¼šåŠ è½½æœŸé—´æˆ–è€…è¿è¡ŒæœŸé—´ã€‚</strong></p><h3 id="åŠ è½½æœŸé—´">åŠ è½½æœŸé—´</h3><p>ç®€å•ä»‹ç»ä¸‹ï¼šæˆ‘ä»¬å¸Œæœ›å°†å¸¸ç”¨çš„å…¬å…±çš„å‡½æ•°éƒ½æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œåœ¨æ•´ä¸ªç³»ç»Ÿé‡Œåªä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ä¸€æ¬¡ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ªè¿›ç¨‹ä½¿ç”¨å®ƒï¼Œè¿™ä¸ªæ–‡ä»¶åœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™ç§æ–‡ä»¶å°±æ˜¯åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ã€‚</p><p>åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶</p><ul><li>Linuxï¼šå…±äº«ç›®æ ‡æ–‡ä»¶ (share object, so)</li><li>Windowï¼šåŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ (dynamic linking library, dll)</li></ul><p>æˆ‘ä»¬å…ˆçœ‹ä¸ªè¶…çº§ç®€å•çš„ä¾‹å­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.c</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">int</span> i)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="built_in">func</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//func.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;input i = %d\n&quot;</span>,i);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC -o libfunc.so fun.c</span><br><span class="line">gcc main.c -o main -L./ -lfunc</span><br></pre></td></tr></table></figure><ul><li><p>-Lï¼š æŒ‡å®šäº†æŸ¥æ‰¾é“¾æ¥åº“çš„è·¯å¾„ (æˆ–è€…å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ LIBRARY_PATH æ¥è¿½åŠ è·¯å¾„)ã€‚ -L. å°±æ˜¯å‘Šè¯‰é“¾æ¥å™¨éœ€è¦åˆ°å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾å…±äº«æ–‡ä»¶ã€‚</p></li><li><p>-l ï¼šæŒ‡å®šäº†å…·ä½“é“¾æ¥åº“çš„åç§°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œgcc  åœ¨å¤„ç†é“¾æ¥åº“åç§°æ—¶ï¼Œä¼šè‡ªåŠ¨åŠ ä¸Š libçš„å‰ç¼€å’Œ.soçš„åç¼€ï¼Œæ‰€ä»¥ï¼Œgcc å‘½ä»¤é€‰é¡¹å†™çš„ -lfuncï¼Œå°±æ˜¯å‘Šè¯‰é“¾æ¥å™¨æŸ¥æ‰¾libfunc.soè¿™ä¸ªå…±äº«ç›®æ ‡æ–‡ä»¶ã€‚</p></li></ul><p>è¿è¡ŒæŒ‡ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=./</span><br><span class="line">./main</span><br><span class="line">input i = 5</span><br></pre></td></tr></table></figure><p>é€šè¿‡å‘½ä»¤çš„æŒ‡ä»¤æˆ‘ä»¬æµ…æµ…çš„çŒœæµ‹ä¸€ä¸‹ï¼Œç¼–è¯‘å‚æ•°ä¸­ -lfuncå­˜åœ¨çš„ç›®çš„ï¼Ÿ</p><p>å› ä¸ºlibfunc.soçš„ç¬¦å·è¡¨ä¸­æœ‰func,å½“é“¾æ¥å™¨å‘ç°è¯¥ç¬¦å·å­˜åœ¨äº.soä¸­ï¼Œåˆ™å°†å…¶ä½œä¸ºåŠ¨æ€ç¬¦å·å¤„ç†ã€‚<strong>è¿™ä¹Ÿè¯´æ˜äº†ï¼Œä¸ºä»€ä¹ˆé™æ€é“¾æ¥é˜¶æ®µï¼Œæˆ‘ä»¬è¿˜éœ€è¦åŠ¨æ€åº“çš„åŸå› ã€‚é™æ€é“¾æ¥é˜¶æ®µï¼ŒåŠ¨æ€åº“çš„ä½œç”¨å°±æ˜¯ç”¨äºåŒºåˆ«ç¬¦å·çš„ç±»å‹ã€‚</strong></p><p>åœ¨å¤šè¿›ç¨‹å…±äº«åŠ¨æ€åº“çš„æ—¶å€™ï¼Œå› ä¸ºä»£ç æ®µæ˜¯ä¸å¯å†™çš„ï¼Œæ‰€ä»¥è¿›ç¨‹é—´å…±äº«ä¸å­˜åœ¨é—®é¢˜ï¼Œè€Œæ•°æ®æ®µå¯å†™ï¼Œç³»ç»Ÿå¿…é¡»ä¿è¯ä¸€ä¸ªè¿›ç¨‹å†™äº†å…±äº«åº“çš„æ•°æ®æ®µï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹çœ‹ä¸åˆ°ã€‚å› æ­¤ï¼Œ<strong>ä¸åŒçš„åº“åœ¨ä¸åŒçš„è¿›ç¨‹åŠ è½½åœ°å€å¯èƒ½æ˜¯ä¸åŒçš„</strong>ã€‚</p><p>ä¸‹é¢é€šè¿‡ç®€å•çš„å®è·µæŸ¥çœ‹ä¸€ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸‹é¢çš„æŒ‡ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc example.c   -no-pie -o main</span><br></pre></td></tr></table></figure><ul><li>-no-pie æ˜¯ç¦æ­¢ç”Ÿæˆåœ°å€æ— å…³çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ–¹ä¾¿æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜å¸ƒå±€ã€‚</li></ul><p>åˆ†åˆ«åœ¨ç»ˆç«¯å¯åŠ¨2ä¸ªç¨‹åºï¼Œé€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹pidï¼Œå…·ä½“å®è·µå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> âœ˜ penge@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° ps aux | grep main</span><br><span class="line"></span><br><span class="line">penge      13319  0.1  2.4 962872 95600 ?        Sl   15:38   0:02 /home/penge/.vscode-server/cli/servers/Stable-e170252f762678dec6ca2cc69aba1570769a5d39/server/node /home/penge/.vscode-server/cli/servers/Stable-e170252f762678dec6ca2cc69aba1570769a5d39/server/out/server-main.js --connection-token=remotessh --accept-server-license-terms --start-server --enable-remote-auto-shutdown --socket-path=/tmp/code-5e7b9f0b-d52b-4755-9d41-32cabc4825ca</span><br><span class="line">penge      14196  0.0  0.0   2496   516 pts/2    S+   16:11   0:00 ./main</span><br><span class="line">penge      14241  0.0  0.0   2496   580 pts/4    S+   16:11   0:00 ./main</span><br><span class="line">penge      14405  0.0  0.0  12116  2728 pts/0    S+   16:13   0:00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn --exclude-dir=.idea --exclude-dir=.tox mai</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿›ç¨‹å†…å­˜ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">penge</span>@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° cat /proc/<span class="number">14241</span>/maps</span><br><span class="line"><span class="attribute">00400000</span>-<span class="number">00401000</span> r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">00401000</span>-<span class="number">00402000</span> r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">00402000</span>-<span class="number">00403000</span> r--p <span class="number">00002000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">00403000</span>-<span class="number">00404000</span> r--p <span class="number">00002000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">00404000</span>-<span class="number">00405000</span> rw-p <span class="number">00003000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">01932000</span>-<span class="number">01953000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                 <span class="meta"> [heap]</span></span><br><span class="line"><span class="attribute">7f8c910fc000</span>-<span class="number">7</span>f8c9111e000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c9111e000</span>-<span class="number">7</span>f8c91296000 r-xp <span class="number">00022000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c91296000</span>-<span class="number">7</span>f8c912e4000 r--p <span class="number">0019</span>a000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c912e4000</span>-<span class="number">7</span>f8c912e8000 r--p <span class="number">001</span>e7000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c912e8000</span>-<span class="number">7</span>f8c912ea000 rw-p <span class="number">001</span>eb000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c912ea000</span>-<span class="number">7</span>f8c912f0000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="attribute">7f8c91308000</span>-<span class="number">7</span>f8c91309000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c91309000</span>-<span class="number">7</span>f8c9132c000 r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c9132c000</span>-<span class="number">7</span>f8c91334000 r--p <span class="number">00024000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c91335000</span>-<span class="number">7</span>f8c91336000 r--p <span class="number">0002</span>c000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c91336000</span>-<span class="number">7</span>f8c91337000 rw-p <span class="number">0002</span>d000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f8c91337000</span>-<span class="number">7</span>f8c91338000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="attribute">7ffd5dcfd000</span>-<span class="number">7</span>ffd5dd1e000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [stack]</span></span><br><span class="line"><span class="attribute">7ffd5ddd5000</span>-<span class="number">7</span>ffd5ddd9000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vvar]</span></span><br><span class="line"><span class="attribute">7ffd5ddd9000</span>-<span class="number">7</span>ffd5dddb000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vdso]</span></span><br><span class="line"><span class="attribute">ffffffffff600000</span>-ffffffffff601000 --xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                 <span class="meta"> [vsyscall]</span></span><br><span class="line"> <span class="attribute">penge</span>@penge-virtual-machine î‚° ~/Desktop/MordenCpp î‚° cat /proc/<span class="number">14196</span>/maps</span><br><span class="line"><span class="attribute">00400000</span>-<span class="number">00401000</span> r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">00401000</span>-<span class="number">00402000</span> r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">00402000</span>-<span class="number">00403000</span> r--p <span class="number">00002000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">00403000</span>-<span class="number">00404000</span> r--p <span class="number">00002000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">00404000</span>-<span class="number">00405000</span> rw-p <span class="number">00003000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">1090886</span>                            /home/penge/Desktop/MordenCpp/tmp1/main</span><br><span class="line"><span class="attribute">01584000</span>-<span class="number">015</span>a5000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                 <span class="meta"> [heap]</span></span><br><span class="line"><span class="attribute">7f9f9f286000</span>-<span class="number">7</span>f9f9f2a8000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f2a8000</span>-<span class="number">7</span>f9f9f420000 r-xp <span class="number">00022000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f420000</span>-<span class="number">7</span>f9f9f46e000 r--p <span class="number">0019</span>a000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f46e000</span>-<span class="number">7</span>f9f9f472000 r--p <span class="number">001</span>e7000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f472000</span>-<span class="number">7</span>f9f9f474000 rw-p <span class="number">001</span>eb000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232266</span>                    /usr/lib/x86_64-linux-gnu/libc-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f474000</span>-<span class="number">7</span>f9f9f47a000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="attribute">7f9f9f492000</span>-<span class="number">7</span>f9f9f493000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f493000</span>-<span class="number">7</span>f9f9f4b6000 r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f4b6000</span>-<span class="number">7</span>f9f9f4be000 r--p <span class="number">00024000</span> <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f4bf000</span>-<span class="number">7</span>f9f9f4c0000 r--p <span class="number">0002</span>c000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f4c0000</span>-<span class="number">7</span>f9f9f4c1000 rw-p <span class="number">0002</span>d000 <span class="number">08</span>:<span class="number">05</span> <span class="number">2232260</span>                    /usr/lib/x86_64-linux-gnu/ld-<span class="number">2</span>.<span class="number">31</span>.so</span><br><span class="line"><span class="attribute">7f9f9f4c1000</span>-<span class="number">7</span>f9f9f4c2000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="attribute">7ffd481b7000</span>-<span class="number">7</span>ffd481d8000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [stack]</span></span><br><span class="line"><span class="attribute">7ffd481f7000</span>-<span class="number">7</span>ffd481fb000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vvar]</span></span><br><span class="line"><span class="attribute">7ffd481fb000</span>-<span class="number">7</span>ffd481fd000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vdso]</span></span><br><span class="line"><span class="attribute">ffffffffff600000</span>-ffffffffff601000 --xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                 <span class="meta"> [vsyscall]</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºåŒæ ·çš„/usr/lib/x86_64-linux-gnu/libc-2.31.soä½†æ˜¯ç©ºé—´æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>å› æ­¤è¿™æ—¶å€™å°±æœ‰äº†<strong>åœ°å€æ— å…³ä»£ç </strong>ã€‚</p><h4 id="PIC">PIC</h4><p>ç™¾åº¦ç™¾ç§‘ï¼šåœ¨è®¡ç®—æœºé¢†åŸŸä¸­ï¼Œåœ°å€æ— å…³ä»£ç  (position-independent codeï¼ŒPIC)ï¼Œåˆç§°åœ°å€æ— å…³å¯æ‰§è¡Œæ–‡ä»¶ (position-independent executableï¼ŒPIE) ï¼Œæ˜¯æŒ‡<strong>å¯åœ¨ä¸»å­˜å‚¨å™¨ä¸­ä»»æ„ä½ç½®æ­£ç¡®åœ°è¿è¡Œï¼Œè€Œä¸å—å…¶ç»å¯¹åœ°å€å½±å“çš„ä¸€ç§æœºå™¨ç </strong>ã€‚</p><p>å†ä»‹ç»PICä¹‹å‰ï¼Œå…ˆè¯´è¯´ä¹‹å‰<strong>ä¸åŒçš„åº“åœ¨ä¸åŒçš„è¿›ç¨‹åŠ è½½åœ°å€å¯èƒ½æ˜¯ä¸åŒçš„</strong>å¯¼è‡´çš„é—®é¢˜å§ã€‚</p><blockquote><p><strong>é—®é¢˜</strong></p></blockquote><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240419135438733.png" alt="image-20240419135438733"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœä¸¤ä¸ªè¿›ç¨‹å…±äº«äº†libc.soå’Œlibd.soä¸¤ä¸ªåŠ¨æ€åº“ï¼Œè€Œä¸” libc ä¸­ä¼šè°ƒç”¨ libd ä¸­å®šä¹‰çš„ foo æ–¹æ³•ã€‚</p><p>è¿›ç¨‹ 1 å°† foo æ–¹æ³•æ˜ å°„åˆ°è‡ªå·±çš„è™šæ‹Ÿåœ°å€ 0x1000 å¤„ï¼Œè€Œè°ƒç”¨ foo æ–¹æ³•çš„æŒ‡ä»¤è¢«æ˜ å°„åˆ° 0x2000 å¤„ï¼Œé‚£ä¹ˆ call æŒ‡ä»¤å¦‚æœé‡‡ç”¨ä¾èµ– rip å¯„å­˜å™¨çš„ç›¸å¯¹å¯»å€çš„åŠæ³•ï¼Œè¿™ä¸ªåç§»é‡åº”è¯¥å¡« -0x1000ã€‚è¿›ç¨‹ 2 å°† foo æ–¹æ³•æ˜ å°„åˆ°è‡ªå·±è™šæ‹Ÿåœ°å€ 0x2000 å¤„ï¼Œè°ƒç”¨ foo æ–¹æ³•çš„æŒ‡ä»¤è¢«æ˜ å°„åˆ° 0x5000 å¤„ï¼Œé‚£ä¹ˆ call æŒ‡ä»¤çš„å‚æ•°å°±åº”è¯¥å¡« -0x3000ã€‚è¿™å°±äº§ç”Ÿäº†å†²çªã€‚</p><p>å› æ­¤éœ€è¦<strong>åœ°å€æ— å…³ä»£ç </strong>æŠ€æœ¯ã€‚</p><p>åœ¨è®¡ç®—æœºç§‘å­¦é¢†åŸŸï¼Œ<strong>æœ‰ä¸€å¥åè¨€ï¼šâ€œè®¡ç®—æœºé¢†åŸŸçš„æ‰€æœ‰é—®é¢˜éƒ½å¯ä»¥ä½¿ç”¨æ–°åŠ ä¸€å±‚æŠ½è±¡æ¥è§£å†³â€ã€‚</strong></p><p>é‚£ä¹ˆæœ‰äº†è¿™å¥è¯çš„å¼•å¯¼ï¼Œè¦å®ç°ä»£ç æ®µçš„åœ°å€æ— å…³ä»£ç ï¼Œæ€è·¯æ˜¯é€šè¿‡æ·»åŠ ä¸€ä¸ªä¸­é—´å±‚ï¼Œä½¿å¾—å¯¹å…¨å±€ç¬¦å·çš„è®¿é—®ç”±ç›´æ¥è®¿é—®å˜æˆé—´æ¥è®¿é—®ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªå›ºå®šåœ°å€ï¼Œè®©å¼•ç”¨è€…ä¸è¿™ä¸ªå›ºå®šåœ°å€ä¹‹é—´çš„ç›¸å¯¹åç§»æ˜¯å›ºå®šçš„ï¼Œç„¶åè¿™ä¸ªåœ°å€å¤„å†å¡«å…¥ foo å‡½æ•°çœŸæ­£çš„åœ°å€ã€‚å½“ç„¶ï¼Œè¿™ä¸ªåœ°æ–¹å¿…ç„¶ä½äºæ•°æ®æ®µä¸­ï¼Œæ˜¯æ¯ä¸ªè¿›ç¨‹ç§æœ‰çš„ï¼Œè¿™æ ·æ‰èƒ½åšåˆ°åœ¨ä¸åŒçš„è¿›ç¨‹é‡Œï¼Œå¯ä»¥è®¿é—®ä¸åŒçš„è™šæ‹Ÿåœ°å€ã€‚è¿™ä¸ªæ–°å¼•å…¥çš„å›ºå®šåœ°å€å°±æ˜¯<strong>å…¨å±€åç§»è¡¨ (Global Offset Table, GOT)</strong>ã€‚</p><p>GOT çš„å·¥ä½œåŸç†å¦‚ä¸‹</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240419135432310.png" alt="image-20240419135432310"></p><p>åœ¨ä¸Šå›¾ä¸­ï¼ŒcallæŒ‡ä»¤å¤„è¢«å¡«å…¥äº† 0x3000ï¼Œè¿™æ˜¯å› ä¸ºè¿›ç¨‹ 1 çš„ GOT ä¸ call æŒ‡ä»¤ä¹‹é—´çš„åç§»æ˜¯ 0x5000-0x2000=0x3000ï¼ŒåŒæ—¶è¿›ç¨‹ 2 çš„ GOT ä¸ callæŒ‡ä»¤ä¹‹é—´çš„åç§»æ˜¯ 0x8000-0x5000=0x3000ã€‚æ‰€ä»¥å¯¹äºè¿™ä¸€æ®µå…±äº«ä»£ç ï¼Œä¸ç®¡æ˜¯è¿›ç¨‹ 1 æ‰§è¡Œè¿˜æ˜¯è¿›ç¨‹ 2 æ‰§è¡Œï¼Œå®ƒä»¬éƒ½èƒ½è·³åˆ°è‡ªå·±çš„GOT è¡¨é‡Œã€‚</p><p>ç„¶åï¼Œè¿›ç¨‹ 1 é€šè¿‡è®¿é—®è‡ªå·±çš„ GOT è¡¨ï¼ŒæŸ¥åˆ° foo å‡½æ•°çš„åœ°å€æ˜¯ 0x1000ï¼Œå®ƒå°±èƒ½çœŸæ­£åœ°è°ƒç”¨åˆ° foo å‡½æ•°äº†ã€‚è¿›ç¨‹ 2 è®¿é—®è‡ªå·±çš„ GOT è¡¨ï¼ŒæŸ¥åˆ° foo å‡½æ•°çš„åœ°å€æ˜¯ 0x2000ï¼Œå®ƒä¹Ÿèƒ½é¡ºåˆ©åœ°è°ƒç”¨ foo å‡½æ•°ã€‚è¿™æ ·æˆ‘ä»¬å°±é€šè¿‡å¼•å…¥äº† GOT è¿™ä¸ªé—´æ¥å±‚ï¼Œè§£å†³äº† call æŒ‡ä»¤å’Œ foo å‡½æ•°å®šä¹‰ä¹‹é—´çš„åç§»ä¸å›ºå®šçš„é—®é¢˜ã€‚</p><p>è¿™ç§æŠ€æœ¯å°±æ˜¯<strong>åœ°å€æ— å…³ä»£ç </strong> (Position Independent Code, PIC)ã€‚</p><p>è¿™ä¸ªéªŒè¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¯ä»¥å°è¯•è‡ªå·±é€šè¿‡ç¨‹åºéªŒè¯ä¸‹ã€‚</p><p>å› æ­¤ï¼Œå…±äº«åº“çš„å¥½å¤„ä¹Ÿå‘¼ä¹‹æ¬²å‡ºäº†ã€‚</p><blockquote><p><strong>é™æ€åº“ VS åŠ¨æ€åº“</strong></p></blockquote><ul><li>é™æ€åº“æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå°±å’Œå¯æ‰§è¡Œæ–‡ä»¶æ‰“åŒ…é“¾æ¥åœ¨ä¸€èµ·çš„ï¼Œå®ƒå¯ä»¥çœ‹æˆæ˜¯ä¸­é—´æ–‡ä»¶çš„ç®€å•é›†åˆï¼Œä¿ç•™äº†ç¬¦å·ï¼Œåªæœ‰åœ¨é™æ€é“¾æ¥çš„è¿‡ç¨‹ï¼Œæ‰ä¼šçœŸæ­£åœ°åšåœ°å€åˆ†é…å’Œé‡å®šä½ã€‚</li><li>åŠ¨æ€åº“åœ¨ç¼–è¯‘é˜¶æ®µï¼Œå®ƒçš„ä»£ç å¹¶ä¸ä¼šè¢«åˆå¹¶è¿›å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œåœ¨è¿è¡Œæ—¶æ‰ä¼šè¢«åŠ è½½è¿›å†…å­˜ï¼Œå®ƒè¢«åŠ è½½è¿›å†…å­˜çš„åœ°å€æ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥æ¯æ¬¡åŠ è½½å®Œæˆä»¥åï¼Œæ‰èƒ½ä¸ºå®ƒçš„ç¬¦å·åˆ†é…çœŸå®çš„å†…å­˜åœ°å€ï¼Œç„¶åå†æŠŠåœ°å€å›å¡«åˆ°å¼•ç”¨å®ƒçš„GOTä¸­ã€‚åŠ¨æ€åº“çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä»¥åœ¨å¤šä¸ªè¿›ç¨‹é—´å…±äº«ï¼Œä»è€Œå¯ä»¥å‡å°‘å†…å­˜çš„é‡å¤ã€‚</li></ul><h3 id="è¿è¡ŒæœŸé—´">è¿è¡ŒæœŸé—´</h3><p><strong>åŠ¨æ€é“¾æ¥è¿‡ç¨‹çš„åŸºæœ¬åŸç†</strong>ï¼šåŠ¨æ€é“¾æ¥é€šè¿‡GOT è¡¨åŠ ä¸€å±‚é—´æ¥è·³è½¬çš„æ–¹å¼ï¼Œè§£å†³äº†ä»£ç ä¸­ call æŒ‡ä»¤å¯¹ç»å¯¹åœ°å€çš„ä¾èµ–ï¼Œä»è€Œå®ç°äº†PICçš„èƒ½åŠ›ã€‚</p><p>åŠ¨æ€é“¾æ¥å­˜åœ¨çš„é—®é¢˜ï¼š</p><ol><li>æ¯æ¬¡å¯¹å…¨å±€ç¬¦å·çš„è®¿é—®éƒ½è¦è½¬æ¢ä¸ºå¯¹ GOT è¡¨çš„è®¿é—®ï¼Œç„¶åè¿›è¡Œé—´æ¥å¯»å€ï¼Œè¿™å¿…ç„¶è¦æ¯”ç›´æ¥çš„åœ°å€è®¿é—®é€Ÿåº¦æ…¢å¾ˆå¤šã€‚</li><li>åŠ¨æ€é“¾æ¥å’Œé™æ€é“¾æ¥çš„åŒºåˆ«æ˜¯å°†é“¾æ¥ä¸­é‡å®šä½çš„è¿‡ç¨‹æ¨è¿Ÿåˆ°ç¨‹åºåŠ è½½æ—¶è¿›è¡Œã€‚å› æ­¤åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼ŒåŠ¨æ€é“¾æ¥å™¨éœ€è¦å¯¹æ•´ä¸ªè¿›ç¨‹ä¸­ä¾èµ–çš„ so è¿›è¡ŒåŠ è½½å’Œé“¾æ¥ï¼Œä¹Ÿå°±æ˜¯å¯¹è¿›ç¨‹ä¸­æ‰€æœ‰ GOT è¡¨ä¸­çš„ç¬¦å·è¿›è¡Œè§£æé‡å®šä½ã€‚</li></ol><h4 id="å»¶è¿Ÿç»‘å®šæŠ€æœ¯">å»¶è¿Ÿç»‘å®šæŠ€æœ¯</h4><p>ä¸ºäº†é¿å…åœ¨åŠ è½½æ—¶å°±æŠŠ GOT è¡¨ä¸­çš„ç¬¦å·å…¨éƒ¨è§£æå¹¶é‡å®šä½ï¼Œé‚£ä¹ˆå°±é‡‡å–æ‡’æ“ä½œï¼ŒæŠŠè¦åšçš„äº‹æƒ…æ¨è¿Ÿåˆ°å¿…é¡»åšçš„æ—¶åˆ»ã€‚<strong>ç®€å•æ¥è¯´ï¼Œå°†å‡½æ•°åœ°å€çš„é‡å®šä½å·¥ä½œä¸€ç›´æ¨è¿Ÿåˆ°ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™å†è¿›è¡Œï¼Œè¿™å°±æ˜¯å»¶è¿Ÿç»‘å®š (Lazy binding) çš„æŠ€æœ¯</strong>ã€‚è¿™æ ·å¯¹äºæ•´ä¸ªç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ²¡æœ‰è®¿é—®åˆ°çš„å…¨å±€å‡½æ•°ï¼Œå¯ä»¥é¿å…å¯¹è¿™ç±»ç¬¦å·çš„é‡å®šä½å·¥ä½œï¼Œæé«˜ç¨‹åºæ€§èƒ½ã€‚</p><p>å»¶è¿Ÿç»‘å®šçš„å®ç°ä½¿ç”¨äº†ä¸¤ä¸ªç‰¹æ®Šçš„æ•°æ®ç»“æ„</p><ul><li>å…¨å±€åç§»è¡¨ï¼ˆGlobal Offset Tableï¼ŒGOTï¼‰</li><li>è¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆProcedure Linkage Tableï¼ŒPLTï¼‰</li></ul><p>å¤§è‡´çš„å®ç°æ€è·¯æ˜¯æˆ‘ä»¬æŠŠ GOT ä¸­çš„å¾…è§£æç¬¦å·çš„åœ°æ–¹éƒ½å¡«æˆåŠ¨æ€ç¬¦å·è§£æçš„å‡½æ•°ï¼Œå½“ CPU æ‰§è¡Œåˆ°è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå°±ä¼šè·³è½¬è¿›å»è§£æç¬¦å·ï¼Œç„¶åæŠŠ GOT è¡¨çš„è¿™ä¸€é¡¹å¡«æˆç¬¦å·çš„çœŸæ­£çš„åœ°å€ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p><p>è¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆProcedure Linkage Tableï¼Œ PLT)ï¼Œå°†åŠ¨æ€è§£æç¬¦å·çš„è¿‡ç¨‹åšæˆäº†ä¸‰çº§è·³ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240419135425681.png" alt="image-20240419135425681"></p><p>ä»”ç»†æŸ¥çœ‹ï¼Œä¼šå‘ç°ä¸Šé¢çš„è¿™å¼ å›¾å¤šäº†.pltæ®µã€‚</p><p>åœ¨ä»£ç æ®µé‡Œï¼Œmain å‡½æ•°å¯¹ B å‡½æ•°çš„è°ƒç”¨è½¬æˆäº†å¯¹&quot;B@plt&quot;çš„è°ƒç”¨ï¼Œ&quot;B@plt&quot;å‡½æ•°åªæœ‰ä¸‰æ¡æŒ‡ä»¤</p><ul><li>ç¬¬ä¸€æ¡æŒ‡ä»¤ jmp *(GOT[3]) æ˜¯ä¸€ä¸ªé—´æ¥è·³è½¬ï¼Œè·³è½¬çš„ç›®æ ‡æ˜¯ GOT è¡¨åç§»ä¸º 0x18 çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®åº”è¯¥æ”¾çš„æ˜¯ B å‡½æ•°çš„çœŸå®åœ°å€ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œé‡Œé¢è‚¯å®šæ˜¯ä¸ºç©ºçš„ï¼Œå› ä¸ºåœ¨åŠ è½½æ—¶ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œé‡å®šä½ã€‚å› æ­¤ç°åœ¨å¡«å…¥çš„æ˜¯æŒ‡å‘äº† B@plt + 0x6 çš„ä½ç½®ï¼Œè¿™æ˜¯ä¸ºäº†ä¼ é€’å‚æ•°ç»™ _dl_runtime_resolve å‡½æ•°ã€‚</li><li>B@plt+0x6 çš„ä½ç½®å…¶å®å°±æ˜¯ B@plt å‡½æ•°çš„ç¬¬äºŒæ¡æŒ‡ä»¤ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†å‡½æ•°å‚æ•°å…¥æ ˆã€‚</li><li>æ¥ç€æ‰§è¡Œç¬¬ä¸‰æ¡æŒ‡ä»¤ jmp .plt å†å‡†å¤‡ç¬¬äºŒä¸ªå‚æ•°ã€‚</li></ul><p>3çº§è·³åˆ†æï¼š</p><ul><li><p>åºå·â‘ ç®­å¤´çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€çº§è·³è½¬ï¼Œå®ƒçš„ç›®çš„æ˜¯æŠŠå‚æ•° 0 å…¥æ ˆã€‚ç”±äº GOT è¡¨çš„ 0x0ï¼Œ0x8ï¼Œ0x10 çš„ä½ç½®éƒ½è¢«å ç”¨äº†ï¼Œæ‰€ä»¥å‚æ•° 0 ä»£è¡¨çš„å°±æ˜¯ 0x18 ä½ç½®ï¼Œè¿™å°±æ˜¯ B å‡½æ•°çš„çœŸå®åœ°å€åº”è¯¥å­˜æ”¾çš„åœ°æ–¹ã€‚</p></li><li><p>åºå·â‘¡ç®­å¤´çš„ä½ç½®ï¼Œå‘ç”Ÿäº†ç¬¬äºŒçº§è·³è½¬ï¼Œè¿™ä¸€æ¬¡æ˜¯ä¸ºäº†æŠŠåŠ¨æ€åº“çš„ ID å·å‹æ ˆä¼ å‚ã€‚</p></li><li><p>åºå·â‘¢ç®­å¤´çš„ä½ç½®ï¼Œç»§ç»­è¿›è¡Œç¬¬ä¸‰çº§è·³è½¬ï¼Œè¿™ä¸€æ¬¡è·³è½¬æ‰çœŸæ­£åœ°è°ƒç”¨åˆ°äº† _dl_runtime_resolveã€åŠ¨æ€è§£æç¬¦å·çš„å‡½æ•° _dl_runtime_resolve ä¾èµ–ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å½“å‰åŠ¨æ€åº“çš„ IDï¼Œå¦ä¸€ä¸ªæ˜¯è¦è§£æçš„ç¬¦å·åœ¨ GOT è¡¨ä¸­çš„åºå·ã€‘ã€‚è°ƒç”¨å®Œè¿™ä¸ªæ–¹æ³•ä»¥åï¼ŒB å‡½æ•°çš„çœŸå®åœ°å€å°±ä¼šè¢«å¡«å…¥ GOT è¡¨ä¸­äº†ã€‚</p></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240419135418296.png" alt="image-20240419135418296"></p><p>æœ€åï¼Œæ€»ç»“ä¸€ä¸‹ GOT è¡¨ä¸­çš„å„ä¸ªè¡¨é¡¹çš„å«ä¹‰ã€‚</p><ul><li>GOT.PLT[0]ä½ç½®è¢«åŠ è½½å™¨ä¿ç•™ï¼Œå®ƒé‡Œé¢å­˜æ”¾çš„æ˜¯.dynamic æ®µçš„åœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒã€‚</li><li>GOT.PLT[1]ä½ç½®å­˜æ”¾çš„æ˜¯å½“å‰ so çš„ IDï¼Œè¿™ä¸ª ID æ˜¯åŠ è½½å™¨åœ¨åŠ è½½å½“å‰åŠ¨æ€åº“æ–‡ä»¶çš„æ—¶å€™åˆ†é…çš„ã€‚</li><li>GOT.PLT[2]ä½ç½®å­˜æ”¾çš„æ˜¯åŠ¨æ€é“¾æ¥å‡½æ•°çš„å…¥å£åœ°å€ï¼Œä¸€èˆ¬æ˜¯åŠ¨æ€é“¾æ¥å™¨ä¸­çš„ _dl_runtime_resovle å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ‰¾åˆ°éœ€è¦æŸ¥æ‰¾çš„ç¬¦å·åœ°å€ï¼Œå¹¶æœ€ç»ˆå›å¡«åˆ° GOT.PLT è¡¨çš„å¯¹åº”ä½ç½®ã€‚</li></ul><p>ç„¶åå†å›é¡¾ä¸€ä¸‹å»¶è¿Ÿç»‘å®šçš„æ•´ä¸ªè¿‡ç¨‹ã€‚</p><ol><li>å½“ demo å‡½æ•°æƒ³è¦è°ƒç”¨ global_func çš„æ—¶å€™ï¼Œç¨‹åºè°ƒç”¨å…ˆè¿›å…¥ global_func@plt ä¸­ï¼›</li><li>åœ¨ global_func@plt ä¸­ï¼Œä¼šå…ˆæ‰§è¡Œ jmpq *GOT.PLT[3] ï¼Œæ­¤æ—¶ GOT.PLT[3] é‡Œå­˜æ”¾çš„æ˜¯ global_func@plt é¡¹ä¸­çš„ç¬¬äºŒæ¡æŒ‡ä»¤ï¼Œå› æ­¤æ§åˆ¶æµç»§ç»­è¿”å›åˆ° global_func@plt ä¸­è¿›è¡Œæ‰§è¡Œï¼›</li><li>æ¥ä¸‹ä¼šæŠŠæ•°å€¼ 0x0 è¿›è¡Œå‹æ ˆï¼Œè¿™ä¸ªæ•°å€¼ä»£è¡¨äº† global_func çš„ IDã€‚ç„¶å jmp åˆ° PLT[0] çš„è¡¨é¡¹ä¸­è¿›è¡Œæ‰§è¡Œï¼›</li><li>åœ¨ PLT[0] ä¸­ï¼Œç»§ç»­å°† GOT.PLT[1] çš„å€¼ä¹Ÿå°±æ˜¯åº“æ–‡ä»¶çš„ ID è¿›è¡Œå‹æ ˆï¼Œç„¶åé€šè¿‡ GOT.PLT[2] è·³è½¬åˆ° _dl_runtime_resolve å‡½æ•°ä¸­ï¼›</li><li>dl_runtime_resolve åˆ™æ ¹æ®å­˜åœ¨æ ˆä¸Šçš„å‡½æ•° ID å’Œ so çš„ ID è¿›è¡Œå…¨å±€æœç´¢ï¼Œæ‰¾åˆ°å¯¹åº”çš„å‡½æ•°åœ°å€ä¹‹åå°±å¯ä»¥å°†å…¶é‡æ–°å¡«å……åˆ° GOT.PLT[3] ä¸­ï¼Œè¿™ä¸ªæ—¶å€™å»¶è¿ŸåŠ è½½çš„æ•´ä¸ªè¿‡ç¨‹å°±å®Œæˆäº†ï¼›</li><li>å½“ä¸‹ä¸€æ¬¡è°ƒç”¨ global_func çš„æ—¶å€™ï¼ŒCPU å°±å¯ä»¥é€šè¿‡ global_func@plt ä¸­ç¬¬ä¸€æ¡æŒ‡ä»¤ jmpq *GOT.PLT[3] ç›´æ¥è·³è½¬åˆ° global_func çš„çœŸå®åœ°å€ä¸­ã€‚</li></ol><h2 id="LoaderåŠ è½½æœºåˆ¶">LoaderåŠ è½½æœºåˆ¶</h2><p>ä¸€ä¸ªå®Œå…¨é™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶åˆ™ä¸éœ€è¦åŠ¨æ€é“¾æ¥å™¨çš„è¾…åŠ©ï¼Œæ‰€ä»¥å†…æ ¸åŠ è½½å®Œä¹‹åå¯ä»¥ç›´æ¥è·³è½¬åˆ°ç”¨æˆ·ä»£ç çš„å…¥å£ä¸­è¿›è¡Œæ‰§è¡Œã€‚è€ŒåŠ¨æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ a.outéœ€è¦é“¾æ¥å™¨ã€‚</p><p>Linuxç¯å¢ƒä¸‹ï¼š<strong><a href="http://xn--ld-tz2cl8o90bm2fn3vb1gq93j.so">åŠ¨æ€é“¾æ¥å™¨åä¸ºld.so</a>ï¼Œåˆå› ä¸ºå®ƒè¿˜è´Ÿè´£åŠ è½½åŠ¨æ€åº“æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰æ—¶ä¹Ÿå«å®ƒ loaderï¼Œæˆ–è€…åŠ è½½å™¨</strong>ã€‚</p><p>ld-linux.soå®Œæˆ4ä¸ªå·¥ä½œï¼š</p><ul><li>å¯åŠ¨åŠ¨æ€é“¾æ¥å™¨</li><li>æ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶çš„åŠ¨æ€é“¾æ¥ä¿¡æ¯ï¼Œå¯»æ‰¾å¹¶åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶ä¾èµ–çš„.soæ–‡ä»¶</li><li>å¯¹ç¬¦å·è¿›è¡Œè§£æå’Œé‡å®šä½</li><li>ä¾æ¬¡æ‰§è¡Œå„ä¸ª so çš„ init å‡½æ•°</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240419140052826.png" alt="image-20240419140052826"></p><h2 id="æ€»ç»“">æ€»ç»“</h2><ul><li>é‡å®šä½çš„æ¦‚å¿µï¼šç¼–è¯‘å™¨åœ¨æŠŠæºä»£ç ç¿»è¯‘æˆæ±‡ç¼–æŒ‡ä»¤çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºä¸çŸ¥é“å…¶ä»–ç¼–è¯‘å•å…ƒçš„ç¬¦å·çš„çœŸå®åœ°å€ï¼Œåœ¨å¼•ç”¨è¿™äº›ç¬¦å·çš„æ—¶å€™åªèƒ½ä½¿ç”¨å ä½ç¬¦ï¼ˆé€šå¸¸æ˜¯ 0ï¼‰æ¥ä»£æ›¿ã€‚è¿™äº›å ä½ç¬¦ç”±é“¾æ¥å™¨å¡«å……ã€‚å½“é“¾æ¥å™¨æŠŠæ‰€æœ‰çš„ç¬¦å·çš„ä½ç½®éƒ½ç¡®å®šå¥½ä»¥åï¼Œå†æŠŠçœŸå®åœ°å€å›å¡«åˆ°å ä½ç¬¦é‡Œã€‚</li><li>é‡å®šä½çš„æ—¶æœºï¼šç¼–è¯‘æœŸé‡å®šä½ï¼ŒåŠ è½½æœŸå’Œè¿è¡Œæ—¶é‡å®šä½ã€‚</li><li><a href="http://xn--ld-linux-is8mi61i6mi4th6n1dye1dzba832r.so">è´Ÿè´£åŠ¨æ€é“¾æ¥çš„æ˜¯ld-linux.so</a>ï¼Œå®ƒè¢«ç§°ä¸ºåŠ¨æ€é“¾æ¥å™¨ï¼Œä½†å› ä¸ºå®ƒè¿˜è´Ÿè´£åŠ è½½æ–‡ä»¶å·¥ä½œï¼Œæ‰€ä»¥ä¹Ÿè¢«äººç§°ä¸ºåŠ è½½å™¨æˆ–è€… loaderã€‚å®ƒçš„å·¥ä½œæµç¨‹ä¸»è¦æœ‰å¯åŠ¨ï¼ŒåŠ è½½ï¼Œé‡å®šä½å’Œ init å››ä¸ªæ­¥éª¤ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹</li><li>ã€ŠCSAPPã€‹</li><li>ã€ŠLINUX GNU C ç¨‹åºè§‚å¯Ÿ (ç½—ç§‹æ˜) ã€‹</li><li>ã€Šé«˜çº§C/C++ç¼–è¯‘æŠ€æœ¯ã€‹</li><li>æå®¢æ—¶é—´</li></ul>]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç®—æœºç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç½‘ç»œ:I/Oå¤šè·¯å¤ç”¨-[select/poll/epoll]</title>
      <link href="/posts/b032cb51.html"/>
      <url>/posts/b032cb51.html</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>å¾ˆæ—©ä¹‹å‰å†™webserveré¡¹ç›®å­¦ä¹ åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œåœ¨è¿™é‡ŒæŠŠæ ¸å¿ƒçŸ¥è¯†ç‚¹è®°è½½ä¸‹ ~</p><h1>é¢„å¤‡çŸ¥è¯†</h1><p><strong>å…¸å‹çš„ä¸€æ¬¡I/Oåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ</strong>ï¼š<strong>æ•°æ®å‡†å¤‡ å’Œ æ•°æ®è¯»å†™</strong></p><p>è§£é‡Šï¼šä½œä¸ºæœåŠ¡å™¨ï¼Œæ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¾—å…ˆç›‘å¬å®¢æˆ·ç«¯æœ‰æ²¡æœ‰æ•°æ®è¿‡æ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªçŠ¶æ€ï¼Œè¿˜æœ‰å°±æ˜¯æ•°æ®è¿‡æ¥äº†è¯¥æ€ä¹ˆå»è¯»å†™ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªçŠ¶æ€ã€‚</p><p>å®é™…ä¸Šï¼Œé˜»å¡ï¼Œéé˜»å¡ï¼ŒåŒæ­¥ï¼Œå¼‚æ­¥ï¼Œåˆ†åˆ«æ˜¯è¿™ä¸¤ç§çŠ¶æ€ä¸‹çš„ä½“ç³»ã€‚</p><p><strong>ç½‘ç»œI/Oé˜¶æ®µ1ï¼šæ•°æ®å‡†å¤‡</strong></p><p>æ•°æ®å‡†å¤‡ï¼šæ ¹æ®ç³»ç»ŸIOæ“ä½œçš„å°±ç»ªçŠ¶æ€ï¼Œåˆ†ä¸º</p><ol><li>é˜»å¡ ï¼š è®©è°ƒç”¨I/Oçš„çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ ï¼Œæ•°æ®å‡†å¤‡å¥½äº†å°±å”¤é†’</li><li>éé˜»å¡ï¼š ä¸ä¼šæ”¹å˜çº¿ç¨‹çš„çŠ¶æ€ï¼Œé€šè¿‡è¿”å›å€¼åˆ¤æ–­</li></ol><p>1- <strong>é˜»å¡</strong></p><p>sockfdç›¸å½“äºå°±æ˜¯ç³»ç»Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»£è¡¨1ä¸ªI/Oï¼Œåˆ›å»ºçš„æ—¶å€™é»˜è®¤æ˜¯é˜»å¡ï¼Œå½“æˆ‘è°ƒç”¨1ä¸ªé˜»å¡I/Oçš„è¯ï¼Œå¦‚æœsockfdä¸Šæ²¡æœ‰æ•°æ®å¯è¯»ï¼Œè¿™ä¸ªrecvä¸ä¼šè¿”å›ï¼Œ<strong>é€ æˆå½“å‰çº¿ç¨‹é˜»å¡</strong>ï¼Œç­‰å¾…sockfdä¸Šæœ‰æ•°æ®åˆ°æ¥ã€‚å¦‚æœè¿”å›äº†ï¼Œå°±æ˜¯æœ‰æ•°æ®å¯è¯»äº†ï¼Œæ¥ä¸‹å»å°±æ˜¯æ•°æ®è¯»å†™äº†ã€‚è¿”å›çš„æ˜¯æœ€ç»ˆè¯»çš„æ•°æ®çš„å¤§å°ã€‚ä¸€ç›´ç­‰ç€ã€‚</p><p>2- <strong>éé˜»å¡</strong></p><p>å¦‚æœæˆ‘ä»¬åœ¨åˆ›å»ºsockfdçš„æ—¶å€™è®¾ç½®æ˜¯éé˜»å¡ï¼Œrecvçš„ä½“ç°æ˜¯ï¼šå¦‚æœsockfdä¸Šæ²¡æœ‰æ•°æ®åˆ°æ¥çš„è¯ï¼Œrecvç›´æ¥è¿”å›å›æ¥ï¼Œ<strong>ä¸ä¼šé€ æˆå½“å‰çº¿ç¨‹é˜»å¡</strong>ã€‚sockfdæ²¡æœ‰æ•°æ®å‡†å¤‡å¥½çš„è¯ï¼Œä¸æ–­çš„ç©ºè½¬CPUã€‚</p><p>3 - <strong>é˜»å¡å’Œéé˜»å¡çš„è¿”å›å€¼</strong>ï¼ˆæ•°æ®å‡†å¤‡çš„è¿”å›å€¼ï¼‰</p><p>å¦‚æœsize==-1çš„è¯ï¼Œè¡¨ç¤ºé”™è¯¯ï¼š</p><ul><li><p>size==-1çœŸçš„é”™è¯¯ï¼Œæ˜¯ç³»ç»Ÿçš„å†…éƒ¨é”™è¯¯ï¼Œå¯èƒ½è¦close(sockfd)</p></li><li><p>å¦‚æœsize==-1&amp;&amp;errno==EAGAINï¼Œè¡¨ç¤ºæ­£å¸¸çš„éé˜»å¡è¿”å›ï¼Œsockfdä¸Šæ²¡æœ‰ç½‘ç»œäº‹ä»¶å‘ç”Ÿ</p></li></ul><p>å¦‚æœsize!= -1,æœ‰ä¸¤ç§æƒ…å†µ</p><ul><li>å¦‚æœsize= =0ï¼Œè¡¨ç¤ºç½‘ç»œå¯¹ç«¯å…³é—­äº†è¿æ¥ï¼Œå¯¹ç«¯ç›´æ¥close(sockfd)</li><li>å¦‚æœsize&gt;0ï¼Œå°±æ˜¯è¡¨ç¤ºæœ‰æ•°æ®è¿‡æ¥äº†ã€‚</li></ul><p><strong>ç½‘ç»œI/Oé˜¶æ®µ2ï¼šæ•°æ®è¯»å†™</strong></p><p>æ•°æ®è¯»å†™ï¼šæ ¹æ®åº”ç”¨ç¨‹åºå’Œå†…æ ¸çš„äº¤äº’æ–¹å¼ï¼Œåˆ†ä¸ºä¸¤ç§</p><ol><li>åŒæ­¥</li><li>å¼‚æ­¥</li></ol><p><strong>2ç§åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«</strong>ï¼šã€I/Oçš„åŒæ­¥å’Œå¼‚æ­¥ã€‘å’Œ ã€åº”ç”¨å±‚å¹¶å‘çš„åŒæ­¥å’Œå¼‚æ­¥ã€‘</p><p>1- <strong>IOåŒæ­¥</strong></p><p>åœ¨åº”ç”¨ç¨‹åºä¸Šè°ƒç”¨recvå‡½æ•°ï¼Œè¿™ä¸ªsockfdæˆ‘ä¸ç®¡å®ƒå·¥ä½œåœ¨é˜»å¡æ¨¡å¼è¿˜æ˜¯éé˜»å¡æ¨¡å¼ï¼ŒçœŸçš„æœ‰æ•°æ®å‡†å¤‡å¥½äº†ä¹‹åï¼ˆTCPçš„æ¥æ”¶ç¼“å†²åŒºæœ‰æ•°æ®äº†ï¼Œå°±æ˜¯æ•°æ®å¯è¯»äº†ï¼‰ï¼Œæˆ‘ä»¬è¦è¯»è¿™ä¸ªæ•°æ®ï¼Œè¿™ä¸ªbufæ˜¯ç”¨æˆ·å±‚è‡ªå·±å®šä¹‰çš„ï¼Œrecvå°±å¯ä»¥å¼€å§‹æ¥æ”¶äº†ï¼Œæ˜¯åº”ç”¨ç¨‹åºå¡åœ¨è¿™é‡Œrecv()ï¼Œä»å†…æ ¸çš„TCPæ¥æ”¶ç¼“å†²åŒºæ¬æ•°æ®åˆ°åº”ç”¨å±‚ä¸Šçš„bufï¼Œåœ¨æ¬çš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºsize&gt;0ï¼Œè¿™å°±è¡¨ç¤ºä»å†…æ ¸æ¬äº†å¤šå°‘å­—èŠ‚çš„æ•°æ®ï¼Œæˆ‘ä»¬å°±è¦è®¿é—®bufäº†ï¼Œæ²¡æ¬å®Œä¹‹å‰ï¼Œä¸ä¼šè¿›å…¥åˆ°ä¸‹é¢çš„ifè¯­å¥ã€‚æ¬å®Œäº†ï¼Œrecvæ‰è¿”å›è¿‡æ¥ï¼Œçœ‹çœ‹sizeæ˜¯å¤šå°‘ï¼Œå°±æ˜¯æ¬äº†å¤šå°‘æ•°æ®ï¼Œ<strong>å› æ­¤I/OåŒæ­¥æ˜¯åº”ç”¨ç¨‹åºæ¬çš„æ•°æ®ã€‚</strong></p><p>I/OåŒæ­¥çš„æ„æ€å°±æ˜¯ï¼š<strong>å½“æˆ‘è°ƒç”¨ç½‘ç»œI/Oçš„æ¥å£ï¼Œå½“I/Oé˜¶æ®µ1æ•°æ®å‡†å¤‡å¥½ä¹‹åï¼Œåœ¨æ•°æ®è¯»å†™çš„æ—¶å€™ï¼Œåº”ç”¨å±‚è‡ªå·±è°ƒç”¨ç½‘ç»œI/Oæ¥å£è‡ªå·±å»è¯»å†™ï¼Œéƒ½èŠ±åœ¨åº”ç”¨å±‚ä¸Š</strong>ã€‚</p><p>Noteï¼šrecvå’Œsendæ˜¯åŒæ­¥çš„I/Oæ¥å£</p><p>2 - <strong>I/Oå¼‚æ­¥</strong></p><p>å½“æˆ‘è¯·æ±‚å†…æ ¸çš„æ—¶å€™ï¼Œå…³å¿ƒsockfdä¸Šçš„æ•°æ®ï¼Œè¿œç«¯å¦‚æœå‘è¿‡æ¥æ•°æ®ï¼Œæˆ‘éœ€è¦è¯»sockfdä¸Šçš„æ•°æ®ï¼Œæˆ‘æœ‰ä¸€ä¸ªbufï¼Œåˆ°æ—¶å€™å¦‚æœæœ‰æ•°æ®æ¥äº†ï¼Œå†…æ ¸èƒ½ä¸èƒ½å¸®å¿™æŠŠæ•°æ®æ”¾åˆ°bufé‡Œé¢ï¼Œæˆ‘å†ç»™å†…æ ¸æ³¨å†Œä¸€ä¸ªsigioä¿¡å·ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº§åˆ«çš„å¼‚æ­¥çš„I/Oæ¥å£æ¥è¯´ï¼Œæˆ‘å…ˆå¡ç»™å†…æ ¸ä¸€ä¸ªsockfdï¼Œè¡¨ç¤ºå¯¹è¿™ä¸ªsockfdä¸Šçš„äº‹ä»¶æ„Ÿå…´è¶£ï¼Œå¦‚æœsockfdä¸Šæœ‰æ•°æ®å¯è¯»çš„è¯ï¼Œ<strong>éº»çƒ¦æ“ä½œç³»ç»Ÿå†…æ ¸æŠŠæ•°æ®æ¬åˆ°bufé‡Œé¢ã€‚</strong></p><p>å†…æ ¸æŠŠå†…æ ¸ç¼“å†²åŒº-sockfdå¯¹åº”çš„TCPæ¥æ”¶ç¼“å†²åŒºçš„æ•°æ®æ¬åˆ°bufé‡Œé¢ï¼Œæ¬å®Œä»¥åï¼Œé€šè¿‡ä¿¡å·sigioç»™åº”ç”¨ç¨‹åºé€šçŸ¥ä¸€ä¸‹ã€‚åº”ç”¨ç¨‹åºåœ¨è¿™æœŸé—´å¯ä»¥ç©è‡ªå·±çš„äº†ï¼Œåšä»»ä½•äº‹æ¸…éƒ½å¯ä»¥ã€‚</p><p><strong>é€šçŸ¥æ˜¯å¼‚æ­¥æœ€å¤§çš„æ ‡è¯†ï¼Œæ˜¯å¼‚æ­¥å°±æœ‰é€šçŸ¥</strong></p><p>linuxçš„aio_readï¼Œaio_writeå°±æ˜¯å…¸å‹çš„linuxç»™æˆ‘ä»¬æä¾›çš„å¼‚æ­¥I/Oæ¥å£ã€‚</p><p>é™ˆç¡•å¤§ä½¬çš„åŸè¯ï¼š<strong>åœ¨å¤„ç† IO çš„æ—¶å€™ï¼Œé˜»å¡å’Œéé˜»å¡éƒ½æ˜¯åŒæ­¥ IOã€‚åªæœ‰ä½¿ç”¨äº†ç‰¹æ®Šçš„ API æ‰æ˜¯å¼‚æ­¥IO</strong>ã€‚</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/5.png" alt=""></p><h1>Linuxäº”ç§I/Oæ¨¡å‹</h1><ul><li><p>é˜»å¡IO</p><ul><li>è°ƒç”¨è€…è°ƒç”¨äº†æŸä¸ªå‡½æ•°ï¼Œç­‰å¾…è¿™ä¸ªå‡½æ•°è¿”å›ï¼ŒæœŸé—´ä»€ä¹ˆéƒ½ä¸åšï¼Œä¸åœæ£€æŸ¥è¿™ä¸ªå‡½æ•°æœ‰æ²¡æœ‰è¿”å›ï¼Œå¿…é¡»ç­‰è¯¥å‡½æ•°è¿”å›æ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥åŠ¨ä½œã€‚</li></ul></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/6.png" alt=""></p><ul><li><p>éé˜»å¡IO</p><ul><li>æ¯éš”ä¸€æ®µæ—¶é—´å»æ£€æµ‹IOæ—¶é—´æ˜¯å¦å°±ç»ªï¼Œæ²¡æœ‰å°±ç»ªå°±å¯ä»¥è¿›è¡Œå…¶ä»–æ“ä½œã€‚</li><li>éé˜»å¡IOæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ€»æ˜¯ç«‹å³è¿”å›ï¼Œä¸ç®¡äº‹ä»¶æ˜¯å¦å·²ç»å‘ç”Ÿï¼Œè‹¥æ²¡å‘ç”Ÿåˆ™è¿”å›-1ï¼Œæ­¤æ—¶æ ¹æ®errnoåŒºåˆ†ä¸¤ç§æƒ…å†µï¼Œå¯¹äºacceptã€recvå’Œsendï¼Œäº‹ä»¶æœªå‘ç”Ÿæ—¶ï¼Œerrnoè¢«è®¾ç½®ä¸ºEAGAINã€‚</li></ul></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/7.png" alt=""></p><ul><li><p>IOå¤ç”¨</p></li><li><p>selectã€pollã€epollå‡½æ•°å®ç°ï¼Œè¿™äº›å‡½æ•°ä¹Ÿä¼šä½¿è¿›ç¨‹é˜»å¡ï¼Œä½†æ˜¯å’Œé˜»å¡IOä¸åŒçš„æ˜¯ï¼Œè¿™äº›å‡½æ•°å¯ä»¥åŒæ—¶é˜»å¡å¤šä¸ªIOæ“ä½œã€‚</p><ul><li><p>å¯ä»¥åŒæ—¶å¯¹å¤šä¸ªè¯»æ“ä½œã€å†™æ“ä½œçš„IOå‡½æ•°è¿›è¡Œæ£€æµ‹ï¼Œç›´åˆ°æœ‰æ•°æ®å¯è¯»æˆ–å¯å†™æ—¶ï¼Œæ‰çœŸæ­£è°ƒç”¨IOæ“ä½œå‡½æ•°.</p></li><li><p><strong>IOå¤šè·¯å¤ç”¨çš„å«ä¹‰å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹èƒ½å¤„ç†å¤šä¸ªsocket</strong></p></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/8.png" alt=""></p></li><li><p>ä¿¡å·é©±åŠ¨IO</p><ul><li>æ³¨å†Œæ–°å·å¤„ç†å‡½æ•°ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œå¹¶ä¸é˜»å¡ï¼Œå½“IOäº‹ä»¶å°±ç»ªæ—¶ï¼Œè¿›ç¨‹å—åˆ°SIGIOæ–°å·ï¼Œç„¶åå¤„ç†IOäº‹ä»¶ã€‚</li><li><strong>å†…æ ¸åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯å¼‚æ­¥ï¼Œåœ¨ç¬¬äºŒä¸ªé˜¶æ®µæ˜¯åŒæ­¥ã€‚</strong></li><li>ä¸éé˜»å¡IOçš„åŒºåˆ«åœ¨äºå®ƒæä¾›äº†æ¶ˆæ¯é€šçŸ¥æœºåˆ¶ï¼Œä¸éœ€è¦ç”¨æˆ·è¿›ç¨‹ä¸æ–­çš„è½®è¯¢æ£€æŸ¥ï¼Œå‡å°‘äº†ç³»ç»ŸAPIçš„è°ƒç”¨æ¬¡æ•°ï¼Œæé«˜äº†æ•ˆç‡ã€‚</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/9.png" alt=""></p></li><li><p>å¼‚æ­¥IO</p><ul><li>LInuxä¸­ï¼Œè°ƒç”¨aio_readå‡½æ•°å‘Šè¯‰å†…æ ¸æè¿°å­—ç¼“å†²åŒºæŒ‡é’ˆå’Œç¼“å†²åŒºå¤§å° ã€æ–‡ä»¶åç§»åŠé€šçŸ¥çš„æ–¹å¼ï¼Œç„¶åç«‹å³è¿”å›ï¼Œå½“å†…æ ¸å°†æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºåï¼Œå†é€šçŸ¥åº”ç”¨ç¨‹åºã€‚</li></ul></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/10.png" alt=""></p><h1>IOå¤šè·¯å¤ç”¨</h1><h2 id="select">select</h2><p><strong>ç®€å•ç†è§£ï¼š</strong></p><ul><li>å§”æ‰˜å†…æ ¸è¿›è¡Œæ“ä½œ</li><li>åªä¼šé€šçŸ¥æœ‰å‡ ä¸ªä»»åŠ¡å¯ç”¨ï¼Œä½†ä¸çŸ¥é“å…·ä½“å“ªå‡ ä¸ªä»»åŠ¡ï¼Œè¿˜éœ€éå†ï¼ˆä¸NIOæ¨¡å‹ç•¥æœ‰ä¸åŒï¼‰</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/11.png" alt=""></p><p><strong>ä¸»æ—¨æ€æƒ³</strong></p><ol><li>é¦–å…ˆè¦æ„é€ ä¸€ä¸ªå…³äºæ–‡ä»¶æè¿°ç¬¦çš„åˆ—è¡¨ï¼Œå°†è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°è¯¥åˆ—è¡¨ä¸­</li><li>è°ƒç”¨ä¸€ä¸ªç³»ç»Ÿå‡½æ•°(<code>select</code>)ï¼Œç›‘å¬è¯¥åˆ—è¡¨ä¸­çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç›´åˆ°è¿™äº›æè¿°ç¬¦ä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿›è¡ŒI/Oæ“ä½œæ—¶ï¼Œè¯¥å‡½æ•°æ‰è¿”å›<ul><li>è¿™ä¸ªå‡½æ•°æ˜¯é˜»å¡</li><li>å‡½æ•°å¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ£€æµ‹çš„æ“ä½œæ˜¯ç”±å†…æ ¸å®Œæˆçš„</li></ul></li><li>åœ¨è¿”å›æ—¶ï¼Œå®ƒä¼šå‘Šè¯‰è¿›ç¨‹æœ‰å¤šå°‘ï¼ˆå“ªäº›ï¼‰æè¿°ç¬¦è¦è¿›è¡ŒI/Oæ“ä½œ</li></ol><p><strong>ç”¨æ³•</strong></p>  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">select</span><span class="params">(<span class="type">int</span> nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, <span class="keyword">struct</span> timeval *timeout)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å‚æ•°æ–‡ä»¶æè¿°ç¬¦fdå¯¹åº”çš„æ ‡å¿—ä½è®¾ç½®ä¸º0 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="type">int</span> fd, fd_set *set)</span></span>; </span><br><span class="line"><span class="comment">// åˆ¤æ–­fdå¯¹åº”çš„æ ‡å¿—ä½æ˜¯0è¿˜æ˜¯1ï¼Œ è¿”å›å€¼ ï¼š fdå¯¹åº”çš„æ ‡å¿—ä½çš„å€¼ï¼Œ0ï¼Œè¿”å›0ï¼Œ 1ï¼Œè¿”å›1 </span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set *set)</span></span>; </span><br><span class="line"><span class="comment">// å°†å‚æ•°æ–‡ä»¶æè¿°ç¬¦fd å¯¹åº”çš„æ ‡å¿—ä½ï¼Œè®¾ç½®ä¸º1 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FD_SET</span><span class="params">(<span class="type">int</span> fd, fd_set *set)</span></span>;</span><br><span class="line"><span class="comment">// fd_setä¸€å…±æœ‰1024 bit, å…¨éƒ¨åˆå§‹åŒ–ä¸º0 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *set)</span></span>;</span><br></pre></td></tr></table></figure><ul><li><p><code>int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout); </code></p><ul><li><p>é€šè¿‡<code>man select</code>æŸ¥çœ‹å¸®åŠ©</p></li><li><p>å‚æ•°</p><ul><li><code>nfds</code>ï¼šå§”æ‰˜å†…æ ¸æ£€æµ‹çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦çš„å€¼ + 1ï¼ˆ+1æ˜¯å› ä¸ºéå†æ˜¯ä¸‹æ ‡ä»0å¼€å§‹ï¼Œforå¾ªç¯ï¼œè®¾å®šï¼‰</li><li><code>readfds</code>ï¼šè¦æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦çš„è¯»çš„é›†åˆï¼Œå§”æ‰˜å†…æ ¸æ£€æµ‹å“ªäº›æ–‡ä»¶æè¿°ç¬¦çš„è¯»çš„å±æ€§<ul><li>ä¸€èˆ¬æ£€æµ‹è¯»æ“ä½œ</li><li>å¯¹åº”çš„æ˜¯å¯¹æ–¹å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œå› ä¸ºè¯»æ˜¯è¢«åŠ¨çš„æ¥æ”¶æ•°æ®ï¼Œæ£€æµ‹çš„å°±æ˜¯è¯»ç¼“å†²åŒº</li><li>æ˜¯ä¸€ä¸ªä¼ å…¥ä¼ å‡ºå‚æ•°</li></ul></li><li><code>writefds</code>ï¼šè¦æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦çš„å†™çš„é›†åˆï¼Œå§”æ‰˜å†…æ ¸æ£€æµ‹å“ªäº›æ–‡ä»¶æè¿°ç¬¦çš„å†™çš„å±æ€§<ul><li>å§”æ‰˜å†…æ ¸æ£€æµ‹å†™ç¼“å†²åŒºæ˜¯ä¸æ˜¯è¿˜å¯ä»¥å†™æ•°æ®ï¼ˆä¸æ»¡çš„å°±å¯ä»¥å†™ï¼‰</li></ul></li><li><code>exceptfds</code>ï¼šæ£€æµ‹å‘ç”Ÿå¼‚å¸¸çš„æ–‡ä»¶æè¿°ç¬¦çš„é›†åˆï¼Œä¸€èˆ¬ä¸ç”¨</li><li><code>timeout</code>ï¼šè®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œå«ä¹‰è§**<code>select</code>å‚æ•°åˆ—è¡¨è¯´æ˜**<ul><li><code>NULL</code>ï¼šæ°¸ä¹…é˜»å¡ï¼Œç›´åˆ°æ£€æµ‹åˆ°äº†æ–‡ä»¶æè¿°ç¬¦æœ‰å˜åŒ–</li><li><code>tv_sec = tv_usec = 0</code>ï¼Œ ä¸é˜»å¡</li><li><code> tv_sec &gt; 0,tv_usec &gt; 0</code>ï¼šé˜»å¡å¯¹åº”çš„æ—¶é—´</li></ul></li></ul></li><li><p>è¿”å›å€¼</p><ul><li>-1ï¼šå¤±è´¥</li><li>&gt;0(n)ï¼šæ£€æµ‹çš„é›†åˆä¸­æœ‰nä¸ªæ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿäº†å˜åŒ–</li></ul></li></ul></li><li><p><code>select</code>å‚æ•°åˆ—è¡¨è¯´æ˜</p><ul><li><p><code>fd_set</code>ï¼šæ˜¯ä¸€å—å›ºå®šå¤§å°çš„ç¼“å†²åŒº(ç»“æ„ä½“)ï¼Œ<code>sizeof(fd_set)=128</code>ï¼Œå³å¯¹åº”1024ä¸ªæ¯”ç‰¹ä½</p></li><li><p><code>timeval </code>ï¼šç»“æ„ä½“ç±»å‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">timeval</span> &#123; </span><br><span class="line">    <span class="type">long</span> tv_sec; <span class="comment">/* seconds */</span> </span><br><span class="line">    <span class="type">long</span> tv_usec; <span class="comment">/* microseconds */</span> </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong>å·¥ä½œè¿‡ç¨‹åˆ†æ</strong></p><p>1.åˆå§‹è®¾å®š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/12.png" alt=""></p><p>2.è®¾ç½®ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ï¼Œå°†<code>fd_set</code>é›†åˆç›¸åº”ä½ç½®ä¸º1</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/13.png" alt=""></p><p>3.è°ƒç”¨<code>select</code>å§”æ‰˜å†…æ ¸æ£€æµ‹</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/14.png" alt=""></p><p>4.å†…æ ¸æ£€æµ‹å®Œæ¯•åï¼Œè¿”å›ç»™ç”¨æˆ·æ€ç»“æœ</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/15.png" alt=""></p><blockquote><p><strong>ä»£ç å®ç°</strong></p></blockquote><p><strong>æ³¨æ„äº‹é¡¹</strong></p><ul><li>selectä¸­éœ€è¦çš„ç›‘å¬é›†åˆéœ€è¦ä¸¤ä¸ª<ul><li>ä¸€ä¸ªæ˜¯ç”¨æˆ·æ€çœŸæ­£éœ€è¦ç›‘å¬çš„é›†åˆ<code>rSet</code></li><li>ä¸€ä¸ªæ˜¯å†…æ ¸æ€è¿”å›ç»™ç”¨æˆ·æ€çš„ä¿®æ”¹é›†åˆ<code>tmpSet</code></li></ul></li><li>éœ€è¦å…ˆåˆ¤æ–­ç›‘å¬æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å‘ç”Ÿæ”¹å˜<ul><li>å¦‚æœæ”¹å˜äº†ï¼Œè¯´æ˜æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼Œæ­¤æ—¶éœ€è¦å°†<strong>æ–°çš„è¿æ¥æ–‡ä»¶æè¿°ç¬¦åŠ å…¥åˆ°<code>rSet</code></strong>ï¼Œå¹¶æ›´æ–°æœ€å¤§æ–‡ä»¶æè¿°ç¬¦</li><li>å¦‚æœæ²¡æœ‰æ”¹å˜ï¼Œè¯´æ˜æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥</li></ul></li><li>ç”±äº<code>select</code>æ— æ³•ç¡®åˆ‡çŸ¥é“å“ªäº›æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥éœ€è¦æ‰§è¡Œéå†æ“ä½œï¼Œä½¿ç”¨<code>FD_ISSET</code>åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†æ”¹å˜</li><li>å¦‚æœå®¢æˆ·ç«¯æ–­å¼€äº†è¿æ¥ï¼Œéœ€è¦ä»<code>rSet</code>ä¸­æ¸…é™¤éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦</li><li>ç¨‹åºå­˜åœ¨çš„é—®é¢˜ï¼šä¸­é—´çš„ä¸€äº›æ–­å¼€è¿æ¥åï¼Œæœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ€ä¹ˆæ›´æ–°ï¼Ÿ=&gt;<strong>ä¼°è®¡ä¸æ›´æ–°ï¼Œæ¯æ¬¡éƒ½ä¼šéå†åˆ°ä¹‹å‰çš„æœ€å¤§å€¼å¤„</strong>ï¼Œè§£å†³æ–¹æ¡ˆè§<a href="https://gitee.com/Pengge_666/linuxServer/blob/master/doc/04Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B.md###%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E6%80%9D%E8%80%83">é«˜å¹¶å‘ä¼˜åŒ–æ€è€ƒ</a></li></ul><p>æœåŠ¡å™¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVERIP <span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 6789</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºsocketï¼ˆç”¨äºç›‘å¬çš„å¥—æ¥å­—ï¼‰</span></span><br><span class="line">    <span class="type">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (listenfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. ç»‘å®š</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server_addr;</span><br><span class="line">    server_addr.sin_family = PF_INET;</span><br><span class="line">    <span class="comment">// ç‚¹åˆ†åè¿›åˆ¶è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åº</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, SERVERIP, &amp;server_addr.sin_addr.s_addr);</span><br><span class="line">    <span class="comment">// æœåŠ¡ç«¯ä¹Ÿå¯ä»¥ç»‘å®š0.0.0.0å³ä»»æ„åœ°å€</span></span><br><span class="line">    <span class="comment">// server_addr.sin_addr.s_addr = INADDR_ANY;</span></span><br><span class="line">    server_addr.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;server_addr, <span class="built_in">sizeof</span>(server_addr));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. ç›‘å¬</span></span><br><span class="line">    ret = <span class="built_in">listen</span>(listenfd, <span class="number">8</span>); <span class="comment">// åŒæ—¶æœ€å¤šèƒ½å¤„ç†8ä¸ªå®¢æˆ·ç«¯</span></span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºè¯»æ£€æµ‹é›†åˆ</span></span><br><span class="line">    <span class="comment">// rSetç”¨äºè®°å½•æ­£åœ¨çš„ç›‘å¬é›†åˆï¼ŒtmpSetç”¨äºè®°å½•åœ¨è½®è®­è¿‡ç¨‹ä¸­ç”±å†…æ ¸æ€è¿”å›åˆ°ç”¨æˆ·æ€çš„é›†åˆ</span></span><br><span class="line">    fd_set rSet, tmpSet;</span><br><span class="line">    <span class="comment">// æ¸…ç©º</span></span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;rSet);</span><br><span class="line">    <span class="comment">// å°†ç›‘å¬æ–‡ä»¶æè¿°ç¬¦åŠ å…¥</span></span><br><span class="line">    <span class="built_in">FD_SET</span>(listenfd, &amp;rSet);</span><br><span class="line">    <span class="comment">// æ­¤æ—¶æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦ä¸ºç›‘å¬æè¿°ç¬¦</span></span><br><span class="line">    <span class="type">int</span> maxfd = listenfd;</span><br><span class="line">    <span class="comment">// ä¸æ–­å¾ªç¯ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        tmpSet = rSet;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨selectï¼Œè®¾ç½®ä¸ºæ°¸ä¹…é˜»å¡ï¼Œæœ‰æ–‡ä»¶æè¿°ç¬¦å˜åŒ–æ‰è¿”å›</span></span><br><span class="line">        <span class="type">int</span> num = <span class="built_in">select</span>(maxfd + <span class="number">1</span>, &amp;tmpSet, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰æ— æ–‡ä»¶æè¿°ç¬¦æœ‰å˜åŒ–ï¼Œæ‰§è¡Œä¸‹ä¸€æ¬¡éå†</span></span><br><span class="line">            <span class="comment">// åœ¨æœ¬æ¬¡è®¾ç½®ä¸­æ— æ•ˆï¼ˆå› ä¸ºselectè¢«è®¾ç½®ä¸ºæ°¸ä¹…é˜»å¡ï¼‰</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é¦–å…ˆåˆ¤æ–­ç›‘å¬æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼ˆå³æ˜¯å¦æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">FD_ISSET</span>(listenfd, &amp;tmpSet)) &#123;</span><br><span class="line">                <span class="comment">// 4. æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">                <span class="keyword">struct</span> sockaddr_in client_addr;</span><br><span class="line">                <span class="type">socklen_t</span> client_addr_len = <span class="built_in">sizeof</span>(client_addr);</span><br><span class="line">                <span class="comment">// è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ socket æ–‡ä»¶æè¿°ç¬¦ connfdï¼Œé€šè¿‡è¿™ä¸ª connfd å¯ä»¥è¿›è¡Œå’Œå®¢æˆ·ç«¯çš„é€šä¿¡ã€‚</span></span><br><span class="line">                <span class="type">int</span> connfd = <span class="built_in">accept</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;client_addr_len);</span><br><span class="line">                <span class="keyword">if</span> (connfd == <span class="number">-1</span>) &#123;</span><br><span class="line">                    <span class="built_in">perror</span>(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è¾“å‡ºå®¢æˆ·ç«¯ä¿¡æ¯ï¼ŒIPç»„æˆè‡³å°‘16ä¸ªå­—ç¬¦ï¼ˆåŒ…å«ç»“æŸç¬¦ï¼‰</span></span><br><span class="line">                <span class="type">char</span> client_ip[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="built_in">inet_ntop</span>(AF_INET, &amp;client_addr.sin_addr.s_addr, client_ip, <span class="built_in">sizeof</span>(client_ip));</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">short</span> client_port = <span class="built_in">ntohs</span>(client_addr.sin_port);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;ip:%s, port:%d\n&quot;</span>, client_ip, client_port);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">FD_SET</span>(connfd, &amp;rSet);</span><br><span class="line">                <span class="comment">// æ›´æ–°æœ€å¤§æ–‡ä»¶ç¬¦</span></span><br><span class="line">                maxfd = maxfd &gt; connfd ? maxfd : connfd;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// éå†é›†åˆåˆ¤æ–­æ˜¯å¦æœ‰å˜åŠ¨ï¼Œå¦‚æœæœ‰å˜åŠ¨ï¼Œé‚£ä¹ˆé€šä¿¡</span></span><br><span class="line">            <span class="type">char</span> recv_buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = listenfd + <span class="number">1</span>; i &lt;= maxfd; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">FD_ISSET</span>(i, &amp;tmpSet)) &#123;</span><br><span class="line">                    ret = <span class="built_in">read</span>(i, recv_buf, <span class="built_in">sizeof</span>(recv_buf));</span><br><span class="line">                    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">                        <span class="built_in">perror</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;recv server data : %s\n&quot;</span>, recv_buf);</span><br><span class="line">                        <span class="built_in">write</span>(i, recv_buf, <span class="built_in">strlen</span>(recv_buf));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// è¡¨ç¤ºå®¢æˆ·ç«¯æ–­å¼€è¿æ¥</span></span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;client closed...\n&quot;</span>);</span><br><span class="line">                        <span class="built_in">close</span>(i);</span><br><span class="line">                        <span class="built_in">FD_CLR</span>(i, &amp;rSet);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(listenfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šä¿—æ¥è¯´ï¼Œå°±æ˜¯æœåŠ¡å™¨å…ˆè®¾ç½®ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸“é—¨ç”¨äºç›‘å¬æ˜¯å¦æœ‰å®¢æˆ·ç«¯è¿›æ¥ï¼Œåœ¨å…¶ä¸Šç»‘å®šIPå’Œç«¯å£å·ï¼Œäº¤ç»™ç»™å†…æ ¸è¿›è¡Œç›‘å¬ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿›æ¥åˆ™è¿™ä¸ªä¸“é—¨ç”¨äºç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦å°±ä¼šå‘ç”Ÿå˜åŒ–ã€‚ä¹‹åï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿›æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæè¿°ç¬¦ç”¨äºä¸è¿™ä¸ªæ–°è¿›æ¥çš„å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ã€‚</p><p>ã€è¿™é‡Œä¸¾ä¸ªä¸æ˜¯å¾ˆæ°å½“çš„ä¾‹å­ï¼Œlistenedæè¿°ç¬¦å°±åƒé…’åº—é—¨å£è¿å®¾äººå‘˜ï¼Œå½“æœ‰å®¢äººæ¥çš„æ—¶å€™ï¼Œå¸¦è¿›é…’åº—çš„åŒ…é—´ï¼Œä¹‹åç”±å…¶ä»–çš„æœåŠ¡äººå‘˜æ¥æ¥ç®¡ã€‚ä¹‹åè¿™ä½è¿å®¾äººå‘˜åˆå›åˆ°åŸæ¥çš„å·¥ä½œå²—ä½ä¸Šã€‘</p><p><strong>å®¢æˆ·ç«¯</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVERIP <span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 6789</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºsocketï¼ˆç”¨äºé€šä¿¡çš„å¥—æ¥å­—ï¼‰</span></span><br><span class="line">    <span class="type">int</span> connfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (connfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. è¿æ¥æœåŠ¡å™¨ç«¯</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server_addr;</span><br><span class="line">    server_addr.sin_family = PF_INET;</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, SERVERIP, &amp;server_addr.sin_addr.s_addr);</span><br><span class="line">    server_addr.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">connect</span>(connfd, (<span class="keyword">struct</span> sockaddr*)&amp;server_addr, <span class="built_in">sizeof</span>(server_addr));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. é€šä¿¡</span></span><br><span class="line">    <span class="type">char</span> recv_buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// å‘é€æ•°æ®</span></span><br><span class="line">        <span class="type">char</span> *send_buf = <span class="string">&quot;client message&quot;</span>;</span><br><span class="line">        <span class="built_in">write</span>(connfd, send_buf, <span class="built_in">strlen</span>(send_buf));</span><br><span class="line">        <span class="comment">// æ¥æ”¶æ•°æ®</span></span><br><span class="line">        ret = <span class="built_in">read</span>(connfd, recv_buf, <span class="built_in">sizeof</span>(recv_buf));</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;recv server data : %s\n&quot;</span>, recv_buf);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¡¨ç¤ºå®¢æˆ·ç«¯æ–­å¼€è¿æ¥</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;client closed...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¼‘çœ çš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„è§‚å¯Ÿï¼Œæ”¾åœ¨æ­¤å¤„å¯ä»¥è§£å†³read: Connection reset by peeré—®é¢˜</span></span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line">    <span class="built_in">close</span>(connfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>å­˜åœ¨é—®é¢˜</strong></p></blockquote><ul><li>æ¯æ¬¡è°ƒç”¨selectï¼Œéƒ½éœ€è¦æŠŠfdé›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¼šå¾ˆå¤§</li><li>åŒæ—¶æ¯æ¬¡è°ƒç”¨selectéƒ½éœ€è¦åœ¨å†…æ ¸éå†ä¼ é€’è¿›æ¥çš„æ‰€æœ‰fdï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¹Ÿå¾ˆå¤§</li><li>selectæ”¯æŒçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¤ªå°äº†ï¼Œé»˜è®¤æ˜¯1024</li><li>fdsé›†åˆä¸èƒ½é‡ç”¨ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡ç½®</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/16.png" alt=""></p><h2 id="poll">poll</h2><p><strong>ä¸»æ—¨æ€æƒ³</strong></p><ul><li>ç”¨ä¸€ä¸ª<strong>ç»“æ„ä½“è®°å½•æ–‡ä»¶</strong>æè¿°ç¬¦é›†åˆï¼Œå¹¶è®°å½•ç”¨æˆ·æ€çŠ¶æ€å’Œå†…æ ¸æ€çŠ¶æ€</li></ul><p><strong>å‡½æ•°æ¦‚è¿°</strong></p><ul><li><p>æ¦‚è§ˆ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span> </span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pollfd</span> &#123; </span><br><span class="line">    <span class="type">int</span> fd; <span class="comment">/* å§”æ‰˜å†…æ ¸æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦ */</span> </span><br><span class="line">    <span class="type">short</span> events; <span class="comment">/* å§”æ‰˜å†…æ ¸æ£€æµ‹æ–‡ä»¶æè¿°ç¬¦çš„ä»€ä¹ˆäº‹ä»¶ */</span> </span><br><span class="line">    <span class="type">short</span> revents; <span class="comment">/* æ–‡ä»¶æè¿°ç¬¦å®é™…å‘ç”Ÿçš„äº‹ä»¶ */</span> </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">poll</span><span class="params">(<span class="keyword">struct</span> pollfd *fds, <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p><code>int poll(struct pollfd *fds, nfds_t nfds, int timeout);</code></p><ul><li><p>é€šè¿‡<code>man poll</code>æŸ¥çœ‹å¸®åŠ©</p></li><li><p>å‚æ•°</p><ul><li><code>fds</code>ï¼šæ˜¯ä¸€ä¸ª<code>struct pollfd</code> ç»“æ„ä½“æ•°ç»„ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦çš„é›†åˆ</li><li><code>nfds</code>ï¼šè¿™ä¸ªæ˜¯ç¬¬ä¸€ä¸ªå‚æ•°æ•°ç»„ä¸­æœ€åä¸€ä¸ªæœ‰æ•ˆå…ƒç´ çš„ä¸‹æ ‡ + 1</li><li>timeoutï¼šé˜»å¡æ—¶é•¿<ul><li>0ï¼šä¸é˜»å¡</li><li>-1ï¼šé˜»å¡ï¼Œå½“æ£€æµ‹åˆ°éœ€è¦æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦æœ‰å˜åŒ–ï¼Œè§£é™¤é˜»å¡</li><li>&gt;0ï¼šå…·ä½“çš„é˜»å¡æ—¶é•¿(ms)</li></ul></li></ul></li><li><p>è¿”å›å€¼</p><ul><li>-1ï¼šå¤±è´¥</li><li>&gt;0(n)ï¼šæ£€æµ‹çš„é›†åˆä¸­æœ‰nä¸ªæ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿäº†å˜åŒ–</li></ul></li></ul></li><li><p><code>events</code>åŠ<code>revents</code>å–å€¼ï¼Œå¦‚æœæœ‰å¤šä¸ªäº‹ä»¶éœ€è¦æ£€æµ‹ï¼Œç”¨<code>|</code>å³å¯ï¼Œå¦‚åŒæ—¶æ£€æµ‹è¯»å’Œå†™ï¼š<code>POLLIN | POLLOUT</code></p></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/17.png" alt=""></p><blockquote><p><strong>ä»£ç å®ç°</strong></p></blockquote><p><strong>æ³¨æ„äº‹é¡¹</strong></p><ul><li><code>nfds</code>è¡¨ç¤ºçš„ç›‘å¬æ–‡ä»¶æè¿°ç¬¦çš„ä¸‹æ ‡ï¼Œæ‰€ä»¥åœ¨éå†æ—¶ï¼Œéœ€è¦ä½¿ç”¨<code>fds[i].fd</code>å–å¾—ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦</li><li>å¦‚ä½•ä¼˜é›…çš„æ›´æ–°nfdsä»£ç ä¸­ä½¿ç”¨è¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ä½œä¸ºæ›¿ä»£æ›´æ–°</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVERIP <span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 6789</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºsocketï¼ˆç”¨äºç›‘å¬çš„å¥—æ¥å­—ï¼‰</span></span><br><span class="line">    <span class="type">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (listenfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. ç»‘å®š</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server_addr;</span><br><span class="line">    server_addr.sin_family = PF_INET;</span><br><span class="line">    <span class="comment">// ç‚¹åˆ†åè¿›åˆ¶è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åº</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, SERVERIP, &amp;server_addr.sin_addr.s_addr);</span><br><span class="line">    <span class="comment">// æœåŠ¡ç«¯ä¹Ÿå¯ä»¥ç»‘å®š0.0.0.0å³ä»»æ„åœ°å€</span></span><br><span class="line">    <span class="comment">// server_addr.sin_addr.s_addr = INADDR_ANY;</span></span><br><span class="line">    server_addr.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;server_addr, <span class="built_in">sizeof</span>(server_addr));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. ç›‘å¬</span></span><br><span class="line">    ret = <span class="built_in">listen</span>(listenfd, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">pollfd</span> fds[<span class="number">1024</span>];</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1024</span>; i++) &#123;</span><br><span class="line">        fds[i].fd = <span class="number">-1</span>;</span><br><span class="line">        fds[i].events = POLLIN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†ç›‘å¬æ–‡ä»¶æè¿°ç¬¦åŠ å…¥</span></span><br><span class="line">    fds[<span class="number">0</span>].fd = listenfd;</span><br><span class="line">    <span class="type">int</span> nfds = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ä¸æ–­å¾ªç¯ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨pollï¼Œè®¾ç½®ä¸ºæ°¸ä¹…é˜»å¡ï¼Œæœ‰æ–‡ä»¶æè¿°ç¬¦å˜åŒ–æ‰è¿”å›</span></span><br><span class="line">        <span class="type">int</span> num = <span class="built_in">poll</span>(fds, nfds + <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰æ— æ–‡ä»¶æè¿°ç¬¦æœ‰å˜åŒ–ï¼Œæ‰§è¡Œä¸‹ä¸€æ¬¡éå†</span></span><br><span class="line">            <span class="comment">// åœ¨æœ¬æ¬¡è®¾ç½®ä¸­æ— æ•ˆï¼ˆå› ä¸ºselectè¢«è®¾ç½®ä¸ºæ°¸ä¹…é˜»å¡ï¼‰</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é¦–å…ˆåˆ¤æ–­ç›‘å¬æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼ˆå³æ˜¯å¦æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (fds[<span class="number">0</span>].revents &amp; POLLIN) &#123;</span><br><span class="line">                <span class="comment">// 4. æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">                <span class="keyword">struct</span> sockaddr_in client_addr;</span><br><span class="line">                <span class="type">socklen_t</span> client_addr_len = <span class="built_in">sizeof</span>(client_addr);</span><br><span class="line">                <span class="type">int</span> connfd = <span class="built_in">accept</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;client_addr_len);</span><br><span class="line">                <span class="keyword">if</span> (connfd == <span class="number">-1</span>) &#123;</span><br><span class="line">                    <span class="built_in">perror</span>(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è¾“å‡ºå®¢æˆ·ç«¯ä¿¡æ¯ï¼ŒIPç»„æˆè‡³å°‘16ä¸ªå­—ç¬¦ï¼ˆåŒ…å«ç»“æŸç¬¦ï¼‰</span></span><br><span class="line">                <span class="type">char</span> client_ip[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="built_in">inet_ntop</span>(AF_INET, &amp;client_addr.sin_addr.s_addr, client_ip, <span class="built_in">sizeof</span>(client_ip));</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">short</span> client_port = <span class="built_in">ntohs</span>(client_addr.sin_port);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;ip:%s, port:%d\n&quot;</span>, client_ip, client_port);</span><br><span class="line">                <span class="comment">// éå†é›†åˆ, å°†æ–°çš„éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦åŠ å…¥é›†åˆ</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">1024</span>; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fds[i].fd == <span class="number">-1</span>) &#123;</span><br><span class="line">                        fds[i].fd = connfd;</span><br><span class="line">                        fds[i].events = POLLIN;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ›´æ–°æœ€å¤§çš„ç›‘å¬æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸‹æ ‡</span></span><br><span class="line">                <span class="comment">// å­˜åœ¨é—®é¢˜ï¼šä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ›¿ä»£æœ€å¤§å¯¹åº”ä¸‹æ ‡</span></span><br><span class="line">                nfds = nfds &gt; connfd ? nfds : connfd;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// éå†é›†åˆåˆ¤æ–­æ˜¯å¦æœ‰å˜åŠ¨ï¼Œå¦‚æœæœ‰å˜åŠ¨ï¼Œé‚£ä¹ˆé€šä¿¡</span></span><br><span class="line">            <span class="type">char</span> recv_buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= nfds; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (fds[i].fd != <span class="number">-1</span> &amp;&amp; fds[i].revents &amp; POLLIN) &#123;</span><br><span class="line">                    ret = <span class="built_in">read</span>(fds[i].fd, recv_buf, <span class="built_in">sizeof</span>(recv_buf));</span><br><span class="line">                    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">                        <span class="built_in">perror</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;recv server data : %s\n&quot;</span>, recv_buf);</span><br><span class="line">                        <span class="built_in">write</span>(fds[i].fd, recv_buf, <span class="built_in">strlen</span>(recv_buf));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// è¡¨ç¤ºå®¢æˆ·ç«¯æ–­å¼€è¿æ¥</span></span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;client closed...\n&quot;</span>);</span><br><span class="line">                        <span class="built_in">close</span>(fds[i].fd);</span><br><span class="line">                        fds[i].fd = <span class="number">-1</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(listenfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´çš„æ€æƒ³å’Œselectä¸€è‡´ï¼Œåªä¸è¿‡æ˜¯ä½¿ç”¨æ•°ç»„æ¥å­˜å‚¨æ ‡è¯†ã€‚</p><p><strong>å®¢æˆ·ç«¯</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVERIP <span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 6789</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºsocketï¼ˆç”¨äºé€šä¿¡çš„å¥—æ¥å­—ï¼‰</span></span><br><span class="line">    <span class="type">int</span> connfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (connfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. è¿æ¥æœåŠ¡å™¨ç«¯</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server_addr;</span><br><span class="line">    server_addr.sin_family = PF_INET;</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, SERVERIP, &amp;server_addr.sin_addr.s_addr);</span><br><span class="line">    server_addr.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">connect</span>(connfd, (<span class="keyword">struct</span> sockaddr*)&amp;server_addr, <span class="built_in">sizeof</span>(server_addr));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. é€šä¿¡</span></span><br><span class="line">    <span class="type">char</span> recv_buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// å‘é€æ•°æ®</span></span><br><span class="line">        <span class="type">char</span> *send_buf = <span class="string">&quot;client message&quot;</span>;</span><br><span class="line">        <span class="built_in">write</span>(connfd, send_buf, <span class="built_in">strlen</span>(send_buf));</span><br><span class="line">        <span class="comment">// æ¥æ”¶æ•°æ®</span></span><br><span class="line">        ret = <span class="built_in">read</span>(connfd, recv_buf, <span class="built_in">sizeof</span>(recv_buf));</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;recv server data : %s\n&quot;</span>, recv_buf);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¡¨ç¤ºå®¢æˆ·ç«¯æ–­å¼€è¿æ¥</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;client closed...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¼‘çœ çš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„è§‚å¯Ÿï¼Œæ”¾åœ¨æ­¤å¤„å¯ä»¥è§£å†³read: Connection reset by peeré—®é¢˜</span></span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line">    <span class="built_in">close</span>(connfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>å­˜åœ¨é—®é¢˜</strong></p></blockquote><ul><li>ç¼ºç‚¹åŒ<code>select</code>ç¬¬ä¸€ç‚¹å’Œç¬¬äºŒç‚¹(å¦‚ä¸‹)ï¼Œå³è§£å†³äº†ç¬¬ä¸‰ç‚¹å’Œç¬¬å››ç‚¹</li><li>æ¯æ¬¡è°ƒç”¨selectï¼Œéƒ½éœ€è¦æŠŠfdé›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¼šå¾ˆå¤§</li><li>åŒæ—¶æ¯æ¬¡è°ƒç”¨selectéƒ½éœ€è¦åœ¨å†…æ ¸éå†ä¼ é€’è¿›æ¥çš„æ‰€æœ‰fdï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¹Ÿå¾ˆå¤§</li></ul><h2 id="epoll">epoll</h2><p><strong>ç®€å•ç†è§£</strong></p><ul><li>å§”æ‰˜å†…æ ¸è¿›è¡Œæ“ä½œ</li><li>ä¼šé€šçŸ¥å…·ä½“æœ‰å“ªå‡ ä¸ªä»»åŠ¡å¯ç”¨</li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/19.png" alt=""></p><p><strong>ä¸»æ—¨æ€æƒ³</strong></p><ul><li>ç›´æ¥åœ¨<strong>å†…æ ¸æ€</strong>åˆ›å»º<code> eventpollå®ä¾‹</code>(ç»“æ„ä½“)ï¼Œé€šè¿‡<code>epoll</code>æä¾›çš„APIæ“ä½œè¯¥å®ä¾‹</li><li>ç»“æ„ä½“ä¸­æœ‰<code>çº¢é»‘æ ‘</code>å’Œ<code>åŒé“¾è¡¨</code>ï¼Œåˆ†åˆ«ç”¨æ¥<strong>å­˜å‚¨éœ€è¦æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦</strong>å’Œ<strong>å­˜å‚¨å·²ç»å‘ç”Ÿæ”¹å˜çš„æ–‡ä»¶æè¿°ç¬¦</strong></li></ul><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/18.png" alt=""></p><p><strong>å‡½æ•°è¯´æ˜</strong></p><ul><li><p>æ¦‚è§ˆ</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„epollå®ä¾‹</span></span><br><span class="line"><span class="comment">// åœ¨å†…æ ¸ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ•°æ®ï¼Œä¸€ä¸ªæ˜¯éœ€è¦æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¿¡æ¯ï¼ˆçº¢é»‘æ ‘ï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å°±ç»ªåˆ—è¡¨ï¼Œå­˜æ”¾æ£€æµ‹åˆ°æ•°æ®å‘é€æ”¹å˜çš„æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼ˆåŒå‘é“¾è¡¨ï¼‰</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_create</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹epollå®ä¾‹è¿›è¡Œç®¡ç†ï¼šæ·»åŠ æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œåˆ é™¤ä¿¡æ¯ï¼Œä¿®æ”¹ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event *event)</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span> &#123; </span><br><span class="line">    <span class="type">uint32_t</span> events; <span class="comment">/* Epoll events */</span> </span><br><span class="line">    <span class="type">epoll_data_t</span> data; <span class="comment">/* User data variable */</span> </span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> <span class="title class_">epoll_data</span> &#123; </span><br><span class="line">    <span class="type">void</span> *ptr; </span><br><span class="line">    <span class="type">int</span> fd; </span><br><span class="line">    <span class="type">uint32_t</span> u32; </span><br><span class="line">    <span class="type">uint64_t</span> u64; </span><br><span class="line">&#125; <span class="type">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æµ‹å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event *events, <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p><code>int epoll_create(int size);</code></p><ul><li>åŠŸèƒ½ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„epollå®ä¾‹</li><li>å‚æ•°ï¼š<code>size</code>ï¼Œç›®å‰æ²¡æœ‰æ„ä¹‰äº†(ä¹‹å‰åº•å±‚å®ç°æ˜¯å“ˆå¸Œè¡¨ï¼Œç°åœ¨æ˜¯çº¢é»‘æ ‘)ï¼Œéšä¾¿å†™ä¸€ä¸ªæ•°ï¼Œå¿…é¡»å¤§äº0</li><li>è¿”å›å€¼<ul><li>-1ï¼šå¤±è´¥</li><li>&gt;0ï¼šæ“ä½œ<code>epollå®ä¾‹</code>çš„æ–‡ä»¶æè¿°ç¬¦</li></ul></li></ul></li><li><p><code>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);</code></p><ul><li><p>åŠŸèƒ½ï¼šå¯¹epollå®ä¾‹è¿›è¡Œç®¡ç†ï¼šæ·»åŠ æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œåˆ é™¤ä¿¡æ¯ï¼Œä¿®æ”¹ä¿¡æ¯</p></li><li><p>å‚æ•°ï¼š</p><ul><li><code>epfd</code>ï¼šepollå®ä¾‹å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦</li><li>opï¼šè¦è¿›è¡Œä»€ä¹ˆæ“ä½œ<ul><li>æ·»åŠ ï¼š<code>EPOLL_CTL_ADD</code></li><li>åˆ é™¤ï¼š<code>EPOLL_CTL_DEL</code></li><li>ä¿®æ”¹ï¼š<code>EPOLL_CTL_MOD</code></li></ul></li><li><code>fd</code>ï¼šè¦æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦</li><li>eventï¼šæ£€æµ‹æ–‡ä»¶æè¿°ç¬¦ä»€ä¹ˆäº‹æƒ…ï¼Œé€šè¿‡è®¾ç½®epoll_event.eventsï¼Œå¸¸è§æ“ä½œ<ul><li>è¯»äº‹ä»¶ï¼š<code>EPOLLIN</code></li><li>å†™äº‹ä»¶ï¼š<code>EPOLLOUT</code></li><li>é”™è¯¯äº‹ä»¶ï¼š<code>EPOLLERR</code></li><li>è®¾ç½®è¾¹æ²¿è§¦å‘ï¼š<code>EPOLLET</code>ï¼ˆé»˜è®¤æ°´å¹³è§¦å‘ï¼‰</li></ul></li></ul></li><li><p>è¿”å›å€¼ï¼šæˆåŠŸ0ï¼Œå¤±è´¥-1</p></li></ul></li><li><p><code>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);</code></p><ul><li><p>åŠŸèƒ½ï¼šæ£€æµ‹å“ªäº›æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿäº†æ”¹å˜</p></li><li><p>å‚æ•°ï¼š</p><ul><li><code>epfd</code>ï¼šepollå®ä¾‹å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦</li></ul></li><li><p><code>events</code>ï¼šä¼ å‡ºå‚æ•°ï¼Œä¿å­˜äº†å‘ç”Ÿäº†å˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¿¡æ¯</p><ul><li><code>maxevents</code>ï¼šç¬¬äºŒä¸ªå‚æ•°ç»“æ„ä½“æ•°ç»„çš„å¤§å°</li></ul></li><li><p>timeoutï¼šé˜»å¡æ—¶é•¿</p><ul><li>0ï¼šä¸é˜»å¡</li><li>-1ï¼šé˜»å¡ï¼Œå½“æ£€æµ‹åˆ°éœ€è¦æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦æœ‰å˜åŒ–ï¼Œè§£é™¤é˜»å¡<ul><li>&gt;0ï¼šå…·ä½“çš„é˜»å¡æ—¶é•¿(ms)</li></ul></li></ul></li><li><p>è¿”å›å€¼ï¼š</p><ul><li>&gt; 0ï¼šæˆåŠŸï¼Œè¿”å›å‘é€å˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°</li><li>-1ï¼šå¤±è´¥</li></ul></li></ul></li></ul><blockquote><p><strong>æ³¨æ„äº‹é¡¹</strong></p></blockquote><ul><li><p><code>events</code>æ˜¯å°è£…äº†ç›‘å¬æè¿°ç¬¦ä¿¡æ¯çš„ç»“æ„ä½“ï¼Œæ¯ä¸€ä¸ªæ–°å¢æ–‡ä»¶éƒ½éœ€è¦è¿™ä¸ª(å¯é‡ç”¨)</p></li><li><p>éœ€è¦æ³¨æ„å¯èƒ½åŒæ—¶å‘ç”Ÿäº†å¤šä¸ªç›‘å¬ï¼ˆå¦‚ç›‘å¬è¯»äº‹ä»¶å’Œå†™äº‹ä»¶ï¼‰ï¼Œé‚£ä¹ˆä»£ç é€»è¾‘éœ€è¦åšç›¸åº”åˆ¤æ–­</p><blockquote><p>å¦‚æœ¬ä¾‹ä¸­åªæ£€æµ‹è¯»äº‹ä»¶ï¼Œæ’é™¤äº†å†™äº‹ä»¶</p></blockquote></li></ul><p><strong>æœåŠ¡ç«¯</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVERIP <span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 6789</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºsocketï¼ˆç”¨äºç›‘å¬çš„å¥—æ¥å­—ï¼‰</span></span><br><span class="line">    <span class="type">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (listenfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. ç»‘å®š</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server_addr;</span><br><span class="line">    server_addr.sin_family = PF_INET;</span><br><span class="line">    <span class="comment">// ç‚¹åˆ†åè¿›åˆ¶è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åº</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, SERVERIP, &amp;server_addr.sin_addr.s_addr);</span><br><span class="line">    <span class="comment">// æœåŠ¡ç«¯ä¹Ÿå¯ä»¥ç»‘å®š0.0.0.0å³ä»»æ„åœ°å€</span></span><br><span class="line">    <span class="comment">// server_addr.sin_addr.s_addr = INADDR_ANY;</span></span><br><span class="line">    server_addr.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;server_addr, <span class="built_in">sizeof</span>(server_addr));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. ç›‘å¬</span></span><br><span class="line">    ret = <span class="built_in">listen</span>(listenfd, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºepollå®ä¾‹</span></span><br><span class="line">    <span class="type">int</span> epfd = <span class="built_in">epoll_create</span>(<span class="number">100</span>);</span><br><span class="line">    <span class="comment">// å°†ç›‘å¬æ–‡ä»¶æè¿°ç¬¦åŠ å…¥å®ä¾‹</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> event;</span><br><span class="line">    event.events = EPOLLIN;</span><br><span class="line">    event.data.fd = listenfd;</span><br><span class="line">    ret = <span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, listenfd, &amp;event);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;epoll_ctl&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ­¤ç»“æ„ä½“ç”¨æ¥ä¿å­˜å†…æ ¸æ€è¿”å›ç»™ç”¨æˆ·æ€å‘ç”Ÿæ”¹å˜çš„æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> events[<span class="number">1024</span>];</span><br><span class="line">    <span class="comment">// ä¸æ–­å¾ªç¯ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨epollï¼Œè®¾ç½®ä¸ºæ°¸ä¹…é˜»å¡ï¼Œæœ‰æ–‡ä»¶æè¿°ç¬¦å˜åŒ–æ‰è¿”å›</span></span><br><span class="line">        <span class="type">int</span> num = <span class="built_in">epoll_wait</span>(epfd, events, <span class="number">1024</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰æ— æ–‡ä»¶æè¿°ç¬¦æœ‰å˜åŒ–ï¼Œæ‰§è¡Œä¸‹ä¸€æ¬¡éå†</span></span><br><span class="line">            <span class="comment">// åœ¨æœ¬æ¬¡è®¾ç½®ä¸­æ— æ•ˆï¼ˆå› ä¸ºselectè¢«è®¾ç½®ä¸ºæ°¸ä¹…é˜»å¡ï¼‰</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// éå†å‘ç”Ÿæ”¹å˜çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆ</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­ç›‘å¬æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼ˆå³æ˜¯å¦æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼‰</span></span><br><span class="line">                <span class="type">int</span> curfd = events[i].data.fd;</span><br><span class="line">                <span class="keyword">if</span> (curfd == listenfd) &#123;</span><br><span class="line">                    <span class="comment">// 4. æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">                    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;</span><br><span class="line">                    <span class="type">socklen_t</span> client_addr_len = <span class="built_in">sizeof</span>(client_addr);</span><br><span class="line">                    <span class="type">int</span> connfd = <span class="built_in">accept</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;client_addr_len);</span><br><span class="line">                    <span class="keyword">if</span> (connfd == <span class="number">-1</span>) &#123;</span><br><span class="line">                        <span class="built_in">perror</span>(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// è¾“å‡ºå®¢æˆ·ç«¯ä¿¡æ¯ï¼ŒIPç»„æˆè‡³å°‘16ä¸ªå­—ç¬¦ï¼ˆåŒ…å«ç»“æŸç¬¦ï¼‰</span></span><br><span class="line">                    <span class="type">char</span> client_ip[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                    <span class="built_in">inet_ntop</span>(AF_INET, &amp;client_addr.sin_addr.s_addr, client_ip, <span class="built_in">sizeof</span>(client_ip));</span><br><span class="line">                    <span class="type">unsigned</span> <span class="type">short</span> client_port = <span class="built_in">ntohs</span>(client_addr.sin_port);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ip:%s, port:%d\n&quot;</span>, client_ip, client_port);</span><br><span class="line">                    <span class="comment">// å°†ä¿¡æ¯åŠ å…¥ç›‘å¬é›†åˆ</span></span><br><span class="line">                    event.events = EPOLLIN;</span><br><span class="line">                    event.data.fd = connfd;</span><br><span class="line">                    <span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, connfd, &amp;event);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// åªæ£€æµ‹è¯»äº‹ä»¶</span></span><br><span class="line">                    <span class="keyword">if</span> (events[i].events &amp; EPOLLOUT) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">                    <span class="type">char</span> recv_buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                    ret = <span class="built_in">read</span>(curfd, recv_buf, <span class="built_in">sizeof</span>(recv_buf));</span><br><span class="line">                    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">                        <span class="built_in">perror</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;recv server data : %s\n&quot;</span>, recv_buf);</span><br><span class="line">                        <span class="built_in">write</span>(curfd, recv_buf, <span class="built_in">strlen</span>(recv_buf));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// è¡¨ç¤ºå®¢æˆ·ç«¯æ–­å¼€è¿æ¥</span></span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;client closed...\n&quot;</span>);</span><br><span class="line">                        <span class="built_in">close</span>(curfd);</span><br><span class="line">                        <span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_DEL, curfd, <span class="literal">NULL</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(listenfd);</span><br><span class="line">    <span class="built_in">close</span>(epfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®¢æˆ·ç«¯</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVERIP <span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 6789</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºsocketï¼ˆç”¨äºé€šä¿¡çš„å¥—æ¥å­—ï¼‰</span></span><br><span class="line">    <span class="type">int</span> connfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (connfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. è¿æ¥æœåŠ¡å™¨ç«¯</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server_addr;</span><br><span class="line">    server_addr.sin_family = PF_INET;</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, SERVERIP, &amp;server_addr.sin_addr.s_addr);</span><br><span class="line">    server_addr.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">connect</span>(connfd, (<span class="keyword">struct</span> sockaddr*)&amp;server_addr, <span class="built_in">sizeof</span>(server_addr));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. é€šä¿¡</span></span><br><span class="line">    <span class="type">char</span> recv_buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// å‘é€æ•°æ®</span></span><br><span class="line">        <span class="type">char</span> *send_buf = <span class="string">&quot;client message&quot;</span>;</span><br><span class="line">        <span class="built_in">write</span>(connfd, send_buf, <span class="built_in">strlen</span>(send_buf));</span><br><span class="line">        <span class="comment">// æ¥æ”¶æ•°æ®</span></span><br><span class="line">        ret = <span class="built_in">read</span>(connfd, recv_buf, <span class="built_in">sizeof</span>(recv_buf));</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;recv server data : %s\n&quot;</span>, recv_buf);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¡¨ç¤ºå®¢æˆ·ç«¯æ–­å¼€è¿æ¥</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;client closed...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¼‘çœ çš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„è§‚å¯Ÿï¼Œæ”¾åœ¨æ­¤å¤„å¯ä»¥è§£å†³read: Connection reset by peeré—®é¢˜</span></span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line">    <span class="built_in">close</span>(connfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å·¥ä½œæ¨¡å¼-LTä¸ET">å·¥ä½œæ¨¡å¼(LTä¸ET)</h3><h4 id="æ°´å¹³è§¦å‘-level-triggered-LT">æ°´å¹³è§¦å‘(level triggered, LT)</h4><ul><li>epollçš„ç¼ºçœçš„å·¥ä½œæ–¹å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒ block å’Œ non-block socket</li><li>åœ¨è¿™ç§åšæ³•ä¸­ï¼Œå†…æ ¸å‘Šè¯‰ä½ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªäº†ï¼Œç„¶åä½ å¯ä»¥å¯¹è¿™ä¸ªå°±ç»ªçš„ fd è¿›è¡Œ IO æ“ä½œã€‚å¦‚æœä½ ä¸ä½œä»»ä½•æ“ä½œï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­é€šçŸ¥ä½ çš„</li></ul><h4 id="è¾¹æ²¿è§¦å‘-edge-triggered-ET">è¾¹æ²¿è§¦å‘(edge triggered, ET)</h4><ul><li>æ˜¯é«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒ non-block socketï¼Œéœ€è¦å¯¹ç›‘å¬æ–‡ä»¶æè¿°ç¬¦è®¾ç½®æ‰èƒ½å®ç°</li><li>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰ä½ ã€‚ç„¶åå®ƒä¼šå‡è®¾ä½ çŸ¥é“æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªï¼Œå¹¶ä¸”ä¸ä¼šå†ä¸ºé‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦å‘é€æ›´å¤šçš„å°±ç»ªé€šçŸ¥ï¼Œç›´åˆ°ä½ åšäº†æŸäº›æ“ä½œå¯¼è‡´é‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸å†ä¸ºå°±ç»ªçŠ¶æ€äº†ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œå¦‚æœä¸€ç›´ä¸å¯¹è¿™ä¸ª fd ä½œ IO æ“ä½œï¼ˆä»è€Œå¯¼è‡´å®ƒå†æ¬¡å˜æˆæœªå°±ç»ªï¼‰ï¼Œå†…æ ¸ä¸ä¼šå‘é€æ›´å¤šçš„é€šçŸ¥ï¼ˆonly onceï¼‰</li></ul><h4 id="åŒºåˆ«ä¸è¯´æ˜">åŒºåˆ«ä¸è¯´æ˜</h4><ul><li>ET æ¨¡å¼åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå‡å°‘äº† epoll äº‹ä»¶è¢«é‡å¤è§¦å‘çš„æ¬¡æ•°ï¼Œå› æ­¤æ•ˆç‡è¦æ¯” LT æ¨¡å¼é«˜</li><li>epollå·¥ä½œåœ¨ ET æ¨¡å¼çš„æ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨éé˜»å¡å¥—æ¥å£ï¼Œä»¥é¿å…ç”±äºä¸€ä¸ªæ–‡ä»¶å¥æŸ„çš„é˜»å¡è¯»/é˜»å¡å†™æ“ä½œæŠŠå¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„ä»»åŠ¡é¥¿æ­»</li><li>æ‰€ä»¥å¦‚æœä½¿ç”¨ETä¸”ç¼“å†²åŒºå†…å®¹ä¸èƒ½ä¸€æ¬¡æ€§è¯»å®Œï¼Œ<strong>éœ€è¦å†™ä¸€ä¸ªå¾ªç¯å°†å†…å®¹å…¨éƒ¨è¯»å–ï¼Œä¸”éœ€è¦å°†å¥—æ¥å­—è®¾ç½®ä¸ºéé˜»å¡</strong></li><li>è¯´æ˜ï¼šå‡è®¾å§”æ‰˜å†…æ ¸æ£€æµ‹è¯»äº‹ä»¶ï¼Œå³æ£€æµ‹fdçš„è¯»ç¼“å†²åŒºï¼Œé‚£ä¹ˆå¦‚æœè¯»ç¼“å†²åŒºæœ‰æ•°æ® ï¼Œepollæ£€æµ‹åˆ°äº†ä¼šç»™ç”¨æˆ·é€šçŸ¥<ul><li>LTã€åªè¦ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œå°±ä¼šä¸€ç›´é€šçŸ¥ã€‘<ul><li>ç”¨æˆ·ä¸è¯»æ•°æ®ï¼Œæ•°æ®ä¸€ç›´åœ¨ç¼“å†²åŒºï¼Œepoll ä¼šä¸€ç›´é€šçŸ¥</li><li>ç”¨æˆ·åªè¯»äº†ä¸€éƒ¨åˆ†æ•°æ®ï¼Œepollä¼šé€šçŸ¥</li><li>ç¼“å†²åŒºçš„æ•°æ®è¯»å®Œäº†ï¼Œä¸é€šçŸ¥</li></ul></li><li>ETã€ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œåªä¼šé€šçŸ¥ä¸€æ¬¡ã€‘<ul><li>ç”¨æˆ·ä¸è¯»æ•°æ®ï¼Œæ•°æ®ä¸€è‡´åœ¨ç¼“å†²åŒºä¸­ï¼Œepollä¸‹æ¬¡æ£€æµ‹çš„æ—¶å€™å°±ä¸é€šçŸ¥äº†</li><li>ç”¨æˆ·åªè¯»äº†ä¸€éƒ¨åˆ†æ•°æ®ï¼Œepollä¸é€šçŸ¥</li><li>ç¼“å†²åŒºçš„æ•°æ®è¯»å®Œäº†ï¼Œä¸é€šçŸ¥</li></ul></li></ul></li></ul><h2 id="api">api</h2><ul><li><p><code>int socket(int domain, int type, int protocol);</code></p><ul><li>åŠŸèƒ½ï¼šåˆ›å»ºä¸€ä¸ªå¥—æ¥å­—</li></ul></li><li><p>å‚æ•°ï¼š</p><ul><li><p>domainï¼šåè®®æ—(å¸¸ç”¨å¦‚ä¸‹)</p></li><li><p><code>AF_INET</code> ï¼š<code>ipv4</code></p><ul><li><code>AF_INET</code>6 ï¼š<code>ipv6</code></li><li><code>AF_UNIX</code>, <code>AF_LOCAL</code>ï¼šæœ¬åœ°å¥—æ¥å­—é€šä¿¡ï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰</li></ul></li><li><p>typeï¼šé€šä¿¡è¿‡ç¨‹ä¸­ä½¿ç”¨çš„åè®®ç±»å‹</p><ul><li><code>SOCK_STREAM</code> : æµå¼åè®®<ul><li><code>SOCK_DGRAM</code> : æŠ¥å¼åè®®</li></ul></li><li>protocolï¼šå…·ä½“çš„ä¸€ä¸ªåè®®ï¼Œä¸€èˆ¬å†™0ï¼Œç”¨äºæŒ‡å®štypeå‚æ•°çš„é»˜è®¤åè®®ç±»å‹</li><li><code>SOCK_STREAM</code> : æµå¼åè®®é»˜è®¤ä½¿ç”¨ TCP</li><li><code>SOCK_DGRAM</code> : æŠ¥å¼åè®®é»˜è®¤ä½¿ç”¨ UDP</li></ul></li><li><p>è¿”å›å€¼</p><ul><li>æˆåŠŸï¼šè¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œæ“ä½œçš„å°±æ˜¯å†…æ ¸ç¼“å†²åŒº</li></ul></li><li><p>å¤±è´¥ï¼š-1</p></li></ul></li><li><p><code>int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code></p><ul><li>åŠŸèƒ½ï¼šç»‘å®šï¼Œå°†fd å’Œæœ¬åœ°çš„IPå’Œç«¯å£è¿›è¡Œç»‘å®š</li><li>å‚æ•°ï¼š<ul><li><code>sockfd</code>ï¼šé€šè¿‡socketå‡½æ•°å¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦</li><li><code>addr</code>ï¼šéœ€è¦ç»‘å®šçš„socketåœ°å€ï¼Œè¿™ä¸ªåœ°å€å°è£…äº†<strong>æœ¬åœ°çš„ipå’Œç«¯å£å·çš„ä¿¡æ¯</strong></li><li><code>addrlen</code>ï¼šç¬¬äºŒä¸ªå‚æ•°ç»“æ„ä½“å çš„å†…å­˜å¤§å°</li></ul></li><li>è¿”å›å€¼ï¼šæˆåŠŸï¼š0ï¼Œå¤±è´¥ï¼š-1</li></ul></li><li><p><code>int listen(int sockfd, int backlog);</code></p><ul><li>åŠŸèƒ½ï¼šç›‘å¬è¿™ä¸ªsocketä¸Šçš„è¿æ¥</li><li>å‚æ•°ï¼š<ul><li><code>sockfd</code>ï¼šé€šè¿‡socket()å‡½æ•°å¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦</li><li><code>backlog</code>ï¼šæœªè¿æ¥çš„å’Œå·²ç»è¿æ¥çš„å’Œçš„æœ€å¤§å€¼ï¼Œå¯ç”¨<code>cat /proc/sys/net/core/somaxconn</code>æŸ¥çœ‹Linuxè®¾ç½®å€¼</li></ul></li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸï¼š0</li><li>å¤±è´¥ï¼š-1</li></ul></li></ul></li><li><p><code>int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen);</code></p><ul><li>åŠŸèƒ½ï¼šæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªé˜»å¡çš„å‡½æ•°ï¼Œé˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</li><li>å‚æ•°ï¼š<ul><li><code>sockfd</code> : ç”¨äºç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦</li><li><code>addr</code> : ä¼ å‡ºå‚æ•°ï¼Œè®°å½•äº†è¿æ¥æˆåŠŸå<strong>å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯</strong>ï¼ˆipï¼Œportï¼‰</li><li><code>addrlen</code> : æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°çš„å¯¹åº”çš„å†…å­˜å¤§å°</li></ul></li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸï¼šç”¨äºé€šä¿¡çš„æ–‡ä»¶æè¿°ç¬¦</li><li>å¤±è´¥ï¼š-1</li></ul></li></ul></li><li><p><code>int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code></p><ul><li>åŠŸèƒ½ï¼š å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨</li><li>å‚æ•°ï¼š<ul><li><code>sockfd</code> : ç”¨äº**é€šä¿¡çš„æ–‡ä»¶æè¿°ç¬¦ **</li><li><code>addr</code> : å®¢æˆ·ç«¯è¦è¿æ¥çš„æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯</li><li><code>addrlen</code> : æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°çš„å¯¹åº”çš„å†…å­˜å¤§å°</li></ul></li><li>è¿”å›å€¼ï¼šæˆåŠŸ 0ï¼Œ å¤±è´¥ -1</li></ul></li><li><p>å…¶ä»–è¯»å†™å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span></span>; <span class="comment">// å†™æ•°æ® </span></span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span></span>; <span class="comment">// è¯»æ•°æ®</span></span><br></pre></td></tr></table></figure></li></ul><h1>å‚è€ƒæ–‡ç« </h1><ul><li><p><a href="https://blog.csdn.net/baidu_41553551/article/details/126807285">C++11é‡å†™muduoç½‘ç»œåº“â€”â€”é¢„å¤‡çŸ¥è¯†</a></p></li><li><p>ç‰›å®¢webserver</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºç½‘ç»œ </category>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> è®¡ç®—æœºç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>More Effective Cpp</title>
      <link href="/posts/e584d079.html"/>
      <url>/posts/e584d079.html</url>
      
        <content type="html"><![CDATA[<h1>Basics åŸºç¡€è®®é¢˜</h1><h2 id="æ¡æ¬¾-1ï¼šä»”ç»†åŒºåˆ«pointerså’Œreferences">æ¡æ¬¾ 1ï¼šä»”ç»†åŒºåˆ«pointerså’Œreferences</h2><ol><li><p>æŒ‡é’ˆå’Œå¼•ç”¨éƒ½æ˜¯é—´æ¥ä½¿ç”¨å…¶ä»–å¯¹è±¡ã€‚</p></li><li><p>æ²¡æœ‰null referenceï¼Œå¼•ç”¨å¿…é¡»æœ‰åˆå€¼ï¼Œè€ŒæŒ‡é’ˆæ²¡æœ‰æ­¤é™åˆ¶ã€‚å› æ­¤å¼•ç”¨ä½¿ç”¨æ—¶ä¸ç”¨åˆ¤æ–­å…¶æœ‰æ•ˆæ€§ï¼Œè€ŒæŒ‡é’ˆé€šå¸¸éœ€è¦ã€‚</p><p>ex1ï¼š<strong>ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸èƒ½ä½¿ç”¨æŒ‡å‘ç©ºå€¼çš„å¼•ç”¨ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span>* pc = <span class="number">0</span>;<span class="comment">// è®¾ç½®æŒ‡é’ˆä¸ºç©ºå€¼</span></span><br><span class="line"><span class="type">char</span>&amp; rc = *pc;<span class="comment">// è®©å¼•ç”¨æŒ‡å‘ç©ºå€¼</span></span><br></pre></td></tr></table></figure><p>å¥½å¤„ï¼šä¸å­˜åœ¨æŒ‡å‘ç©ºå€¼çš„å¼•ç”¨è¿™ä¸ªäº‹å®æ„å‘³ç€ä½¿ç”¨å¼•ç”¨çš„ä»£ç æ•ˆç‡æ¯”ä½¿ç”¨æŒ‡é’ˆè¦é«˜ï¼Œå› ä¸ºåœ¨ä½¿ç”¨å¼•ç”¨ä¹‹å‰ä¸éœ€è¦æ£€æŸ¥å®ƒçš„åˆæ³•æ€§ã€‚</p><p>ex2ï¼šå¼•ç”¨å¿…é¡»åˆå§‹åŒ–</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string&amp; rs;      <span class="comment">// é”™è¯¯ï¼Œå¼•ç”¨å¿…é¡»è¢«åˆå§‹åŒ–ã€‚</span></span><br><span class="line"><span class="function">string <span class="title">s</span><span class="params">(<span class="string">&quot;XYZ&quot;</span>)</span></span>;</span><br><span class="line">string&amp; rs = s;  <span class="comment">// rs æŒ‡å‘ sã€‚</span></span><br><span class="line">string *ps;      <span class="comment">// æœªåˆå§‹åŒ–çš„æŒ‡é’ˆï¼Œæœ‰æ•ˆï¼Œä½†é£é™©é«˜ã€‚</span></span><br></pre></td></tr></table></figure></li><li><p>referenceæ€»æ˜¯æŒ‡å‘ï¼ˆä»£è¡¨ï¼‰åˆå§‹åŒ–çš„å¯¹è±¡ï¼Œè€ŒæŒ‡é’ˆå¯ä»¥è¢«é‡æ–°èµ‹å€¼ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">s1</span><span class="params">(<span class="string">&quot;Nancey&quot;</span>)</span></span>;</span><br><span class="line"><span class="function">string <span class="title">s2</span><span class="params">(<span class="string">&quot;Clancy&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">string&amp; rs = s1;   <span class="comment">// rs æŒ‡å‘ s1ã€‚</span></span><br><span class="line">string *ps = &amp;s2;  <span class="comment">// ps æŒ‡å‘ s1ã€‚</span></span><br><span class="line">rs = s2;          <span class="comment">// rs ä»ç„¶ä»£è¡¨ s1, ä½†æ˜¯ç°åœ¨å…¶å€¼è¢«èµ‹ä¸º s2 çš„å€¼ã€‚</span></span><br><span class="line">ps = &amp;s2;          <span class="comment">// ps ç°åœ¨æŒ‡å‘ s2ï¼Œs1 æ²¡æœ‰å˜åŒ–ã€‚</span></span><br></pre></td></tr></table></figure></li><li><p>ç»“è®ºï¼šå½“ä½ çŸ¥é“ä½ éœ€è¦æŒ‡å‘æŸä¸ªä¸œè¥¿ï¼Œè€Œä¸”ç»ä¸ä¼šæ”¹å˜æŒ‡å‘å…¶ä»–ä¸œè¥¿ï¼Œæˆ–æ˜¯å½“ä½ å®ç°ä¸€ä¸ªæ“ä½œç¬¦è€Œå…¶è¯­æ³•éœ€æ±‚æ— æ³•ç”±pointers è¾¾æˆï¼Œä½ å°±åº”è¯¥é€‰æ‹© referencesã€‚ä»»ä½•å…¶ä»–æ—¶å€™ï¼Œè¯·é‡‡ç”¨pointersã€‚</p></li></ol><h2 id="æ¡æ¬¾-2ï¼šæœ€å¥½ä½¿ç”¨C-è½¬å‹æ“ä½œç¬¦">æ¡æ¬¾ 2ï¼šæœ€å¥½ä½¿ç”¨C++è½¬å‹æ“ä½œç¬¦</h2><ol><li><p>C++ä¸­çš„4ä¸ªè½¬å‹æ“ä½œç¬¦ï¼š<code>static_cast</code>, <code>const_cast</code>, <code>dynamic_cast</code>å’Œ <code>reinterpret_cast</code>ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(type) expression;             <span class="comment">// æ—§çš„è½¬å‹</span></span><br><span class="line"><span class="type">int</span> firstNumber, secondNumber;</span><br><span class="line">...</span><br><span class="line"><span class="type">double</span> result = ((<span class="type">double</span>)firstNumber) / secondNumber;</span><br><span class="line"><span class="built_in">static_cast</span>&lt;type&gt;(expression); <span class="comment">//æ–°çš„è½¬å‹</span></span><br><span class="line"><span class="type">double</span> result = <span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(firstNumber) / secondNumber;</span><br></pre></td></tr></table></figure></li><li><p><code>const_cast</code> ç”¨æ¥æ”¹å˜è¡¨è¾¾å¼ä¸­çš„å¸¸é‡æ€§ï¼ˆconstnessï¼‰æˆ–å˜æ˜“æ€§ï¼ˆvolatilenessï¼‰ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123; ... &#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpecialWidget</span>: <span class="keyword">public</span> Widget &#123; ... &#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">( SpecialWidget *psw )</span></span>;</span><br><span class="line">SpecialWidget sw;              <span class="comment">// sw æ˜¯ä¸€ä¸ª non-const å¯¹è±¡</span></span><br><span class="line"><span class="type">const</span> SpecialWidget&amp; csw = sw; <span class="comment">// csw æ˜¯ä¸€ä¸ªä»£è¡¨ sw çš„ const å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">update</span>( &amp;csw ); <span class="comment">//é”™è¯¯ï¼ä¸èƒ½å°† const SpecialWidget*ä¼ é€’ç»™ä¸€ä¸ªéœ€è¦ SpecialWidget* çš„å‡½æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">update</span>( <span class="built_in">const_cast</span>&lt;SpecialWidget*&gt;(&amp;csw) ); <span class="comment">// å¯è¡Œï¼Œ&amp;csw çš„å¸¸é‡ä¸‹æ€§è¢«å»é™¤äº†ï¼Œ å› æ­¤cswï¼ˆäº¦å³swï¼‰åœ¨æ­¤å‡½æ•°ä¸­å¯è¢«æ›´æ”¹ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">update</span>( ( SpecialWidget* )&amp;csw );  <span class="comment">// å’Œç¬¬9è¡Œæƒ…å†µç›¸åŒï¼Œä½†ä½¿ç”¨çš„æ˜¯è¾ƒéš¾è¯†åˆ«çš„ C æ—§å¼è½¬å‹è¯­æ³•ã€‚</span></span><br><span class="line"></span><br><span class="line">Widget *pw = <span class="keyword">new</span> SpecialWidget;</span><br><span class="line"><span class="built_in">update</span>(pw); <span class="comment">// é”™è¯¯ï¼pwç±»å‹æ˜¯Widget*ï¼Œä½†updateï¼ˆï¼‰éœ€è¦çš„æ˜¯SpecialWidget*ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">update</span>( <span class="built_in">const_cast</span>&lt;SpecialWidget*&gt;(pw) ); <span class="comment">// é”™è¯¯ï¼const åªèƒ½å½±å“å¸¸é‡æ€§æˆ–æ˜“å˜æ€§ã€‚</span></span><br></pre></td></tr></table></figure></li><li><p><code>dynamic_cast</code>ï¼Œç”¨æ¥æ‰§è¡Œç»§æ‰¿ä½“ç³»ä¸­â€œå®‰å…¨çš„å‘ä¸‹è½¬å‹æˆ–è·¨ç³»è½¬å‹åŠ¨ä½œâ€ã€‚å¯ä»¥<strong>åˆ©ç”¨<code>dynamic_cast</code>å°†æŒ‡å‘åŸºç±»å¯¹è±¡çš„æŒ‡é’ˆæˆ–å¼•ç”¨è½¬å‹ä¸ºæŒ‡å‘å…¶æ´¾ç”Ÿç±»æˆ–å…„å¼Ÿç±»çš„æŒ‡é’ˆæˆ–å¼•ç”¨</strong>ã€‚<strong>æˆåŠŸè¿”å›1ï¼Œå¤±è´¥ä¼šè®®ä¸€ä¸ª<code>null</code>æŒ‡é’ˆæˆ–è€…å¼‚å¸¸ï¼ˆå½“è½¬å‹å¯¹è±¡æ˜¯å¼•ç”¨ï¼‰è¡¨ç°å‡ºæ¥ã€‚</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Widget *pw;</span><br><span class="line">...</span><br><span class="line"><span class="built_in">update</span>( <span class="built_in">dynamic_cast</span>&lt;SpecialWidget*&gt;(pw) ); <span class="comment">// å¦‚æœè½¬å‹æˆåŠŸï¼Œå°†ä¼ ç»™ updataï¼ˆï¼‰ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ pw æ‰€æŒ‡çš„ SpecialWidgetï¼Œ å¦åˆ™ä¼ ç»™updataï¼ˆï¼‰ä¸€ä¸ª null æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">updateViaRef</span><span class="params">( SpecialWidget&amp; rsw)</span></span>;</span><br><span class="line"><span class="built_in">updateViaRef</span>( <span class="built_in">dynamic_cast</span>&lt;SpecialWidget&amp;&gt;(*pw) ); <span class="comment">// å¦‚æœè½¬å‹æˆåŠŸï¼Œå°†ä¼ ç»™ updateViaRefï¼ˆï¼‰ pw æ‰€æŒ‡çš„ SpecialWidgetï¼Œ å¦åˆ™æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚</span></span><br></pre></td></tr></table></figure></li></ol><p>æ€»ç»“ï¼š</p><ul><li>static_castï¼šåœ¨åŠŸèƒ½ä¸Šå’ŒCé£æ ¼ç±»å‹è½¬æ¢ä¸€æ ·å¼ºå¤§ï¼Œå«ä¹‰ä¹Ÿä¸€æ ·ï¼Œå¯ä»¥è¢«ç”¨äºå¼ºåˆ¶éšå½¢è½¬æ¢ï¼ˆä¾‹å¦‚ï¼Œnon-constå¯¹è±¡è½¬æ¢ä¸ºconstå¯¹è±¡ï¼Œintè½¬å‹ä¸ºdoubleï¼Œç­‰ç­‰ï¼‰ã€‚</li><li>const_castï¼š å»æ‰constæˆ–volatilenesså±æ€§çš„æ“ä½œã€‚</li><li>dynamic_castï¼šç”¨äºå®‰å…¨çš„æ²¿ç€ç±»çš„ç»§æ‰¿å…³ç³»å‘ä¸‹è¿›è¡Œç±»å‹è½¬æ¢ï¼Œå¤±è´¥çš„è½¬æ¢å°†è¿”å›ç©ºæŒ‡é’ˆï¼ˆé’ˆå¯¹æŒ‡é’ˆè¿›è¡Œç±»å‹è½¬æ¢ï¼‰æˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼ˆé’ˆå¯¹å¼•ç”¨è¿›è¡Œç±»å‹è½¬æ¢ï¼‰ã€‚</li><li>reinterpret_castï¼šä¸»è¦æ˜¯å°†æ•°æ®ä»ä¸€ç§ç±»å‹çš„è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ï¼Œæ˜¯ç‰¹æ„ç”¨äºåº•å±‚çš„å¼ºåˆ¶è½¬å‹ï¼Œå¯¼è‡´å®ç°ä¾èµ–ï¼ˆå°±æ˜¯è¯´ï¼Œä¸å¯ç§»æ¤ï¼‰çš„ç»“æœï¼Œä¾‹å¦‚ï¼Œå°†ä¸€ä¸ªæŒ‡é’ˆè½¬å‹ä¸ºä¸€ä¸ªæ•´æ•°ã€‚</li></ul><h2 id="æ¡æ¬¾-3ï¼šç»å¯¹ä¸è¦ä»¥å¤šæ€æ–¹å¼å¤„ç†æ•°ç»„">æ¡æ¬¾ 3ï¼šç»å¯¹ä¸è¦ä»¥å¤šæ€æ–¹å¼å¤„ç†æ•°ç»„</h2><ol><li><p>ç»§æ‰¿çš„é‡è¦æ€§è´¨ä¹‹ä¸€å°±æ˜¯ï¼Œå¯ä»¥é€šè¿‡æŒ‡å‘åŸºç±»å¯¹è±¡çš„æŒ‡é’ˆæˆ–å¼•ç”¨ï¼Œæ¥æ“ä½œæ´¾ç”Ÿç±»ã€‚</p></li><li><p>å½“å°†æ´¾ç”Ÿç±»ç±»å‹çš„æ•°ç»„ä¼ é€’ç»™éœ€è¦åŸºç±»ç±»å‹çš„æ•°ç»„æ—¶ï¼Œå…¶ä¼šå®‰åŸºç±»ç±»å‹çš„å¤§å°æ¥æ“ä½œæ•°ç»„æŒ‡é’ˆã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BST</span> &#123; ... &#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BalancedBST</span>: <span class="keyword">public</span> BST &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printBSTArray</span><span class="params">(ostream&amp; s, <span class="type">const</span> BST array[], <span class="type">int</span> numElements)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">int</span> i = <span class="number">0</span>; i &lt; numElements; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        s &lt;&lt; array[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BST BSTArray[<span class="number">10</span>];</span><br><span class="line">...</span><br><span class="line"><span class="built_in">printBSTArray</span>(cout, BSTArray, <span class="number">10</span>);  <span class="comment">// æ²¡é—®é¢˜</span></span><br><span class="line"></span><br><span class="line">BalancedBST bBSTArray[<span class="number">10</span>];</span><br><span class="line">...</span><br><span class="line"><span class="built_in">printBSTArray</span>( cout, bBSTArray, <span class="number">10</span>); <span class="comment">// å°†ä»¥ BST ç±»å‹å¤„ç† bBSTAraay å‡½æ•°æŒ‡é’ˆï¼Œå³æŒ‡é’ˆæ“ä½œçš„æ­¥é•¿ä¸º sizeof(BST) </span></span><br></pre></td></tr></table></figure></li></ol><h2 id="æ¡æ¬¾-4ï¼šéå¿…è¦ä¸æä¾›default-constructor">æ¡æ¬¾ 4ï¼šéå¿…è¦ä¸æä¾›default constructor</h2><p>**ï¼ˆ1ï¼‰**default constructorï¼šåœ¨æ²¡æœ‰ä»»ä½•å¤–æ¥ä¿¡æ¯çš„æƒ…å†µä¸‹å°†å¯¹è±¡åˆå§‹åŒ–.</p><p>**ï¼ˆ2ï¼‰**ä½†æ˜¯æœ‰äº›å¯¹è±¡å¦‚æœæ²¡æœ‰å¤–æ¥ä¿¡æ¯ï¼Œå°±æ²¡æœ‰åŠæ³•å®Œæˆåˆå§‹åŒ–åŠ¨ä½œï¼Œé‚£ä¹ˆè¿™äº›å¯¹è±¡ï¼Œå°±æ²¡æœ‰å¿…è¦æä¾›default constructor.</p><p>**ï¼ˆ3ï¼‰**å¦‚æœä¸€ä¸ªç±»ç¼ºä¹default constructorï¼Œé‚£ä¹ˆä½¿ç”¨è¿™ä¸ªç±»çš„æ—¶å€™ä¼šå­˜åœ¨ä¸€å®šçš„é™åˆ¶.</p><blockquote><p><strong>é™åˆ¶1</strong></p></blockquote><p>é™åˆ¶1ï¼šäº§ç”Ÿæ•°ç»„çš„æ—¶å€™ï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªæ–¹æ³•å¯ä»¥ä¸ºæ•°ç»„ä¸­çš„å¯¹è±¡æŒ‡å®šconstructorè‡ªå˜é‡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EquipmentPiece bestPieces[<span class="number">10</span>];<span class="comment">//é”™è¯¯ï¼</span></span><br><span class="line">EquipmentPiece *bestPieces=<span class="keyword">new</span> EquipmentPiece[<span class="number">10</span>];<span class="comment">//é”™è¯¯ï¼</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>é™åˆ¶2</strong></p></blockquote><p>é™åˆ¶2ï¼šä¸é€‚ç”¨äºæŸäº›æ¨¡æ¿ç±»</p><p>å¯¹é‚£äº›æ¨¡æ¿è€Œè¨€ï¼Œè¢«å®ä¾‹åŒ–çš„ç›®æ ‡ç±»å‹å¿…é¡»å¾—æœ‰ä¸€ä¸ªdefault constructorï¼Œè¿™æ˜¯ä¸€ä¸ªæ™®éçš„å…±åŒéœ€æ±‚ï¼Œå› ä¸ºé‚£äº›æ¨¡æ¿å†…å‡ ä¹æ€»æ˜¯ä¼šäº§ç”Ÿä¸€ä¸ªä»¥templateä½œä¸ºç±»å‹è€Œæ„æ¶èµ·æ¥çš„æ•°ç»„ï¼Œå½“ç„¶ï¼Œå¦‚æœè°¨æ…è®¾è®¡æ¨¡æ¿ï¼Œå¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¾ˆå¤šæ¨¡æ¿çš„è®¾è®¡è€…ç‹¬ç¼ºè°¨æ…ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç¼ºä¹default constructorçš„ç±»ä¸å…¼å®¹äºè®¸å¤šæ¨¡æ¿ã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªæ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°çš„ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NoDefaultConstructor</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="comment">//NoDefaultConstructor() &#123;&#125; æ²¡æœ‰è¿™å¥è¯å°±æŠ¥é”™ </span></span><br><span class="line">    <span class="built_in">NoDefaultConstructor</span>(<span class="type">int</span> value) : <span class="built_in">data</span>(value) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Value: &quot;</span> &lt;&lt; data &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªæ¨¡æ¿ç±»</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Container</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Container</span>() &#123;</span><br><span class="line">        <span class="comment">// åœ¨æ„é€ å‡½æ•°ä¸­å°è¯•ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="comment">// ä½†è¿™ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼Œå› ä¸ºTå¯èƒ½æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="comment">// obj = T();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addObject</span><span class="params">(<span class="type">const</span> T&amp; object)</span> </span>&#123;</span><br><span class="line">        obj = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">displayObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        obj.<span class="built_in">display</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T obj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ä½¿ç”¨æ¨¡æ¿ç±»Containerï¼Œå¹¶ä¼ å…¥æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°çš„ç±»NoDefaultConstructorä½œä¸ºæ¨¡æ¿å‚æ•°</span></span><br><span class="line">    Container&lt;NoDefaultConstructor&gt; container; <span class="comment">// è¿™ä¸€è¡Œå°†å¯¼è‡´ç¼–è¯‘é”™è¯¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£é‡Šï¼šåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>NoDefaultConstructor</code> æ˜¯ä¸€ä¸ªæ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°çš„ç±»ã€‚ç„¶åï¼Œæˆ‘ä»¬å°è¯•å°†å®ƒä½œä¸ºæ¨¡æ¿å‚æ•°ä¼ é€’ç»™æ¨¡æ¿ç±» <code>Container</code>ã€‚ç”±äº <code>Container</code> åœ¨é»˜è®¤æ„é€ å‡½æ•°ä¸­å°è¯•ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–æˆå‘˜å˜é‡ <code>obj</code>ï¼Œä½† <code>NoDefaultConstructor</code> æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œå› æ­¤ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚</p><p>**ï¼ˆ4ï¼‰**é¿å…é™åˆ¶1çš„ä¸‰ç§æ–¹æ³•</p><p><strong>æ–¹æ³•1ï¼šåœ¨å †æ ˆä¸­åˆ›å»ºæ•°ç»„ï¼Œå¹¶ä¸”ä½¿ç”¨æ˜¾ç¤ºåˆå§‹åŒ–åˆ—è¡¨</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A a[<span class="number">5</span>]=&#123;A(<span class="number">1</span>),A(<span class="number">2</span>),A(<span class="number">3</span>),A(<span class="number">4</span>),A(<span class="number">5</span>)&#125;;</span><br></pre></td></tr></table></figure><p>ç¼ºç‚¹ï¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå¦‚æœæ•°ç»„å…ƒç´ æœ‰1Wä¸ªï¼Œé‚£ä¹ˆè¦å†™1wä¸ªæ„é€ å‡½æ•°ï¼Œæ˜¾ç„¶ä¸å¯èƒ½</p><p>å¹¶ä¸”åªé€‚ç”¨äºå †æ ˆæ•°ç»„ï¼Œå †ä¸­æ²¡æœ‰æ­¤è¯­æ³•(C++ä¸­å †æ ˆæŒ‡çš„æ˜¯æ ˆ)</p><p><strong>æ–¹æ³•2ï¼šä½¿ç”¨æŒ‡é’ˆæ•°ç»„ï¼Œè€Œéå¯¹è±¡æ•°ç»„</strong></p><p>ä½¿ç”¨æŒ‡é’ˆæ•°ç»„(<strong>æŒ‡é’ˆä¸å—æ„é€ å‡½æ•°çš„æŸç¼š</strong>)ã€‚å¦‚ A* ptr_A[10];</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> EquipmentPiece* PEP;</span><br><span class="line">PEP a[<span class="number">10</span>];</span><br><span class="line">PEP *b=new PEP[<span class="number">10</span>];</span><br></pre></td></tr></table></figure><p>ç†ç”±ï¼šåœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œ<strong>æŒ‡é’ˆçš„å¤§å°é€šå¸¸æ˜¯ç›¸åŒçš„</strong>ã€‚æ— è®ºæ˜¯æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆã€æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆè¿˜æ˜¯æŒ‡å‘ä»»ä½•å…¶ä»–ç±»å‹çš„æŒ‡é’ˆï¼Œå®ƒä»¬çš„å¤§å°é€šå¸¸æ˜¯ç›¸åŒçš„ã€‚è¿™æ˜¯å› ä¸ºæŒ‡é’ˆåœ¨å†…å­˜ä¸­å­˜å‚¨çš„æ˜¯åœ°å€ï¼Œè€Œåœ°å€çš„å¤§å°åœ¨å¤§å¤šæ•°ç°ä»£è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­éƒ½æ˜¯ç›¸åŒçš„ã€‚</p><p>ä¾‹å­ï¼š</p><p>ç°åœ¨æˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œå…¶ä¸­å­˜å‚¨çš„æ˜¯æŒ‡å‘ <code>Shape</code> ç±»å¯¹è±¡çš„æŒ‡é’ˆï¼Œä½†æˆ‘ä»¬ä¸æƒ³å—åˆ°æ„é€ å‡½æ•°çš„æŸç¼šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤ŸåŠ¨æ€åœ°åˆ›å»º <code>Circle</code> å’Œ <code>Square</code> å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åˆ°æŒ‡é’ˆæ•°ç»„ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">    virtual <span class="type">void</span> <span class="title function_">draw</span><span class="params">()</span> <span class="type">const</span> = <span class="number">0</span>;</span><br><span class="line">    virtual ~Shape() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span> :</span> public Shape &#123;</span><br><span class="line">public:</span><br><span class="line">    <span class="type">void</span> <span class="title function_">draw</span><span class="params">()</span> <span class="type">const</span> override &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Drawing a circle&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span> :</span> public Shape &#123;</span><br><span class="line">public:</span><br><span class="line">    <span class="type">void</span> <span class="title function_">draw</span><span class="params">()</span> <span class="type">const</span> override &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Drawing a square&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œå­˜å‚¨ Shape ç±»å¯¹è±¡çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> size = <span class="number">2</span>;</span><br><span class="line">    Shape* shapes[size];<span class="comment">// </span></span><br><span class="line">    <span class="comment">// åˆ›å»º Circle å’Œ Square å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬çš„æŒ‡é’ˆå­˜å‚¨åˆ°æŒ‡é’ˆæ•°ç»„ä¸­</span></span><br><span class="line">    shapes[<span class="number">0</span>] = new Circle();</span><br><span class="line">    shapes[<span class="number">1</span>] = new Square();</span><br><span class="line">    <span class="comment">// éå†æŒ‡é’ˆæ•°ç»„ï¼Œè°ƒç”¨ draw() æ–¹æ³•æ¥ç»˜åˆ¶å„ç§å½¢çŠ¶</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        shapes[i]-&gt;draw();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾æŒ‡é’ˆæ•°ç»„ä¸­çš„å†…å­˜</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        delete shapes[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•°ç»„ä¸­çš„å„ä¸ªæŒ‡é’ˆå¯ä»¥ç”¨æ¥æŒ‡å‘ä¸€ä¸ªä¸ªä¸åŒçš„å¯¹è±¡</p><p>ç¼ºç‚¹ï¼š</p><p>1.ä¸å†éœ€è¦è¿™äº›å¯¹è±¡æ—¶å¿…é¡»å°†æ­¤æ•°ç»„æ‰€æŒ‡å‘çš„å¯¹è±¡åˆ é™¤ï¼Œé¿å…å†…å­˜æ³„æ¼</p><p>2.å­˜æ”¾æŒ‡é’ˆæ•°ç»„ï¼Œéœ€è¦é¢å¤–çš„ç©ºé—´</p><p><strong>æ–¹æ³•3ï¼šä½¿ç”¨å†…å­˜æ± ï¼Œä½¿ç”¨operator new[]å‡½æ•°é¢„å…ˆç”³è¯·ä¸€å—å†…å­˜ï¼Œè¦ä½¿ç”¨çš„æ—¶å€™å†ä½¿ç”¨placement new(å®šä½new)ä¾æ¬¡æ„é€ </strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EquipmentPiece</span>&#123;</span><span class="comment">//è¯¥ç±»ç¼ºä¹default constructor</span></span><br><span class="line">public:</span><br><span class="line">    EquipmentPiece(<span class="type">int</span> IDNumber)&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//åˆ†é…è¶³å¤Ÿçš„raw memoryï¼Œç»™ä¸€ä¸ªé¢„å¤‡å®¹çº³10ä¸ªEquipmentPiece å¯¹è±¡çš„æ•°ç»„ä½¿ç”¨</span></span><br><span class="line">    <span class="type">void</span> *rawMemory=operator new[](<span class="number">10</span>*<span class="keyword">sizeof</span>(EquipmentPiece));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è®©bestPiecesæŒ‡å‘æ­¤å—å†…å­˜ï¼Œä½¿å¾—è¿™å—å†…å­˜è¢«è§†ä¸ºä¸€ä¸ªEquipmentPieceæ•°ç»„</span></span><br><span class="line">    EquipmentPiece *bestPieces=static_cast&lt;EquipmentPiece*&gt;(rawMemory);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ©ç”¨placement new æ„é€ è¿™å—å†…å­˜ä¸­çš„EquipmentPieceå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">        new (&amp;bestPieces[i]) EquipmentPiece(<span class="number">1</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼šå¯ä»¥åœ¨å †ä¸­åˆ›å»ºæ•°ç»„ï¼Œå¹¶ä¸”ä¸éœ€è¦å ç”¨é¢å¤–ç©ºé—´</p><p>ç¼ºç‚¹ï¼š</p><p>1ï¼‰åœ¨æ•°ç»„å†…å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶éœ€è¦æ‰‹åŠ¨è°ƒç”¨å…¶ææ„å‡½æ•°ï¼Œç„¶åè°ƒç”¨operator delete[]é‡Šæ”¾è¿™å—å†…å­˜</p><p>2ï¼‰å¦‚æœé‡‡ç”¨ä¸€èˆ¬çš„æ•°ç»„åˆ é™¤è¯­æ³•ï¼Œç¨‹åºè¡Œä¸ºå°†ä¸å¯é¢„æœŸï¼Œå› ä¸ºåˆ é™¤ä¸€ä¸ªä¸å¯ä»¥new operatorè·å¾—çš„æŒ‡é’ˆï¼Œå…¶ç»“æœæ²¡æœ‰å®šä¹‰</p><p>**ï¼ˆ5ï¼‰**æ€»ç»“</p><p>æ·»åŠ æ²¡æœ‰æ„ä¹‰çš„default constructorï¼Œä¹Ÿä¼šå½±å“classesçš„æ•ˆç‡ï¼Œå¦‚æœmember function å¿…é¡»æµ‹è¯•å­—æ®µæ˜¯å¦çœŸè¢«åˆå§‹åŒ–äº†ï¼Œå…¶è°ƒç”¨è€…å¿…é¡»ä¸ºæµ‹è¯•è¡Œä¸ºä»˜å‡ºæ—¶é—´ä»£ä»·ï¼Œå¹¶ä¸”ä¸ºæµ‹è¯•ä»£ç ä»˜å‡ºç©ºé—´ä»£ä»·ï¼Œå› ä¸ºå¯æ‰§è¡Œæ–‡ä»¶å’Œç¨‹åºåº“éƒ½å˜å¤§äº†ï¼Œä¸‡ä¸€æµ‹è¯•ç»“æœä¸ºå¦å®šï¼Œå¯¹åº”çš„æµ‹è¯•ç¨‹åºåˆè¦ä»˜å‡ºä¸€äº›ç©ºé—´ä»£ä»·ï¼Œå¦‚æœclass constructorså¯ä»¥ç¡®ä¿å¯¹è±¡çš„æ‰€æœ‰å­—æ®µéƒ½ä¼šè¢«æ­£ç¡®åˆå§‹åŒ–ï¼Œä¸Šè¿°æ‰€æœ‰æˆæœ¬éƒ½å¯ä»¥å…é™¤ï¼Œ<strong>å¦‚æœdefault constructoræ— æ³•æä¾›è¿™ç§ä¿è¯ï¼Œé‚£ä¹ˆæœ€å¥½é¿å…è®©default constructorå‡ºç°ï¼Œè™½ç„¶è¿™å¯èƒ½ä¼šå¯¹classsesçš„ä½¿ç”¨æ–¹å¼å¸¦æ¥æŸç§é™åˆ¶ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥ä¸€ç§ä¿è¯</strong>ï¼Œå½“ä½ çœŸçš„ä½¿ç”¨äº†è¿™æ ·çš„classesï¼Œä½ å¯ä»¥é¢„æœŸä»–ä»¬æ‰€äº§ç”Ÿçš„å¯¹è±¡ä¼šè¢«å®Œå…¨çš„åˆå§‹åŒ–ï¼Œå®ç°ä¸Šä¹Ÿå¯Œæœ‰æ•ˆç‡</p><h1>Operators æ“ä½œç¬¦</h1><h2 id="æ¡æ¬¾-5ï¼šå¯¹å®šåˆ¶çš„â€œç±»å‹è½¬æ¢å‡½æ•°â€ä¿æŒè­¦è§‰">æ¡æ¬¾ 5ï¼šå¯¹å®šåˆ¶çš„â€œç±»å‹è½¬æ¢å‡½æ•°â€ä¿æŒè­¦è§‰</h2><hr><p>æ€»ç»“</p><ol><li>å•å˜é‡(æˆ–å…¶ä»–å˜é‡æœ‰é»˜è®¤å‚æ•°ï¼‰æ„é€ å‡½æ•°ctorï¼šå¯èƒ½è§¦å‘ä¸å¿…è¦çš„éšå¼è½¬æ¢ï¼Œæ‰€ä»¥å°½é‡ç”¨explictä¿®é¥°</li><li>éšå¼ç±»å‹è½¬æ¢ç¬¦æœ€å¥½åªæœ‰boolç±»å‹ï¼Œå…¶ä»–ç±»å‹çš„ç”¨åˆ«åå‡½æ•°ä»£æ›¿ï¼ˆasDoubleï¼‰</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Rational</span>&#123;</span></span><br><span class="line">    Rational(<span class="type">int</span> number, <span class="type">int</span> denominator = <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// æ¨èï¼šexlicit Rational(int numberï¼Œ int denominator = 1);</span></span><br><span class="line">    operator <span class="title function_">double</span><span class="params">()</span> <span class="type">const</span>;</span><br><span class="line">    <span class="comment">// æ¨èï¼š opeartor asDouble() const;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Rational <span class="title function_">r</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span>; <span class="comment">// 1/2</span></span><br><span class="line"><span class="comment">// æ²¡æœ‰å®šä¹‰ opeartor&lt;&lt;ï¼Œä¸ºäº†è®©&lt;&lt;è°ƒç”¨æˆåŠŸè€Œé»˜è®¤æ‰§è¡Œäº† double()</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; r &lt;&lt; <span class="built_in">endl</span>;   <span class="comment">// r-&gt;double-&gt; 0.5;</span></span><br></pre></td></tr></table></figure><hr><ol><li><p>ç¼–è¯‘å™¨å…è®¸ä½¿ç”¨å•è‡ªå˜é‡æ„é€ å‡½æ•°ï¼ˆå•ä¸€è‡ªå˜é‡æˆåŠŸè°ƒç”¨çš„ï¼‰å’Œéšå¼ç±»å‹è½¬æ¢æ“ä½œç¬¦ï¼ˆå…³é”®è¯operator ä¹‹ååŠ ä¸Šä¸€ä¸ªç±»å‹åç§°ï¼‰è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p></li><li><p>ç±»å‹è½¬æ¢å¾ˆå¯èƒ½åœ¨ä½ æœªé¢„æœŸçš„æƒ…å†µä¸‹è¿›è¡Œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Name</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line"> <span class="built_in">Name</span>(<span class="type">const</span> string&amp; s); <span class="comment">// å°† string è½¬æ¢ä¸º Name  </span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rational</span>(<span class="type">int</span> numerator = <span class="number">0</span>, <span class="type">int</span> denominator = <span class="number">1</span>); <span class="comment">// å°† int è½¬æ¢ä¸º Rational</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span>; <span class="comment">// å°† Rational è½¬æ¢ä¸º double</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è°ƒç”¨éšå¼ç±»å‹è½¬æ¢æ“ä½œç¬¦å‡½æ•°</span></span><br><span class="line"><span class="function">Rational <span class="title">r</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line"><span class="type">double</span> d = <span class="number">0.5</span> * r; <span class="comment">// å°† r è½¬æ¢ä¸º double, ç„¶åæ‰§è¡Œä¹˜æ³•è¿ç®—</span></span><br><span class="line"></span><br><span class="line">cout &lt;&lt; r; <span class="comment">// è‹¥ä½ å¹¶æœªä¸º Rational å®šä¹‰ &lt;&lt; æ“ä½œç¬¦å…¶ä¹Ÿèƒ½é€šè¿‡ç¼–è¯‘å¹¶è¿è¡Œï¼Œå› ä¸º r ä¼šéšå¼çš„è½¬æ¢ä¸ºèƒ½å’Œ &lt;&lt; åŒ¹é…çš„ç±»å‹ï¼ˆ æ­¤å¤„ä¸ºdouble ï¼‰ç±»å‹è¾“å‡º</span></span><br></pre></td></tr></table></figure></li><li><p>è§£å†³ç¬¬äºŒç‚¹çš„æ–¹æ³•æ˜¯ä»¥åŠŸèƒ½å¯¹ç­‰çš„å¦ä¸€ä¸ªå‡½æ•°å–ä»£ç±»å‹è½¬æ¢æ“ä½œç¬¦ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">asDouble</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">Rational <span class="title">r</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line">cout &lt;&lt; r; <span class="comment">// é”™è¯¯ï¼ Rationals æ²¡æœ‰ operator&lt;&lt;</span></span><br><span class="line">cout &lt;&lt; r.<span class="built_in">asDouble</span>(); <span class="comment">// ä»¥ double çš„å½¢å¼è¾“å‡º r</span></span><br></pre></td></tr></table></figure></li><li><p>å°†æ„é€ å‡½æ•°å£°æ˜ä¸º <code>explicit</code>ï¼Œç¼–è¯‘å™¨ä¾¿ä¸èƒ½å› éšå¼ç±»å‹è½¬æ¢çš„éœ€è¦è€Œè°ƒç”¨å®ƒä»¬ã€‚</p></li><li><p>å…è®¸ç¼–è¯‘å™¨æ‰§è¡Œéšå¼ç±»å‹è½¬æ¢ï¼Œå®³å¤„å°†å¤šè¿‡å¥½å¤„ã€‚æ‰€ä»¥ä¸è¦æä¾›è½¬æ¢å‡½æ•°ï¼Œé™¤éä½ ç¡®å®šä½ éœ€è¦å®ƒä»¬ã€‚</p></li></ol><h2 id="æ¡æ¬¾-6-åŒºåˆ«-increment-decrement-æ“ä½œç¬¦çš„å‰ç½®å’Œåç½®å½¢å¼">æ¡æ¬¾ 6:åŒºåˆ« increment / decrement  æ“ä½œç¬¦çš„å‰ç½®å’Œåç½®å½¢å¼</h2><ol><li><p>é‡è½½å‡½æ•°æ˜¯ä»¥å…¶<strong>å‚æ•°ç±»å‹</strong>æ¥åŒºåˆ†å½¼æ­¤çš„ï¼Œç„¶è€Œä¸è®º increment æˆ– decrement æ“ä½œç¬¦çš„å‰ç½®å¼æˆ–åç½®å¼ï¼Œéƒ½æ²¡æœ‰å‚æ•°ã€‚ä¸ºäº†å¡«å¹³è¿™ä¸ªè¯­è¨€å­¦ä¸Šçš„æ¼æ´ï¼Œåªå¥½è®©åç½®å¼æœ‰ä¸€ä¸ª int è‡ªå˜é‡ï¼Œå¹¶ä¸”åœ¨å®ƒè¢«è°ƒç”¨æ—¶ï¼Œ<strong>ç¼–è¯‘å™¨é»˜é»˜åœ°ä¸ºè¯¥ int æŒ‡å®šä¸€ä¸ª 0å€¼</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UPInt</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    UPInt&amp; <span class="keyword">operator</span>++(); <span class="comment">// prefix ++</span></span><br><span class="line">    <span class="type">const</span> UPInt <span class="keyword">operator</span>++(<span class="type">int</span>); <span class="comment">// postfix ++</span></span><br><span class="line">    </span><br><span class="line">    UPInt&amp; <span class="keyword">operator</span>--(); <span class="comment">// prefix --</span></span><br><span class="line">    <span class="type">const</span> UPInt <span class="keyword">operator</span>--(<span class="type">int</span>); <span class="comment">// postfix -- </span></span><br><span class="line">    </span><br><span class="line">    UPInt&amp; <span class="keyword">operator</span>+=(<span class="type">int</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>increment æ“ä½œç¬¦çš„å‰ç½®å¼æ„ä¹‰â€œincrement and fetchâ€ï¼ˆç´¯åŠ ç„¶åå–å‡ºï¼‰ï¼Œåç½®å¼æ„ä¹‰â€œfetch and incrementâ€ï¼ˆå–å‡ºç„¶åç´¯åŠ ï¼‰ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">UPInt&amp; UPInt::<span class="keyword">operator</span>++()</span><br><span class="line">&#123;</span><br><span class="line">    *<span class="keyword">this</span> += <span class="number">1</span>;    <span class="comment">// increment</span></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;  <span class="comment">// fetch</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> UPInt UPInt::<span class="keyword">operator</span>++(<span class="type">int</span>)</span><br><span class="line">&#123;</span><br><span class="line">    UPInt oldValue = *<span class="keyword">this</span>; <span class="comment">// fetch</span></span><br><span class="line">    ++(*<span class="keyword">this</span>);              <span class="comment">// increment</span></span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åç½®å¼ increment å’Œ decrement æ“ä½œç¬¦çš„å®ç°åº”ä»¥å…¶å‰ç½®å¼å…„å¼Ÿä¸ºåŸºç¡€ã€‚å¦‚æ­¤ä¸€æ¥ä½ å°±åªéœ€ç»´æŠ¤å‰ç½®å¼ç‰ˆæœ¬ï¼Œå› ä¸ºåç½®å¼ç‰ˆæœ¬ä¼šè‡ªåŠ¨è°ƒæ•´ä¸ºä¸€è‡´çš„è¡Œä¸ºã€‚</p></li><li><p>åç½®ç´¯åŠ æˆ–å‡æ“ä½œè¿”å›<code>const</code>å¯¹è±¡æ˜¯é˜²æ­¢ <code>i++++</code> è¡Œä¸ºã€‚</p></li></ol><h2 id="æ¡æ¬¾-7ï¼šåƒä¸‡ä¸è¦é‡è½½-ï¼Œ-å’Œ-æ“ä½œç¬¦">æ¡æ¬¾ 7ï¼šåƒä¸‡ä¸è¦é‡è½½ <code>&amp;&amp;</code>ï¼Œ<code>||</code> å’Œ <code>,</code>  æ“ä½œç¬¦</h2><ol><li><p>å’Œ C ä¸€æ ·ï¼ŒC++å¯¹äºâ€œçœŸå‡å€¼è¡¨è¾¾å¼â€é‡‡ç”¨æ‰€è°“çš„â€œéª¤æ­»å¼â€è¯„ä¼°æ–¹å¼ã€‚æ„æ€æ˜¯ä¸€æ—¦è¯¥è¡¨è¾¾å¼çš„çœŸå‡å€¼ç¡®å®šï¼Œå³ä½¿è¡¨è¾¾å¼ä¸­è¿˜æœ‰éƒ¨åˆ†å°šæœªæ£€éªŒï¼Œæ•´ä¸ªè¯„ä¼°å·¥ä½œä»å‘Šç»“æŸã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *p;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> ((p != <span class="number">0</span>) &amp;&amp; (<span class="built_in">strlen</span>(p) &gt; <span class="number">10</span>)) <span class="comment">// è‹¥ p ä¸º NULL è¡¨è¾¾å¼ç›´æ¥ä¸ºå‡ï¼Œ ä¸ä¼šè°ƒç”¨åç»­ strlen()</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½†é‡è½½çš„ <code>&amp;&amp;</code> å’Œ <code>||</code>åšä¸åˆ°â€œéª¤æ­»å¼â€ã€‚åœ¨ä¸‹åˆ—ç¤ºä¾‹ä¸­é—®é¢˜åœ¨äºï¼š1ï¼Œ<strong>å‡½æ•°è°ƒç”¨è¢«æ‰§è¡Œæ—¶æ‰€æœ‰çš„å‚æ•°éƒ½å·²è¯„ä¼°å®Œæˆï¼Œæ‰€ä»¥ <code>&amp;&amp;</code> ä¸¤è¾¹çš„è¡¨è¾¾å¼éƒ½å°†è¿è¡Œ</strong>ï¼›2ï¼Œ<strong>C++ä¸­æ²¡æœ‰è§„èŒƒå‡½æ•°è°ƒç”¨ä¸­çš„å‚æ•°çš„è¯„ä¼°é¡ºåºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸çŸ¥é“ <code>&amp;&amp;</code> ä¸¤è¾¹çš„è¡¨è¾¾å¼é‚£ä¸ªå…ˆè¿è¡Œ</strong>ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (expression1 &amp;&amp; expression2)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç­‰ä»·äº</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (expression1.<span class="keyword">operator</span>&amp;&amp;(expression2)) <span class="comment">// å‡è®¾ operator&amp;&amp; æ˜¯ä¸ªæˆå‘˜å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">operator</span>&amp;&amp;(expression1, expression2)) <span class="comment">// å‡è®¾ operator&amp;&amp; æ˜¯ä¸ªå…¨å±€å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ“ä½œç¬¦é‡è½½çš„ç›®çš„æ˜¯è¦è®©ç¨‹åºæ›´å®¹æ˜“è¢«é˜…è¯»ã€è¢«æ’°å†™ã€è¢«ç†è§£ï¼Œä¸æ˜¯ä¸ºäº†å‘åˆ«äººå¤¸è€€ä½ çŸ¥é“â€œé€—å·å…¶å®æ˜¯ä¸ªæ“ä½œç¬¦â€ã€‚å¦‚æœä½ æ²¡æœ‰ä»€ä¹ˆå¥½ç†ç”±å°†æŸä¸ªæ“ä½œç¬¦é‡è½½ï¼Œå°±ä¸è¦å»åšã€‚</p></li></ol><h2 id="æ¡æ¬¾-8ï¼šäº†è§£å„ç§ä¸åŒæ„ä¹‰çš„-new-å’Œ-delete">æ¡æ¬¾ 8ï¼šäº†è§£å„ç§ä¸åŒæ„ä¹‰çš„ <code>new</code> å’Œ <code>delete</code></h2><ol><li><p>new operatorï¼Œç¬¬ä¸€ï¼Œå®ƒåˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œç”¨æ¥æ”¾ç½®æŸç±»å‹çš„å¯¹è±¡ã€‚ä»¥ä¸Šä¾‹è€Œè¨€ï¼Œå®ƒåˆ†é…è¶³å¤Ÿæ”¾ç½®ä¸€ä¸ªstring å¯¹è±¡çš„å†…å­˜ã€‚ç¬¬äºŒï¼Œå®ƒè°ƒç”¨ä¸€ä¸ª constructorï¼Œä¸ºåˆšæ‰åˆ†é…çš„å†…å­˜ä¸­çš„é‚£ä¸ªå¯¹è±¡è®¾å®šåˆå€¼ã€‚new operator æ€»æ˜¯åšè¿™ä¸¤ä»¶äº‹ï¼Œæ— è®ºå¦‚ä½•ä½ ä¸èƒ½å¤Ÿæ”¹å˜å…¶è¡Œä¸ºã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string *ps = <span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">&quot;Memory Management&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>new operatorè°ƒç”¨æŸä¸ªå‡½æ•°ï¼Œæ‰§è¡Œå¿…è¦çš„å†…å­˜åˆ†é…åŠ¨ä½œï¼Œä½ å¯ä»¥é‡å†™æˆ–é‡è½½é‚£ä¸ªå‡½æ•°ï¼Œæ”¹å˜å…¶è¡Œä¸ºã€‚è¿™ä¸ªå‡½æ•°çš„åç§°å«åš operator newã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *rawMemory = <span class="keyword">operator</span> <span class="built_in">new</span>(<span class="built_in">sizeof</span>(string)); <span class="comment">// è°ƒç”¨ operator new</span></span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ <code>new []</code> æ—¶è¦åŒ¹é…ä½¿ç”¨ <code>delete []</code>ã€‚ã€è¿™ä¸ªåœ¨effectivate C++ä¸­æœ‰è¯¦ç»†è¯´æ˜ã€‘</p></li></ol><h1>Exceptions å¼‚å¸¸å¤„ç†</h1><h2 id="æ¡æ¬¾-9ï¼šåˆ©ç”¨ææ„å‡½æ•°é¿å…èµ„æºæ³„æ¼">æ¡æ¬¾ 9ï¼šåˆ©ç”¨ææ„å‡½æ•°é¿å…èµ„æºæ³„æ¼</h2><ol><li>ä»¥ä¸€ä¸ªå¯¹è±¡å­˜æ”¾â€œå¿…é¡»è‡ªåŠ¨é‡Šæ”¾çš„èµ„æºâ€ï¼Œå¹¶ä¾èµ–è¯¥å¯¹è±¡çš„ destructor é‡Šæ”¾â€”â€”äº¦å¯å¯¹â€œä»¥æŒ‡é’ˆä¸ºæœ¬â€ä»¥å¤–çš„èµ„æºæ–½è¡Œã€‚</li><li>æŠŠèµ„æºå°è£…åœ¨å¯¹è±¡å†…ï¼Œé€šå¸¸ä¾¿å¯ä»¥åœ¨ exceptionså‡ºç°æ—¶é¿å…æ³„æ¼èµ„æºã€‚</li></ol><p>ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">processAdoption</span><span class="params">(istream&amp; dataSource)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(dataSource)</span><br><span class="line">    &#123;</span><br><span class="line">        ALA* pa = readALA(dataSource);</span><br><span class="line">        pa-&gt;processAdoption();</span><br><span class="line">        delete pa;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å¦‚æœpa-&gt;processAdoption()è·‘å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆdelete paä¸ä¼šæ‰§è¡Œï¼Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚</p><p><strong>è§£å†³æ–¹æ³•ä¹‹ä¸€</strong>ï¼Œåˆ©ç”¨try-catchæ•æ‰ï¼Œä¸å¥½ä¹‹å¤„å°±æ˜¯ç¨‹åºæµç¨‹è¢«æ‰“ä¹±ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">processAdoption</span><span class="params">(istream&amp; dataSource)</span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(dataSource)</span><br><span class="line">    &#123;</span><br><span class="line">        ALA* pa = readALA(dataSource);</span><br><span class="line">        try&#123;</span><br><span class="line">            pa-&gt;processAdoption();</span><br><span class="line">        &#125;catch(...)&#123;</span><br><span class="line">            delete pa;</span><br><span class="line">            throw;</span><br><span class="line">        &#125;</span><br><span class="line">        delete pa;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ³•ä¹‹äºŒ</strong>ï¼Œå°±æ˜¯æ™ºèƒ½æŒ‡é’ˆï¼ˆauto_ptræ˜¯C++98çš„ï¼Œç°åœ¨æå€¡ä½¿ç”¨unique_ptrï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">processAdoption</span><span class="params">(istream&amp; dataSource)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(dataSource)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">auto_ptr&lt;ALA&gt; <span class="title">pa</span><span class="params">(readALA(dataSource))</span></span>;</span><br><span class="line">        pa-&gt;<span class="built_in">processAdoption</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ³•ä¹‹ä¸‰</strong>ï¼Œå°è£…èµ„æºï¼Œä»¤å…¶constructorå’Œdestructoråˆ†åˆ«è·å–èµ„æºå’Œé‡Šæ”¾èµ„æºï¼ˆæ¨¡ä»¿æ™ºèƒ½æŒ‡é’ˆï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ­¤å‡½æ•°å¯èƒ½æŠ›å‡ºå¼‚å¸¸ä¹‹åå‘ç”Ÿèµ„æºæ³„éœ²é—®é¢˜ã€‚</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">displayInfo</span><span class="params">(<span class="type">const</span> Information&amp; info)</span></span><br><span class="line">&#123;</span><br><span class="line">    WINDOW_HANDLE <span class="title function_">w</span><span class="params">(createWindow())</span>;</span><br><span class="line">    display info in window corresponding to w;</span><br><span class="line">    destroyWindow(w);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//å°è£…çš„ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WindowHandle</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line">    WindowHandle(WINDOW_HANDLE handle):w(handle)&#123;&#125;</span><br><span class="line">    ~WindowHandle()&#123;destroyWindow(w);&#125;</span><br><span class="line">    operator <span class="title function_">WINDOW_HANDLE</span><span class="params">()</span>&#123;<span class="keyword">return</span> w;&#125;</span><br><span class="line">private:</span><br><span class="line">    WINDOW_HANDLE w;</span><br><span class="line">    WindowHandle(<span class="type">const</span> WindowHandle&amp;);</span><br><span class="line">    WindowHandle&amp; operator=(<span class="type">const</span> WindowHandle&amp;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°çœ‹èµ·æ¥å°±åƒauto_pträ¸€æ ·ã€‚</p><p>æœ‰äº†è¿™ä¸ªå°è£…ç±»ï¼Œæˆ‘ä»¬é‡å†™displayInfoå‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">displayInfo</span><span class="params">(<span class="type">const</span> Information&amp; info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">WindowHandlew</span>(<span class="built_in">createWindow</span>());</span><br><span class="line">    display info in window corresponding to w;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å³ä½¿displayInfoè·‘å‡ºå¼‚å¸¸ï¼ŒcreateWindowäº§ç”Ÿçš„çª—å£è¿˜æ˜¯ä¼šè¢«é”€æ¯ã€‚</p><h2 id="æ¡æ¬¾-10ï¼šåœ¨æ„é€ å‡½æ•°å†…é˜»æ­¢èµ„æºæ³„æ¼">æ¡æ¬¾ 10ï¼šåœ¨æ„é€ å‡½æ•°å†…é˜»æ­¢èµ„æºæ³„æ¼</h2><p>ç”¨å‡½æ•°tryè¯­å¥å—æ¥ç¡®ä¿æ„é€ å‡½æ•°ä¸æŠ›å‡ºå¼‚å¸¸ã€ç”¨æ™ºèƒ½æŒ‡é’ˆæ¥ç®¡ç†ç±»ä¸­çš„æŒ‡é’ˆèµ„æºé¿å…æ‰‹åŠ¨é‡Šæ”¾ã€‚</p><blockquote><p>TITLEï¼šåœ¨constructorså†…é˜»æ­¢èµ„æºæ³„éœ²ï¼ˆresource leak)</p></blockquote><ol><li><p><strong>æ³¨æ„æ²¡æœ‰æ„é€ å®Œæˆçš„å¯¹è±¡ï¼Œæ˜¯æ— æ³•è¢«ææ„çš„ï¼ˆå°±æ˜¯ä¸ä¼šè°ƒç”¨ææ„å‡½æ•°ï¼‰</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename T&gt;</span><br><span class="line">Blob&lt;T&gt;::Blob(<span class="built_in">initializer_list</span>&lt;T&gt; il) try: data(make_shared&lt;<span class="built_in">vector</span>&lt;T&gt;&gt;(il) &#123; </span><br><span class="line">    <span class="comment">// å‡½æ•°ä½“</span></span><br><span class="line">&#125; catch(<span class="type">const</span> <span class="built_in">std</span>::bad_alloc &amp;e) &#123; handle_out_of_memory(e); &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><p><strong>æ€»ç»“ï¼šå¦‚æœä½ ç”¨å¯¹ç”¨çš„auto_ptrå¯¹è±¡ã€æ™ºèƒ½æŒ‡é’ˆã€‘ä»£æ›¿æŒ‡é’ˆæˆå‘˜å˜é‡ï¼Œå°±å¯ä»¥é˜²æ­¢æ„é€ å‡½æ•°å­˜åœ¨å¼‚å¸¸æ—¶å€™å¯¼è‡´èµ„æºæ³„éœ²ï¼Œä½ ä¹Ÿä¸ç”¨æ‰‹åŠ¨ææ„å‡½æ•°ä¸­é‡Šæ”¾å¯¹è±¡ï¼Œå¹¶ä¸”ä½ è¿˜èƒ½åƒä»¥å‰ä½¿ç”¨éconstæŒ‡é’ˆä¸€æ ·ä½¿ç”¨constæŒ‡é’ˆç»™å…¶èµ‹å€¼ã€‚</strong></p><h2 id="æ¡æ¬¾-11ï¼šç¦æ­¢å¼‚å¸¸æµå‡ºææ„å‡½æ•°ä¹‹å¤–">æ¡æ¬¾ 11ï¼šç¦æ­¢å¼‚å¸¸æµå‡ºææ„å‡½æ•°ä¹‹å¤–</h2><ol><li><strong>ä¸¤ç§æƒ…å†µä¸‹ destructor ä¼šè¢«è°ƒç”¨</strong>ã€‚<ol><li>ç¬¬ä¸€ç§æƒ…å†µæ˜¯å½“å¯¹è±¡åœ¨æ­£å¸¸çŠ¶æ€ä¸‹è¢«é”€æ¯ï¼Œä¹Ÿå°±æ˜¯å½“å®ƒ<strong>ç¦»å¼€äº†å®ƒçš„ç”Ÿå­˜ç©ºé—´</strong>ï¼ˆscopeï¼‰æˆ–æ˜¯è¢«æ˜ç¡®åœ°åˆ é™¤ã€‚</li><li>ç¬¬äºŒç§æƒ…å†µæ˜¯<strong>å½“å¯¹è±¡è¢« exception å¤„ç†æœºåˆ¶</strong>â€”â€”ä¹Ÿå°±æ˜¯exception ä¼ æ’­è¿‡ç¨‹ä¸­çš„ stack-unwindingï¼ˆæ ˆå±•å¼€ï¼‰æœºåˆ¶â€”é”€æ¯ã€‚</li></ol></li><li>æœ‰ä¸¤ä¸ªå¥½ç†ç”±æ”¯æŒæˆ‘ä»¬â€œå…¨åŠ›é˜»æ­¢ exceptionsä¼ å‡º destructors ä¹‹å¤–ã€‚<ol><li>ç¬¬ä¸€ï¼Œå®ƒå¯ä»¥é¿å… <strong>terminateå‡½æ•°</strong>ã€<a href="https://blog.csdn.net/wangyin159/article/details/46584257?ref=myread%E3%80%91%E5%9C%A8">https://blog.csdn.net/wangyin159/article/details/46584257?ref=myreadã€‘åœ¨</a> exceptionä¼ æ’­è¿‡ç¨‹çš„æ ˆå±•å¼€ï¼ˆstack-unwindingï¼‰æœºåˆ¶ä¸­è¢«è°ƒç”¨ã€‚</li><li>ç¬¬äºŒï¼Œå®ƒå¯ä»¥ååŠ©ç¡®ä¿  destructors  å®Œæˆå…¶åº”è¯¥å®Œæˆçš„æ‰€æœ‰äº‹æƒ…ã€‚</li></ol></li></ol><h2 id="æ¡æ¬¾-12ï¼šäº†è§£â€œæŠ›å‡ºä¸€ä¸ª-exceptionâ€ä¸â€œä¼ é€’ä¸€ä¸ªå‚æ•°â€æˆ–â€œè°ƒç”¨ä¸€ä¸ªè™šå‡½æ•°â€ä¹‹é—´çš„å·®å¼‚">æ¡æ¬¾ 12ï¼šäº†è§£â€œæŠ›å‡ºä¸€ä¸ª exceptionâ€ä¸â€œä¼ é€’ä¸€ä¸ªå‚æ•°â€æˆ–â€œè°ƒç”¨ä¸€ä¸ªè™šå‡½æ•°â€ä¹‹é—´çš„å·®å¼‚</h2><ol><li>åŸå› æ˜¯å½“ä½ è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œæ§åˆ¶æƒæœ€ç»ˆä¼šå›åˆ°è°ƒç”¨ç«¯ï¼ˆé™¤éå‡½æ•°å¤±è´¥ä»¥è‡³äºæ— æ³•è¿”å›ï¼‰ï¼Œä½†æ˜¯å½“ä½ æŠ›å‡ºä¸€ä¸ª exceptionï¼Œæ§åˆ¶æƒä¸ä¼šå†å›åˆ°æŠ›å‡ºç«¯ã€‚</li><li>ä¸€ä¸ªå¯¹è±¡è¢«æŠ›å‡ºä½œä¸º exceptionæ—¶ï¼Œæ€»æ˜¯ä¼šå‘ç”Ÿå¤åˆ¶ï¼ˆcopyï¼‰ã€‚</li><li>å¼‚å¸¸åªå…³å¿ƒé™æ€ç±»å‹ã€‚</li><li>exceptions ä¸ <code>catch </code>å­å¥ç›¸åŒ¹é…â€çš„è¿‡ç¨‹ä¸­ï¼Œä»…æœ‰ä¸¤ç§è½¬æ¢å¯ä»¥å‘ç”Ÿã€‚ç¬¬ä¸€ç§æ˜¯â€œç»§æ‰¿æ¶æ„ä¸­çš„ç±»è½¬æ¢ï¼ˆinheritance-based conversionsï¼‰â€ã€‚ç¬¬äºŒä¸ªå…è®¸å‘ç”Ÿçš„è½¬æ¢æ˜¯ä»ä¸€ä¸ªâ€œæœ‰å‹æŒ‡é’ˆâ€è½¬ä¸ºâ€œæ— å‹æŒ‡é’ˆâ€ï¼Œæ‰€ä»¥ä¸€ä¸ªé’ˆå¯¹ <code>const void* </code>æŒ‡é’ˆè€Œè®¾è®¡çš„ catchå­å¥ï¼Œå¯æ•æ‰ä»»ä½•æŒ‡é’ˆç±»å‹çš„ exceptionã€‚</li><li><code>catch </code>å­å¥æ€»æ˜¯ä¾å‡ºç°é¡ºåºåšåŒ¹é…å°è¯•ã€‚</li><li>è™šå‡½æ•°éµå¾ªæœ€ä½³å»åˆç­–ç•¥ï¼ˆbest fitï¼‰ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶éµå¾ªæœ€å…ˆå»åˆç­–ç•¥ï¼ˆfirst fitï¼‰ã€‚ å› æ­¤ç»ä¸è¦å°†â€œé’ˆå¯¹base class è€Œè®¾è®¡çš„ catchå­å¥â€æ”¾åœ¨â€œé’ˆå¯¹ derived class è€Œè®¾è®¡çš„catch å­å¥â€ä¹‹å‰ã€‚</li></ol><h2 id="æ¡æ¬¾-13ï¼šä»¥-by-reference-çš„æ–¹å¼æ•æ‰å¼‚å¸¸">æ¡æ¬¾ 13ï¼šä»¥ by reference çš„æ–¹å¼æ•æ‰å¼‚å¸¸</h2><ol><li><p>ä¸è¦ä»¥æŒ‡é’ˆçš„æ–¹å¼æŠ›å‡ºå¼‚å¸¸ï¼Œä¼šæœ‰ä½•æ—¶é‡Šæ”¾èµ„æºçš„éš¾é¢˜ï¼Œä¹Ÿæ— æ³•æ•æ‰æ ‡å‡†å¼‚å¸¸ã€‚</p></li><li><p>ä½¿ç”¨ä¼ å€¼çš„æ–¹å¼æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œæ¯æ¬¡æœ‰å¼‚å¸¸æŠ›å‡ºï¼Œå°†å‘ç”Ÿå¤åˆ¶ä¸¤æ¬¡ã€‚å½“æ´¾ç”Ÿç±»å¯¹è±¡è¢«æ¥æ”¶åŸºç±»å¼‚å¸¸çš„<code>catch</code>æ•æ‰æ—¶ï¼Œå°†å‘ç”Ÿå¯¹è±¡åˆ‡å‰²ï¼ŒåŒæ—¶ï¼Œå½“å…¶è™šå‡½æ•°åœ¨å¼‚å¸¸ä¸­è°ƒç”¨æ—¶ï¼Œå°†è¢«è§£æä¸ºåŸºç±»çš„è™šå‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">exception</span> <span class="comment">// æ ‡å‡†çš„ exception class</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">what</span><span class="params">()</span> <span class="title">throw</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">runtime_error</span>: <span class="keyword">public</span> exception &#123; ... &#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Validation_error</span>: <span class="keyword">public</span> runtime_error <span class="comment">// æ–°å¢çš„ class</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">what</span><span class="params">()</span> <span class="title">throw</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">someFunction</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (a validation test fails)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">Validation_error</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doSomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">someFunction</span>();    <span class="comment">// å¯èƒ½ä¼šæŠ›å‡ºä¸€ä¸ªæœ‰æ•ˆçš„ exception</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (exception ex)   <span class="comment">// æ•æ‰æ ‡å‡†ç»§æ‰¿ä½“ç³»å†…çš„æ‰€ä»¥ exceptions ï¼ˆæˆ–å…¶æ´¾ç”Ÿç±»ï¼‰</span></span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; ex.<span class="built_in">what</span>(); <span class="comment">// è°ƒç”¨çš„æ˜¯ exception::what() </span></span><br><span class="line">        ...                <span class="comment">// è€Œä¸æ˜¯ Validation_error::what()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>æ€»ç»“ï¼š</p><ol><li>by referenceæ•æ‰å¼‚å¸¸çš„å¥½å¤„æœ‰3ï¼šâ‘ throwå¯¹è±¡ä¸ä¼šè¢«åˆ‡å‰²ã€â‘¡æ ‡å‡†åº“é‡Œexception é€šå¸¸éƒ½throwå¯¹è±¡ï¼ˆæˆ‘ä»¬æˆ‘ä»¬ç”¨by pointerç±»å‹ä¸åŒ¹é…ï¼‰ï¼Œè€Œrefernceå¯ä»¥ç»‘å®šå¯¹è±¡ã€â‘¢çº¦æŸäº†exception objå¤åˆ¶çš„æ¬¡æ•°ï¼ˆå°±throwæ—¶å¤åˆ¶ä¸€æ¬¡ï¼‰</li><li>by pointerç¼ºç‚¹ï¼šä¸ç¬¦åˆä¸Šè¿°â‘¡ï¼Œæ ‡å‡†åº“é‡Œéƒ½throwå¯¹è±¡</li><li>by valueç¼ºç‚¹ï¼šä¸ç¬¦åˆä¸Šè¿°â‘ ï¼Œthrowå‡ºçš„å¯¹è±¡ä¼šè¢«åˆ‡å‰²ï¼Œæ— æ³•è°ƒç”¨è™šå‡½æ•°ã€‚</li></ol><h2 id="æ¡æ¬¾-14ï¼šæ˜æ™ºè¿ç”¨-exception-specifications">æ¡æ¬¾ 14ï¼šæ˜æ™ºè¿ç”¨ exception specifications</h2><h2 id="æ¡æ¬¾-15ï¼šäº†è§£å¼‚å¸¸å¤„ç†">æ¡æ¬¾ 15ï¼šäº†è§£å¼‚å¸¸å¤„ç†</h2><h1>Efficiency æ•ˆç‡</h1><h2 id="æ¡æ¬¾-16ï¼šè°¨è®°-80-20-æ³•åˆ¶">æ¡æ¬¾ 16ï¼šè°¨è®° 80-20 æ³•åˆ¶</h2><ol><li>è½¯ä»¶ä¸­çš„80%çš„æ—¶é—´æµªè´¹åœ¨äº†20%çš„ä»£ç ä¸Šã€‚</li></ol><h2 id="æ¡æ¬¾-17ï¼šè€ƒè™‘ä½¿ç”¨-lazy-evaluation">æ¡æ¬¾ 17ï¼šè€ƒè™‘ä½¿ç”¨ lazy evaluation</h2><ol><li><p>ä»æ•ˆç‡çš„è§‚ç‚¹æ¥çœ‹ï¼Œæœ€å¥½çš„è¿ç®—æ˜¯ä»æœªè¢«æ‰§è¡Œçš„è¿ç®—ã€‚</p></li><li><p><strong>Reference Countingï¼ˆå¼•ç”¨è®¡æ•°ï¼‰-  é¿å…éå¿…è¦çš„å¯¹è±¡å¤åˆ¶</strong>ï¼šåœ¨ä½ çœŸæ­£éœ€è¦ä¹‹å‰ï¼Œä¸å¿…ç€æ€¥ä¸ºæŸç‰©åšä¸€ä¸ªå‰¯æœ¬ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œä»¥æ‹–å»¶æˆ˜æœ¯åº”ä»˜ä¹‹â€”â€”åªè¦èƒ½å¤Ÿï¼Œå°±ä½¿ç”¨å…¶ä»–å‰¯æœ¬ã€‚åœ¨æŸäº›åº”ç”¨é¢†åŸŸï¼Œä½ å¸¸æœ‰å¯èƒ½æ°¸è¿œä¸éœ€è¦æä¾›é‚£æ ·ä¸€ä¸ªå‰¯æœ¬ã€‚</p><ol><li><strong>æ¯”å¦‚string s2 = s1ï¼Œä½†æ˜¯åç»­çš„æ“ä½œop1_s2, op2_s2ï¼Œç­‰ç­‰éƒ½æ˜¯ä¸æ”¹å˜s2çš„ï¼Œæ‰€ä»¥åªè¦è®©s2å’Œs1å…±äº«å³å¯ï¼Œå½“çœŸæ­£è¦æ”¹å˜s2æ—¶æ‰æ‹·è´s1ã€‚</strong></li></ol></li><li><p><strong>åŒºåˆ†è¯»å’Œå†™</strong>:è¯»å–æ“ä½œå¾€å¾€ä»£ä»·ä½å»‰ï¼Œå†™æ“ä½œå¯èƒ½æ•ˆç‡ä½ï¼Œå¼€é”€å¤§ã€‚å¦‚æœèƒ½å»¶ç¼“å†³å®šâ€œç©¶ç«Ÿæ˜¯è¯»è¿˜æ˜¯å†™ï¼Œç›´åˆ°èƒ½ç¡®å®šä¸ºæ­¢â€å°†æé«˜æ•ˆç‡ã€‚</p><ol><li><strong>å¯¹äºä¸€ä¸ªreferä½†æ˜¯æ­¤å¤„æ³•æ— æ³•åˆ¤å®šæ˜¯å¦èƒ½åŒºåˆ†ï¼Œå¦‚æœèƒ½å¤Ÿåœ¨operator[]é‡Œé¢åŒºåˆ†è¯»å’Œå†™ï¼Œå°±å¯ä»¥åˆ¤å®šéœ€ä¸éœ€è¦åšé¢å¤–çš„æ“ä½œã€‚s[3]ä½œä¸ºå·¦è¾¹çš„å€¼æ˜¯å†™ï¼Œs[3]ä½œä¸ºå³è¾¹çš„å€¼æ˜¯è¯»ã€‚</strong></li></ol></li><li><p>Lazy Fetchingï¼ˆç¼“å¼å–å‡ºï¼‰ï¼šç”Ÿäº§ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œåªäº§ç”Ÿè¯¥å¯¹è±¡çš„â€œå¤–å£³â€ï¼Œä¸ä»ç£ç›˜è¯»å–ä»»ä½•å­—æ®µæ•°æ®ã€‚å½“å¯¹è±¡å†…çš„æŸä¸ªå­—æ®µè¢«éœ€è¦äº†ï¼Œç¨‹åºæ‰å–å›å¯¹åº”çš„æ•°æ®ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LargeObject</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">LargeObject</span>(ObjectID id);</span><br><span class="line">    <span class="function"><span class="type">const</span> string&amp; <span class="title">field1</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">field2</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">field3</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> string&amp; <span class="title">field4</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    ...</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    ObjectID oid;</span><br><span class="line">    <span class="keyword">mutable</span> string *field1Value;</span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">int</span> *field2Value;</span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">double</span> *field3Value;</span><br><span class="line">    <span class="keyword">mutable</span> string *field4Value;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">LargeObject::<span class="built_in">LargeObject</span>(ObjectID id)</span><br><span class="line">    : <span class="built_in">oid</span>(id), <span class="built_in">field1Value</span>(<span class="number">0</span>), <span class="built_in">field2Value</span>(<span class="number">0</span>), <span class="built_in">field3Value</span>(<span class="number">0</span>), ...&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">const</span> string&amp; <span class="title">LargeObject::field1</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (field1Value == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//read the data for field 1 from the database and </span></span><br><span class="line">        <span class="comment">//meke field1Value point to it;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> *field1Value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Lazy Expression Evaluationï¼ˆè¡¨è¾¾å¼ç¼“è¯„ä¼°ï¼‰ï¼šå°†è¡¨è¾¾å¼çš„å€¼æš‚å­˜èµ·æ¥ï¼Œéœ€è¦æ—¶å†è®¡ç®—å®ƒï¼ˆå¾€å¾€éœ€è¦åªä¸€éƒ¨åˆ†ï¼Œåˆ™åªè®¡ç®—ä¸€éƒ¨åˆ†ï¼‰ã€‚</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">template&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span>&#123;</span>...&#125;;<span class="comment">//for homogeneous matrices</span></span><br><span class="line"> </span><br><span class="line">Matrix&lt;<span class="type">int</span>&gt; <span class="title function_">m1</span><span class="params">(<span class="number">1000</span>,<span class="number">1000</span>)</span>;<span class="comment">//ä¸€ä¸ª1000*1000çš„çŸ©é˜µ</span></span><br><span class="line">Matrix&lt;<span class="type">int</span>&gt; <span class="title function_">m2</span><span class="params">(<span class="number">1000</span>,<span class="number">1000</span>)</span>;</span><br><span class="line">...</span><br><span class="line">Matrix&lt;<span class="type">int</span>&gt; m3 = m1 + m2;</span><br></pre></td></tr></table></figure><p>è¿‡operator çš„å®ç°æ˜¯eagar evaluationï¼šåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä¼šè®¡ç®—å’Œè¿”å›m1 ä¸ m2çš„å’Œã€‚è¿™ä¸ªè®¡ç®—é‡éå¸¸å¤§ï¼ˆ100000æ¬¡åŠ æ³•è¿ç®—ï¼‰ï¼Œå½“ç„¶ç³»ç»Ÿä¼šåˆ†é…å†…å­˜æ¥å­˜å‚¨è¿™ä¸ªå€¼ã€‚</p><p>lazy evaluationæ–¹æ³•å°±æ˜¯å»ºç«‹ä¸€ä¸ªæ•°æ®ç»“æ„æ¥è¡¨ç¤ºm3çš„å€¼æ˜¯m1å’Œm2çš„å’Œï¼Œå†ç”¨ä¸€ä¸ªenumæ¥è¡¨ç¤ºå®ƒä»¬ä¹‹é—´çš„åŠ æ³•ï¼Œè¿™æ ·æ•°æ®ç»“æ„è¦æ¯”m1å’Œm2ç›¸åŠ å¿«è®¸å¤šï¼Œä¹Ÿèƒ½èŠ‚çº¦å†…å­˜ã€‚</p></li></ol><h2 id="æ¡æ¬¾-18ï¼šåˆ†æœŸæ‘Šè¿˜é¢„æœŸçš„è®¡ç®—æˆæœ¬">æ¡æ¬¾ 18ï¼šåˆ†æœŸæ‘Šè¿˜é¢„æœŸçš„è®¡ç®—æˆæœ¬</h2><ol><li><p>Over-eager evaluation èƒŒåçš„è§‚å¿µæ˜¯ï¼Œå¦‚æœä½ é¢„æœŸç¨‹åºå¸¸å¸¸ä¼šç”¨åˆ°æŸä¸ªè®¡ç®—ï¼Œä½ å¯ä»¥é™ä½æ¯æ¬¡è®¡ç®—çš„å¹³å‡æˆæœ¬ï¼ŒåŠæ³•å°±æ˜¯è®¾è®¡ä¸€ä»½æ•°æ®ç»“æ„ä»¥ä¾¿èƒ½å¤Ÿææœ‰æ•ˆç‡åœ°å¤„ç†éœ€æ±‚ã€‚</p></li><li><p>å°†â€œå·²ç»è®¡ç®—å¥½è€Œæœ‰å¯èƒ½å†è¢«éœ€è¦â€çš„æ•°å€¼ä¿ç•™ä¸‹æ¥ï¼ˆæ‰€è°“ cachingï¼‰ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">findCubicleNumber</span><span class="params">(<span class="type">const</span> string&amp; employeeName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">typedef</span> map&lt;string, <span class="type">int</span>&gt; CubicleMap;</span><br><span class="line">    <span class="type">static</span> CubicleMap cubes;   <span class="comment">// å±€éƒ¨ç¼“å­˜</span></span><br><span class="line">    </span><br><span class="line">    CubicleMap::iterator it = cubes.<span class="built_in">find</span>(employeeName);</span><br><span class="line">    <span class="keyword">if</span> (it == cubes.end)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> cubicle = <span class="comment">/* the result of looking up employeeName&#x27;s cubicle number</span></span><br><span class="line"><span class="comment">                         in the database */</span></span><br><span class="line">        cubes[employeeName] = cubicle;</span><br><span class="line">        <span class="keyword">return</span> cubicle;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">return</span> (*it).second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ Prefetchingï¼ˆé¢„å…ˆå–å‡ºï¼‰</p></li><li><p>å½“ä½ å¿…é¡»æ”¯æŒæŸäº›è¿ç®—è€Œå…¶ç»“æœå‡ ä¹æ€»æ˜¯è¢«éœ€è¦ï¼Œæˆ–å…¶ç»“æœå¸¸å¸¸è¢«å¤šæ¬¡éœ€è¦çš„æ—¶å€™ï¼Œover-eager evaluation å¯ä»¥æ”¹å–„ç¨‹åºæ•ˆç‡ã€‚</p></li></ol><h2 id="æ¡æ¬¾-19ï¼šäº†è§£ä¸´æ—¶å¯¹è±¡çš„æ¥æº">æ¡æ¬¾ 19ï¼šäº†è§£ä¸´æ—¶å¯¹è±¡çš„æ¥æº</h2><p>åªè¦ä½ äº§ç”Ÿä¸€ä¸ªno-heap-objectè€Œæ²¡æœ‰ä¸ºå®ƒå‘½åï¼Œä¾¿äº§ç”Ÿäº†ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ã€‚</p><p>ä¸´æ—¶å¯¹è±¡çš„äº§ç”Ÿé€”å¾„ï¼š</p><ul><li><p>å½“éšå¼å‹åˆ«è½¬æ¢è¢«æ–½è¡Œèµ·æ¥ä»¥æ±‚å‡½æ•°èƒ½å¤Ÿè°ƒç”¨æˆåŠŸã€‚</p></li><li><p>å½“å‡½æ•°è¿”å›å¯¹è±¡çš„æ—¶å€™ã€‚</p></li></ul><p>1.<strong>å½“éšå¼å‹åˆ«è½¬æ¢è¢«æ–½è¡Œèµ·æ¥ä»¥æ±‚å‡½æ•°èƒ½å¤Ÿè°ƒç”¨æˆåŠŸ</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">countChar</span><span class="params">(<span class="type">const</span> <span class="built_in">string</span>&amp; str,<span class="type">char</span> ch)</span>&#123;</span><br><span class="line"><span class="built_in">cout</span>&lt;&lt;str;<span class="comment">//ç»Ÿè®¡å­—ç¬¦å‡ºç°çš„ä¸ªæ•°ï¼Œç•¥æ‰</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">     <span class="type">char</span> buffer[<span class="number">20</span>];</span><br><span class="line"> <span class="type">char</span> c;</span><br><span class="line"> <span class="built_in">cin</span>&gt;&gt;c&gt;&gt;buffer;</span><br><span class="line"> <span class="built_in">cout</span>&lt;&lt;countChar(buffer,c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¦ç‚¹</strong></p><p>è§£é‡Šï¼šåˆ©ç”¨char buffer[20]è°ƒç”¨countChar(string&amp; str,char ch)éœ€è¦åšå“ªäº›äº‹æƒ…å‘¢ï¼Ÿ</p><p>é‡ç‚¹ï¼šå…ˆè½¬åŒ–ï¼Œæ„é€ ä¸€ä¸ªstringç±»å‹çš„ä¸´æ—¶å¯¹è±¡ï¼Œä»¥bufferä¸ºè‡ªå˜é‡ï¼Œè°ƒç”¨string constructorï¼Œ<strong>strå°±ä¼šç»‘å®šåœ¨ä¸´æ—¶å¯¹è±¡ä¸Šé¢ã€åœ¨è°ƒç”¨å‡½æ•°çš„æ—¶å€™å­˜åœ¨è°ƒç”¨æ ˆä¸Šã€‘</strong>ã€‚</p><p>ã€<strong>é‡ç‚¹ä¸­çš„é‡ç‚¹</strong>ã€‘<strong>è¯·æ³¨æ„ï¼Œè¿™è¾¹stræ˜¯const string &amp;ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ä¸å…è®¸æ”¹å˜strçš„å€¼ï¼Œå³ç»‘å®šåœ¨è¯¥ä¸´æ—¶å¯¹è±¡ä¸Šé¢ï¼Œè¯»å–ä¸´æ—¶å¯¹è±¡çš„å€¼ï¼Œè€Œæ²¡æœ‰æ”¹å˜ä¸´æ—¶å¯¹è±¡çš„å€¼ï¼Œæ”¹å˜ä¸´æ—¶å¯¹è±¡çš„å€¼æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä¸´æ—¶å¯¹è±¡ä¼šè¢«é”€æ¯ã€‚</strong></p><p>åªæœ‰å½“å¯¹è±¡ä»¥ by value(ä¼ å€¼)æ–¹å¼ä¼ é€’ï¼Œæˆ–æ˜¯å½“å¯¹è±¡è¢«ä¼ é€’ç»™ä¸€ä¸ªreference-to-constï¼ˆå¸¸å¼•ç”¨ï¼‰å‚æ•°æ—¶ï¼Œè½¬æ¢æ‰ä¼šå‘ç”Ÿã€‚å½“å¯¹è±¡ä¼ é€’ç»™ä¸€ä¸ªreference-to-non-constå‚æ•°ï¼Œå¹¶ä¸ä¼šå‘ç”Ÿæ­¤ç§è½¬æ¢ã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">countChar</span><span class="params">( string&amp; str,<span class="type">char</span> ch)</span>&lt;/strong&gt;</span>&#123;</span><br><span class="line">cout&lt;&lt;str;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">     <span class="type">char</span> buffer[<span class="number">20</span>];</span><br><span class="line"> <span class="type">char</span> c;</span><br><span class="line"> cin&gt;&gt;c&gt;&gt;buffer;</span><br><span class="line"> cout&lt;&lt;<span class="built_in">countChar</span>(buffer,c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†ä¸Šè¿°çš„<code>size_t countChar(const string&amp; str,char ch)</code> ä¿®æ”¹ä¸º<code>size_t countChar( string&amp; str,char ch)</code>ï¼Œç¼–è¯‘ç«‹åˆ»å‡ºé”™</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">error </span>C2664: â€œcountCharâ€: ä¸èƒ½å°†å‚æ•° 1 ä»â€œchar [20]â€è½¬æ¢ä¸ºâ€œstd::string &amp;â€</span><br></pre></td></tr></table></figure><p>å³æ— æ³•è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p><p><strong>ç†ç”±ï¼šstring&amp; str æ˜¯ references-to-non-const ,å¦‚æœç¼–è¯‘å™¨é’ˆå¯¹ references-to-non-const å¯¹è±¡è¿›è¡Œéšå¼å‹åˆ«è½¬æ¢ï¼Œä¼šå…è®¸ä¸´æ—¶å¯¹è±¡è¢«æ”¹å˜ã€‚æ”¹å˜ä¸´æ—¶å¯¹è±¡æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚references-to-constå‚æ•°åˆ™ä¸éœ€è¦æ‰¿æ‹…è¿™ä¸€é—®é¢˜ï¼Œå› ä¸ºæ­¤å‚æ•°ä¸ºconstï¼Œæ— æ³•æ”¹å˜å…¶å†…å®¹ã€‚</strong></p><p><strong>2.å½“å‡½æ•°è¿”å›å¯¹è±¡çš„æ—¶å€™ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> Number operator+(<span class="type">const</span> Number&amp; lhs, <span class="type">const</span> Number&amp; rhs) &#123;</span><br><span class="line">    <span class="keyword">return</span> Obj(lhs)+=rhs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿”å›å¯ä»¥ç”¨ç±»ä¼¼å¤åˆè¯­å¥(+=, -=ï¼Œâ€¦)æ¥ä¼˜åŒ–è¿”å›æ—¶ä¸´æ—¶å¯¹è±¡çš„ä¸ªæ•°ã€‚</li><li>æ³¨æ„å‡½æ•°è¿”å›å¼•ç”¨ï¼šæ˜¯ä¸äº§ç”Ÿä¸´æ—¶å¯¹è±¡çš„ã€‚</li></ul><h2 id="æ¡æ¬¾-20ï¼šååŠ©å®Œæˆâ€è¿”å›å€¼ä¼˜åŒ–ï¼ˆreturn-value-optimizationï¼‰â€œ">æ¡æ¬¾ 20ï¼šååŠ©å®Œæˆâ€è¿”å›å€¼ä¼˜åŒ–ï¼ˆreturn value optimizationï¼‰â€œ</h2><ol><li><p>å°½é‡å†™å‡ºç¼–è¯‘å™¨å¯å¸®ä½ æ¶ˆé™¤ä¸´æ—¶å¯¹è±¡+è¿”å›å€¼å¯¹è±¡çš„æ‹·è´çš„ä»£ç </p></li><li><p>å¦‚æœè¿˜å¯ä»¥å°†å‡½æ•°inlineï¼Œç¼–è¯‘å™¨è¿˜æ¶ˆé™¤äº†å‡½æ•°è°ƒç”¨çš„æˆæœ¬</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="type">const</span> Rational <span class="keyword">operator</span>*(<span class="type">const</span> Rational&amp; lhs, <span class="type">const</span> Rational&amp; rhs) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Rational</span>(lhs.<span class="built_in">numberator</span>() * rhs.<span class="built_in">number</span>(), ...); </span><br><span class="line">    <span class="comment">// è¿™å°±æ˜¯ctor argumentsï¼Œç›´æ¥ä¸€ä¸ªreturn æ²¡æœ‰ä¸´æ—¶å¯¹è±¡çš„æˆæœ¬ï¼Œå°±èƒ½å¤Ÿè¢«ç¼–è¯‘å™¨ä¼˜åŒ–ï¼</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ€»å…±ä¸¤ä¸ªæˆæœ¬ï¼š</span></span><br><span class="line">    <span class="comment">//  1. ä¸´æ—¶å¯¹è±¡çš„æˆæœ¬ï¼šRational(lhs.numberator() * rhs.number(), ...); </span></span><br><span class="line">    <span class="comment">//  2. ByValueè¿”å›å€¼çš„æˆæœ¬ï¼šå› ä¸ºä½ const Rational&amp; åœ¨è¿™é‡Œæ— æ³•åŠåˆ°</span></span><br><span class="line">&#125;</span><br><span class="line">Rational c = a * b;  <span class="comment">// è°ƒç”¨è¿™ä¸ªæ—¶èƒ½å¤Ÿè¢«å¿½ç•¥ï¼ï¼</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="æ¡æ¬¾-21ï¼šåˆ©ç”¨é‡è½½æŠ€æœ¯é¿å…éšå¼è½¬æ¢">æ¡æ¬¾ 21ï¼šåˆ©ç”¨é‡è½½æŠ€æœ¯é¿å…éšå¼è½¬æ¢</h2><ol><li><strong>æ¯ä¸ªâ€œé‡è½½æ“ä½œç¬¦â€å¿…é¡»è·å¾—è‡³å°‘ä¸€ä¸ªâ€œç”¨æˆ·å®šåˆ¶ç±»å‹â€çš„è‡ªå˜é‡ã€‚</strong></li></ol><p>ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UPInt</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">UPInt</span>();</span><br><span class="line"><span class="built_in">UPInt</span>(<span class="type">int</span> value);</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> UPInt <span class="keyword">operator</span>+(<span class="type">const</span> UPInt* lhs,<span class="type">const</span> UPInt* rhs);</span><br><span class="line"> </span><br><span class="line">UPInt upi1,upi2;</span><br><span class="line">...</span><br><span class="line">UPInt upi3 = upi1 +upi2;</span><br></pre></td></tr></table></figure><p>ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">upi3 = upi1 + <span class="number">10</span>;</span><br><span class="line">upi3 = <span class="number">10</span> + upi1;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„10ä¼šå»ºç«‹ä¸´æ—¶å¯¹è±¡æŠŠæ•´å‹10è½¬æ¢æˆUPIntï¼Œç»å†è½¬æ¢ä¼šæœ‰å¼€é”€ã€‚</p><p>ä¸ºäº†é¿å…å¼€é”€ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æŠŠUPIntå’Œintå¯¹è±¡ç›¸åŠ ï¼Œé€šè¿‡å£°æ˜å‡½æ•°æ¥è¾¾åˆ°ç›®çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UPInt operator+(<span class="type">const</span> UPInt* lhs,<span class="type">const</span> UPInt* rhs);<span class="comment">//UPIntç›¸åŠ </span></span><br><span class="line"><span class="type">const</span> UPInt operator+(<span class="type">const</span> UPInt* lhs,<span class="type">int</span> rhs); <span class="comment">//UPIntå’Œintç›¸åŠ </span></span><br><span class="line"><span class="type">const</span> UPInt operator+(<span class="type">int</span> lhs,<span class="type">const</span> UPInt* rhs); <span class="comment">//intå’ŒUPIntç›¸åŠ </span></span><br><span class="line">UPInt upi1,upi2;</span><br><span class="line">...</span><br><span class="line">UPInt upi3 = upi1 +upi2;<span class="comment">//UPIntç›¸åŠ </span></span><br><span class="line"> </span><br><span class="line">upi3 = upi1 + <span class="number">10</span>;<span class="comment">//ä¸ä¼šç”Ÿæˆä¸´æ—¶å¯¹è±¡</span></span><br><span class="line">upi3 = <span class="number">10</span> + upi1;<span class="comment">//ä¸ä¼šç”Ÿæˆä¸´æ—¶å¯¹è±¡</span></span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼š</p><p><strong>C++è§„å®šï¼šæ¯ä¸€ä¸ªé‡è½½çš„operatorå¿…é¡»å¸¦æœ‰ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰ç±»å‹</strong>ã€‚ä¹Ÿåœ¨æœ¬æ¡æ¬¾çš„æœ€å‰é¢ç»™å‡ºã€‚</p><p>é”™è¯¯ä»£ç </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UPInt <span class="keyword">operator</span>+(<span class="type">int</span> lhs,<span class="type">int</span> rhs);</span><br></pre></td></tr></table></figure><h2 id="æ¡æ¬¾-22ï¼šè€ƒè™‘ä»¥æ“ä½œç¬¦å¤åˆå½¢å¼å–ä»£å…¶ç‹¬èº«å½¢å¼">æ¡æ¬¾ 22ï¼šè€ƒè™‘ä»¥æ“ä½œç¬¦å¤åˆå½¢å¼å–ä»£å…¶ç‹¬èº«å½¢å¼</h2><p>å¯¹äºä¸‹é¢çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x = x + y ; x = x - y;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x += y;  x -= y;</span><br></pre></td></tr></table></figure><p>æ­£å¦‚è¿™ä¸ªæ¡æ¬¾çš„é¢˜ç›®æ‰€è¨€ï¼š</p><p><strong>ä»¥æ“ä½œç¬¦å¤åˆå½¢å¼å–ä»£å…¶ç‹¬èº«å½¢å¼</strong>ã€‚operatorçš„å¤åˆå½¢å¼ä¸ä¸€ä¸ªå•ç‹¬å½¢å¼ä¹‹é—´å­˜åœ¨æ­£å¸¸çš„å…³ç³»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//operator+æ ¹æ®operator+=æ¥å®ç°</span></span><br><span class="line"><span class="type">const</span> Rational operator+(<span class="type">const</span> Rational&amp; lhs,<span class="type">const</span> Rational&amp; rhs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> Rational(lhs) += rhs;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//operator-æ ¹æ®operator-=æ¥å®ç°</span></span><br><span class="line"><span class="type">const</span> Rational operator-(<span class="type">const</span> Rational&amp; lhs,<span class="type">const</span> Rational&amp; rhs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> Rational(lhs) -= rhs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½å¤„ï¼š</p><p><strong>operatorå¤åˆå½¢å¼æ¯”å•ç‹¬å½¢å¼æ•ˆç‡é«˜</strong>ï¼Œ<strong>å› ä¸ºå•ç‹¬å½¢å¼è¦è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€å› ä¸ºè¦åˆ›å»ºä¸ªæ–°å¯¹è±¡ä½œä¸ºæœ€ç»ˆçš„å€¼ã€‘</strong>ï¼Œ<strong>ä»è€Œåœ¨ä¸´æ—¶å¯¹è±¡çš„æ„é€ å’Œé‡Šæ”¾æœ‰ä¸€äº›å¼€é”€ï¼Œoperatorå¤åˆå½¢å¼æŠŠç»“æœå†™åˆ°å·¦è¾¹çš„å‚æ•°é‡Œï¼Œå› æ­¤ä¸éœ€è¦ä¸´æ—¶å¯¹è±¡æ¥å®¹çº³operatorçš„è¿”å›å€¼</strong>ã€‚</p><h2 id="æ¡æ¬¾-23ï¼šè€ƒè™‘ä½¿ç”¨å…¶ä»–ç¨‹åºåº“">æ¡æ¬¾ 23ï¼šè€ƒè™‘ä½¿ç”¨å…¶ä»–ç¨‹åºåº“</h2><p>iostreamå’Œstdioä¹‹é—´æ€§èƒ½çš„å¯¹æ¯”ã€‚</p><p>æˆ‘ä»¬éœ€è¦æœ‰è¿™æ ·çš„æ„è¯†ï¼Œå…·æœ‰ç›¸åŒåŠŸèƒ½çš„ä¸åŒçš„ç¨‹åºåº“åœ¨æ€§èƒ½ä¸Šé‡‡å–ä¸åŒçš„æƒè¡¡æªæ–½ï¼Œæ‰€ä»¥ä¸€æ—¦æ‰¾åˆ°ç¨‹åºçš„ç“¶é¢ˆï¼Œä½ åº”è¯¥çŸ¥é“æ˜¯å¦å¯ä»¥é€šè¿‡æ›¿æ¢ç¨‹åºåº“æ¥æ¶ˆé™¤ç“¶é¢ˆã€‚æ¯”å¦‚å¦‚æœä½ çš„ç¨‹åºçš„æœ‰I/Oç“¶é¢ˆï¼Œä½ è€ƒè™‘ç”¨stdioæ›¿æ¢iostreamï¼Œå¦‚æœç¨‹åºçš„åœ¨åŠ¨æ€åˆ†é…å’Œé‡Šæ”¾ä¸Šå­˜åœ¨ä½¿ç”¨å¤§é‡çš„æ—¶é—´ï¼Œä½ å¯ä»¥æƒ³æƒ³æ˜¯å¦æœ‰å…¶ä»–çš„operator newå’Œoperator deleteçš„å®ç°å¯ç”¨ã€‚å› ä¸ºä¸åŒçš„ç¨‹åºåº“åœ¨æ•ˆç‡ã€å¯æ‰©å±•æ€§ã€ç§»æ¤æ€§ã€ç±»å‹å®‰å…¨å’Œå…¶ä»–ä¸€äº›é‡è¦é¢†åŸŸä¸Šè•´å«ç€ä¸ç”¨çš„è®¾è®¡ç†å¿µï¼Œé€šè¿‡å˜æ›´ä½¿ç”¨ç»™äºˆæ€§èƒ½çš„æ›´å¤šè€ƒè™‘çš„ç¨‹åºåº“ï¼Œä½ æœ‰æ—¶å¯ä»¥å¤§å¹…åº¦æé«˜è½¯ä»¶çš„æ•ˆç‡ã€‚</p><h2 id="æ¡æ¬¾-24ï¼šäº†è§£-virtual-functionsã€multiple-inheritanceã€virtual-base-classesã€runtime-type-identificationçš„æˆæœ¬">æ¡æ¬¾ 24ï¼šäº†è§£ virtual functionsã€multiple inheritanceã€virtual base classesã€runtime type identificationçš„æˆæœ¬</h2><p>è™šå‡½æ•°æœ‰4ä¸ªæˆæœ¬éœ€è¦æ³¨æ„ï¼š</p><ol><li>æ¯ä¸ªæ‹¥æœ‰è™šå‡½æ•°çš„ç±»ï¼Œéœ€è¦ä¸€ä¸ªvtblï¼ˆå…¶å¤§å°ç”±è™šå‡½æ•°ä¸ªæ•°å†³å®š)ï¼Œç”¨äºä¿å­˜å…¶å¯è°ƒç”¨è™šå‡½æ•°çš„æŒ‡é’ˆã€‚</li><li>æ¯ä¸ªæ‹¥æœ‰è™šå‡½æ•°çš„å¯¹è±¡ï¼Œéœ€è¦ä¸€ä¸ªvptrï¼Œç”¨äºæŒ‡å‘vtbl</li><li>è™šå‡½æ•°åº”å½“ä¸å†™inlineå…³é”®å­—ã€‚é¿å…è¿™æ ·å†™ï¼Œæœ‰äº›ç¼–è¯‘å™¨èƒ½å¸®å¿™ä¼˜åŒ–ï¼Œæœ‰äº›ç¼–è¯‘å™¨ä¸ä¼šã€‚<ol><li>vtblæ”¾åœ¨é‚£é‡Œå‘¢ï¼Ÿä¸€èˆ¬è€Œè¨€ï¼š<code>class's vtbl</code>é€šå¸¸æ”¾åœ¨å…¶ç¬¬ä¸€ä¸ª<code>non-inline, non-pure</code>è™šå‡½æ•°å®šä¹‰çš„ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚<code>class C1</code>çš„vtblå¯èƒ½æ”¾åœ¨å®šä¹‰<code>C1::~C1</code>çš„ç›®æ ‡æ–‡ä»¶ä¸­ã€‚æˆ–è€…ç¼–è¯‘å™¨ä¼šè®©ä½ é€‰æ‹©ï¼Œvtblæ”¾åœ¨é‚£é‡Œã€‚ã€åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰æ˜¯ä¸æ‹¥æœ‰è™šå‡½æ•°çš„ç±»æ”¾åœ¨ä¸€èµ·çš„ï¼Œä½†å¹¶ä¸æ€»æ˜¯è¿™æ ·ã€‚å…·ä½“å–å†³äºç¼–è¯‘å™¨å’Œå¹³å°çš„å®ç°ã€‚ï¼ˆgptçš„ç­”æ¡ˆï¼‰ã€‘</li><li>å› ä¸ºè™šå‡½æ•°å¦‚æœå¯ä»¥inlineï¼ˆç›¸å½“äºdefineåœ¨headerä¸­ï¼‰ï¼Œä¼šå¯¼è‡´<code>vtbl</code>éœ€è¦æ‹·è´åˆ°æ¯ä¸€ä¸ªä½¿ç”¨äº†æ­¤<code>class's vtbl</code>çš„ç›®æ ‡æ–‡ä»¶ä¸­ã€‚<ol><li><strong>å¦‚æœä½ åœ¨ç±»çš„å£°æ˜ä¸­å°†è™šå‡½æ•°å®šä¹‰ä¸ºå†…è”å‡½æ•°ï¼ˆinlineï¼‰ï¼Œç¼–è¯‘å™¨ä¼šå°è¯•åœ¨æ¯ä¸ªä½¿ç”¨äº†è¿™äº›è™šå‡½æ•°çš„åœ°æ–¹ç›´æ¥æ’å…¥å‡½æ•°çš„ä»£ç </strong>ï¼Œè€Œä¸æ˜¯é€šè¿‡è°ƒç”¨è™šå‡½æ•°è¡¨æ¥è°ƒç”¨å‡½æ•°ã€‚è¿™æ ·åšä¼šå¯¼è‡´è™šå‡½æ•°è¡¨çš„å†…å®¹è¢«å¤åˆ¶åˆ°æ¯ä¸ªä½¿ç”¨äº†è¿™äº›è™šå‡½æ•°çš„ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯é›†ä¸­æ”¾åœ¨ä¸€ä¸ªåœ°æ–¹ã€‚</li><li>å¦‚æœ<strong>å°†è™šå‡½æ•°å®šä¹‰ä¸ºå†…è”å‡½æ•°</strong>ï¼Œå¹¶ä¸”è™šå‡½æ•°è¡¨çš„å†…å®¹è¢«å¤åˆ¶åˆ°æ¯ä¸ªä½¿ç”¨äº†è¿™äº›è™šå‡½æ•°çš„ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆåœ¨<strong>è°ƒç”¨è¿™äº›è™šå‡½æ•°æ—¶å°±ä¸ä¼šå‘ç”Ÿå¤šæ€</strong>ã€‚</li></ol></li></ol></li><li>æ¯ä¸ªclasså¯¹åº”çš„vtblï¼Œéœ€è¦æŒ‡å‘ä¸€ä¸ªtype_infoå¯¹è±¡ï¼Œtype_infoå¯¹è±¡ç”¨äºä¿å­˜å…¶ç±»å‹ä¿¡æ¯ã€‚.</li></ol><p>æ³¨æ„ï¼š</p><ul><li><p>classçš„vtbleå¸¸è§çš„ä½ç½®ï¼Œæ˜¯åœ¨ç¬¬ä¸€ä¸ªã€éinlineï¼Œéçº¯è™šå‡½æ•°ã€‘(non-inline, non-pure) çš„å®šä¹‰æ–‡ä»¶ä¸­ã€‚</p></li><li><p>å¤šé‡ç»§æ‰¿å¯¼è‡´éœ€è¦è™šåŸºç±»ï¼Œè€Œè™šåŸºç±»ä¼šè®©éšè—æŒ‡é’ˆvptrå˜å¤šï¼Œå ç”¨ç©ºé—´ã€‚</p><ul><li><p>Aæ˜¯BCçš„è™šåŸºç±»ï¼ŒDç»§æ‰¿BCï¼Œæ‰€ä»¥å¯¹Dæ¥è¯´ï¼Œå®ƒçš„å†…å­˜ç»“æœå¦‚ä¸‹å³å›¾ã€‚BCè¦æŒ‡å‘å…±åŒçš„Açš„pointer to virtual baseéƒ¨åˆ†ï¼ŒBCADéƒ½æœ‰è‡ªå·±çš„vptr</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/3.png" alt=""></p></li></ul></li></ul><h1>Techniques æŠ€æœ¯</h1><h2 id="æ¡æ¬¾-25ï¼šå°†æ„é€ å‡½æ•°å’Œéæˆå‘˜å‡½æ•°è™šåŒ–">æ¡æ¬¾ 25ï¼šå°†æ„é€ å‡½æ•°å’Œéæˆå‘˜å‡½æ•°è™šåŒ–</h2><ol><li>æ‰€è°“ virtual constructor æ˜¯æŸç§å‡½æ•°ï¼Œè§†å…¶è·å¾—çš„è¾“å…¥ï¼Œå¯äº§ç”Ÿä¸åŒç±»å‹çš„å¯¹è±¡ã€‚</li><li>å¦‚æœå‡½æ•°çš„è¿”å›ç±»å‹æ˜¯ä¸ªæŒ‡é’ˆï¼ˆæˆ–referenceï¼‰ï¼ŒæŒ‡å‘ä¸€ä¸ªbase classï¼Œé‚£ä¹ˆ derived class çš„å‡½æ•°å¯ä»¥è¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼ˆæˆ–referenceï¼‰ï¼ŒæŒ‡å‘è¯¥ base class çš„ä¸€ä¸ª derived classã€‚</li><li>å†™ä¸€ä¸ªè™šå‡½æ•°åšå®é™…å·¥ä½œï¼Œå†å†™ä¸€ä¸ªä»€ä¹ˆéƒ½ä¸åšçš„éè™šå‡½æ•°ï¼Œåªè´Ÿè´£è°ƒç”¨è™šå‡½æ•°ã€‚</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Expr_node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">friend</span> std::ostream &amp;</span><br><span class="line">    <span class="keyword">operator</span>&lt;&lt;(std::ostream &amp;, <span class="type">const</span> Expr &amp;);</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">print</span><span class="params">(std::ostream &amp;)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Int_node</span> : <span class="keyword">public</span> Expr_node</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(std::ostream &amp;o)</span> <span class="type">const</span> </span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Unary_node</span> : <span class="keyword">public</span> Expr_node</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Expr</span>;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(std::ostream &amp;o)</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::ostream &amp;</span><br><span class="line">    <span class="keyword">operator</span>&lt;&lt;(std::ostream &amp;, <span class="type">const</span> Expr_node &amp;)</span><br><span class="line">&#123;</span><br><span class="line">    t.<span class="built_in">print</span>(o);</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¡æ¬¾-26ï¼šé™åˆ¶æŸä¸ª-class-æ‰€èƒ½äº§ç”Ÿçš„å¯¹è±¡æ•°é‡">æ¡æ¬¾ 26ï¼šé™åˆ¶æŸä¸ª <code>class</code> æ‰€èƒ½äº§ç”Ÿçš„å¯¹è±¡æ•°é‡</h2><h3 id="é—®é¢˜1ï¼šå¦‚ä½•å…è®¸å»ºç«‹é›¶ä¸ªå¯¹è±¡"><strong>é—®é¢˜1ï¼šå¦‚ä½•å…è®¸å»ºç«‹é›¶ä¸ªå¯¹è±¡?</strong></h3><p>æœ€å®¹æ˜“çš„æ–¹æ³•å°±æ˜¯<strong>æŠŠè¯¥ç±»çš„æ„é€ å‡½æ•°å£°æ˜åœ¨ç±»çš„privateåŸŸ</strong>ã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CantBeInstantiated</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">CantBeInstantiated</span>();</span><br><span class="line">    <span class="built_in">CantBeInstantiated</span>(<span class="type">const</span> CantBeInstantiated&amp;);</span><br><span class="line">    ....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜2ï¼šå¦‚ä½•å…è®¸å»ºç«‹ä¸€ä¸ªå¯¹è±¡ï¼Ÿ"><strong>é—®é¢˜2ï¼šå¦‚ä½•å…è®¸å»ºç«‹ä¸€ä¸ªå¯¹è±¡ï¼Ÿ</strong></h3><p>å°†ç±»çš„æ„é€ å‡½æ•°å£°æ˜ä¸ºprivateåï¼Œæ¯ä¸ªç”¨æˆ·éƒ½æ²¡æœ‰æƒåŠ›å»ºç«‹å¯¹è±¡ï¼Œä½†å®é™…åº”ç”¨çš„éœ€æ±‚æ˜¯æˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€‰æ‹©æ€§åœ°æ”¾æ¾è¿™ä¸ªé™åˆ¶ã€‚</p><p>å¯¹äºå£°æ˜ä¸ºprivateçš„æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬<strong>å¯ä»¥å¼•å…¥å‹å…ƒå‡½æ•°æˆ–æˆå‘˜å‡½æ•°æ¥è¿›è¡Œè®¿é—®ï¼Œå¹¶åˆ©ç”¨é™æ€æˆå‘˜å˜é‡æ¥ä¿è¯å¯¹è±¡çš„å”¯ä¸€</strong>ï¼Œå…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨å‹å…ƒå‡½æ•°æ¥è®¿é—®ç§æœ‰æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="keyword">namespace</span> PrintingStuff</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">PrintJob</span>;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Printer</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">submitJob</span><span class="params">(<span class="type">const</span> PrintJob&amp; job)</span></span>;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">rest</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">performSelfTest</span><span class="params">()</span></span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="function"><span class="keyword">friend</span> Printer&amp; <span class="title">thePrinter</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="built_in">Printer</span>();</span><br><span class="line">        <span class="built_in">Printer</span>(<span class="type">const</span> Printer&amp; rhs);</span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="function">Printer&amp; <span class="title">thePrinter</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">static</span> Printer p;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> PrintingStuff::thePrinter;</span><br><span class="line"><span class="built_in">thePrinter</span>().<span class="built_in">reset</span>();</span><br><span class="line"><span class="built_in">thePrinter</span>().<span class="built_in">submitJob</span>(buffer);</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨é™æ€æˆå‘˜å‡½æ•°æ¥è®¿é—®ç§æœ‰æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Printer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Printer&amp; <span class="title">thePrinter</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Printer</span>();</span><br><span class="line">    <span class="built_in">Printer</span>(<span class="type">const</span> Printer&amp; rhs);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">Printer&amp; <span class="title">Printer::thePrinter</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> Printer p;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Printer::<span class="built_in">thePrinter</span>().<span class="built_in">reset</span>();</span><br><span class="line">Printer::<span class="built_in">thePrinter</span>().<span class="built_in">submitJob</span>(buffer);</span><br></pre></td></tr></table></figure><p>**1)å”¯ä¸€çš„Printerå¯¹è±¡æ˜¯ä½äºå‡½æ•°é‡Œçš„é™æ€æˆå‘˜è€Œä¸æ˜¯åœ¨ç±»ä¸­çš„é™æ€æˆå‘˜ã€‚**åœ¨ç±»ä¸­çš„é™æ€å¯¹è±¡æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼Œä¸€ä¸ªæ€»æ˜¯è¢«æ„é€ ï¼ˆå’Œé‡Šæ”¾ï¼‰ï¼Œå³ä½¿ä¸ä½¿ç”¨è¯¥å¯¹è±¡ï¼›å¦ä¸€ä¸ªç¼ºç‚¹æ˜¯å®ƒçš„åˆå§‹åŒ–æ—¶é—´ä¸ç¡®å®šã€‚</p><p><strong>2)thePrinter()å‡½æ•°æ²¡æœ‰å£°æ˜ä¸ºå†…è”å‡½æ•°</strong>ï¼Œå› ä¸ºå†…è”æ„å‘³ç¼–è¯‘å™¨ç”¨å‡½æ•°ä½“ä»£æ›¿å¯¹å‡½æ•°çš„æ¯ä¸€ä¸ªè°ƒç”¨ï¼Œè¿™æ ·ä¼šå¯¼è‡´å‡½æ•°å†…çš„é™æ€å¯¹è±¡åœ¨ç¨‹åºå†…è¢«å¤åˆ¶ï¼Œå¯èƒ½ä¼šä½¿ç¨‹åºçš„é™æ€å¯¹è±¡çš„æ‹·è´è¶…è¿‡ä¸€ä¸ªã€‚</p><h3 id="é—®é¢˜3ï¼šå¦‚ä½•é™åˆ¶å…è®¸å»ºç«‹å¤šä¸ªå¯¹è±¡ï¼Ÿ"><strong>é—®é¢˜3ï¼šå¦‚ä½•é™åˆ¶å…è®¸å»ºç«‹å¤šä¸ªå¯¹è±¡ï¼Ÿ</strong></h3><p>æˆ‘ä»¬å¯ä»¥æ¢ä¸€ç§æ€è·¯ï¼Œä¸åˆ©ç”¨å‹å…ƒå‡½æ•°æˆ–æˆå‘˜å‡½æ•°æ¥ä½œä¸ºå»ºç«‹å¯¹è±¡çš„ä¸­ä»‹ï¼Œè€Œ<strong>å¼•å…¥è®¡æ•°å™¨ç®€å•åœ°è®¡ç®—å¯¹è±¡çš„æ•°ç›®ï¼Œä¸€æ—¦éœ€è¦å¤ªå¤šçš„å¯¹è±¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸</strong>ã€‚å…·ä½“ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Printer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TooManyObjects</span>&#123;&#125;;        <span class="comment">//å½“éœ€è¦çš„å¯¹è±¡è¿‡å¤šæ—¶ï¼ŒæŠ›å‡ºçš„å¼‚å¸¸ç±»</span></span><br><span class="line">    <span class="built_in">Printer</span>();</span><br><span class="line">    ~<span class="built_in">Printer</span>();</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">size_t</span> numObjects;</span><br><span class="line">    <span class="type">static</span> <span class="type">size_t</span> maxObjects;</span><br><span class="line">    <span class="built_in">Printer</span>(<span class="type">const</span> Printer&amp; rhs);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> Printer::numObjects = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> Printer::maxObjects = <span class="number">10</span>;</span><br><span class="line">Printer::<span class="built_in">Printer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(numObjects &gt;= maxObjects)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">TooManyObjects</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    ++numObjects;</span><br><span class="line">&#125;</span><br><span class="line">Printer::~<span class="built_in">Printer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    --numObjects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ³•çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ä½¿ç”¨numObjectsè·Ÿè¸ªPrinterå¯¹è±¡å­˜åœ¨çš„æ•°é‡ã€‚å½“æ„é€ å¯¹è±¡æ—¶ï¼Œå®ƒçš„å€¼å°±å¢åŠ ï¼Œé‡Šæ”¾å¯¹è±¡æ—¶ï¼Œå®ƒçš„å€¼å°±å‡å°‘ã€‚å¦‚æœè¯•å›¾æ„é€ è¿‡å¤šçš„å¯¹è±¡ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ªTooManyObjectsç±»å‹çš„å¼‚å¸¸ã€‚é€šè¿‡maxObjectsè®¾ç½®å¯å…è®¸å»ºç«‹å¯¹è±¡çš„æœ€å¤§æ•°ç›®ã€‚</p><p>ä»¥ä¸Šä¸¤ç§æ–¹æ³•åŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³ï¼Œé™åˆ¶å¯¹è±¡æ•°ç›®çš„è¦æ±‚ã€‚ä½†æ˜¯å…·ä½“åº”ç”¨ä¸­ï¼Œä»ä¼šå‡ºç°é—®é¢˜ï¼Œä¸Šè¿°ä¸¤ç§æ–¹æ³•æ— æ³•è§£å†³ã€‚å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼š</p><p>è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ColorPrinter</span>:<span class="keyword">public</span> Printer&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line">Printer p;</span><br><span class="line">ColorPrinter cp;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CPFMachine</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Printer p;</span><br><span class="line">    FaxMachine f;</span><br><span class="line">    CopyMachine c;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line">CPFMachine m1;</span><br><span class="line">CPFMachine m2;</span><br></pre></td></tr></table></figure><p>â€‹       åˆ©ç”¨è®¡æ•°å™¨çš„æ–¹æ³•ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œéƒ½å°†ä¼šäº§ç”Ÿå¤šä¸ªPrinterå¯¹è±¡ï¼Œç”±Printerè¢«ä½œä¸ºåŸºç±»æˆ–è€…è¢«åŒ…å«äºå…¶ä»–ç±»ä¸­ï¼Œå¯¼è‡´å…¶ä»–å¯¹è±¡çš„æ„é€ æ—¶ï¼Œéšè—æ„é€ Printerå¯¹è±¡ã€‚è¿™ä¸»è¦æ˜¯è®¡æ•°å™¨æ–¹æ³•æ— æ³•åŒºåˆ†å¯¹è±¡å­˜åœ¨çš„ä¸‰ç§ä¸åŒç¯å¢ƒï¼š<strong>åªæœ‰å®ƒä»¬æœ¬èº«ï¼›ä½œä¸ºå…¶ä»–æ´¾ç”Ÿç±»çš„åŸºç±»ï¼›è¢«åµŒå…¥åœ¨æ›´å¤§çš„å¯¹è±¡ä¸­</strong>ã€‚</p><p>åˆ©ç”¨thePrinter()å‡½æ•°çš„æ–¹æ³•ï¼ŒæŠŠPrinterå¯¹è±¡çš„æ•°é‡é™åˆ¶ä¸ºä¸€ä¸ªï¼Œè¿™æ ·åšçš„åŒæ—¶ä¹Ÿä¼šè®©æˆ‘ä»¬æ¯ä¸€æ¬¡è¿è¡Œç¨‹åºæ—¶åªèƒ½ä½¿ç”¨ä¸€ä¸ªPrinterå¯¹è±¡ã€‚<strong>å¯¼è‡´æˆ‘ä»¬ä¸èƒ½åœ¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ä½¿ç”¨ä¸åŒçš„Printerå¯¹è±¡</strong>ã€‚å¦‚ä¸‹é¢ä¼ªä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å»ºç«‹Printerå¯¹è±¡p1;</span><br><span class="line">ä½¿ç”¨p1;</span><br><span class="line">é‡Šæ”¾p1;</span><br><span class="line">å»ºç«‹Printerå¯¹è±¡p2;</span><br><span class="line">ä½¿ç”¨p2;</span><br><span class="line">é‡Šæ”¾p2;</span><br><span class="line">....</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜4ï¼šè§£å†³é—®é¢˜3çš„é—®é¢˜">é—®é¢˜4ï¼šè§£å†³é—®é¢˜3çš„é—®é¢˜</h3><p>**æ€è·¯ï¼šå°†ä¸¤ç§æ–¹æ³•ç»“åˆï¼Œå°†æ„é€ å‡½æ•°å£°æ˜ä¸ºprivateï¼Œé™åˆ¶å…¶è¢«ç»§æ‰¿å’Œè¢«åŒ…å«äºå…¶ä»–çš„ç±»ï¼Œè§£å†³è®¡æ•°å™¨çš„é—®é¢˜ï¼Œå¹¶æä¾›ä¼ªæ„é€ å‡½æ•°ä½œä¸ºè®¿é—®å¯¹è±¡çš„æ¥å£ï¼Œå¹¶ç»Ÿè®¡å¯¹è±¡çš„ä¸ªæ•°ï¼Œæ¥è§£å†³é™åˆ¶æ„é€ å¤šä¸ªå¯¹è±¡å’Œç¨‹åºä¸åŒéƒ¨åˆ†ä½¿ç”¨ä¸åŒå¯¹è±¡çš„é—®é¢˜ã€‚**å…·ä½“ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Printer</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TooManyObjects</span>&#123;&#125;;</span><br><span class="line">    <span class="comment">//ä¼ªæ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="type">static</span> Printer* <span class="title">makePrinter</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> Printer* <span class="title">makePrinter</span><span class="params">(<span class="type">const</span> Printer&amp; rhs)</span></span>;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">size_t</span> numObjects;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">size_t</span> maxObjects;</span><br><span class="line">    <span class="built_in">Printer</span>();</span><br><span class="line">    <span class="built_in">Printer</span>(<span class="type">const</span> Printer&amp; rhs);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> Printer::numObjects = <span class="number">0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> Printer::maxObjects = <span class="number">10</span>;</span><br><span class="line">Printer::<span class="built_in">Printer</span>()&#123;</span><br><span class="line">    <span class="keyword">if</span>(numObjects &gt;= maxObjects)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">TooManyObjects</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">Printer::<span class="built_in">Printer</span>(<span class="type">const</span> Printer&amp; rhs)&#123;</span><br><span class="line">    <span class="keyword">if</span>(numObjects &gt;= maxObjects)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">TooManyObjects</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">Printer* Printer:<span class="built_in">makePrinter</span>()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Printer;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Printer* <span class="title">Printer::makePrinter</span><span class="params">(<span class="type">const</span> Printer&amp; rhs)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Printer</span>(rhs);</span><br><span class="line">&#125;</span><br><span class="line">Printer *p1 = Printer::<span class="built_in">makePrinter</span>();</span><br></pre></td></tr></table></figure><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå¯¹äºé™åˆ¶å¯¹è±¡æ•°ç›®çš„é—®é¢˜ï¼Œåº”è¯¥æ˜¯å¤§åŠŸå‘Šæˆã€‚ä½†æ˜¯ä»ä¸èƒ½æ»¡è¶³å·¥ç¨‹æ€§ä¸Šçš„åº”ç”¨ï¼Œä¾‹å¦‚æˆ‘ä»¬æœ‰å¤§é‡åƒPrinteréœ€è¦é™åˆ¶å®ä¾‹æ•°é‡çš„ç±»ï¼Œå°±å¿…é¡»ä¸€éåˆä¸€éåœ°ç¼–å†™ä¸€æ ·çš„ä»£ç ï¼Œæ¯ä¸ªç±»ç¼–å†™ä¸€æ¬¡ã€‚ä½œä¸ºç¨‹åºå‘˜ï¼Œåº”è¯¥é¿å…è¿™ç§é‡å¤æ€§çš„å·¥ä½œã€‚</p><h3 id="ä¸€ä¸ªå…·æœ‰å¯¹è±¡è®¡æ•°åŠŸèƒ½çš„åŸºç±»"><strong>ä¸€ä¸ªå…·æœ‰å¯¹è±¡è®¡æ•°åŠŸèƒ½çš„åŸºç±»</strong></h3><p>**é’ˆå¯¹é‡å¤æ€§å·¥ä½œçš„é—®é¢˜ï¼Œè§£å†³æ€è·¯æ˜¯ï¼šæ„é€ ä¸€ä¸ªå…·æœ‰å®ä¾‹è®¡æ•°åŠŸèƒ½çš„åŸºç±»ï¼Œè®©åƒPrinterè¿™æ ·çš„ç±»ä»è¯¥åŸºç±»ç»§æ‰¿ï¼Œåˆ©ç”¨æ´¾ç”Ÿç±»å¯¹è±¡çš„æ„é€ ï¼Œéœ€è¦å…ˆæ„é€ åŸºç±»å¯¹è±¡çš„ç‰¹ç‚¹ï¼Œé€šè¿‡éšè—çš„åŸºç±»å®ç°è®¡æ•°åŠŸèƒ½ã€‚**å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">BeingCounted</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Counted</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TooManyObjects</span>&#123;&#125;;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">objectCount</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> numObjects;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">Counted</span>();</span><br><span class="line">    <span class="built_in">Counted</span>(<span class="type">const</span> Counted&amp; rhs);</span><br><span class="line">    ~<span class="built_in">Counted</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        --numObjects;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> numObjects;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">size_t</span> maxObjects;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">BeingCounted</span>&gt;</span><br><span class="line">Counted&lt;BeingCounted&gt;::<span class="built_in">Counted</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">init</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;BeingCounted&gt;</span><br><span class="line">Counted&lt;BeingCounted&gt;::<span class="built_in">Counted</span>(<span class="type">const</span> Counted&lt;BeingCounted&gt;&amp;)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">init</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">BeingCounted</span>&gt;</span><br><span class="line"><span class="type">void</span> Counted&lt;BeingCounted&gt;::<span class="built_in">init</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(numObjects &gt;= maxObjects)</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">TooManyObjects</span>();</span><br><span class="line">    ++numObjects;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Printer</span>::<span class="keyword">private</span> Counted&lt;Printer&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Printer* <span class="title">makePrinter</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> Printer* <span class="title">makePrinter</span><span class="params">(<span class="type">const</span> Printer&amp; rhs)</span></span>;</span><br><span class="line">    ~<span class="built_in">Printer</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">submitJob</span><span class="params">(<span class="type">const</span> PrintJob&amp; job)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">performSelfTest</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">using</span> Counted&lt;Printer&gt;::objectCount;</span><br><span class="line">    <span class="keyword">using</span> Counted&lt;Printer&gt;::TooManyObjects;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Printer</span>();</span><br><span class="line">    <span class="built_in">Printer</span>(<span class="type">const</span> Printer&amp; rhs);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="æ¡æ¬¾-27ï¼šè¦æ±‚ï¼ˆæˆ–ç¦æ­¢ï¼‰å¯¹è±¡äº§ç”Ÿäº-heap-ä¹‹ä¸­">æ¡æ¬¾ 27ï¼šè¦æ±‚ï¼ˆæˆ–ç¦æ­¢ï¼‰å¯¹è±¡äº§ç”Ÿäº  heap ä¹‹ä¸­</h2><p>è¦æ±‚å¯¹è±¡äº§ç”Ÿäºheapä¸­ï¼Œæ„æ€æ˜¯éœ€è¦é˜»æ­¢clientsä¸å¾—ä½¿ç”¨newä»¥å¤–çš„æ–¹æ³•äº§ç”Ÿå¯¹è±¡ã€‚æ¯”è¾ƒå¥½çš„æ–¹æ³•å°±æ˜¯å°†destructorå®šä¹‰ä¸ºprivateï¼Œå› ä¸ºconstructorçš„ç±»å‹å¤ªå¤šï¼Œæ‰€ä»¥ä»ç„¶å°†constructorå®šä¹‰ä¸ºpublicã€‚ç„¶åå®šä¹‰ä¸€ä¸ªpseudo destructoræ¥è°ƒç”¨çœŸæ­£çš„destructorã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HeapBasedObject</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">HeapBasedObject</span>() &#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">delete</span> <span class="keyword">this</span>; &#125; <span class="comment">// pseudo destructor</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  ~<span class="built_in">HeapBasedObject</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//HeapBasedObject h;</span></span><br><span class="line">  HeapBasedObject *ph = <span class="keyword">new</span> HeapBasedObject;</span><br><span class="line">  <span class="comment">//delete ph;</span></span><br><span class="line">  ph-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¦æ­¢å¯¹è±¡äº§ç”Ÿäºheapä¸­ï¼Œåˆ™æ˜¯è¦è®©clientsä¸èƒ½ä½¿ç”¨newæ–¹æ³•æ¥äº§ç”Ÿå¯¹è±¡ã€‚æ–¹æ³•å°±æ˜¯å°†operator newå’Œoperator deleteå®šä¹‰ä¸ºprivateã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NoHeapBasedObject</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">NoHeapBasedObject</span>() &#123;&#125;</span><br><span class="line">  ~<span class="built_in">NoHeapBasedObject</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span> *ptr)</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NoHeapBasedObject nh;</span><br><span class="line">  <span class="type">static</span> NoHeapBasedObject snh;</span><br><span class="line">  <span class="comment">//NoHeapBasedObject *pnh = new NoHeapBasedObject;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹ä¾‹æ˜¯å®ç°çš„ä¸€ä¸ªåˆ¤æ–­æŸä¸ªå¯¹è±¡æ˜¯å¦ä½äºheapå†…çš„åŸºç±»HeapTrackedã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HeapTracked</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">MissingAddress</span>&#123;&#125;; <span class="comment">//åœ°å€å¼‚å¸¸</span></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">HeapTracked</span>() = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span> *ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">isOnHeap</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">typedef</span> <span class="type">const</span> <span class="type">void</span>* RawAddress;</span><br><span class="line">  <span class="type">static</span> std::list&lt;RawAddress&gt; addresses;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::list&lt;HeapTracked::RawAddress&gt; HeapTracked::addresses;</span><br><span class="line"></span><br><span class="line">HeapTracked::~<span class="built_in">HeapTracked</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* HeapTracked::<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="type">void</span>* memPtr = ::<span class="keyword">operator</span> <span class="built_in">new</span>(size); <span class="comment">// å–å¾—å†…å­˜ã€‚</span></span><br><span class="line">  addresses.<span class="built_in">push_front</span>(memPtr); <span class="comment">// å°†å…¶åœ°å€ç½®äºlistå¤´éƒ¨ã€‚</span></span><br><span class="line">  <span class="keyword">return</span> memPtr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> HeapTracked::<span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span> *ptr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> it = std::<span class="built_in">find</span>(addresses.<span class="built_in">begin</span>(), addresses.<span class="built_in">end</span>(), ptr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (it != addresses.<span class="built_in">end</span>()) &#123;</span><br><span class="line">      addresses.<span class="built_in">erase</span>(it);</span><br><span class="line">      ::<span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(ptr)</span></span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="built_in">MissingAddress</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">HeapTracked::isOnHeap</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> rawAddress = <span class="built_in">dynamic_cast</span>&lt;<span class="type">const</span> <span class="type">void</span>*&gt;(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> it = std::<span class="built_in">find</span>(addresses.<span class="built_in">begin</span>(), addresses.<span class="built_in">end</span>(), rawAddress);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> it != addresses.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Object</span>: <span class="keyword">public</span> HeapTracked &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Object</span>() &#123;&#125;</span><br><span class="line">  ~<span class="built_in">Object</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Object o1;</span><br><span class="line">  Object* o2 = <span class="keyword">new</span> Object;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;o1 isOnHeap = &quot;</span> &lt;&lt; o1.<span class="built_in">isOnHeap</span>() &lt;&lt; std::endl;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;o2 isOnHeap = &quot;</span> &lt;&lt; o2-&gt;<span class="built_in">isOnHeap</span>() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¡æ¬¾-28ï¼šSmart-Pointersï¼ˆæ™ºèƒ½æŒ‡é’ˆï¼‰">æ¡æ¬¾ 28ï¼šSmart Pointersï¼ˆæ™ºèƒ½æŒ‡é’ˆï¼‰</h2><p>æ‰€è°“ smart pointers æ˜¯é‚£äº›çœ‹èµ·æ¥ã€ç”¨èµ·æ¥ã€æ„Ÿè§‰èµ·æ¥éƒ½åƒå†…å»ºæŒ‡é’ˆï¼Œä½†æä¾›æ›´å¤šæœºèƒ½çš„ä¸€ç§å¯¹è±¡ã€‚smart pointers ç”± templates äº§ç”Ÿå‡ºæ¥ï¼Œå¯ä»¥åˆ©ç”¨ templates å‚æ•°è¡¨æ˜å…¶æ‰€æŒ‡å¯¹è±¡çš„ç±»å‹ã€‚</p><p><strong>Smart Pointers çš„æ„é€ ã€èµ‹å€¼ã€ææ„</strong></p><p>Smart pointer çš„æ„é€ é€šå¸¸éå¸¸ç®€å•ï¼šç¡®å®šä¸€ä¸ªç›®æ ‡ç‰©ï¼ˆé€šå¸¸æ˜¯åˆ©ç”¨ smart pointer çš„ constructor è‡ªå˜é‡ï¼‰ï¼Œç„¶åè®© smart pointer å†…éƒ¨çš„ dumb pointer æŒ‡å‘å®ƒã€‚å¦‚æœå°šæœªå†³å®šç›®æ ‡ç‰©ï¼Œå°±å°†å†…éƒ¨æŒ‡é’ˆè®¾ä¸º 0ï¼Œæˆ–æ˜¯å‘å‡ºä¸€ä¸ªé”™è¯¯ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œå¦‚æœä¸€ä¸ª smart pointer æ‹¥æœ‰å®ƒæ‰€æŒ‡çš„å¯¹è±¡ï¼Œå®ƒå°±æœ‰è´£ä»»åœ¨æœ¬èº«å³å°†è¢«é”€æ¯æ—¶åˆ é™¤è¯¥å¯¹è±¡ï¼Œå‰ææ˜¯è¿™ä¸ª smart pointer æ‰€æŒ‡å¯¹è±¡ç³»åŠ¨æ€åˆ†é…è€Œå¾—ã€‚</p><p>ä»¥ by value æ–¹å¼ä¼ é€’ auto_ptrs å¾€å¾€æ˜¯ä¸ªéå¸¸ç³Ÿçš„åšæ³•ï¼Œåªæœ‰å½“ä½ ç¡®å®šè¦è®²å¯¹è±¡æ‹¥æœ‰æƒç§»è½¬ç»™å‡½æ•°çš„æŸä¸ªå‚æ•°æ—¶ï¼Œæ‰åº”è¯¥ä»¥ by value æ–¹å¼ä¼ é€’ auto_ptrs.è‹¥ä¸€å®šè¦ä»¥ auto_ptrs ä½œä¸ºå‚æ•°ï¼Œåº”é‡‡ç”¨ pass-by-reference-to-const æ–¹å¼ã€‚å½“ smart pointer è¢«å¤åˆ¶ï¼Œæˆ–æ˜¯èº«ä¸ºèµ‹å€¼åŠ¨ä½œçš„æ¥æºç«¯æ—¶ï¼Œå®ƒä¼šè¢«æ”¹å˜ã€‚</p><p>smart pointer çš„ destructor é€šå¸¸çœ‹èµ·æ¥å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">SmartPtr&lt;T&gt;::~<span class="built_in">SmartPtr</span>()&#123;</span><br><span class="line">    <span class="keyword">if</span>(*<span class="keyword">this</span> owns *pointee) &#123;</span><br><span class="line">        <span class="keyword">delete</span> pointee;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ç°è§£ææ“ä½œç¬¦</strong></p><p>operator* è¿”å›æ‰€æŒ‡å¯¹è±¡ï¼Œreference;operator-&gt; è¿”å› dumb pointerï¼ˆæŒ‡å‘æŸå¯¹è±¡ï¼‰ï¼Œæˆ–è€…ä¸€ä¸ª smart pointerã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">T&amp; SmartPtr&lt;T&gt;::<span class="keyword">operator</span>*() <span class="type">const</span>&#123;</span><br><span class="line">    perform <span class="string">&quot;smart pointer&quot;</span> processing;</span><br><span class="line">    <span class="keyword">return</span> *pointee;</span><br><span class="line">&#125;</span><br><span class="line">T* SmartPtr&lt;T&gt;::<span class="keyword">operator</span>-&gt;() <span class="type">const</span>&#123;</span><br><span class="line">    perform <span class="string">&quot;smart pointer&quot;</span> processing;</span><br><span class="line">    <span class="keyword">return</span> pointee;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯• Smart Pointers æ˜¯å¦ä¸º Null</strong></p><p>smart pointer ä¸èƒ½ç›´æ¥è¿›è¡Œæµ‹è¯•æ˜¯å¦ä¸º Nullï¼Œéœ€è¦æä¾›ä¸€ä¸ªéšå¼ç±»å‹è½¬æ¢ç¬¦ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SmartPtr&lt;TreeNode&gt; ptn;</span><br><span class="line"><span class="keyword">if</span>(ptn == <span class="number">0</span>)... <span class="comment">//error</span></span><br><span class="line"><span class="keyword">if</span>(ptn)... <span class="comment">//error</span></span><br><span class="line"><span class="keyword">if</span>(!ptn)... <span class="comment">//error</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/////////////////////////////ä¿®æ”¹/////////////////////////////////////    </span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SmartPtr</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">operator</span> <span class="type">void</span>*();</span><br><span class="line">&#125;;</span><br><span class="line">SmartPtr&lt;TreeNode&gt; ptn;</span><br><span class="line"><span class="keyword">if</span>(ptn == <span class="number">0</span>) <span class="comment">//ç°åœ¨æ­£ç¡®</span></span><br><span class="line"><span class="keyword">if</span>(ptn) <span class="comment">//ç°åœ¨æ­£ç¡®</span></span><br><span class="line"><span class="keyword">if</span>(!ptn) <span class="comment">//ç°åœ¨æ­£ç¡®</span></span><br></pre></td></tr></table></figure><p><strong>Smart Pointers ä¸ç»§æ‰¿æœ‰å…³çš„è½¬æ¢</strong></p><p>ä¹Ÿéœ€è¦æ·»åŠ ä¸€ä¸ªéšå¼ç±»å‹è½¬æ¢ç¬¦ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MusicProduct</span>&#123;....&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cassette</span>:<span class="keyword">public</span> MusicProduct&#123;....&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CD</span>:<span class="keyword">public</span> MusicProduct&#123;....&#125;;</span><br><span class="line"><span class="built_in">displayAndPlay</span>(<span class="type">const</span> SmartPtr&lt;MusicProduct&gt;&amp; pmp, <span class="type">int</span> numTimes);</span><br><span class="line"></span><br><span class="line"><span class="function">SmartPtr&lt;Cassette&gt; <span class="title">funMusic</span><span class="params">(<span class="keyword">new</span> Cassette(<span class="string">&quot;1234&quot;</span>))</span></span>;</span><br><span class="line"><span class="function">SmartPtr&lt;CD&gt; <span class="title">nightmareMusic</span><span class="params">(<span class="keyword">new</span> CD(<span class="string">&quot;143&quot;</span>))</span></span>;</span><br><span class="line"><span class="built_in">displayAndPlay</span>(funMusic, <span class="number">10</span>); <span class="comment">// é”™è¯¯!</span></span><br><span class="line"><span class="built_in">displayAndPlay</span>(nightmareMusic, <span class="number">0</span>); <span class="comment">// é”™è¯¯!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////ä¿®æ”¹/////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SmartPtr</span>&lt;Cassette&gt;&#123;<span class="comment">//æˆ–è€…ç”¨æ¨¡æ¿æ¥ä»£æ›¿</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">operator</span> <span class="built_in">SmartPtr</span>&lt;MusicProduct&gt;()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">SmartPtr</span>&lt;MusicProduct&gt;(pointee);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>Smart Pointer å’Œ const</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SmartPtr&lt;CD&gt; p; <span class="comment">//non-const å¯¹è±¡ non-const æŒ‡é’ˆ</span></span><br><span class="line">SmartPtr&lt;<span class="type">const</span> CD&gt; p; <span class="comment">//const å¯¹è±¡ non-const æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">const</span> SmartPtr&lt;CD&gt; p = &amp;goodCD; <span class="comment">//non-const å¯¹è±¡ const æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">const</span> SmartPtr&lt;<span class="type">const</span> CD&gt; p = &amp;goodCD; <span class="comment">//const å¯¹è±¡ const æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;      <span class="comment">// æŒ‡å‘constå¯¹è±¡çš„</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SmartPtrToConst</span>&#123; <span class="comment">//çµå·§æŒ‡é’ˆ</span></span><br><span class="line">    ...                <span class="comment">// çµå·§æŒ‡é’ˆé€šå¸¸çš„æˆå‘˜å‡½æ•°</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="type">const</span> T* constPointee; <span class="comment">// è®© SmartPtrToConst è®¿é—®</span></span><br><span class="line">        T* pointee; <span class="comment">// è®© SmartPtr è®¿é—®</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="comment">// æŒ‡å‘ non-const å¯¹è±¡çš„çµå·§æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SmartPtr</span>: <span class="keyword">public</span> SmartPtrToConst&lt;T&gt; &#123;</span><br><span class="line">    ... <span class="comment">// æ²¡æœ‰æ•°æ®æˆå‘˜</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="æ¡æ¬¾-29ï¼šReference-countingï¼ˆå¼•ç”¨è®¡æ•°ï¼‰">æ¡æ¬¾ 29ï¼šReference countingï¼ˆå¼•ç”¨è®¡æ•°ï¼‰</h2><p>å¼•ç”¨è®¡æ•°æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š</p><ul><li>ç®€åŒ– heap objects å‘¨è¾¹çš„è®°å½•å·¥ä½œï¼šå½“å¯¹è±¡ä½¿ç”¨äº†å¼•ç”¨è®¡æ•°ï¼Œå®ƒå°±æ‹¥æœ‰äº†è‡ªå·±ï¼Œä¸€æ—¦ä¸å†æœ‰ä»»ä½•äººä½¿ç”¨å®ƒï¼Œä¾¿è‡ªåŠ¨é”€æ¯è‡ªå·±ã€‚</li><li>å…è®¸å¤šä¸ªç­‰å€¼å¯¹è±¡å…±äº«åŒä¸€å®å€¼ï¼Œé¿å…å¤šæ¬¡å­˜å‚¨ã€‚</li><li><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/4.png" alt=""></li></ul><p><strong>å¼•ç”¨è®¡æ•°çš„å®ç°ï¼š</strong></p><p>äº§ç”Ÿä¸€ä¸ª class ä¸ä»…å­˜å‚¨å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿå­˜å‚¨å®ƒä»¬è¿½è¸ªçš„å¯¹è±¡å€¼ã€‚</p><p><strong>æŠ€å·§ï¼š</strong> å°†ä¸€ä¸ª struct åµŒå¥—æ”¾è¿›ä¸€ä¸ª class çš„ private æ®µè½å†…ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°è®©è¯¥ class çš„æ‰€æœ‰ members æœ‰æƒå¤„ç†è¿™ä¸ª structï¼Œè€Œåˆèƒ½ç¦æ­¢ä»»ä½•å…¶ä»–äººè®¿é—®è¿™ä¸ª structã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// åµŒå¥—çš„ç»“æ„ä½“</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">InnerStruct</span> &#123;</span><br><span class="line">        <span class="type">int</span> value;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">MyClass</span>(<span class="type">int</span> val) : <span class="built_in">innerData</span>(&#123;val&#125;) &#123;&#125;</span><br><span class="line">    <span class="comment">// æˆå‘˜å‡½æ•°å¯ä»¥è®¿é—®å†…éƒ¨ç»“æ„ä½“</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setValue</span><span class="params">(<span class="type">int</span> val)</span> </span>&#123;</span><br><span class="line">        innerData.value = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getValue</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> innerData.value;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// å†…éƒ¨æ•°æ®ç»“æ„ä½“</span></span><br><span class="line">    InnerStruct innerData;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">MyClass <span class="title">obj</span><span class="params">(<span class="number">42</span>)</span></span>;</span><br><span class="line">    <span class="comment">// æ— æ³•ç›´æ¥è®¿é—®å†…éƒ¨ç»“æ„ä½“</span></span><br><span class="line">    <span class="comment">// obj.innerData.value = 10; // ç¼–è¯‘é”™è¯¯ï¼š&#x27;MyClass::InnerStruct MyClass::innerData&#x27; is private within this context</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åªèƒ½é€šè¿‡å…¬å…±æ¥å£æ¥è®¿é—®å†…éƒ¨æ•°æ®</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Initial value: &quot;</span> &lt;&lt; obj.<span class="built_in">getValue</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨æˆå‘˜å‡½æ•°æ¥ä¿®æ”¹å†…éƒ¨æ•°æ®</span></span><br><span class="line">    obj.<span class="built_in">setValue</span>(<span class="number">99</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Updated value: &quot;</span> &lt;&lt; obj.<span class="built_in">getValue</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¡æ¬¾-30ï¼šProxy-classesï¼ˆæ›¿èº«ç±»ã€ä»£ç†ç±»ï¼‰">æ¡æ¬¾ 30ï¼šProxy classesï¼ˆæ›¿èº«ç±»ã€ä»£ç†ç±»ï¼‰</h2><h3 id="å¤šç»´æ•°ç»„">å¤šç»´æ•°ç»„</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰ä¸€ä¸ªç±»æ¨¡æ¿å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Array2D</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Array2D</span>(<span class="type">int</span> dim1,<span class="type">int</span> dim2);</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol><li>å°†<code>operator[]</code>é‡è½½ï¼Œä»¤å®ƒè¿”å›ä¸€ä¸ªArray1Då¯¹è±¡ï¼›</li><li>å¯¹Array1Dé‡è½½<code>operator[]</code>ï¼Œä»¤å®ƒè¿”å›åŸæ¥äºŒç»´æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼š</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Array2D</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Array1D</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">T&amp; <span class="keyword">operator</span>[](<span class="type">int</span> index);</span><br><span class="line"><span class="type">const</span> T&amp; <span class="keyword">operator</span>[](<span class="type">int</span> index) <span class="type">const</span>;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Array1D <span class="keyword">operator</span>[](<span class="type">int</span> index);</span><br><span class="line"><span class="type">const</span> Array1D <span class="keyword">operator</span>[](<span class="type">int</span> index) <span class="type">const</span>;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨</span></span><br><span class="line"><span class="function">Array2D&lt;<span class="type">float</span>&gt; <span class="title">data</span><span class="params">(<span class="number">10</span>,<span class="number">20</span>)</span></span>;</span><br><span class="line">...</span><br><span class="line">cout &lt;&lt; data[<span class="number">3</span>][<span class="number">6</span>];<span class="comment">//ok</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>data[3]è·å¾—ä¸€ä¸ªArray1Då¯¹è±¡ï¼Œå¯¹è¯¥å¯¹è±¡å†æ–½è¡Œoperator[]ï¼Œè·å¾—åŸäºŒç»´æ•°ç»„ä¸­(3, 6)ä½ç½®çš„æµ®ç‚¹æ•°ï¼›Array2Dç±»çš„ç”¨æˆ·ä¸éœ€è¦çŸ¥é“Array1Dç±»çš„å­˜åœ¨ã€‚</p><p><strong>å‡¡â€œç”¨æ¥ä»£è¡¨ï¼ˆè±¡å¾ï¼‰å…¶ä»–å¯¹è±¡â€çš„å¯¹è±¡ï¼Œå¸¸è¢«ç§°ä¸ºproxy objectsï¼ˆæ›¿èº«å¯¹è±¡ï¼‰ï¼›</strong><br>ç”¨ä»¥è¡¨ç°proxy objectsè€…ï¼Œæˆ‘ä»¬ç§°ä¸ºproxy classesã€‚</p><h3 id="åŒºåˆ†operator-çš„è¯»å†™åŠ¨ä½œ">åŒºåˆ†<code>operator[]</code> çš„è¯»å†™åŠ¨ä½œ</h3><blockquote><p>å¯¹äºä¸€ä¸ªproxyï¼Œä½ åªæœ‰3ä»¶äº‹æƒ…å¯åšï¼š</p><p>äº§ç”Ÿå®ƒï¼Œæœ¬ä¾‹ä¹Ÿå°±æ˜¯æŒ‡å®šå®ƒä»£è¡¨å“ªä¸€ä¸ªå­—ç¬¦ä¸²ä¸­çš„å“ªä¸€ä¸ªå­—ç¬¦ï¼›<br>ä»¥å®ƒä½œä¸ºèµ‹å€¼åŠ¨ä½œçš„ç›®æ ‡ï¼ˆæ¥å—ç«¯ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹ä½ æ˜¯å¯¹å®ƒæ‰€ä»£è¡¨çš„å­—ç¬¦ä¸²å†…çš„å­—ç¬¦åšèµ‹å€¼åŠ¨ä½œã€‚å¦‚æœè¿™ä¹ˆä½¿ç”¨ï¼Œproxyä»£è¡¨çš„å°†æ˜¯â€œè°ƒç”¨operator[]å‡½æ•°â€çš„é‚£ä¸ªå­—ç¬¦ä¸²çš„å·¦å€¼è¿ç”¨ï¼›<br>ä»¥å…¶ä»–æ–¹å¼ä½¿ç”¨ä¹‹ã€‚å¦‚æœè¿™ä¹ˆä½¿ç”¨ï¼Œproxyè¡¨ç°çš„æ˜¯â€œè°ƒç”¨operatorp[]å‡½æ•°â€çš„é‚£ä¸ªå­—ç¬¦ä¸²çš„å³å€¼è¿ç”¨ã€‚</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸€ä¸ªreference-counted String classï¼Œ</span></span><br><span class="line"><span class="comment">//å…¶ä¸­åˆ©ç”¨proxy classæ¥åŒºåˆ†operator[]çš„å·¦å€¼è¿ç”¨å’Œå³å€¼è¿ç”¨ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">String</span> <span class="comment">//reference-counted stringsè§ä¸Šä¸€ç¯‡ç»†èŠ‚</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CharProxy</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">CharProxy</span>(String&amp; str,<span class="type">int</span> index);<span class="comment">//æ„é€ </span></span><br><span class="line">CharProxy&amp; <span class="keyword">operator</span> = (<span class="type">const</span> CharProxy&amp; rhs);<span class="comment">//å·¦å€¼è¿ç”¨</span></span><br><span class="line">CharProxy&amp; <span class="keyword">operator</span> = (<span class="type">char</span> c);<span class="comment">//å³å€¼è¿ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">operator</span> <span class="title">char</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">String&amp; theString;<span class="comment">//è¿™ä¸ªproxyé™„å±çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="type">int</span> charIndex;<span class="comment">//è¿™ä¸ªproxyæ‰€ä»£è¡¨çš„å­—ç¬¦ä¸²å­—ç¬¦</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> CharProxy <span class="keyword">operator</span>[](<span class="type">int</span> index) <span class="type">const</span>; <span class="comment">//é’ˆå¯¹const strings</span></span><br><span class="line">CharProxy <span class="keyword">operator</span>[](<span class="type">int</span> index); <span class="comment">//é’ˆå¯¹non-const strings</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">CharProxy</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">RCPtr&lt;StringValue&gt; value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨</span></span><br><span class="line">String s1,s2;</span><br><span class="line">...</span><br><span class="line">cout &lt;&lt; s1[<span class="number">5</span>];    <span class="comment">//åˆæ³•ï¼ˆå³å€¼è¿ç”¨ï¼‰</span></span><br><span class="line">s2[<span class="number">5</span>] = <span class="string">&#x27;x&#x27;</span>;  <span class="comment">//åˆæ³•ï¼ˆå·¦å€¼è¿ç”¨ï¼‰</span></span><br><span class="line">s1[<span class="number">3</span>] = s2[<span class="number">8</span>];    <span class="comment">//åˆæ³•ï¼ˆå·¦å€¼ã€å³å€¼ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//String operator[]å®ç°ï¼š</span></span><br><span class="line"><span class="type">const</span> String::CharProxy String::<span class="keyword">operator</span>[](<span class="type">int</span> index) <span class="type">const</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">CharProxy</span>(<span class="built_in">const_cast</span>&lt;String&amp;&gt;(*<span class="keyword">this</span>), index);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">åœ¨C++ä¸­ï¼Œå½“ä½ åœ¨ä¸€ä¸ªæˆå‘˜å‡½æ•°ä¸­ä½¿ç”¨ const ä¿®é¥°ç¬¦æ—¶ï¼Œè¿™æ„å‘³ç€è¯¥æˆå‘˜å‡½æ•°æ‰¿è¯ºä¸ä¼šä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œåœ¨ const æˆå‘˜å‡½æ•°å†…éƒ¨ï¼Œ*this æŒ‡é’ˆçš„ç±»å‹æ˜¯ const ç±»å‹çš„ï¼Œå³æŒ‡å‘ const å¯¹è±¡çš„æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">String::CharProxy String::<span class="keyword">operator</span>[](<span class="type">int</span> index)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CharProxy</span>(*<span class="keyword">this</span>, index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªå‡½æ•°éƒ½åªæ˜¯äº§ç”Ÿå¹¶è¿”å›â€œè¢«è¯·æ±‚ä¹‹å­—ç¬¦â€çš„ä¸€ä¸ªæ›¿ä»£å“ã€‚æ²¡æœ‰ä»»ä½•åŠ¨ä½œæ–½åŠ äºæ­¤å­—ç¬¦èº«ä¸Šï¼šæˆ‘ä»¬å»¶ç¼“æ­¤ç­‰è¡Œä¸ºï¼Œç›´åˆ°çŸ¥é“è¯¥è¡Œä¸ºæ˜¯â€œè¯»å–â€æˆ–è€…â€œå†™â€ã€‚</p><p><code>operator[]</code>è¿”å›çš„æ¯ä¸€ä¸ªproxyéƒ½ä¼šè®°ä½å®ƒæ‰€é™„å±çš„å­—ç¬¦ä¸²ï¼Œä»¥åŠå®ƒæ‰€åœ¨çš„ç´¢å¼•ä½ç½®ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String::CharProxy::<span class="built_in">CharProxy</span>(String&amp; str,<span class="type">int</span> index)</span><br><span class="line">:<span class="built_in">theString</span>(str),<span class="built_in">charIndex</span>(index)&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†proxyè½¬æ¢ä¸ºå³å€¼ï¼šåªéœ€è¦è¿”å›è¯¥proxyæ‰€è¡¨ç°çš„å­—ç¬¦ä¸²å‰¯æœ¬å°±è¡Œï¼š</span></span><br><span class="line"> </span><br><span class="line">String::<span class="function">CharProxy::<span class="keyword">operator</span> <span class="title">char</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> theString.value-&gt;data[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CharProxyçš„èµ‹å€¼æ“ä½œç¬¦ï¼š</span></span><br><span class="line">String::CharProxy&amp;</span><br><span class="line">String::CharProxy::<span class="keyword">operator</span> = (<span class="type">const</span> CharProxy&amp; rhs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//å¦‚æœæœ¬å­—ç¬¦ä¸²ä¸å…¶ä»–Stringå¯¹è±¡å…±äº«ä¸€ä¸ªå®å€¼</span></span><br><span class="line"><span class="comment">//å°†å®å€¼å¤åˆ¶ä¸€ä»½ï¼Œä¾›æœ¬å­—ç¬¦ä¸²å•ç‹¬ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">if</span>(theString.value-&gt;<span class="built_in">isShared</span>())&#123;</span><br><span class="line">theString.value = <span class="keyword">new</span> <span class="built_in">StringValue</span>(theString.value-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç°åœ¨è¿›è¡Œèµ‹å€¼åŠ¨ä½œï¼šå°†rhsæ‰€ä»£è¡¨çš„å­—ç¬¦å€¼</span></span><br><span class="line"><span class="comment">//èµ‹äºˆ*thisæ‰€ä»£è¡¨çš„å­—ç¬¦</span></span><br><span class="line">theString.value-&gt;datap[charIndex] = </span><br><span class="line">rhs.theString.value-&gt;data[rhs.charIndex];</span><br><span class="line"><span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¬¬äºŒä¸ªCharProxyèµ‹å€¼æ“ä½œç¬¦å’Œä¸Šè¿°ä¼ ç»Ÿç‰ˆæœ¬å‡ ä¹é›·åŒï¼š</span></span><br><span class="line">CharProxy&amp; String::CharProxy::<span class="keyword">operator</span> = (<span class="type">char</span> c)&#123;</span><br><span class="line"><span class="keyword">if</span>(theString.value-&gt;<span class="built_in">isShared</span>())</span><br><span class="line">theString.value = <span class="keyword">new</span> <span class="built_in">StringValue</span>(theString.value-&gt;data);</span><br><span class="line"></span><br><span class="line">theString.value-&gt;data[charIndex] = c;</span><br><span class="line"><span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†ä¸Šè¿°ä¸¤ä¸ªèµ‹å€¼æ“ä½œç¬¦çš„é‡å¤ä»£ç æŠ½å‡ºæ¥æ”¾è¿›ä¸€ä¸ªç§æœ‰çš„CharProxyæˆå‘˜å‡½æ•°</span></span><br><span class="line"><span class="comment">//ç„¶åè®©ä¸¤ä¸ªæ“ä½œç¬¦éƒ½å»è°ƒç”¨å®ƒ</span></span><br></pre></td></tr></table></figure><h3 id="é™åˆ¶éšå¼ç±»å‹è½¬æ¢">é™åˆ¶éšå¼ç±»å‹è½¬æ¢</h3><p>éš¾ç‚¹ï¼šâ€œå¯¹proxyå–å€â€æ‰€è·å–çš„æŒ‡é’ˆç±»å‹å’Œâ€œå¯¹çœŸå®å¯¹è±¡å–å€â€è·å–çš„æŒ‡é’ˆç±»å‹ä¸åŒã€‚</p><p>è§£å†³ï¼šéœ€è¦åœ¨CharProxyç±»å†…å°†å–å€æ“ä½œç¬¦åŠ ä»¥é‡è½½ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">String</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CharProxy</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">...</span><br><span class="line"><span class="type">char</span>* <span class="keyword">operator</span>&amp;();</span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">operator</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span>* String::CharProxy::<span class="built_in">operator</span>() <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> &amp;(theString.value-&gt;data[charIndex]);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">char</span>* String::CharProxy::<span class="keyword">operator</span>&amp;()</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//ç¡®å®šâ€œæ ‡çš„å­—ç¬¦â€æ‰€å±çš„å­—ç¬¦ä¸²å®å€¼ä¸ä¸ºä»»ä½•å…¶ä»–ä»»ä½•Stringå¯¹è±¡å…±äº«</span></span><br><span class="line"><span class="keyword">if</span>(theString.value-&gt;<span class="built_in">isShared</span>())&#123;</span><br><span class="line">theString.value = <span class="keyword">new</span> <span class="built_in">StringValue</span>(theString.value-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æˆ‘ä»¬ä¸çŸ¥é“clientsä¼šå°†æœ¬å‡½æ•°è¿”å›çš„æŒ‡é’ˆä¿ç•™å¤šä¹…ï¼Œæ‰€ä»¥â€œç›®æ ‡å­—ç¬¦â€æ‰€å±çš„å­—ç¬¦ä¸²å®å€¼ç»ä¸å¯ä»¥è¢«å…±äº«</span></span><br><span class="line">theString.value-&gt;<span class="built_in">markUnshanreable</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;(theString.value-&gt;data[charIndex]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ¡æ¬¾-31ï¼šè®©å‡½æ•°æ ¹æ®ä¸€ä¸ªä»¥ä¸Šçš„å¯¹è±¡ç±»å‹æ¥å†³å®šå¦‚ä½•è™šåŒ–">æ¡æ¬¾ 31ï¼šè®©å‡½æ•°æ ¹æ®ä¸€ä¸ªä»¥ä¸Šçš„å¯¹è±¡ç±»å‹æ¥å†³å®šå¦‚ä½•è™šåŒ–</h2><p>é‡ŒæŒ‡å‡ºäº†ä¸€ä¸ªæƒ…å†µï¼Œä¾‹å¦‚æˆ‘ä»¬æœ‰ä¸‰ç§ç‰©ä½“ï¼Œä¸”éƒ½ç»§æ‰¿<code>GameObject</code></p><ul><li><code>SpaceShip</code> é£èˆ¹</li><li><code>SpaceStation</code> ç©ºé—´ç«™</li><li><code>Asteroid</code> é™¨çŸ³</li></ul><p>ä¸åŒçš„ç‰©ä½“ä¼šç›¸æ’ï¼Œä¸”ä¼šäº§ç”Ÿä¸åŒçš„ç»“æœã€‚ä¾‹å¦‚é£èˆ¹å’Œç©ºé—´ç«™ç›¸æ’ï¼Œé£èˆ¹èƒ½è¿›å…¥åˆ°ç©ºé—´ç«™å†…ï¼›é£èˆ¹å’Œé™¨çŸ³ç›¸æ’ï¼Œä¸¤è€…éƒ½ä¼šæ‘§æ¯ã€‚<br>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–¹æ³•ï¼Œä¼ å…¥ä»»æ„ä¿©ä¸ª<code>GameObject</code>éƒ½å¯ä»¥å¤„ç†ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">processCollision</span><span class="params">(GameObject&amp; object1, GameObject&amp; object2)</span></span></span><br></pre></td></tr></table></figure><p>ä¹¦ä¸­è®¨è®ºäº†ä¸€å¥—æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªä¸é”™çš„æ–¹æ³•ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜ä¸æ˜¯å¾ˆå®Œç¾ã€‚ç›®å‰å°±æ•´ç†ä¸€ä¸‹ä»£ç ï¼Œè®°å½•ä¸‹æ¥ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameObject</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">GameObject</span>() &#123;&#125; <span class="comment">//åŸºç±»é‡Œé¢æœ‰è™šå‡½æ•°ï¼Œæ´¾ç”Ÿç±»ç»§æ‰¿åï¼Œä½¿ç”¨typeid().nameæ‰èƒ½å–å¾—å¯¹åº”çš„class name</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpaceShip</span> : <span class="keyword">public</span> GameObject &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpaceStation</span> : <span class="keyword">public</span> GameObject &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Asteroid</span> : <span class="keyword">public</span> GameObject &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŒ¿ånamespace</span></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="keyword">using</span> std::string;</span><br><span class="line">    <span class="keyword">using</span> std::map;</span><br><span class="line">    <span class="keyword">using</span> std::make_pair;</span><br><span class="line">    <span class="keyword">using</span> std::pair;</span><br><span class="line">    <span class="keyword">using</span> std::cout;</span><br><span class="line">    <span class="keyword">using</span> std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">shipAsteroid</span><span class="params">(GameObject&amp; spaceShip, GameObject&amp; asteroid)</span> </span>&#123; cout &lt;&lt; <span class="string">&quot;spaceShip collide with asteroid&quot;</span> &lt;&lt; endl; &#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">shipStation</span><span class="params">(GameObject&amp; spaceShip, GameObject&amp; spaceStation)</span> </span>&#123; cout &lt;&lt; <span class="string">&quot;spaceShip collide with spaceStation&quot;</span> &lt;&lt; endl; &#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">asteroidStation</span><span class="params">(GameObject&amp; asteroid, GameObject&amp; spaceStation)</span> </span>&#123; cout &lt;&lt; <span class="string">&quot;asteroid collide with spaceStation&quot;</span> &lt;&lt; endl; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">asteroidShip</span><span class="params">(GameObject&amp; asteroid, GameObject&amp; spaceShip)</span> </span>&#123; <span class="built_in">shipAsteroid</span>(spaceShip, asteroid); &#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">stationShip</span><span class="params">(GameObject&amp; spaceStation, GameObject&amp; spaceShip)</span> </span>&#123; <span class="built_in">shipStation</span>(spaceShip, spaceStation); &#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">stationAsteroid</span><span class="params">(GameObject&amp; spaceStation, GameObject&amp; asteroid)</span> </span>&#123; <span class="built_in">asteroidStation</span>(asteroid, spaceStation); &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¢°æ’map</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CollisionMap</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//è¿™é‡Œä½¿ç”¨å•ä¾‹</span></span><br><span class="line">    <span class="function"><span class="type">static</span> CollisionMap* <span class="title">theCollisionMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">static</span> CollisionMap CM;</span><br><span class="line">        <span class="keyword">return</span> &amp;CM;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*HitFunctionPtr)</span><span class="params">(GameObject&amp;, GameObject&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™é‡Œæ·»åŠ æ–°çš„ç¢°æ’å¤„ç†å‡½æ•°ï¼Œæˆå¯¹å¤„ç†</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addEntry</span><span class="params">(<span class="type">const</span> string&amp; type1, <span class="type">const</span> string&amp; type2, HitFunctionPtr collisionFunction)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (collisionMap.<span class="built_in">find</span>(std::<span class="built_in">make_pair</span>(type1, type2)) != collisionMap.<span class="built_in">end</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æˆå¯¹æ·»åŠ </span></span><br><span class="line">        collisionMap[std::<span class="built_in">make_pair</span>(type1, type2)] = collisionFunction;</span><br><span class="line">        collisionMap[std::<span class="built_in">make_pair</span>(type2, type1)] = collisionFunction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™é‡Œç§»é™¤ç¢°æ’å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">removeEntry</span><span class="params">(<span class="type">const</span> string&amp; type1, <span class="type">const</span> string&amp; type2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (collisionMap.<span class="built_in">find</span>(std::<span class="built_in">make_pair</span>(type1, type2)) != collisionMap.<span class="built_in">end</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æˆå¯¹ç§»é™¤</span></span><br><span class="line">        collisionMap.<span class="built_in">erase</span>(std::<span class="built_in">make_pair</span>(type1, type2));</span><br><span class="line">        collisionMap.<span class="built_in">erase</span>(std::<span class="built_in">make_pair</span>(type2, type1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŸ¥æ‰¾æœ‰æ²¡æœ‰å¯¹åº”çš„ç¢°æ’å‡½æ•°</span></span><br><span class="line">    <span class="function">HitFunctionPtr <span class="title">lookup</span><span class="params">(<span class="type">const</span> string&amp; class1, <span class="type">const</span> string&amp; class2)</span> </span>&#123;</span><br><span class="line">        HitMap::iterator it = collisionMap.<span class="built_in">find</span>(<span class="built_in">make_pair</span>(class1, class2));</span><br><span class="line">        <span class="keyword">if</span> (it == collisionMap.<span class="built_in">end</span>()) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (*it).second;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">typedef</span> map&lt;pair&lt;string, string&gt;, HitFunctionPtr&gt; HitMap;</span><br><span class="line">    HitMap collisionMap;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CollisionMap</span>() &#123; <span class="built_in">initializeCollisionMap</span>(); &#125;;</span><br><span class="line">    <span class="built_in">CollisionMap</span>(<span class="type">const</span> CollisionMap&amp;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œå¯ä»¥å†…éƒ¨åˆå§‹åŒ–ï¼Œä¹Ÿå¯ä»¥æ”¹ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ³¨å†Œä¸€ä¸‹å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">initializeCollisionMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        collisionMap.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">addEntry</span>(<span class="string">&quot;class SpaceShip&quot;</span>, <span class="string">&quot;class Asteroid&quot;</span>, &amp;shipAsteroid);</span><br><span class="line">        <span class="built_in">addEntry</span>(<span class="string">&quot;class SpaceShip&quot;</span>, <span class="string">&quot;class SpaceStation&quot;</span>, &amp;shipStation);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŒ¿ånamespace</span></span><br><span class="line"><span class="keyword">namespace</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œå¤„ç†ç¢°æ’ï¼Œä¼šæŸ¥æ‰¾ç¢°æ’mapï¼Œå¦‚æœæœ‰å‡½æ•°å°±æ‰§è¡Œï¼Œæ²¡æœ‰çš„è¯å°±æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">processCollision</span><span class="params">(GameObject&amp; object1, GameObject&amp; object2)</span> </span>&#123;  </span><br><span class="line">        CollisionMap* CM = CollisionMap::<span class="built_in">theCollisionMap</span>();</span><br><span class="line"> </span><br><span class="line">        CollisionMap::HitFunctionPtr phf = CM-&gt;<span class="built_in">lookup</span>(<span class="built_in">typeid</span>(object1).<span class="built_in">name</span>(), <span class="built_in">typeid</span>(object2).<span class="built_in">name</span>());</span><br><span class="line">        <span class="keyword">if</span> (phf) <span class="built_in">phf</span>(object1, object2);</span><br><span class="line">        <span class="keyword">else</span> cout &lt;&lt; <span class="string">&quot;UnkowCollision! &quot;</span> &lt;&lt; <span class="built_in">typeid</span>(object1).<span class="built_in">name</span>() &lt;&lt; <span class="string">&quot; - &quot;</span> &lt;&lt; <span class="built_in">typeid</span>(object2).<span class="built_in">name</span>() &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SpaceShip spaceShip;</span><br><span class="line">    Asteroid asteroid;</span><br><span class="line">    SpaceStation spaceStation;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">processCollision</span>(spaceShip, asteroid);  <span class="comment">//spaceShip collide with asteroid</span></span><br><span class="line">    <span class="built_in">processCollision</span>(asteroid, spaceShip);  <span class="comment">//UnkowCollision! class Asteroid - class SpaceShip</span></span><br><span class="line">    <span class="built_in">processCollision</span>(spaceShip, spaceStation); <span class="comment">//spaceShip collide with spaceStation</span></span><br><span class="line">    <span class="built_in">processCollision</span>(asteroid, spaceStation); <span class="comment">//UnkowCollision! class Asteroid - class SpaceStation</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>Miscellany æ‚é¡¹è®¨è®º</h1><h2 id="æ¡æ¬¾-32ï¼šåœ¨æœªæ¥æ—¶æ€ä¸‹å‘å±•ç¨‹åº">æ¡æ¬¾ 32ï¼šåœ¨æœªæ¥æ—¶æ€ä¸‹å‘å±•ç¨‹åº</h2><p>æœªæ¥å¼æ€ç»´åªä¸è¿‡æ˜¯åŠ ä¸Šä¸€äº›é¢å¤–çš„è€ƒè™‘ï¼š</p><ol><li><p>æä¾›å®Œæ•´çš„classesâ€”â€”å³ä½¿æŸäº›éƒ¨åˆ†ç›®å‰ç”¨ä¸åˆ°ã€‚å½“æ–°çš„éœ€æ±‚è¿›æ¥ï¼Œä½ ä¸å¤ªéœ€è¦å»å›å¤´ä¿®æ”¹é‚£äº›classesï¼›<br>æ¯”å¦‚ï¼šã€C++ Efficiencyã€‘over-eager evaluationçš„ä¸¤ç§åšæ³•ï¼šcachingå’Œprefetching</p></li><li><p>è®¾è®¡ä½ çš„æ¥å£ï¼Œä½¿æœ‰åˆ©å…±åŒçš„æ“ä½œè¡Œä¸ºï¼Œé˜»æ­¢å…±åŒçš„é”™è¯¯ã€‚è®©è¿™äº›classesè½»æ˜“åœ°è¢«æ­£ç¡®è¿ç”¨ï¼Œéš¾ä»¥è¢«é”™è¯¯è¿ç”¨ï¼›</p></li><li><p>å°½é‡ä½¿ä½ çš„ä»£ç ä¸€èˆ¬åŒ–ï¼ˆæ³›åŒ–ï¼‰ï¼Œé™¤éæœ‰ä¸è‰¯çš„å·¨å¤§åæœã€‚</p></li></ol><h2 id="æ¡æ¬¾-33ï¼šå°†éå°¾ç«¯ç±»ï¼ˆnonï½leaf-classesï¼‰è®¾è®¡ä¸ºæŠ½è±¡ç±»ï¼ˆabstract-classesï¼‰">æ¡æ¬¾ 33ï¼šå°†éå°¾ç«¯ç±»ï¼ˆnonï½leaf classesï¼‰è®¾è®¡ä¸ºæŠ½è±¡ç±»ï¼ˆabstract classesï¼‰</h2><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ç§è¿™æ ·çš„ç»§æ‰¿ç»“æ„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Animal&amp; <span class="keyword">operator</span>=( Animal&amp; rhs)&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Lizard</span> : <span class="keyword">public</span> Animal &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Lizard&amp; <span class="keyword">operator</span>=( Lizard&amp; rhs)&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chicken</span> : <span class="keyword">public</span> Animal &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Chicken&amp; <span class="keyword">operator</span>=( Chicken&amp; rhs)&#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">Lizard liz1;</span><br><span class="line">Lizard liz2;</span><br><span class="line">Chicken chick;</span><br><span class="line"></span><br><span class="line">Animal *pAnimal1 = &amp;liz1;</span><br><span class="line">Animal *pAnimal2 = &amp;liz2;</span><br><span class="line">Animal *pAnimal3 = &amp;chick;</span><br><span class="line"></span><br><span class="line"><span class="comment">//*pAnimal1 = *pAnimal2;      //å°†ä¸€åªèœ¥èœ´èµ‹å€¼ç»™å¦ä¸€åªèœ¥èœ´ï¼Œéœ€è¦åˆæ³•ï¼Œéœ€è¦å…è®¸</span></span><br><span class="line">*pAnimal1 = *pAnimal3;      <span class="comment">//å°†ä¸€åªé¸¡èµ‹å€¼ç»™ä¸€åªèœ¥èœ´ï¼Œemmm ä¸åˆæ³•ï¼Œéœ€è¦ç¦æ­¢</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ƒè™‘åˆ°ç»§æ‰¿å…³ç³»ï¼Œ<code>Lizard</code> ç±»å‹çš„å¯¹è±¡å¯ä»¥è¢«è§†ä¸º <code>Animal</code> ç±»å‹çš„å¯¹è±¡ï¼Œå› ä¸º <code>Lizard</code> æ˜¯ <code>Animal</code> çš„æ´¾ç”Ÿç±»ã€‚å› æ­¤ï¼Œ<code>*pAnimal1 = *pAnimal2;</code> è¿™ç§æƒ…å†µä¸‹æ˜¯åˆæ³•çš„ï¼Œå› ä¸ºå®ƒå°†ä¸€ä¸ª <code>Lizard</code> ç±»å‹çš„å¯¹è±¡èµ‹å€¼ç»™äº†å¦ä¸€ä¸ª <code>Lizard</code> ç±»å‹çš„å¯¹è±¡ã€‚</p><p><code>*pAnimal1 = *pAnimal3;</code> è¿™ç§æƒ…å†µä¸‹æ˜¯ä¸åˆæ³•çš„ã€‚å°½ç®¡ <code>pAnimal1</code> å’Œ <code>pAnimal3</code> éƒ½æ˜¯ <code>Animal</code> ç±»å‹çš„æŒ‡é’ˆï¼Œä½†æ˜¯å®ƒä»¬æŒ‡å‘çš„å¯¹è±¡ç±»å‹ä¸åŒï¼Œä¸€ä¸ªæ˜¯ <code>Lizard</code>ï¼Œä¸€ä¸ªæ˜¯ <code>Chicken</code>ã€‚åœ¨èµ‹å€¼æ“ä½œä¸­ï¼Œç¼–è¯‘å™¨ä¼šå°è¯•è°ƒç”¨é€‚å½“çš„èµ‹å€¼è¿ç®—ç¬¦é‡è½½å‡½æ•°ï¼Œ<strong>ä½†æ˜¯ <code>Animal</code> ç±»å‹çš„èµ‹å€¼è¿ç®—ç¬¦å‡½æ•°åªèƒ½ä¿è¯å¤„ç† <code>Animal</code> ç±»å‹çš„å¯¹è±¡ï¼Œè€Œä¸èƒ½å¤„ç† <code>Lizard</code> æˆ– <code>Chicken</code> ç±»å‹çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œå°è¯•å°† <code>Chicken</code> ç±»å‹çš„å¯¹è±¡èµ‹å€¼ç»™ <code>Lizard</code> ç±»å‹çš„å¯¹è±¡æ˜¯ä¸åˆæ³•çš„ï¼Œè¿™æ˜¯ç”±äºç±»å‹ä¸åŒ¹é…é€ æˆçš„ã€‚</strong></p><p>ä¸Šè¾¹ä»£ç å­˜åœ¨çš„ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>éƒ¨åˆ†èµ‹å€¼ï¼šæœ€åä¸€å¥è°ƒç”¨ Animal class çš„èµ‹å€¼æ“ä½œç¬¦åªä¼šä¿®æ”¹ liz çš„ Animal æˆåˆ†</li><li>class å®¹æ˜“è¢«è¯¯ç”¨ï¼Œå¦‚æœå°† <code>Animal::operator=</code> åˆ™ä¼šè®©ä¸Šè¾¹çš„ä»£ç æˆä¸ºåˆæ³•ä»£ç ï¼Œè¿™ä¼šå¸¦æ¥å¼‚å‹èµ‹å€¼é—®é¢˜</li></ul><p>é€šè¿‡è®¾è®¡æŠ½è±¡ç±»ï¼Œå¯ä»¥å®ç°é€šè¿‡æŒ‡é’ˆè¿›è¡Œçš„åŒå‹èµ‹å€¼è€Œåˆå¯ä»¥ç¦æ­¢é€šè¿‡åŒæ ·é‚£äº›æŒ‡é’ˆè€Œè¿›è¡Œçš„å¼‚å‹èµ‹å€¼ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AbstractAnimal</span>&#123;<span class="comment">//æŠ½è±¡ç±»--å¿…é¡»å†…å«è‡³å°‘ä¸€ä¸ªçº¯è™šå‡½æ•°</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    AbstractAnimal&amp; <span class="keyword">operator</span>=(<span class="type">const</span> AbstractAnimal&amp; rhs);</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">AbstractAnimal</span>() = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>: <span class="keyword">public</span> AbstractAnimal&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Animal&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Animal&amp; rhs);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Lizard</span>:<span class="keyword">public</span> AbstractAnimal&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> Lizard&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Animal&amp; rhs);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chicken</span>:<span class="keyword">public</span> AbstractAnimal&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> Chicken&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Animal&amp; rhs);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰ä»»ä½• member functions å¯ä»¥å¾ˆè‡ªç„¶åœ°è¢«ä½ å£°æ˜ä¸ºçº¯è™šå‡½æ•°ï¼Œä¼ ç»Ÿåšæ³•æ˜¯è®© destructor æˆä¸ºçº¯è™šå‡½æ•°ã€‚</p><p>çº¯è™šææ„å‡½æ•°å¿…é¡»è¢«å®ç°å‡ºæ¥ï¼Œå› ä¸ºåªè¦æœ‰ä¸€ä¸ª derived class destructor è¢«è°ƒç”¨ï¼Œå®ƒä»¬ä¾¿ä¼šè¢«è°ƒç”¨ã€‚æ­¤å¤–ï¼Œå®ƒä»¬é€šå¸¸æ‰§è¡Œä¸€äº›æœ‰ç”¨çš„å·¥ä½œï¼Œå¦‚é‡Šæ”¾èµ„æºæˆ–è®°å½•è¿è½¬æ¶ˆæ¯ç­‰ç­‰ã€‚</p><h2 id="æ¡æ¬¾-34ï¼šå¦‚ä½•åœ¨åŒä¸€ä¸ªç¨‹åºä¸­ç»“åˆ-C-å’Œ-C">æ¡æ¬¾ 34ï¼šå¦‚ä½•åœ¨åŒä¸€ä¸ªç¨‹åºä¸­ç»“åˆ C++å’Œ C</h2><ol><li>name manglingï¼ˆåç§°é‡æ•´ï¼‰ã€staticsï¼ˆé™æ€å¯¹è±¡ï¼‰åˆå§‹åŒ–ã€åŠ¨æ€å†…å­˜åˆ†é…ã€æ•°æ®ç»“æ„çš„å…¼å®¹æ€§ã€‚</li><li>å¦‚æœä½ æ‰“ç®—åœ¨åŒä¸€ä¸ªç¨‹åºä¸­æ··ç”¨ C++å’Œ Cï¼Œè¯·è®°ä½ä»¥ä¸‹å‡ ä¸ªç®€å•å®ˆåˆ™ï¼š<ul><li>ç¡®å®šä½ çš„ C++å’Œ C ç¼–è¯‘å™¨äº§å‡ºå…¼å®¹çš„ç›®æ ‡æ–‡ä»¶ï¼ˆobject filesï¼‰ã€‚</li><li>å°†åŒæ–¹éƒ½ä½¿ç”¨çš„å‡½æ•°å£°æ˜ä¸º<code> extern ï¼‚Cï¼‚</code>ã€‚</li><li>å¦‚æœå¯èƒ½ï¼Œå°½é‡åœ¨ C++ä¸­æ’°å†™<code>main</code>ã€‚</li><li>æ€»æ˜¯ä»¥ deleteåˆ é™¤ newè¿”å›çš„å†…å­˜ï¼›æ€»æ˜¯ä»¥ <code>free </code>é‡Šæ”¾ <code>malloc</code> è¿”å›çš„å†…å­˜ã€‚</li><li>å°†ä¸¤ä¸ªè¯­è¨€é—´çš„â€œæ•°æ®ç»“æ„ä¼ é€’â€é™åˆ¶äº C æ‰€èƒ½äº†è§£çš„å½¢å¼ï¼›C++ structs å¦‚æœå†…å«éè™šå‡½æ•°ï¼Œå€’æ˜¯ä¸å—æ­¤é™ã€‚</li></ul></li></ol><h2 id="æ¡æ¬¾-35ï¼šè®©è‡ªå·±ä¹ æƒ¯äºæ ‡å‡†-C-è¯­è¨€">æ¡æ¬¾ 35ï¼šè®©è‡ªå·±ä¹ æƒ¯äºæ ‡å‡† C++è¯­è¨€</h2><p>ä¸»è¦æ˜¯äº†è§£ä¸æ–­å‘å±•çš„ C++ æ ‡å‡†çš„ç‰¹æ€§ï¼šRTTIã€Templatesã€å¼‚å¸¸å¤„ç†ã€STLç­‰ã€‚</p><h1>å‚è€ƒæ–‡ç« </h1><ul><li><a href="https://blog.csdn.net/lujiandong1/article/details/41799959">æ¡æ¬¾19 äº†è§£ä¸´æ—¶å¯¹è±¡çš„æ¥æº</a></li><li><a href="https://blog.csdn.net/weixin_28712713/article/details/80995472">5 å¯¹å®šåˆ¶çš„â€œç±»å‹è½¬æ¢å‡½æ•°â€ä¿å­˜è­¦è§‰</a></li><li><a href="https://blog.csdn.net/weixin_30457551/article/details/99191112">é™åˆ¶æŸä¸ªç±»æ‰€èƒ½äº§ç”Ÿçš„å¯¹è±¡æ•°é‡</a></li><li><a href="https://segmentfault.com/a/1190000040890556">è¦æ±‚ï¼ˆæˆ–ç¦æ­¢ï¼‰å¯¹è±¡äº§ç”Ÿäºheapä¹‹ä¸­</a></li><li><a href="https://blog.csdn.net/weixin_49347928/article/details/133706022">åˆ©ç”¨Proxy classesï¼ˆä»£ç†ç±»ï¼‰å®ç°ï¼šå¤šç»´æ•°ç»„ã€åŒºåˆ†å·¦/å³å€¼è¿ç”¨ã€é™åˆ¶éšå¼ç±»å‹è½¬æ¢</a></li><li><a href="https://www.xhxha.one/post/moreeffectivec++_5/#%E6%9D%A1%E6%AC%BE-25%E5%B0%86-constructor-%E5%92%8C-non-member-functions-%E8%99%9A%E5%8C%96">More Effective C++ | ç¬¬ 5 ç«  æŠ€æœ¯</a></li><li><a href="https://zhuanlan.zhihu.com/p/575971939">ã€ã€ŠMore Effective C++ (35ä¸ªæ”¹å–„ç¼–ç¨‹ä¸è®¾è®¡çš„æœ‰æ•ˆæ–¹æ³•)ã€‹ è¯»ä¹¦ç¬”è®°ã€‘æ¡æ¬¾31ï¼šè®©å‡½æ•°æ ¹æ®ä¸€ä¸ªä»¥ä¸Šçš„å¯¹è±¡ç±»å‹æ¥å†³å®šå¦‚ä½•è™šåŒ–</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Cpp </category>
          
          <category> è¯»ä¹¦ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cpp </tag>
            
            <tag> è¯»ä¹¦ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Effectivate Modern Cpp</title>
      <link href="/posts/ccc0d0ac.html"/>
      <url>/posts/ccc0d0ac.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>è½¬è½½ï¼š<a href="https://joytsing.cn/posts/46568/">https://joytsing.cn/posts/46568/</a></p><p>ç»“åˆè‡ªå·±çš„å­¦ä¹ å†…å®¹è¿›è¡Œè¡¥å……</p><h2 id="ç¬¬ä¸€ç« ï¼šç±»å‹æ¨å¯¼">ç¬¬ä¸€ç« ï¼šç±»å‹æ¨å¯¼</h2><h3 id="æ¡æ¬¾-1ï¼šç†è§£æ¨¡æ¿ç±»å‹æ¨å¯¼">æ¡æ¬¾ 1ï¼šç†è§£æ¨¡æ¿ç±»å‹æ¨å¯¼</h3><hr><p>é‡ç‚¹ï¼š</p><blockquote><p><strong>æ¨¡æ¿ç±»å‹æ¨å¯¼</strong></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(ParamType param)</span></span>;</span><br></pre></td></tr></table></figure><p>åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨é€šè¿‡ expr æ¥è¿›è¡Œæ¨å¯¼å‡ºä¸¤ä¸ªç±»å‹ï¼š</p><ul><li>T</li><li>ParamType</li></ul><p>å½¢å¼:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f(expr); <span class="comment">// ç”¨ä¸€äº›è¡¨è¾¾å¼æ¥è°ƒç”¨f</span></span><br></pre></td></tr></table></figure><p><strong>å¯¹äº T çš„ç±»å‹æ¨å¯¼ä¸ä»…å–å†³äº <code>expr</code> çš„ç±»å‹ï¼Œè¿˜å–å†³äº <code>ParamType</code> çš„å½¢å¼</strong>ã€‚</p><p>æœ‰ä¸‰ç§æƒ…å†µï¼š</p><ul><li><code>ParamType</code> æ˜¯æŒ‡é’ˆæˆ–å¼•ç”¨ï¼Œä½†ä¸æ˜¯é€šç”¨å¼•ç”¨ï¼ˆé€šç”¨å¼•ç”¨åœ¨æ¡æ¬¾24ä¸­ä»‹ç»ï¼‰ã€‚</li><li><code>ParamType</code> æ˜¯é€šç”¨å¼•ç”¨ã€‚</li><li><code>ParamType</code> æ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨ã€‚<ul><li>æŒ‰pass-by-valueå¤„ç†ï¼š<ul><li>å¦‚æœ expr çš„ç±»å‹æ˜¯ä¸ªå¼•ç”¨ï¼Œå°†ä¼šå¿½ç•¥å¼•ç”¨çš„éƒ¨åˆ†ã€‚</li><li>å¦‚æœexpr æ˜¯ const çš„ï¼Œä¹Ÿè¦å¿½ç•¥æ‰ const ã€‚å¦‚æœæ˜¯ volatileçš„ï¼Œä¹Ÿè¦å¿½ç•¥æ‰ã€‚</li></ul></li></ul></li></ul><blockquote><p><strong>æ•°ç»„å‚æ•°</strong></p></blockquote><p><strong>è™½ç„¶é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ•°ç»„ä¼šè¢«é€€åŒ–æˆä¸€ä¸ªæŒ‡å‘å…¶ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œæ•°ç»„ç±»å‹å’ŒæŒ‡é’ˆç±»å‹æ˜¯ä¸ä¸€æ ·çš„</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> name[] = <span class="string">&quot;J. P. Briggs&quot;</span>; <span class="comment">// nameçš„ç±»å‹æ˜¯const char[13]</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * ptrToName = name; <span class="comment">// æ•°ç»„è¢«é€€åŒ–æˆæŒ‡é’ˆ</span></span><br></pre></td></tr></table></figure><p>case1:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">myFunc</span><span class="params">(<span class="type">int</span> param[])</span>; Â  </span><br><span class="line"><span class="type">void</span> <span class="title function_">myFunc</span><span class="params">(<span class="type">int</span>* param)</span>; Â  Â <span class="comment">// å’Œä¸Šé¢çš„å‡½æ•°æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">f(name); <span class="comment">// nameæ˜¯ä¸ªæ•°ç»„ï¼Œä½†æ˜¯Tè¢«æ¨å¯¼æˆconst char*</span></span><br></pre></td></tr></table></figure><p>case2:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp; param)</span></span>; <span class="comment">// å¼•ç”¨å‚æ•°çš„æ¨¡æ¿</span></span><br><span class="line"><span class="built_in">f</span>(name); <span class="comment">// ä¼ é€’æ•°ç»„ç»™f</span></span><br></pre></td></tr></table></figure><p><strong>T è¢«æ¨å¯¼æˆäº† const char [13] ï¼Œå‡½æ•° f çš„å‚æ•°ï¼ˆæ•°ç»„çš„å¼•ç”¨ï¼‰è¢«æ¨å¯¼æˆäº† const char(&amp;)[13]</strong></p><blockquote><p><strong>å‡½æ•°å‚æ•°</strong></p></blockquote><p>å‡½æ•°ç±»å‹å¯ä»¥è¢«é€€åŒ–æˆå‡½æ•°æŒ‡é’ˆ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">someFunc</span><span class="params">(<span class="type">int</span>ï¼Œ <span class="type">double</span>)</span></span>; <span class="comment">// someFuncæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç±»å‹æ˜¯void(int, double)</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">(T param)</span></span>; <span class="comment">// åœ¨f1ä¸­ å‚æ•°ç›´æ¥æŒ‰å€¼ä¼ é€’</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f2</span><span class="params">(T&amp; param)</span></span>; <span class="comment">// åœ¨f2ä¸­ å‚æ•°æ˜¯æŒ‰ç…§ä¼ é€’</span></span><br><span class="line"><span class="built_in">f1</span>(someFunc); <span class="comment">// paramè¢«æ¨å¯¼æˆå‡½æ•°æŒ‡é’ˆï¼Œç±»å‹æ˜¯void(*)(int, double)</span></span><br><span class="line"><span class="built_in">f2</span>(someFunc); <span class="comment">// paramè¢«æ¨å¯¼æˆå‡½æ•°å¼•ç”¨ï¼Œç±»å‹æ˜¯void(&amp;)(int, double)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¦ç‚¹</p><ul><li><p>åœ¨æ¨¡æ¿ç±»å‹æ¨å¯¼æœŸé—´ï¼Œå¼•ç”¨å®å‚è¢«è§†ä¸ºéå¼•ç”¨ï¼Œå³å¿½ç•¥å…¶å¼•ç”¨æ€§è´¨ã€‚</p></li><li><p>åœ¨æ¨å¯¼é€šç”¨å¼•ç”¨å½¢å‚çš„ç±»å‹æ—¶ï¼Œå·¦å€¼å®å‚ä¼šå¾—åˆ°ç‰¹æ®Šå¤„ç†ã€‚</p></li><li><p>åœ¨æ¨å¯¼æŒ‰å€¼ä¼ é€’çš„å½¢å‚ç±»å‹æ—¶ï¼Œconst å’Œ/æˆ– volatile å‚æ•°è¢«è§†ä¸ºé const å’Œévolatileçš„ã€‚</p></li><li><p>åœ¨æ¨¡æ¿ç±»å‹æ¨å¯¼æœŸé—´ï¼Œæ•°ç»„æˆ–å‡½æ•°å®å‚ä¼šé€€åŒ–ä¸ºç›¸åº”çš„æŒ‡é’ˆï¼Œé™¤éå®ƒä»¬ç”¨äºåˆå§‹åŒ–å¼•ç”¨ã€‚</p></li></ul><hr><p>å‡½æ•°æ¨¡æ¿å¤§è‡´å½¢å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(ParamType param)</span></span>;</span><br></pre></td></tr></table></figure><p>åœ¨ç¼–è¯‘æœŸï¼Œç¼–è¯‘å™¨ä¼šé€šè¿‡è¡¨è¾¾å¼æ¨å¯¼å‡ºä¸¤ä¸ªç±»å‹ï¼šä¸€ä¸ªæ˜¯<code>T</code>çš„ç±»å‹ï¼Œå¦ä¸€ä¸ªæ˜¯<code>ParamType</code>çš„ç±»å‹ï¼Œè¿™ä¸¤ä¸ªç±»å‹å¾€å¾€ä¸ä¸€æ ·ï¼Œ<code>ParamType</code>å¸¸åŒ…å«ä¸€äº›é¥°è¯ï¼Œå¦‚<code>const</code>æˆ–å¼•ç”¨ç¬¦å·ç­‰é™å®šè¯ã€‚</p><p><strong>æƒ…å†µ 1ï¼šParamType æ˜¯ä¸ªæŒ‡é’ˆæˆ–å¼•ç”¨ï¼Œä½†ä¸æ˜¯ä¸ªä¸‡èƒ½å¼•ç”¨</strong></p><ol><li>è‹¥è¡¨è¾¾å¼å…·æœ‰å¼•ç”¨ç±»å‹ï¼Œåˆ™å…ˆå°†å¼•ç”¨éƒ¨åˆ†å¿½ç•¥ã€‚</li><li>å¯¹è¡¨è¾¾å¼çš„ç±»å‹å’Œ<code>ParamType</code>è¿›è¡ŒåŒ¹é…æ¥å†³å®š<code>T</code>çš„ç±»å‹ã€‚</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp; param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x = <span class="number">27</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> cx = x;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; rx = x;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(x);    <span class="comment">// T çš„ç±»å‹ä¸º int, paramType ä¸º int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(cx);   <span class="comment">// T çš„ç±»å‹ä¸º const int, paramType ä¸º const int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(rx);   <span class="comment">// T çš„ç±»å‹ä¸º const int, paramType ä¸º const int&amp;</span></span><br></pre></td></tr></table></figure><p>è‹¥æˆ‘ä»¬å‡å®š<code>param</code>å…·æœ‰å¸¸å¼•ç”¨ç±»å‹ï¼Œåˆ™<code>T</code>çš„ç±»å‹æ¨å¯¼ç»“æœä¸­ä¹Ÿå°±æ²¡å¿…è¦åŒ…å«<code>const</code>äº†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">const</span> T&amp; param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(x);    <span class="comment">// T çš„ç±»å‹ä¸º int, paramType ä¸º int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(cx);   <span class="comment">// T çš„ç±»å‹ä¸º int, paramType ä¸º const int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(rx);   <span class="comment">// T çš„ç±»å‹ä¸º int, paramType ä¸º const int&amp;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>param</code>æ˜¯ä¸ªæŒ‡é’ˆï¼ˆæˆ–æŒ‡å‘ const å¯¹è±¡çš„æŒ‡é’ˆï¼‰è€Œéå¼•ç”¨ï¼Œè¿ä½œæ–¹å¼æœ¬è´¨ä¸Šå¹¶æ— ä¸åŒï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T* param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x = <span class="number">27</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span>* px = &amp;x;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(&amp;x);   <span class="comment">// T çš„ç±»å‹ä¸º int, paramType ä¸º int*</span></span><br><span class="line"><span class="built_in">f</span>(px);   <span class="comment">// T çš„ç±»å‹ä¸º const int, paramType ä¸º const int*</span></span><br></pre></td></tr></table></figure><p><strong>æƒ…å†µ 2ï¼šParamType æ˜¯ä¸ªä¸‡èƒ½å¼•ç”¨</strong></p><blockquote><p>è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ<strong>æ¡æ¬¾ 24</strong>ã€‚</p></blockquote><ol><li>å¦‚æœè¡¨è¾¾å¼æ˜¯ä¸ªå·¦å€¼ï¼Œåˆ™<code>T</code>å’Œ<code>ParamType</code>éƒ½ä¼šè¢«æ¨å¯¼ä¸ºå·¦å€¼å¼•ç”¨ã€‚</li><li>å¦‚æœè¡¨è¾¾å¼æ˜¯ä¸ªå³å€¼ï¼Œåˆ™éµå¾ªæƒ…å†µ 1 ä¸­çš„è§„åˆ™ã€‚</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x = <span class="number">27</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> cx = x;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; rx = x;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å·¦å€¼çš„æƒ…å†µ</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(x);    <span class="comment">// T çš„ç±»å‹ä¸º int&amp;, paramType ä¸º int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(cx);   <span class="comment">// T çš„ç±»å‹ä¸º const int&amp;, paramType ä¸º const int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(rx);   <span class="comment">// T çš„ç±»å‹ä¸º const int&amp;, paramType ä¸º const int&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å³å€¼çš„æƒ…å†µ</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(<span class="number">27</span>)    <span class="comment">// T çš„ç±»å‹ä¸º int, paramType ä¸º int&amp;&amp;</span></span><br></pre></td></tr></table></figure><p><strong>æƒ…å†µ 3ï¼šParamType æ—¢éæŒ‡é’ˆä¹Ÿéå¼•ç”¨</strong></p><p>è¿™ç§æƒ…å†µå³ä¸ºæŒ‰å€¼ä¼ é€’ï¼Œæ— è®ºä¼ å…¥çš„æ˜¯ä»€ä¹ˆï¼Œ<code>param</code>éƒ½ä¼šæ˜¯å®ƒçš„ä¸€ä¸ªå‰¯æœ¬ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(x);    <span class="comment">// T å’Œ param çš„ç±»å‹å‡ä¸º int</span></span><br><span class="line"><span class="built_in">f</span>(cx);   <span class="comment">// T å’Œ param çš„ç±»å‹å‡ä¸º int</span></span><br><span class="line"><span class="built_in">f</span>(rx);   <span class="comment">// T å’Œ param çš„ç±»å‹å‡ä¸º int</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºæŒ‡å‘ const å¯¹è±¡çš„ const æŒ‡é’ˆçš„ä¼ é€’ï¼Œä»…æœ‰æŒ‡é’ˆæœ¬èº«çš„å¸¸é‡æ€§ä¼šè¢«å¿½ç•¥ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> ptr = <span class="string">&quot;Fun with pointers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(ptr);    <span class="comment">// T å’Œ param çš„ç±»å‹å‡ä¸º const char*</span></span><br></pre></td></tr></table></figure><p><strong>æ•°ç»„å®å‚ï¼š</strong></p><p>æŒ‰å€¼ä¼ é€’ç»™å‡½æ•°æ¨¡æ¿çš„æ•°ç»„ç±»å‹å°†é€€åŒ–ä¸ºæŒ‡é’ˆç±»å‹ï¼Œä½†æŒ‰å¼•ç”¨ä¼ é€’å´èƒ½æ¨å¯¼å‡ºçœŸæ­£çš„æ•°ç»„ç±»å‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp; param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> name[] = <span class="string">&quot;J. P. Briggs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(name);   <span class="comment">// T çš„ç±»å‹ä¸º const char[13], paramType ä¸º const char (&amp;)[13]</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨å£°æ˜æ•°ç»„å¼•ç”¨è¿™ä¸€èƒ½åŠ›å¯ä»¥åˆ›é€ å‡ºä¸€ä¸ªæ¨¡æ¿ï¼Œç”¨æ¥æ¨å¯¼å‡ºæ•°ç»„å«æœ‰çš„å…ƒç´ ä¸ªæ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, std::<span class="type">size_t</span> N&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> std::<span class="type">size_t</span> <span class="title">arraySize</span><span class="params">(T (&amp;)[N])</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> N;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å‡½æ•°å®å‚ï¼š</strong></p><p>å‡½æ•°ç±»å‹åŒæ ·ä¹Ÿä¼šé€€åŒ–æˆå‡½æ•°æŒ‡é’ˆï¼Œå¹¶ä¸”å’Œæ•°ç»„ç±»å‹çš„è§„åˆ™ç±»ä¼¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">someFunc</span><span class="params">(<span class="type">int</span>, <span class="type">double</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">(T param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f2</span><span class="params">(T&amp; param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f1</span>(someFunc);   <span class="comment">// param è¢«æ¨å¯¼ä¸ºå‡½æ•°æŒ‡é’ˆï¼Œå…·ä½“ç±»å‹ä¸º void (*)(int, double)</span></span><br><span class="line"><span class="built_in">f2</span>(someFunc);   <span class="comment">// param è¢«æ¨å¯¼ä¸ºå‡½æ•°å¼•ç”¨ï¼Œå…·ä½“ç±»å‹ä¸º void (&amp;)(int, double)</span></span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-2ï¼šç†è§£-auto-ç±»å‹æ¨å¯¼">æ¡æ¬¾ 2ï¼šç†è§£ auto ç±»å‹æ¨å¯¼</h3><hr><p>é‡ç‚¹ï¼š</p><p>autoç±»å‹æ¨å¯¼å‡ ä¹æ¨¡æ¿ç±»å‹æ¨å¯¼ã€å› æ­¤ï¼Œä¹Ÿåˆ†ä¸º3ç§æƒ…å†µã€‘ï¼Œé™¤äº†ç‰¹ä¾‹ã€‚</p><p>caseï¼šå¯¹å¾…èŠ±æ‹¬å·åˆå§‹åŒ–çš„è¡Œä¸ºï¼Œæ˜¯ auto å”¯ä¸€å’Œæ¨¡æ¿ç±»å‹æ¨å¯¼ä¸ä¸€æ ·çš„åœ°æ–¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> x = &#123; <span class="number">11</span>, <span class="number">23</span>, <span class="number">9</span> &#125;; <span class="comment">// xçš„ç±»å‹æ˜¯ std::initializer_list&lt;int&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="comment">// å’Œxçš„å£°æ˜ç­‰ä»·çš„æ¨¡æ¿</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T param)</span></span>; </span><br><span class="line"> </span><br><span class="line"><span class="built_in">f</span>(&#123; <span class="number">11</span>, <span class="number">23</span>, <span class="number">9</span> &#125;); <span class="comment">// é”™è¯¯ï¼æ²¡åŠæ³•æ¨å¯¼Tçš„ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(std::initializer_list&lt;T&gt; initList)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(&#123; <span class="number">11</span>, <span class="number">23</span>, <span class="number">9</span> &#125;); <span class="comment">// Tè¢«æ¨å¯¼æˆintï¼ŒinitListçš„ç±»å‹æ˜¯std::initializer_list&lt;int&gt;</span></span><br></pre></td></tr></table></figure><p>auto å’Œæ¨¡æ¿ç±»å‹æ¨å¯¼çš„<strong>æœ¬è´¨åŒºåˆ«</strong>å°±æ˜¯ auto å‡è®¾èŠ±æ‹¬å·åˆå§‹åŒ–ä»£è¡¨çš„æ˜¯std::initializer_listï¼Œä½†æ¨¡æ¿ç±»å‹æ¨å¯¼ä¸æ˜¯</p><p><strong>è¦ç‚¹</strong></p><ul><li>autoç±»å‹æ¨å¯¼é€šå¸¸ä¸æ¨¡æ¿ç±»å‹æ¨å¯¼ç›¸åŒï¼Œä½†autoç±»å‹æ¨å¯¼å‡å®šå¸¦èŠ±æ‹¬å·çš„åˆå§‹åŒ–åˆ—è¡¨çš„ç±»å‹è¡¨ç¤ºä¸º std::initializer_listï¼Œè€Œæ¨¡æ¿ç±»å‹æ¨å¯¼åˆ™ä¸ä¼šè¿™æ ·å‡è®¾ã€‚</li><li><strong>åœ¨å‡½æ•°è¿”å›ç±»å‹æˆ– lambda å‚æ•°ä¸­ä½¿ç”¨ auto æ„å‘³ç€æ¨¡æ¿ç±»å‹æ¨å¯¼ï¼Œè€Œä¸æ˜¯autoç±»å‹æ¨å¯¼ã€‚</strong></li></ul><hr><p><code>auto</code>ç±»å‹æ¨å¯¼é™¤äº†åœ¨ä¸€ä¸ªä¾‹å¤–æƒ…å†µä¸‹ï¼Œå’Œæ¨¡æ¿ç±»å‹æ¨å¯¼çš„è§„åˆ™ä¸€æ¨¡ä¸€æ ·ï¼ŒåŒæ ·å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æƒ…å†µ 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> x = <span class="number">27</span>;        <span class="comment">// ç±»å‹ä¸º int</span></span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span> cx = x;  <span class="comment">// ç±»å‹ä¸º const int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æƒ…å†µ 1</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span>&amp; rx = x; <span class="comment">// ç±»å‹ä¸º const int&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æƒ…å†µ 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span>&amp;&amp; uref1 = x;   <span class="comment">// ç±»å‹ä¸º int&amp;</span></span><br><span class="line"><span class="keyword">auto</span>&amp;&amp; uref2 = cx;  <span class="comment">// ç±»å‹ä¸º const int&amp;</span></span><br><span class="line"><span class="keyword">auto</span>&amp;&amp; uref3 = <span class="number">27</span>;  <span class="comment">// ç±»å‹ä¸º int&amp;&amp;</span></span><br></pre></td></tr></table></figure><p>æ•°ç»„å’Œå‡½æ•°å®å‚çš„éå¼•ç”¨é€€åŒ–è§„åˆ™ä¹ŸåŒæ ·é€‚ç”¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> name[] = <span class="string">&quot;J. P. Briggs&quot;</span>; <span class="comment">// ç±»å‹ä¸º const char[13]</span></span><br><span class="line"><span class="keyword">auto</span> arr1 = name;                   <span class="comment">// ç±»å‹ä¸º const char*</span></span><br><span class="line"><span class="keyword">auto</span>&amp; arr2 = name;                  <span class="comment">// ç±»å‹ä¸º const char (&amp;)[13]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">someFunc</span><span class="params">(<span class="type">int</span>, <span class="type">double</span>)</span></span>;         <span class="comment">// ç±»å‹ä¸º void(int, double)</span></span><br><span class="line"><span class="keyword">auto</span> func1= someFunc;               <span class="comment">// ç±»å‹ä¸º void (*)(int, double)</span></span><br><span class="line"><span class="keyword">auto</span>&amp; func2= someFunc;              <span class="comment">// ç±»å‹ä¸º void (&amp;)(int, double)</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å°†è®¨è®ºä¾‹å¤–æƒ…å†µï¼š<code>auto</code>ä¼šå‡å®šç”¨å¤§æ‹¬å·æ‹¬èµ·çš„åˆå§‹åŒ–è¡¨è¾¾å¼ä»£è¡¨ä¸€ä¸ª<code>std::initializer_list</code>ï¼Œä½†æ¨¡æ¿ç±»å‹æ¨å¯¼ä¸ä¼šã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> x3 = &#123; <span class="number">27</span> &#125;;   <span class="comment">// ç±»å‹ä¸º std::initializer_list&lt;int&gt;ï¼Œå€¼ä¸º &#123; 27 &#125;</span></span><br><span class="line"><span class="keyword">auto</span> x4&#123; <span class="number">27</span> &#125;;      <span class="comment">// åŒä¸Š</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> x5 = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3.0</span> &#125;;    <span class="comment">// é”™è¯¯ï¼Œç±»å‹ä¸ä¸€è‡´</span></span><br><span class="line">                            <span class="comment">// æ— æ³•æ¨å¯¼å‡º std::initializer_list&lt;T&gt; ä¸­çš„ T</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">(T param)</span></span>;</span><br><span class="line"><span class="built_in">f1</span>(&#123; <span class="number">11</span>, <span class="number">23</span>, <span class="number">9</span> &#125;);   <span class="comment">// é”™è¯¯</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f2</span><span class="params">(std::initializer_list&lt;T&gt; param)</span></span>;</span><br><span class="line"><span class="built_in">f2</span>(&#123; <span class="number">11</span>, <span class="number">23</span>, <span class="number">9</span> &#125;);   <span class="comment">// æ­£ç¡®ï¼ŒParamType ä¸º std::initializer_list&lt;int&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œ2014 å¹´ C++ æ ‡å‡†å§”å‘˜ä¼šé€šè¿‡äº† <a href="https://link.zhihu.com/?target=https%3A//www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n3922.html">N3922 ææ¡ˆ</a>ï¼Œä¿®æ”¹äº†<code>auto</code>å¯¹äºå¤§æ‹¬å·åˆå§‹åŒ–çš„ç±»å‹æ¨æ–­è§„åˆ™ã€‚ä¸Šé¢æ‰€æåŠçš„<code>auto x4&#123; 27 &#125;</code>è¿™è¡Œä»£ç ä¸­ï¼Œ<code>x4</code>æ¨å¯¼å‡ºçš„çš„ç±»å‹å·²ç»ä¸å†æ˜¯<code>std::initializer_list&lt;int&gt;</code>ï¼Œè€Œæ˜¯<code>int</code>ã€‚</p></blockquote><p>åœ¨ C++14 ä¸­ï¼Œå…è®¸ä½¿ç”¨<code>auto</code>æ¥è¯´æ˜å‡½æ•°è¿”å›å€¼éœ€è¦æ¨å¯¼ï¼Œè€Œä¸” lambda è¡¨è¾¾å¼ä¹Ÿä¼šåœ¨å½¢å‚å£°æ˜ä¸­ç”¨åˆ°<code>auto</code>ã€‚ç„¶è€Œè¿™äº›<code>auto</code>ç”¨æ³•ä½¿ç”¨çš„æ˜¯æ¨¡æ¿ç±»å‹æ¨å¯¼è€Œé<code>auto</code>ç±»å‹æ¨å¯¼ï¼Œå› æ­¤ä¹Ÿä¸èƒ½ä½¿ç”¨å¤§æ‹¬å·æ‹¬èµ·çš„åˆå§‹åŒ–è¡¨è¾¾å¼ã€‚</p><h3 id="æ¡æ¬¾-3ï¼šç†è§£-decltype">æ¡æ¬¾ 3ï¼šç†è§£ decltype</h3><hr><p>é‡ç‚¹ï¼šé¹¦é¹‰å­¦èˆŒ</p><p><strong>è¦ç‚¹</strong></p><ul><li>decltype å‡ ä¹æ€»æ˜¯è¿”å›å˜é‡æˆ–è¡¨è¾¾å¼çš„ç±»å‹ï¼Œè€Œä¸ä¼šè¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚</li><li><strong>å¯¹äºç±»å‹ä¸º T çš„å·¦å€¼è¡¨è¾¾å¼ï¼ˆä¸æ˜¯åç§°ï¼‰ï¼Œdecltype æ€»æ˜¯æŠ¥å‘Š T&amp;ç±»å‹ã€‚</strong></li><li>C++14 æ”¯æŒdecltype(auto)ï¼Œå®ƒåƒ auto ä¸€æ ·ä»åˆå§‹åŒ–è¡¨è¾¾å¼ä¸­æ¨æ–­ç±»å‹ï¼Œä½†ä½¿ç”¨çš„æ˜¯ decltype è§„åˆ™</li></ul><hr><p>ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ<code>decltype</code>ä¼šå¾—å‡ºå˜é‡æˆ–è¡¨è¾¾å¼çš„ç±»å‹è€Œä¸ä½œä»»ä½•ä¿®æ”¹ã€‚å¯¹äºç±»å‹ä¸º<code>T</code>çš„å·¦å€¼è¡¨è¾¾å¼ï¼Œé™¤éè¯¥è¡¨è¾¾å¼ä»…æœ‰ä¸€ä¸ªåå­—ï¼Œå¦åˆ™<code>decltype</code>æ€»æ˜¯å¾—å‡ºç±»å‹<code>T&amp;</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">decltype</span>(x);    <span class="comment">// æ¨å¯¼ç»“æœä¸º int</span></span><br><span class="line"><span class="keyword">decltype</span>((x));  <span class="comment">// æ¨å¯¼ç»“æœä¸º int&amp;</span></span><br></pre></td></tr></table></figure><p>åœ¨ C++11 ä¸­ï¼Œ<code>decltype</code>çš„ä¸»è¦ç”¨é€”æ˜¯å£°æ˜è¿”å›å€¼ç±»å‹ä¾èµ–äºå½¢å‚ç±»å‹çš„å‡½æ•°æ¨¡æ¿ï¼Œè¿™éœ€è¦ç”¨åˆ°<strong>è¿”å›å€¼ç±»å‹å°¾ç½®è¯­æ³•ï¼ˆtrailing return type syntaxï¼‰</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">authAndAccess</span><span class="params">(Container&amp; c, Index i)</span> -&gt; <span class="title">decltype</span><span class="params">(c[i])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">authenticateUser</span>();</span><br><span class="line">    <span class="keyword">return</span> c[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>C++11 å…è®¸å¯¹å•è¡¨è¾¾å¼çš„ lambda çš„è¿”å›å€¼å®æ–½ç±»å‹æ¨å¯¼ï¼Œè€Œ C++14 å°†è¿™ä¸ªå…è®¸èŒƒå›´æ‰©å¼ åˆ°äº†ä¸€åˆ‡å‡½æ•°å’Œä¸€åˆ‡ lambdaï¼ŒåŒ…æ‹¬é‚£äº›å¤šè¡¨è¾¾å¼çš„ã€‚è¿™å°±æ„å‘³ç€åœ¨ C++14 ä¸­å¯ä»¥å»æ‰è¿”å›å€¼ç±»å‹å°¾ç½®è¯­æ³•ï¼Œä»…ä¿ç•™å‰å¯¼<code>auto</code>ã€‚</p><p>ä½†ç¼–è¯‘å™¨ä¼šä¸º<code>auto</code>æŒ‡å®šä¸ºè¿”å›å€¼ç±»å‹çš„å‡½æ•°å®æ–½æ¨¡æ¿ç±»å‹æ¨å¯¼ï¼Œè¿™æ ·å°±ä¼šç•™ä¸‹éšæ‚£ï¼ˆä¾‹å¦‚å¿½ç•¥åˆå§‹åŒ–è¡¨è¾¾çš„å¼•ç”¨æ€§ï¼‰ï¼Œä½¿ç”¨<code>decltype(auto)</code>æ¥è¯´æ˜æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯<code>decltype</code>çš„è§„åˆ™ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">authAndAccess</span><span class="params">(Container&amp; c, Index i)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">authenticateUser</span>();</span><br><span class="line">    <span class="keyword">return</span> c[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆå§‹åŒ–è¡¨è¾¾å¼å¤„ä¹Ÿå¯ä»¥åº”ç”¨<code>decltype</code>ç±»å‹æ¨å¯¼è§„åˆ™ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Widget w;</span><br><span class="line"><span class="type">const</span> Widget&amp; cw = w;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> myWidget1 = cw;            <span class="comment">// auto æ¨å¯¼å‡ºç±»å‹ä¸º Widget</span></span><br><span class="line"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) myWidget2 = cw;  <span class="comment">// decltype æ¨å¯¼å‡ºç±»å‹ä¸º const Widget&amp;</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°æƒ…å½¢ä¸­ï¼Œæˆ‘ä»¬æ— æ³•å‘å‡½æ•°ä¼ é€’å³å€¼å®¹å™¨ï¼Œè‹¥æƒ³è¦é‡‡ç”¨ä¸€ç§æ—¢èƒ½ç»‘å®šåˆ°å·¦å€¼ä¹Ÿèƒ½ç»‘å®šåˆ°å³å€¼çš„å¼•ç”¨å½¢å‚ï¼Œå°±éœ€è¦å€ŸåŠ©ä¸‡èƒ½å¼•ç”¨ï¼Œå¹¶åº”ç”¨<code>std::forward</code>ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 25</strong>ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">authAndAccess</span><span class="params">(Container&amp;&amp; c, Index i)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">authenticateUser</span>();</span><br><span class="line">    <span class="keyword">return</span> std::forward&lt;Container&gt;(c)[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-4ï¼šæŒæ¡æŸ¥çœ‹ç±»å‹æ¨å¯¼ç»“æœçš„æ–¹æ³•">æ¡æ¬¾ 4ï¼šæŒæ¡æŸ¥çœ‹ç±»å‹æ¨å¯¼ç»“æœçš„æ–¹æ³•</h3><p><strong>1. IDE ç¼–è¾‘å™¨</strong></p><p><strong>2. ç¼–è¯‘å™¨è¯Šæ–­ä¿¡æ¯</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;    <span class="comment">// åªå£°æ˜ TD è€Œä¸å®šä¹‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TD</span>;               <span class="comment">// TD æ˜¯ â€œç±»å‹æ˜¾ç¤ºç±»â€ï¼ˆType Displayerï¼‰çš„ç¼©å†™</span></span><br><span class="line"></span><br><span class="line">TD&lt;<span class="keyword">decltype</span>(x)&gt; xType;  <span class="comment">// è¯±å‘åŒ…æ‹¬ x å’Œ y çš„ç±»å‹çš„é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">TD&lt;<span class="keyword">decltype</span>(y)&gt; yType;</span><br></pre></td></tr></table></figure><p><strong>3. è¿è¡Œæ—¶è¾“å‡º</strong></p><p>é’ˆå¯¹æŸä¸ªå¯¹è±¡è°ƒç”¨<code>typeid</code>ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ª<code>std::type_info</code>å¯¹è±¡ï¼Œå…¶æ‹¥æœ‰ä¸€ä¸ªæˆå‘˜å‡½æ•°<code>name</code>ï¼Œè¯¥å‡½æ•°äº§ç”Ÿä¸€ä¸ªä»£è¡¨ç±»å‹çš„ C-style çš„å­—ç¬¦ä¸²ã€‚</p><p>ä½†é—æ†¾çš„æ˜¯ï¼Œä¸åŒç¼–è¯‘å™¨å¯¹äº<code>std::type_info::name</code>çš„å®ç°å„ä¸ç›¸åŒï¼Œæ— æ³•ä¿è¯å®Œå…¨å¯é ã€‚å¹¶ä¸”æŒ‰ç…§æ ‡å‡†ï¼Œ<code>std::type_info::name</code>ä¸­å¤„ç†ç±»å‹çš„æ–¹å¼å’Œå‘å‡½æ•°æ¨¡æ¿æŒ‰å€¼ä¼ å‚ä¸€æ ·ï¼Œå› æ­¤ç±»å‹çš„å¼•ç”¨æ€§ä»¥åŠ<code>const</code>å’Œ<code>volatile</code>é™å®šç¬¦ä¹Ÿå°†è¢«å¿½ç•¥ã€‚</p><p>åŸä¹¦ä¸­ä»‹ç»äº† Boost.TypeIndex ç¬¬ä¸‰æ–¹åº“ç”¨äºä»£æ›¿<code>typeid</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/type_index.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">const</span> T&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> std::cout;</span><br><span class="line">    <span class="keyword">using</span> boost::typeindex::type_id_with_cvr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¾ç¤º T çš„ç±»å‹</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;T =          &quot;</span></span><br><span class="line">         &lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;T&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">         &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¾ç¤º param çš„ç±»å‹</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;param =          &quot;</span></span><br><span class="line">         &lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(param)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">         &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç¬¬äºŒç« ï¼šauto">ç¬¬äºŒç« ï¼šauto</h2><h3 id="æ¡æ¬¾-5ï¼šä¼˜å…ˆé€‰ç”¨-autoï¼Œè€Œéæ˜¾å¼ç±»å‹å£°æ˜">æ¡æ¬¾ 5ï¼šä¼˜å…ˆé€‰ç”¨ autoï¼Œè€Œéæ˜¾å¼ç±»å‹å£°æ˜</h3><hr><p>é€Ÿè®°ï¼š</p><p>autoå¥½å¤„ï¼š</p><ul><li>autoå¿…é¡»åˆå§‹åŒ–</li><li>ç®€åŒ–ä»£ç </li><li>std::function æ–¹æ³•é€šå¸¸ä½“ç§¯æ¯” auto å¤§ï¼Œå¹¶ä¸”æ…¢ï¼Œè¿˜æœ‰å¯èƒ½å¯¼è‡´å†…å­˜ä¸è¶³çš„å¼‚å¸¸</li><li>åœ¨32ä½ Windows ç³»ç»Ÿä¸Šï¼Œ unsigned å’Œ size_type æœ‰åŒæ ·çš„å¤§å°ï¼Œä½†æ˜¯åœ¨64ä½çš„ Windows ä¸Šï¼Œ unsigned æ˜¯32bitçš„ï¼Œè€Œ size_type æ˜¯64bitçš„ã€‚</li><li>é¿å…error</li></ul><p>é—®é¢˜ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="type">int</span>&gt; m;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="type">int</span>&gt;&amp; p : m)&#123;</span><br><span class="line">Â  Â  ... <span class="comment">// ä½¿ç”¨p</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¹å™¨çš„å…ƒç´ ç±»å‹åº”è¯¥æ˜¯ï¼šstd::pair&lt;const std::sting, int&gt;</p><p>æ­£ç¡®å†™æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; p : m)&#123;</span><br><span class="line">Â  Â  ... <span class="comment">// å’Œä»¥å‰ä¸€æ ·</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><code>auto</code>å˜é‡è¦æ±‚å¿…é¡»åˆå§‹åŒ–ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥é¿å…ä¼šå¯¼è‡´å…¼å®¹æ€§å’Œæ•ˆç‡é—®é¢˜çš„ç±»å‹ä¸åŒ¹é…ç°è±¡ï¼Œè¿˜å¯ä»¥ç®€åŒ–é‡æ„æµç¨‹ï¼Œé€šå¸¸ä¹Ÿæ¯”æ˜¾å¼æŒ‡å®šç±»å‹è¦å°‘æ‰“ä¸€äº›å­—ï¼Œä½†åœ¨ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„<strong>æ¡æ¬¾ 2</strong> å’Œ<strong>æ¡æ¬¾ 6</strong> ä¸­æåˆ°çš„é—®é¢˜ã€‚</p><p>ä½¿ç”¨<code>auto</code>å’Œ<code>std::function</code>éƒ½å¯ä»¥å­˜å‚¨é—­åŒ…ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C++14 å…è®¸åœ¨ lambda è¡¨è¾¾å¼çš„å½¢å‚ä¸­ä½¿ç”¨ auto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> derefLess = [](<span class="type">const</span> <span class="keyword">auto</span>&amp; p1, <span class="type">const</span> <span class="keyword">auto</span>&amp; p2)</span><br><span class="line">                  &#123; <span class="keyword">return</span> *p1 &lt; *p2; &#125;;</span><br><span class="line"></span><br><span class="line">std::function&lt;<span class="type">bool</span>(<span class="type">const</span> std::unique_ptr&lt;Widget&gt;&amp;,</span><br><span class="line">                   <span class="type">const</span> std::unique_ptr&lt;Widget&gt;&amp;)&gt;</span><br><span class="line">    derefUPLess = [](<span class="type">const</span> std::unique_ptr&lt;Widget&gt;&amp; p1,</span><br><span class="line">                     <span class="type">const</span> std::unique_ptr&lt;Widget&gt;&amp; p2)</span><br><span class="line">                   &#123; <span class="keyword">return</span> *p1 &lt; *p2; &#125;;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>auto</code>å£°æ˜çš„ã€å­˜å‚¨ç€ä¸€ä¸ªé—­åŒ…çš„å˜é‡å’Œè¯¥é—­åŒ…æ˜¯åŒä¸€ç±»å‹ï¼Œä»è€Œå®ƒè¦æ±‚çš„å†…å­˜é‡ä¹Ÿå’Œè¯¥é—­åŒ…ç›¸åŒï¼›è€Œä½¿ç”¨<code>std::function</code>å£°æ˜çš„ã€å­˜å‚¨ç€ä¸€ä¸ªé—­åŒ…çš„å˜é‡æ˜¯<code>std::function</code>çš„ä¸€ä¸ªå®ä¾‹ï¼Œä¸ç®¡ç»™å®šçš„ç­¾åå¦‚ä½•ï¼Œå®ƒéƒ½å æœ‰å›ºå®šå¤§å°çš„å†…å­˜ï¼Œè€Œè¿™ä¸ªå¤§å°å¯¹äºå…¶å­˜å‚¨çš„é—­åŒ…è€Œè¨€å¹¶ä¸ä¸€å®šå¤Ÿç”¨ï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆ<code>std::function</code>çš„æ„é€ å‡½æ•°å°±ä¼šåˆ†é…å †ä¸Šçš„å†…å­˜æ¥å­˜å‚¨è¯¥é—­åŒ…ã€‚å†æœ‰ï¼Œç¼–è¯‘å™¨çš„ç»†èŠ‚ä¸€èˆ¬éƒ½ä¼šé™åˆ¶å†…è”ï¼Œå¹¶ä¼šäº§ç”Ÿé—´æ¥å‡½æ•°è°ƒç”¨ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>std::function</code>é€šå¸¸æ¯”èµ·<code>auto</code>æ›´å¤§æ›´æ…¢ï¼Œè¿˜å¯èƒ½å¯¼è‡´å†…å­˜æ¶ˆè€—å¼‚å¸¸ï¼Œå› æ­¤å®é™…ä½¿ç”¨æ—¶æ›´æ¨è<code>auto</code>ã€‚</p><p>è€ƒè™‘ä»¥ä¸‹ä»£ç çš„éšæ‚£ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">std::unordered_map&lt;std::string, <span class="type">int</span>&gt; m;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> std::pair&lt;std::string, <span class="type">int</span>&gt;&amp; p : m) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>std::unordered_map</code>çš„é”®å€¼éƒ¨åˆ†æ˜¯ const çš„ï¼Œæ‰€ä»¥å“ˆå¸Œè¡¨ä¸­çš„<code>std::pair</code>ç±»å‹åº”ä¸º<code>std::pair&lt;const std::string, int&gt;</code>è€Œé<code>std::pair&lt;std::string, int&gt;</code>ï¼Œç±»å‹çš„ä¸åŒ¹é…ä¼šå¯¼è‡´é¢å¤–çš„ä¸´æ—¶å¯¹è±¡è¢«å¤åˆ¶å‡ºæ¥ï¼Œé™ä½äº†è¿è¡Œæ•ˆç‡ã€‚</p><p>ä½¿ç”¨<code>auto</code>å°±å¯ä»¥è½»æ¾é¿å…è¿™ç§é—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; p : m) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-6ï¼šå½“-auto-æ¨å¯¼çš„ç±»å‹ä¸ç¬¦åˆè¦æ±‚æ—¶ï¼Œä½¿ç”¨æ˜¾å¼ç±»å‹åˆå§‹åŒ–æƒ¯ç”¨æ³•">æ¡æ¬¾ 6ï¼šå½“ auto æ¨å¯¼çš„ç±»å‹ä¸ç¬¦åˆè¦æ±‚æ—¶ï¼Œä½¿ç”¨æ˜¾å¼ç±»å‹åˆå§‹åŒ–æƒ¯ç”¨æ³•</h3><hr><p>autoåå¤„ï¼š</p><p>å½“autoæ¨å¯¼çš„ç±»å‹ä¸ç¬¦åˆè¦æ±‚æ—¶ï¼Œä½¿ç”¨æ˜¾å¼ç±»å‹åˆå§‹åŒ–è¯­æ³•</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt; <span class="title function_">features</span><span class="params">(<span class="type">const</span> Widget&amp; w)</span>;</span><br><span class="line">Widget w;</span><br><span class="line">â€¦</span><br><span class="line"><span class="type">bool</span> highPriority = features(w)[<span class="number">5</span>]; <span class="comment">// å‡è®¾å®¹å™¨çš„ç¬¬5ä½ï¼ˆbitï¼‰è¡¨ç¤º Widget æ˜¯å¦å…·æœ‰é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">processWidget(w, highPriority); <span class="comment">// èƒ½æ­£å¸¸å·¥ä½œï¼Œæ ¹æ®ä¼˜å…ˆçº§è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="keyword">auto</span> highPriority = features(w)[<span class="number">5</span>];<span class="comment">// è¿”å›ç±»å‹ä¸º std::vector&lt;bool&gt;::referenceprocessWidget(w, highPriority); // æœªå®šä¹‰çš„è¡Œä¸º!</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>std::vector::operator[] é€šå¸¸è¿”å›å…ƒç´ çš„å¼•ç”¨ï¼Œboolå…ƒç´ ç±»å‹é™¤å¤–</strong></p><ul><li>std::vector&lt; bool&gt; è¢«æŒ‡å®šæ¯ä¸ª bool å€¼å ä¸€ä¸ªä½</li><li>std::vector&lt; T&gt; çš„ operator[] åº”è¯¥è¿”å›ä¸€ä¸ª T&amp;ï¼Œä½† C++ ç¦æ­¢å¯¹ä½çš„å¼•ç”¨</li><li>std::vector&lt; bool&gt;::referenceç”¨äºä½¿å…¶ç”¨èµ·æ¥åƒæ˜¯bool&amp;ï¼Œå¯ä»¥è¿›è¡Œèµ‹å€¼ã€æ¯”è¾ƒã€æ¡ä»¶ç­‰</li><li>ä¸ºäº†è®©ä¸Šè¿°çš„è®¾è®¡èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œstd::vector<bool>::reference è¿›è¡Œäº†ä¸€ç§éšå¼çš„è½¬æ¢ï¼Œå°†å…¶è½¬æ¢ä¸º bool ç±»å‹</li><li>std::vector&lt; bool&gt;::reference çš„ä¸€ç§å¯èƒ½å®ç°æ–¹å¼æ˜¯ï¼šåŒ…å«ä¸€ä¸ªæŒ‡é’ˆï¼ˆæŒ‡å‘ä¸€ä¸ªåŒ…å«ç»“æœå€¼çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼‰ï¼Œå’Œåç§»é‡ï¼ˆç»“æœå€¼åœ¨æ•°æ®ç»“æ„ä¸­çš„ä½ç½®ï¼‰</li></ul><p>æ€»ç»“ï¼šautoæ¨å¯¼æ²¡é”™ï¼Œåªéœ€è¦æ˜¾ç¤ºå£°æ˜orç±»å‹è½¬åŒ–</p><hr><p>â€œéšå½¢â€ çš„ä»£ç†ç±»å‹å¯ä»¥å¯¼è‡´<code>auto</code>æ ¹æ®åˆå§‹åŒ–è¡¨è¾¾å¼æ¨å¯¼å‡º â€œé”™è¯¯çš„â€ ç±»å‹ï¼Œåº”è¯¥é˜²æ­¢å†™å‡ºè¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> someVar = <span class="string">&quot; éšå½¢ &quot;</span> ä»£ç†ç±»å‹è¡¨è¾¾å¼;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªéšå½¢ä»£ç†ç±»çš„å…¸å‹ä¾‹å­æ˜¯<code>std::vector&lt;bool&gt;</code>ï¼Œå®ƒç»è¿‡äº†ç‰¹åŒ–ï¼Œä¸ä¸€èˆ¬çš„<code>std::vector</code>çš„è¡Œä¸ºä¸åŒï¼Œå’Œ<code>std::bitset</code>çš„è¡Œä¸ºç›¸ä¼¼ï¼Œä½¿ç”¨ä¸€ç§å‹ç¼©å½¢å¼è¡¨ç¤ºå…¶æŒæœ‰çš„<code>bool</code>å…ƒç´ ï¼Œæ¯ä¸ª<code>bool</code>å…ƒç´ ç”¨ä¸€ä¸ªæ¯”ç‰¹æ¥è¡¨ç¤ºã€‚å› æ­¤ï¼Œ<code>std::vector&lt;bool&gt;</code>çš„<code>operator[]</code>å¹¶ä¸ä¼šç›´æ¥è¿”å›ä¸€ä¸ª<code>bool&amp;</code>ï¼Œè€Œæ˜¯ä¼šè¿”å›ä¸€ä¸ªå…·æœ‰ç±»ä¼¼è¡Œä¸ºçš„<code>std::vector&lt;bool&gt;::reference</code>ç±»å‹çš„å¯¹è±¡ï¼Œå¹¶å¯ä»¥éšå¼è½¬æ¢ä¸º<code>bool</code>ç±»å‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::vector&lt;<span class="type">bool</span>&gt; <span class="title">features</span><span class="params">(<span class="type">const</span> Widget&amp; w)</span></span>;</span><br><span class="line">Widget w;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> highPriority1 = <span class="built_in">features</span>(w)[<span class="number">5</span>];    <span class="comment">// å¾—åˆ°æ­£ç¡®çš„ bool å˜é‡</span></span><br><span class="line"><span class="keyword">auto</span> highPriority2 = <span class="built_in">features</span>(w)[<span class="number">5</span>];    <span class="comment">// é”™è¯¯åœ°å¾—åˆ°äº† std::vector&lt;bool&gt;::reference å¯¹è±¡</span></span><br></pre></td></tr></table></figure><p>é™¤äº†<code>std::vector&lt;bool&gt;</code>ä»¥å¤–ï¼Œæ ‡å‡†åº“ä¸­çš„æ™ºèƒ½æŒ‡é’ˆå’Œå¦å¤–ä¸€äº› C++ åº“ä¸­çš„ç±»ä¹Ÿä½¿ç”¨äº†ä»£ç†ç±»çš„è®¾è®¡æ¨¡å¼ï¼Œä¾‹å¦‚ä¸ºäº†æé«˜æ•°å€¼è®¡ç®—ä»£ç æ•ˆç‡çš„<strong>è¡¨è¾¾å¼æ¨¡æ¿</strong>æŠ€æœ¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Matrix sum = m1 + m2 + m3 + m4; <span class="comment">// é€šè¿‡ä½¿ operator+ è¿”å›ç»“æœçš„ä»£ç†æ¥æé«˜æ•ˆç‡</span></span><br></pre></td></tr></table></figure><blockquote><p>åœ¨å®é™…ç¼–å†™ä»£ç æ—¶ï¼Œè®°å¾—é€šè¿‡æŸ¥çœ‹æ–‡æ¡£æˆ–å¤´æ–‡ä»¶ä¸­çš„å‡½æ•°åŸå‹æ¥ç¡®è®¤æ‰‹å¤´ä¸Šçš„ç±»æ˜¯å¦ä¸ºä»£ç†ç±»ã€‚</p></blockquote><p>è§£å†³ä»£ç†ç±»é—®é¢˜çš„åšæ³•æ˜¯ï¼šä½¿ç”¨å¸¦æ˜¾å¼ç±»å‹çš„åˆå§‹å€¼è®¾å®šé¡¹æ¥å¼ºåˆ¶<code>auto</code>æ¨å¯¼å‡ºä½ æƒ³è¦çš„ç±»å‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> highPriority = <span class="built_in">static_cast</span>&lt;<span class="type">bool</span>&gt;(<span class="built_in">features</span>(w)[<span class="number">5</span>]);</span><br></pre></td></tr></table></figure><p>è¿™ç§ç”¨æ³•å¹¶ä¸ä»…é™äºä¼šäº§ç”Ÿä»£ç†ç±»å‹çš„åˆå§‹å€¼è®¾å®šé¡¹ï¼Œå®ƒåŒæ ·å¯ä»¥åº”ç”¨äºä½ æƒ³è¦å¼ºè°ƒåˆ›å»ºä¸€ä¸ªç±»å‹ä¸åŒäºåˆå§‹åŒ–è¡¨è¾¾å¼ç±»å‹çš„åœºåˆï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">double</span> <span class="title">calcEpsilon</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> ep1 = <span class="built_in">calcEpsilon</span>();                      <span class="comment">// è¿›è¡Œä» double åˆ° float çš„éšå¼ç±»å‹è½¬æ¢</span></span><br><span class="line"><span class="keyword">auto</span> ep2 = <span class="built_in">static_cast</span>&lt;<span class="type">float</span>&gt;(<span class="built_in">calcEpsilon</span>());   <span class="comment">// å¼ºè°ƒäº†ç±»å‹è½¬æ¢çš„å­˜åœ¨</span></span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸‰ç« ï¼šè½¬å‘ç°ä»£-C">ç¬¬ä¸‰ç« ï¼šè½¬å‘ç°ä»£ C++</h2><h3 id="æ¡æ¬¾-7ï¼šåœ¨åˆ›å»ºå¯¹è±¡æ—¶æ³¨æ„åŒºåˆ†-å’Œ">æ¡æ¬¾ 7ï¼šåœ¨åˆ›å»ºå¯¹è±¡æ—¶æ³¨æ„åŒºåˆ† () å’Œ {}</h3><hr><p>é‡ç‚¹ï¼šï¼š</p><p>å†…ç½®ç±»å‹</p><p>å¯ä»¥ä½¿ç”¨ï¼ˆï¼‰ã€= æˆ– { } æ¥æŒ‡å®šåˆå§‹åŒ–å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">x</span><span class="params">(<span class="number">0</span>)</span>; </span><br><span class="line"><span class="type">int</span> y = <span class="number">0</span>; </span><br><span class="line"><span class="type">int</span> z&#123; <span class="number">0</span> &#125;; </span><br><span class="line"><span class="type">int</span> z = &#123; <span class="number">0</span> &#125;; <span class="comment">// ç­‰ä»·äº int z&#123; 0 &#125;; </span></span><br></pre></td></tr></table></figure><p>ç”¨æˆ·å®šä¹‰ç±»å‹</p><ul><li>å¯¹éé™æ€æ•°æ®æˆå‘˜è¿›è¡Œåˆå§‹åŒ–<ul><li>å¯ä»¥ä½¿ç”¨{ }, = å¯¹éé™æ€æ•°æ®æˆå‘˜è¿›è¡Œåˆå§‹åŒ–ï¼Œä½†( ) ä¸è¡Œ</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Widget</span> &#123;</span></span><br><span class="line">Â  Â  â€¦</span><br><span class="line">Â  Â  private:</span><br><span class="line">Â  Â  <span class="type">int</span> x&#123; <span class="number">0</span> &#125;; <span class="comment">// æ­£ç¡®, xçš„é»˜è®¤å€¼ä¸º0</span></span><br><span class="line">Â  Â  <span class="type">int</span> y = <span class="number">0</span>; <span class="comment">// åŒæ ·æ­£ç¡®</span></span><br><span class="line">Â  Â  <span class="type">int</span> <span class="title function_">z</span><span class="params">(<span class="number">0</span>)</span>; <span class="comment">// é”™è¯¯!</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><p>ä¸å¯å¤åˆ¶çš„å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œstd::atomicsï¼‰</p><ul><li>ä¸å¯å¤åˆ¶çš„å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œstd::atomicsï¼‰å¯ä»¥ä½¿ç”¨{ }æˆ–ï¼ˆï¼‰è¿›è¡Œåˆå§‹åŒ–ï¼Œä½†ä¸èƒ½ä½¿ç”¨ =</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="type">int</span>&gt; ai1&#123; <span class="number">0</span> &#125;; <span class="comment">// æ­£ç¡®</span></span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="type">int</span>&gt; <span class="title function_">ai2</span><span class="params">(<span class="number">0</span>)</span>; <span class="comment">// æ­£ç¡®</span></span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="type">int</span>&gt; ai3 = <span class="number">0</span>; <span class="comment">// é”™è¯¯!</span></span><br></pre></td></tr></table></figure></li><li><p>{ }åˆå§‹åŒ–ç¦æ­¢å†…ç½®ç±»å‹ä¹‹é—´çš„éšå¼çª„åŒ–è½¬æ¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> x, y, z;</span><br><span class="line">â€¦</span><br><span class="line"><span class="type">int</span> sum1&#123; x + y + z &#125;; <span class="comment">// é”™è¯¯! åŒç²¾åº¦æ•°çš„å’Œå¯èƒ½æ— æ³•è¡¨ç¤ºä¸ºæ•´æ•°int sum2(x + y + z); // å¯ä»¥ (è¡¨è¾¾å¼çš„å€¼è¢«æˆªæ–­ä¸ºæ•´æ•°)</span></span><br><span class="line"><span class="type">int</span> sum3 = x + y + z; <span class="comment">// åŒä¸Š</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>{ } åˆå§‹åŒ–ä¸å— C++ä¸­ä»¤äººçƒ¦æ¼çš„è§£æé—®é¢˜ï¼ˆä»»ä½•å¯ä»¥è¢«è§£æä¸ºå£°æ˜çš„ä¸œè¥¿éƒ½å¿…é¡»è¢«è§£é‡Šä¸ºå£°æ˜ï¼‰çš„å½±å“</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Widget <span class="title function_">w1</span><span class="params">(<span class="number">10</span>)</span>; <span class="comment">// è°ƒç”¨ Widget ç±»çš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¼ å…¥å‚æ•°10</span></span><br><span class="line">Widget <span class="title function_">w2</span><span class="params">()</span>; <span class="comment">// ä»¤äººçƒ¦æ¼çš„è§£æï¼å£°æ˜äº†åä¸º w2 çš„å‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ª Widgetï¼</span></span><br><span class="line">Widget w3&#123;&#125;; <span class="comment">// æ— å‚æ•°ï¼Œè°ƒç”¨æ„é€ å‡½æ•°</span></span><br></pre></td></tr></table></figure><blockquote><p>æ„é€ å‡½æ•°å£°æ˜ç±»å‹ä¸ºstd::initializer_listçš„å‚æ•°</p></blockquote><p><strong>å¦‚æœå­˜åœ¨æ„é€ å‡½æ•°å£°æ˜äº†ç±»å‹ä¸º std::initializer_list çš„å‚æ•°ï¼Œé‚£ä¹ˆä½¿ç”¨{ }åˆå§‹åŒ–è¯­æ³•çš„è°ƒç”¨å¼ºçƒˆå€¾å‘äºé‡‡ç”¨æ¥å— std::initializer_list çš„é‡è½½ã€‚éå¸¸å¼ºçƒˆï¼ï¼ï¼</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Widget</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">Â  Â  Widget(<span class="type">int</span> i, <span class="type">bool</span> b); <span class="comment">// å’Œä»¥å‰ä¸€æ ·</span></span><br><span class="line">Â  Â  Widget(<span class="type">int</span> i, <span class="type">double</span> d); <span class="comment">// å’Œä»¥å‰ä¸€æ ·</span></span><br><span class="line">Â  Â  Widget(<span class="built_in">std</span>::<span class="built_in">initializer_list</span>&lt;<span class="type">long</span> <span class="type">double</span>&gt; il); <span class="comment">// æ–°åŠ å…¥</span></span><br><span class="line">Â  Â  â€¦</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Widget <span class="title function_">w1</span><span class="params">(<span class="number">10</span>, <span class="literal">true</span>)</span>; <span class="comment">// è°ƒç”¨ç¬¬ä¸€ä¸ªctor</span></span><br><span class="line">Widget w2&#123;<span class="number">10</span>, <span class="literal">true</span>&#125;; <span class="comment">// è°ƒç”¨initializer_list ctor(10å’Œtrueè½¬æ¢ä¸ºlong double)</span></span><br><span class="line">Widget <span class="title function_">w3</span><span class="params">(<span class="number">10</span>, <span class="number">5.0</span>)</span>; <span class="comment">// è°ƒç”¨ç¬¬äºŒä¸ªctor</span></span><br><span class="line">Widget w4&#123;<span class="number">10</span>, <span class="number">5.0</span>&#125;; <span class="comment">// è°ƒç”¨initializer_list ctor(10å’Œ5.0è½¬æ¢ä¸ºlong double)</span></span><br></pre></td></tr></table></figure><p>æŠ¥é”™æƒ…å†µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Widget</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">Â  Â  Widget(<span class="type">int</span> i, <span class="type">bool</span> b); <span class="comment">// å’Œä»¥å‰ä¸€æ ·</span></span><br><span class="line">Â  Â  Widget(<span class="type">int</span> i, <span class="type">double</span> d); <span class="comment">// å’Œä»¥å‰ä¸€æ ·</span></span><br><span class="line">    <span class="comment">//å…ƒç´ ç±»å‹ç°åœ¨ä¸ºbool</span></span><br><span class="line">Â  Â  Widget(<span class="built_in">std</span>::<span class="built_in">initializer_list</span>&lt;<span class="type">bool</span>&gt; il); </span><br><span class="line">&#125;; </span><br><span class="line">Widget w&#123;<span class="number">10</span>, <span class="number">5.0</span>&#125;; <span class="comment">// é”™è¯¯! éœ€è¦çª„åŒ–è½¬æ¢</span></span><br></pre></td></tr></table></figure><p>Widgetæƒ³è½¬æ¢ï¼Œä½†æ˜¯{}ä¸èƒ½æ”¯æŒçª„è½¬æ¢~</p><hr><p>ä¸ºäº†ç€æ‰‹è§£é™¤ä¼—å¤šçš„åˆå§‹åŒ–è¯­æ³•å¸¦æ¥çš„å›°æƒ‘ï¼Œä¹Ÿä¸ºäº†è§£å†³è¿™äº›è¯­æ³•ä¸èƒ½è¦†ç›–æ‰€æœ‰åˆå§‹åŒ–åœºæ™¯çš„é—®é¢˜ï¼ŒC++11 å¼•å…¥äº†ç»Ÿä¸€åˆå§‹åŒ–ï¼Œä»¥<strong>å¤§æ‹¬å·åˆå§‹åŒ–ï¼ˆbraced initializeï¼‰</strong> çš„å½¢å¼å­˜åœ¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‹é¢ä¸¤ç§å†™æ³•ç­‰ä»·</span></span><br><span class="line"><span class="type">int</span> x&#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">int</span> y = &#123; <span class="number">0</span> &#125;;</span><br></pre></td></tr></table></figure><p>å¤§æ‹¬å·å¯ä»¥ç”¨äºæŒ‡å®šå®¹å™¨çš„åˆå§‹å†…å®¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="type">int</span>&gt; v&#123; <span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span> &#125;;</span><br></pre></td></tr></table></figure><p>å¤§æ‹¬å·å’Œç­‰å·å¯ä»¥ç”¨äºä¸ºéé™æ€æˆå‘˜æŒ‡å®šé»˜è®¤åˆå§‹åŒ–å€¼ï¼Œè€Œå°æ‹¬å·ä¸è¡Œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> x&#123; <span class="number">0</span> &#125;; <span class="comment">// å¯è¡Œ</span></span><br><span class="line">    <span class="type">int</span> y = <span class="number">0</span>;  <span class="comment">// å¯è¡Œ</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">z</span><span class="params">(<span class="number">0</span>)</span></span>;   <span class="comment">// ä¸å¯è¡Œï¼</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸å¯å¤åˆ¶çš„å¯¹è±¡å¯ä»¥é‡‡ç”¨å¤§æ‹¬å·å’Œå°æ‹¬å·è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œä¸èƒ½ä½¿ç”¨ç­‰å·ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">int</span>&gt; ai1&#123; <span class="number">0</span> &#125;;  <span class="comment">// å¯è¡Œ</span></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">ai2</span><span class="params">(<span class="number">0</span>)</span></span>;    <span class="comment">// å¯è¡Œ</span></span><br><span class="line">std::atomic&lt;<span class="type">int</span>&gt; ai3 = <span class="number">0</span>;   <span class="comment">// ä¸å¯è¡Œï¼</span></span><br></pre></td></tr></table></figure><p>å¤§æ‹¬å·åˆå§‹åŒ–ç¦æ­¢å†…å»ºç±»å‹ä¹‹é—´è¿›è¡Œ<strong>éšå¼çª„åŒ–ç±»å‹è½¬æ¢ï¼ˆnarrowing conversionï¼‰</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> x, y, z;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sum1&#123; x + y + z &#125;;  <span class="comment">// é”™è¯¯ï¼double ä¹‹å’Œå¯èƒ½æ— æ³•ç”¨ int è¡¨è¾¾</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sum2</span><span class="params">(x + y + z)</span></span>;    <span class="comment">// æ­£ç¡®ï¼Œè¡¨è¾¾å¼çš„å€¼è¢«æˆªæ–­ä¸º int</span></span><br><span class="line"><span class="type">int</span> sum3 = x + y + z;   <span class="comment">// åŒä¸Š</span></span><br></pre></td></tr></table></figure><p>å¤§æ‹¬å·åˆå§‹åŒ–å¯ä»¥é¿å…<strong>æœ€ä»¤äººçƒ¦æ¼çš„è§£æè¯­æ³•ï¼ˆmost vexing parseï¼‰</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Widget <span class="title">w1</span><span class="params">(<span class="number">10</span>)</span></span>;  <span class="comment">// è°ƒç”¨ Widget æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="function">Widget <span class="title">w2</span><span class="params">()</span></span>;    <span class="comment">// å£°æ˜äº†ä¸€ä¸ªåä¸º w2ï¼Œè¿”å›å€¼ä¸º Widget å¯¹è±¡çš„å‡½æ•°</span></span><br><span class="line">Widget w3&#123;&#125;;    <span class="comment">// è°ƒç”¨æ²¡æœ‰å½¢å‚çš„ Widget æ„é€ å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>å¤§æ‹¬å·åˆå§‹åŒ–ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯<strong>æ¡æ¬¾ 2</strong> ä¸­æåˆ°çš„ auto æ¨å¯¼é—®é¢˜ï¼Œå¦ä¸€ä¸ªåˆ™äº§ç”Ÿäºå¯¹å¸¦æœ‰<code>std::initializer_list</code>ç±»å‹å½¢å‚çš„é‡è½½ç‰ˆæœ¬çš„å¼ºçƒˆåå‘æ€§ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Widget</span>(<span class="type">int</span> i, <span class="type">bool</span> b);</span><br><span class="line">    <span class="built_in">Widget</span>(<span class="type">int</span> i, <span class="type">double</span> d);</span><br><span class="line">    <span class="built_in">Widget</span>(std::initializer_list&lt;<span class="type">int</span>&gt; f);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">Widget <span class="title">w1</span><span class="params">(<span class="number">10</span>, <span class="literal">true</span>)</span></span>;        <span class="comment">// è°ƒç”¨ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°</span></span><br><span class="line">Widget w2&#123; <span class="number">10</span>, <span class="literal">true</span> &#125;;      <span class="comment">// è°ƒç”¨å¸¦æœ‰ std::initializer_list å½¢å‚çš„æ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function">Widget <span class="title">w3</span><span class="params">(<span class="number">10</span>, <span class="number">5.0</span>)</span></span>;         <span class="comment">// è°ƒç”¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•°</span></span><br><span class="line">Widget w4&#123; <span class="number">10</span>, <span class="number">5.0</span> &#125;;       <span class="comment">// é”™è¯¯ï¼ç¦æ­¢çª„åŒ–ç±»å‹è½¬æ¢</span></span><br><span class="line"></span><br><span class="line"><span class="function">Widget <span class="title">w5</span><span class="params">(w4)</span></span>;              <span class="comment">// è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">Widget w6&#123; w4 &#125;;            <span class="comment">// å°† w4 å¼ºåˆ¶è½¬æ¢ä¸º int åï¼Œè°ƒç”¨å¸¦æœ‰ std::initializer_list å½¢å‚çš„æ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function">Widget <span class="title">w7</span><span class="params">(std::move(w4))</span></span>;   <span class="comment">// è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°</span></span><br><span class="line">Widget w8&#123; std::<span class="built_in">move</span>(w4) &#125;; <span class="comment">// æƒ…å†µå’Œ w6 ç›¸åŒ</span></span><br></pre></td></tr></table></figure><p>åªæœ‰åœ¨æ‰¾ä¸åˆ°ä»»ä½•åŠæ³•æŠŠå¤§æ‹¬å·åˆå§‹å€¼è®¾å®šé¡¹ä¸­çš„å®å‚è½¬æ¢ä¸º<code>std::initializer_list</code>æ¨¡æ¿ä¸­çš„ç±»å‹æ—¶ï¼Œç¼–è¯‘å™¨æ‰ä¼šé€€è€Œæ£€æŸ¥æ™®é€šçš„é‡è½½å†³è®®ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸€å¯¹ç©ºå¤§æ‹¬å·ä»£è¡¨çš„æ„ä¹‰æ˜¯ â€œæ²¡æœ‰å®å‚â€ï¼Œè€Œé â€œç©ºçš„<code>std::initializer_list</code>â€ï¼Œåè€…å¯ä»¥ç”¨å¥—å¨ƒçš„æ‹¬å·æ¥è¡¨ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Widget w1;      <span class="comment">// è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line">Widget w2&#123;&#125;;    <span class="comment">// ä»ç„¶è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="function">Widget <span class="title">w3</span><span class="params">()</span></span>;    <span class="comment">// å˜æˆäº†å‡½æ•°å£°æ˜è¯­å¥</span></span><br><span class="line"><span class="function">Widget <span class="title">w4</span><span class="params">(&#123;&#125;)</span></span>;  <span class="comment">// è°ƒç”¨å¸¦æœ‰ std::initializer_list å½¢å‚çš„æ„é€ å‡½æ•°</span></span><br><span class="line">                <span class="comment">// å¹¶ä¼ å…¥ç©ºçš„ std::initializer_list</span></span><br><span class="line">Widget w5&#123;&#123;&#125;&#125;;  <span class="comment">// åŒä¸Š</span></span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨æ¨¡æ¿è¿›è¡Œå¯¹è±¡åˆ›å»ºæ—¶ï¼Œåˆ°åº•è¯¥ä½¿ç”¨å°æ‹¬å·è¿˜æ˜¯å¤§æ‹¬å·ä¼šæˆä¸ºä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœä½ æƒ³ä»¥ä»»æ„æ•°é‡çš„å®å‚æ¥åˆ›å»ºä¸€ä¸ªä»»æ„ç±»å‹çš„å¯¹è±¡ï¼Œé‚£ä¹ˆï¼Œä¸€ä¸ªå¯å˜å‚æ•°æ¨¡æ¿å°†ä¼šæ˜¯ä¸é”™çš„é€‰æ‹©ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doSomeWork</span><span class="params">(Ts&amp;&amp;... params)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ©ç”¨ params åˆ›å»º T ç±»å‹çš„å±€éƒ¨å¯¹è±¡</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">doSomeWork&lt;std::vector&lt;<span class="type">int</span>&gt;&gt;(<span class="number">10</span>, <span class="number">20</span>);</span><br></pre></td></tr></table></figure><p>ç„¶è€Œæ­¤æ—¶ï¼Œåœ¨æ¨¡æ¿å†…éƒ¨åˆ›å»ºå±€éƒ¨å¯¹è±¡æ—¶ï¼Œå¯¹å°æ‹¬å·å’Œå¤§æ‹¬å·çš„é€‰æ‹©å°†ä¼šå½±å“å®é™…åˆ›å»ºå‡ºçš„å†…å®¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¾—åˆ°ä¸€ä¸ªåŒ…å« 10 ä¸ªå…ƒç´ çš„ std::vector</span></span><br><span class="line"><span class="function">T <span class="title">localObject</span><span class="params">(std::forward&lt;Ts&gt;(params)...)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾—åˆ°ä¸€ä¸ªåŒ…å« 2 ä¸ªå…ƒç´ çš„ std::vector</span></span><br><span class="line">T localObject&#123; std::forward&lt;Ts&gt;(params)... &#125;;</span><br></pre></td></tr></table></figure><p>æ ‡å‡†åº“å‡½æ•°<code>std::make_unique</code>å’Œ<code>std::make_shared</code>ä¹Ÿé¢ä¸´ç€è¿™ä¸ªé—®é¢˜ï¼Œå®ƒä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨å†…éƒ¨ä½¿ç”¨å°æ‹¬å·ï¼Œå¹¶å°†è¿™ä¸ªå†³å®šå†™è¿›æ–‡æ¡£ä¸­ï¼Œä½œä¸ºå…¶æ¥å£çš„ç»„æˆéƒ¨åˆ†ã€‚</p><h3 id="æ¡æ¬¾-8ï¼šä¼˜å…ˆé€‰ç”¨-nullptrï¼Œè€Œé-0-æˆ–-NULL">æ¡æ¬¾ 8ï¼šä¼˜å…ˆé€‰ç”¨ nullptrï¼Œè€Œé 0 æˆ– NULL</h3><hr><p>é‡ç‚¹ï¼š</p><p>åœ¨C++11ä¸­ï¼Œnullptræ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œè™½ç„¶å®ƒä¹Ÿä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼Œä½†å¥½åœ¨å®ƒä¹Ÿä¸æ˜¯æ•´æ•°ç±»å‹ã€‚<br>nullptrçš„ç±»å‹ä¸ºstd::nullptr_tï¼Œå®ƒå¯ä»¥éšå¼åœ°è½¬æ¢ä¸ºæ‰€æœ‰å†…ç½®çš„æŒ‡é’ˆç±»å‹ã€‚</p><hr><p><code>nullptr</code>çš„å®é™…ç±»å‹æ˜¯<code>std::nullptr_t</code>ï¼Œè¯¥ç±»å‹å¯ä»¥éšå¼è½¬æ¢åˆ°æ‰€æœ‰çš„è£¸æŒ‡é’ˆç±»å‹ï¼Œå› æ­¤<code>nullptr</code>å¯ä»¥æ‰®æ¼”æ‰€æœ‰ç±»å‹çš„æŒ‡é’ˆã€‚ä¸<code>0</code>å’Œ<code>NULL</code>ä¸åŒï¼Œ<code>nullptr</code>ä¸å…·å¤‡æ•´æ•°ç±»å‹ï¼Œå› æ­¤ä¸å…·æœ‰å¤šä¹‰æ€§ã€‚</p><p><code>0</code>å’Œ<code>NULL</code>å¯¼è‡´çš„é‡è½½é—®é¢˜æé†’æˆ‘ä»¬åº”å½“å°½é‡é¿å…åœ¨æ•´å‹å’ŒæŒ‡é’ˆç±»å‹ä¹‹é—´è¿›è¡Œé‡è½½ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">bool</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">void</span>*)</span></span>;  <span class="comment">// f çš„ä¸‰ä¸ªé‡è½½ç‰ˆæœ¬</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(<span class="number">0</span>);           <span class="comment">// è°ƒç”¨ f(int)</span></span><br><span class="line"><span class="built_in">f</span>(<span class="literal">NULL</span>);        <span class="comment">// å¯èƒ½æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œä½†ä¸€èˆ¬ä¼šè°ƒç”¨ f(int)ï¼Œç»ä¸ä¼šè°ƒç”¨ f(void*)</span></span><br><span class="line"><span class="built_in">f</span>(<span class="literal">nullptr</span>);     <span class="comment">// è°ƒç”¨ f(void*)</span></span><br></pre></td></tr></table></figure><p><code>nullptr</code>åœ¨æœ‰æ¨¡æ¿çš„å‰æä¸‹è¡¨ç°æœ€äº®çœ¼ï¼šæ¨¡æ¿ç±»å‹æ¨å¯¼ä¼šå°†<code>0</code>å’Œ<code>NULL</code>æ¨å¯¼æˆ â€œé”™è¯¯â€ ç±»å‹ï¼ˆå³å®ƒä»¬çš„çœŸå®ç±»å‹ï¼Œè€Œéç©ºæŒ‡é’ˆè¿™ä¸ªå«ä¹‰ï¼‰ï¼Œè€Œä½¿ç”¨<code>nullptr</code>çš„è¯ï¼Œæ¨¡æ¿å°±ä¸ä¼šå¸¦æ¥ç‰¹æ®Šçš„éº»çƒ¦ã€‚è€ƒè™‘å¦‚ä¸‹æƒ…å½¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">f1</span><span class="params">(std::shared_ptr&lt;Widget&gt; spw)</span></span>;</span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">f2</span><span class="params">(std::unique_ptr&lt;Widget&gt; upw)</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">f3</span><span class="params">(Widget* pw)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> FuncType, <span class="keyword">typename</span> MuxType, <span class="keyword">typename</span> PtrType&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">lockAndCall</span><span class="params">(FuncType func, MuxType&amp; mutex, PtrType ptr)</span> </span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">g</span><span class="params">(mutex)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">func</span>(ptr);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">std::mutex f1m, f2m, f3m;</span><br><span class="line"><span class="keyword">auto</span> result1 = <span class="built_in">lockAndCall</span>(f1, f1m, <span class="number">0</span>);         <span class="comment">// é”™è¯¯ï¼</span></span><br><span class="line"><span class="keyword">auto</span> result2 = <span class="built_in">lockAndCall</span>(f2, f2m, <span class="literal">NULL</span>);      <span class="comment">// é”™è¯¯ï¼</span></span><br><span class="line"><span class="keyword">auto</span> result3 = <span class="built_in">lockAndCall</span>(f3, f3m, <span class="literal">nullptr</span>);   <span class="comment">// æ­£ç¡®</span></span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-9ï¼šä¼˜å…ˆé€‰ç”¨åˆ«åå£°æ˜ï¼Œè€Œé-typedef">æ¡æ¬¾ 9ï¼šä¼˜å…ˆé€‰ç”¨åˆ«åå£°æ˜ï¼Œè€Œé typedef</h3><hr><p>é‡ç‚¹ï¼š</p><p><strong>åˆ«åå£°æ˜å¯ä»¥æ¨¡æ¿åŒ–(åˆ«åæ¨¡æ¿)ï¼Œè€Œtypedefä¸èƒ½ã€‚</strong></p><p>è¦ç‚¹ï¼š</p><ul><li>typedefä¸æ”¯æŒæ¨¡æ¿åŒ–ï¼Œä½†åˆ«åå£°æ˜æ”¯æŒã€‚</li><li>åˆ«åæ¨¡æ¿é¿å…ä½¿ç”¨â€œ::typeâ€åç¼€ï¼Œä»¥åŠåœ¨æ¨¡æ¿ä¸­çš„â€œtypenameâ€å‰ç¼€ï¼ˆtypedefæ‰€éœ€è¦çš„ï¼‰ã€‚</li><li>C++ 14ä¸ºæ‰€æœ‰çš„C++ 11ç±»å‹ç‰¹å¾è½¬æ¢æä¾›äº†åˆ«åæ¨¡æ¿ã€‚</li></ul><hr><p>å¾ˆå¤šäººå‘ç°åˆ«åå£°æ˜åœ¨å¤„ç†æ¶‰åŠå‡½æ•°æŒ‡é’ˆçš„ç±»å‹æ—¶ï¼Œæ¯”<code>typedef</code>æ›´å®¹æ˜“ç†è§£ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*FP)</span><span class="params">(<span class="type">int</span>, <span class="type">const</span> std::string&amp;)</span></span></span><br></pre></td></tr></table></figure><p>ä»£æ›¿ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> FP = <span class="built_in">void</span> (*)(<span class="type">int</span>, <span class="type">const</span> std::string&amp;);</span><br></pre></td></tr></table></figure><p>ä½†åˆ«åå£°æ˜çš„å‹å€’æ€§ä¼˜åŠ¿åœ¨äº<strong>åˆ«åæ¨¡æ¿ï¼ˆalias templateï¼‰</strong>ï¼Œå®ƒç»™äºˆäº† C++11 ç¨‹åºå‘˜ä¸€ç§ç›´æˆªäº†å½“çš„è¡¨è¾¾æœºåˆ¶ï¼Œç”¨ä»¥è¡¨è¾¾ C++98 ç¨‹åºå‘˜ä¸å¾—ä¸ç”¨åµŒå¥—åœ¨æ¨¡æ¿åŒ–çš„<code>struct</code>é‡Œé¢çš„<code>typedef</code>æ‰èƒ½ç¡¬æå‡ºæ¥çš„ä¸œè¥¿ã€‚è€ƒè™‘å¦‚ä¸‹æƒ…å½¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyAllocList</span> &#123;</span><br><span class="line">    <span class="keyword">typedef</span> std::list&lt;T, MyAlloc&lt;T&gt;&gt; type;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">typename</span> MyAllocList&lt;T&gt;::type list;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨åˆ«åæ¨¡æ¿ï¼Œå°±å¯ä»¥è®©æ•´ä¸ªå†™æ³•æ›´ç®€æ´ï¼Œå¹¶ä¸”å¯ä»¥æ‘†è„±ç±»å‹å‰çš„<code>typename</code>é™å®šç¬¦ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">using</span> MyAllocList = std::list&lt;T, MyAlloc&lt;T&gt;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    MyAllocList&lt;T&gt; list;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ C++11 ä¸­ï¼Œæ ‡å‡†åº“çš„<code>&lt;type_traits&gt;</code>ç»™å‡ºäº†ä¸€æ•´å¥—ç”¨äºè¿›è¡Œå€¼ç±»åˆ«è½¬æ¢çš„æ¨¡æ¿ï¼Œå®ƒä»¬æ˜¯ä½¿ç”¨<code>typedef</code>å®ç°çš„ï¼Œå¯¹äºç»™å®šå¾…å˜æ¢ç±»å‹ Tï¼Œå…¶ç»“æœç±»å‹éœ€è¦é€šè¿‡<code>std::transformation&lt;T&gt;::type</code>çš„æ–¹å¼è·å¾—ã€‚è€Œåœ¨ C++14 ä¸­ï¼Œæ‰€æœ‰çš„å€¼ç±»åˆ«è½¬æ¢éƒ½åŠ ä¸Šäº†å¯¹åº”çš„åˆ«åæ¨¡æ¿ï¼Œé€šè¿‡<code>std::transformation_t&lt;T&gt;</code>çš„æ–¹å¼ä½¿ç”¨ï¼Œè¿™æ˜¾ç„¶æ¯”<code>typedef</code>å®ç°çš„ç‰ˆæœ¬æ›´åŠ å¥½ç”¨ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">std::remove_const&lt;T&gt;::type          <span class="comment">// C++11: const T -&gt; T</span></span><br><span class="line">std::<span class="type">remove_const_t</span>&lt;T&gt;              <span class="comment">// C++14 ä¸­çš„ç­‰ä»·ç‰©</span></span><br><span class="line"></span><br><span class="line">std::remove_reference&lt;T&gt;::type      <span class="comment">// C++11: T&amp;/T&amp;&amp; -&gt; T</span></span><br><span class="line">std::<span class="type">remove_reference_t</span>&lt;T&gt;          <span class="comment">// C++14 ä¸­çš„ç­‰ä»·ç‰©</span></span><br><span class="line"></span><br><span class="line">std::add_lvalue_reference&lt;T&gt;::type  <span class="comment">// C++11: T -&gt; T&amp;</span></span><br><span class="line">std::<span class="type">add_lvalue_reference_t</span>&lt;T&gt;      <span class="comment">// C++14 ä¸­çš„ç­‰ä»·ç‰©</span></span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-10ï¼šä¼˜å…ˆé€‰ç”¨é™å®šä½œç”¨åŸŸçš„æšä¸¾ç±»å‹ï¼Œè€Œéä¸é™ä½œç”¨åŸŸçš„æšä¸¾ç±»å‹">æ¡æ¬¾ 10ï¼šä¼˜å…ˆé€‰ç”¨é™å®šä½œç”¨åŸŸçš„æšä¸¾ç±»å‹ï¼Œè€Œéä¸é™ä½œç”¨åŸŸçš„æšä¸¾ç±»å‹</h3><hr><p>é‡ç‚¹ï¼š</p><p>C++11å¼•å…¥çš„é™å®šä½œç”¨åŸŸæšä¸¾æ˜¯å¼ºç±»å‹æšä¸¾ï¼Œä½¿å¾—æšä¸¾ç±»å‹æ›´åŠ ç±»å‹å®‰å…¨ã€‚</p><p>è¦ç‚¹</p><ul><li>C++98 é£æ ¼çš„æšä¸¾ç°åœ¨è¢«ç§°ä¸ºä¸é™ä½œç”¨åŸŸçš„æšä¸¾ã€‚</li><li>é™å®šä½œç”¨åŸŸçš„æšä¸¾å€¼ä»…åœ¨æšä¸¾å†…éƒ¨å¯è§ã€‚å®ƒä»¬åªèƒ½é€šè¿‡å¼ºåˆ¶ç±»å‹è½¬æ¢è½¬æ¢ä¸ºå…¶ä»–ç±»å‹ã€‚</li><li>é™å®šä½œç”¨åŸŸçš„æšä¸¾å’Œä¸é™å®šä½œç”¨åŸŸçš„æšä¸¾éƒ½æ”¯æŒæŒ‡å®šåŸºç¡€ç±»å‹ã€‚é™å®šä½œç”¨çš„æšä¸¾çš„é»˜è®¤åŸºç¡€ç±»å‹æ˜¯ intã€‚ä¸é™å®šä½œç”¨åŸŸçš„æšä¸¾æ²¡æœ‰é»˜è®¤åŸºç¡€ç±»å‹ã€‚</li><li>é™å®šä½œç”¨åŸŸæ˜¯æšä¸¾æ€»æ˜¯å¯ä»¥è¿›è¡Œå‰ç½®å£°æ˜ã€‚ä¸é™å®šä½œç”¨åŸŸçš„æšä¸¾åªæœ‰åœ¨å…¶å£°æ˜æŒ‡å®šäº†åŸºç¡€ç±»å‹æ—¶æ‰èƒ½è¿›è¡Œå‰ç½®å£°æ˜ã€‚</li></ul><hr><p>C++98 ä¸­çš„æšä¸¾ç±»å‹è¢«ç§°ä¸ºä¸é™ä½œç”¨åŸŸçš„æšä¸¾ç±»å‹ï¼Œä¸ä¹‹ç›¸å¯¹çš„å³æ˜¯ C++11 ä¸­å¼•å…¥çš„é™å®šä½œç”¨åŸŸçš„æšä¸¾ç±»å‹ï¼Œå³æšä¸¾ç±»<code>enum class</code>ï¼Œå®ƒçš„ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼šä¸ä¼šäº§ç”Ÿåç§°æ±¡æŸ“ã€‚</p><p>é™¤æ­¤ä»¥å¤–ï¼Œæšä¸¾ç±»è¿˜æ˜¯å¼ºç±»å‹çš„ï¼Œè€Œä¸é™èŒƒå›´çš„æšä¸¾ç±»å‹ä¸­çš„æšä¸¾é‡å¯ä»¥éšå¼è½¬æ¢åˆ°æ•´å‹ï¼ˆå¹¶ç”±æ­¤æ›´è¿›ä¸€æ­¥è½¬æ¢åˆ°æµ®ç‚¹å‹ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123; black, white, red &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;std::<span class="type">size_t</span>&gt; <span class="title">primeFactors</span><span class="params">(std::<span class="type">size_t</span> x)</span></span>;</span><br><span class="line"></span><br><span class="line">Color c = red;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (c &lt; <span class="number">14.5</span>) &#123;</span><br><span class="line">    <span class="keyword">auto</span> factors = <span class="built_in">primeFactors</span>(c);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æƒ³è¦ç”¨<code>enum class</code>ä»£æ›¿<code>enum</code>ï¼Œå¯¹å…¶æ–½ä»¥å¼ºåˆ¶ç±»å‹è½¬æ¢å³å¯ï¼Œä½†æ˜¯æ— æ³•ç¡®ä¿è½¬æ¢çš„åˆæ³•æ€§ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">Color</span> &#123; black, white, red &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;std::<span class="type">size_t</span>&gt; <span class="title">primeFactors</span><span class="params">(std::<span class="type">size_t</span> x)</span></span>;</span><br><span class="line"></span><br><span class="line">Color c = Color::red;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(c) &lt; <span class="number">14.5</span>) &#123;</span><br><span class="line">    <span class="keyword">auto</span> factors = <span class="built_in">primeFactors</span>(<span class="built_in">static_cast</span>&lt;std::<span class="type">size_t</span>&gt;(c));</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸é™èŒƒå›´çš„æšä¸¾ç±»å‹ï¼Œç¼–è¯‘å™¨ä¸ºäº†èŠ‚çº¦ä½¿ç”¨å†…å­˜ï¼Œé€šå¸¸ä¼šä¸ºæšä¸¾ç±»å‹é€‰ç”¨è¶³å¤Ÿè¡¨ç¤ºæšä¸¾é‡å–å€¼çš„æœ€å°åº•å±‚ç±»å‹ã€‚å³ä½¿åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šé‡‡å–ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ï¼Œå¯¼è‡´æ”¾å¼ƒé€‰æ‹©å°ºå¯¸æœ€å°çš„ç±»å‹ï¼Œç„¶è€Œå®ƒä»ç„¶éœ€è¦ä¿ç•™ä¼˜åŒ–ç©ºé—´çš„èƒ½åŠ›ã€‚å› æ­¤ï¼Œåœ¨ C++98 ä¸­ï¼Œ<code>enum</code>åªå…è®¸åœ¨å£°æ˜å¤„å®šä¹‰ï¼Œæ²¡æœ‰æä¾›å¯¹å‰ç½®å£°æ˜çš„æ”¯æŒã€‚</p><p>è€Œåœ¨ C++11 ä¸­ï¼Œæ— è®ºæ˜¯<code>enum class</code>è¿˜æ˜¯<code>enum</code>éƒ½å¯ä»¥è¿›è¡Œå‰ç½®å£°æ˜ï¼Œ<code>enum class</code>çš„é»˜è®¤åº•å±‚ç±»å‹æ˜¯<code>int</code>ï¼Œè€Œ<code>enum</code>ä¸å…·å¤‡é»˜è®¤åº•å±‚ç±»å‹ï¼Œåªæœ‰åœ¨æŒ‡å®šäº†çš„å‰æä¸‹æ‰å¯ä»¥è¿›è¡Œå‰ç½®å£°æ˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status</span>;                  <span class="comment">// åº•å±‚ç±»å‹æ˜¯ int</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status</span> : std::<span class="type">uint32_t</span>;  <span class="comment">// åº•å±‚ç±»å‹æ˜¯ std::uint32_t</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> : std::<span class="type">uint8_t</span>;          <span class="comment">// åº•å±‚ç±»å‹æ˜¯ std::uint8_t</span></span><br></pre></td></tr></table></figure><p>åº•å±‚ç±»å‹æŒ‡å®šåŒæ ·ä¹Ÿå¯ä»¥åœ¨å®šä¹‰æ—¶è¿›è¡Œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status</span> : std::<span class="type">uint32_t</span> &#123;</span><br><span class="line">    good = <span class="number">0</span>,</span><br><span class="line">    failed = <span class="number">1</span>,</span><br><span class="line">    incomplete = <span class="number">100</span>,</span><br><span class="line">    corrupt = <span class="number">200</span>,</span><br><span class="line">    audited = <span class="number">500</span>,</span><br><span class="line">    indetermine = <span class="number">0xFFFFFFFF</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸é™èŒƒå›´çš„æšä¸¾ç±»å‹åœ¨ä½ éœ€è¦æ›´ä¾¿æ·åœ°ä¸ºæ•°å­—å’Œåç§°å»ºç«‹è”ç³»æ—¶ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½ç”¨çš„ï¼Œä¾‹å¦‚åœ¨è®¿é—®å…ƒç»„çš„å…ƒç´ æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨æšä¸¾é‡è€Œéç›´æ¥ä½¿ç”¨éš¾æ‡‚çš„æ•°å­—ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UserInfo = std::tuple&lt;std::string, std::string, std::<span class="type">size_t</span>&gt;;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">UserInfoFields</span> &#123; uiName, uiEmail, uiReputation &#125;;</span><br><span class="line"></span><br><span class="line">UserInfo uInfo;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> val = std::<span class="built_in">get</span>&lt;uiEmail&gt;(uInfo);</span><br></pre></td></tr></table></figure><p>è€Œä½¿ç”¨<code>enum class</code>å°±è¦å•°å—¦å¾—å¤šï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> val = std::get&lt;<span class="built_in">static_cast</span>&lt;std::<span class="type">size_t</span>&gt;(UserInfoFields::uiEmail)&gt;(uInfo);</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å®åœ¨æ— æ³•å¿å—åç§°æ±¡æŸ“ï¼Œæ‰§æ„æ‰“ç®—ä½¿ç”¨<code>enum class</code>ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ä»¥ä¸‹è¾…åŠ©ç±»æ¥ç®€åŒ–ä¹¦å†™ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> E&gt;    <span class="comment">// C++14</span></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="keyword">auto</span> <span class="title">toUType</span><span class="params">(E enumerator)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;std::<span class="type">underlying_type_t</span>&lt;E&gt;&gt;(enumerator);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> val = std::<span class="built_in">get</span>&lt;<span class="built_in">toUType</span>(UserInfoFields::uiEmail)&gt;(uInfo);</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-11ï¼šä¼˜å…ˆé€‰ç”¨åˆ é™¤å‡½æ•°ï¼Œè€Œé-private-æœªå®šä¹‰å‡½æ•°">æ¡æ¬¾ 11ï¼šä¼˜å…ˆé€‰ç”¨åˆ é™¤å‡½æ•°ï¼Œè€Œé private æœªå®šä¹‰å‡½æ•°</h3><hr><p>é‡ç‚¹ï¼š</p><p>å·²åˆ é™¤å‡½æ•°çš„ä¸€ä¸ªé‡è¦ä¼˜åŠ¿æ˜¯ä»»ä½•å‡½æ•°éƒ½å¯ä»¥è¢«åˆ é™¤</p><p><strong>è¦ç‚¹</strong></p><ul><li>ä¼˜å…ˆé€‰æ‹©å·²åˆ é™¤å‡½æ•°è€Œä¸æ˜¯ç§æœ‰æœªå®šä¹‰çš„å‡½æ•°ã€‚</li><li>ä»»ä½•å‡½æ•°éƒ½å¯ä»¥è¢«åˆ é™¤ï¼ŒåŒ…æ‹¬éæˆå‘˜å‡½æ•°å’Œæ¨¡æ¿å®ä¾‹åŒ–ã€‚</li></ul><hr><p>åˆ é™¤å‡½æ•°å’Œå°†å‡½æ•°å£°æ˜ä¸º private çœ‹èµ·æ¥åªæ˜¯é£æ ¼ä¸åŒçš„é€‰æ‹©ï¼Œä½†å…¶å®æœ‰æ›´å¤šå€¼å¾—æ€è€ƒçš„å¾®å¦™ä¹‹å¤„ï¼Œä¾‹å¦‚ï¼šè¢«åˆ é™¤çš„å‡½æ•°æ— æ³•é€šè¿‡ä»»ä½•æ–¹æ³•è°ƒç”¨ï¼Œå¯¹äºæˆå‘˜å’Œå‹å…ƒå‡½æ•°ä¸­çš„ä»£ç ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><p>ä¹ æƒ¯ä¸Šï¼Œåˆ é™¤å‡½æ•°ä¼šè¢«å£°æ˜ä¸º publicï¼Œè€Œé privateï¼Œè¿™æ ·åšçš„ç†ç”±æ˜¯ï¼šC++ ä¼šå…ˆæ ¡éªŒå¯è®¿é—®æ€§ï¼Œåæ ¡éªŒåˆ é™¤çŠ¶æ€ï¼Œå½“æˆ‘ä»¬å°è¯•è°ƒç”¨æŸä¸ª private åˆ é™¤å‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨å¯èƒ½åªä¼šæé†’å‡½æ•°æ— æ³•è®¿é—®ï¼Œè€Œéæ›´åº”å…³å¿ƒçš„å‡½æ•°æ˜¯å¦è¢«åˆ é™¤ã€‚</p><p>ä»¥ä¸‹æ˜¯ C++11 ä¸­<code>std::basic_ios</code>é˜»æ­¢è¢«å¤åˆ¶çš„æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">charT</span>, <span class="keyword">class</span> <span class="title class_">traits</span> = char_traits&lt;charT&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> basic_ios : <span class="keyword">public</span> ios_base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">basic_ios</span>(<span class="type">const</span> basic_ios&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    basic_ios&amp; <span class="keyword">operator</span>=(<span class="type">const</span> basic_ios&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»»ä½•å‡½æ•°éƒ½èƒ½è¢«åˆ é™¤ï¼Œè—‰æ­¤æˆ‘ä»¬å¯ä»¥è¿‡æ»¤æ‰ä¸æƒ³è¦çš„å‡½æ•°é‡è½½ç‰ˆæœ¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isLucky</span><span class="params">(<span class="type">int</span> number)</span></span>;       <span class="comment">// åŸå§‹ç‰ˆæœ¬</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isLucky</span><span class="params">(<span class="type">char</span>)</span> </span>= <span class="keyword">delete</span>;    <span class="comment">// æ‹’ç» char ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isLucky</span><span class="params">(<span class="type">bool</span>)</span> </span>= <span class="keyword">delete</span>;    <span class="comment">// æ‹’ç» bool ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isLucky</span><span class="params">(<span class="type">double</span>)</span> </span>= <span class="keyword">delete</span>;  <span class="comment">// æ‹’ç» double å’Œ float ç±»å‹</span></span><br></pre></td></tr></table></figure><p><code>float</code>ç±»å‹çš„å‚æ•°ä¼šä¼˜å…ˆè½¬æ¢åˆ°<code>double</code>ç±»å‹ï¼Œå› æ­¤ä¼ å…¥<code>float</code>æ—¶ä¼šè°ƒç”¨<code>double</code>ç±»å‹çš„é‡è½½ç‰ˆæœ¬ï¼Œä½†ç”±äºè¿™ä¸ªé‡è½½ç‰ˆæœ¬è¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥ç¼–è¯‘ä¼šè¢«é˜»æ­¢ã€‚</p><p>åˆ é™¤å‡½æ•°è¿˜å¯ä»¥é˜»æ­¢é‚£äº›ä¸åº”è¯¥è¿›è¡Œçš„æ¨¡æ¿å…·ç°ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾ä½ éœ€è¦ä¸€ä¸ªå’Œå†…å»ºæŒ‡é’ˆåä½œçš„æ¨¡æ¿ï¼Œå´ä¸æƒ³è¦å®ƒå¯¹<code>void*</code>å’Œ<code>char*</code>æŒ‡é’ˆè¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå¯ä»¥å†™å‡ºä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">processPointer</span><span class="params">(T* ptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="type">void</span> <span class="built_in">processPointer</span>&lt;<span class="type">void</span>&gt;(<span class="type">void</span>*) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="type">void</span> <span class="built_in">processPointer</span>&lt;<span class="type">char</span>&gt;(<span class="type">char</span>*) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="type">void</span> <span class="built_in">processPointer</span>&lt;<span class="type">const</span> <span class="type">void</span>&gt;(<span class="type">const</span> <span class="type">void</span>*) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="type">void</span> <span class="built_in">processPointer</span>&lt;<span class="type">const</span> <span class="type">char</span>&gt;(<span class="type">const</span> <span class="type">char</span>*) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ å»å…¶å®ƒç‰ˆæœ¬ï¼Œå¦‚ volatile void* å’Œ volatile char*</span></span><br><span class="line"><span class="comment">// ä¸å…¶å®ƒæ ‡å‡†å­—ç¬¦ç±»å‹ï¼Œå¦‚ std::wchar_t, std::char16_t å’Œ std::char32_t</span></span><br></pre></td></tr></table></figure><p>æˆå‘˜å‡½æ•°æ¨¡æ¿å¯ä»¥åœ¨ç±»å¤–è¢«åˆ é™¤ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">processPointer</span><span class="params">(T* ptr)</span> </span>&#123; ... &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="type">void</span> Widget::<span class="built_in">processPointer</span>&lt;<span class="type">void</span>&gt;(<span class="type">void</span>*) = <span class="keyword">delete</span>;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-12ï¼šä¸ºæ„åœ¨æ”¹å†™çš„å‡½æ•°æ·»åŠ -override-å£°æ˜">æ¡æ¬¾ 12ï¼šä¸ºæ„åœ¨æ”¹å†™çš„å‡½æ•°æ·»åŠ  override å£°æ˜</h3><hr><blockquote><p><strong>å¼•ç”¨é™å®šç¬¦</strong></p></blockquote><p>å¼•ç”¨é™å®šç¬¦å¯ä»¥å°†æˆå‘˜å‡½æ•°çš„ä½¿ç”¨é™åˆ¶ä¸ºåªå·¦å€¼æˆ–åªå³å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Widget</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">Â  Â  â€¦</span><br><span class="line">Â  Â  <span class="type">void</span> <span class="title function_">doWork</span><span class="params">()</span> &amp;; <span class="comment">// åªæœ‰å½“*thisæ˜¯å·¦å€¼æ—¶ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„doWorkæ‰é€‚ç”¨</span></span><br><span class="line">Â  Â  <span class="type">void</span> <span class="title function_">doWork</span><span class="params">()</span> &amp;&amp; ; <span class="comment">// åªæœ‰å½“*thisæ˜¯å³å€¼æ—¶ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„doWorkæ‰é€‚ç”¨</span></span><br><span class="line">&#125;; </span><br><span class="line">â€¦</span><br><span class="line">Widget <span class="title function_">makeWidget</span><span class="params">()</span>; <span class="comment">// å·¥å‚å‡½æ•°(è¿”å›å³å€¼)</span></span><br><span class="line">Widget w; <span class="comment">// æ™®é€šå¯¹è±¡(ä¸€ä¸ªå·¦å€¼)</span></span><br><span class="line">â€¦</span><br><span class="line">w.doWork(); <span class="comment">// è°ƒç”¨å·¦å€¼ç‰ˆæœ¬çš„ Widget::doWork (i.e., Widget::doWork &amp;)</span></span><br><span class="line">makeWidget().doWork(); <span class="comment">// è°ƒç”¨å³å€¼ç‰ˆæœ¬çš„ Widget::doWork (i.e., Widget::doWork &amp;&amp;)</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>case</strong></p></blockquote><p>ä¸ºä»€ä¹ˆè¿™äº›æ´¾ç”Ÿç±»çš„å‡½æ•°ä¸é‡å†™åŸºç±»çš„åŒåå‡½æ•°?</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf1</span><span class="params">()</span> <span class="type">const</span>;</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf2</span><span class="params">(<span class="type">int</span> x)</span>;</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf3</span><span class="params">()</span> &amp;;</span><br><span class="line">Â  Â  <span class="type">void</span> <span class="title function_">mf4</span><span class="params">()</span> <span class="type">const</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> public Base &#123;</span><br><span class="line">public:</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf1</span><span class="params">()</span>;</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf2</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> x)</span>;</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf3</span><span class="params">()</span> &amp;&amp; ;</span><br><span class="line">Â  Â  <span class="type">void</span> <span class="title function_">mf4</span><span class="params">()</span> <span class="type">const</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>mf1åœ¨Baseä¸­å£°æ˜ä¸ºconstï¼Œä½†åœ¨Derivedä¸­æ²¡æœ‰ã€‚</li><li>mf2åœ¨Baseä¸­æ¥å—ä¸€ä¸ªintç±»å‹å‚æ•°ï¼Œä½†åœ¨Derivedä¸­æ¥å—ä¸€ä¸ªunsigned intç±»å‹å‚æ•°ã€‚</li><li>mf3åœ¨Baseä¸­æ˜¯å·¦å€¼é™å®šçš„ï¼Œä½†åœ¨Derivedä¸­æ˜¯å³å€¼é™å®šçš„ã€‚</li><li>åœ¨Baseä¸­æ²¡æœ‰å°†f4å£°æ˜ä¸ºvirtualã€‚</li></ul><p>C++11ä¸­ï¼Œå¯ä»¥å°†æˆå‘˜å‡½æ•°å£°æ˜ä¸ºoverrideï¼Œ<strong>ç¼–è¯‘å™¨ä¼šæŠ±æ€¨æ‰€æœ‰ä¸é‡å†™ç›¸å…³çš„é—®é¢˜</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> public Base &#123;</span><br><span class="line">public:</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf1</span><span class="params">()</span> override;</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf2</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> x)</span> override;</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf3</span><span class="params">()</span> &amp;&amp; override;</span><br><span class="line">Â  Â  virtual <span class="type">void</span> <span class="title function_">mf4</span><span class="params">()</span> <span class="type">const</span> override;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¦ç‚¹</p><ul><li>å°†é‡å†™å‡½æ•°å£°æ˜ä¸ºoverrideã€‚</li><li>æˆå‘˜å‡½æ•°å¼•ç”¨é™å®šç¬¦ä½¿å¾—å¯ä»¥åŒºåˆ«å¯¹å¾…å·¦å€¼å’Œå³å€¼å¯¹è±¡(*this)ã€‚</li></ul><hr><p>å¦‚æœè¦ä½¿è™šå‡½æ•°é‡å†™å‘ç”Ÿï¼Œæœ‰ä¸€ç³»åˆ—è¦æ±‚éœ€è¦æ»¡è¶³ï¼š</p><ol><li>åŸºç±»ä¸­çš„å‡½æ•°å¿…é¡»æ˜¯è™šå‡½æ•°ã€‚</li><li>åŸºç±»å’Œæ´¾ç”Ÿç±»ä¸­çš„<strong>å‡½æ•°åç§°</strong>å¿…é¡»å®Œå…¨ç›¸åŒï¼ˆææ„å‡½æ•°é™¤å¤–ï¼‰ã€‚</li><li>åŸºç±»å’Œæ´¾ç”Ÿç±»ä¸­çš„<strong>å‡½æ•°å½¢å‚ç±»å‹</strong>å¿…é¡»å®Œå…¨ç›¸åŒã€‚</li><li>åŸºç±»å’Œæ´¾ç”Ÿç±»ä¸­çš„<strong>å‡½æ•°å¸¸é‡æ€§</strong>å¿…é¡»å®Œå…¨ç›¸åŒã€‚</li><li>åŸºç±»å’Œæ´¾ç”Ÿç±»ä¸­çš„<strong>å‡½æ•°è¿”å›å€¼</strong>å’Œ<strong>å¼‚å¸¸è§„æ ¼</strong>å¿…é¡»å…¼å®¹ã€‚</li><li>åŸºç±»å’Œæ´¾ç”Ÿç±»çš„<strong>å‡½æ•°å¼•ç”¨é™å®šç¬¦</strong>å¿…é¡»å®Œå…¨ç›¸åŒã€‚</li></ol><p>ç”±äºå¯¹å£°æ˜æ´¾ç”Ÿç±»ä¸­çš„é‡å†™ï¼Œä¿è¯æ­£ç¡®æ€§å¾ˆé‡è¦ï¼Œè€Œå‡ºé”™åˆå¾ˆå®¹æ˜“ï¼ŒC++11 æä¾›äº†<code>override</code>å£°æ˜æ¥æ˜¾å¼åœ°æ ‡æ˜æ´¾ç”Ÿç±»ä¸­çš„å‡½æ•°æ˜¯ä¸ºäº†é‡å†™åŸºç±»ç‰ˆæœ¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf1</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf2</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf3</span><span class="params">()</span> &amp;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf4</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf1</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf2</span><span class="params">(<span class="type">int</span> x)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf3</span><span class="params">()</span> &amp; <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">mf4</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;  <span class="comment">// åŠ ä¸ª &quot;virtual&quot; æ²¡é—®é¢˜ï¼Œä½†ä¹Ÿæ²¡å¿…è¦</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ ·åšçš„å¥½å¤„ä¸ä»…åœ¨äºè®©ç¼–è¯‘å™¨æé†’ä½ æƒ³è¦é‡å†™çš„å‡½æ•°å®é™…ä¸Šå¹¶æœªé‡å†™ï¼Œè¿˜å¯ä»¥è®©ä½ åœ¨æ‰“ç®—æ›´æ”¹åŸºç±»ä¸­è™šå‡½æ•°çš„ç­¾åæ—¶ï¼Œè¡¡é‡ä¸€ä¸‹å…¶æ‰€é€ æˆçš„å½±å“ã€‚</p><blockquote><p><code>override</code>å’Œ<code>final</code>æ˜¯ C++11 ä¸­åŠ å…¥çš„<strong>è¯­å¢ƒå…³é”®å­—ï¼ˆcontextual keywordï¼‰</strong>ï¼Œå®ƒä»¬çš„ç‰¹ç‚¹æ˜¯ä»…ä¼šåœ¨ç‰¹å®šè¯­å¢ƒä¸‹æ‰å‘æŒ¥è¢«ä¿ç•™çš„æ„ä¹‰ï¼Œå› æ­¤å¦‚æœä½ æœ‰ä¸€äº›é—ç•™ä»£ç ï¼Œå…¶ä¸­å·²ç»ç”¨è¿‡<code>override</code>å’Œ<code>final</code>ä½œä¸ºåç§°çš„è¯ï¼Œå¹¶ä¸éœ€è¦ä¸ºå®ƒä»¬æ”¹åã€‚</p></blockquote><p><strong>å‡½æ•°å¼•ç”¨é™å®šç¬¦ï¼ˆreference qualifierï¼‰ï¼š</strong> é™åˆ¶æˆå‘˜å‡½æ•°ä»…ç”¨äºå·¦å€¼å¯¹è±¡æˆ–å³å€¼å¯¹è±¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">doWork</span><span class="params">()</span> &amp;</span>;    <span class="comment">// ä»…åœ¨ *this æ˜¯å·¦å€¼æ—¶è°ƒç”¨</span></span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">doWork</span><span class="params">()</span> &amp;&amp;</span>;   <span class="comment">// ä»…åœ¨ *this æ˜¯å³å€¼æ—¶è°ƒç”¨</span></span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function">Widget <span class="title">makeWidget</span><span class="params">()</span></span>;</span><br><span class="line">Widget w;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">w.<span class="built_in">doWork</span>();            <span class="comment">// ä»¥å·¦å€¼è°ƒç”¨ Widget::doWork &amp;</span></span><br><span class="line"><span class="built_in">makeWidget</span>().<span class="built_in">doWork</span>(); <span class="comment">// ä»¥å³å€¼è°ƒç”¨ Widget::doWork &amp;&amp;</span></span><br></pre></td></tr></table></figure><p>å¸¦å¼•ç”¨é™å®šç¬¦çš„æˆå‘˜å‡½æ•°å¹¶ä¸å¸¸è§ï¼Œä½†æœ‰æ—¶ä¹Ÿæ˜¯éœ€è¦çš„ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾æˆ‘ä»¬çš„<code>Widget</code>ç±»ä¸­æœ‰ä¸ª<code>std::vector</code>ç±»å‹çš„æ•°æ®æˆå‘˜ï¼Œæˆ‘ä»¬æä¾›ä¸€ä¸ªå‡½æ•°è®©ç”¨æˆ·èƒ½å¯¹è¿™ä¸ªæ•°æ®æˆå‘˜ç›´æ¥è®¿é—®ï¼Œä½†å¯¹äºå·¦å€¼å¯¹è±¡å’Œå³å€¼å¯¹è±¡æœ‰ä¸åŒçš„è¡Œä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> DataType = std::vector&lt;<span class="type">double</span>&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function">DataType&amp; <span class="title">data</span><span class="params">()</span> &amp;              <span class="comment">// å¯¹äºå·¦å€¼ Widget ç±»å‹ï¼Œè¿”å›å·¦å€¼</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> values; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">DataType <span class="title">data</span><span class="params">()</span> &amp;&amp;              <span class="comment">// å¯¹äºå³å€¼ Widget ç±»å‹ï¼Œè¿”å›å³å€¼</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> std::<span class="built_in">move</span>(values); &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    DataType values;</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function">Widget <span class="title">makeWidget</span><span class="params">()</span></span>;</span><br><span class="line">Widget w;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> vals1 = w.<span class="built_in">data</span>();              <span class="comment">// è°ƒç”¨ Widget::data çš„å·¦å€¼é‡è½½ç‰ˆæœ¬</span></span><br><span class="line">                                    <span class="comment">// vals1 é‡‡ç”¨æ‹·è´æ„é€ å®Œæˆåˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> vals2 = <span class="built_in">makeWidget</span>().<span class="built_in">data</span>();   <span class="comment">// è°ƒç”¨ Widget::data çš„å³å€¼é‡è½½ç‰ˆæœ¬</span></span><br><span class="line">                                    <span class="comment">// vals2 é‡‡ç”¨ç§»åŠ¨æ„é€ å®Œæˆåˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-13ï¼šä¼˜å…ˆé€‰ç”¨-const-iteratorï¼Œè€Œé-iterator">æ¡æ¬¾ 13ï¼šä¼˜å…ˆé€‰ç”¨ const_iteratorï¼Œè€Œé iterator</h3><hr><p>è¦ç‚¹</p><ul><li>ä¼˜å…ˆé€‰ç”¨const_iterator,è€Œéiteratorã€‚</li><li>åœ¨æœ€æ³›å‹çš„ä»£ç ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨beginã€endã€rbeginç­‰çš„éæˆå‘˜ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯å¯¹åº”çš„æˆå‘˜å‡½æ•°ã€‚</li></ul><hr><p><code>const_iterator</code>æ˜¯ STL ä¸­æä¾›çš„ä¸æŒ‡å‘ const çš„æŒ‡é’ˆå«ä¹‰ç›¸åŒä¹‹ç‰©ï¼Œå®ƒä»¬æŒ‡å‘ä¸å¯è¢«ä¿®æ”¹çš„å€¼ã€‚ä»»ä½•æ—¶å€™åªè¦ä½ éœ€è¦ä¸€ä¸ªè¿­ä»£å™¨è€Œå…¶æ‰€æŒ‡å‘çš„å†…å®¹æ²¡æœ‰ä¿®æ”¹çš„å¿…è¦ï¼Œé‚£å°±åº”è¯¥ä½¿ç”¨ const_iteratorã€‚</p><p>ä½†åœ¨ C++98 ä¸­ï¼Œ<code>const_iterator</code>å¾—åˆ°çš„æ”¯æŒä¸å¤Ÿå…¨é¢ï¼Œæƒ³è¦è·å–å®ƒä»¬å°±å¾ˆä¸å®¹æ˜“ï¼Œè€Œè·å–åˆ°äº†ä»¥åä½¿ç”¨å®ƒä»¬çš„æ–¹æ³•ä¹Ÿå¾ˆå—é™ã€‚ä¾‹å¦‚åœ¨ C++98 ä¸­ï¼Œæˆ‘ä»¬ä¼šè¢«è¿«å†™å‡ºä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> std::vector&lt;<span class="type">int</span>&gt;::iterator IterT;</span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;<span class="type">int</span>&gt;::const_iterator ConstIterT;</span><br><span class="line"></span><br><span class="line">std::vector&lt;<span class="type">int</span>&gt; values;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">ConstIterT ci = </span><br><span class="line">    std::<span class="built_in">find</span>(<span class="built_in">static_cast</span>&lt;ConstIterT&gt;(values.<span class="built_in">begin</span>()),</span><br><span class="line">              <span class="built_in">static_cast</span>&lt;ConstIterT&gt;(values.<span class="built_in">end</span>()),</span><br><span class="line">              <span class="number">1983</span>);                            <span class="comment">// const_iterator ä½œä¸ºå‚æ•°ï¼Œè¿”å› const_iterator</span></span><br><span class="line"></span><br><span class="line">values.<span class="built_in">insert</span>(<span class="built_in">static_cast</span>&lt;IterT&gt;(ci), <span class="number">1998</span>);    <span class="comment">// C++98 ä¸­ insert åªèƒ½æ¥å— iterator</span></span><br><span class="line">                                                <span class="comment">// ä» const_iterator åˆ° iterator ä¸å­˜åœ¨å¯ç§»æ¤çš„ç±»å‹è½¬æ¢</span></span><br><span class="line">                                                <span class="comment">// å¯èƒ½æ— æ³•é€šè¿‡ç¼–è¯‘</span></span><br></pre></td></tr></table></figure><p>è€Œåœ¨ C++11 ä¸­ï¼Œè¿™äº›ç°è±¡å¾—åˆ°äº†å½»åº•çš„æ”¹å˜ï¼Œè·å–å’Œä½¿ç”¨<code>const_iterator</code>éƒ½å˜å¾—å®¹æ˜“äº†ã€‚è¦æŠŠåŸå§‹çš„ã€ä½¿ç”¨<code>iterator</code>çš„ C++98 ä»£ç ä¿®æ”¹æˆä½¿ç”¨<code>const_iterator</code>çš„ C++11 ä»£ç ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="type">int</span>&gt; values;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> it = std::<span class="built_in">find</span>(values.<span class="built_in">cbegin</span>(), values.<span class="built_in">cend</span>(), <span class="number">1983</span>);</span><br><span class="line"></span><br><span class="line">values.<span class="built_in">insert</span>(it, <span class="number">1998</span>);</span><br></pre></td></tr></table></figure><p>C++11 å¯¹äº<code>const_iterator</code>æ”¯æŒçš„å”¯ä¸€ç¼ºé™·æ˜¯åªä¸º<code>begin</code>å’Œ<code>end</code>æä¾›äº†å¯¹åº”çš„éæˆå‘˜å‡½æ•°ç‰ˆæœ¬ï¼Œè€Œæ²¡æœ‰ä¸º<code>cbegin</code>ã€<code>cend</code>ã€<code>rbegin</code>ã€<code>cend</code>ã€<code>crbegin</code>å’Œ<code>crend</code>è¿™äº›è¿”å›<code>const_iterator</code>çš„å‡½æ•°æä¾›å¯¹åº”çš„éæˆå‘˜å‡½æ•°ç‰ˆæœ¬ï¼Œè¿™ä¸ªé—®é¢˜åœ¨ C++14 ä¸­å¾—åˆ°äº†è§£å†³ã€‚æƒ³è¦è‡ªå·±å®ç°å®ƒä»¬ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚ä¸‹å°±æ˜¯éæˆå‘˜å‡½æ•°ç‰ˆæœ¬çš„<code>cbegin</code>çš„ä¸€ä¸ªå®ç°æ–¹å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> C&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">cbegin</span><span class="params">(<span class="type">const</span> C&amp; container)</span> -&gt; <span class="title">decltype</span><span class="params">(std::begin(container))</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">begin</span>(container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ¨¡æ¿åœ¨ä¼ å…¥ä¸€ä¸ªå†…å»ºæ•°ç»„æ—¶ä¹Ÿç®¡ç”¨ï¼Œæ­¤æ—¶<code>container</code>ä¼šæˆä¸ºä¸€ä¸ª const æ•°ç»„çš„å¼•ç”¨ã€‚</p><blockquote><p>C++11 çš„éæˆå‘˜å‡½æ•°ç‰ˆæœ¬çš„<code>begin</code>ä¸ºå†…å»ºæ•°ç»„æä¾›äº†ä¸€ä¸ªç‰¹åŒ–ç‰ˆæœ¬ï¼Œå®ƒè¿”å›ä¸€ä¸ªæŒ‡å‘æ•°ç»„é¦–å…ƒç´ çš„æŒ‡é’ˆã€‚ç”±äº const æ•°ç»„çš„å…ƒç´ éƒ½ä¸º constï¼Œæ‰€ä»¥è‹¥ç»™<code>begin</code>ä¼ å…¥ä¸€ä¸ª const æ•°ç»„ï¼Œåˆ™è¿”å›çš„æŒ‡é’ˆæ˜¯ä¸ªæŒ‡å‘ const çš„æŒ‡é’ˆï¼Œå³æ•°ç»„æ„ä¹‰ä¸‹çš„ const_iteratorã€‚</p></blockquote><p>ç”±äºå†…å»ºæ•°ç»„å’Œç¬¬ä¸‰æ–¹åº“çš„å­˜åœ¨ï¼Œæœ€é€šç”¨åŒ–çš„ä»£ç å¾€å¾€ä¸ä¼šå‡å®šæˆå‘˜å‡½æ•°çš„å­˜åœ¨ï¼Œè€Œæ˜¯æ›´å¤šåœ°é‡‡ç”¨éæˆå‘˜å‡½æ•°ç‰ˆæœ¬ï¼Œä¾‹å¦‚ä»¥ä¸‹<code>findAndInsert</code>æ¨¡æ¿çš„é€šç”¨å½¢å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> C, <span class="keyword">typename</span> V&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">findAndInsert</span><span class="params">(C&amp; container, <span class="type">const</span> V&amp; targetVal, <span class="type">const</span> V&amp; insertVal)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> std::cbegin;</span><br><span class="line">    <span class="keyword">using</span> std::cend;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> it = std::<span class="built_in">find</span>(<span class="built_in">cbegin</span>(container), <span class="built_in">cend</span>(container), targetVal);</span><br><span class="line"></span><br><span class="line">    container.<span class="built_in">insert</span>(it, insertVal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-14ï¼šåªè¦å‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå°±ä¸ºå…¶åŠ ä¸Š-noexcept-å£°æ˜">æ¡æ¬¾ 14ï¼šåªè¦å‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå°±ä¸ºå…¶åŠ ä¸Š noexcept å£°æ˜</h3><hr><p>noexceptå«ä¹‰ï¼šä¸€ä¸ªå‡½æ•° fï¼Œå®ƒå‘è°ƒç”¨è€…æ‰¿è¯ºæ°¸è¿œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚noexceptä½¿å¾—ç¼–è¯‘å™¨å¯ä»¥æ ¹æ®è¿™ä¸ªå£°æ˜è¿›è¡Œæ›´æ·±å…¥çš„ä¼˜åŒ–ï¼Œé¿å…ä¸å¿…è¦æ ˆå±•å¼€æ“ä½œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">f</span><span class="params">(<span class="type">int</span> x)</span> <span class="title">throw</span><span class="params">()</span></span>; <span class="comment">// C++98 é£æ ¼</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">f</span><span class="params">(<span class="type">int</span> x)</span> <span class="keyword">noexcept</span></span>; <span class="comment">// C++11 é£æ ¼</span></span><br></pre></td></tr></table></figure><p>å¦‚æœf è¿åäº†å¼‚å¸¸è§„èŒƒã€‚<br>C++98 é£æ ¼ï¼šè°ƒç”¨æ ˆä¼šå±•å¼€ï¼Œé€€å›åˆ° f çš„è°ƒç”¨è€…ï¼Œè¿›è¡Œä¸€äº›æ“ä½œåï¼Œç¨‹åºæ‰§è¡Œå°±ä¼šç»ˆæ­¢<br>C++11 é£æ ¼ï¼šç¨‹åºç»ˆæ­¢ä¹‹å‰ï¼Œæ ˆåªæ˜¯å¯èƒ½ä¼šè¢«å±•å¼€ï¼ˆå°±ç®—å¼‚å¸¸è¢«æŠ›å‡ºï¼Œå¤§ä¸äº†ç»ˆæ­¢ç¨‹åºï¼Œæ— éœ€å¤„ç†å¼‚å¸¸ï¼‰</p><p>æ½œåœ¨é—®é¢˜ï¼š</p><p>å‡è®¾ä½ æƒ³é€šè¿‡ç§»åŠ¨æ¥ä¼˜åŒ–æ€§èƒ½ï¼Œä½†ä¸æ‹·è´ä¸åŒï¼Œç§»åŠ¨è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œå°†å¾ˆéš¾å›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€ã€‚è¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå› ä¸ºé—ç•™ä»£ç çš„è¡Œä¸ºå¯èƒ½ä¾èµ–äºpush_backçš„å¼ºå¼‚å¸¸å®‰å…¨ä¿è¯ã€‚å› æ­¤ç§»åŠ¨æ“ä½œå¿…é¡»åšå‡ºnoexceptä¿è¯ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;Widget&gt; vw;</span><br><span class="line">â€¦</span><br><span class="line">Widget w;</span><br><span class="line">â€¦ </span><br><span class="line">vw.<span class="built_in">push_back</span>(w); </span><br><span class="line">â€¦</span><br></pre></td></tr></table></figure><hr><p>åœ¨ C++11 ä¸­ï¼ŒC++98 é£æ ¼çš„å¼‚å¸¸è§„èŒƒå·²ç»è¢«å¼ƒç”¨ï¼Œè€Œè½¬ä¸ºä¸ºä¸ä¼šæŠ›å‡ºå¼‚å¸¸çš„å‡½æ•°æä¾›<code>noexcept</code>å£°æ˜ï¼Œå‡½æ•°æ˜¯å¦è¦åŠ ä¸Šè¿™ä¸ªå£°æ˜ï¼Œäº‹å…³æ¥å£å£°æ˜ã€‚</p><p>è°ƒç”¨æ–¹å¯ä»¥æŸ¥è¯¢å‡½æ•°çš„<code>noexcept</code>çŠ¶æ€ï¼Œè€ŒæŸ¥è¯¢ç»“æœå¯èƒ½ä¼šå½±å“è°ƒç”¨ä»£ç çš„å¼‚å¸¸å®‰å…¨æ€§å’Œè¿è¡Œæ•ˆç‡ã€‚è¿™ä¹ˆä¸€æ¥ï¼Œå‡½æ•°æ˜¯å¦å¸¦æœ‰<code>noexcept</code>å£°æ˜å°±æ˜¯å’Œæˆå‘˜å‡½æ•°æ˜¯å¦å¸¦æœ‰ const å£°æ˜åŒç­‰é‡è¦çš„ä¿¡æ¯ã€‚å½“ä½ æ˜æ˜çŸ¥é“ä¸€ä¸ªå‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸å´æœªç»™å®ƒåŠ ä¸Š<code>noexcept</code>å£°æ˜çš„è¯ï¼Œå°±å±äºæ¥å£è§„æ ¼è®¾è®¡ç¼ºé™·ã€‚</p><p>ç›¸å½“äºä¸å¸¦<code>noexcept</code>å£°æ˜çš„å‡½æ•°ï¼Œå¸¦æœ‰<code>noexcept</code>å£°æ˜çš„å‡½æ•°æœ‰æ›´å¤šæœºä¼šå¾—åˆ°ä¼˜åŒ–ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RetType <span class="title">function</span><span class="params">(params)</span> <span class="keyword">noexcept</span></span>;  <span class="comment">// æœ€ä¼˜åŒ–</span></span><br><span class="line"></span><br><span class="line"><span class="function">RetType <span class="title">function</span><span class="params">(params)</span> <span class="title">throw</span><span class="params">()</span></span>;   <span class="comment">// ä¼˜åŒ–ä¸è¶³</span></span><br><span class="line"></span><br><span class="line"><span class="function">RetType <span class="title">function</span><span class="params">(params)</span></span>;           <span class="comment">// ä¼˜åŒ–ä¸è¶³</span></span><br></pre></td></tr></table></figure><p>åœ¨å¸¦æœ‰<code>noexcept</code>å£°æ˜çš„å‡½æ•°ä¸­ï¼Œä¼˜åŒ–å™¨ä¸éœ€è¦åœ¨å¼‚å¸¸ä¼ å‡ºå‡½æ•°çš„å‰æä¸‹ï¼Œå°†è¿è¡Œæ—¶æ ˆä¿æŒåœ¨å¯å±•å¼€çŠ¶æ€ï¼›ä¹Ÿä¸éœ€è¦åœ¨å¼‚å¸¸é€¸å‡ºå‡½æ•°çš„å‰æä¸‹ï¼Œä¿è¯æ‰€æœ‰å…¶ä¸­çš„å¯¹è±¡ä»¥å…¶è¢«æ„é€ é¡ºåºçš„é€†åºå®Œæˆææ„ã€‚è€Œé‚£äº›ä»¥<code>throw()</code>å¼‚å¸¸è§„æ ¼å£°æ˜çš„å‡½æ•°å°±äº«å—ä¸åˆ°è¿™æ ·çš„ä¼˜åŒ–çµæ´»æ€§ï¼Œå’Œé‚£äº›æ²¡æœ‰åŠ ä¸Šå¼‚å¸¸è§„æ ¼çš„å‡½æ•°ä¸€æ ·ã€‚</p><p><code>noexcept</code>å±æ€§å¯¹äºç§»åŠ¨æ“ä½œã€swapã€å†…å­˜é‡Šæ”¾å‡½æ•°å’Œææ„å‡½æ•°æœ€æœ‰ä»·å€¼ã€‚C++11 STL ä¸­çš„å¤§éƒ¨åˆ†å‡½æ•°éµå¾ª â€œèƒ½ç§»åŠ¨åˆ™ç§»åŠ¨ï¼Œå¿…é¡»å¤åˆ¶æ‰å¤åˆ¶â€ ç­–ç•¥ï¼Œä½†è¿™å¿…é¡»ä¿è¯åœ¨ä½¿ç”¨ç§»åŠ¨æ“ä½œä»£æ›¿å¤åˆ¶æ“ä½œåï¼Œå‡½æ•°ä¾æ—§å…·å¤‡å¼ºå¼‚å¸¸å®‰å…¨æ€§ã€‚ä¸ºäº†å¾—çŸ¥ç§»åŠ¨æ“ä½œä¼šä¸ä¼šäº§ç”Ÿå¼‚å¸¸ï¼Œå°±éœ€è¦æ ¡éªŒè¿™ä¸ªæ“ä½œæ˜¯å¦å¸¦æœ‰<code>noexcept</code>å£°æ˜ã€‚</p><p><code>swap</code>å‡½æ•°æ˜¯è®¸å¤š STL ç®—æ³•å®ç°çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒçš„å¹¿æ³›ä½¿ç”¨æ˜­ç¤ºç€é’ˆå¯¹å…¶å®æ–½<code>noexcept</code>å£°æ˜å¸¦æ¥çš„æ”¶ç›Šæ˜¯å¯è§‚çš„ã€‚æ ‡å‡†åº“ä¸­çš„<code>swap</code>æ˜¯å¦å¸¦æœ‰<code>noexcept</code>å£°æ˜ï¼Œå–å†³äºç”¨æˆ·å®šä¹‰çš„<code>swap</code>è‡ªèº«ã€‚ä¾‹å¦‚ï¼Œæ ‡å‡†åº“ä¸ºæ•°ç»„å’Œ<code>std::pair</code>å‡†å¤‡çš„<code>swap</code>å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="type">size_t</span> N&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(T (&amp;a)[N],</span></span></span><br><span class="line"><span class="params"><span class="function">          T (&amp;b)[N])</span> <span class="title">noexcept</span><span class="params">(<span class="keyword">noexcept</span>(swap(*a, *b)))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T1</span>, <span class="keyword">class</span> <span class="title class_">T2</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pair</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(pair&amp; p)</span> <span class="title">noexcept</span><span class="params">(<span class="keyword">noexcept</span>(swap(first, p.first)) &amp;&amp;</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">noexcept</span>(swap(second, p.second)))</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™äº›å‡½æ•°å¸¦æœ‰æ¡ä»¶å¼<code>noexcept</code>å£°æ˜ï¼Œå®ƒä»¬åˆ°åº•æ˜¯å¦å…·å¤‡<code>noexcept</code>å±æ€§ï¼Œå–å†³äºå®ƒçš„<code>noexcept</code>åˆ†å¥ä¸­çš„è¡¨è¾¾å¼æ˜¯å¦ç»“æœä¸º<code>noexcept</code>ã€‚åœ¨æ­¤å¤„ï¼Œæ•°ç»„å’Œ<code>std::pair</code>çš„<code>swap</code>å…·å¤‡<code>noexcept</code>å±æ€§çš„å‰ææ˜¯ï¼Œå…¶æ¯ä¸€ä¸ªå…ƒç´ çš„<code>swap</code>éƒ½å…·å¤‡<code>noexcept</code>å±æ€§ã€‚</p><p>å¯¹äºæŸäº›å‡½æ•°æ¥è¯´ï¼Œå…·å¤‡<code>noexcept</code>å±æ€§æ˜¯å¦‚æ­¤ä¹‹é‡è¦ï¼Œæ‰€ä»¥å®ƒä»¬é»˜è®¤å°±æ˜¯å¦‚æ­¤ã€‚åœ¨ C++11 ä¸­ï¼Œå†…å­˜é‡Šæ”¾å‡½æ•°å’Œæ‰€æœ‰çš„ææ„å‡½æ•°éƒ½é»˜è®¤éšå¼åœ°å…·å¤‡<code>noexcept</code>å±æ€§ã€‚ææ„å‡½æ•°æœªéšå¼åœ°å…·å¤‡<code>noexcept</code>å±æ€§çš„å”¯ä¸€æƒ…å†µï¼Œå°±æ˜¯æ‰€æœ‰ç±»ä¸­æœ‰æ•°æ®æˆå‘˜ï¼ˆåŒ…æ‹¬ç»§æ‰¿è€Œæ¥çš„æˆå‘˜ï¼Œä»¥åŠåœ¨å…¶ä»–æ•°æ®æˆå‘˜ä¸­åŒ…å«çš„æ•°æ®æˆå‘˜ï¼‰çš„ç±»å‹æ˜¾å¼åœ°å°†å…¶ææ„å‡½æ•°å£°æ˜ä¸º<code>noexcept(false)</code>ï¼Œå³å¯èƒ½æŠ›å‡ºå¼‚å¸¸ã€‚</p><blockquote><p>ä¸å…·å¤‡<code>noexcept</code>å±æ€§çš„ææ„å‡½æ•°å¾ˆå°‘è§ï¼Œæ ‡å‡†åº“é‡Œä¸€ä¸ªéƒ½æ²¡æœ‰ï¼Œè€Œå¦‚æœæ ‡å‡†åº“ä½¿ç”¨äº†æŸä¸ªå¯¹è±¡ï¼Œå…¶ææ„å‡½æ•°æŠ›å‡ºäº†å¼‚å¸¸ï¼Œåˆ™è¯¥è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚</p></blockquote><p>å¤§å¤šæ•°å‡½æ•°éƒ½æ˜¯<strong>å¼‚å¸¸ä¸­ç«‹ï¼ˆexception-neutralï¼‰</strong> çš„ï¼Œä¸å…·å¤‡<code>noexcept</code>å±æ€§ã€‚æ­¤ç±»å‡½æ•°è‡ªèº«å¹¶ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œä½†å®ƒä»¬è°ƒç”¨çš„å‡½æ•°å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè¿™äº›å¼‚å¸¸ä¼šç»ç”±å¼‚å¸¸ä¸­ç«‹å‡½æ•°ä¼ è‡³è°ƒç”¨æ ˆçš„æ›´æ·±ä¸€å±‚ã€‚</p><p>C++ å…è®¸å¸¦æœ‰<code>noexcept</code>å£°æ˜çš„å‡½æ•°ä¾èµ–äºç¼ºä¹<code>noexcept</code>ä¿è¯çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cleanup</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doWork</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="built_in">setup</span>();</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">cleanup</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæœ‰äº›åº“çš„æ¥å£è®¾è®¡è€…ä¼šæŠŠå‡½æ•°åŒºåˆ†ä¸ºå¸¦æœ‰<strong>å®½æ¾è§„çº¦ï¼ˆwide constractï¼‰</strong> å’Œå¸¦æœ‰<strong>ç‹­éš˜è§„çº¦ï¼ˆnarrow constractï¼‰</strong> çš„ä¸åŒç§ç±»ã€‚å¸¦æœ‰å®½æ¾è§„çº¦çš„å‡½æ•°æ˜¯æ²¡æœ‰å‰ç½®æ¡ä»¶çš„ï¼Œè¦è°ƒç”¨è¿™æ ·çš„å‡½æ•°ä¹Ÿæ— é¡»å…³å¿ƒç¨‹åºçŠ¶æ€ï¼›è€Œå¯¹äºå¸¦æœ‰ç‹­éš˜è§„çº¦çš„å‡½æ•°ï¼Œå¦‚æœå‰ç½®æ¡ä»¶è¢«è¿åï¼Œåˆ™ç»“æœå°†æˆä¸ºæœªå®šä¹‰çš„ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬åªä¼šæŠŠ<code>noexcept</code>å£°æ˜ä¿ç•™ç»™é‚£äº›å¸¦æœ‰å®½æ¾è§„çº¦çš„å‡½æ•°ã€‚</p><h3 id="æ¡æ¬¾-15ï¼šåªè¦æœ‰å¯èƒ½ä½¿ç”¨-constexprï¼Œå°±ä½¿ç”¨å®ƒ">æ¡æ¬¾ 15ï¼šåªè¦æœ‰å¯èƒ½ä½¿ç”¨ constexprï¼Œå°±ä½¿ç”¨å®ƒ</h3><hr><p>constexpræœ¬è´¨ä¸Šæ˜¯constçš„å¢å¼ºå½¢å¼ã€‚</p><p>ä»æ¦‚å¿µä¸Šè®²ï¼Œconstexpr è¡¨ç¤ºä¸ä»…æ˜¯å¸¸é‡ï¼Œè€Œä¸”åœ¨ç¼–è¯‘æ—¶å°±å·²çŸ¥çš„å€¼ã€‚</p><p><strong>å½“ç”¨ç¼–è¯‘æ—¶å¸¸é‡è°ƒç”¨constexprå‡½æ•°æ—¶ï¼Œä¼šäº§ç”Ÿç¼–è¯‘æ—¶å¸¸é‡ã€‚å¦‚æœç”¨è¿è¡Œæ—¶æ‰çŸ¥é“çš„å€¼æ¥è°ƒç”¨ï¼Œåˆ™ä¼šäº§ç”Ÿè¿è¡Œæ—¶å€¼ã€‚è¿™æ„å‘³ç€ä¸éœ€è¦ä¸¤ä¸ªå‡½æ•°æ¥æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œä¸€ä¸ªç”¨äºç¼–è¯‘æ—¶å¸¸é‡ï¼Œä¸€ä¸ªç”¨äºæ‰€æœ‰å…¶ä»–å€¼ã€‚</strong></p><p>è¦ç‚¹</p><ul><li>constexpr å¯¹è±¡æ˜¯å¸¸é‡ï¼Œå¹¶ä¸”ä½¿ç”¨åœ¨ç¼–è¯‘æ—¶å·²çŸ¥çš„å€¼è¿›è¡Œåˆå§‹åŒ–ã€‚</li><li>å½“ä½¿ç”¨ç¼–è¯‘æ—¶å·²çŸ¥å€¼ä½œä¸ºå‚æ•°è°ƒç”¨æ—¶ï¼Œconstexpr å‡½æ•°å¯ä»¥åœ¨ç¼–è¯‘æ—¶äº§ç”Ÿç»“æœã€‚</li><li>constexpr å¯¹è±¡å’Œå‡½æ•°å¯èƒ½æ¯”é constexpr å¯¹è±¡å’Œå‡½æ•°åœ¨æ›´å¹¿æ³›çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ã€‚</li><li>constexpr æ˜¯å¯¹è±¡æˆ–å‡½æ•°æ¥å£çš„ä¸€éƒ¨åˆ†ã€‚</li></ul><hr><p><strong><code>constexpr</code>å¯¹è±¡ï¼š</strong> å…·å¤‡ const å±æ€§ï¼Œå¹¶ç”±ç¼–è¯‘æœŸå·²çŸ¥çš„å€¼å®Œæˆåˆå§‹åŒ–ã€‚</p><p>åœ¨ç¼–è¯‘é˜¶æ®µå°±å·²çŸ¥çš„å€¼æ‹¥æœ‰è®¸å¤šç‰¹æƒï¼Œå®ƒä»¬å¯èƒ½è¢«æ”¾ç½®åœ¨åªè¯»å†…å­˜é‡Œï¼ˆå¯¹äºåµŒå…¥å¼å¼€å‘å°¤ä¸ºé‡è¦ï¼‰ï¼›åœ¨ç¼–è¯‘é˜¶æ®µå°±å·²çŸ¥çš„å¸¸é‡æ•´å‹å€¼å¯ä»¥ç”¨åœ¨ C++ è¦æ±‚æ•´å‹å¸¸é‡è¡¨è¾¾å¼çš„è¯­å¢ƒä¸­ï¼ŒåŒ…æ‹¬æ•°ç»„çš„å°ºå¯¸è§„æ ¼ã€æ•´å‹æ¨¡æ¿å®å‚ã€æšä¸¾é‡çš„å€¼ã€å¯¹é½è§„æ ¼ç­‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sz;                             <span class="comment">// é constexpr å˜é‡</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span> arraySize = sz;          <span class="comment">// æ­£ç¡®ï¼ŒarraySize æ˜¯ sz çš„ä¸€ä¸ª const å‰¯æœ¬</span></span><br><span class="line">std::array&lt;<span class="type">int</span>, arraySize&gt; data;    <span class="comment">// é”™è¯¯ï¼arraySize çš„å€¼éç¼–è¯‘æœŸå¯çŸ¥</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> arraySize1 = sz;     <span class="comment">// é”™è¯¯ï¼sz çš„å€¼åœ¨ç¼–è¯‘æœŸæœªçŸ¥</span></span><br><span class="line">std::array&lt;<span class="type">int</span>, sz&gt; data1;          <span class="comment">// é”™è¯¯ï¼é—®é¢˜åŒä¸Š</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> arraySize2 = <span class="number">10</span>;     <span class="comment">// æ­£ç¡®ï¼Œ10 æ˜¯ç¼–è¯‘æœŸå¸¸é‡</span></span><br><span class="line">std::array&lt;<span class="type">int</span>, arraySize2&gt; data2;  <span class="comment">// æ­£ç¡®ï¼ŒarraySize2 æ˜¯ç¼–è¯‘æœŸå¸¸é‡</span></span><br></pre></td></tr></table></figure><p><strong><code>constexpr</code>å‡½æ•°ï¼š</strong></p><ul><li><code>constexpr</code>å‡½æ•°å¯ä»¥ç”¨åœ¨è¦æ±‚ç¼–è¯‘æœŸå¸¸é‡çš„è¯­å¢ƒä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè‹¥ä¼ ç»™ä¸€ä¸ª<code>constexpr</code>å‡½æ•°çš„å®å‚å€¼æ˜¯åœ¨ç¼–è¯‘æœŸå·²çŸ¥çš„ï¼Œåˆ™ç»“æœä¹Ÿä¼šåœ¨ç¼–è¯‘æœŸè®¡ç®—å‡ºæ¥ï¼›å¦‚æœä»»ä½•ä¸€ä¸ªå®å‚å€¼åœ¨ç¼–è¯‘æœŸæœªçŸ¥ï¼Œåˆ™ä»£ç å°†æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚</li><li><code>constexpr</code>å‡½æ•°ä¹Ÿå¯ä»¥è¿ç”¨åœ¨éç¼–è¯‘æœŸå¸¸é‡çš„è¯­å¢ƒä¸­ï¼Œæ­¤æ—¶ä¼ å…¥çš„å€¼å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªåœ¨ç¼–è¯‘æœŸæœªçŸ¥ã€‚å®ƒçš„è¿ä½œæ–¹å¼å’Œæ™®é€šå‡½æ•°æ— å¼‚ï¼ŒåŒæ ·åœ¨è¿è¡ŒæœŸå®Œæˆç»“æœçš„è®¡ç®—ã€‚</li><li>åœ¨ C++11 ä¸­ï¼Œ<code>constexpr</code>å‡½æ•°ä¸å¾—åŒ…å«å¤šäºä¸€ä¸ªå¯æ‰§è¡Œè¯­å¥ï¼Œå³ä¸€æ¡<code>return</code>è¯­å¥ï¼›è€Œåˆ°äº† C++14ï¼Œå°±æ²¡æœ‰äº†è¿™ç§é™åˆ¶ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="type">int</span> <span class="title">pow</span><span class="params">(<span class="type">int</span> base, <span class="type">int</span> exp)</span> <span class="keyword">noexcept</span> </span>&#123;     <span class="comment">// C++11</span></span><br><span class="line">    <span class="keyword">return</span> (exp == <span class="number">0</span> ? <span class="number">1</span> : base * <span class="built_in">pow</span>(base, exp - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="type">int</span> <span class="title">pow</span><span class="params">(<span class="type">int</span> base, <span class="type">int</span> exp)</span> <span class="keyword">noexcept</span> </span>&#123;     <span class="comment">// C++14</span></span><br><span class="line">    <span class="keyword">auto</span> result = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; exp; ++i) result *= base;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> numConds = <span class="number">5</span>;</span><br><span class="line">std::array&lt;<span class="type">int</span>, pow(3, numConds)&gt; results;</span><br></pre></td></tr></table></figure><p><code>constexpr</code>å‡½æ•°ä»…é™äºä¼ å…¥å’Œè¿”å›<strong>å­—é¢ç±»å‹ï¼ˆliteral typeï¼‰</strong>ï¼Œè¿™äº›ç±»å‹èƒ½å¤ŸæŒæœ‰ç¼–è¯‘æœŸå¯ä»¥å†³è®®çš„å€¼ã€‚åœ¨ C++11 ä¸­ï¼Œé™¤äº†<code>void</code>çš„æ‰€æœ‰å†…å»ºç±»å‹éƒ½æ˜¯å­—é¢ç±»å‹ï¼›æ­¤å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å­—é¢ç±»å‹ï¼Œè¿™éœ€è¦å°†å…¶æ„é€ å‡½æ•°å’Œéƒ¨åˆ†æˆå‘˜å‡½æ•°å£°æ˜ä¸º<code>constexpr</code>å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="title">Point</span><span class="params">(<span class="type">double</span> xVal = <span class="number">0</span>, <span class="type">double</span> yVal = <span class="number">0</span>)</span> <span class="keyword">noexcept</span> :</span></span><br><span class="line"><span class="function">        x(xVal), y(yVal) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="type">double</span> <span class="title">xValue</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">return</span> x; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="type">double</span> <span class="title">yValue</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">return</span> y; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setX</span><span class="params">(<span class="type">double</span> newX)</span> <span class="keyword">noexcept</span> </span>&#123; x = newX; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setY</span><span class="params">(<span class="type">double</span> newY)</span> <span class="keyword">noexcept</span> </span>&#123; y = newY; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> x, y;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> Point <span class="title">p1</span><span class="params">(<span class="number">9.4</span>, <span class="number">27.7</span>)</span></span>;  <span class="comment">// åœ¨ç¼–è¯‘æœŸæ‰§è¡Œ constexpr æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> Point <span class="title">p2</span><span class="params">(<span class="number">28.8</span>, <span class="number">5.3</span>)</span></span>;  <span class="comment">// åŒä¸Š</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> Point <span class="title">midpoint</span><span class="params">(<span class="type">const</span> Point&amp; p1, <span class="type">const</span> Point&amp; p2)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; (p1.<span class="built_in">xValue</span>() + p2.<span class="built_in">xValue</span>()) / <span class="number">2</span>,</span><br><span class="line">             (p1.<span class="built_in">yValue</span>() + p2.<span class="built_in">yValue</span>()) / <span class="number">2</span> &#125;; <span class="comment">// è°ƒç”¨ constexpr æˆå‘˜å‡½æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> mid = <span class="built_in">midpoint</span>(p1, p2);  <span class="comment">// ä½¿ç”¨ constexpr å‡½æ•°çš„è¿”å›å€¼æ¥åˆå§‹åŒ– constexpr å¯¹è±¡</span></span><br></pre></td></tr></table></figure><p>åœ¨ C++14 ä¸­ï¼Œå°±è¿è¿”å›å€¼ç±»å‹ä¸º<code>void</code>çš„ setter å‡½æ•°ä¹Ÿå¯ä»¥å£°æ˜ä¸º<code>constexpr</code>å‡½æ•°ï¼Œè¿™å°±ä½¿ä»¥ä¸‹ä»£ç å˜ä¸ºå¯èƒ½ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="type">void</span> <span class="title">setX</span><span class="params">(<span class="type">double</span> newX)</span> <span class="keyword">noexcept</span> </span>&#123; x = newX; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="type">void</span> <span class="title">setY</span><span class="params">(<span class="type">double</span> newY)</span> <span class="keyword">noexcept</span> </span>&#123; y = newY; &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> Point <span class="title">reflection</span><span class="params">(<span class="type">const</span> Point&amp; p)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    Point result;</span><br><span class="line"></span><br><span class="line">    result.<span class="built_in">setX</span>(-p.<span class="built_in">xValue</span>());</span><br><span class="line">    result.<span class="built_in">setY</span>(-p.<span class="built_in">yValue</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> reflectionMid = <span class="built_in">reflection</span>(mid);</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€æ—¦ä½ æŠŠä¸€ä¸ªå¯¹è±¡æˆ–å‡½æ•°å£°æ˜æˆäº†<code>constexpr</code>ï¼Œè€Œåæ¥ä½ åˆæ„Ÿè§‰å¯¹<code>constexpr</code>è¿ç”¨ä¸å½“ï¼Œç„¶åè¿›è¡Œäº†ç§»é™¤ï¼Œé‚£ä¹ˆè¿™ä¼šå¯¼è‡´éå¸¸å¤šå®¢æˆ·ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚å› æ­¤ï¼Œâ€œåªè¦æœ‰å¯èƒ½ä½¿ç”¨<code>constexpr</code>ï¼Œå°±ä½¿ç”¨å®ƒâ€ è¿™å¥è¯ä¸­çš„ â€œåªè¦æœ‰å¯èƒ½â€ çš„å«ä¹‰å°±æ˜¯ä½ æ˜¯å¦æœ‰ä¸€ä¸ªé•¿æœŸçš„æ‰¿è¯ºï¼Œå°†ç”±<code>constexpr</code>å¸¦æ¥çš„ç§ç§é™åˆ¶æ–½åŠ äºç›¸å…³çš„å‡½æ•°å’Œå¯¹è±¡ä¸Šã€‚</p><h3 id="æ¡æ¬¾-16ï¼šä¿è¯-const-æˆå‘˜å‡½æ•°çš„çº¿ç¨‹å®‰å…¨æ€§">æ¡æ¬¾ 16ï¼šä¿è¯ const æˆå‘˜å‡½æ•°çš„çº¿ç¨‹å®‰å…¨æ€§</h3><hr><p>è¦ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Polynomial</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">Â  Â  using RootsType = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">double</span>&gt;;</span><br><span class="line">Â  Â  RootsType <span class="title function_">roots</span><span class="params">()</span> <span class="type">const</span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title function_">g</span><span class="params">(m)</span>; <span class="comment">// é”å®šmutex</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> (!rootsAreValid) &#123; <span class="comment">// å¦‚æœç¼“å­˜æ— æ•ˆ</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  â€¦ <span class="comment">// è®¡ç®—/å­˜å‚¨ rootVals</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  rootsAreValid = <span class="literal">true</span>;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> rootVals;</span><br><span class="line">Â  Â  &#125; <span class="comment">// è§£é”mutex</span></span><br><span class="line">private:</span><br><span class="line">Â  Â  mutable <span class="built_in">std</span>::mutex m;</span><br><span class="line">Â  Â  mutable <span class="type">bool</span> rootsAreValid&#123; <span class="literal">false</span> &#125;;</span><br><span class="line">Â  Â  mutable RootsType rootVals&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>é‡ç‚¹1</strong>ï¼šä¸šåŠ¡é€»è¾‘è®¤ä¸ºå¯æ”¹ï¼ŒåŠ mutableå…³é”®å­—ã€‚mutableå…³é”®å­—ç”¨äºå…è®¸åœ¨å¸¸é‡å‡½æ•°ï¼ˆå¦‚rootsï¼‰ä¸­ä¿®æ”¹ç±»çš„æŸäº›æˆå‘˜å˜é‡ã€‚</p><p><strong>é‡ç‚¹2</strong>ï¼šç”±äºstd::mutexæ˜¯ä¸€ç§ä»…å¯ç§»åŠ¨ç±»å‹ï¼Œå°†mæ·»åŠ åˆ°Polynomialï¼Œå°†å¯¼è‡´Polynomialå¤±å»äº†è¢«å¤åˆ¶çš„èƒ½åŠ›ã€‚ã€ä¸std::mutexä¸€æ ·ï¼Œstd::atomicä¹Ÿæ˜¯ä»…å¯ç§»åŠ¨ç±»å‹ï¼Œå› æ­¤Pointä¸­å­˜åœ¨callCountæ„å‘³ç€Pointä¹Ÿæ˜¯ä»…å¯ç§»åŠ¨çš„ã€‚ã€‘</p><hr><p>å¯¹äº const æˆå‘˜å‡½æ•°ï¼Œæˆ‘ä»¬é€šå¸¸è®¤ä¸ºå®ƒä»£è¡¨çš„æ˜¯è¯»æ“ä½œï¼Œè€Œå¤šä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹æ‰§è¡Œè¯»æ“ä½œåº”è¯¥æ˜¯å®‰å…¨çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ const æˆå‘˜å‡½æ•°çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œé™¤éå¯ä»¥ç¡®ä¿¡å®ƒä»¬ä¸ä¼šåœ¨å¹¶å‘è¯­å¢ƒä¸­è¢«ä½¿ç”¨ã€‚</p><p>è€ƒè™‘å¦‚ä¸‹æƒ…å½¢ï¼Œæˆ‘ä»¬å°†è®¡ç®—å‡ºçš„å¤šé¡¹å¼çš„æ ¹å­˜å…¥ç¼“å­˜ä¸­ï¼Œä»¥é¿å…ä»£ä»·é«˜æ˜‚çš„é‡å¤è®¡ç®—ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Polynomial</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> RootsType = std::vector&lt;<span class="type">double</span>&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function">RootsType <span class="title">roots</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!rootsAreValid) &#123;       <span class="comment">// å¦‚æœç¼“å­˜æ— æ•ˆ</span></span><br><span class="line">            ...</span><br><span class="line">            rootsAreValid = <span class="literal">true</span>;   <span class="comment">// åˆ™è®¡ç®—æ ¹ï¼Œå¹¶å°†å…¶å­˜å…¥ rootVals</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rootsVals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">bool</span> rootsAreValid&#123; <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="keyword">mutable</span> RootsType rootVals&#123;&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç”±äº mutable æˆå‘˜å˜é‡çš„å­˜åœ¨ï¼Œå¯èƒ½æœ‰ä¸åŒçš„å¤šä¸ªçº¿ç¨‹é€šè¿‡<code>roots</code>æˆå‘˜å‡½æ•°åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹è¯»å†™åŒä¸€å—å†…å­˜ï¼Œé€ æˆ<strong>æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰</strong>ï¼Œè¿™ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºçš„å‡ºç°ã€‚</p><p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ€ç®€å•çš„æ–¹æ³•ä¹Ÿæ˜¯æœ€å¸¸è§çš„ï¼Œå¼•å…¥ä¸€ä¸ª mutex äº’æ–¥é‡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Polynomial</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> RootsType = std::vector&lt;<span class="type">double</span>&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function">RootsType <span class="title">roots</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">g</span><span class="params">(m)</span></span>;   <span class="comment">// äº’æ–¥é‡åŠ é”</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!rootsAreValid) &#123;       <span class="comment">// å¦‚æœç¼“å­˜æ— æ•ˆ</span></span><br><span class="line">            ...</span><br><span class="line">            rootsAreValid = <span class="literal">true</span>;   <span class="comment">// åˆ™è®¡ç®—æ ¹ï¼Œå¹¶å°†å…¶å­˜å…¥ rootVals</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rootsVals;</span><br><span class="line">    &#125;                                       <span class="comment">// äº’æ–¥é‡è§£é”</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex m;                   <span class="comment">// æ·»åŠ  mutable çš„äº’æ–¥é‡</span></span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">bool</span> rootsAreValid&#123; <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="keyword">mutable</span> RootsType rootVals&#123;&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨<code>std::atomic</code>ç±»å‹çš„å˜é‡ï¼Œè¿™ä¼šæ¯”ä½¿ç”¨äº’æ–¥é‡æä¾›æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ›´é€‚ç”¨äºå¯¹å•ä¸ªå˜é‡æˆ–å†…å­˜åŒºåŸŸçš„æ“ä½œã€‚ä»¥ä¸‹æƒ…å†µæ›´é€‚åˆä½¿ç”¨<code>std::atomic</code>æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">distanceFromOrigin</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        ++callCount;                                <span class="comment">// å¸¦åŸå­æ€§çš„è‡ªå¢æ“ä½œ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">sqrt</span>((x * x) + (y * y));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> std::atomic&lt;<span class="type">unsigned</span>&gt; callCount&#123; <span class="number">0</span> &#125;;   <span class="comment">// å­˜å‚¨è°ƒç”¨æ¬¡æ•°</span></span><br><span class="line">    <span class="type">double</span> x, y;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ— è®ºæ˜¯<code>std::mutex</code>è¿˜æ˜¯<code>std::atomic</code>éƒ½æ˜¯åªç§»ç±»å‹ï¼Œæ— æ³•è¿›è¡Œå¤åˆ¶ï¼Œå› æ­¤åŠ å…¥å®ƒä»¬éƒ½ä¼šä½¿ç±»å¤±å»å¯å¤åˆ¶æ€§ï¼Œä½†ä»ç„¶å¯ä»¥ç§»åŠ¨ã€‚</p><h3 id="æ¡æ¬¾-17ï¼šç†è§£ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„ç”Ÿæˆæœºåˆ¶">æ¡æ¬¾ 17ï¼šç†è§£ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„ç”Ÿæˆæœºåˆ¶</h3><hr><p><strong>è¦ç‚¹</strong></p><ul><li>ç‰¹æ®Šæˆå‘˜å‡½æ•°æ˜¯ç¼–è¯‘å™¨å¯ä»¥è‡ªå·±ç”Ÿæˆçš„å‡½æ•°ï¼šé»˜è®¤æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ã€æ‹·è´æ“ä½œå’Œç§»åŠ¨æ“ä½œã€‚</li><li>åªæœ‰æ²¡æœ‰æ˜¾å¼å£°æ˜ç§»åŠ¨æ“ä½œã€æ‹·è´æ“ä½œå’Œææ„å‡½æ•°çš„ç±»æ‰ä¼šç”Ÿæˆç§»åŠ¨æ“ä½œã€‚</li><li>åªæœ‰æ²¡æœ‰æ˜¾å¼å£°æ˜æ‹·è´æ„é€ å‡½æ•°çš„ç±»æ‰ä¼šç”Ÿæˆæ‹·è´æ„é€ å‡½æ•°ï¼Œå¦‚æœå£°æ˜äº†ç§»åŠ¨æ“ä½œï¼Œå°±ä¼šåˆ é™¤æ‹·è´æ„é€ å‡½æ•°ã€‚</li><li>åªæœ‰æ²¡æœ‰æ˜¾å¼å£°æ˜æ‹·è´èµ‹å€¼æ“ä½œç¬¦çš„ç±»æ‰ä¼šç”Ÿæˆæ‹·è´èµ‹å€¼æ“ä½œç¬¦ï¼Œå¦‚æœå£°æ˜äº†ç§»åŠ¨æ“ä½œç¬¦ï¼Œå°±ä¼šåˆ é™¤å®ƒã€‚ä¸èµ</li><li>æˆåœ¨æ˜¾å¼å£°æ˜ææ„å‡½æ•°çš„ç±»ä¸­ç”Ÿæˆæ‹·è´æ“ä½œã€‚</li><li>æˆå‘˜å‡½æ•°æ¨¡æ¿æ°¸è¿œä¸ä¼šæŠ‘åˆ¶ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„ç”Ÿæˆã€‚</li></ul><hr><p>åœ¨ C++11 ä¸­ï¼Œæ”¯é…ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„æœºåˆ¶å¦‚ä¸‹ï¼ˆæ‰€æœ‰ç”Ÿæˆçš„é»˜è®¤ç‰¹æ®Šå‡½æ•°éƒ½æ˜¯ inline çš„ï¼Œä¸”å…·æœ‰ public è®¿é—®æƒé™ï¼‰ï¼š</p><ul><li><strong>é»˜è®¤æ„é€ å‡½æ•°ï¼š</strong> ä¸ C++98 çš„æœºåˆ¶ç›¸åŒã€‚ä»…å½“ç±»ä¸­ä¸åŒ…å«ç”¨æˆ·å£°æ˜çš„æ„é€ å‡½æ•°æ—¶æ‰ç”Ÿæˆã€‚</li><li><strong>ææ„å‡½æ•°ï¼š</strong> ä¸ C++98 çš„æœºåˆ¶åŸºæœ¬ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºææ„å‡½æ•°é»˜è®¤ä¸º noexceptï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 14</strong>ï¼‰ã€‚ä»…å½“åŸºç±»çš„ææ„å‡½æ•°ä¸ºè™šæ—¶ï¼Œæ´¾ç”Ÿç±»çš„ææ„å‡½æ•°æ‰ä¸ºè™šã€‚</li><li><strong>æ‹·è´æ„é€ å‡½æ•°ï¼š</strong> è¿è¡ŒæœŸè¡Œä¸ºä¸ C++98 ç›¸åŒï¼š<strong>æŒ‰æˆå‘˜</strong>è¿›è¡Œ<strong>éé™æ€</strong>æ•°æ®æˆå‘˜çš„æ‹·è´æ„é€ ã€‚ä»…å½“ç±»ä¸­ä¸åŒ…å«ç”¨æˆ·å£°æ˜çš„æ‹·è´æ„é€ å‡½æ•°æ—¶æ‰ç”Ÿæˆã€‚å¦‚æœè¯¥ç±»å£°æ˜äº†ç§»åŠ¨æ“ä½œï¼Œåˆ™æ‹·è´æ„é€ å‡½æ•°å°†è¢«åˆ é™¤ã€‚åœ¨å·²ç»å­˜åœ¨æ‹·è´èµ‹å€¼è¿ç®—ç¬¦æˆ–ææ„å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œä»ç„¶ç”Ÿæˆæ‹·è´æ„é€ å‡½æ•°å·²ç»æˆä¸ºäº†è¢«åºŸå¼ƒçš„è¡Œä¸ºï¼ˆä½†æœªè¢«ç¦æ­¢ï¼‰ï¼ŒåŸå› è§ä¸‰è€…æ³•åˆ™ã€‚</li><li><strong>æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼š</strong> è¿è¡ŒæœŸè¡Œä¸ºä¸ C++98 ç›¸åŒï¼š<strong>æŒ‰æˆå‘˜</strong>è¿›è¡Œ<strong>éé™æ€</strong>æ•°æ®æˆå‘˜çš„æ‹·è´èµ‹å€¼ã€‚ä»…å½“ç±»ä¸­ä¸åŒ…å«ç”¨æˆ·å£°æ˜çš„æ‹·è´èµ‹å€¼è¿ç®—ç¬¦æ—¶æ‰ç”Ÿæˆã€‚å¦‚æœè¯¥ç±»å£°æ˜äº†ç§»åŠ¨æ“ä½œï¼Œåˆ™æ‹·è´èµ‹å€¼è¿ç®—ç¬¦å°†è¢«åˆ é™¤ã€‚åœ¨å·²ç»å­˜åœ¨æ‹·è´æ„é€ å‡½æ•°æˆ–ææ„å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œä»ç„¶ç”Ÿæˆæ‹·è´æ„é€ å‡½æ•°å·²ç»æˆä¸ºäº†è¢«åºŸå¼ƒçš„è¡Œä¸ºï¼ˆä½†æœªè¢«ç¦æ­¢ï¼‰ï¼ŒåŸå› è§ä¸‰è€…æ³•åˆ™ã€‚</li></ul><blockquote><p><strong>ä¸‰è€…æ³•åˆ™ï¼ˆRule of Threeï¼‰ï¼š</strong> å¦‚æœä½ å£°æ˜äº†æ‹·è´æ„é€ å‡½æ•°ã€æ‹·è´èµ‹å€¼è¿ç®—ç¬¦æˆ–ææ„å‡½æ•°ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œä½ å°±å¾—åŒæ—¶å£°æ˜æ‰€æœ‰è¿™ä¸‰ä¸ªã€‚<br>ä¸‰è€…æ³•åˆ™æ ¹æ¤äºè¿™æ ·çš„æ€æƒ³ï¼šå¦‚æœæœ‰æ”¹å†™æ‹·è´æ“ä½œçš„éœ€æ±‚ï¼Œå¾€å¾€æ„å‘³ç€è¯¥ç±»éœ€è¦æ‰§è¡ŒæŸç§èµ„æºç®¡ç†ï¼Œè€Œè¿™å°±æ„å‘³ç€ï¼š<br>\1. åœ¨ä¸€ç§æ‹·è´æ“ä½œä¸­è¿›è¡Œçš„ä»»ä½•èµ„æºç®¡ç†ï¼Œä¹Ÿææœ‰å¯èƒ½åœ¨å¦ä¸€ç§æ‹·è´æ“ä½œä¸­ä¹Ÿéœ€è¦è¿›è¡Œã€‚<br>\2. è¯¥ç±»çš„ææ„å‡½æ•°ä¹Ÿä¼šå‚ä¸åˆ°è¯¥èµ„æºçš„ç®¡ç†ä¸­ï¼ˆé€šå¸¸æ˜¯å¯¹èµ„æºè¿›è¡Œé‡Šæ”¾ï¼‰ã€‚<br>ä¸‰è€…æ³•åˆ™å¯¹ç§»åŠ¨æ“ä½œä¹ŸåŒæ ·æˆç«‹ã€‚</p></blockquote><ul><li><strong>ç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼š</strong> éƒ½<strong>æŒ‰æˆå‘˜</strong>è¿›è¡Œ<strong>éé™æ€</strong>æ•°æ®æˆå‘˜çš„ç§»åŠ¨æ“ä½œã€‚ä»…å½“ç±»ä¸­ä¸åŒ…å«ç”¨æˆ·å£°æ˜çš„æ‹·è´æ“ä½œã€ç§»åŠ¨æ“ä½œå’Œææ„å‡½æ•°æ—¶æ‰ç”Ÿæˆã€‚å£°æ˜ä¸€ä¸ªç§»åŠ¨æ„é€ å‡½æ•°ä¼šé˜»æ­¢ç¼–è¯‘å™¨ç”Ÿæˆç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼Œè€Œå£°æ˜ä¸€ä¸ªç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ä¹Ÿä¼šé˜»æ­¢ç¼–è¯‘å™¨ç”Ÿæˆç§»åŠ¨æ„é€ å‡½æ•°ã€‚</li></ul><blockquote><p>å£°æ˜æ‹·è´æ“ä½œï¼ˆæ— è®ºæ˜¯æ‹·è´æ„é€ è¿˜æ˜¯æ‹·è´èµ‹å€¼ï¼‰çš„è¡Œä¸ºè¡¨æ˜äº†å¯¹è±¡çš„å¸¸è§„æ‹·è´æ–¹å¼ï¼ˆæŒ‰æˆå‘˜æ‹·è´ï¼‰å¯¹äºè¯¥ç±»å¹¶ä¸é€‚ç”¨ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±ä¼šè®¤ä¸ºæŒ‰æˆå‘˜ç§»åŠ¨ææœ‰å¯èƒ½ä¹Ÿä¸é€‚ç”¨äºç§»åŠ¨æ“ä½œã€‚å› æ­¤ï¼Œä¸€æ—¦æ˜¾å¼å£°æ˜äº†æ‹·è´æ“ä½œï¼Œç¼–è¯‘å™¨å°±ä¸å†ä¼šä¸ºå…¶ç”Ÿæˆç§»åŠ¨æ“ä½œï¼Œåä¹‹äº¦ç„¶ã€‚</p></blockquote><p>å¦‚æœä½ æœ‰ä¸€äº›ä»£ç ä¾èµ–äºç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ç‰¹æ®Šå‡½æ•°ï¼Œå¹¶ä¸”ä½ ç¡®ä¿¡è¿™äº›å‡½æ•°ä¼šæ­£ç¡®æ‰§è¡Œï¼Œé‚£ä¹ˆå¯ä»¥ç”¨<code>=default</code>æ˜¾å¼æŒ‡å®šè®©å®ƒä»¬ç”Ÿæˆï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base</span>() = <span class="keyword">default</span>;              <span class="comment">// ä½¿ææ„å‡½æ•°æˆä¸ºè™šçš„</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">Base</span>(Base&amp;&amp;) = <span class="keyword">default</span>;                 <span class="comment">// æä¾›ç§»åŠ¨æ“ä½œçš„æ”¯æŒ</span></span><br><span class="line">    Base&amp; <span class="keyword">operator</span>=(Base&amp;&amp;) = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Base</span>(<span class="type">const</span> Base&amp;) = <span class="keyword">default</span>;            <span class="comment">// æä¾›æ‹·è´æ“ä½œçš„æ”¯æŒ</span></span><br><span class="line">    Base&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Base&amp;) = <span class="keyword">default</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆå‘˜å‡½æ•°æ¨¡æ¿åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šæŠ‘åˆ¶ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„ç”Ÿæˆï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªç±»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="title">Widget</span><span class="params">(<span class="type">const</span> T&amp; rhs)</span></span>;               <span class="comment">// ä»¥ä»»æ„ç±»å‹æ„é€  Widget</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>=(<span class="type">const</span> T&amp; rhs);    <span class="comment">// ä»¥ä»»æ„ç±»å‹å¯¹ Widget èµ‹å€¼</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨ä¼šå§‹ç»ˆç”Ÿæˆ<code>Widget</code>çš„æ‹·è´å’Œç§»åŠ¨æ“ä½œï¼Œå³ä½¿è¿™äº›æ¨¡æ¿çš„å…·ç°åŒ–ç”Ÿæˆäº†æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„å‡½æ•°ç­¾åã€‚</p><h2 id="ç¬¬å››ç« ï¼šæ™ºèƒ½æŒ‡é’ˆ">ç¬¬å››ç« ï¼šæ™ºèƒ½æŒ‡é’ˆ</h2><p>ä»¥ä¸‹ç†ç”±ä½¿å¾—è£¸æŒ‡é’ˆä¸å—æ¬¢è¿ï¼š</p><ol><li>è£¸æŒ‡é’ˆæ²¡æœ‰åœ¨å£°æ˜ä¸­æŒ‡å‡ºï¼Œå…¶æŒ‡å‘çš„å†…å®¹æ˜¯å•ä¸ªå¯¹è±¡è¿˜æ˜¯æ•°ç»„ã€‚</li><li>è£¸æŒ‡é’ˆæ²¡æœ‰åœ¨å£°æ˜ä¸­æŒ‡å‡ºï¼Œæ˜¯å¦è¯¥åœ¨å…¶æŒ‡å‘çš„å¯¹è±¡ä½¿ç”¨å®Œåè¿›è¡Œææ„ã€‚</li><li>æ— æ³•å¾—çŸ¥æ€æ ·ææ„è£¸æŒ‡é’ˆæ‰æ˜¯é€‚å½“çš„ï¼Œæ˜¯ä½¿ç”¨<code>delete</code>è¿ç®—ç¬¦ï¼Œè¿˜æ˜¯æœ‰ä¸“é—¨ç”¨äºææ„çš„å‡½æ•°ã€‚</li><li>åœ¨å·²çŸ¥ä½¿ç”¨<code>delete</code>çš„æƒ…å†µä¸‹ï¼Œéš¾ä»¥ç¡®å®šè¯¥ç”¨<code>delete</code>è¿˜æ˜¯<code>delete[]</code>ã€‚</li><li>å¾ˆéš¾ä¿è¯å¯¹æŒ‡é’ˆæ‰€æŒ‡å‘å¯¹è±¡çš„ææ„ï¼Œåœ¨æ‰€æœ‰ä»£ç è·¯å¾„ä¸Šåªæ‰§è¡Œä¸€æ¬¡ã€‚</li><li>æ²¡æœ‰æ­£è§„çš„æ–¹å¼æ¥æ£€æµ‹æŒ‡é’ˆæ˜¯å¦ç©ºæ‚¬ï¼ˆdangleï¼‰ã€‚</li></ol><p>å› æ­¤ï¼Œåœ¨å¤§å¤šæ•°æ—¶å€™ï¼Œåº”è¯¥ä¼˜å…ˆé€‰ç”¨æ™ºèƒ½æŒ‡é’ˆã€‚<code>std::auto_ptr</code>æ˜¯ä» C++98 ä¸­æ®‹ç•™ä¸‹æ¥çš„å¼ƒç”¨ç‰¹æ€§ï¼Œåº”è¯¥è¢« C++11 ä¸­çš„ <code>std::unique_ptr</code>æ‰€æ›¿ä»£ã€‚</p><h3 id="æ¡æ¬¾-18ï¼šä½¿ç”¨-std-unique-ptr-ç®¡ç†å…·å¤‡ä¸“å±æ‰€æœ‰æƒçš„èµ„æº">æ¡æ¬¾ 18ï¼šä½¿ç”¨ std::unique_ptr ç®¡ç†å…·å¤‡ä¸“å±æ‰€æœ‰æƒçš„èµ„æº</h3><hr><p>æŒ‡é’ˆåªèƒ½æŒ‡å‘ä¸€ä¸ªåœ°æ–¹ï¼Œå¹¶ä¸”æŒ‡å‘çš„åœ°æ–¹å¯ä»¥æ›´æ”¹ã€é€šè¿‡ç§»åŠ¨æ“ä½œã€‘ï¼Œå¯¹æ¯”auto_ptr.</p><p><strong>è¦ç‚¹</strong>ï¼š</p><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œstd::unique_pträ¸åŸå§‹æŒ‡é’ˆå…·æœ‰ç›¸åŒçš„å¤§å°ï¼Œå¹¶ä¸”å¯¹äºå¤§å¤šæ•°æ“ä½œï¼ˆåŒ…æ‹¬è§£å¼•ç”¨ï¼‰ï¼Œå®ƒä»¬æ‰§è¡Œå®Œå…¨ç›¸åŒçš„æŒ‡ä»¤ã€‚</li><li>std::unique_ptr ä½“ç°äº†ç‹¬å æ‰€æœ‰æƒè¯­ä¹‰ï¼Œæ€»æ˜¯æ‹¥æœ‰å®ƒæ‰€æŒ‡å‘çš„å¯¹è±¡</li><li>ç§»åŠ¨std::unique_pträ¼šå°†æ‰€æœ‰æƒä»æºæŒ‡é’ˆè½¬ç§»åˆ°ç›®æ ‡æŒ‡é’ˆï¼ˆæºæŒ‡é’ˆè¢«è®¾ç½®ä¸º nullï¼‰</li><li>ä¸å…è®¸æ‹·è´std::unique_ptrï¼Œå› æ­¤å®ƒæ˜¯ä¸€ç§åªç§»åŠ¨ç±»å‹</li><li>é”€æ¯æ—¶ï¼Œéç©ºstd::unique_pträ¼šé”€æ¯å…¶èµ„æºã€‚é»˜è®¤é€šè¿‡å¯¹å†…éƒ¨çš„åŸå§‹æŒ‡é’ˆåº”ç”¨deleteæ¥å®Œæˆ</li></ul><p>ä½¿ç”¨é»˜è®¤åˆ é™¤å™¨ï¼ˆå³deleteï¼‰ä½¿ç”¨æ—¶ï¼Œstd::unique_ptr å¯¹è±¡ä¸åŸå§‹æŒ‡é’ˆå¤§å°ç›¸åŒã€‚</p><ul><li><strong>å½“ä½¿ç”¨è‡ªå®šä¹‰åˆ é™¤å™¨æ—¶ï¼Œå‡½æ•°æŒ‡é’ˆç±»å‹çš„åˆ é™¤å™¨é€šå¸¸ä¼šä½¿ std::unique_ptr çš„å¤§å°ä»ä¸€ä¸ªå­—å¢é•¿åˆ°ä¸¤ä¸ªå­—</strong></li><li><strong>å¯¹äºå‡½æ•°å¯¹è±¡ç±»å‹çš„åˆ é™¤å™¨ï¼Œå¤§å°çš„å˜åŒ–å–å†³äºå‡½æ•°å¯¹è±¡ä¸­å­˜å‚¨çš„çŠ¶æ€çš„æ•°é‡</strong>ã€‚æ— çŠ¶æ€çš„å‡½æ•°å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œæ²¡æœ‰æ•è·çš„ lambda è¡¨è¾¾å¼ï¼‰æ²¡æœ‰è€Œå¤–çš„è´Ÿæ‹…</li></ul><p>ç®€å•ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;locale&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>()&#123;&#125;;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">int</span> a)&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// A *a = new A;</span></span><br><span class="line">    <span class="keyword">auto</span> fun = [](A *a)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;debug&quot;</span>);</span><br><span class="line">        <span class="keyword">delete</span> a;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;A, <span class="title">decltype</span><span class="params">(fun)</span>&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> A, fun)</span></span>;<span class="comment">// è‡ªå®šä¹‰åˆ é™¤å™¨</span></span><br><span class="line">    <span class="comment">// std::unique_ptr&lt;A, void (*)(A *)&gt; p(new A, fun);</span></span><br><span class="line">    <span class="function">std::unique_ptr&lt;A&gt; <span class="title">p1</span><span class="params">(<span class="keyword">new</span> A)</span></span>;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;A&gt; <span class="title">p2</span><span class="params">(std::move(p1))</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><code>std::unique_ptr</code>æ˜¯å°å·§ã€é«˜é€Ÿçš„ã€å…·å¤‡åªç§»ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå¯¹äºæ‰˜ç®¡çš„æŒ‡é’ˆå®æ–½ä¸“å±æ‰€æœ‰æƒè¯­ä¹‰ã€‚å®ƒå’Œè£¸æŒ‡é’ˆæ‰€å å¤§å°ç›¸åŒï¼Œå¹¶ä¸”ä¸å…è®¸è¢«æ‹·è´ï¼Œåœ¨æ‰§è¡Œææ„æ“ä½œæ—¶ï¼ŒåŒæ—¶ææ„å…¶æ‰€ç®¡ç†çš„èµ„æºã€‚</p><p><code>std::unique_ptr</code>çš„ä¸€ä¸ªå¸¸è§ç”¨æ³•æ˜¯åœ¨ç»§æ‰¿ä½“ç³»ä¸­ï¼Œä½œä¸ºå·¥å‚å‡½æ•°çš„è¿”å›å€¼ç±»å‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Investment</span> &#123; </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Investment</span>();  <span class="comment">// å¿…å¤‡çš„è™šææ„å‡½æ•°ï¼</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Stock</span> : <span class="keyword">public</span> Investment &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bond</span> : <span class="keyword">public</span> Investment &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealEstate</span> : <span class="keyword">public</span> Investment &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;Investment&gt; <span class="title">makeInvestment</span><span class="params">(Ts&amp;&amp;... params)</span></span>; <span class="comment">// è¿”å› std::unique_ptr</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">auto</span> pInvestment = <span class="built_in">makeInvestment</span>( arguments );</span><br><span class="line">    ...</span><br><span class="line">&#125;   <span class="comment">// *pInvestment åœ¨æ­¤å¤„ææ„</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤åœ°ï¼Œèµ„æºææ„é‡‡ç”¨<code>delete</code>è¿ç®—ç¬¦æ¥å®Œæˆï¼Œä½†ä¹Ÿå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œå¹¶ä¸”åˆ é™¤å™¨å°†ä¼šè¢«è§†ä½œ<code>std::unique_ptr</code>ç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ä½¿ç”¨äº† lambda è¡¨è¾¾å¼ä½œä¸ºè‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œå¹¶åœ¨åˆ é™¤æ—¶å†™å…¥ä¸€æ¡æ—¥å¿—ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> delInvmt = [](Investment* pInvestment) &#123;</span><br><span class="line">    <span class="built_in">makeLogEntry</span>(pInvestment);</span><br><span class="line">    <span class="keyword">delete</span> pInvestment;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;Investment, <span class="title">decltype</span><span class="params">(delInvmt)</span>&gt; <span class="title">makeInvestment</span><span class="params">(Ts&amp;&amp;... params)</span></span>; <span class="comment">// æ”¹è¿›åçš„è¿”å›å€¼ç±»å‹</span></span><br></pre></td></tr></table></figure><p>åœ¨ C++14 ä¸­ï¼Œç”±äºæœ‰äº†å‡½æ•°è¿”å›å€¼ç±»å‹æ¨å¯¼ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 3</strong>ï¼‰ï¼Œ<code>makeInvestment</code>å¯ä»¥ç”¨æ›´åŠ ç®€å•çš„ã€å°è£…æ€§æ›´å¥½çš„æ–¹æ³•å®ç°ï¼Œè‡ªå®šä¹‰åˆ é™¤å™¨ä¹Ÿå¯ä»¥æ”¾åœ¨å‡½æ•°å†…éƒ¨ï¼Œå®Œæ•´çš„ä»£ç æ¼”ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">makeInvestment</span><span class="params">(Ts&amp;&amp;... params)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç°åœ¨è‡ªå®šä¹‰åˆ é™¤å™¨ä½äºå‡½æ•°å†…éƒ¨</span></span><br><span class="line">    <span class="keyword">auto</span> delInvmt = [](Investment* pInvestment) &#123;</span><br><span class="line">        <span class="built_in">makeLogEntry</span>(pInvestment);</span><br><span class="line">        <span class="keyword">delete</span> pInvestment;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::unique_ptr&lt;Investment, <span class="title">decltype</span><span class="params">(delInvmt)</span>&gt; <span class="title">pInv</span><span class="params">(<span class="literal">nullptr</span>, delInvmt)</span></span>;    <span class="comment">// å¾…è¿”å›çš„æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ reset æ¥è®© pInv è·å– new äº§ç”Ÿçš„å¯¹è±¡çš„æ‰€æœ‰æƒ</span></span><br><span class="line">    <span class="comment">// å¯¹æ¯ä¸€æ¬¡ new çš„è°ƒç”¨ç»“æœï¼Œéƒ½ä½¿ç”¨ std::forward å¯¹å®å‚è¿›è¡Œå®Œç¾è½¬å‘ï¼ˆå‚è€ƒæ¡æ¬¾ 25ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="comment">/* åº”åˆ›å»ºä¸€ä¸ª Stock ç±»å‹çš„å¯¹è±¡ */</span> ) &#123;</span><br><span class="line">        pInv.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">Stock</span>(std::forward&lt;Ts&gt;(params)...));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="comment">/* åº”åˆ›å»ºä¸€ä¸ª Bond ç±»å‹çš„å¯¹è±¡ */</span> ) &#123;</span><br><span class="line">        pInv.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">Bond</span>(std::forward&lt;Ts&gt;(params)...));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="comment">/* åº”åˆ›å»ºä¸€ä¸ª RealEstate ç±»å‹çš„å¯¹è±¡ */</span> ) &#123;</span><br><span class="line">        pInv.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">RealEstate</span>(std::forward&lt;Ts&gt;(params)...));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pInv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨è‡ªå®šä¹‰åˆ é™¤å™¨åï¼Œ<code>std::unique_ptr</code>çš„å¤§å°å¯èƒ½ä¸å†å’Œè£¸æŒ‡é’ˆç›¸åŒï¼šæœ‰çŠ¶æ€çš„åˆ é™¤å™¨å’Œé‡‡ç”¨å‡½æ•°æŒ‡é’ˆçš„åˆ é™¤å™¨ä¼šå¢åŠ <code>std::unique_ptr</code>ç±»å‹çš„å¯¹è±¡å°ºå¯¸å¤§å°ã€‚æ— çŠ¶æ€çš„å‡½æ•°å¯¹è±¡ï¼ˆä¾‹å¦‚æ— æ•è·çš„ lambda è¡¨è¾¾å¼ï¼‰ä¸ä¼šæµªè´¹ä»»ä½•å†…å­˜ç©ºé—´ï¼Œè€Œå‡½æ•°æŒ‡é’ˆé€šå¸¸ä¼šä½¿<code>std::unique_ptr</code>çš„å¤§å°å¢åŠ ä¸€åˆ°ä¸¤ä¸ªå­—é•¿ï¼ˆwordï¼‰ï¼Œè¿™æ„å‘³ç€æ— æ•è·çš„ lambda è¡¨è¾¾å¼å¾€å¾€æ˜¯ç”¨ä½œåˆ é™¤å™¨çš„æœ€ä½³é€‰æ‹©ã€‚</p><p><code>std::unique_ptr</code>æä¾›äº†ä¸¤ç§å½¢å¼ï¼Œä¸€ç§æ˜¯å•ä¸ªå¯¹è±¡ï¼ˆ<code>std::unique_ptr&lt;T&gt;</code>ï¼‰ï¼Œå¦ä¸€ç§æ˜¯æ•°ç»„ï¼ˆ<code>std::unique_ptr&lt;T[]&gt;</code>ï¼‰ã€‚ä¸ºäº†é¿å…äºŒä¹‰æ€§ï¼Œå•ä¸ªå¯¹è±¡å½¢å¼ä¸æä¾›ç´¢å¼•è¿ç®—ç¬¦ï¼ˆ<code>operator[]</code>ï¼‰ï¼Œè€Œæ•°ç»„å½¢å¼ä¸æä¾›è§£å¼•ç”¨è¿ç®—ç¬¦ï¼ˆ<code>operator*</code>å’Œ<code>operator-&gt;</code>ï¼‰ã€‚ä½†å®é™…ä¸Šï¼Œæ•°ç»„å½¢å¼ç”¨åˆ°çš„åœºåˆéå¸¸å°‘ï¼Œå”¯ä¸€çš„åº”ç”¨åœºåˆå¤§æ¦‚æ˜¯åœ¨ä½¿ç”¨ C é£æ ¼ API æ—¶ï¼Œå®ƒè¿”å›äº†å­˜æ”¾åœ¨å †ä¸Šçš„è£¸æŒ‡é’ˆï¼›å¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬ä¼šä¼˜å…ˆè€ƒè™‘<code>std::array</code>ã€<code>std::vector</code>å’Œ<code>std::string</code>è¿™äº›æ•°æ®ç»“æ„ã€‚</p><p><code>std::unique_ptr</code>å¯ä»¥æ–¹ä¾¿é«˜æ•ˆåœ°è½¬æ¢ä¸º<code>std::shared_ptr</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::shared_ptr&lt;Investment&gt; sp = <span class="built_in">makeInvestment</span>( arguments );</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-19ï¼šä½¿ç”¨-std-shared-ptr-ç®¡ç†å…·å¤‡å…±äº«æ‰€æœ‰æƒçš„èµ„æº">æ¡æ¬¾ 19ï¼šä½¿ç”¨ std::shared_ptr ç®¡ç†å…·å¤‡å…±äº«æ‰€æœ‰æƒçš„èµ„æº</h3><hr><p>è¦ç‚¹ï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/1.png" alt=""></p><p>å¼•ç”¨è®¡æ•°çš„å­˜åœ¨å¯¹æ€§èƒ½çš„å½±å“ï¼š</p><ul><li><strong>std::shared_ptr çš„å¤§å°æ˜¯åŸå§‹æŒ‡é’ˆçš„ä¸¤å€</strong>ï¼šå› ä¸ºå†…éƒ¨åŒ…å«ä¸€ä¸ªæŒ‡å‘èµ„æºçš„<strong>åŸå§‹æŒ‡é’ˆ</strong>ï¼Œä»¥åŠä¸€ä¸ªæŒ‡å‘èµ„æº<strong>å¼•ç”¨è®¡æ•°çš„åŸå§‹æŒ‡é’ˆ</strong>ã€æˆ‘çš„ç†è§£æ˜¯æ§åˆ¶å—æŒ‡é’ˆã€‘</li><li><strong>å¼•ç”¨è®¡æ•°çš„å†…å­˜å¿…é¡»åŠ¨æ€åˆ†é…</strong>ï¼šæ‰€æŒ‡å‘çš„å¯¹è±¡å¯¹å¼•ç”¨è®¡æ•°ä¸€æ— æ‰€çŸ¥ï¼Œå¯¹è±¡æ²¡æœ‰å­˜å‚¨å¼•ç”¨è®¡æ•°çš„åœ°æ–¹</li><li><strong>å¼•ç”¨è®¡æ•°çš„å¢åŠ å’Œå‡å°‘å¿…é¡»æ˜¯åŸå­æ“ä½œ</strong>ï¼šä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æŒ‡å‘èµ„æºçš„ std::shared_ptr å¯èƒ½æ­£åœ¨æ‰§è¡Œå…¶ææ„å‡½æ•°ï¼Œè€Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼ŒæŒ‡å‘åŒä¸€å¯¹è±¡çš„ std::shared_ptr å¯èƒ½æ­£åœ¨è¢«æ‹·è´</li></ul><p>ç®€å•ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>()&#123;&#125;;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">int</span> a)&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// A *a = new A;</span></span><br><span class="line">    <span class="keyword">auto</span> fun = [](A *a)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;debug&quot;</span>);</span><br><span class="line">        <span class="keyword">delete</span> a;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;A, <span class="title">decltype</span><span class="params">(fun)</span>&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> A, fun)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><p><strong>ä¸èƒ½ä»å•ä¸ªåŸå§‹æŒ‡é’ˆæ„é€ å¤šä¸ªstd::shared_ptr</strong>ï¼Œå¦åˆ™æŒ‡å‘çš„å¯¹è±¡å°†æœ‰å¤šä¸ªæ§åˆ¶å—ï¼Œå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚</p><p><strong>std::shared_ptrçš„å¦ä¸€ä¸ªå±€é™æ€§æ˜¯æ— æ³•å¤„ç†æ•°ç»„</strong>ã€‚ä¸std::unique_pträ¸åŒï¼Œstd::shared_ptrçš„ API ä»…è®¾è®¡ç”¨äºæŒ‡å‘å•ä¸ªå¯¹è±¡ã€‚æ²¡æœ‰std::shared_ptr&lt;T[]&gt;ï¼Œ ä¹Ÿæ²¡æœ‰æä¾›operator[]ã€‚<strong>C++11 ä¸­æœ‰å¤šç§å†…ç½®æ•°ç»„çš„æ›¿ä»£æ–¹æ¡ˆ</strong>ï¼ˆä¾‹å¦‚ï¼Œstd::arrayã€std::vectorã€std::stringï¼‰ï¼Œå£°æ˜ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆæ¥æŒ‡å‘æ„šè ¢çš„æ•°ç»„å‡ ä¹æ€»æ˜¯ç³Ÿç³•è®¾è®¡çš„æ ‡å¿—ã€‚</p><hr><p><code>std::shared_ptr</code>æä¾›äº†æ–¹ä¾¿çš„æ‰‹æ®µï¼Œå®ç°äº†ä»»æ„èµ„æºåœ¨å…±äº«æ‰€æœ‰æƒè¯­ä¹‰ä¸‹è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†çš„åƒåœ¾å›æ”¶ã€‚ä¸<code>std::unique_ptr</code>ç›¸æ¯”ï¼Œ<code>std::shared_ptr</code>æ‰€å å¤§å°é€šå¸¸æ˜¯è£¸æŒ‡é’ˆçš„ä¸¤å€ï¼Œå®ƒè¿˜ä¼šå¸¦æ¥æ§åˆ¶å—çš„å¼€é”€ï¼Œå¹¶ä¸”è¦æ±‚æˆæœ¬é«˜æ˜‚çš„åŸå­åŒ–çš„å¼•ç”¨è®¡æ•°æ“ä½œã€‚</p><p>é»˜è®¤çš„èµ„æºææ„é€šè¿‡<code>delete</code>è¿ç®—ç¬¦æ¥å®Œæˆï¼Œä½†åŒæ—¶ä¹Ÿæ”¯æŒè‡ªå®šä¹‰åˆ é™¤å™¨ã€‚ä¸<code>std::unique_ptr</code>ä¸åŒçš„æ˜¯ï¼Œåˆ é™¤å™¨çš„ç±»å‹å¯¹<code>std::shared_ptr</code>çš„ç±»å‹æ²¡æœ‰å½±å“ï¼Œä¹Ÿä¸ä¼šå½±å“<code>std::shared_ptr</code>çš„å°ºå¯¸å¤§å°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> loggingDel = [](Widget* pw) &#123;</span><br><span class="line">    <span class="built_in">makeLogEntry</span>(pw);</span><br><span class="line">    <span class="keyword">delete</span> pw;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">std::unique_ptr&lt;Widget, <span class="title">decltype</span><span class="params">(loggingDel)</span>&gt; <span class="title">upw</span><span class="params">(<span class="keyword">new</span> Widget, loggingDel)</span></span>;</span><br><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt;                       <span class="title">spw</span><span class="params">(<span class="keyword">new</span> Widget, loggingDel)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™ä½¿å¾—<code>std::shared_ptr</code>çš„è®¾è®¡æ›´å…·å¼¹æ€§ï¼Œæ‹¥æœ‰ä¸åŒç±»å‹è‡ªå®šä¹‰åˆ é™¤å™¨çš„<code>std::shared_ptr</code>ä¹Ÿå¯ä»¥è¢«æ”¾åœ¨åŒä¸€ä¸ªå®¹å™¨ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> customDeleter1 = [](Widget* pw) &#123;&#125;;    <span class="comment">// è‡ªå®šä¹‰åˆ é™¤å™¨</span></span><br><span class="line"><span class="keyword">auto</span> customDeleter2 = [](Widget* pw) &#123;&#125;;    <span class="comment">// å„æœ‰ä¸åŒçš„ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">pw1</span><span class="params">(<span class="keyword">new</span> Widget, customDeleter1)</span></span>;</span><br><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">pw2</span><span class="params">(<span class="keyword">new</span> Widget, customDeleter2)</span></span>;</span><br><span class="line"></span><br><span class="line">std::vector&lt;std::shared_ptr&lt;Widget&gt;&gt; vpw&#123; pw1, pw2 &#125;;</span><br></pre></td></tr></table></figure><p><strong>æ§åˆ¶å—ï¼ˆcontrol blockï¼‰ï¼š</strong> æ¯ä¸€ä¸ªç”±<code>std::shared_ptr</code>ç®¡ç†çš„å¯¹è±¡éƒ½æ‹¥æœ‰ä¸€ä¸ªæ§åˆ¶å—ï¼Œå®ƒçš„å†…å­˜è¢«åŠ¨æ€åˆ†é…åœ¨å †ä¸Šï¼Œé™¤äº†åŒ…å«å¼•ç”¨è®¡æ•°ä»¥å¤–ï¼Œè¿˜åŒ…å«ä½œç”¨äº<code>std::weak_ptr</code>çš„å¼±è®¡æ•°ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 20</strong>ï¼‰ï¼Œè‡ªå®šä¹‰åˆ é™¤å™¨å’Œåˆ†é…å™¨ç­‰å†…å®¹ã€‚</p><p>ä¸€ä¸ªå¯¹è±¡çš„æ§åˆ¶å—åº”è¯¥åœ¨åˆ›å»ºé¦–ä¸ªæŒ‡å‘è¯¥å¯¹è±¡çš„<code>std::shared_ptr</code>æ—¶ç¡®å®šï¼Œå› æ­¤ï¼Œæ§åˆ¶å—çš„åˆ›å»ºéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p><ol><li>ä½¿ç”¨<code>std::make_shared</code>ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 21</strong>ï¼‰æ€»æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªæ§åˆ¶å—ã€‚</li><li>ä»å…·å¤‡ä¸“å±æ‰€æœ‰æƒçš„æŒ‡é’ˆï¼ˆ<code>std::unique_ptr</code>æˆ–<code>std::auto_ptr</code>ï¼‰å‡ºå‘æ„é€ ä¸€ä¸ª<code>std::shared_ptr</code>æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ§åˆ¶å—ã€‚</li><li>ç”¨è£¸æŒ‡é’ˆä½œä¸ºå®å‚è°ƒç”¨<code>std::shared_ptr</code>çš„æ„é€ å‡½æ•°æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ§åˆ¶å—ã€‚</li></ol><p>ç”±ä»¥ä¸Šè§„åˆ™æˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼Œåº”è¯¥é¿å…ä½¿ç”¨è£¸æŒ‡é’ˆç±»å‹çš„å˜é‡æ¥åˆ›å»º<code>std::shared_ptr</code>ã€‚ç”¨åŒä¸€ä¸ªè£¸æŒ‡é’ˆæ„é€ å‡ºä¸æ­¢ä¸€ä¸ª<code>std::shared_ptr</code>å°†ä¼šä½¿å¯¹è±¡æ‹¥æœ‰å¤šé‡çš„æ§åˆ¶å—ï¼Œè¿™ä¼šå¯¼è‡´å¯¹èµ„æºçš„å¤šæ¬¡ææ„ï¼Œä»è€Œäº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> pw = <span class="keyword">new</span> Widget; <span class="comment">// pw æ˜¯ä¸ªè£¸æŒ‡é’ˆ</span></span><br><span class="line">...</span><br><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw1</span><span class="params">(pw, loggingDel)</span></span>;</span><br><span class="line">...</span><br><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw2</span><span class="params">(pw, loggingDel)</span></span>;</span><br></pre></td></tr></table></figure><p>åº”è¯¥æ”¹ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw1</span><span class="params">(<span class="keyword">new</span> Widget, loggingDel)</span></span>;</span><br><span class="line">...</span><br><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw2</span><span class="params">(spw1)</span></span>;</span><br></pre></td></tr></table></figure><p>å½“ä½ å¸Œæœ›ä¸€ä¸ªæ‰˜ç®¡åˆ°<code>std::shared_ptr</code>çš„ç±»èƒ½å¤Ÿå®‰å…¨åœ°ç”±<code>this</code>æŒ‡é’ˆåˆ›å»ºä¸€ä¸ª<code>std::shared_ptr</code>æ—¶ï¼Œåº”è¯¥ä½¿è¯¥ç±»ç»§æ‰¿è‡ª<code>std::enable_shared_from_this</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> : <span class="keyword">public</span> std::enable_shared_from_this&lt;Widget&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>std::enable_shared_from_this</code>å®šä¹‰äº†ä¸€ä¸ªæˆå‘˜å‡½æ•°<code>std::shared_from_this</code>ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª<code>std::shared_ptr</code>æŒ‡å‘å½“å‰å¯¹è±¡ï¼Œä½†ä¸ä¼šé‡å¤åˆ›å»ºæ§åˆ¶å—ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;std::shared_ptr&lt;Widget&gt;&gt; processedWidget;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Widget::process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†å¯¹è±¡æœ¬èº«</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æŒ‡å‘å½“å‰å¯¹è±¡çš„ std::shared_ptr åŠ å…¥ processedWidget</span></span><br><span class="line">    processedWidget.<span class="built_in">emplace_back</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†é¿å…ç”¨æˆ·åœ¨<code>std::shared_ptr</code>æŒ‡å‘è¯¥å¯¹è±¡å‰å°±è°ƒç”¨äº†<code>std::shared_from_this</code>ï¼ˆè¿™ä¼šå¯¼è‡´å…¶æ— æ³•æŸ¥è¯¢åˆ°å¯¹è±¡æ‹¥æœ‰çš„æ§åˆ¶å—ï¼Œäº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºï¼‰ï¼Œç»§æ‰¿è‡ª<code>std::enable_shared_from_this</code>çš„ç±»é€šå¸¸ä¼šå°†å…¶æ„é€ å‡½æ•°å£°æ˜ä¸º privateï¼Œå¹¶ä¸”åªå…è®¸é€šè¿‡è°ƒç”¨è¿”å›<code>std::shared_ptr</code>çš„å·¥å‚å‡½æ•°æ¥åˆ›å»ºå¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯<code>Widget</code>ç±»çš„ä¸€ä¸ªå¯èƒ½å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> : <span class="keyword">public</span> std::enable_shared_from_this&lt;Widget&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// å°†å®å‚å®Œç¾è½¬å‘ç»™ private æ„é€ å‡½æ•°çš„å·¥å‚å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function">    <span class="type">static</span> std::shared_ptr&lt;Widget&gt; <span class="title">create</span><span class="params">(Ts&amp;&amp;... params)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Widget</span>( ... );  <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>std::unique_ptr</code>å¯ä»¥è½»æ˜“è½¬æ¢ä¸º<code>std::shared_ptr</code>ï¼Œåä¹‹å´å¹¶ä¸æˆç«‹ï¼Œä¸€æ—¦èµ„æºçš„ç”Ÿå­˜æœŸè¢«æ‰˜ç®¡ç»™äº†<code>std::shared_ptr</code>ï¼Œå°±ä¸èƒ½å›æ”¶è¯¥èµ„æºçš„æ‰€æœ‰æƒï¼Œå¹¶è®©ä¸€ä¸ª<code>std::unique_ptr</code>æ¥æ‰˜ç®¡å®ƒã€‚å¹¶ä¸”å’Œ<code>std::unique_ptr</code>ä¸åŒï¼Œ<code>std::shared_ptr</code>ç›´åˆ° C++17 æ‰æ‹¥æœ‰å¤„ç†æ•°ç»„çš„èƒ½åŠ›ï¼ˆ<code>std::shared_ptr&lt;T[]&gt;</code>ï¼‰ï¼Œåœ¨ C++11/14 ä¸­ï¼Œå®ƒçš„ API ä»…è¢«è®¾è®¡ç”¨æ¥å¤„ç†æŒ‡å‘å•ä¸ªå¯¹è±¡çš„æŒ‡é’ˆã€‚</p><h3 id="æ¡æ¬¾-20ï¼šå¯¹äºç±»ä¼¼-std-shared-ptr-ä½†æœ‰å¯èƒ½ç©ºæ‚¬çš„æŒ‡é’ˆä½¿ç”¨-std-weak-ptr">æ¡æ¬¾ 20ï¼šå¯¹äºç±»ä¼¼ std::shared_ptr ä½†æœ‰å¯èƒ½ç©ºæ‚¬çš„æŒ‡é’ˆä½¿ç”¨ std::weak_ptr</h3><hr><p>weak_ptrè§‚å¯Ÿè€…</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> spw = std::<span class="built_in">make_shared</span>&lt;Widget&gt;(); Â <span class="comment">// å¼•ç”¨è®¡æ•°=1</span></span><br><span class="line">â€¦</span><br><span class="line"><span class="function">std::weak_ptr&lt;Widget&gt; <span class="title">wpw</span><span class="params">(spw)</span></span>; Â  Â  Â  Â  <span class="comment">// å¼•ç”¨è®¡æ•°=1</span></span><br><span class="line">â€¦</span><br><span class="line">spw = <span class="literal">nullptr</span>; Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="comment">// å¼•ç”¨è®¡æ•°=0ï¼Œspwå˜ä¸ºç©ºæ‚¬</span></span><br><span class="line"><span class="keyword">if</span> (wpw.<span class="built_in">expired</span>()) â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="comment">// å¦‚æœ wpw æ²¡æœ‰æŒ‡å‘ä»»ä½•å¯¹è±¡</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½†é€šå¸¸ä½ å¸Œæœ›æ£€æŸ¥ std::weak_ptræ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœå®ƒä¸æ˜¯æ‚¬æŒ‚çš„ï¼Œåˆ™è®¿é—®å®ƒæŒ‡å‘çš„å¯¹è±¡ã€‚</p><ul><li>å› ä¸º std::weak_ptrç¼ºä¹è§£å¼•ç”¨æ“ä½œï¼Œæ‰€ä»¥æ— æ³•ç¼–å†™è¿™æ ·çš„ä»£ç ã€‚</li><li>éœ€è¦åŸå­æ“ä½œï¼Œæ£€æŸ¥ std::weak_ptræ˜¯å¦æœ‰æ•ˆï¼Œ æœ‰æ•ˆåˆ™ä» std::weak_ptråˆ›å»ºä¸€ä¸ª std::shared_ptræ¥è¿›è¡Œè®¿é—®</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Widget&gt; spw1 = wpw.lock(); <span class="comment">// å¦‚æœ wpw æ— æ•ˆ, spw1 å°†ä¼šæ˜¯ç©º</span></span><br><span class="line"><span class="keyword">auto</span> spw2 = wpw.lock(); <span class="comment">// åŒä¸Š</span></span><br></pre></td></tr></table></figure><p>std::shared_ptrå¯ä»¥ä½¿ç”¨std::weak_pträ½œä¸ºå‚æ•°è¿›è¡Œæ„é€ ï¼Œå¦‚æœstd::weak_ptrå·²ç»æ— æ•ˆï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Widget&gt; <span class="title function_">spw3</span><span class="params">(wpw)</span>; <span class="comment">// æ— æœ wpw æ— æ•ˆ, åˆ™æŠ›å‡º std::bad_weak_ptr</span></span><br></pre></td></tr></table></figure><p><strong>è¦ç‚¹é€Ÿè®°</strong></p><ul><li>å¯¹äºç±»ä¼¼std::shared_ptrçš„å¯èƒ½ä¼šæ‚¬æŒ‚çš„æŒ‡é’ˆï¼Œè¯·ä½¿ç”¨std::weak_ptrã€‚</li><li>std::weak_ptrçš„æ½œåœ¨ç”¨ä¾‹åŒ…æ‹¬ç¼“å­˜ã€è§‚å¯Ÿè€…åˆ—è¡¨ä»¥åŠé˜²æ­¢std::shared_ptrå¾ªç¯ã€‚ã€Modern Cppä¸­å·²ç»è®²è¿°è¯¦ç»†äº†çš„ã€‘</li></ul><hr><p><code>std::weak_ptr</code>å¹¶ä¸æ˜¯ä¸€ç§ç‹¬ç«‹çš„æ™ºèƒ½æŒ‡é’ˆï¼Œè€Œæ˜¯<code>std::shared_ptr</code>çš„ä¸€ç§æ‰©å……ã€‚å®ƒä¸€èˆ¬æ˜¯é€šè¿‡<code>std::shared_ptr</code>æ¥åˆ›å»ºçš„ï¼Œä¸¤è€…ä¼šæŒ‡å‘ç›¸åŒä½ç½®ï¼Œä½†<code>std::weak_ptr</code>å¹¶ä¸å½±å“æ‰€æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œè€Œæ˜¯ä¼šå½±å“æ§åˆ¶å—ä¸­çš„å¼±è®¡æ•°ã€‚</p><p>ä½¿ç”¨<code>expired</code>å‡½æ•°æ¥æ£€æµ‹<code>std::weak_ptr</code>çš„ç©ºæ‚¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> spw = std::<span class="built_in">make_shared</span>&lt;Widget&gt;();</span><br><span class="line"><span class="function">std::weak_ptr&lt;Widget&gt; <span class="title">wpw</span><span class="params">(spw)</span></span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">spw = <span class="literal">nullptr</span>;      <span class="comment">// Widget å¯¹è±¡è¢«ææ„ï¼Œwpw ç©ºæ‚¬</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (wpw.<span class="built_in">expired</span>())  <span class="comment">// è‹¥ wpw ä¸å†æŒ‡å‘ä»»ä½•å¯¹è±¡</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>std::weak_ptr</code>åˆ›å»º<code>std::shared_ptr</code>ï¼Œå¯ä»¥åœ¨æœªå¤±æ•ˆæƒ…å†µä¸‹æä¾›å¯¹èµ„æºçš„è®¿é—®ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ lock å‡½æ•°æ—¶ï¼Œè‹¥ wpw å¤±æ•ˆï¼Œåˆ™ spw1 å’Œ spw2 ä¸ºç©º</span></span><br><span class="line">std::shared_ptr&lt;Widget&gt; spw1 = wpw.<span class="built_in">lock</span>();</span><br><span class="line"><span class="keyword">auto</span> spw2 = wpw.<span class="built_in">lock</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›´æ¥æ„é€ æ—¶ï¼Œè‹¥ wpw å¤±æ•ˆï¼Œåˆ™æŠ›å‡º std::bad_weak_ptr ç±»å‹çš„å¼‚å¸¸</span></span><br><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw3</span><span class="params">(wpw)</span></span>;</span><br></pre></td></tr></table></figure><p><code>std::weak_ptr</code>æœ‰ä»¥ä¸‹å¯èƒ½çš„ç”¨æ­¦ä¹‹åœ°ï¼š</p><ul><li>åˆ›å»ºå¸¦ç¼“å­˜çš„å·¥å‚å‡½æ•°ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;<span class="type">const</span> Widget&gt; <span class="title">fastLoadWidget</span><span class="params">(WidgetID id)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> std::unordered_map&lt;WidgetID, std::weak_ptr&lt;<span class="type">const</span> Widget&gt;&gt; cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> objPtr = cache[id].<span class="built_in">lock</span>(); <span class="comment">// å¦‚æœå¯¹è±¡ä¸åœ¨ç¼“å­˜ä¸­ï¼Œåˆ™è¿”å›ç©ºæŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!objPtr) &#123;                  <span class="comment">// åŠ è½½å¹¶ç¼“å­˜å¯¹è±¡</span></span><br><span class="line">        objPtr = <span class="built_in">loadWidget</span>(id);</span><br><span class="line">        cache[id] = objPtr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> objPtr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ï¼ˆObserver design patternï¼‰ï¼šå¤šä¸ªè§‚å¯Ÿè€…ï¼ˆobserverï¼‰å¯¹è±¡åŒæ—¶ç›‘å¬ä¸€ä¸ªä¸»é¢˜ï¼ˆsubjectï¼‰å¯¹è±¡ï¼Œä¸»é¢˜å¯¹è±¡ä¼šåœ¨å…¶å‘ç”ŸçŠ¶æ€æ”¹å˜æ—¶å‘å‡ºé€šçŸ¥ã€‚ä¸»é¢˜å¯¹è±¡ä¸ä¼šæ§åˆ¶å…¶è§‚å¯Ÿè€…çš„ç”Ÿå­˜æœŸï¼Œä½†éœ€è¦ç¡®è®¤å½“ä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡è¢«ææ„åï¼Œä¸»é¢˜å¯¹è±¡ä¸ä¼šå†è®¿é—®å®ƒã€‚ä¸€ç§åˆç†çš„è®¾è®¡å°±æ˜¯è®©æ¯ä¸ªä¸»é¢˜å¯¹è±¡æŒæœ‰æŒ‡å‘å…¶è§‚å¯Ÿè€…å¯¹è±¡çš„<code>std::weak_ptr</code>ï¼Œä»¥ä¾¿åœ¨ä½¿ç”¨ä¹‹å‰ç¡®è®¤å®ƒæ˜¯å¦ç©ºæ‚¬ã€‚</li><li>é¿å…<code>std::shared_ptr</code>å¾ªç¯å¼•ç”¨ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    std::shared_ptr&lt;B&gt; pb;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    std::shared_ptr&lt;A&gt; pa;</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> pa = std::<span class="built_in">make_shared</span>&lt;A&gt;();</span><br><span class="line"><span class="keyword">auto</span> pb = std::<span class="built_in">make_shared</span>&lt;B&gt;();</span><br><span class="line"></span><br><span class="line">pa-&gt;pb = pb;</span><br><span class="line">pb-&gt;pa = pa;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>A</code>å’Œ<code>B</code>äº’ç›¸ä¿å­˜ç€æŒ‡å‘å¯¹æ–¹çš„<code>std::shared_ptr</code>ï¼Œäº§ç”Ÿäº†å¾ªç¯å¼•ç”¨ï¼Œä¸¤è€…ä¼šæ°¸ä¹…ä¿æŒå½¼æ­¤çš„å¼•ç”¨è®¡æ•°è‡³å°‘ä¸ºä¸€ï¼Œè¿™ä¼šé˜»æ­¢<code>A</code>å’Œ<code>B</code>è¢«ææ„ï¼Œå®é™…ä¸Šäº§ç”Ÿäº†å†…å­˜æ³„æ¼ã€‚</p><p>å°†å…¶ä¸­ä¸€è€…æ”¹ä¸º<code>std::weak_ptr</code>å¯ä»¥é¿å…å¾ªç¯çš„äº§ç”Ÿï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    std::shared_ptr&lt;B&gt; pb;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    std::weak_ptr&lt;A&gt; pa;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-21ï¼šä¼˜å…ˆé€‰ç”¨-std-make-unique-å’Œ-std-make-sharedï¼Œè€Œéç›´æ¥ä½¿ç”¨-new">æ¡æ¬¾ 21ï¼šä¼˜å…ˆé€‰ç”¨ std::make_unique å’Œ std::make_sharedï¼Œè€Œéç›´æ¥ä½¿ç”¨ new</h3><hr><blockquote><p><strong>å¥½å¤„1.åŸå­æ€§</strong></p></blockquote><p>1.åŸå­æ€§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">processWidget</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Widget&gt; spw, <span class="type">int</span> priority)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">computePriority</span><span class="params">()</span>;</span><br><span class="line">processWidget(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Widget&gt;(new Widget), computePriority()); <span class="comment">// å¯èƒ½èµ„æºæ³„æ¼</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿è¡Œæ—¶ï¼Œå‡½æ•°çš„å‚æ•°å¿…é¡»åœ¨è°ƒç”¨å‡½æ•°ä¹‹å‰è¿›è¡Œæ±‚å€¼ï¼š</p><ul><li>è®¡ç®— new Widget è¡¨è¾¾å¼ï¼Œå³å¿…é¡»åœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ª Widget</li><li>æ‰§è¡Œè´Ÿè´£ç®¡ç† newäº§ç”Ÿçš„æŒ‡é’ˆçš„ std::shared_ptr&lt; Widget &gt;çš„æ„é€ å‡½æ•°</li><li>è¿è¡ŒcomputePriorityå¿…é¡»</li></ul><p><strong>ç¼–è¯‘å™¨ä¸éœ€è¦ç”ŸæˆæŒ‰ç…§è¿™ä¸ªé¡ºåºæ‰§è¡Œçš„ä»£ç </strong>ã€‚ã€ç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–ã€‘new Widgetå¿…é¡»åœ¨ std::shared_ptr`æ„é€ å‡½æ•°è¢«è°ƒç”¨ä¹‹å‰æ‰§è¡Œå³å¯ã€‚</p><p>ç¼–è¯‘å™¨å¯èƒ½ä¼šç”ŸæˆæŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œæ“ä½œçš„ä»£ç ï¼š</p><p>1ã€æ‰§è¡Œ new Widgetï¼›</p><p>2ã€æ‰§è¡Œ computePriorityï¼›</p><p>3ã€è¿è¡Œ std::shared_ptr æ„é€ å‡½æ•°ã€‚å¦‚æœè¿è¡Œæ—¶ï¼ŒcomputePriority äº§ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆæ­¥éª¤ 1 ä¸­åŠ¨æ€åˆ†é…çš„ Widget å°†æ³„æ¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">processWidget(<span class="built_in">std</span>::make_shared&lt;Widget&gt;(), computePriority()); <span class="comment">// ä¸ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>å¥½å¤„2.å†…å­˜åˆ†é…æ¬¡æ•°</strong></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw</span><span class="params">(<span class="keyword">new</span> Widget)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ‰§è¡Œäº†ä¸¤æ¬¡å†…å­˜åˆ†é…ã€‚ç›´æ¥ä½¿ç”¨ newï¼Œéœ€è¦ä¸€æ¬¡ä¸º Widget åˆ†é…å†…å­˜ï¼Œç¬¬äºŒæ¬¡ä¸ºæ§åˆ¶å—åˆ†é…å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> spw = <span class="built_in">std</span>::make_shared&lt;Widget&gt;();</span><br></pre></td></tr></table></figure><p>std::make_sharedåˆ†é…äº†ä¸€ä¸ªå•ç‹¬çš„å†…å­˜å—æ¥å®¹çº³ Widget å¯¹è±¡å’Œæ§åˆ¶å—ï¼Œè¿™ç§ä¼˜åŒ–å‡å°‘äº†ç¨‹åºçš„é™æ€å¤§å°ï¼Œå› ä¸ºä»£ç ä¸­åªåŒ…å«ä¸€ä¸ªå†…å­˜åˆ†é…è°ƒç”¨ï¼Œå¹¶ä¸”å®ƒæé«˜äº†å¯æ‰§è¡Œä»£ç çš„é€Ÿåº¦ï¼Œå› ä¸ºåªåˆ†é…äº†ä¸€æ¬¡å†…å­˜ã€‚</p><blockquote><p><strong>åå¤„ï¼šä¸èƒ½è‡ªå®šä¹‰åˆ é™¤å™¨</strong></p></blockquote><p>ä½†æ²¡æœ‰ä»»ä½•makeå‡½æ•°å…è®¸æŒ‡å®šè‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œè€Œæ˜¯ std::unique_ptr å’Œ std::shared_ptr éƒ½æœ‰æ„é€ å‡½æ•°å¯ä»¥è¿™æ ·åš</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> widgetDeleter = [](Widget* pw) &#123; â€¦ &#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Widget, <span class="title function_">decltype</span><span class="params">(widgetDeleter)</span>&gt; <span class="title function_">upw</span><span class="params">(new Widget, widgetDeleter)</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Widget&gt; <span class="title function_">spw</span><span class="params">(new Widget, widgetDeleter)</span>;</span><br></pre></td></tr></table></figure><blockquote><p><strong>ä¸å»ºè®®ä½¿ç”¨makeçš„æƒ…å†µ</strong></p></blockquote><p>1ã€å½“ç±»æœ‰è‡ªå·±çš„ operator new å’Œ operator delete å®ç°æ—¶ï¼Œä¸ std::shared_ptr çš„è‡ªå®šä¹‰åˆ†é…å’Œé‡Šæ”¾æ”¯æŒå¯èƒ½ä¸å…¼å®¹ï¼Œå› æ­¤ä½¿ç”¨ make å‡½æ•°åˆ›å»ºè¿™äº›ç±»çš„å¯¹è±¡å¯èƒ½ä¸åˆé€‚ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜ç®¡ç†æ–¹é¢çš„é—®é¢˜ã€‚</p><p>2ã€std::shared_ptr çš„æ§åˆ¶å—ä¸ç®¡ç†å¯¹è±¡æ”¾åœ¨åŒä¸€å—å†…å­˜ä¸­ã€‚å½“è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸ºé›¶æ—¶ï¼Œè¯¥å¯¹è±¡å°†è¢«é”€æ¯ï¼ˆå³ï¼Œè°ƒç”¨å…¶ææ„å‡½æ•°ï¼‰ã€‚ä½†æ˜¯ï¼Œåœ¨æ§åˆ¶å—ä¹Ÿè¢«é”€æ¯ä¹‹å‰ï¼Œå®ƒæ‰€å ç”¨çš„å†…å­˜ä¸èƒ½è¢«é‡Šæ”¾</p><ul><li>ç”± std::shared_ptr make å‡½æ•°åˆ†é…çš„å†…å­˜åªæœ‰åœ¨æœ€åä¸€ä¸ª std::shared_ptr å’Œæœ€åä¸€ä¸ªå¼•ç”¨å®ƒçš„ std::weak_ptr è¢«é”€æ¯åæ‰èƒ½è¢«é‡Šæ”¾ã€‚å¯¹è±¡é”€æ¯å’Œå®ƒå ç”¨çš„å†…å­˜è¢«é‡Šæ”¾ä¹‹é—´å¯èƒ½ä¼šå‡ºç°æ»å</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReallyBigType</span>&#123;</span>...&#125;;</span><br><span class="line"><span class="keyword">auto</span> pBigObj = <span class="built_in">std</span>::make_shared&lt;ReallyBigType&gt;(); <span class="comment">// é€šè¿‡std::make_sharedåˆ›å»ºéå¸¸å¤§çš„å¯¹è±¡</span></span><br><span class="line">... <span class="comment">// åˆ›å»º std::shared_ptrs å’Œ std::weak_ptrs åˆ°å¤§å¯¹è±¡ï¼Œä½¿ç”¨å®ƒä»¬ä¸ä¹‹åˆä½œ</span></span><br><span class="line">... <span class="comment">// æ­¤å¤„é”€æ¯å¯¹è±¡çš„æœ€åä¸€ä¸ª std::shared_ptrï¼Œä½†å¯¹å®ƒçš„ std::weak_ptr ä»ç„¶å­˜åœ¨</span></span><br><span class="line">... <span class="comment">// åœ¨è¿™æ®µæ—¶é—´å†…ï¼Œä»¥å‰è¢«å¤§å¯¹è±¡å ç”¨çš„å†…å­˜ä»ç„¶è¢«åˆ†é…</span></span><br><span class="line">... <span class="comment">// æ­¤å¤„é”€æ¯å¯¹è±¡çš„æœ€åä¸€ä¸ª std::weak_ptr;</span></span><br><span class="line"><span class="comment">// æ§åˆ¶å—å’Œå¯¹è±¡çš„å†…å­˜è¢«é‡Šæ”¾</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€šè¿‡ç›´æ¥ä½¿ç”¨ newï¼ŒReallyBigType å¯¹è±¡çš„å†…å­˜å¯ä»¥åœ¨æœ€åä¸€ä¸ªå¯¹å®ƒçš„ std::shared_ptr è¢«é”€æ¯åç«‹å³é‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReallyBigType</span>&#123;</span>...&#125;; <span class="comment">// ä¸ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;ReallyBigType&gt; <span class="title function_">pBigObj</span><span class="params">(new ReallyBigType)</span>;</span><br><span class="line"><span class="comment">// é€šè¿‡ new åˆ›å»ºéå¸¸å¤§çš„å¯¹è±¡</span></span><br><span class="line">... <span class="comment">// ä¸ä¹‹å‰ä¸€æ ·ï¼Œåˆ›å»ºå¯¹è±¡çš„ std::shared_ptrs å’Œ std::weak_ptrsï¼Œä¸ä¹‹ä¸€èµ·ä½¿ç”¨</span></span><br><span class="line">... <span class="comment">// æ­¤å¤„é”€æ¯å¯¹è±¡çš„æœ€åä¸€ä¸ª std::shared_ptrï¼Œä½†å¯¹å®ƒçš„ std::weak_ptrs ä»ç„¶å­˜åœ¨;</span></span><br><span class="line"><span class="comment">// å¯¹è±¡çš„å†…å­˜å·²è¢«é‡Šæ”¾</span></span><br><span class="line">... <span class="comment">// åœ¨è¿™æ®µæ—¶é—´å†…ï¼Œåªæœ‰æ§åˆ¶å—çš„å†…å­˜ä»ç„¶æœ‰æ•ˆ</span></span><br><span class="line">... <span class="comment">// æ­¤å¤„é”€æ¯å¯¹è±¡çš„æœ€åä¸€ä¸ª std::weak_ptr;</span></span><br><span class="line"><span class="comment">// æ§åˆ¶å—çš„å†…å­˜è¢«é‡Šæ”¾</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸é€‚åˆä½¿ç”¨ std::make_shared ï¼Œåˆå¸Œæœ›å…å—å¼‚å¸¸å®‰å…¨é—®é¢˜çš„å½±å“ã€‚æœ€å¥½çš„æ–¹æ³•æ˜¯ç¡®ä¿å½“ç›´æ¥ä½¿ç”¨ new æ—¶ï¼Œç«‹å³å°†ç»“æœä¼ é€’ç»™æ™ºèƒ½æŒ‡é’ˆæ„é€ å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">processWidget</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Widget&gt; spw, <span class="type">int</span> priority)</span>;<span class="comment">// åƒä»¥å‰ä¸€æ ·void cusDel(Widget *ptr); // è‡ªå®šä¹‰åˆ é™¤å™¨</span></span><br><span class="line"><span class="comment">// æ½œåœ¨çš„èµ„æºæ³„æ¼processWidget( std::shared_ptr&lt;Widget&gt;(new Widget, cusDel), computePriority() );</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Widget&gt; <span class="title function_">spw</span><span class="params">(new Widget, cusDel)</span>;</span><br><span class="line">processWidget(spw, computePriority()); <span class="comment">// æ­£ç¡®ï¼Œä½†ä¸æ˜¯æœ€ä½³çš„ï¼Œå‚æ•°å˜ä¸ºäº†å·¦å€¼</span></span><br><span class="line">processWidget(<span class="built_in">std</span>::move(spw), computePriority());<span class="comment">// æ—¢é«˜æ•ˆåˆå¼‚å¸¸å®‰å…¨</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>è¦ç‚¹</strong></p><ul><li>ä¸ä½¿ç”¨ new ç›¸æ¯”ï¼Œmake å‡½æ•°æ¶ˆé™¤äº†æºä»£ç é‡å¤ï¼Œæé«˜äº†å¼‚å¸¸å®‰å…¨æ€§ï¼Œå¹¶ä¸”å¯¹äº std::make_shared å’Œ std::allocate_sharedï¼Œç”Ÿæˆçš„ä»£ç æ›´å°ã€æ›´å¿«ã€‚</li><li>ä¸é€‚åˆä½¿ç”¨ make å‡½æ•°çš„æƒ…å†µåŒ…æ‹¬ï¼Œéœ€è¦æŒ‡å®šè‡ªå®šä¹‰åˆ é™¤å™¨å’Œå¸Œæœ›ä¼ é€’èŠ±æ‹¬å·åˆå§‹åŒ–å™¨ã€‚</li><li>å¯¹äº std::shared_ptrï¼Œä¸å»ºè®®ä½¿ç”¨ make å‡½æ•°çš„å…¶ä»–æƒ…å†µåŒ…æ‹¬ï¼ˆ1ï¼‰å…·æœ‰è‡ªå®šä¹‰å†…å­˜ç®¡ç†çš„ç±»ï¼›ï¼ˆ2ï¼‰æ³¨é‡å†…å­˜æ•ˆç‡çš„ç³»ç»Ÿï¼Œå…·æœ‰éå¸¸å¤§çš„å¯¹è±¡ä»¥åŠæ¯”ç›¸åº”çš„ std::shared_ptr å­˜æ´»æ—¶é—´æ›´é•¿çš„ std::weak_ptr</li></ul><hr><p><code>std::make_shared</code>æ˜¯ C++11 çš„ä¸€éƒ¨åˆ†ï¼Œä½†<code>std::make_unique</code>åˆ°äº† C++14 æ‰è¢«åŠ å…¥æ ‡å‡†åº“ï¼Œä¸è¿‡è¦å†™å‡ºä¸€ä¸ªåŸºç¡€ç‰ˆæœ¬çš„<code>std::make_unique</code>éå¸¸å®¹æ˜“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;T&gt; <span class="title">make_unique</span><span class="params">(Ts&amp;&amp;... params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;T&gt;(<span class="keyword">new</span> <span class="built_in">T</span>(std::forward&lt;Ts&gt;(params)...));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸å¯¹äºç›´æ¥ä½¿ç”¨<code>new</code>è¿ç®—ç¬¦ï¼Œmake å‡½æ•°æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>æ¶ˆé™¤é‡å¤ä»£ç ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">upw1</span><span class="params">(std::make_unique&lt;Widget&gt;())</span></span>;      <span class="comment">// ä½¿ç”¨ make å‡½æ•°</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;Widget&gt; <span class="title">upw2</span><span class="params">(<span class="keyword">new</span> Widget)</span></span>;   <span class="comment">// ä¸ä½¿ç”¨ make å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">spw1</span><span class="params">(std::make_shared&lt;Widget&gt;())</span></span>;      <span class="comment">// ä½¿ç”¨ make å‡½æ•°</span></span><br><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw2</span><span class="params">(<span class="keyword">new</span> Widget)</span></span>;   <span class="comment">// ä¸ä½¿ç”¨ make å‡½æ•°</span></span><br></pre></td></tr></table></figure><ul><li>æ”¹è¿›äº†å¼‚å¸¸å®‰å…¨æ€§ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">processWidget</span>(std::<span class="built_in">shared_ptr</span>&lt;Widget&gt;(<span class="keyword">new</span> Widget), <span class="built_in">computePriority</span>());  <span class="comment">// æœ‰æ½œåœ¨çš„å†…å­˜æ³„æ¼é£é™©</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">processWidget</span>(std::<span class="built_in">make_shared</span>&lt;Widget&gt;(), <span class="built_in">computePriority</span>());           <span class="comment">// ä¸å…·æœ‰æ½œåœ¨çš„å†…å­˜æ³„æ¼é£é™©</span></span><br></pre></td></tr></table></figure><p>åœ¨ç›´æ¥ä½¿ç”¨<code>new</code>è¿ç®—ç¬¦çš„æƒ…å†µä¸‹ï¼Œç”±äºåˆ†é…<code>Widget</code>å¯¹è±¡ã€æ‰§è¡Œ<code>std::shared_ptr</code>æ„é€ å‡½æ•°ã€æ‰§è¡Œ<code>computePriority</code>å‡½æ•°ä¸‰è€…å¹¶ä¸å­˜åœ¨å›ºå®šé¡ºåºï¼Œ<code>computePriority</code>å‡½æ•°å¯èƒ½ä¼šæ™šäº<code>Widget</code>å¯¹è±¡çš„åˆ†é…ï¼Œå…ˆäº<code>std::shared_ptr</code>çš„æ„é€ å‡½æ•°æ‰§è¡Œï¼Œæ­¤æ—¶è‹¥<code>computePriority</code>äº§ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆåˆ†é…çš„<code>Widget</code>å†…å­˜å°±ä¼šå‘ç”Ÿæ³„æ¼ã€‚ä½¿ç”¨<code>std::make_shared</code>åˆ™ä¸ä¼šäº§ç”Ÿè¿™ä¸ªé—®é¢˜ã€‚</p><ul><li>ä½¿ç”¨<code>std::make_shared</code>å’Œ<code>std::allocate_shared</code>æœ‰åŠ©äºç”Ÿæˆçš„å°ºå¯¸æ›´å°ã€é€Ÿåº¦æ›´å¿«çš„ç›®æ ‡ä»£ç ã€‚</li></ul><blockquote><p><code>std::make_shared</code>ä¼šå°†æŒ‡å‘çš„å¯¹è±¡å’Œä¸å…¶ç›¸å…³è”çš„æ§åˆ¶å—åˆ†é…åœ¨å•å—å†…å­˜ä¸­ï¼Œè¿™ç§ä¼˜åŒ–å‡å°‘äº†ç¨‹åºçš„é™æ€å°ºå¯¸ï¼Œå¹¶ä¸”å› ä¸ºåªè¿›è¡Œä¸€æ¬¡å†…å­˜åˆ†é…ï¼Œè¿˜å¯ä»¥åŠ å—ä»£ç çš„è¿è¡Œé€Ÿåº¦ã€‚ä½¿ç”¨<code>std::make_shared</code>è¿˜å¯ä»¥å‡å°‘å¯¹æ§åˆ¶å—ä¸€äº›ç°¿è®°ä¿¡æ¯ï¼ˆbookkeeping informationï¼‰çš„éœ€è¦ï¼Œæ½œåœ¨åœ°å‡å°‘äº†ç¨‹åºçš„å†…å­˜å ç”¨é‡ï¼ˆmemory footprintï¼‰ã€‚<code>std::allocate_shared</code>ä¹Ÿæ˜¯åŒç†ã€‚</p></blockquote><p>è™½ç„¶æœ‰ç€å¦‚æ­¤å¤šçš„ä¼˜åŠ¿ï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›æƒ…å½¢ä¸‹ï¼Œä¸èƒ½æˆ–è€…ä¸åº”è¯¥ä½¿ç”¨ make å‡½æ•°ï¼š</p><ul><li>ä½¿ç”¨ make å‡½æ•°æ— æ³•è‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œä»¥åŠç›´æ¥ä¼ é€’å¤§æ‹¬å·å†…çš„åˆå§‹å€¼è®¾å®šé¡¹ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æƒ³è¦è‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œå°±åªèƒ½ä½¿ç”¨ new è¿ç®—ç¬¦</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;Widget, <span class="title">decltype</span><span class="params">(widgetDeleter)</span>&gt; <span class="title">upw</span><span class="params">(<span class="keyword">new</span> Widget, widgetDeleter)</span></span>;</span><br><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt;                          <span class="title">spw</span><span class="params">(<span class="keyword">new</span> Widget, widgetDeleter)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªèƒ½é—´æ¥ä¼ é€’åˆå§‹åŒ–åˆ—è¡¨ç»™ make å‡½æ•°</span></span><br><span class="line"><span class="keyword">auto</span> initList = &#123; <span class="number">10</span>, <span class="number">20</span> &#125;;</span><br><span class="line"><span class="keyword">auto</span> spv = std::make_shared&lt;std::vector&lt;<span class="type">int</span>&gt;&gt;(initList);</span><br></pre></td></tr></table></figure><ul><li>ä¸å»ºè®®å¯¹è‡ªå®šä¹‰å†…å­˜ç®¡ç†æ–¹å¼çš„ç±»ä½¿ç”¨ make å‡½æ•°ï¼šé€šå¸¸æƒ…å†µä¸‹ï¼Œç±»è‡ªå®šä¹‰çš„<code>operator new</code>å’Œ<code>operator delete</code>è¢«è®¾è®¡æˆç”¨æ¥åˆ†é…å’Œé‡Šæ”¾èƒ½ç²¾ç¡®å®¹çº³è¯¥ç±»å¤§å°çš„å†…å­˜å—ï¼Œä½†<code>std::allocate_shared</code>æ‰€è¦æ±‚çš„å†…å­˜å¤§å°å¹¶ä¸ç­‰äºåŠ¨æ€åˆ†é…å¯¹è±¡çš„å¤§å°ï¼Œè€Œæ˜¯åœ¨å…¶åŸºç¡€ä¸ŠåŠ ä¸Šæ§åˆ¶å—çš„å¤§å°ã€‚å› æ­¤ï¼Œä½¿ç”¨ make å‡½æ•°å»åˆ›å»ºé‡è½½äº†<code>operator new</code>å’Œ<code>operator delete</code>ç±»çš„å¯¹è±¡ï¼Œé€šå¸¸å¹¶ä¸æ˜¯ä¸ªå¥½ä¸»æ„ã€‚</li><li>å½“å¤„äºç‰¹åˆ«å…³æ³¨å†…å­˜çš„ç³»ç»Ÿä¸­æ—¶ï¼Œè‹¥å­˜åœ¨éå¸¸å¤§çš„å¯¹è±¡å’Œæ¯”ç›¸åº”çš„<code>std::shared_ptr</code>ç”Ÿå­˜æœŸæ›´ä¹…çš„<code>std::weak_ptr</code>ï¼Œä¸å»ºè®®ä½¿ç”¨ make å‡½æ•°ï¼šè¿™ä¼šå¯¼è‡´å¯¹è±¡çš„ææ„å’Œå†…å­˜çš„é‡Šæ”¾ä¹‹é—´äº§ç”Ÿå»¶è¿Ÿï¼Œè€Œè‹¥ç›´æ¥ä½¿ç”¨<code>new</code>è¿ç®—ç¬¦ï¼Œå†…å­˜çš„é‡Šæ”¾å°±ä¸å¿…ç­‰å¾…<code>std::weak_ptr</code>çš„ææ„ã€‚</li></ul><p>å¦‚æœä½ å‘ç°è‡ªå·±å¤„äºä¸åº”è¯¥ä½¿ç”¨<code>std::make_shared</code>çš„æƒ…å½¢ä¸‹ï¼Œåˆä¸æƒ³å—åˆ°ä¹‹å‰æ‰€è¿°å¼‚å¸¸å®‰å…¨é—®é¢˜çš„å½±å“ã€‚æœ€å¥½çš„æ–¹æ³•æ˜¯ç¡®ä¿åœ¨ç›´æ¥ä½¿ç”¨<code>new</code>æ—¶ï¼Œç«‹å³å°†ç»“æœä¼ é€’ç»™æ™ºèƒ½æŒ‡é’ˆçš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”åœ¨è¿™æ¡è¯­å¥ä¸­ä¸åšå…¶å®ƒä»»ä½•äº‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw</span><span class="params">(<span class="keyword">new</span> Widget, cusDel)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">processWidget</span>(std::<span class="built_in">move</span>(spw), <span class="built_in">computePriority</span>());</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-22ï¼šä½¿ç”¨-Pimpl-æƒ¯ç”¨æ³•æ—¶ï¼Œå°†ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„å®šä¹‰æ”¾åˆ°å®ç°æ–‡ä»¶ä¸­">æ¡æ¬¾ 22ï¼šä½¿ç”¨ Pimpl æƒ¯ç”¨æ³•æ—¶ï¼Œå°†ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„å®šä¹‰æ”¾åˆ°å®ç°æ–‡ä»¶ä¸­</h3><p>Pimpl æƒ¯ç”¨æ³•çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œæ˜¯å£°æ˜ä¸€ä¸ªæŒ‡é’ˆç±»å‹çš„æ•°æ®æˆå‘˜ï¼ŒæŒ‡å‘ä¸€ä¸ªéå®Œæ•´ç±»å‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line">    <span class="built_in">Widget</span>();</span><br><span class="line">    ~<span class="built_in">Widget</span>();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Impl</span>;</span><br><span class="line">    Impl* pImpl;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒéƒ¨åˆ†æ˜¯åŠ¨æ€åˆ†é…å’Œå›æ”¶æŒæœ‰åŸå§‹ç±»ä¸­æ•°æ®æˆå‘˜çš„å¯¹è±¡ï¼Œè€Œåˆ†é…å’Œå›æ”¶çš„ä»£ç è¢«æ”¾åœ¨å®ç°æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Widget</span>::Impl &#123;                   <span class="comment">// Widget::Impl çš„å®ç°</span></span><br><span class="line">    std::string name;                   <span class="comment">// åŒ…å«åœ¨åŸå§‹ Widget ç±»ä¸­çš„æ•°æ®æˆå‘˜</span></span><br><span class="line">    std::vector&lt;<span class="type">double</span>&gt; data;</span><br><span class="line">    Gadget g1, g2, g3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Widget::<span class="built_in">Widget</span>() : <span class="built_in">pImpl</span>(<span class="keyword">new</span> Impl) &#123;&#125;   <span class="comment">// ä¸º Widget å¯¹è±¡åˆ†é…æ•°æ®æˆå‘˜æ‰€éœ€å†…å­˜</span></span><br><span class="line"></span><br><span class="line">Widget::~<span class="built_in">Widget</span>() &#123; <span class="keyword">delete</span> pImpl; &#125;     <span class="comment">// ä¸º Widget å¯¹è±¡ææ„æ•°æ®æˆå‘˜</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢å±•ç¤ºçš„æ˜¯ C++98 çš„å†™æ³•ï¼Œä½¿ç”¨äº†è£¸æŒ‡é’ˆã€è£¸<code>new</code>è¿ç®—ç¬¦å’Œè£¸<code>delete</code>è¿ç®—ç¬¦ã€‚è€Œåˆ°äº† C++11ï¼Œä½¿ç”¨<code>std::unique_ptr</code>æ›¿ä»£æŒ‡å‘<code>Impl</code>çš„è£¸æŒ‡é’ˆæˆä¸ºäº†é¦–é€‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜ä»£ç ä½äºå¤´æ–‡ä»¶ widget.h å†…</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line">    <span class="built_in">Widget</span>();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Impl</span>;</span><br><span class="line">    std::unique_ptr&lt;Impl&gt; pImpl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°ä»£ç ä½äºå®ç°æ–‡ä»¶ widget.cpp å†…</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Widget</span>::Impl &#123;   <span class="comment">// åŒå‰</span></span><br><span class="line">    std::string name;</span><br><span class="line">    std::vector&lt;<span class="type">double</span>&gt; data;</span><br><span class="line">    Gadget g1, g2, g3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Widget::<span class="built_in">Widget</span>() : <span class="built_in">pImpl</span>(std::<span class="built_in">make_unique</span>&lt;Impl&gt;()) &#123;&#125;</span><br></pre></td></tr></table></figure><p>é—æ†¾çš„æ˜¯ï¼Œè¿™æ®µä»£ç æœ¬èº«èƒ½é€šè¿‡ç¼–è¯‘ï¼Œä½†åœ¨åˆ›å»ºå¯¹è±¡æ—¶å´ä¼šæŠ¥é”™ã€‚å› ä¸ºç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ææ„å‡½æ•°é»˜è®¤æ˜¯<code>inline</code>çš„ï¼Œè€Œ<code>std::unique_ptr</code>çš„é»˜è®¤åˆ é™¤å™¨è¦æ±‚å…¶æŒ‡å‘å®Œæ•´ç±»å‹ï¼Œæ‰€ä»¥å³ä½¿é»˜è®¤ç‰¹æ®Šå‡½æ•°çš„å®ç°æœ‰ç€æ­£ç¡®è¡Œä¸ºï¼Œæˆ‘ä»¬ä»å¿…é¡»å°†å…¶å£°æ˜å’Œå®ç°åˆ†ç¦»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜ä»£ç ä½äºå¤´æ–‡ä»¶ widget.h å†…</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line">    <span class="built_in">Widget</span>();</span><br><span class="line">    ~<span class="built_in">Widget</span>()</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Impl</span>;</span><br><span class="line">    std::unique_ptr&lt;Impl&gt; pImpl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°ä»£ç ä½äºå®ç°æ–‡ä»¶ widget.cpp å†…</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Widget::<span class="built_in">Widget</span>() : <span class="built_in">pImpl</span>(std::<span class="built_in">make_unique</span>&lt;Impl&gt;()) &#123;&#125;</span><br><span class="line"></span><br><span class="line">Widget::~<span class="built_in">Widget</span>() &#123;&#125;    <span class="comment">// å†™æˆ Widget::~Widget() = default; æ•ˆæœç›¸åŒ</span></span><br></pre></td></tr></table></figure><p>åœ¨<strong>æ¡æ¬¾ 17</strong> ä¸­æˆ‘ä»¬æåˆ°ï¼Œå£°æ˜ææ„å‡½æ•°ä¼šé˜»æ­¢ç¼–è¯‘å™¨ç”Ÿæˆç§»åŠ¨æ“ä½œï¼Œæ‰€ä»¥å‡å¦‚ä½ éœ€è¦æ”¯æŒç§»åŠ¨æ“ä½œï¼Œä¹Ÿå¿…é¡»é‡‡ç”¨å£°æ˜å’Œå®ç°åˆ†ç¦»çš„æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜ä»£ç ä½äºå¤´æ–‡ä»¶ widget.h å†…</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">Widget</span>(Widget&amp;&amp; rhs);</span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>=(Widget&amp;&amp; rhs);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°ä»£ç ä½äºå®ç°æ–‡ä»¶ widget.cpp å†…</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Widget::<span class="built_in">Widget</span>(Widget&amp;&amp; rhs) = <span class="keyword">default</span>;</span><br><span class="line">Widget&amp; Widget::<span class="keyword">operator</span>=(Widget&amp;&amp; rhs) = <span class="keyword">default</span>;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨ä¸ä¼šä¸ºå¸¦æœ‰<code>std::unique_ptr</code>è¿™ç§åªç§»ç±»å‹çš„ç±»ç”Ÿæˆæ‹·è´æ“ä½œï¼Œå‡å¦‚ä½ éœ€è¦æ”¯æŒæ‹·è´æ“ä½œï¼Œåˆ™éœ€è¦è‡ªè¡Œç¼–å†™æ‰§è¡Œæ·±æ‹·è´çš„å‡½æ•°å®ç°ï¼Œå¹¶ä¸”åŒæ ·éœ€è¦éµå®ˆå‰é¢æ‰€è¯´çš„è§„åˆ™ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜ä»£ç ä½äºå¤´æ–‡ä»¶ widget.h å†…</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">Widget</span>(<span class="type">const</span> Widget&amp; rhs);</span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Widget&amp; rhs);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°ä»£ç ä½äºå®ç°æ–‡ä»¶ widget.cpp å†…</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Widget::<span class="built_in">Widget</span>(<span class="type">const</span> Widget&amp; rhs)</span><br><span class="line">    : <span class="built_in">pImpl</span>(std::<span class="built_in">make_unique</span>&lt;Impl&gt;(*rhs.pImpl)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">Widget&amp; Widget::<span class="keyword">operator</span>=(<span class="type">const</span> Widget&amp; rhs) &#123;</span><br><span class="line">    *pImpl = *rhs.pImpl;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å»ºè®®ä»…ä»…é€‚ç”¨äº<code>std::unique_ptr</code>ï¼Œè€Œä¸é€‚ç”¨äº<code>std::shared_ptr</code>ã€‚å¯¹äº<code>std::shared_ptr</code>è€Œè¨€ï¼Œåˆ é™¤å™¨ç±»å‹å¹¶éæ™ºèƒ½æŒ‡é’ˆç±»å‹çš„ä¸€éƒ¨åˆ†ï¼Œè¿™å°±ä¼šå¯¼è‡´æ›´å¤§çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ä»¥åŠæ›´æ…¢çš„ç›®æ ‡ä»£ç ï¼Œä½†åœ¨ä½¿ç”¨ç¼–è¯‘å™¨ç”Ÿæˆçš„ç‰¹æ®Šå‡½æ•°æ—¶ï¼Œå¹¶ä¸è¦æ±‚å…¶æŒ‡å‘å®Œæ•´ç±»å‹ã€‚ä»¥ä¸‹ä»£ç å¹¶ä¸ä¼šäº§ç”Ÿé—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line">    <span class="built_in">Widget</span>();</span><br><span class="line">    ...         <span class="comment">// ä¸å†éœ€è¦ææ„å‡½æ•°æˆ–ç§»åŠ¨æ“ä½œçš„å£°æ˜</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Impl</span>;</span><br><span class="line">    std::shared_ptr&lt;Impl&gt; pImpl;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å°± Pimpl æƒ¯ç”¨æ³•è€Œè¨€ï¼Œå¹¶ä¸éœ€è¦åœ¨<code>std::unique_ptr</code>å’Œ<code>std::shared_ptr</code>çš„ç‰¹æ€§ä¹‹é—´ä½œå‡ºæƒè¡¡ï¼Œå› ä¸º<code>Widget</code>å’Œ<code>Impl</code>ä¹‹é—´çš„å…³ç³»æ˜¯ä¸“å±æ‰€æœ‰æƒï¼Œæ‰€ä»¥åœ¨æ­¤å¤„<code>std::unique_ptr</code>å°±æ˜¯å®Œæˆä»»åŠ¡çš„åˆé€‚å·¥å…·ã€‚</p><h2 id="ç¬¬äº”ç« ï¼šå³å€¼å¼•ç”¨ã€ç§»åŠ¨è¯­ä¹‰å’Œå®Œç¾è½¬å‘">ç¬¬äº”ç« ï¼šå³å€¼å¼•ç”¨ã€ç§»åŠ¨è¯­ä¹‰å’Œå®Œç¾è½¬å‘</h2><p>åœ¨é˜…è¯»æœ¬ç« ä¸­çš„æ¡æ¬¾æ—¶ï¼Œéœ€è¦é“­è®°ä¸€ç‚¹ï¼šå½¢å‚æ€»æ˜¯å·¦å€¼ï¼Œå³ä½¿å…¶ç±»å‹æ˜¯å³å€¼å¼•ç”¨ã€‚ä¾‹å¦‚ç»™å®šå‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(Widget&amp;&amp; w)</span></span>;</span><br></pre></td></tr></table></figure><p>å°½ç®¡å½¢å‚<code>w</code>çš„ç±»å‹æ˜¯æŒ‡å‘<code>Widget</code>å¯¹è±¡çš„å³å€¼å¼•ç”¨ï¼Œå¯ä»¥ä¼ å…¥ç»‘å®šåˆ°å³å€¼çš„å®å‚ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸ªå·¦å€¼ã€‚</p><h3 id="æ¡æ¬¾-23ï¼šç†è§£-std-move-å’Œ-std-forward">æ¡æ¬¾ 23ï¼šç†è§£ std::move å’Œ std::forward</h3><hr><p>é‡ç‚¹ï¼š</p><p><strong>std::move å’Œ std::forward ä»…ä»…æ˜¯æ‰§è¡Œç±»å‹è½¬æ¢çš„å‡½æ•°ï¼ˆå®é™…ä¸Šæ˜¯å‡½æ•°æ¨¡æ¿ï¼‰</strong></p><p>std::move æ— æ¡ä»¶åœ°å°†å…¶å‚æ•°è½¬æ¢ä¸ºå³å€¼ï¼Œè€Œ std::forward åªæœ‰åœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶æ‰æ‰§è¡Œæ­¤è½¬æ¢ã€‚</p><p>å³å€¼åªæ˜¯ç§»åŠ¨çš„å€™é€‰è€…ã€‚</p><blockquote><p>æ¥çœ‹ä¸ªcase:</p></blockquote><p>ç»“è®ºï¼šå¦‚æœå¸Œæœ›è¿›è¡Œç§»åŠ¨æ“ä½œï¼Œä¸è¦å£°æ˜å¯¹è±¡ä¸ºconstã€‚å¯¹å¸¸é‡å¯¹è±¡çš„ç§»åŠ¨è¯·æ±‚ä¼šé»˜é»˜åœ°è½¬æ¢ä¸ºæ‹·è´æ“ä½œã€‚</p><p>stringæ„é€ å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span>(<span class="type">const</span> <span class="built_in">string</span>&amp; rhs); Â <span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="built_in">string</span>(<span class="built_in">string</span>&amp;&amp; rhs); Â  Â  Â  <span class="comment">// ç§»åŠ¨æ„é€ å‡½æ•°</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Annotation</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">Â  Â  explicit <span class="title function_">Annotation</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> text)</span>:<span class="title function_">value</span><span class="params">(<span class="built_in">std</span>::move(text))</span><span class="comment">//å¹¶ä¸åƒçœ‹ä¸Šå»è¿™æ ·ï¼</span></span><br><span class="line">Â  Â  &#123;... &#125;  </span><br><span class="line">Â  Â  <span class="comment">//...</span></span><br><span class="line">private:</span><br><span class="line">Â  Â  <span class="built_in">std</span>::<span class="built_in">string</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>text æ˜¯ä¸€ä¸ªå·¦å€¼ const std::stringï¼Œè½¬æ¢çš„ç»“æœæ˜¯ä¸€ä¸ªå³å€¼ const std::stringï¼Œä½†å§‹ç»ˆä¿æŒå¸¸é‡æ€§</strong>ã€‚</p><p>ç»“æœå°±æ˜¯ï¼Œtext æ²¡æœ‰è¢«ç§»åŠ¨åˆ° value ä¸­ï¼Œè€Œæ˜¯è¢«æ‹·è´äº†ã€‚</p><p><strong>ç®€å•æ¥è¯´</strong>ï¼šä¸€ä¸ªå³å€¼å¼•ç”¨ï¼Œç¼–è¯‘å™¨å…ˆæ‰¾æœ‰æ²¡æœ‰åŒ¹é…çš„fun(A &amp;&amp;)ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ‰¾fun(const A&amp;a)</p><blockquote><p><strong>std::move å’Œ std::forward</strong></p></blockquote><p>æ—¢ç„¶ std::move å’Œ std::forward éƒ½å½’ç»“ä¸ºè½¬æ¢ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ std::move æ€»æ˜¯è¿›è¡Œè½¬æ¢ï¼Œè€Œ std::forward åªæ˜¯æœ‰æ—¶è¿›è¡Œè½¬æ¢</p><p><strong>è¦ç‚¹</strong></p><ul><li>std::moveæ‰§è¡Œæ— æ¡ä»¶è½¬æ¢ä¸ºå³å€¼ã€‚å°±å…¶æœ¬èº«è€Œè¨€ï¼Œå®ƒä¸ä¼šç§»åŠ¨ä»»ä½•ä¸œè¥¿</li><li>åªæœ‰å½“å‚æ•°ç»‘å®šåˆ°å³å€¼æ—¶ï¼Œstd::forward æ‰ä¼šå°†å…¶å‚æ•°è½¬æ¢ä¸ºå³å€¼</li><li>std::move å’Œ std::forward åœ¨è¿è¡Œæ—¶éƒ½ä¸ä¼šåšä»»ä½•äº‹æƒ…</li></ul><hr><p><code>std::move</code>æ‰§è¡Œçš„æ˜¯å‘å³å€¼çš„æ— æ¡ä»¶å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå°±å…¶è‡ªèº«è€Œè¨€ï¼Œå®ƒä¸ä¼šç§»åŠ¨ä»»ä½•ä¸œè¥¿ã€‚å®ƒçš„åŸºæœ¬å®ç°å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C++11 ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> remove_reference&lt;T&gt;::<span class="function">type&amp;&amp; <span class="title">move</span><span class="params">(T&amp;&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ReturnType = <span class="keyword">typename</span> remove_reference&lt;T&gt;::type&amp;&amp;;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;ReturnType&gt;(param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C++14 ç‰ˆæœ¬</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">move</span><span class="params">(T&amp;&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ReturnType = <span class="type">remove_reference_t</span>&lt;T&gt;&amp;&amp;;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;ReturnType&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>std::move</code>å¹¶ä¸æ”¹å˜å¸¸é‡æ€§ï¼Œä¹Ÿä¸ä¿è¯ç»è¿‡å…¶å¼ºåˆ¶ç±»å‹è½¬æ¢åçš„å¯¹è±¡å¯è¢«ç§»åŠ¨ï¼Œé’ˆå¯¹å¸¸é‡å¯¹è±¡æ‰§è¡Œçš„ç§»åŠ¨æ“ä½œå¯èƒ½ä¼šæ‚„æ— å£°æ¯åœ°è½¬åŒ–ä¸ºæ‹·è´æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Annotation</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Annotation</span><span class="params">(<span class="type">const</span> std::string text)</span></span></span><br><span class="line"><span class="function">        : value(std::move(text)) &#123;</span> ... &#125;    <span class="comment">// æƒ³è¦å°† text â€œç§»åŠ¨å…¥â€ value</span></span><br><span class="line">    ...                                     <span class="comment">// ä½†å®é™…ä¸Šæ‰§è¡Œäº† std::string çš„æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">                                            <span class="comment">// è€Œéç§»åŠ¨æ„é€ å‡½æ•° string(string&amp;&amp;)</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œå¦‚æœæƒ³è¦å–å¾—å¯¹æŸä¸ªå¯¹è±¡æ‰§è¡Œç§»åŠ¨æ“ä½œçš„èƒ½åŠ›ï¼Œå°±ä¸è¦å°†å…¶å£°æ˜ä¸ºå¸¸é‡ã€‚</p><p>ä¸<code>std::move</code>ä¸åŒï¼Œ<code>std::forward</code>æ˜¯æœ‰æ¡ä»¶çš„ã€‚ä»…å½“ä¼ å…¥çš„å®å‚è¢«ç»‘å®šåˆ°å³å€¼æ—¶ï¼Œ<code>std::forward</code>æ‰ä¼šé’ˆå¯¹è¯¥å®å‚æ‰§è¡Œå‘å³å€¼çš„å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå®ƒåŒæ ·ä¸ä¼šè½¬å‘ä»»ä½•ä¸œè¥¿ã€‚</p><p><code>std::forward</code>çš„ä¸€ä¸ªå…¸å‹åº”ç”¨åœºæ™¯ï¼Œæ˜¯æŸä¸ªå‡½æ•°æ¨¡æ¿ä½¿ç”¨ä¸‡èƒ½å¼•ç”¨ä½œä¸ºå½¢å‚ï¼Œéšåå°†å…¶ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">(<span class="type">const</span> Widget&amp; lvalArg)</span></span>;    <span class="comment">// å¤„ç†å·¦å€¼</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">(Widget&amp;&amp; rvalArg)</span></span>;         <span class="comment">// å¤„ç†å³å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">logAndProcess</span><span class="params">(T&amp;&amp; param)</span> </span>&#123;         <span class="comment">// ä½¿ç”¨ä¸‡èƒ½å¼•ç”¨ä½œä¸ºå®å‚</span></span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">makeLogEntry</span>(<span class="string">&quot;Calling &#x27;process&#x27;&quot;</span>, now);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">process</span>(std::forward&lt;T&gt;(param));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‹¥åœ¨è°ƒç”¨<code>logAndProcess</code>æ—¶ä¼ å…¥å·¦å€¼ï¼Œé‚£ä¹ˆè¯¥å·¦å€¼è‡ªç„¶ä¼šä¼ é€’ç»™å¤„ç†å·¦å€¼ç‰ˆæœ¬çš„<code>process</code>å‡½æ•°ï¼›è‹¥åœ¨è°ƒç”¨<code>logAndProcess</code>æ—¶ä¼ å…¥å³å€¼ï¼Œç”±äºå‡½æ•°å½¢å‚çš†ä¸ºå·¦å€¼ï¼Œå¿…é¡»è¦é€šè¿‡<code>std::forward</code>å°†<code>param</code>å¼ºåˆ¶è½¬æ¢ä¸ºå³å€¼ç±»å‹ï¼Œæ‰èƒ½å¾—ä»¥æ­£ç¡®è°ƒç”¨å¤„ç†å³å€¼ç‰ˆæœ¬çš„<code>process</code>å‡½æ•°ã€‚<code>std::forward</code>ä¼šé€šè¿‡æ¨¡æ¿ç±»å‹<code>T</code>æ¥åˆ¤æ–­æ˜¯å¦è¯¥å¯¹<code>param</code>è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå…·ä½“çš„åŸç†ç»†èŠ‚å‚è€ƒ<strong>æ¡æ¬¾ 28</strong>ã€‚</p><p>å°½ç®¡<code>std::move</code>å’Œ<code>std::forward</code>å½’æ ¹ç»“åº•éƒ½æ˜¯å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä½†ä¸¤è€…çš„è¡Œä¸ºå…·æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼šå‰è€…ç”¨äºä¸ºç§»åŠ¨æ“ä½œè¿›è¡Œé“ºå«ï¼Œè€Œåè€…ä»…ä»…ç”¨äºè½¬å‘ä¸€ä¸ªå¯¹è±¡åˆ°å¦ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­è¯¥å¯¹è±¡ä»ä¿æŒåŸæ¥çš„å·¦å€¼æ€§æˆ–å³å€¼æ€§ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿è¡ŒæœŸï¼Œ<code>std::move</code>å’Œ<code>std::forward</code>éƒ½ä¸ä¼šåšä»»ä½•æ“ä½œã€‚</p></blockquote><h3 id="æ¡æ¬¾-24ï¼šåŒºåˆ†ä¸‡èƒ½å¼•ç”¨å’Œå³å€¼å¼•ç”¨">æ¡æ¬¾ 24ï¼šåŒºåˆ†ä¸‡èƒ½å¼•ç”¨å’Œå³å€¼å¼•ç”¨</h3><hr><p><strong>é€šç”¨å¼•ç”¨2ä¸ªæ¡ä»¶ï¼š</strong></p><p>1ï¼šT&amp;&amp; / auto &amp;&amp;</p><p>2.å­˜åœ¨ç±»å‹æ¨å¯¼</p><p><strong>å³å€¼å¼•ç”¨</strong>ï¼Œä¸æ˜¯é€šç”¨å¼•ç”¨å°±æ˜¯å³å€¼å¼•ç”¨ã€‚</p><hr><p>å¦‚æœå‡½æ•°æ¨¡æ¿å½¢å‚çš„ç±»å‹ä¸º<code>T&amp;&amp;</code>ï¼Œå¹¶ä¸” T çš„ç±»å‹éœ€è¦æ¨å¯¼å¾—åˆ°ï¼Œæˆ–ä¸€ä¸ªå¯¹è±¡ä½¿ç”¨<code>auto&amp;&amp;</code>å£°æ˜å…¶ç±»å‹ï¼Œåˆ™æ­¤å¤„çš„<code>T&amp;&amp;</code>å’Œ<code>auto&amp;&amp;</code>è¡¨ç¤º<strong>ä¸‡èƒ½å¼•ç”¨ï¼ˆuniversal referenceï¼‰</strong>ï¼›å¦‚æœç±»å‹å£°æ˜ä¸æ˜¯æ ‡å‡†çš„<code>type&amp;&amp;</code>å½¢å¼ï¼Œæˆ–è€…å¹¶æœªå‘ç”Ÿç±»å‹æ¨å¯¼ï¼Œåˆ™æ­¤å¤„çš„<code>type&amp;&amp;</code>è¡¨ç¤ºå³å€¼å¼•ç”¨ã€‚</p><p>ç¬¦åˆä¸‡èƒ½å¼•ç”¨çš„æƒ…å½¢å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span>&amp;&amp; var2 = var1;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">Allocator</span> = allocator&lt;T&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> vector &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">class</span>... Args&gt;</span><br><span class="line">    <span class="type">void</span> <span class="built_in">emplace_back</span>(Args&amp;&amp;... args);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> timeFuncInvocation = [](<span class="keyword">auto</span>&amp;&amp; func, <span class="keyword">auto</span>&amp;&amp;... params) &#123;   <span class="comment">// C++14</span></span><br><span class="line">    std::forward&lt;<span class="keyword">decltype</span>(func)&gt;(func)(                         <span class="comment">// è°ƒç”¨ func</span></span><br><span class="line">        std::forward&lt;<span class="keyword">decltype</span>(params)&gt;(params)...               <span class="comment">// å–ç”¨ params</span></span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç±»å‹å£°æ˜ä¸æ˜¯æ ‡å‡†<code>type&amp;&amp;</code>çš„æƒ…å½¢å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(std::vector&lt;T&gt;&amp;&amp; param)</span></span>; <span class="comment">// param æ˜¯å³å€¼å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">const</span> T&amp;&amp; param)</span></span>;        <span class="comment">// param æ˜¯å³å€¼å¼•ç”¨</span></span><br></pre></td></tr></table></figure><p>ç±»å‹æ˜¯<code>T&amp;&amp;</code>ï¼Œä½†å¹¶æœªå‘ç”Ÿç±»å‹æ¨å¯¼çš„æƒ…å½¢å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">Allocator</span> = allocator&lt;T&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> vector &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">void</span> <span class="built_in">push_back</span>(T&amp;&amp; x);  <span class="comment">// x æ˜¯å³å€¼å¼•ç”¨</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è‹¥ä½¿ç”¨å³å€¼æ¥åˆå§‹åŒ–ä¸‡èƒ½å¼•ç”¨ï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªå³å€¼å¼•ç”¨ï¼›åŒç†ï¼Œè‹¥ä½¿ç”¨å·¦å€¼æ¥åˆå§‹åŒ–ä¸‡èƒ½å¼•ç”¨ï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªå·¦å€¼å¼•ç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; param)</span></span>;  <span class="comment">// param æ˜¯ä¸‡èƒ½å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">Widget w;</span><br><span class="line"><span class="built_in">f</span>(w);               <span class="comment">// å·¦å€¼è¢«ä¼ é€’ç»™ fï¼Œparam çš„ç±»å‹ä¸º Widget&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(std::<span class="built_in">move</span>(w));    <span class="comment">// å³å€¼è¢«ä¼ é€’ç»™ fï¼Œparam çš„ç±»å‹ä¸º Widget&amp;&amp;</span></span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-25ï¼šé’ˆå¯¹å³å€¼å¼•ç”¨å®æ–½-std-moveï¼Œé’ˆå¯¹ä¸‡èƒ½å¼•ç”¨å®æ–½-std-forward">æ¡æ¬¾ 25ï¼šé’ˆå¯¹å³å€¼å¼•ç”¨å®æ–½ std::moveï¼Œé’ˆå¯¹ä¸‡èƒ½å¼•ç”¨å®æ–½ std::forward</h3><hr><p>å³å€¼å¼•ç”¨ std::moveï¼Œä¸‡èƒ½å¼•ç”¨ std::forwardã€‚</p><blockquote><p><strong>ex1</strong></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Matrix <span class="comment">// æŒ‰å€¼è¿”å›</span></span><br><span class="line">operator+(Matrix&amp;&amp; lhs, <span class="type">const</span> Matrix&amp; rhs)&#123;</span><br><span class="line">Â  Â  lhs += rhs;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> <span class="built_in">std</span>::move(lhs); <span class="comment">// å°† lhs ç§»åŠ¨åˆ°è¿”å›å€¼ä¸­</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>é€šè¿‡åœ¨è¿”å›è¯­å¥ä¸­ï¼ˆé€šè¿‡ std::moveï¼‰å°† lhs å¼ºåˆ¶è½¬æ¢ä¸ºå³å€¼ï¼Œlhs å°†è¢«ç§»åŠ¨åˆ°å‡½æ•°çš„è¿”å›å€¼ä½ç½®</p><p>å¦‚æœçœç•¥äº†å¯¹ std::move çš„è°ƒç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Matrix </span><br><span class="line">operator+(Matrix&amp;&amp; lhs, <span class="type">const</span> Matrix&amp; rhs)&#123;</span><br><span class="line">Â  Â  lhs += rhs;</span><br><span class="line">Â  Â  <span class="keyword">return</span> lhs; <span class="comment">// å°† lhs æ‹·è´åˆ°è¿”å›å€¼</span></span><br><span class="line">&#125; Â </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šï¼Œlhsæ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œè¿™ä¼šè¿«ä½¿ç¼–è¯‘å™¨å°†å®ƒæ‹·è´åˆ°è¿”å›å€¼çš„ä½ç½®</p><blockquote><p><strong>ex2</strong></p></blockquote><p>RVO åªèƒ½åœ¨è¿”å›çš„æ˜¯å±€éƒ¨å¯¹è±¡çš„æƒ…å†µä¸‹æ‰§è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">std</span>::move(w);<span class="comment">//è¿”å›çš„ä¸æ˜¯å±€éƒ¨å¯¹è±¡ wï¼Œè€Œæ˜¯ w çš„å¼•ç”¨</span></span><br></pre></td></tr></table></figure><p><strong>è¦ç‚¹</strong></p><ul><li>å¯¹äºå³å€¼å¼•ç”¨ä½¿ç”¨ std::moveï¼Œå¯¹äºé€šç”¨å¼•ç”¨ä½¿ç”¨ std::forwardï¼Œä¸”éƒ½åœ¨æœ€åä¸€æ¬¡ä½¿ç”¨æ—¶è¿›è¡Œ</li><li>å¯¹äºæŒ‰å€¼è¿”å›çš„å‡½æ•°ï¼Œè¿”å›çš„å³å€¼å¼•ç”¨å’Œé€šç”¨å¼•ç”¨ï¼Œä¹Ÿæ‰§è¡Œç›¸åŒçš„æ“ä½œ</li><li>å¦‚æœå±€éƒ¨å¯¹è±¡æœ¬æ¥å¯ä»¥è¿›è¡Œè¿”å›å€¼ä¼˜åŒ–ï¼Œå°±ä¸è¦å¯¹å®ƒä»¬åº”ç”¨ std::move æˆ– std::forward</li></ul><hr><p>å³å€¼å¼•ç”¨ä¸€å®šä¼šè¢«ç»‘å®šåˆ°å³å€¼ï¼Œå› æ­¤å½“è½¬å‘å³å€¼å¼•ç”¨ç»™å…¶ä»–å‡½æ•°æ—¶ï¼Œåº”å½“é€šè¿‡<code>std::move</code>å¯¹å…¶å®æ–½å‘å³å€¼çš„æ— æ¡ä»¶å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Widget</span>(Widget&amp;&amp; rhs)</span><br><span class="line">        : <span class="built_in">name</span>(std::<span class="built_in">move</span>(rhs.name)),</span><br><span class="line">          <span class="built_in">p</span>(std::<span class="built_in">move</span>(rhs.p)) &#123; ... &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string name;</span><br><span class="line">    std::shared_ptr&lt;SomeDataStructure&gt; p;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œä¸‡èƒ½å¼•ç”¨ä¸ä¸€å®šä¼šè¢«ç»‘å®šåˆ°å³å€¼ï¼Œå› æ­¤å½“è½¬å‘ä¸‡èƒ½å¼•ç”¨æ—¶ï¼Œåº”å½“é€šè¿‡<code>std::forward</code>å¯¹å…¶å®æ–½å‘å³å€¼çš„æœ‰æ¡ä»¶å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">setName</span><span class="params">(T&amp;&amp; newName)</span> </span>&#123;</span><br><span class="line">        name = std::forward&lt;T&gt;(newName);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è™½ç„¶é’ˆå¯¹å³å€¼å¼•ç”¨å®æ–½<code>std::forward</code>ä¹Ÿèƒ½ç¡¬å¼„å‡ºæ­£ç¡®è¡Œä¸ºï¼Œä½†ä»£ç å•°å—¦ã€æ˜“é”™ï¼Œä¸”ä¸ç¬¦åˆä¹ æƒ¯ç”¨æ³•ï¼›è€Œé’ˆå¯¹ä¸‡èƒ½å¼•ç”¨å®æ–½<code>std::move</code>ä¼šé€ æˆæ›´åŠ ä¸¥é‡çš„åæœï¼Œè¿™ä¼šå¯¼è‡´æŸäº›å·¦å€¼é­å—æ„å¤–çš„æ”¹åŠ¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">setName</span><span class="params">(T&amp;&amp; newName)</span> </span>&#123;</span><br><span class="line">        name = std::<span class="built_in">move</span>(newName);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string name;</span><br><span class="line">    std::shared_ptr&lt;SomeDataStructure&gt; p;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">getWidgetName</span><span class="params">()</span></span>;    <span class="comment">// å·¥å‚å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">Widget w;</span><br><span class="line"><span class="keyword">auto</span> n = <span class="built_in">getWidgetName</span>();</span><br><span class="line">w.<span class="built_in">setName</span>(n);               <span class="comment">// å°† n ç§»å…¥ w</span></span><br><span class="line">...                         <span class="comment">// n çš„å€¼å˜ä¸ºæœªçŸ¥</span></span><br></pre></td></tr></table></figure><p>ä¸€ç§æ‰‹æ³•æ˜¯å°†ä¸‡èƒ½å¼•ç”¨çš„ç‰ˆæœ¬æ”¹æˆå¯¹å·¦å€¼å’Œå³å€¼åˆ†åˆ«è¿›è¡Œé‡è½½ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setName</span><span class="params">(<span class="type">const</span> std::string&amp; newName)</span> </span>&#123;</span><br><span class="line">        name = newName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setName</span><span class="params">(std::string&amp;&amp; newName)</span> </span>&#123;</span><br><span class="line">        name = std::<span class="built_in">move</span>(newName);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ‰‹æ³•è™½ç„¶çœ‹ä¼¼å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯æ‹¥æœ‰æ›´å¤§çš„ç¼ºç‚¹ï¼šç¬¬ä¸€ï¼Œéœ€è¦ç¼–å†™å’Œç»´æŠ¤æ›´å¤šæºç ï¼›ç¬¬äºŒï¼Œæ•ˆç‡ä¼šå¤§æ‰“æŠ˜æ‰£ï¼ˆäº§ç”Ÿé¢å¤–çš„ä¸´æ—¶å¯¹è±¡ï¼‰ï¼›ç¬¬ä¸‰ï¼Œå¯æ‰©å±•æ€§å¤ªå·®ã€‚å› æ­¤ï¼Œæ­£ç¡®åœ°ä½¿ç”¨ä¸‡èƒ½å¼•ç”¨æ‰æ˜¯é—®é¢˜çš„å”¯ä¸€è§£å†³ä¹‹é“ã€‚</p><p>åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½æƒ³åœ¨å‡½æ•°å†…å°†æŸä¸ªå¯¹è±¡ä¸æ­¢ä¸€æ¬¡åœ°ç»‘å®šåˆ°å³å€¼å¼•ç”¨æˆ–ä¸‡èƒ½å¼•ç”¨ï¼Œå¹¶ä¸”æƒ³ä¿è¯åœ¨å®Œæˆå¯¹è¯¥å¯¹è±¡åœ°å…¶å®ƒæ‰€æœ‰æ“ä½œä¹‹å‰ï¼Œå…¶å€¼ä¸ä¼šå‘ç”Ÿç§»åŠ¨ï¼Œé‚£ä¹ˆå°±å¾—ä»…åœ¨æœ€åä¸€æ¬¡ä½¿ç”¨è¯¥å¼•ç”¨æ—¶ï¼Œå¯¹å…¶å®æ–½<code>std::move</code>æˆ–<code>std::forward</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setSignText</span><span class="params">(T&amp;&amp; text)</span> </span>&#123;</span><br><span class="line">    sign.<span class="built_in">setText</span>(text);                         <span class="comment">// ä½¿ç”¨ textï¼Œä½†ä¸ä¿®æ”¹å…¶å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    signHistory.<span class="built_in">add</span>(now, std::forward&lt;T&gt;(now)); <span class="comment">// æœ‰æ¡ä»¶åœ°å°† text å¼ºåˆ¶è½¬æ¢ä¸ºå³å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æå°‘æ•°çš„æƒ…å†µä¸‹ï¼Œä½ éœ€è¦ç”¨<code>std::move_if_noexcept</code>æ¥ä»£æ›¿<code>std::move</code>ã€‚</p><blockquote><p><code>std::move_if_noexcept</code>æ˜¯<code>std::move</code>çš„ä¸€ä¸ªå˜ä½“ï¼Œå®ƒæ˜¯å¦ä¼šå°†å¯¹è±¡å¼ºåˆ¶è½¬æ¢ä¸ºå³å€¼ï¼Œå–å†³äºå…¶ç±»å‹çš„ç§»åŠ¨æ„é€ å‡½æ•°æ˜¯å¦å¸¦æœ‰ noexcept å£°æ˜ã€‚</p></blockquote><p>åœ¨æŒ‰å€¼è¿”å›çš„å‡½æ•°ä¸­ï¼Œå¦‚æœè¿”å›çš„æ˜¯ç»‘å®šåˆ°å³å€¼å¼•ç”¨æˆ–ä¸‡èƒ½å¼•ç”¨çš„å¯¹è±¡ï¼Œåˆ™å½“ä½ è¿”å›è¯¥å¼•ç”¨æ—¶ï¼Œåº”å½“å¯¹å…¶å®æ–½<code>std::move</code>æˆ–<code>std::forward</code>ï¼Œè¿™æ ·å¯ä»¥é¿å…ç¼–è¯‘å™¨å°†å…¶è§†ä½œå·¦å€¼ï¼Œä»è€Œæ¶ˆé™¤æ‹·è´å·¦å€¼è¿›å…¥è¿”å›å€¼å­˜å‚¨ä½ç½®çš„é¢å¤–å¼€é”€ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‰å€¼è¿”å›å³å€¼å¼•ç”¨å½¢å‚</span></span><br><span class="line">Matrix <span class="keyword">operator</span>+(Matrix&amp;&amp; lhs, <span class="type">const</span> Matrix&amp; rhs) &#123;</span><br><span class="line">    lhs += rhs;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">move</span>(lhs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‰å€¼è¿”å›ä¸‡èƒ½å¼•ç”¨å½¢å‚</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">Fraction <span class="title">reduceAndCopy</span><span class="params">(T&amp;&amp; frac)</span> </span>&#123;</span><br><span class="line">    frac.<span class="built_in">reduce</span>();</span><br><span class="line">    <span class="keyword">return</span> std::forward&lt;T&gt;(frac);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è‹¥å±€éƒ¨å¯¹è±¡å¯èƒ½é€‚ç”¨äº<strong>è¿”å›å€¼ä¼˜åŒ–ï¼ˆreturn value optimizationï¼ŒRVOï¼‰</strong>ï¼Œåˆ™è¯·å‹¿å¯¹å…¶å®æ–½<code>std::move</code>æˆ–<code>std::forward</code>ã€‚è¿™æ˜¯å› ä¸ºå½“ RVO çš„å‰ææ¡ä»¶å¾—åˆ°æ»¡è¶³æ—¶ï¼Œè¦ä¹ˆå‘ç”Ÿ<strong>æ‹·è´çœç•¥ï¼ˆcopy elisionï¼‰</strong>ï¼Œè¦ä¹ˆ<code>std::move</code>ä¼šéšå¼åœ°è¢«å®æ–½äºè¿”å›çš„å±€éƒ¨å¯¹è±¡ä¸Šï¼›è€Œäººä¸ºåœ°æ·»åŠ <code>std::move</code>æˆ–<code>std::forward</code>ï¼Œä¼šå¯¼è‡´ç¼–è¯‘å™¨å¤±å»æ‰§è¡Œ RVO çš„èƒ½åŠ›ã€‚</p><p>ä¸‹é¢çš„<code>makeWidget</code>å‡½æ•°æ»¡è¶³ RVO çš„ä¸¤ä¸ªå‰ææ¡ä»¶ï¼šå±€éƒ¨å¯¹è±¡ç±»å‹å’Œå‡½æ•°è¿”å›å€¼ç±»å‹ç›¸åŒï¼Œä¸”è¿”å›çš„å°±æ˜¯å±€éƒ¨å¯¹è±¡æœ¬èº«ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Widget <span class="title">makeWidget</span><span class="params">(Widget w)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> w;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†ç”±äºå‡½æ•°å½¢å‚ä¸é€‚åˆå®æ–½æ‹·è´çœç•¥ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å¿…é¡»å¤„ç†ä»¥ä¸Šä»£ç ï¼Œä½¿å…¶ä¸ä»¥ä¸‹ä»£ç ç­‰ä»·ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Widget <span class="title">makeWidget</span><span class="params">(Widget w)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">move</span>(w);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-26ï¼šé¿å…å¯¹ä¸‡èƒ½å¼•ç”¨ç±»å‹è¿›è¡Œé‡è½½">æ¡æ¬¾ 26ï¼šé¿å…å¯¹ä¸‡èƒ½å¼•ç”¨ç±»å‹è¿›è¡Œé‡è½½</h3><hr><p>é‡ç‚¹ï¼š</p><p>**æ¥å—é€šç”¨å¼•ç”¨çš„å‡½æ•°æ˜¯ C++ ä¸­æœ€è´ªå©ªçš„å‡½æ•°ã€‚**å®ƒä»¬å®ä¾‹åŒ–ä»¥åˆ›å»ºå‡ ä¹ä»»ä½•ç±»å‹çš„å‚æ•°çš„ç²¾ç¡®åŒ¹é…ï¼Œç»“åˆé‡è½½å’Œé€šç”¨å¼•ç”¨å‡ ä¹æ€»æ˜¯ä¸€ä¸ªåä¸»æ„ã€‚</p><p><strong>è¦ç‚¹</strong></p><ul><li>å¯¹é€šç”¨å¼•ç”¨è¿›è¡Œé‡è½½ï¼Œå‡ ä¹æ€»æ˜¯å¯¼è‡´å®ƒçš„è¿‡åº¦ä½¿ç”¨</li><li>å®Œç¾è½¬å‘æ„é€ å‡½æ•°å°¤å…¶æˆé—®é¢˜ï¼Œå› ä¸ºå¯¹äºéconst å·¦å€¼ï¼Œå®ƒä»¬é€šå¸¸æ¯”æ‹·è´æ„é€ å‡½æ•°æ›´åŒ¹é…ï¼Œå¹¶ä¸”å®ƒä»¬å¯ä»¥åŠ«æŒ</li><li>æ´¾ç”Ÿç±»å¯¹åŸºç±»æ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°çš„è°ƒç”¨</li></ul><hr><p>å½¢å‚ä¸ºä¸‡èƒ½å¼•ç”¨çš„å‡½æ•°æ˜¯ C++ ä¸­æœ€è´ªå©ªçš„ï¼Œå®ƒä»¬ä¼šåœ¨å…·ç°è¿‡ç¨‹ä¸­å’Œå‡ ä¹æ‰€æœ‰å®å‚ç±»å‹äº§ç”Ÿç²¾ç¡®åŒ¹é…ï¼ˆæå°‘çš„ä¸é€‚ç”¨å®å‚å°†åœ¨<strong>æ¡æ¬¾ 30</strong> ä¸­ä»‹ç»ï¼‰ï¼Œè¿™å°±æ˜¯ä¸ºä½•æŠŠé‡è½½å’Œä¸‡èƒ½å¼•ç”¨ä¸¤è€…ç»“åˆé€šå¸¸ä¸ä¼šè¾¾åˆ°é¢„æœŸæ•ˆæœã€‚è€ƒè™‘å¦‚ä¸‹æƒ…å½¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">logAndAdd</span><span class="params">(T&amp;&amp; name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">log</span>(now, <span class="string">&quot;logAndAdd&quot;</span>);</span><br><span class="line">    names.<span class="built_in">emplace</span>(std::forward&lt;T&gt;(name));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">nameFromIdx</span><span class="params">(<span class="type">int</span> idx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">logAndAdd</span><span class="params">(<span class="type">int</span> idx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">log</span>(now, <span class="string">&quot;logAndAdd&quot;</span>);</span><br><span class="line">    names.<span class="built_in">emplace</span>(<span class="built_in">nameFromIdx</span>(idx));</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">short</span> nameIdx;      <span class="comment">// ç”¨ short ç±»å‹æŒæœ‰ç´¢å¼•å€¼</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">logAndAdd</span>(nameIdx); <span class="comment">// è°ƒç”¨çš„å´æ˜¯ä¸‡èƒ½å¼•ç”¨ç‰ˆæœ¬</span></span><br></pre></td></tr></table></figure><p><code>logAndAdd</code>æœ‰ä¸¤ä¸ªé‡è½½ç‰ˆæœ¬ï¼Œå½¢å‚ç±»å‹ä¸ºä¸‡èƒ½å¼•ç”¨çš„ç‰ˆæœ¬å¯ä»¥å°†<code>T</code>æ¨å¯¼ä¸º<code>short</code>ï¼Œä»è€Œäº§ç”Ÿç²¾ç¡®åŒ¹é…ï¼›è€Œå½¢å‚ç±»å‹ä¸º<code>int</code>çš„ç‰ˆæœ¬å´åªèƒ½åœ¨ç±»å‹æå‡åæ‰å¯ä»¥åŒ¹é…åˆ°<code>short</code>ç±»å‹çš„å®å‚ã€‚å› æ­¤ï¼Œå½¢å‚ç±»å‹ä¸ºä¸‡èƒ½å¼•ç”¨çš„ç‰ˆæœ¬æ‰æ˜¯è¢«ä¼˜å…ˆè°ƒç”¨çš„ç‰ˆæœ¬ã€‚</p><p>å½“å®Œç¾è½¬å‘å‡ºç°åœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­æ—¶ï¼Œæƒ…å†µä¼šå˜å¾—æ›´åŠ å¤æ‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;        <span class="comment">// å®Œç¾è½¬å‘æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Person</span><span class="params">(T&amp;&amp; n)</span></span></span><br><span class="line"><span class="function">        : name(std::forward&lt;T&gt;(n)) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Person</span><span class="params">(<span class="type">int</span> idx)</span></span>;   <span class="comment">// å½¢å‚ä¸º int çš„æ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">Person</span>(<span class="type">const</span> Person&amp; rhs);  <span class="comment">// æ‹·è´æ„é€ å‡½æ•°ï¼ˆç”±ç¼–è¯‘å™¨ç”Ÿæˆï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">Person</span>(Person&amp;&amp; rhs);       <span class="comment">// ç§»åŠ¨æ„é€ å‡½æ•°ï¼ˆç”±ç¼–è¯‘å™¨ç”Ÿæˆï¼‰</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string name;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äºéå¸¸é‡çš„å·¦å€¼ç±»å‹ï¼Œå®Œç¾è½¬å‘æ„é€ å‡½æ•°ä¸€èˆ¬éƒ½ä¼šä¼˜å…ˆäºæ‹·è´æ„é€ å‡½æ•°å½¢æˆåŒ¹é…ï¼›è€Œå¯¹äºå¸¸é‡å·¦å€¼ç±»å‹ï¼Œå®Œç¾è½¬å‘æ„é€ å‡½æ•°å’Œæ‹·è´æ„é€ å‡½æ•°å…·æœ‰ç›¸ç­‰çš„åŒ¹é…ç¨‹åº¦ï¼Œæ­¤æ—¶ç”±äºéå‡½æ•°æ¨¡æ¿ä¼šä¼˜å…ˆäºå‡½æ•°æ¨¡æ¿è¢«åŒ¹é…ï¼Œç¼–è¯‘å™¨æ‰ä¼šè½¬å‘è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Person <span class="title">p</span><span class="params">(<span class="string">&quot;Nancy&quot;</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">cloneOfP</span><span class="params">(p)</span></span>;           <span class="comment">// è°ƒç”¨å®Œç¾è½¬å‘æ„é€ å‡½æ•°ï¼Œæ— æ³•é€šè¿‡ç¼–è¯‘</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> Person <span class="title">cp</span><span class="params">(<span class="string">&quot;Nancy&quot;</span>)</span></span>;   <span class="comment">// å¯¹è±¡æˆä¸ºäº†å¸¸é‡</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">cloneOfCp</span><span class="params">(cp)</span></span>;         <span class="comment">// ä¼šæ­£ç¡®è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>å®Œç¾è½¬å‘æ„é€ å‡½æ•°è¿˜ä¼šåŠ«æŒæ´¾ç”Ÿç±»ä¸­å¯¹åŸºç±»çš„æ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°çš„è°ƒç”¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SpecialPerson</span> : <span class="keyword">public</span> Person &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SpecialPerson</span>(<span class="type">const</span> SpecialPerson&amp; rhs) <span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">        : <span class="built_in">Person</span>(rhs) &#123;&#125;                    <span class="comment">// è°ƒç”¨çš„æ˜¯åŸºç±»çš„å®Œç¾è½¬å‘æ„é€ å‡½æ•°ï¼</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">SpecialPerson</span>(SpecialPerson&amp;&amp; rhs)      <span class="comment">// ç§»åŠ¨æ„é€ å‡½æ•°</span></span><br><span class="line">        : <span class="built_in">Person</span>(std::<span class="built_in">move</span>(rhs)) &#123;&#125;         <span class="comment">// è°ƒç”¨çš„æ˜¯åŸºç±»çš„å®Œç¾è½¬å‘æ„é€ å‡½æ•°ï¼</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-27ï¼šç†Ÿæ‚‰å¯¹ä¸‡èƒ½å¼•ç”¨ç±»å‹è¿›è¡Œé‡è½½çš„æ›¿ä»£æ–¹æ¡ˆ">æ¡æ¬¾ 27ï¼šç†Ÿæ‚‰å¯¹ä¸‡èƒ½å¼•ç”¨ç±»å‹è¿›è¡Œé‡è½½çš„æ›¿ä»£æ–¹æ¡ˆ</h3><p><strong>1. æ”¾å¼ƒé‡è½½</strong></p><p><strong>2. ä¼ é€’<code>const T&amp;</code>ç±»å‹çš„å½¢å‚</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">logAndAdd</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">log</span>(now, <span class="string">&quot;logAndAdd&quot;</span>);</span><br><span class="line">    names.<span class="built_in">emplace</span>(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§åšæ³•å¯ä»¥é¿å…é‡è½½ä¸‡èƒ½å¼•ç”¨å¸¦æ¥çš„ä¸è‰¯å½±å“ï¼Œä½†ä¼šèˆå¼ƒä¸€äº›æ€§èƒ½ã€‚</p><p><strong>3. ä¼ å€¼</strong></p><p>æŠŠä¼ é€’çš„å½¢å‚ä»å¼•ç”¨ç±»å‹æ¢æˆå€¼ç±»å‹ï¼Œæ˜¯ä¸€ç§ç»å¸¸èƒ½å¤Ÿæå‡æ€§èƒ½ï¼Œå´ä¸ä¼šå¢åŠ ä»»ä½•å¤æ‚æ€§çš„æ–¹æ³•ï¼Œå°½ç®¡è¿™æœ‰äº›åç›´è§‰ã€‚è¿™ç§è®¾è®¡éµå¾ªäº†<strong>æ¡æ¬¾ 41</strong> çš„å»ºè®®â€”â€”å½“ä½ çŸ¥é“è‚¯å®šéœ€è¦å¤åˆ¶å½¢å‚æ—¶ï¼Œè€ƒè™‘æŒ‰å€¼ä¼ é€’å¯¹è±¡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Person</span><span class="params">(std::string n)</span>  <span class="comment">// æ›¿æ¢æ‰ T&amp;&amp; ç±»å‹çš„æ„é€ å‡½æ•°</span></span></span><br><span class="line"><span class="function">        : name(std::move(n)) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Person</span><span class="params">(<span class="type">int</span> idx)</span>        <span class="comment">// åŒå‰</span></span></span><br><span class="line"><span class="function">        : name(nameFromIdx(idx)) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string name;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>4. ä½¿ç”¨æ ‡ç­¾åˆ†æ´¾ï¼ˆtag dispatchï¼‰</strong></p><p>åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬å°†å®é™…é‡è½½å’Œå®ç°åŠŸèƒ½çš„å‡½æ•°æ”¹ä¸º<code>logAndAddImpl</code>ï¼Œè€Œ<code>logAndAdd</code>ä»…ä»…ç”¨äºæ‰§è¡Œå®Œç¾è½¬å‘å’Œæ ‡ç­¾åˆ†æ´¾ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">logAndAdd</span><span class="params">(T&amp;&amp; name)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">logAndAddImpl</span>(std::forward&lt;T&gt;(name),</span><br><span class="line">        std::is_integral&lt;<span class="keyword">typename</span> std::remove_reference&lt;T&gt;::type&gt;());    <span class="comment">// C++14 å¯ä»¥ä½¿ç”¨ std::remove_reference_t</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹<code>std::is_integral</code>äº§ç”Ÿçš„å¸ƒå°”å€¼ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºä¸¤ä¸ª<code>logAndAddImpl</code>é‡è½½ç‰ˆæœ¬ï¼Œç”¨äºåŒºåˆ†å®ƒä»¬çš„ç±»å‹<code>std::false_type</code>å’Œ<code>std::true_type</code>å°±æ˜¯æ‰€è°“ â€œæ ‡ç­¾â€ã€‚å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">logAndAddImpl</span><span class="params">(T&amp;&amp; name, std::false_type)</span> </span>&#123; <span class="comment">// éæ•´å‹å®å‚</span></span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">log</span>(now, <span class="string">&quot;logAndAdd&quot;</span>);</span><br><span class="line">    names.<span class="built_in">emplace</span>(std::forward&lt;T&gt;(name));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">nameFromIdx</span><span class="params">(<span class="type">int</span> idx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">logAndAddImpl</span><span class="params">(<span class="type">int</span> idx, std::true_type)</span> </span>&#123;   <span class="comment">// æ•´å‹å®å‚</span></span><br><span class="line">    <span class="built_in">logAndAdd</span>(<span class="built_in">nameFromIdx</span>(idx));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>5. å¯¹æ¥å—ä¸‡èƒ½å¼•ç”¨çš„æ¨¡æ¿æ–½åŠ é™åˆ¶</strong></p><p>é€šè¿‡ SFINAE æŠ€æœ¯å’Œ<code>std::enable_if</code>ï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸€äº›æ¨¡æ¿åœ¨æ»¡è¶³äº†æŒ‡å®šæ¡ä»¶çš„æƒ…å†µä¸‹æ‰è¢«å¯ç”¨ï¼Œå®ƒçš„ä½¿ç”¨æ–¹å¼å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T,</span><br><span class="line">             <span class="keyword">typename</span> = <span class="keyword">typename</span> std::enable_if&lt;condition&gt;::type&gt;    <span class="comment">// C++14 å¯ä»¥ä½¿ç”¨ std::enable_if_t</span></span><br><span class="line">    <span class="keyword">explicit</span> <span class="built_in">Person</span>(T&amp;&amp; n);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„æˆ‘ä»¬æƒ³è¦<code>T</code>æ˜¯<code>Person</code>ä»¥å¤–çš„ç±»å‹æ—¶ï¼Œæ‰å¯ç”¨è¯¥æ¨¡æ¿æ„é€ å‡½æ•°ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥å†™ä¸‹é¢è¿™æ ·çš„æ¡ä»¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!std::is_same&lt;Person, <span class="keyword">typename</span> std::decay&lt;T&gt;::type&gt;::value  <span class="comment">// C++17 å¯ä»¥ä½¿ç”¨ std::is_same_v</span></span><br></pre></td></tr></table></figure><p><code>std::decay</code>ç”¨äºä½¿ç±»å‹å®Œå…¨é€€åŒ–ï¼Œåœ¨æ­¤å¤„ç”¨æ¥ç§»é™¤<code>T</code>çš„å¼•ç”¨å’Œ cv é™å®šç¬¦ï¼ˆå³<code>const</code>æˆ–<code>volatile</code>é™å®šç¬¦ï¼‰ï¼Œä½¿æˆ‘ä»¬å¯ä»¥æ›´åŠ çº¯ç²¹åœ°å…³æ³¨ç±»å‹æœ¬èº«ã€‚<code>std::decay</code>è¿˜å¯ä»¥ç”¨äºæŠŠæ•°ç»„å’Œå‡½æ•°ç±»å‹å¼ºåˆ¶è½¬æ¢ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 1</strong>ï¼‰ï¼Œå®ƒå½“ç„¶ä¹Ÿæ‹¥æœ‰æ›´æ˜“ç”¨çš„ C++14 ç‰ˆæœ¬ï¼Œå³<code>std::decay_t</code>ã€‚</p><p>å†™å‡ºè¿™ä¸ªæ¡ä»¶å¹¶ä¸æ„å‘³ç€å®Œæˆï¼Œ<strong>æ¡æ¬¾ 26</strong> ä¸­è¿˜æåˆ°äº†åœ¨æ´¾ç”Ÿç±»ä¸­è°ƒç”¨åŸºç±»çš„æ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°æ—¶ï¼Œé”™è¯¯è°ƒç”¨å®Œç¾è½¬å‘æ„é€ å‡½æ•°çš„é—®é¢˜ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æƒ³è¦çš„æ˜¯ä¸º<code>Person</code>å’Œç»§æ‰¿è‡ª<code>Person</code>çš„ç±»å‹éƒ½ä¸ä¸€æ ·çš„å®å‚ç±»å‹å¯ç”¨æ¨¡æ¿æ„é€ å‡½æ•°ã€‚æ ‡å‡†åº“ä¸­çš„<code>std::is_base_of</code>ç”¨äºåˆ¤æ–­ä¸€ä¸ªç±»å‹æ˜¯å¦ç”±å¦ä¸€ä¸ªç±»å‹æ´¾ç”Ÿè€Œæ¥ï¼Œç”¨å®ƒä»£æ›¿<code>std::is_same</code>å°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿ï¼ˆC++17 å¯ä»¥ä½¿ç”¨<code>std::is_base_of_v</code>ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span>&lt;</span><br><span class="line">        <span class="keyword">typename</span> T,</span><br><span class="line">        <span class="keyword">typename</span> = <span class="keyword">typename</span> std::enable_if&lt;</span><br><span class="line">                       !std::is_base_of&lt;Person, </span><br><span class="line">                                        <span class="keyword">typename</span> std::decay&lt;T&gt;::type</span><br><span class="line">                                       &gt;::value</span><br><span class="line">                   &gt;::type</span><br><span class="line">    &gt;</span><br><span class="line">    <span class="keyword">explicit</span> <span class="built_in">Person</span>(T&amp;&amp; n);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å†åŠ ä¸Šå¤„ç†æ•´å‹å®å‚çš„æ„é€ å‡½æ•°é‡è½½ç‰ˆæœ¬ï¼Œå¹¶è¿›ä¸€æ­¥é™åˆ¶æ¨¡æ¿æ„é€ å‡½æ•°ï¼Œç¦æ­¢å…¶æ¥å—æ•´å‹å®å‚ï¼Œæˆ‘ä»¬å¾—åˆ°çš„å®Œç¾çš„<code>Person</code>ç±»ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span>&lt;</span><br><span class="line">        <span class="keyword">typename</span> T,</span><br><span class="line">        <span class="keyword">typename</span> = std::<span class="type">enable_if_t</span>&lt;</span><br><span class="line">            !std::is_base_of&lt;Person, std::<span class="type">decay_t</span>&lt;T&gt;&gt;::value</span><br><span class="line">            &amp;&amp;</span><br><span class="line">            !std::is_integral&lt;std::<span class="type">remove_reference_t</span>&lt;T&gt;&gt;::value</span><br><span class="line">        &gt;</span><br><span class="line">    &gt;</span><br><span class="line">    <span class="keyword">explicit</span> <span class="built_in">Person</span>(T&amp;&amp; n)              <span class="comment">// æ¥å— std::string ç±»å‹ä»¥åŠå¯ä»¥å¼ºåˆ¶è½¬æ¢ä¸º </span></span><br><span class="line">    : <span class="built_in">name</span>(std::forward&lt;T&gt;(n)) &#123; ... &#125;  <span class="comment">// std::string ç±»å‹çš„å®å‚çš„æ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">explicit</span> <span class="built_in">Person</span>(<span class="type">int</span> idx)            <span class="comment">// æ¥å—æ•´å‹å®å‚çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    : <span class="built_in">name</span>(<span class="built_in">nameFromIdx</span>(idx)) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    ...                                 <span class="comment">// æ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°ç­‰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string name;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>æƒè¡¡</strong></p><p>æœ¬æ¡æ¬¾è®¨è®ºçš„å‰ä¸‰ç§æ–¹æ¡ˆï¼ˆèˆå¼ƒé‡è½½ï¼Œä¼ é€’<code>const T&amp;</code>ç±»å‹çš„å½¢å‚å’Œä¼ å€¼ï¼‰éƒ½éœ€è¦å¯¹å¾…è°ƒç”¨çš„å‡½æ•°å½¢å‚é€ä¸€æŒ‡å®šç±»å‹ï¼Œè€Œåä¸¤ç§æ–¹æ¡ˆï¼ˆä½¿ç”¨æ ‡ç­¾åˆ†æ´¾å’Œå¯¹æ¥å—ä¸‡èƒ½å¼•ç”¨çš„æ¨¡æ¿æ–½åŠ é™åˆ¶ï¼‰åˆ™ä½¿ç”¨äº†å®Œç¾è½¬å‘ï¼Œå› æ­¤æ— éœ€æŒ‡å®šå½¢å‚ç±»å‹ã€‚</p><p>æŒ‰ç…§å¸¸ç†ï¼Œå®Œç¾è½¬å‘çš„æ•ˆç‡æ›´é«˜ï¼Œå› ä¸ºå®ƒå°†ç±»å‹ä¿æŒå’Œå½¢å‚å£°æ˜æ—¶å®Œå…¨ä¸€è‡´ï¼Œæ‰€ä»¥ä¼šé¿å…åˆ›å»ºä¸´æ—¶å¯¹è±¡ã€‚ä½†å®Œç¾è½¬å‘ä¹Ÿæœ‰ä¸€äº›ä¸è¶³ï¼šé¦–å…ˆæ˜¯é’ˆå¯¹æŸäº›ç±»å‹æ— æ³•å®ç°å®Œç¾è½¬å‘ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 30</strong>ï¼‰ï¼Œå…¶æ¬¡æ˜¯å®Œç¾è½¬å‘ä¼šä½¿å¾—åœ¨ä¼ é€’éæ³•å½¢å‚æ—¶ï¼Œå‡ºç°æ›´éš¾ç†è§£çš„é”™è¯¯ä¿¡æ¯ã€‚</p><p><code>std::is_constructible</code>è¿™ä¸ªç±»å‹ç‰¹å¾ï¼ˆtype traitï¼‰å¯ä»¥åœ¨ç¼–è¯‘æœŸåˆ¤æ–­æŸä¸ªç±»å‹çš„å¯¹è±¡æ˜¯å¦å¯ä»¥ç”¨å¦ä¸€ç±»å‹çš„å¯¹è±¡ï¼ˆæˆ–ä¸åŒç±»å‹çš„å¤šä¸ªå¯¹è±¡ï¼‰æ¥æ„é€ ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥éªŒè¯è½¬å‘å‡½æ•°çš„ä¸‡èƒ½å¼•ç”¨å½¢å‚æ˜¯å¦åˆæ³•ã€‚ä¸‹é¢æ˜¯å¢åŠ äº†<code>static_assert</code>åçš„<code>Person</code>ç±»ï¼Œå®ƒå¯ä»¥äº§ç”Ÿæ›´æ˜ç¡®çš„æŠ¥é”™ä¿¡æ¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> = std::<span class="type">enable_if_t</span>&lt;...&gt;&gt;  <span class="comment">// åŒå‰</span></span><br><span class="line">    <span class="keyword">explicit</span> <span class="built_in">Person</span>(T&amp;&amp; n)</span><br><span class="line">        : <span class="built_in">name</span>(std::forward&lt;T&gt;(n)) &#123;</span><br><span class="line">        <span class="comment">// æ–­è¨€å¯ä»¥ç”¨ T ç±»å‹çš„å¯¹è±¡æ„é€  std::string</span></span><br><span class="line">        <span class="built_in">static_assert</span>(</span><br><span class="line">            std::is_constructible&lt;std::string, T&gt;::value,   <span class="comment">// C++17 å¯ä»¥ä½¿ç”¨ std::is_constructible_v</span></span><br><span class="line">            <span class="string">&quot;Parameter n can&#x27;t be used to construct a std::string&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        ... <span class="comment">// æ„é€ å‡½æ•°é€šå¸¸è¦å®Œæˆçš„å·¥ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-28ï¼šç†è§£å¼•ç”¨æŠ˜å ">æ¡æ¬¾ 28ï¼šç†è§£å¼•ç”¨æŠ˜å </h3><hr><p>æ ¹æ®ä»¥ä¸‹è§„åˆ™å°†å¼•ç”¨æŠ˜å ä¸ºå•ä¸ªå¼•ç”¨ï¼š</p><ul><li>å¦‚æœä¸¤ä¸ªéƒ½æ˜¯å³å€¼å¼•ç”¨ï¼Œç»“æœæ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ï¼ˆå³å€¼-å³å€¼ï¼‰</li><li>å¦åˆ™ç»“æœä¸ºå·¦å€¼å¼•ç”¨ï¼ˆå·¦å€¼-å·¦å€¼ã€å·¦å€¼-å³å€¼ã€å³å€¼-å·¦å€¼ï¼‰</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Widget <span class="title function_">widgetFactory</span><span class="params">()</span>; <span class="comment">// è¿”å›å³å€¼çš„å‡½æ•°</span></span><br><span class="line">Widget w; <span class="comment">// å˜é‡ï¼ˆå·¦å€¼ï¼‰</span></span><br><span class="line">func(w); <span class="comment">// ç”¨å·¦å€¼è°ƒç”¨ func; T æ¨å¯¼ä¸º Widget&amp;</span></span><br><span class="line">func(widgetFactory()); <span class="comment">// ç”¨å³å€¼è°ƒç”¨ func; T æ¨å¯¼ä¸º Widget</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¼•ç”¨æŠ˜å æ˜¯ std::forward å·¥ä½œçš„å…³é”®</p><p><strong>std::forwardåŸç†</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="comment">// åœ¨å‘½åç©ºé—´std</span></span><br><span class="line"><span class="function">T&amp;&amp; <span class="title">forward</span><span class="params">(<span class="keyword">typename</span> remove_reference&lt;T&gt;::type&amp; param)</span> </span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;T&amp;&amp;&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¦ç‚¹</strong></p><ul><li>å¼•ç”¨æŠ˜å å‘ç”Ÿåœ¨å››ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼šæ¨¡æ¿å®ä¾‹åŒ–ã€autoç±»å‹ç”Ÿæˆã€typedefåˆ«åå£°æ˜çš„åˆ›å»ºå’Œä½¿ç”¨ä»¥åŠdecltype</li><li>å½“ç¼–è¯‘å™¨åœ¨å¼•ç”¨æŠ˜å ä¸Šä¸‹æ–‡ä¸­ç”Ÿæˆå¯¹å¼•ç”¨çš„å¼•ç”¨æ—¶ï¼Œç»“æœå˜æˆå•ä¸ªå¼•ç”¨ã€‚å¦‚æœåŸå§‹å¼•ç”¨ä¸­çš„ä»»ä½•ä¸€ä¸ªæ˜¯å·¦å€¼å¼•ç”¨ï¼Œåˆ™ç»“æœæ˜¯å·¦å€¼å¼•ç”¨ã€‚å¦åˆ™ï¼Œå®ƒæ˜¯å³å€¼å¼•ç”¨</li><li>é€šç”¨å¼•ç”¨æ˜¯åœ¨ç±»å‹æ¨å¯¼åŒºåˆ†å·¦å€¼å’Œå³å€¼ä»¥åŠå‘ç”Ÿå¼•ç”¨æŠ˜å çš„ä¸Šä¸‹æ–‡ä¸­çš„å³å€¼å¼•ç”¨</li></ul><hr><p>åœ¨<strong>æ¡æ¬¾ 24</strong> ä¸­æˆ‘ä»¬äº†è§£äº†ä¸‡èƒ½å¼•ç”¨å’Œå³å€¼å¼•ç”¨çš„åŒºåˆ«ï¼Œä½†å®é™…ä¸Šä¸‡èƒ½å¼•ç”¨å¹¶éä¸€ç§æ–°çš„å¼•ç”¨ç±»å‹ï¼Œå…¶å®å®ƒå°±æ˜¯åœ¨æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶çš„è¯­å¢ƒä¸­çš„å³å€¼å¼•ç”¨ï¼š</p><ol><li>ç±»å‹æ¨å¯¼çš„è¿‡ç¨‹ä¸­ä¼šåŒºåˆ†å·¦å€¼å’Œå³å€¼ï¼›</li><li>ä¼šå‘ç”Ÿ<strong>å¼•ç”¨æŠ˜å ï¼ˆreference collapsingï¼‰</strong>ã€‚</li></ol><p>C++ æ ‡å‡†ç¦æ­¢ç›´æ¥å£°æ˜ â€œå¼•ç”¨çš„å¼•ç”¨â€ ï¼Œä½†å¼•ç”¨æŠ˜å ä¸å—æ­¤é™åˆ¶ã€‚å½“å·¦å€¼è¢«ä¼ é€’ç»™æ¥å—ä¸‡èƒ½å¼•ç”¨çš„å‡½æ•°æ¨¡æ¿æ—¶ï¼Œä¼šå‘ç”Ÿä¸‹é¢è¿™æ ·çš„çŠ¶å†µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(T&amp;&amp; param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">func</span>(w);    <span class="comment">// è°ƒç”¨ func å¹¶ä¼ å…¥å·¦å€¼ï¼ŒT æ¨å¯¼å‡ºçš„ç±»å‹ä¸º Widget&amp;</span></span><br></pre></td></tr></table></figure><p>ä»£å…¥<code>T</code>çš„æ¨å¯¼ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸‹é¢è¿™æ ·çš„å…·ç°åŒ–æ¨¡æ¿ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(Widget&amp; &amp;&amp; param)</span></span>;</span><br></pre></td></tr></table></figure><p>å‡ºç°äº†å¼•ç”¨çš„å¼•ç”¨ï¼ç„¶è€Œè¿™å¹¶ä¸è¿è§„ï¼Œå¼•ç”¨æŠ˜å çš„è§„åˆ™ä¼šæŠŠåŒé‡å¼•ç”¨æŠ˜å æˆå•ä¸ªå¼•ç”¨ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p><blockquote><p>å¦‚æœä»»ä¸€å¼•ç”¨ä¸ºå·¦å€¼å¼•ç”¨ï¼Œåˆ™ç»“æœä¸ºå·¦å€¼å¼•ç”¨ï¼Œå¦åˆ™ï¼ˆå³ä¸¤ä¸ªçš†ä¸ºå³å€¼å¼•ç”¨ï¼‰ï¼Œç»“æœä¸ºå³å€¼å¼•ç”¨ã€‚</p></blockquote><p>æ‰€ä»¥å®é™…ä¸Šçš„å‡½æ•°ç­¾åä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(Widget&amp; param)</span></span>;</span><br></pre></td></tr></table></figure><p>å¼•ç”¨æŠ˜å æ˜¯ä½¿<code>std::forward</code>å¾—ä»¥è¿ä½œçš„å…³é”®ï¼Œä¹Ÿæ˜¯å°†å·¦å€¼æˆ–å³å€¼ä¿¡æ¯ç¼–ç åˆ°ä¸‡èƒ½å¼•ç”¨å½¢å‚<code>T</code>ä¸­çš„å®ç°é€”å¾„ã€‚<code>std::forward</code>çš„ä»»åŠ¡æ˜¯ï¼Œå½“ä¸”ä»…å½“ç¼–ç åœ¨<code>T</code>ä¸­çš„ä¿¡æ¯è¡¨æ˜ä¼ é€’çš„å®å‚æ˜¯å³å€¼ï¼Œå³<code>T</code>æ¨å¯¼å‡ºçš„ç±»å‹æ˜¯ä¸ªéå¼•ç”¨ç±»å‹æ—¶ï¼Œå¯¹å·¦å€¼å½¢å‚å®æ–½åˆ°å³å€¼çš„å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚å®ƒçš„åŸºæœ¬å®ç°å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C++11 ç‰ˆæœ¬</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">T&amp;&amp; <span class="title">forward</span><span class="params">(<span class="keyword">typename</span> remove_reference&lt;T&gt;::type&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;T&amp;&amp;&gt;(param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C++14 ç‰ˆæœ¬</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">T&amp;&amp; <span class="title">forward</span><span class="params">(<span class="type">remove_reference_t</span>&lt;T&gt;&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;T&amp;&amp;&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ä¼ é€’ç»™å‡½æ•°<code>forward</code>çš„å®å‚ç±»å‹æ˜¯å·¦å€¼<code>Widget</code>ï¼Œåˆ™æ¨¡æ¿çš„å…·ç°åŒ–ç»“æœå¯ä»¥å†™æˆï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Widget&amp; &amp;&amp; <span class="title">forward</span><span class="params">(<span class="type">remove_reference_t</span>&lt;Widget&amp;&gt;&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Widget&amp; &amp;&amp;&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç”Ÿå¼•ç”¨æŠ˜å åï¼Œç”Ÿæˆçš„æœ€ç»ˆç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºå·¦å€¼ç±»å‹å¹¶ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Widget&amp; <span class="title">forward</span><span class="params">(Widget&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Widget&amp;&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ä¼ é€’ç»™å‡½æ•°<code>forward</code>çš„å®å‚ç±»å‹æ˜¯å³å€¼<code>Widget</code>ï¼Œåˆ™æ¨¡æ¿çš„å…·ç°åŒ–ç»“æœå¯ä»¥å†™æˆï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Widget&amp;&amp; <span class="title">forward</span><span class="params">(<span class="type">remove_reference_t</span>&lt;Widget&gt;&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Widget&amp;&amp;&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç”Ÿå¼•ç”¨æŠ˜å åï¼Œç”Ÿæˆçš„æœ€ç»ˆç»“æœå¦‚ä¸‹ï¼Œæ˜¾ç„¶å·¦å€¼ç±»å‹çš„å½¢å‚ä¼šè¢«å¼ºåˆ¶è½¬æ¢ä¸ºå³å€¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Widget&amp;&amp; <span class="title">forward</span><span class="params">(Widget&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Widget&amp;&amp;&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼•ç”¨æŠ˜å ä¼šåœ¨å››ç§è¯­å¢ƒä¸­å‡ºç°ï¼šæ¨¡æ¿å…·ç°åŒ–ï¼Œ<code>auto</code>ç±»å‹æ¨æ–­ï¼Œåˆ›å»ºå’Œä½¿ç”¨<code>typedef</code>å’Œåˆ«åå£°æ˜ï¼Œä»¥åŠ<code>decltype</code>ã€‚</p><p><code>auto</code>ç±»å‹æ¨æ–­ä¸­å‘ç”Ÿçš„å¼•ç”¨æŠ˜å ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Widget w;                       <span class="comment">// å˜é‡ï¼ˆå·¦å€¼ï¼‰</span></span><br><span class="line"><span class="function">Widget <span class="title">widgetFunction</span><span class="params">()</span></span>;        <span class="comment">// è¿”å›å³å€¼çš„å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span>&amp;&amp; w1 = w;                  <span class="comment">// æ¨å¯¼å‡º Widget&amp; &amp;&amp; w1ï¼Œå¼•ç”¨æŠ˜å åä¸º Widget&amp; w1</span></span><br><span class="line"><span class="keyword">auto</span>&amp;&amp; w2 = <span class="built_in">widgetFunction</span>();   <span class="comment">// æ¨å¯¼å‡º Widget&amp;&amp; w1ï¼Œä¸ä¼šå‘ç”Ÿå¼•ç”¨æŠ˜å </span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºå’Œä½¿ç”¨<code>typedef</code>ä¸­å‘ç”Ÿçš„å¼•ç”¨æŠ˜å ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> T&amp;&amp; RvalueRefToT;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Widget&lt;<span class="type">int</span>&amp;&gt; w; <span class="comment">// ç”¨å·¦å€¼å¼•ç”¨ç±»å‹æ¥å…·ç°åŒ– Widget æ¨¡æ¿</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…·ç°åŒ–åå¾—åˆ° typedef int&amp; &amp;&amp; RvalueRefToT</span></span><br><span class="line"><span class="comment">// å¼•ç”¨æŠ˜å åä¸º typedef int&amp; RvalueRefToT</span></span><br></pre></td></tr></table></figure><p>æœ€åä¸€ç§ä¼šå‘ç”Ÿå¼•ç”¨æŠ˜å çš„è¯­å¢ƒåœ¨<code>decltype</code>çš„è¿ç”¨ä¸­ï¼šå¦‚æœåœ¨åˆ†æä¸€ä¸ªæ¶‰åŠ<code>decltype</code>çš„ç±»å‹æ—¶å‡ºç°äº†å¼•ç”¨çš„å¼•ç”¨ï¼Œåˆ™å¼•ç”¨æŠ˜å ä¼šä»‹å…¥å¹¶å°†å…¶æ¶ˆç­ã€‚</p><h3 id="æ¡æ¬¾-29ï¼šå‡å®šç§»åŠ¨æ“ä½œä¸å­˜åœ¨ã€æˆæœ¬é«˜ã€æœªè¢«ä½¿ç”¨">æ¡æ¬¾ 29ï¼šå‡å®šç§»åŠ¨æ“ä½œä¸å­˜åœ¨ã€æˆæœ¬é«˜ã€æœªè¢«ä½¿ç”¨</h3><p>åœ¨ä¸‹é¢å‡ ä¸ªæƒ…å½¢ä¸‹ï¼ŒC++11 çš„ç§»åŠ¨è¯­ä¹‰ä¸ä¼šç»™ä½ å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼š</p><ul><li><strong>æ²¡æœ‰ç§»åŠ¨æ“ä½œï¼š</strong> å¾…ç§»åŠ¨çš„å¯¹è±¡æœªèƒ½æä¾›ç§»åŠ¨æ“ä½œã€‚å› æ­¤ï¼Œç§»åŠ¨è¯·æ±‚å°±å˜æˆäº†æ‹·è´è¯·æ±‚ã€‚</li><li><strong>ç§»åŠ¨æœªèƒ½æ›´å¿«ï¼š</strong> å¾…ç§»åŠ¨çš„å¯¹è±¡è™½ç„¶æœ‰ç§»åŠ¨æ“ä½œï¼Œä½†å¹¶ä¸æ¯”å…¶æ‹·è´æ“ä½œæ›´å¿«ã€‚</li></ul><blockquote><p>ç§»åŠ¨æ“ä½œä¸æ¯”æ‹·è´æ“ä½œæ›´å¿«çš„ä¾‹å­ï¼š<code>std::array</code>å°†æ•°æ®ç›´æ¥å­˜å‚¨åœ¨å¯¹è±¡å†…ï¼Œç§»åŠ¨<code>std::array</code>éœ€è¦é€ä¸ªç§»åŠ¨å®¹å™¨å†…çš„æ¯ä¸ªå…ƒç´ ï¼›å¼€å¯äº†<strong>çŸ­å­—ç¬¦ä¸²ä¼˜åŒ–ï¼ˆsmall string optimizationï¼ŒSSOï¼‰</strong> çš„<code>std::string</code>ï¼Œå®ƒä¼šå°†å­—ç¬¦ä¸²å­˜å‚¨åœ¨<code>std::string</code>å¯¹è±¡çš„æŸä¸ªç¼“å†²åŒºå†…ï¼Œè€Œéä½¿ç”¨å †ä¸Šçš„å†…å­˜ã€‚</p></blockquote><ul><li><strong>ç§»åŠ¨ä¸å¯ç”¨ï¼š</strong> ç§»åŠ¨æœ¬å¯ä»¥å‘ç”Ÿçš„æƒ…å†µä¸‹ï¼Œè¦æ±‚ç§»åŠ¨æ“ä½œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†è¯¥æ“ä½œæœªåŠ ä¸Š<code>noexcept</code>å£°æ˜ã€‚</li><li><strong>æºå¯¹è±¡æ˜¯å·¦å€¼ï¼š</strong> åªæœ‰å³å€¼å¯ä»¥ä½œä¸ºç§»åŠ¨æ“ä½œçš„æºã€‚</li></ul><p>å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥ä¸ºé€šç”¨çš„ä»£ç å‡å®šç§»åŠ¨æ“ä½œä¸å­˜åœ¨ã€æˆæœ¬é«˜ä¸”æœªè¢«ä½¿ç”¨ã€‚ç„¶è€Œï¼Œå¯¹äºå·²çŸ¥çš„ç±»å‹æˆ–æ”¯æŒç§»åŠ¨è¯­ä¹‰çš„ä»£ç ä¸­ï¼Œå°±ä¸éœ€è¦ä½œä¸Šè¿°å‡å®šï¼Œåœ¨ä½ çŸ¥é“ç§»åŠ¨æ“ä½œæˆæœ¬ä½å»‰çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ”¾å¿ƒå¤§èƒ†åœ°å°†æ‹·è´æ“ä½œæ›¿æ¢ä¸ºç›¸å¯¹ä¸é‚£ä¹ˆæ˜‚è´µçš„ç§»åŠ¨æ“ä½œã€‚</p><h3 id="æ¡æ¬¾-30ï¼šç†Ÿæ‚‰å®Œç¾è½¬å‘çš„å¤±è´¥æƒ…å½¢">æ¡æ¬¾ 30ï¼šç†Ÿæ‚‰å®Œç¾è½¬å‘çš„å¤±è´¥æƒ…å½¢</h3><p>å®Œç¾è½¬å‘çš„å«ä¹‰æ˜¯æˆ‘ä»¬ä¸ä»…è½¬å‘å¯¹è±¡ï¼Œè¿˜è½¬å‘å…¶ç‰¹å¾ï¼šç±»å‹ï¼Œæ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼ï¼Œä»¥åŠæ˜¯å¦å¸¦æœ‰<code>const</code>å’Œ<code>volatile</code>é™å®šç¬¦ã€‚å‡ºäºæ­¤ç›®çš„ï¼Œæˆ‘ä»¬ä¼šè¿ç”¨ä¸‡èƒ½å¼•ç”¨æ¥å°†å·¦ã€å³å€¼ä¿¡æ¯ç¼–ç åˆ°ç±»å‹ä¸­ï¼Œè€Œç”¨äºè½¬å‘çš„å‡½æ•°è‡ªç„¶ä¹Ÿè¯¥æ˜¯æ³›å‹çš„ï¼Œå®ƒçš„æ ‡å‡†å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fwd</span><span class="params">(T&amp;&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">f</span>(std::forward&lt;T&gt;(param));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ä½¿è½¬å‘å‡½æ•°èƒ½æ¥å—ä»»æ„æ•°é‡çš„å½¢å‚ï¼Œä½¿ç”¨å¯å˜å‚æ•°æ¨¡æ¿ä¹Ÿåœ¨æˆ‘ä»¬çš„è€ƒè™‘èŒƒå›´å†…ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fwd</span><span class="params">(Ts&amp;&amp;... param)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">f</span>(std::forward&lt;Ts&gt;(param)...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‹¥ç”¨ç›¸åŒå®å‚è°ƒç”¨<code>f</code>å’Œ<code>fwd</code>ä¼šæ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œåˆ™ç§°<code>fwd</code>å°†å®å‚å®Œç¾è½¬å‘åˆ°<code>f</code>å¤±è´¥ã€‚å®Œç¾è½¬å‘çš„å¤±è´¥æƒ…å½¢æºäºæ¨¡æ¿ç±»å‹æ¨å¯¼å¤±è´¥ï¼Œæˆ–æ¨å¯¼å‡ºé”™è¯¯çš„ç±»å‹ã€‚ä¸‹é¢æˆ‘ä»¬å°†äº†è§£ä¼šé€ æˆå®Œç¾è½¬å‘å¤±è´¥çš„å…¸å‹ä¾‹å­ã€‚</p><p><strong>å¤§æ‹¬å·åˆå§‹å€¼è®¾å®šé¡¹ï¼ˆBraced initializersï¼‰</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">const</span> std::vector&lt;<span class="type">int</span>&gt;&amp; v)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(&#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;);         <span class="comment">// â€œ&#123; 1, 2, 3 &#125;â€ ä¼šéšå¼è½¬æ¢ä¸º std::vector&lt;int&gt;</span></span><br><span class="line"><span class="built_in">fwd</span>(&#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;);       <span class="comment">// æ— æ³•é€šè¿‡ç¼–è¯‘ï¼</span></span><br></pre></td></tr></table></figure><p>ç”±äº<code>fwd</code>çš„å½¢å‚ä¸ºè¢«å£°æ˜ä¸º<code>std::initializer_list</code>ï¼Œç¼–è¯‘å™¨å°±ä¼šè¢«ç¦æ­¢åœ¨<code>fwd</code>çš„è°ƒç”¨è¿‡ç¨‹ä¸­ä»è¡¨è¾¾å¼<code>&#123; 1, 2, 3 &#125;</code>å‡ºå‘æ¥æ¨å¯¼ç±»å‹ã€‚æ—¢ç„¶æ— æ³•æ¨å¯¼å‡ºå½¢å‚çš„ç±»å‹ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¹Ÿåªèƒ½æ‹’ç»å¯¹<code>fwd</code>çš„è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å…ˆç”¨<code>auto</code>å£°æ˜ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå†ä¼ é€’ç»™<code>fwd</code>æ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> il = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;  <span class="comment">// il çš„ç±»å‹è¢«æ¨å¯¼ä¸º std::initializer_list&lt;int&gt;</span></span><br><span class="line"><span class="built_in">fwd</span>(il);                <span class="comment">// æ²¡é—®é¢˜ï¼Œå°† il å®Œç¾è½¬å‘ç»™ f</span></span><br></pre></td></tr></table></figure><p><strong>0 å’Œ NULL ä½œç©ºæŒ‡é’ˆ</strong></p><p><strong>æ¡æ¬¾ 8</strong> ä¸­æ›¾ç»è¯´æ˜è¿‡ï¼Œå½“ä½ è¯•å›¾å°†<code>0</code>æˆ–<code>NULL</code>ä½œä¸ºç©ºæŒ‡é’ˆä¼ é€’ç»™æ¨¡æ¿æ—¶ï¼Œç±»å‹æ¨å¯¼å°±ä¼šå‘ç”Ÿé”™è¯¯ï¼Œå°†å®å‚æ¨å¯¼ä¸ºä¸€ä¸ªæ•´å‹è€ŒéæŒ‡é’ˆç±»å‹ï¼Œç»“æœä¸ç®¡æ˜¯<code>0</code>è¿˜æ˜¯<code>NULL</code>éƒ½ä¸ä¼šä½œä¸ºç©ºæŒ‡é’ˆè¢«å®Œç¾è½¬å‘ã€‚è§£å†³æ–¹æ³•éå¸¸ç®€å•ï¼Œä¼ ä¸€ä¸ª<code>nullptr</code>è€Œä¸æ˜¯<code>0</code>æˆ–<code>NULL</code>ã€‚</p><p><strong>ä»…æœ‰å£°æ˜çš„æ•´å‹<code>static const</code>æˆå‘˜å˜é‡</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> std::<span class="type">size_t</span> MinVals = <span class="number">28</span>;  <span class="comment">// ä»…æä¾› MinVals çš„å£°æ˜</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;                                          <span class="comment">// æœªç»™å‡º MinVals çš„å®šä¹‰</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(std::<span class="type">size_t</span> v)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(Widget::MinVals);                         <span class="comment">// æ²¡é—®é¢˜ï¼Œå½“ä½œ â€œf(28)â€ å¤„ç†</span></span><br><span class="line"><span class="built_in">fwd</span>(Widget::MinVals);                       <span class="comment">// å¯èƒ½æ— æ³•é€šè¿‡é“¾æ¥</span></span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬è€Œè¨€ï¼Œç¼–è¯‘å™¨ä¼šç»•è¿‡<code>MinVals</code>ç¼ºå°‘å®šä¹‰çš„äº‹å®ï¼Œå¹¶ç”¨å…¶å€¼æ›¿æ¢æ‰€æœ‰æ¶‰åŠåˆ°<code>MinVals</code>çš„åœ°æ–¹ï¼Œä½†å¹¶ä¸ä¼šä¸ºå…¶å®é™…åˆ†é…å­˜å‚¨ç©ºé—´ã€‚è¿™å°±å¯¼è‡´å¦‚æœæˆ‘ä»¬å°è¯•å¯¹<code>MinVals</code>å®æ–½å–åœ°å€æˆ–å¯¹å®ƒè¿›è¡Œå¼•ç”¨ï¼Œå°±ä¼šå¯¼è‡´é“¾æ¥æ— æ³•é€šè¿‡ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä½•ä¸èƒ½å°†<code>Widget::MinVals</code>ä½œä¸ºå®å‚ä¼ é€’ç»™<code>fwd</code>ã€‚</p><p>æŒ‰ç…§æ ‡å‡†ï¼ŒæŒ‰å¼•ç”¨ä¼ é€’<code>MinVals</code>æ—¶è¦æ±‚<code>MinVals</code>æœ‰å®šä¹‰ã€‚ç„¶è€Œå¹¶ä¸æ˜¯æ‰€æœ‰å®ç°éƒ½éµå¾ªäº†è¿™ä¸ªè§„å®šï¼Œå¯¹äºä¸€äº›ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ï¼Œä½ ä¼šå‘ç°å°†<code>MinVals</code>ç”¨äºå®Œç¾è½¬å‘å¹¶ä¸ä¼šäº§ç”Ÿé”™è¯¯ï¼Œç”šè‡³å¯¹å®ƒå–åœ°å€ä¹Ÿä¸ä¼šã€‚ä½†ä¸ºäº†ä»£ç çš„å¯ç§»æ¤æ€§ï¼Œè¿˜æ˜¯åº”å½“é‡è§†æ­¤å¤„æ‰€è®²çš„è§„åˆ™ï¼Œä¸º<code>static const</code>æˆå‘˜å˜é‡æä¾›å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> std::<span class="type">size_t</span> Widget::MinVals;  <span class="comment">// åœ¨ Widget çš„ .cpp æ–‡ä»¶ä¸­</span></span><br></pre></td></tr></table></figure><p><strong>é‡è½½å‡½æ•°çš„åç§°å’Œæ¨¡æ¿åç§°</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">int</span> (*pf)(<span class="type">int</span>))</span></span>; <span class="comment">// æˆ–è€… void f(int pf(int))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">processVal</span><span class="params">(<span class="type">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">processVal</span><span class="params">(<span class="type">int</span> value, <span class="type">int</span> priority)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(processVal);          <span class="comment">// æ²¡é—®é¢˜</span></span><br><span class="line"><span class="built_in">fwd</span>(processVal);        <span class="comment">// é”™è¯¯ï¼æ— æ³•ç¡®å®šæ˜¯å“ªä¸ªé‡è½½ç‰ˆæœ¬</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">T <span class="title">workOnVal</span><span class="params">(T param)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">fwd</span>(workOnVal);         <span class="comment">// é”™è¯¯ï¼æ— æ³•ç¡®å®šæ˜¯ workOnVal çš„å“ªä¸ªå®ä¾‹</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å°†<code>processVal</code>ä¼ é€’ç»™<code>f</code>æ—¶ï¼Œç”±äº<code>f</code>çš„å½¢å‚ç±»å‹æ˜¯å·²çŸ¥çš„ï¼Œç¼–è¯‘å™¨è‡ªç„¶ä¹ŸçŸ¥é“å®ƒéœ€è¦çš„æ˜¯<code>processVal</code>çš„å“ªä¸ªé‡è½½ç‰ˆæœ¬ï¼›ä½†çº¯ç²¹çš„å‡½æ•°åç§°<code>processVal</code>å¹¶ä¸åŒ…å«ç±»å‹ä¿¡æ¯ï¼Œç±»å‹æ¨å¯¼æ›´æ˜¯æ— ä»è°ˆèµ·ï¼Œå°†å®ƒä¼ é€’ç»™<code>fwd</code>åªä¼šé€ æˆå®Œç¾è½¬å‘å¤±è´¥è€Œå·²ã€‚</p><p>è¦è®©<code>fwd</code>æ¥å—é‡è½½å‡½æ•°çš„åç§°æˆ–æ¨¡æ¿åç§°ï¼Œåªèƒ½æ‰‹åŠ¨æŒ‡å®šéœ€è¦è½¬å‘çš„å“ªä¸ªé‡è½½ç‰ˆæœ¬æˆ–æ¨¡æ¿å®ä¾‹ã€‚ä¾‹å¦‚ä¸‹é¢çš„åšæ³•å°±æ˜¯åˆç†çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProcessFuncType = <span class="built_in">int</span> (*)(<span class="type">int</span>);</span><br><span class="line">ProcessFuncType processValPtr = processVal;     <span class="comment">// æŒ‡å®šäº†éœ€è¦çš„ processVal ç­¾å</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">fwd</span>(processValPtr);                             <span class="comment">// æ²¡é—®é¢˜</span></span><br><span class="line"><span class="built_in">fwd</span>(<span class="built_in">static_cast</span>&lt;ProcessFuncType&gt;(workOnVal));   <span class="comment">// ä¹Ÿæ²¡é—®é¢˜</span></span><br></pre></td></tr></table></figure><p><strong>ä½åŸŸ</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">IPv4Header</span> &#123;                 <span class="comment">// ç”¨äºè¡¨ç¤º IPv4 å¤´éƒ¨çš„æ¨¡å‹</span></span><br><span class="line">    std::<span class="type">uint32_t</span> version:<span class="number">4</span>,</span><br><span class="line">                  IHL:<span class="number">4</span>,</span><br><span class="line">                  DSCP:<span class="number">6</span>,</span><br><span class="line">                  ECN:<span class="number">2</span>,</span><br><span class="line">                  totalLength:<span class="number">16</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(std::<span class="type">size_t</span> sz)</span></span>;</span><br><span class="line"></span><br><span class="line">IPv4Header h;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(h.totalLength);                   <span class="comment">// æ²¡é—®é¢˜</span></span><br><span class="line"><span class="built_in">fwd</span>(h.totalLength);                 <span class="comment">// é”™è¯¯ï¼</span></span><br></pre></td></tr></table></figure><p>C++ æ ‡å‡†è§„å®šï¼šéå¸¸å¼•ç”¨ä¸å¾—ç»‘å®šåˆ°ä½åŸŸã€‚ä½åŸŸæ˜¯ç”±æœºå™¨å­—çš„è‹¥å¹²ä»»æ„éƒ¨åˆ†ç»„æˆçš„ï¼Œä½†è¿™æ ·çš„å®ä½“æ˜¯æ— æ³•å¯¹å…¶ç›´æ¥å–åœ°å€çš„ï¼Œæ— æ³•å°†æŒ‡é’ˆæŒ‡å‘å®ƒï¼Œå› æ­¤ä¹Ÿæ— æ³•å¯¹å…¶è¿›è¡Œå¼•ç”¨ã€‚</p><blockquote><p>å®é™…ä¸Šå¸¸å¼•ç”¨ä¹Ÿä¸å¯èƒ½ç»‘å®šåˆ°ä½åŸŸï¼Œå®ƒä»¬ç»‘å®šåˆ°çš„æ˜¯ â€œå¸¸è§„â€ å¯¹è±¡ï¼ˆæŸç§æ ‡å‡†æ•´å‹ï¼Œä¾‹å¦‚<code>int</code>ï¼‰ï¼Œå…¶ä¸­æ‹·è´äº†ä½åŸŸçš„å€¼ã€‚</p></blockquote><p>å°†ä½åŸŸä¼ é€’ç»™è½¬å‘å‡½æ•°çš„å¯èƒ½é€”å¾„æ˜¯åˆ¶ä½œä¸€ä¸ªå‰¯æœ¬ï¼Œå¹¶ä»¥è¯¥å‰¯æœ¬è°ƒç”¨è½¬å‘å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‹·è´ä½åŸŸå€¼ï¼Œä½¿ç”¨çš„åˆå§‹åŒ–å½¢å¼å‚è€ƒæ¡æ¬¾ 6</span></span><br><span class="line"><span class="keyword">auto</span> length = <span class="built_in">static_cast</span>&lt;std::<span class="type">uint16_t</span>&gt;(h.totalLength);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fwd</span>(length);    <span class="comment">// è½¬å‘è¯¥å‰¯æœ¬</span></span><br></pre></td></tr></table></figure><h2 id="ç¬¬å…­ç« ï¼šlambda-è¡¨è¾¾å¼">ç¬¬å…­ç« ï¼šlambda è¡¨è¾¾å¼</h2><hr><p>é‡ç‚¹</p><p>**é—­åŒ…ï¼š**èƒ½å¤Ÿè®¿é—®å…¶ä»–Â·å‡½æ•°å†…éƒ¨å˜é‡çš„å‡½æ•°</p><p><strong>é—­åŒ…ç±»ï¼ˆclosure classï¼‰ï¼š</strong> å®ä¾‹åŒ–é—­åŒ…çš„ç±»ï¼Œæ¯ä¸ª lambda éƒ½ä¼šä½¿ç¼–è¯‘å™¨ç”Ÿæˆå”¯ä¸€çš„é—­åŒ…ç±»ã€‚lambda ä¸­çš„è¯­å¥ä¼šæˆä¸ºå…¶é—­åŒ…ç±»çš„æˆå‘˜å‡½æ•°ã€operator()ã€‘ä¸­çš„å¯æ‰§è¡ŒæŒ‡ä»¤ã€‚</p><p>é—­åŒ…å¯ä»¥æ‹·è´</p><hr><p>åœ¨å¼€å§‹æœ¬ç« ä¹‹å‰ï¼Œéœ€è¦ç†è§£å‡ ä¸ªåŸºæœ¬çš„æ¦‚å¿µï¼š</p><ul><li><strong>lambda è¡¨è¾¾å¼ï¼ˆlambda expressionï¼‰ï¼š</strong> è¡¨è¾¾å¼çš„ä¸€ç§ï¼Œå®ƒçš„åŸºæœ¬å†™æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[](<span class="type">int</span> val)&#123; <span class="keyword">return</span> <span class="number">0</span> &lt; val &amp;&amp; val &lt; <span class="number">10</span>; &#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é—­åŒ…ï¼ˆclosureï¼‰ï¼š</strong> lambda æ‰€åˆ›å»ºçš„è¿è¡ŒæœŸå¯¹è±¡ï¼Œæ ¹æ®ä¸åŒçš„æ•è·æ¨¡å¼ï¼Œé—­åŒ…ä¼šæŒæœ‰æ•°æ®çš„å‰¯æœ¬æˆ–å¼•ç”¨ã€‚</li><li><strong>é—­åŒ…ç±»ï¼ˆclosure classï¼‰ï¼š</strong> å®ä¾‹åŒ–é—­åŒ…çš„ç±»ï¼Œæ¯ä¸ª lambda éƒ½ä¼šä½¿ç¼–è¯‘å™¨ç”Ÿæˆå”¯ä¸€çš„é—­åŒ…ç±»ã€‚lambda ä¸­çš„è¯­å¥ä¼šæˆä¸ºå…¶é—­åŒ…ç±»çš„æˆå‘˜å‡½æ•°ä¸­çš„å¯æ‰§è¡ŒæŒ‡ä»¤ã€‚</li></ul><blockquote><p><strong>lambda è¡¨è¾¾å¼å’Œé—­åŒ…ç±»å­˜åœ¨äºç¼–è¯‘æœŸï¼Œè€Œé—­åŒ…å­˜åœ¨äºè¿è¡ŒæœŸã€‚</strong></p></blockquote><h3 id="æ¡æ¬¾-31ï¼šé¿å…é»˜è®¤æ•è·æ¨¡å¼">æ¡æ¬¾ 31ï¼šé¿å…é»˜è®¤æ•è·æ¨¡å¼</h3><hr><p>æŒ‰å¼•ç”¨ï¼šå¯èƒ½å¯¼è‡´ç©ºæ‚¬æŒ‡é’ˆ</p><p>æŒ‰å€¼ï¼šæ•è·æŒ‡é’ˆä¹Ÿä¼šå¯¼è‡´ç›¸åŒçš„æƒ…å†µ</p><p>é™æ€å¯¹è±¡ï¼Œå¯ä»¥åœ¨lamdbaè¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼Œä¸èƒ½æ•è·ã€‚</p><p>æ•è·åªèƒ½é’ˆå¯¹åœ¨åˆ›å»º lambda è¡¨è¾¾å¼çš„ä½œç”¨åŸŸå†…å¯è§çš„éé™æ€å±€éƒ¨å˜é‡ï¼ˆåŒ…æ‹¬å½¢å‚ï¼‰ã€‚</p><p><strong>è¦ç‚¹</strong></p><ul><li>é»˜è®¤çš„æŒ‰å¼•ç”¨æ•è·å¯èƒ½å¯¼è‡´æ‚¬ç©ºå¼•ç”¨</li><li>é»˜è®¤çš„æŒ‰å€¼æ•è·ä¹Ÿå¯èƒ½å‡ºç°æ‚¬ç©ºæŒ‡é’ˆï¼ˆå°¤å…¶æ˜¯thisæŒ‡é’ˆçš„æƒ…å†µï¼‰ï¼Œå¹¶ä¸”å®ƒä¼šäº§ç”Ÿè¯¯å¯¼ï¼Œè®©äººä»¥ä¸º lambda æ˜¯ç‹¬ç«‹çš„</li></ul><hr><p><strong>C++11 ä¸­æœ‰ä¸¤ç§é»˜è®¤æ•è·æ¨¡å¼ï¼šæŒ‰å¼•ç”¨æˆ–æŒ‰å€¼ã€‚æŒ‰å¼•ç”¨æ•è·ä¼šå¯¼è‡´é—­åŒ…å†…åŒ…å«æŒ‡å‘å±€éƒ¨å˜é‡çš„å¼•ç”¨ï¼Œæˆ–æŒ‡å‘å®šä¹‰ lambda çš„ä½œç”¨åŸŸå†…å½¢å‚çš„å¼•ç”¨ï¼Œä¸€æ—¦ç”± lambda æ‰€åˆ›å»ºçš„é—­åŒ…è¶Šè¿‡äº†è¯¥å±€éƒ¨å˜é‡æˆ–å½¢å‚çš„ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆé—­åŒ…å†…çš„å¼•ç”¨å°±ä¼šå‘ç”Ÿç©ºæ‚¬ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> FilterContainer = std::vector&lt;std::function&lt;<span class="built_in">bool</span>(<span class="type">int</span>)&gt;&gt;;</span><br><span class="line">FilterContainer filters;                                <span class="comment">// å…ƒç´ ä¸ºç­›é€‰å‡½æ•°çš„å®¹å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addDivisorFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> calc1 = <span class="built_in">computeSomeValue1</span>();</span><br><span class="line">    <span class="keyword">auto</span> calc2 = <span class="built_in">computeSomeValue2</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> divisor = <span class="built_in">computeDivisor</span>(calc1, calc2);</span><br><span class="line"></span><br><span class="line">    filters.<span class="built_in">emplace_back</span>(</span><br><span class="line">        [&amp;](<span class="type">int</span> value) &#123; <span class="keyword">return</span> value % divisor == <span class="number">0</span>; &#125; <span class="comment">// å±é™©ï¼æŒ‡å‘ divisor çš„å¼•ç”¨å¯èƒ½ç©ºæ‚¬</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¢ä½œç”¨æ˜¾å¼æ–¹å¼æŒ‰å¼•ç”¨æ•è·<code>divisor</code>ï¼Œé—®é¢˜ä¾æ—§ä¼šå‘ç”Ÿï¼Œä½†æ›´å®¹æ˜“çœ‹å‡º lambda ä¾èµ–äº<code>divisor</code>çš„ç”Ÿå‘½å‘¨æœŸè¿™ä¸€é—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filters.<span class="built_in">emplace_back</span>(</span><br><span class="line">    [&amp;divisor](<span class="type">int</span> value) &#123; <span class="keyword">return</span> value % divisor == <span class="number">0</span>; &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸€ç§æƒå®œä¹‹è®¡æ˜¯ä¸ä½¿ç”¨å®¹å™¨æ¥å­˜æ”¾ç­›é€‰å‡½æ•°ï¼Œè½¬è€Œä½¿ç”¨ C++11 çš„<code>std::all_of</code>å¯¹æ¯ä¸ªå…ƒç´ é€ä¸€è¿›è¡Œåˆ¤æ–­ã€‚ä½†å¦‚æœå°†è¯¥ lambda æ‹·è´åˆ°å…¶å®ƒé—­åŒ…æ¯”<code>divisor</code>ç”Ÿå‘½å‘¨æœŸæ›´é•¿çš„è¯­å¢ƒä¸­ï¼Œåˆ™ç©ºæ‚¬å¼•ç”¨çš„é—®é¢˜ä»ä¼šå‘ç”Ÿï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> C&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">workWithContainer</span><span class="params">(<span class="type">const</span> C&amp; container)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> calc1 = <span class="built_in">computeSomeValue1</span>();</span><br><span class="line">    <span class="keyword">auto</span> calc2 = <span class="built_in">computeSomeValue2</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> divisor = <span class="built_in">computeDivisor</span>(calc1, calc2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> ContElemT = <span class="keyword">typename</span> C::value_type;           <span class="comment">// å–å¾—å®¹å™¨ä¸­çš„å…ƒç´ ç±»å‹ï¼ˆå‚è€ƒæ¡æ¬¾ 13ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> std::begin;</span><br><span class="line">    <span class="keyword">using</span> std::end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (std::<span class="built_in">all_of</span>(<span class="built_in">begin</span>(container), <span class="built_in">end</span>(container),   <span class="comment">// åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å…ƒç´ éƒ½æ˜¯ divisor çš„å€æ•°</span></span><br><span class="line">        [&amp;](<span class="type">const</span> ContElemT&amp; value)                     <span class="comment">// C++14 å¯ä»¥ç›´æ¥å†™æˆ const auto&amp; value</span></span><br><span class="line">        &#123; <span class="keyword">return</span> value % divisor == <span class="number">0</span>; &#125;)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æœ¬ä¾‹ä¸­ï¼Œä½¿ç”¨é»˜è®¤çš„æŒ‰å€¼æ•è·æ¨¡å¼å°±è¶³ä»¥è§£å†³é—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filters.<span class="built_in">emplace_back</span>(</span><br><span class="line">    [=](<span class="type">int</span> value) &#123; <span class="keyword">return</span> value % divisor == <span class="number">0</span>; &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯é»˜è®¤çš„æŒ‰å€¼æ•è·æ¨¡å¼ä¹Ÿæœ‰å…¶é—®é¢˜ï¼šé»˜è®¤çš„æŒ‰å€¼æ•è·ææ˜“å—åˆ°ç©ºæ‚¬æŒ‡é’ˆçš„å½±å“ï¼ˆå°¤å…¶æ˜¯<code>this</code>æŒ‡é’ˆï¼‰ï¼Œå¹¶ä¸”ä¼šè¯¯å¯¼äººä»¬è®¤ä¸º lambda æ˜¯ç‹¬ç«‹çš„ã€‚è€ƒè™‘å¦‚ä¸‹æƒ…å½¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addFilter</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> divisor;    <span class="comment">// ç”¨äº Widget çš„ filters</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Widget::addFilter</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    filters.<span class="built_in">emplace_back</span>(</span><br><span class="line">        [=](<span class="type">int</span> value) &#123; <span class="keyword">return</span> value % divisor == <span class="number">0</span>; &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ­¤å¤„çš„ lambda è€Œè¨€ï¼Œ<code>divisor</code>æ—¢ä¸æ˜¯å±€éƒ¨å˜é‡ï¼Œä¹Ÿä¸æ˜¯å½¢å‚ï¼ŒæŒ‰ç†æ¥è®²æ˜¯å‹æ ¹æ— æ³•è¢«æ•è·çš„ã€‚äº‹å®ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œè¢«æ•è·çš„å®é™…ä¸Šæ˜¯<code>Widget</code>çš„<code>this</code>æŒ‡é’ˆï¼Œè€Œä¸æ˜¯<code>divisor</code>ã€‚å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œ<code>addFilter</code>çš„ä»£ç ç›¸å½“äºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Widget::addFilter</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> currentObjectPtr = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    filters.<span class="built_in">emplace_back</span>(</span><br><span class="line">        [currentObjectPtr](<span class="type">int</span> value)</span><br><span class="line">        &#123; <span class="keyword">return</span> value % currentObjectPtr-&gt;divisor == <span class="number">0</span>; &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œä¹Ÿå°±èƒ½ç†è§£ lambda é—­åŒ…çš„å­˜æ´»ä¾èµ–äºå®ƒå«æœ‰çš„<code>this</code>æŒ‡é’ˆå‰¯æœ¬æ‰€æŒ‡å‘çš„<code>Widget</code>å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å‡å¦‚é¢ä¸´ä»¥ä¸‹ä»£ç ï¼Œç©ºæ‚¬æŒ‡é’ˆçš„é—®é¢˜å°†å‡ºç°åœ¨æˆ‘ä»¬çš„çœ¼å‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> FilterContainer = std::vector&lt;std::function&lt;<span class="built_in">bool</span>(<span class="type">int</span>)&gt;&gt;;</span><br><span class="line">FilterContainer filters;                    <span class="comment">// åŒå‰</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doSomeWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> pw = std::<span class="built_in">make_unique</span>&lt;Widget&gt;();   <span class="comment">// åˆ›å»º Widgetï¼Œstd::make_unique çš„ä½¿ç”¨å‚è€ƒæ¡æ¬¾ 21</span></span><br><span class="line"></span><br><span class="line">    pw-&gt;<span class="built_in">addFilter</span>();                        <span class="comment">// æ·»åŠ ä½¿ç”¨äº† Widget::divisor çš„ç­›é€‰å‡½æ•°</span></span><br><span class="line">    ...</span><br><span class="line">&#125;                                           <span class="comment">// Widget è¢«é”€æ¯ï¼Œfilters ç°åœ¨æŒæœ‰ç©ºæ‚¬æŒ‡é’ˆï¼</span></span><br></pre></td></tr></table></figure><p>ä¸€ç§è§£å†³æ–¹æ³•æ˜¯å°†ä½ æƒ³æ•è·çš„æˆå‘˜å˜é‡æ‹·è´è‡³å±€éƒ¨å˜é‡ä¸­ï¼Œä¹‹åå†æ•è·è¯¥å‰¯æœ¬å±€éƒ¨å˜é‡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Widget::addFilter</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> divisorCopy = divisor;</span><br><span class="line"></span><br><span class="line">    filters.<span class="built_in">emplace_back</span>(</span><br><span class="line">        [divisorCopy](<span class="type">int</span> value) &#123; <span class="keyword">return</span> value % divisorCopy == <span class="number">0</span>; &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ C++14 ä¸­ï¼Œæ•è·æˆå‘˜å˜é‡çš„ä¸€ç§æ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨<strong>å¹¿ä¹‰ lambda æ•è·ï¼ˆgeneralized lambda captureï¼Œå‚è€ƒæ¡æ¬¾ 32ï¼‰</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Widget::addFilter</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    filters.<span class="built_in">emplace_back</span>(</span><br><span class="line">        [divisor = divisor](<span class="type">int</span> value)  <span class="comment">// C++14: å°† divisor æ‹·è´å…¥é—­åŒ…å¹¶ä½¿ç”¨å‰¯æœ¬</span></span><br><span class="line">        &#123; <span class="keyword">return</span> value % divisor == <span class="number">0</span>; &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤çš„æŒ‰å€¼æ•è·æ¨¡å¼çš„å¦ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œå®ƒä¼šä½¿äººä»¬è¯¯è®¤ä¸ºé—­åŒ…æ˜¯ç‹¬ç«‹çš„ï¼Œä¸é—­åŒ…å¤–çš„æ•°æ®å˜åŒ–ç›¸éš”ç»ã€‚ä½†å®é™…ä¸Šå¹¶éå¦‚æ­¤ï¼Œlambda å¯èƒ½ä¸ä»…ä¾èµ–äºå±€éƒ¨å˜é‡å’Œå½¢å‚ï¼Œè¿˜ä¼šä¾èµ–äº<strong>é™æ€å­˜å‚¨æœŸï¼ˆstatic storage durationï¼‰å¯¹è±¡</strong>ï¼Œè¿™æ ·çš„å¯¹è±¡å¯ä»¥åœ¨ lambda ä¸­ä½¿ç”¨ï¼Œä½†å´æ— æ³•è¢«æ•è·ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­è¶³ä»¥ä½“ç°è¿™ä¸€ç‚¹ä¼šé€ æˆçš„é—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">addDivisorFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">auto</span> calc1 = <span class="built_in">computeSomeValue1</span>();</span><br><span class="line">    <span class="type">static</span> <span class="keyword">auto</span> calc2 = <span class="built_in">computeSomeValue2</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="keyword">auto</span> divisor = <span class="built_in">computeDivisor</span>(calc1, calc2);</span><br><span class="line"></span><br><span class="line">    filters.<span class="built_in">emplace_back</span>(</span><br><span class="line">        [=](<span class="type">int</span> value)                      <span class="comment">// æœªæ•è·ä»»ä½•ä¸œè¥¿ï¼</span></span><br><span class="line">        &#123; <span class="keyword">return</span> value % divisor == <span class="number">0</span>; &#125;    <span class="comment">// å¼•ç”¨ä¸Šé¢çš„ static å¯¹è±¡</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    ++divisor;                              <span class="comment">// æ„å¤–ä¿®æ”¹äº† divisor</span></span><br><span class="line">                                            <span class="comment">// å¯¼è‡´æ¯ä¸ª lambda éƒ½å‡ºç°æ–°çš„è¡Œä¸º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-32ï¼šä½¿ç”¨åˆå§‹åŒ–æ•è·å°†å¯¹è±¡ç§»å…¥é—­åŒ…">æ¡æ¬¾ 32ï¼šä½¿ç”¨åˆå§‹åŒ–æ•è·å°†å¯¹è±¡ç§»å…¥é—­åŒ…</h3><hr><p>è¦ç‚¹</p><ul><li>å¯ä»¥ä½¿ç”¨ C++14 çš„åˆå§‹åŒ–æ•è·å°†å¯¹è±¡ç§»åŠ¨åˆ°é—­åŒ…ä¸­</li><li>åœ¨ C++11 ä¸­ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»æˆ– std::bind æ¥æ¨¡æ‹Ÿåˆå§‹åŒ–æ•è·ã€‚</li></ul><hr><p>C++14 ä¸­æ–°å¢çš„<strong>åˆå§‹åŒ–æ•è·ï¼ˆinit captureï¼Œåˆç§°å¹¿ä¹‰ lambda æ•è·ï¼‰</strong>ï¼Œå¯ä»¥è®©ä½ æŒ‡å®šï¼š</p><ol><li>ç”± lambda ç”Ÿæˆçš„é—­åŒ…ç±»ä¸­æˆå‘˜å˜é‡çš„åå­—ã€‚</li><li>ä¸€ä¸ªç”¨äºåˆå§‹åŒ–è¯¥æˆå‘˜å˜é‡çš„è¡¨è¾¾å¼ã€‚</li></ol><p>ä¸‹é¢æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨åˆå§‹åŒ–æ•è·å°†<code>std::unique_ptr</code>ç§»å…¥é—­åŒ…å†…ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isValidated</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isProcessed</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isArchived</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> pw = std::<span class="built_in">make_unique</span>&lt;Widget&gt;();   <span class="comment">// åˆ›å»º Widgetï¼Œstd::make_unique çš„ä½¿ç”¨å‚è€ƒæ¡æ¬¾ 21</span></span><br><span class="line"></span><br><span class="line">...                                     <span class="comment">// é…ç½® *pw</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> func = [pw = std::<span class="built_in">move</span>(pw)]        <span class="comment">// ä½¿ç”¨ std::move(pw) åˆå§‹åŒ–é—­åŒ…ç±»çš„æ•°æ®æˆå‘˜</span></span><br><span class="line">            &#123; <span class="keyword">return</span> pw-&gt;<span class="built_in">isValidated</span>() &amp;&amp; pw-&gt;<span class="built_in">isArchived</span>(); &#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœç»ç”±<code>std::make_unique</code>åˆ›å»ºçš„å¯¹è±¡å·²å…·å¤‡è¢« lambda æ•è·çš„åˆé€‚çŠ¶æ€ï¼Œåˆ™é—­åŒ…ç±»æˆåŸå¯¹è±¡å¯ä»¥ç›´æ¥ç”±<code>std::make_unique</code>å®Œæˆåˆå§‹åŒ–ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> func = [pw = std::<span class="built_in">make_unique</span>&lt;Widget&gt;()]</span><br><span class="line">            &#123; <span class="keyword">return</span> pw-&gt;<span class="built_in">isValidated</span>() &amp;&amp; pw-&gt;<span class="built_in">isArchived</span>(); &#125;;</span><br></pre></td></tr></table></figure><p>åœ¨åˆå§‹åŒ–æ•è·çš„ä»£ç ä¸­ï¼Œä½äº<code>=</code>å·¦ä¾§çš„æ˜¯æ‰€æŒ‡å®šçš„é—­åŒ…ç±»æˆå‘˜å˜é‡çš„åç§°ï¼Œå³ä¾§çš„åˆ™æ˜¯å…¶åˆå§‹åŒ–è¡¨è¾¾å¼ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ<code>=</code>çš„å·¦å³ä¸¤ä¾§ä½äºä¸åŒçš„ä½œç”¨åŸŸï¼Œå·¦ä¾§ä½œç”¨åŸŸå°±æ˜¯é—­åŒ…çš„ä½œç”¨åŸŸï¼Œè€Œå³ä¾§ä½œç”¨åŸŸåˆ™ä¸ lambda å®šä¹‰æ‰€åœ¨çš„ä½œç”¨åŸŸç›¸åŒã€‚</p><p>åœ¨ C++11 ä¸­ï¼Œæˆ‘ä»¬è™½ç„¶æ— æ³•ä½¿ç”¨åˆå§‹åŒ–æ•è·ï¼Œä½†æ˜¯å¯ä»¥ä¾é åŸç†ç›¸åŒçš„æ‰‹å†™ç±»è¾¾åˆ°ç›®çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IsValAndArch</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> DataType = std::unique_ptr&lt;Widget&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">IsValAndArch</span><span class="params">(DataType&amp;&amp; ptr)</span>   <span class="comment">// std::move çš„ä½¿ç”¨å‚è€ƒæ¡æ¬¾ 25</span></span></span><br><span class="line"><span class="function">        : pw(std::move(ptr)) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span> <span class="type">const</span> </span>&#123;               <span class="comment">// ç¼–å†™ä»¿å‡½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> pw-&gt;<span class="built_in">isValidated</span>() &amp;&amp; pw-&gt;<span class="built_in">isArchived</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    DataType pw;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> func = <span class="built_in">IsValAndArch</span>(std::<span class="built_in">make_unique</span>&lt;Widget&gt;());</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ éè¦ä½¿ç”¨ lambdaï¼ŒæŒ‰ç§»åŠ¨æ•è·ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ¨¡æ‹Ÿï¼š</p><ol><li>å°†éœ€è¦æ•è·çš„å¯¹è±¡ç§»è‡³<code>std::bind</code>æ‰€äº§ç”Ÿçš„å‡½æ•°å¯¹è±¡ä¸­ã€‚</li><li>ç»™äºˆ lambda ä¸€ä¸ªæŒ‡å‘æƒ³è¦ â€œæ•è·â€ çš„å¯¹è±¡çš„å¼•ç”¨ã€‚</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="type">double</span>&gt; data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> func =</span><br><span class="line">    std::<span class="built_in">bind</span>([](<span class="type">const</span> std::vector&lt;<span class="type">double</span>&gt;&amp; data)   <span class="comment">// C++11 æ¨¡æ‹Ÿåˆå§‹åŒ–æ•è·</span></span><br><span class="line">              &#123; <span class="comment">/* ä½¿ç”¨ data */</span> &#125;,</span><br><span class="line">              std::<span class="built_in">move</span>(data));</span><br></pre></td></tr></table></figure><p><code>std::bind</code>çš„ç¬¬ä¸€ä¸ªå®å‚æ˜¯ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œæ¥ä¸‹æ¥çš„æ‰€æœ‰å®å‚è¡¨ç¤ºä¼ ç»™è¯¥å¯¹è±¡çš„å€¼ã€‚å’Œ lambda è¡¨è¾¾å¼ç±»ä¼¼ï¼Œ<code>std::bind</code>ä¹Ÿä¼šç”Ÿæˆå‡½æ•°å¯¹è±¡ï¼ˆåŸä¹¦ä¸­ç§°å…¶ä¸º<strong>ç»‘å®šå¯¹è±¡ï¼Œbind object</strong>ï¼‰ï¼Œå…¶ä¸­å«æœ‰ä¼ é€’ç»™<code>std::bind</code>çš„æ‰€æœ‰å®å‚çš„å‰¯æœ¬ï¼Œå…¶ä¸­å·¦å€¼å®å‚æ‰§è¡Œçš„æ˜¯æ‹·è´æ„é€ ï¼Œè€Œå³å€¼å®å‚æ‰§è¡Œçš„åˆ™æ˜¯ç§»åŠ¨æ„é€ ã€‚å› æ­¤ï¼Œåœ¨æ­¤å¤„ç”¨<code>std::move(data)</code>ä½œä¸ºå®å‚å¯ä»¥è®©<code>data</code>è¢«ç§»å…¥ç»‘å®šå¯¹è±¡ä¸­ï¼Œè¢« lambda çš„å·¦å€¼å¼•ç”¨å½¢å‚æ‰€æ¥å—ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œlambda ç”Ÿæˆçš„é—­åŒ…ç±»ä¸­çš„<code>operator()</code>æˆå‘˜å‡½æ•°ä¼šå¸¦æœ‰<code>const</code>é™å®šç¬¦ï¼Œå®ƒä¼šå¯¼è‡´æ˜¯é—­åŒ…ç±»é‡Œçš„æ‰€æœ‰æˆå‘˜å˜é‡åœ¨ lambda çš„å‡½æ•°ä½“å†…éƒ½ä¼šå¸¦æœ‰<code>const</code>é™å®šç¬¦ã€‚ä½†æ˜¯ï¼Œç»‘å®šå¯¹è±¡é‡Œé€šè¿‡ç§»åŠ¨æ„é€ å¾—åˆ°çš„<code>data</code>å‰¯æœ¬å´å¹¶ä¸å¸¦æœ‰<code>const</code>é™å®šç¬¦ã€‚å› æ­¤ï¼Œä¸ºäº†é˜²æ­¢è¯¥<code>data</code>å‰¯æœ¬åœ¨ lambda ä¸­è¢«æ„å¤–ä¿®æ”¹ï¼Œæˆ‘ä»¬ä¼šå°†å…¶å½¢å‚å£°æ˜ä¸ºå¸¸å¼•ç”¨ã€‚ä½†å¦‚æœ lambda åœ¨å£°æ˜æ—¶å¸¦æœ‰<code>mutable</code>é™å®šç¬¦ï¼Œåˆ™é—­åŒ…é‡Œçš„<code>operator()</code>å°±ä¸å†ä¼šå¸¦æœ‰<code>const</code>é™å®šç¬¦ï¼Œä¹Ÿä¸å¿…å†å°†å½¢å‚å£°æ˜ä¸ºå¸¸å¼•ç”¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> func =</span><br><span class="line">    std::<span class="built_in">bind</span>([](std::vector&lt;<span class="type">double</span>&gt;&amp; data) <span class="keyword">mutable</span></span><br><span class="line">              &#123; <span class="comment">/* ä½¿ç”¨ data */</span> &#125;,</span><br><span class="line">              std::<span class="built_in">move</span>(data));</span><br></pre></td></tr></table></figure><p>å›åˆ°ä¹‹å‰çš„ä¾‹å­ï¼Œä½¿ç”¨ C++14 åœ¨é—­åŒ…å†…åˆ›å»º<code>std::unique_ptr</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> func = [pw = std::<span class="built_in">make_unique</span>&lt;Widget&gt;()]</span><br><span class="line">            &#123; <span class="keyword">return</span> pw-&gt;<span class="built_in">isValidated</span>() &amp;&amp; pw-&gt;<span class="built_in">isArchived</span>(); &#125;;</span><br></pre></td></tr></table></figure><p>å®ƒåœ¨ C++11 ä¸­çš„æ¨¡æ‹Ÿä»£ç å¯ä»¥è¿™æ ·ç¼–å†™ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> func = std::<span class="built_in">bind</span>([](<span class="type">const</span> std::unique_ptr&lt;Widget&gt;&amp; pw)</span><br><span class="line">                      &#123; <span class="keyword">return</span> pw-&gt;<span class="built_in">isValidated</span>() &amp;&amp; pw-&gt;<span class="built_in">isArchived</span>(); &#125;,</span><br><span class="line">                      std::<span class="built_in">make_unique</span>&lt;Widget&gt;());</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-33ï¼šå¯¹-auto-ç±»å‹çš„å½¢å‚ä½¿ç”¨-decltype-ä»¥å¯¹å…¶å®æ–½-std-forward">æ¡æ¬¾ 33ï¼šå¯¹ auto&amp;&amp; ç±»å‹çš„å½¢å‚ä½¿ç”¨ decltype ä»¥å¯¹å…¶å®æ–½ std::forward</h3><hr><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">auto</span> f =[](auto&amp;&amp; param)&#123;returnfunc(normalize(std::forward&lt;decl<span class="keyword">type</span>(param)&gt;(param)));&#125;;</span><br></pre></td></tr></table></figure><p><strong>è¦ç‚¹</strong><br>å¯¹ auto&amp;&amp; å‚æ•°ä½¿ç”¨ decltype æ¥è¿›è¡Œ std::forward</p><hr><p>C++14 æ”¯æŒ<strong>æ³›å‹ lambdaï¼ˆgeneric lambdaï¼‰</strong>ï¼Œå¯ä»¥åœ¨å£°æ˜å½¢å‚æ—¶ä½¿ç”¨<code>auto</code>ï¼Œå³é—­åŒ…ç±»ä¸­çš„<code>operator()</code>å¯ä»¥ç”¨æ¨¡æ¿å®ç°ã€‚ä¾‹å¦‚ï¼Œç»™å®šä»¥ä¸‹ lambdaï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> f = [](<span class="keyword">auto</span> x) &#123; <span class="keyword">return</span> <span class="built_in">func</span>(<span class="built_in">normalize</span>(x)); &#125;;</span><br></pre></td></tr></table></figure><p>åˆ™é—­åŒ…ç±»çš„<code>operator()</code>å®ç°å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SomeCompilerGeneratedClassName</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">auto</span> <span class="title">operator</span><span class="params">()</span><span class="params">(T x)</span> <span class="type">const</span> </span>&#123;    <span class="comment">// auto ç±»å‹çš„è¿”å›å€¼ï¼Œå‚è€ƒæ¡æ¬¾ 3</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">func</span>(<span class="built_in">normalize</span>(x));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤å¤„ï¼Œlambda æ€»ä¼šä¼ é€’å·¦å€¼ç»™<code>normalize</code>ï¼Œè¿™å¯¹äºä¸€ä¸ªä¼šåŒºåˆ«å¯¹å¾…å·¦ã€å³å€¼çš„<code>normalize</code>æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚å¦‚æœæƒ³è¦ä¿ç•™å®å‚çš„å·¦ã€å³å€¼æ€§ï¼Œå°±éœ€è¦å°†å½¢å‚å£°æ˜ä¸ºä¸‡èƒ½å¼•ç”¨ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 24</strong>ï¼‰ï¼Œå¹¶ä½¿ç”¨<code>std::forward</code>å°†å…¶è½¬å‘ç»™<code>normalize</code>ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 25</strong>ï¼‰ã€‚è¿™æ ·çš„æ”¹é€ ååˆ†ç®€å•ï¼Œå”¯ä¸€çš„é—®é¢˜æ˜¯åœ¨ lambda ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å¯ç”¨çš„æ¨¡æ¿å½¢å‚<code>T</code>ï¼Œåªèƒ½å¯¹è¦è½¬å‘çš„å½¢å‚ä½¿ç”¨<code>decltype</code>ï¼Œä»¥å–å¾—å…¶ç±»å‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> f = [](<span class="keyword">auto</span>&amp;&amp; param) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">func</span>(<span class="built_in">normalize</span>(std::forward&lt;<span class="keyword">decltype</span>(param)&gt;(param)));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>æ¡æ¬¾ 28</strong> è¯´æ˜äº†ï¼Œä½¿ç”¨<code>std::forward</code>çš„æƒ¯ä¾‹æ˜¯ï¼šç”¨å·¦å€¼å¼•ç”¨ç±»å‹çš„æ¨¡æ¿å½¢å‚æ¥è¡¨æ˜æƒ³è¦è¿”å›å·¦å€¼ï¼Œç”¨éå¼•ç”¨ç±»å‹çš„æ¨¡æ¿å½¢å‚æ¥è¡¨æ˜æƒ³è¦è¿”å›å³å€¼ã€‚è€Œåœ¨æ­¤å¤„ï¼Œå¦‚æœ<code>param</code>æ˜¯å·¦å€¼ï¼Œåˆ™<code>decltype(param)</code>ä¼šäº§ç”Ÿå·¦å€¼å¼•ç”¨ç±»å‹ï¼Œè¿™ç¬¦åˆæƒ¯ä¾‹ï¼›ä½†å¦‚æœ<code>param</code>æ˜¯å³å€¼ï¼Œåˆ™<code>decltype(param)</code>ä¼šäº§ç”Ÿå³å€¼å¼•ç”¨ç±»å‹ï¼Œä¸ç¬¦åˆæƒ¯ä¾‹çš„éå¼•ç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>std::forward</code>å°†è¢«å…·ç°åŒ–ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Widget&amp;&amp; &amp;&amp; <span class="title">forward</span><span class="params">(<span class="type">remove_reference_t</span>&lt;Widget&amp;&gt;&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Widget&amp;&amp; &amp;&amp;&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºå¼•ç”¨æŠ˜å çš„å­˜åœ¨ï¼Œ<code>Widget&amp;&amp; &amp;&amp;</code>å°†è¢«æŠ˜å ä¸º<code>Widget&amp;&amp;</code>ï¼Œæ‰€ä»¥å®é™…ä¸Šç”Ÿæˆçš„ä»£ç å’Œä½¿ç”¨éå¼•ç”¨ç±»å‹ä½œä¸ºæ¨¡æ¿å½¢å‚ç”Ÿæˆçš„ç‰ˆæœ¬å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨æ­¤å¤„ä½¿ç”¨<code>decltype(param)</code>å¹¶ä¸ä¼šäº§ç”Ÿä»»ä½•é—®é¢˜ï¼Œè¿™æ˜¯ä¸ªéå¸¸ä¸é”™çš„ç»“æœã€‚</p><p>C++14 çš„ lambda ä¹Ÿæ”¯æŒå¯å˜å‚æ•°ï¼Œåªéœ€ç¨åŠ æ”¹åŠ¨ï¼Œå°±å¯ä»¥å¾—åˆ°èƒ½æ¥å—å¤šä¸ªå‚æ•°çš„å®Œç¾è½¬å‘ lambda ç‰ˆæœ¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> f = [](<span class="keyword">auto</span>&amp;&amp;... params) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">func</span>(<span class="built_in">normalize</span>(std::forward&lt;<span class="keyword">decltype</span>(params)&gt;(params)...));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-34ï¼šä¼˜å…ˆé€‰ç”¨-lambdaï¼Œè€Œé-std-bind">æ¡æ¬¾ 34ï¼šä¼˜å…ˆé€‰ç”¨ lambdaï¼Œè€Œé std::bind</h3><p>ä¹‹æ‰€ä»¥ä¼˜å…ˆé€‰ç”¨ lambda è€Œé std::bindï¼Œæœ€ä¸»è¦çš„åŸå› æ˜¯ lambda å…·æœ‰æ›´é«˜çš„å¯è¯»æ€§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸ªå‡½æ•°ç”¨æ¥è®¾ç½®è­¦æŠ¥å£°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºæ—¶åˆ»çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">using</span> Time = std::chrono::steady_clock::time_point;</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Sound</span> &#123; Beep, Siren, Whistle &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨ç¤ºæ—¶é•¿çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">using</span> Duration = std::chrono::steady_clock::duration;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ—¶åˆ» tï¼Œå‘å‡ºå£°éŸ³ sï¼ŒæŒç»­æ—¶é•¿ d</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setAlarm</span><span class="params">(Time t, Sound s, Duration d)</span></span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª lambdaï¼Œè®¾ç½®åœ¨ä¸€å°æ—¶åå‘å‡ºè­¦æŠ¥å¹¶æŒç»­ 30 ç§’ï¼ŒåŒæ—¶æä¾›æ¥å£ï¼Œä»¥æŒ‡å®šå‘å‡ºçš„å£°éŸ³ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> setSoundL = [](Sound s) &#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std::literals;              <span class="comment">// å¼•å…¥ C++14 ä¸­çš„å­—é¢é‡åç¼€</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setAlarm</span>(steady_clock::<span class="built_in">now</span>() + <span class="number">1</span>h, s, <span class="number">30</span>s); <span class="comment">// C++11 éœ€è¦ç”¨ hours å’Œ seconds ä»£æ›¿åç¼€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†å°è¯•ä½¿ç”¨<code>std::bind</code>æ¥ç¼–å†™ç›¸åº”çš„ä»£ç ã€‚ä¸‹é¢çš„è¿™æ®µä»£ç å¹¶ä¸æ­£ç¡®ï¼Œä½†è¶³ä»¥è®©æˆ‘ä»¬å‘ç°<code>std::bind</code>çš„éš¾ç”¨ä¹‹å¤„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::literals;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::placeholders;  <span class="comment">// å¼•å…¥å ä½ç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> setSoundB = std::<span class="built_in">bind</span>(setAlarm,</span><br><span class="line">                           steady_clock::<span class="built_in">now</span>() + <span class="number">1</span>h,</span><br><span class="line">                           _1,</span><br><span class="line">                           <span class="number">30</span>s);</span><br></pre></td></tr></table></figure><p>å ä½ç¬¦<code>_1</code>è¡¨ç¤ºå®ƒåœ¨<code>std::bind</code>å½¢å‚åˆ—è¡¨ä¸­çš„æ˜ å°„ä½ç½®ï¼Œåœ¨æ­¤å¤„è¡¨ç¤ºè°ƒç”¨<code>setSoundB</code>æ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå®å‚ï¼Œä¼šä½œä¸ºç¬¬äºŒä¸ªå®å‚ä¼ é€’ç»™<code>setAlarm</code>ã€‚è¿™æ˜¾ç„¶å·²ç»ä¸å¦‚ lambda ç›´è§‚ã€‚</p><p>æ›´é‡è¦çš„æ˜¯ä¸Šè¿°ä»£ç æ‰€éšå«çš„é—®é¢˜ï¼šè°ƒç”¨æ—¶é—´çš„é”™è¯¯ã€‚åœ¨<code>std::bind</code>çš„è°ƒç”¨ä¸­ï¼Œ<code>steady_clock::now() + 1h</code>ä½œä¸ºå®å‚è¢«ä¼ é€’ç»™äº†<code>std::bind</code>ï¼Œè€Œé<code>setAlarm</code>ï¼Œè¿™æ„å‘³ç€è¯¥è¡¨è¾¾å¼ä¼šåœ¨è°ƒç”¨<code>std::bind</code>çš„æ—¶åˆ»è®¡ç®—å‡ºå…·ä½“å€¼ï¼Œè€Œéè°ƒç”¨<code>setAlarm</code>çš„æ—¶åˆ»ï¼Œè¿™ä¸æˆ‘ä»¬çš„æ„å›¾æ˜¾ç„¶ä¸ç¬¦ã€‚æƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±è¦åµŒå¥—ç¬¬äºŒå±‚<code>std::bind</code>çš„è°ƒç”¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> setSoundB = std::<span class="built_in">bind</span>(setAlarm,</span><br><span class="line">                           std::<span class="built_in">bind</span>(std::plus&lt;&gt;(), <span class="comment">// C++11 æ— æ³•çœç•¥ std::plus&lt;steady_clock::time_point&gt;()</span></span><br><span class="line">                                     steady_clock::<span class="built_in">now</span>(),</span><br><span class="line">                                     <span class="number">1</span>h),</span><br><span class="line">                           _1,</span><br><span class="line">                           <span class="number">30</span>s);</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ª<code>std::bind</code>ä¸å¦‚ lambda çš„ä¾‹å­æ˜¯é‡è½½ã€‚å‡å¦‚æœ‰ä¸ªé‡è½½ç‰ˆæœ¬ä¼šæ¥å—ç¬¬å››ä¸ªå½¢å‚ï¼Œç”¨äºæŒ‡å®šè­¦æŠ¥çš„éŸ³é‡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">Volume</span> &#123; Normal, Loud, LoudPlusPlus &#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setAlarm</span><span class="params">(Time t, Sound s, Duration d, Volume v)</span></span>;</span><br></pre></td></tr></table></figure><p>åŸæ¥çš„ lambda ä»ä¼šæ­£å¸¸è¿ä½œï¼Œè€Œ<code>std::bind</code>ä¼šç«‹åˆ»å‘ç”Ÿé”™è¯¯ï¼Œå› ä¸ºå®ƒåªæœ‰å‡½æ•°åï¼Œå¹¶ä¸çŸ¥é“è¦è°ƒç”¨å“ªä¸ªé‡è½½ç‰ˆæœ¬çš„å‡½æ•°ã€‚ä¸ºä½¿å¾—<code>std::bind</code>çš„è°ƒç”¨èƒ½é€šè¿‡ç¼–è¯‘ï¼Œå¿…é¡»å°†<code>setAlarm</code>å¼ºåˆ¶è½¬æ¢åˆ°é€‚å½“çš„å‡½æ•°æŒ‡é’ˆç±»å‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> SetAlarm3ParamType = <span class="built_in">void</span> (*)(Time t, Sound s, Duration d);</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> setSoundB = std::<span class="built_in">bind</span>(<span class="built_in">static_cast</span>&lt;SetAlarm3ParamType&gt;(setAlarm),</span><br><span class="line">                           std::<span class="built_in">bind</span>(std::plus&lt;&gt;(), steady_clock::<span class="built_in">now</span>(), <span class="number">1</span>h),</span><br><span class="line">                           _1,</span><br><span class="line">                           <span class="number">30</span>s);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ›´æç«¯çš„ä¾‹å­ï¼Œæ¼”ç¤ºäº†<code>std::bind</code>åˆ°åº•æœ‰å¤šæ™¦æ¶©ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lambda ç‰ˆæœ¬ï¼ˆC++14ï¼‰</span></span><br><span class="line"><span class="keyword">auto</span> betweenL = [lowVal, highVal](<span class="type">const</span> <span class="keyword">auto</span>&amp; val) &#123;</span><br><span class="line">    <span class="keyword">return</span> lowVal &lt;= val &amp;&amp; val &lt;= highVal;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// std::bind ç‰ˆæœ¬ï¼ˆC++14ï¼‰</span></span><br><span class="line"><span class="keyword">auto</span> betweenB = std::<span class="built_in">bind</span>(std::logical_and&lt;&gt;(),</span><br><span class="line">                          std::<span class="built_in">bind</span>(std::less_equal&lt;&gt;(), lowVal, std::placeholders::_1),</span><br><span class="line">                          std::<span class="built_in">bind</span>(std::less_equal&lt;&gt;(), std::placeholders::_1, highVal),)</span><br></pre></td></tr></table></figure><p><code>std::bind</code>æ€»æ˜¯æ‹·è´å…¶å®å‚ï¼Œè°ƒç”¨æ—¶éœ€è¦å€ŸåŠ©<code>std::ref</code>æ¥è¾¾åˆ°æŒ‰å¼•ç”¨å­˜å‚¨å®å‚çš„ç›®çš„ï¼Œè¿™ä¸€ç‚¹åŒæ ·ä¹Ÿä¸å¦‚ lambda æ¥å¾—æ˜ç¡®ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> compressRateL = [&amp;w](CompLevel lev) &#123; <span class="keyword">return</span> <span class="built_in">compress</span>(w, lev); &#125;;</span><br><span class="line"><span class="keyword">auto</span> compressRateB = std::<span class="built_in">bind</span>(compress, std::<span class="built_in">ref</span>(w), std::placeholders::_1);</span><br></pre></td></tr></table></figure><p>é™¤äº†å¯è¯»æ€§ä»¥å¤–ï¼Œç¼–è¯‘å™¨é€šå¸¸èƒ½æ›´å¥½åœ°ä»¥å†…è”ä¼˜åŒ– lambda æ‰€è°ƒç”¨çš„å‡½æ•°ï¼Œè€Œå¯¹äºä½¿ç”¨å‡½æ•°æŒ‡é’ˆçš„<code>std::bind</code>åˆ™å¾ˆéš¾åšåˆ°ï¼Œè¿™ä¼šå¯¼è‡´ä½¿ç”¨ lambda æœ‰å¯èƒ½ä¼šç”Ÿæˆæ¯”ä½¿ç”¨<code>std::bind</code>è¿è¡Œå¾—æ›´å¿«çš„ä»£ç ã€‚</p><p>åœ¨ C++11 ä¸­ï¼Œ<code>std::bind</code>ä»…åœ¨ä¸¤ä¸ªå—é™çš„åœºåˆè¿˜æœ‰ä½¿ç”¨çš„ç†ç”±ï¼š</p><ol><li>ç§»åŠ¨æ•è·ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 32</strong>ï¼‰ï¼›</li><li>å¤šæ€å‡½æ•°å¯¹è±¡ï¼ˆè¿™åœ¨ C++14 ä¸­å¯ä»¥è¢«æ³›å‹ lambda è½»æ˜“å®ç°ï¼‰ï¼š</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PolyWidget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> T&amp; param)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PolyWidget pw;</span><br><span class="line"><span class="keyword">auto</span> boundPW = std::<span class="built_in">bind</span>(pw, std::placeholders::_1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ä»¥ç”¨ä¸åŒç±»å‹çš„å®å‚è°ƒç”¨ PolyWidget::operator()</span></span><br><span class="line"><span class="built_in">boundPW</span>(<span class="number">1930</span>);</span><br><span class="line"><span class="built_in">boundPW</span>(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="built_in">boundPW</span>(<span class="string">&quot;Rosebud&quot;</span>); <span class="comment">// åŸä¹¦ä½œè€…ç©çš„ã€Šå…¬æ°‘å‡¯æ©ã€‹æ¢—ï¼ˆåº”è¯¥æ˜¯å§ï¼‰</span></span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸ƒç« ï¼šå¹¶å‘-API">ç¬¬ä¸ƒç« ï¼šå¹¶å‘ API</h2><h3 id="æ¡æ¬¾-35ï¼šä¼˜å…ˆé€‰ç”¨åŸºäºä»»åŠ¡è€ŒéåŸºäºçº¿ç¨‹çš„ç¨‹åºè®¾è®¡">æ¡æ¬¾ 35ï¼šä¼˜å…ˆé€‰ç”¨åŸºäºä»»åŠ¡è€ŒéåŸºäºçº¿ç¨‹çš„ç¨‹åºè®¾è®¡</h3><p>å¦‚æœä½ æƒ³ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œå‡½æ•°<code>doAsyncWork</code>ï¼Œä½ å¯ä»¥é€‰æ‹©<strong>åŸºäºçº¿ç¨‹ï¼ˆthread-basedï¼‰</strong> çš„æ–¹å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">doAsyncWork</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">std::thread <span class="title">t</span><span class="params">(doAsyncWork)</span></span>;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥å°†<code>doAsyncWork</code>ä¼ é€’ç»™<code>std::async</code>ï¼Œè¿™æ˜¯<strong>åŸºäºä»»åŠ¡ï¼ˆtask-basedï¼‰</strong> çš„æ–¹å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fut = std::<span class="built_in">async</span>(doAsyncWork); <span class="comment">// éœ€è¦ #include &lt;future&gt;</span></span><br></pre></td></tr></table></figure><p>â€œçº¿ç¨‹â€ åœ¨å¸¦æœ‰å¹¶å‘çš„ C++ è½¯ä»¶ä¸­æœ‰ä¸‰é‡å«ä¹‰ï¼š</p><ul><li><strong>ç¡¬ä»¶çº¿ç¨‹ï¼ˆhardware threadsï¼‰</strong> æ˜¯å®é™…æ‰§è¡Œè®¡ç®—çš„çº¿ç¨‹ã€‚ç°ä»£è®¡ç®—æœºæ¶æ„ä¼šä¸ºæ¯ä¸ª CPU å†…æ ¸æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªç¡¬ä»¶çº¿ç¨‹ã€‚</li><li><strong>è½¯ä»¶çº¿ç¨‹ï¼ˆsoftware threadsï¼Œä¹Ÿç§°ç³»ç»Ÿçº¿ç¨‹ï¼‰</strong> æ˜¯æ“ä½œç³»ç»Ÿï¼ˆæˆ–åµŒå…¥å¼ç³»ç»Ÿï¼‰ç”¨äºå®ç°è·¨è¿›ç¨‹çš„ç®¡ç†ï¼Œä»¥åŠè¿›è¡Œç¡¬ä»¶çº¿ç¨‹è°ƒåº¦çš„çº¿ç¨‹ã€‚é€šå¸¸ï¼Œèƒ½å¤Ÿåˆ›å»ºçš„è½¯ä»¶çº¿ç¨‹æ¯”ç¡¬ä»¶çº¿ç¨‹è¦å¤šï¼Œå› ä¸ºå½“ä¸€ä¸ªè½¯ä»¶çº¿ç¨‹è¢«é˜»å¡æ—¶ï¼Œè¿è¡Œå…¶å®ƒæœªé˜»å¡çº¿ç¨‹èƒ½å¤Ÿæé«˜ååç‡ã€‚</li><li><strong><code>std::thread</code></strong> æ˜¯ C++ è¿›ç¨‹ä¸­çš„å¯¹è±¡ï¼Œç”¨ä½œåº•å±‚è½¯ä»¶çº¿ç¨‹çš„å¥æŸ„ã€‚æœ‰äº›<code>std::thread</code>å¯¹è±¡è¡¨ç°ä¸º â€œnullâ€ å¥æŸ„ï¼Œè¡¨ç¤ºå…¶æ— è½¯ä»¶çº¿ç¨‹ï¼Œå¯èƒ½çš„åŸå› æœ‰ï¼šå¤„äºé»˜è®¤æ„é€ çŠ¶æ€ï¼ˆæ²¡æœ‰è¦æ‰§è¡Œçš„å‡½æ•°ï¼‰ï¼Œè¢«ç§»åŠ¨äº†ï¼ˆè¢«ç§»åŠ¨çš„ç›®æ ‡å¯¹è±¡æˆä¸ºäº†è¯¥è½¯ä»¶çº¿ç¨‹çš„å¥æŸ„ï¼‰ï¼Œè¢«è”ç»“ï¼ˆjoinï¼‰äº†ï¼ˆå‡½æ•°å·²æ‰§è¡Œç»“æŸï¼‰ï¼Œè¢«åˆ†ç¦»ï¼ˆdetachï¼‰äº†ï¼ˆä¸å…¶è½¯ä»¶çº¿ç¨‹çš„è¿æ¥è¢«åˆ‡æ–­ï¼‰ã€‚</li></ul><p>è½¯ä»¶çº¿ç¨‹å’Œç¡¬ä»¶çº¿ç¨‹éƒ½æ˜¯æœ‰é™çš„ã€‚å¦‚æœä½ è¯•å›¾åˆ›å»ºå¤šäºç³»ç»Ÿèƒ½æä¾›çš„æ•°é‡çš„çº¿ç¨‹ï¼Œå°±ä¼šæŠ›å‡º<code>std::system_error</code>å¼‚å¸¸ï¼Œå³ä½¿å¾…æ‰§è¡Œçš„å‡½æ•°å¸¦æœ‰<code>noexcept</code>é™å®šç¬¦ä¹Ÿä¸€æ ·ã€‚å¦‚æœéé˜»å¡çš„è½¯ä»¶çº¿ç¨‹æ•°é‡è¶…è¿‡äº†ç¡¬ä»¶çº¿ç¨‹æ•°é‡ï¼Œå°±ä¼šäº§ç”Ÿ<strong>èµ„æºè¶…é¢ï¼ˆoversubscriptionï¼‰</strong> é—®é¢˜ï¼Œæ­¤æ—¶çº¿ç¨‹è°ƒåº¦å™¨ä¼šå°†è½¯ä»¶çº¿ç¨‹çš„ CPU æ—¶é—´åˆ‡ç‰‡ï¼Œåˆ†é…åˆ°ç¡¬ä»¶çº¿ç¨‹ä¹‹ä¸Šã€‚å½“ä¸€ä¸ªè½¯ä»¶çº¿ç¨‹çš„æ—¶é—´ç‰‡æ‰§è¡Œç»“æŸï¼Œå°±ä¼šè®©ç»™å¦ä¸€ä¸ªè½¯ä»¶çº¿ç¨‹ï¼Œå¹¶äº§ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ–°çš„è½¯ä»¶çº¿ç¨‹å‡ ä¹ä¸èƒ½å‘½ä¸­ CPU ç¼“å­˜ï¼ŒåŒæ—¶è¿˜ä¼šæ±¡æŸ“ä¸ºæ—§çº¿ç¨‹æ‰€å‡†å¤‡çš„æ•°æ®ï¼ˆæ—§çº¿ç¨‹å¾ˆå¯èƒ½è¿˜ä¼šå†è¢«è°ƒåº¦åˆ°åŒä¸€å†…æ ¸ä¸Šè¿è¡Œï¼‰ï¼Œè¿™ä¼šé€ æˆé«˜æ˜‚çš„çº¿ç¨‹ç®¡ç†å¼€é”€ã€‚</p><blockquote><p>é¿å…èµ„æºè¶…é¢å¾ˆå›°éš¾ï¼Œå› ä¸ºè½¯ä»¶çº¿ç¨‹å’Œç¡¬ä»¶çº¿ç¨‹çš„æœ€ä½³æ¯”ä¾‹å–å†³äºè½¯ä»¶çº¿ç¨‹çš„æ‰§è¡Œé¢‘ç‡ï¼Œé‚£æ˜¯åŠ¨æ€æ”¹å˜çš„ï¼Œä¾‹å¦‚ä¸€ä¸ªç¨‹åºä» IO å¯†é›†å‹å˜æˆè®¡ç®—å¯†é›†å‹ï¼Œä¼šä½¿æ‰§è¡Œé¢‘ç‡å‘ç”Ÿæ”¹å˜ã€‚è€Œä¸”è¯¥æ¯”ä¾‹è¿˜ä¾èµ–äºä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ä»¥åŠè½¯ä»¶çº¿ç¨‹å¯¹äº CPU ç¼“å­˜çš„ä½¿ç”¨æ•ˆç‡ã€‚è®¡ç®—æœºæœ¬èº«çš„æ¶æ„ä¹Ÿä¼šå¯¹å…¶å…·ä½“ç»†èŠ‚äº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚</p></blockquote><p>æ¯”èµ·åŸºäºçº¿ç¨‹ï¼ŒåŸºäºä»»åŠ¡çš„è®¾è®¡èƒ½å¤Ÿå‡è½»æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„è‰°éš¾ï¼Œè€Œä¸”å®ƒæä¾›äº†ä¸€ç§å¾ˆè‡ªç„¶çš„æ–¹å¼ï¼ˆè—‰ç”±<code>get</code>å‡½æ•°ï¼‰ï¼Œè®©ä½ æ£€æŸ¥å¼‚æ­¥æ‰§è¡Œå‡½æ•°çš„ç»“æœï¼ˆå³è¿”å›å€¼æˆ–å¼‚å¸¸ï¼‰ã€‚</p><p>è™½ç„¶è¯´äº†è¿™ä¹ˆå¤šï¼Œä½†ä»æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼Œç›´æ¥ä½¿ç”¨çº¿ç¨‹ä¼šæ›´åˆé€‚ï¼š</p><ul><li><strong>ä½ éœ€è¦è®¿é—®éå¸¸åº•å±‚çš„çº¿ç¨‹ APIã€‚</strong> C++ å¹¶å‘ API é€šå¸¸ä¼šé‡‡ç”¨ç‰¹å®šå¹³å°çš„ä½çº§ API æ¥å®ç°ï¼Œä¾‹å¦‚ pthread å’Œ Windows çº¿ç¨‹åº“ï¼Œå®ƒä»¬æé«˜çš„ API æ¯” C++ æ›´ä¸°å¯Œã€‚ä¸ºäº†è®¿é—®åº•å±‚çš„çº¿ç¨‹ APIï¼Œ<code>std::thread</code>é€šå¸¸ä¼šæä¾›<code>native_handle</code>æˆå‘˜å‡½æ•°ï¼Œè€Œ<code>std::async</code>çš„è¿”å›å€¼<code>std::future</code>åˆ™æ²¡æœ‰è¯¥åŠŸèƒ½ã€‚</li><li><strong>ä½ éœ€è¦ä¸”æœ‰èƒ½åŠ›ä¸ºä½ çš„åº”ç”¨ä¼˜åŒ–çº¿ç¨‹çš„ä½¿ç”¨ã€‚</strong> ä¾‹å¦‚åœ¨å®Œæˆæ€§èƒ½åˆ†æçš„æƒ…å†µä¸‹ä¸ºä¸“ä¸€ç¡¬ä»¶å¹³å°å¼€å‘åº”ç”¨ã€‚</li><li><strong>ä½ éœ€è¦å®ç°å®ç°è¶…è¶Š C++ å¹¶å‘ API çš„çº¿ç¨‹æŠ€æœ¯ã€‚</strong> ä¾‹å¦‚ä¸º C++ æœªæä¾›çº¿ç¨‹æ± çš„å¹³å°å®ç°çº¿ç¨‹æ± ã€‚</li></ul><h3 id="æ¡æ¬¾-36ï¼šå¦‚æœå¼‚æ­¥æ˜¯å¿…è¦çš„ï¼Œåˆ™æŒ‡å®š-std-launch-async">æ¡æ¬¾ 36ï¼šå¦‚æœå¼‚æ­¥æ˜¯å¿…è¦çš„ï¼Œåˆ™æŒ‡å®š std::launch::async</h3><p>åœ¨è°ƒç”¨<code>std::async</code>æ—¶ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å¯åŠ¨ç­–ç•¥å¯ä»¥é€‰æ‹©ï¼š</p><ul><li><code>std::launch::async</code>å¯åŠ¨ç­–ç•¥æ„å‘³ç€å‡½æ•°å¿…é¡»ä»¥å¼‚æ­¥æ–¹å¼åœ¨å¦ä¸€æ¡çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</li><li><code>std::launch::deferred</code>å¯åŠ¨ç­–ç•¥æ„å‘³ç€å‡½æ•°ä¼šè¢«æ¨è¿Ÿåˆ°<code>std::async</code>æ‰€è¿”å›çš„<code>std::future</code>çš„<code>get</code>æˆ–<code>wait</code>å‡½æ•°å¾—åˆ°è°ƒç”¨æ—¶æ‰æ‰§è¡Œï¼ˆè¿™æ˜¯ä¸ªç®€åŒ–è¯´æ³•ï¼Œå…³é”®ç‚¹å…¶å®æ˜¯<code>std::future</code>å¼•ç”¨çš„å…±äº«çŠ¶æ€ï¼Œå‚è€ƒ<strong>æ¡æ¬¾ 38</strong>ï¼‰ã€‚åœ¨é‚£ä¹‹åï¼Œè°ƒç”¨<code>get</code>æˆ–<code>wait</code>çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡ï¼Œç›´è‡³å‡½æ•°æ‰§è¡Œç»“æŸä¸ºæ­¢ã€‚å¦‚æœ<code>get</code>æˆ–<code>wait</code>éƒ½æ²¡å¾—åˆ°è°ƒç”¨ï¼Œåˆ™å‡½æ•°å°†ä¸ä¼šè¢«æ‰§è¡Œã€‚</li></ul><p><code>std::async</code>çš„é»˜è®¤å¯åŠ¨ç­–ç•¥æ—¢å…è®¸ä»»åŠ¡ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œï¼Œä¹Ÿå…è®¸ä»»åŠ¡ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œï¼Œå³ä¸‹é¢ä¸¤ä¸ªè°ƒç”¨æ˜¯ç­‰ä»·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fut1 = std::<span class="built_in">async</span>(f);</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> fut2 = std::<span class="built_in">async</span>(std::launch::async | std::launch::deferred,</span><br><span class="line">                       f);</span><br></pre></td></tr></table></figure><p>è¿™ç§å¼¹æ€§ä½¿å¾—<code>std::async</code>å’Œæ ‡å‡†åº“çš„çº¿ç¨‹ç®¡ç†ç»„ä»¶èƒ½å¤Ÿæ‰¿æ‹…èµ·çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œé¿å…èµ„æºè¶…é¢ï¼Œä»¥åŠè´Ÿè½½å‡è¡¡çš„è´£ä»»ã€‚ä½†ä¹Ÿä¼šå¸¦æ¥ä¸€äº›æ„æ–™ä¹‹å¤–çš„é—®é¢˜ï¼š</p><ul><li>æ— æ³•é¢„çŸ¥<code>f</code>æ˜¯å¦ä¼šä¸è°ƒç”¨<code>std::async</code>çš„çº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œå®ƒä¹Ÿå¯èƒ½ä¼šè¢«æ¨è¿Ÿæ‰§è¡Œã€‚</li><li>æ— æ³•é¢„çŸ¥<code>f</code>æ˜¯å¦ä¼šåœ¨ä¸è°ƒç”¨<code>get</code>å’Œ<code>wait</code>å‡½æ•°çš„çº¿ç¨‹ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</li><li>æ— æ³•é¢„çŸ¥<code>f</code>åœ¨è¯»æˆ–å†™æ­¤<strong>çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆthread-localï¼ŒTLSï¼‰</strong> æ—¶ï¼Œä¼šåœ¨å“ªä¸ªçº¿ç¨‹çš„æœ¬åœ°å­˜å‚¨ä¸Šå®Œæˆæ“ä½œï¼Œè¿™ä¼šå½±å“åˆ°<code>thread_local</code>å˜é‡çš„ä½¿ç”¨ã€‚</li><li>å°±è¿<code>f</code>æ˜¯å¦ä¼šè¢«æ‰§è¡Œè¿™ç§åŸºæœ¬çš„äº‹æƒ…éƒ½æ— æ³•é¢„çŸ¥ã€‚</li></ul><p>å»¶è¿Ÿå¯åŠ¨ç­–ç•¥è¿˜ä¼šå½±å“ä»¥è¶…æ—¶ä¸ºæ¡ä»¶çš„åŸºäº wait çš„å¾ªç¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::literals;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">1</span>s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> fut = std::<span class="built_in">async</span>(f);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (fut.<span class="built_in">wait_for</span>(<span class="number">100</span>ms) != std::future_status::ready) &#123;  <span class="comment">// å¾ªç¯è‡³ f å®Œæˆæ‰§è¡Œ</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// è‹¥ f è¢«æ¨è¿Ÿæ‰§è¡Œï¼Œåˆ™ fut.wait_for è¿”å› std::future_status::deferred</span></span><br><span class="line">    <span class="comment">// å¾ªç¯æ°¸è¿œä¸ä¼šè¢«ç»ˆæ­¢ï¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦ç¡®è®¤ä»»åŠ¡æ˜¯å¦è¢«æ¨è¿Ÿï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ä¸€ä¸ªåŸºäºè¶…æ—¶çš„å‡½æ•°ï¼ˆä¾‹å¦‚<code>wait_for</code>ï¼‰å¹¶æ£€æŸ¥å…¶è¿”å›å€¼æ¥å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fut = std::<span class="built_in">async</span>(f);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fut.<span class="built_in">wait_for</span>(<span class="number">0</span>s) == std::future_status::deferred) &#123; <span class="comment">// å¦‚æœä»»åŠ¡è¢«æ¨è¿Ÿäº†</span></span><br><span class="line">    ... <span class="comment">// è°ƒç”¨ fut çš„ wait æˆ– getï¼Œä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œ f</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;                                                  <span class="comment">// å¦‚æœä»»åŠ¡æœªè¢«æ¨è¿Ÿ</span></span><br><span class="line">    <span class="keyword">while</span> (fut.<span class="built_in">wait_for</span>(<span class="number">100</span>ms) != std::future_status::ready) &#123;</span><br><span class="line">        ... <span class="comment">// ä¸æ–­å»åšå¹¶å‘ä»»åŠ¡ï¼Œç›´è‡³ f å®Œæˆæ‰§è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    ... <span class="comment">// fut å·²ç»å°±ç»ª</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå¦‚æœéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>std::async</code>çš„é»˜è®¤å¯åŠ¨ç­–ç•¥ï¼š</p><ol><li>ä»»åŠ¡ä¸éœ€è¦ä¸è°ƒç”¨<code>get</code>æˆ–<code>wait</code>çš„çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚</li><li>è¯»æˆ–å†™å“ªä¸ªçº¿ç¨‹çš„<code>thread_local</code>å˜é‡å¹¶æ— å½±å“ã€‚</li><li>ä¿è¯åœ¨<code>std::async</code>è¿”å›çš„<code>std::future</code>å¯¹è±¡ä¸Šè°ƒç”¨<code>get</code>æˆ–<code>wait</code>ï¼Œæˆ–è€…å¯ä»¥æ¥å—ä»»åŠ¡å¯èƒ½æ°¸ä¸æ‰§è¡Œã€‚</li><li>ä½¿ç”¨<code>wait_for</code>æˆ–<code>wait_until</code>çš„ä»£ç ä¼šè€ƒè™‘åˆ°ä»»åŠ¡è¢«æ¨è¿Ÿçš„å¯èƒ½æ€§ã€‚</li></ol><p>å¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œå°±éœ€è¦ç¡®ä¿ä»»åŠ¡ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fut = std::<span class="built_in">async</span>(std::launch::async, f);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç¼–å†™ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥è‡ªåŠ¨æ‰§è¡Œ<code>std::async</code>çš„å¼‚æ­¥å¯åŠ¨ç­–ç•¥ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Ts&gt;</span><br><span class="line"><span class="keyword">inline</span> std::future&lt;<span class="keyword">typename</span> std::result_of&lt;<span class="built_in">F</span>(Ts...)&gt;::type&gt; <span class="comment">// C++14 å¯ä»¥ç›´æ¥ç”¨ auto æ¨å¯¼è¿”å›å€¼ç±»å‹</span></span><br><span class="line"><span class="built_in">reallyAsync</span>(F&amp;&amp; f, Ts&amp;&amp;... params) &#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">async</span>(std::launch::async,</span><br><span class="line">                      std::forward&lt;F&gt;(f),</span><br><span class="line">                      std::forward&lt;Ts&gt;(params)...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç”¨äºè·å–å¯è°ƒç”¨å¯¹è±¡è¿”å›å€¼ç±»å‹çš„<code>std::result_of</code>åœ¨ C++17 åè¢«å¼ƒç”¨ï¼Œå…¶æ›¿ä»£å“ä¸º<code>std::invoke_result</code>ã€‚</p></blockquote><h3 id="æ¡æ¬¾-37ï¼šä½¿-std-thread-å¯¹è±¡åœ¨æ‰€æœ‰è·¯å¾„çš†ä¸å¯è”ç»“">æ¡æ¬¾ 37ï¼šä½¿ std::thread å¯¹è±¡åœ¨æ‰€æœ‰è·¯å¾„çš†ä¸å¯è”ç»“</h3><p>å½“<code>std::thread</code>å¤„äºå¯è”ç»“çš„çŠ¶æ€æ—¶ï¼Œå®ƒå¯¹åº”äºæ­£åœ¨è¿è¡Œæˆ–å¯èƒ½å°†è¦è¿è¡Œçš„åº•å±‚æ‰§è¡Œçº¿ç¨‹ï¼Œè¿™åŒ…æ‹¬æ­£åœ¨ç­‰å¾…è°ƒåº¦çš„æˆ–è€…è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œä»¥åŠè¿è¡Œç»“æŸçš„çº¿ç¨‹ã€‚</p><p>ä»¥ä¸‹å‡ ç§<code>std::thread</code>å¯¹è±¡å¤„äºä¸å¯è”ç»“çš„çŠ¶æ€ï¼š</p><ul><li>é»˜è®¤æ„é€ çš„<code>std::thread</code>ã€‚</li><li>å·²ç§»åŠ¨çš„<code>std::thread</code>ã€‚</li><li>å·²è”ç»“ï¼ˆjoinï¼‰çš„<code>std::thread</code>ã€‚</li><li>å·²åˆ†ç¦»ï¼ˆdetachï¼‰çš„<code>std::thread</code>ã€‚</li></ul><p>å½“<code>std::thread</code>æ‰§è¡Œææ„æ—¶ï¼Œè‹¥å…¶å¤„äºå¯è”ç»“çŠ¶æ€ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºç»ˆæ­¢è¿è¡Œï¼ˆé€šå¸¸ä¼šè°ƒç”¨<code>std::abort</code>ï¼‰ã€‚è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> tenMillion = <span class="number">10&#x27;000&#x27;000</span>;             <span class="comment">// C++14 çš„å•å¼•å·æ•°å­—åˆ†éš”ç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">doWork</span><span class="params">(std::function&lt;<span class="type">bool</span>(<span class="type">int</span>)&gt; filter, <span class="type">int</span> maxVal = tenMillion)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; goodVals;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">([&amp;filter, maxVal, &amp;goodVals] &#123;    <span class="comment">// éå† goodVals</span></span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt;= maxVal; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">                      &#123; <span class="keyword">if</span> (filter(i)) goodVals.push_back(i); &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                  &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> nh = t.<span class="built_in">native_handle</span>();                    <span class="comment">// ä½¿ç”¨ t çš„åŸç”Ÿå¥æŸ„æ¥è®¾å®šçº¿ç¨‹çš„ä¼˜å…ˆçº§</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">conditionAreSatisfied</span>()) &#123;</span><br><span class="line">        t.<span class="built_in">join</span>();                                   <span class="comment">// è®© t ç»“æŸè¿è¡Œ</span></span><br><span class="line">        <span class="built_in">performComputation</span>(goodVals);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;                                <span class="comment">// è®¡ç®—å·²å®æ–½</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;                                   <span class="comment">// è®¡ç®—æœªå®æ–½</span></span><br><span class="line">&#125;                                                   <span class="comment">// æ­¤å¤„ææ„ std::thread ä¼šå¯¼è‡´ç¨‹åºç»ˆæ­¢</span></span><br></pre></td></tr></table></figure><p>æ ‡å‡†å§”å‘˜ä¼šå¹¶æ²¡æœ‰é€‰æ‹©è®©<code>std::thread</code>åœ¨é”€æ¯æ—¶ï¼Œéšå¼æ‰§è¡Œ<code>join</code>æˆ–<code>detach</code>ï¼Œå› ä¸ºè¿™å¸¦æ¥çš„é—®é¢˜ä¼šæ¯”ç›´æ¥è®©ç¨‹åºç»ˆæ­¢è¿è¡Œè¿˜è¦ä¸¥é‡ï¼š</p><ul><li><strong>éšå¼<code>join</code></strong> ä¼šä½¿<code>std::thread</code>çš„ææ„å‡½æ•°ç­‰å¾…åº•å±‚å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚è¿™å¬ä¸Šå»å¾ˆåˆç†ï¼Œä½†å´å¯èƒ½å¯¼è‡´éš¾ä»¥è¿½è¸ªçš„æ€§èƒ½å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œå³ä½¿<code>conditionAreSatisfied</code>å·²ç»è¿”å›<code>false</code>äº†ï¼Œ<code>doWork</code>ä»ç„¶ä¼šç»§ç»­æ‰§è¡Œéå†æ“ä½œï¼Œè¿™æ˜¯è¿åç›´è§‰çš„ã€‚</li><li><strong>éšå¼<code>detach</code></strong> ä¼šä½¿<code>std::thread</code>çš„ææ„å‡½æ•°åˆ†ç¦»<code>std::thread</code>å¯¹è±¡å’Œåº•å±‚æ‰§è¡Œçº¿ç¨‹ä¹‹é—´çš„è¿æ¥ï¼Œè€Œè¯¥åº•å±‚æ‰§è¡Œçº¿ç¨‹ä¼šç»§ç»­è¿è¡Œã€‚è¿™ä¼šå¯¼è‡´æ›´è¦å‘½çš„è°ƒè¯•é—®é¢˜ã€‚å‡å¦‚<code>conditionAreSatisfied</code>è¿”å›äº†<code>false</code>ï¼Œåˆ™<code>doWork</code>ä¹Ÿä¼šç›´æ¥è¿”å›ï¼ŒåŒæ—¶é”€æ¯å±€éƒ¨å˜é‡å¹¶å¼¹å‡ºæ ˆå¸§ã€‚ä½†çº¿ç¨‹ä»ç„¶åœ¨<code>doWork</code>çš„è°ƒç”¨ç‚¹ç»§ç»­è¿è¡Œï¼Œå¹¶å¯¼è‡´æ ˆå¸§ä¸Šçš„å†…å­˜è¢«æ„å¤–ä¿®æ”¹ï¼Œ</li></ul><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª RAII ç±»ï¼Œå¹¶è®©è°ƒç”¨è€…è‡ªè¡Œé€‰æ‹©åœ¨é”€æ¯æ—¶ä¸º<code>std::thread</code>è°ƒç”¨<code>join</code>è¿˜æ˜¯<code>detach</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadRAII</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum class</span> <span class="title class_">DtorAction</span> &#123; join, detach &#125;;     <span class="comment">// å…³äºæšä¸¾ç±»ï¼Œå‚è€ƒæ¡æ¬¾ 20</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">ThreadRAII</span>(std::thread&amp;&amp; t, DtorAction a)   <span class="comment">// å¯¹ t æ‰§è¡Œæ“ä½œ a</span></span><br><span class="line">        : <span class="built_in">action</span>(action), <span class="built_in">t</span>(std::<span class="built_in">move</span>(t)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ThreadRAII</span>() &#123;</span><br><span class="line">        <span class="comment">// å…ˆæ ¡éªŒ t æ˜¯å¦å¤„äºå¯è”ç»“çŠ¶æ€</span></span><br><span class="line">        <span class="comment">// å¯¹ä¸å¯è”ç»“çš„ std::thread è°ƒç”¨ join æˆ– detach æ˜¯æœªå®šä¹‰è¡Œä¸º</span></span><br><span class="line">        <span class="keyword">if</span> (t.<span class="built_in">joinable</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (action == DtorAction::join) &#123;</span><br><span class="line">                t.<span class="built_in">join</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                t.<span class="built_in">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ThreadRAII</span>(ThreadRAII&amp;&amp;) = <span class="keyword">default</span>;         <span class="comment">// æ”¯æŒç§»åŠ¨æ“ä½œ</span></span><br><span class="line">    ThreadRAII&amp; <span class="keyword">operator</span>=(ThreadRAII&amp;&amp;) = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread&amp; <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> t; &#125;            <span class="comment">// è¿”å›åº•å±‚çš„ std::thread å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    DtorAction action;</span><br><span class="line">    std::thread t;                              <span class="comment">// ä½¿ t æœ€åè¢«åˆå§‹åŒ–ï¼Œç¡®ä¿å®ƒå¯ä»¥å®‰å…¨è®¿é—®å…¶å®ƒæˆå‘˜</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸éœ€è¦æ‹…å¿ƒåœ¨<code>t.joinable()</code>çš„æ‰§è¡Œå’Œ<code>join</code>æˆ–<code>detach</code>çš„è°ƒç”¨ä¹‹é—´ï¼Œæœ‰å¦ä¸€ä¸ªçº¿ç¨‹ä¼šè®©<code>t</code>å˜å¾—ä¸å¯è”ç»“ã€‚å› ä¸º<code>std::thread</code>å¯¹è±¡åªèƒ½é€šè¿‡è°ƒç”¨æˆå‘˜å‡½æ•°æ¥ä»å¯è”ç»“çŠ¶æ€è½¬æ¢ä¸ºä¸å¯è”ç»“çŠ¶æ€ï¼Œè€Œå½“<code>ThreadRAII</code>å¯¹è±¡çš„ææ„å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œä¸åº”è¯¥æœ‰å…¶å®ƒçº¿ç¨‹è°ƒç”¨è¯¥å¯¹è±¡çš„æˆå‘˜å‡½æ•°ã€‚ä¸€èˆ¬åœ°ï¼Œè‹¥è¦åœ¨ä¸€ä¸ªå¯¹è±¡ä¸ŠåŒæ—¶è°ƒç”¨ä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼Œåªæœ‰å½“æ‰€æœ‰è¿™äº›å‡½æ•°éƒ½å¸¦æœ‰<code>const</code>é™å®šç¬¦æ—¶æ‰å®‰å…¨ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 16</strong>ï¼‰ã€‚</p></blockquote><p>åœ¨<code>doWork</code>å‡½æ•°çš„ä»£ç ä¸­ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨<code>ThreadRAII</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">doWork</span><span class="params">(std::function&lt;<span class="type">bool</span>(<span class="type">int</span>)&gt; filter, <span class="type">int</span> maxVal = tenMillion)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; goodVals;</span><br><span class="line"></span><br><span class="line">    <span class="function">ThreadRAII <span class="title">t</span><span class="params">(std::thread([&amp;filter, maxVal, &amp;goodVals] &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt;= maxVal; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">                                 &#123; <span class="keyword">if</span> (filter(i)) goodVals.push_back(i); &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                             &#125;),</span></span></span><br><span class="line"><span class="params"><span class="function">                 ThreadRAII::DtorAction::join)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> nh = t.<span class="built_in">get</span>().<span class="built_in">native_handle</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">conditionAreSatisfied</span>()) &#123;</span><br><span class="line">        t.<span class="built_in">get</span>().<span class="built_in">join</span>();</span><br><span class="line">        <span class="built_in">performComputation</span>(goodVals);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-38ï¼šæ³¨æ„ä¸åŒçº¿ç¨‹å¥æŸ„çš„ææ„è¡Œä¸º">æ¡æ¬¾ 38ï¼šæ³¨æ„ä¸åŒçº¿ç¨‹å¥æŸ„çš„ææ„è¡Œä¸º</h3><p>future ä½äºé€šä¿¡ä¿¡é“çš„ä¸€ç«¯ï¼Œè¢«è°ƒç”¨è€…é€šè¿‡è¯¥ä¿¡é“å°†ç»“æœå‘é€ç»™è°ƒç”¨è€…ã€‚è¢«è°ƒç”¨è€…ï¼ˆé€šå¸¸ä»¥å¼‚æ­¥æ–¹å¼è¿è¡Œï¼‰å°†å…¶è®¡ç®—æ‰€å¾—çš„ç»“æœå†™å…¥ä¿¡é“ï¼ˆé€šå¸¸ç»è¿‡<code>std::promise</code>å¯¹è±¡ï¼‰ï¼Œè€Œè°ƒç”¨è€…åˆ™ä½¿ç”¨ future æ¥è¯»å–è¯¥ç»“æœã€‚</p><p>ä½†è¢«è°ƒç”¨è€…çš„ç»“æœè¦å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿæ—¢ä¸èƒ½å­˜å‚¨åœ¨è¢«è°ƒç”¨è€…çš„<code>std::promise</code>å¯¹è±¡ä¸­ï¼Œå› ä¸ºå®ƒæ˜¯ä¸ªå±€éƒ¨å¯¹è±¡ï¼Œåœ¨è¢«è°ƒç”¨è€…æ‰§è¡Œç»“æŸåä¼šè¢«é”€æ¯ï¼›ä¹Ÿä¸èƒ½å­˜å‚¨åœ¨è°ƒç”¨è€…çš„ future ä¸­ï¼Œå› ä¸º<code>std::future</code>å¯èƒ½ä¼šè¢«ç”¨æ¥åˆ›å»º<code>std::shared_future</code>ï¼Œè€Œåè€…ä¼šå¯¼è‡´åŸå§‹<code>std::future</code>ææ„ä¹‹åè¢«å¤šæ¬¡æ‹·è´ï¼Œä½†è¢«è°ƒç”¨è€…çš„ç»“æœå¹¶ä¸èƒ½ä¿è¯ä¸€å®šå¯ä»¥è¢«æ‹·è´ï¼Œå¾ˆéš¾åšåˆ°ä½¿å®ƒä¸æœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„ future ç”Ÿå‘½å‘¨æœŸä¸€æ ·é•¿ã€‚</p><p>å› æ­¤è¯¥ç»“æœä¼šè¢«å­˜å‚¨åœ¨ä½äºä¸¤è€…å¤–éƒ¨çš„æŸä¸ªä½ç½®ï¼Œè¿™ä¸ªä½ç½®ç§°ä¸º<strong>å…±äº«çŠ¶æ€ï¼ˆshared stateï¼‰</strong>ï¼Œé€šå¸¸ç”¨å †ä¸Šçš„å¯¹è±¡æ¥è¡¨ç¤ºï¼Œä½†æ˜¯å…¶ç±»å‹ã€æ¥å£å’Œå®ç°çš†æœªåœ¨æ ‡å‡†ä¸­æŒ‡å®šã€‚æˆ‘ä»¬å¯ä»¥æŠŠè°ƒç”¨è€…ï¼Œè¢«è°ƒç”¨è€…ä»¥åŠå…±äº«çŠ¶æ€ä¹‹é—´çš„å…³ç³»ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š</p><p><img src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/2.png" alt=""></p><p>å…±äº«çŠ¶æ€çš„å­˜åœ¨éå¸¸é‡è¦ï¼Œå› ä¸º future å¯¹è±¡çš„ææ„è¡Œä¸ºå–å†³äºä¸å…¶å…³è”çš„å…±äº«çŠ¶æ€ã€‚å…·ä½“æ¥è¯´å°±æ˜¯ï¼š</p><ul><li>å¸¸è§„çš„ future å¯¹è±¡åœ¨ææ„æ—¶ä»…ä¼šææ„è¯¥ future çš„æˆå‘˜å˜é‡ã€‚è¿™ç›¸å½“äºå¯¹åº•å±‚æ‰§è¡Œçº¿ç¨‹æ‰§è¡Œäº†éšå¼<code>detach</code>ã€‚</li><li>å¼•ç”¨äº†å…±äº«çŠ¶æ€ï¼ˆä½¿ç”¨<code>std::async</code>å¯åŠ¨æœªå»¶è¿Ÿä»»åŠ¡æ—¶åˆ›å»ºçš„ï¼‰çš„æœ€åä¸€ä¸ª future å¯¹è±¡çš„ææ„å‡½æ•°å°†ä¼šè¢«é˜»å¡ä½ï¼Œç›´è‡³è¯¥ä»»åŠ¡ç»“æŸã€‚è¿™ç›¸å½“äºå¯¹æ­£åœ¨è¿è¡Œ<code>std::async</code>æ‰€åˆ›å»ºä»»åŠ¡çš„çº¿ç¨‹æ‰§è¡Œäº†éšå¼<code>join</code>ã€‚</li></ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰åœ¨æ»¡è¶³ä¸‹åˆ—æ¡ä»¶æ—¶ï¼Œfuture çš„éå¸¸è§„ææ„è¡Œä¸ºæ‰ä¼šè¢«è§¦å‘ï¼š</p><ol><li>future æ‰€å¼•ç”¨çš„å…±äº«çŠ¶æ€æ˜¯åœ¨è°ƒç”¨<code>std::async</code>æ—¶åˆ›å»ºçš„ï¼›</li><li>è¯¥ä»»åŠ¡æ‰§è¡Œå¼‚æ­¥å¯åŠ¨ç­–ç•¥ï¼Œå³<code>std::launch::async</code>ï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 36</strong>ï¼‰ï¼›</li><li>è¯¥ future æ˜¯æœ€åä¸€ä¸ªå¼•ç”¨äº†è¯¥å…±äº«çŠ¶æ€çš„ futureã€‚</li></ol><p>future çš„ API æ²¡æœ‰æä¾›ä»»ä½•åŠæ³•åˆ¤æ–­å®ƒå¼•ç”¨çš„å…±äº«çŠ¶æ€æ˜¯å¦è¯ç”Ÿäº<code>std::async</code>çš„è°ƒç”¨ï¼Œå› æ­¤ä»»æ„ç»™å®šä¸€ä¸ª future å¯¹è±¡ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•åˆ¤æ–­å®ƒæ˜¯å¦ä¼šåœ¨ææ„å‡½æ•°ä¸­é˜»å¡ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ„å¤–çš„æƒ…å†µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯¥å®¹å™¨çš„ææ„å‡½æ•°å¯èƒ½ä¼šå‘ç”Ÿé˜»å¡</span></span><br><span class="line"><span class="comment">// å› ä¸ºå®ƒæŒæœ‰ future å¯èƒ½ä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ª</span></span><br><span class="line"><span class="comment">// æ»¡è¶³è§¦å‘éå¸¸è§„ææ„è¡Œä¸ºçš„æ¡ä»¶</span></span><br><span class="line">std::vector&lt;std::future&lt;<span class="type">void</span>&gt;&gt; futs;    <span class="comment">// å…³äº std::future&lt;void&gt;ï¼Œå‚è€ƒæ¡æ¬¾ 39</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;                          <span class="comment">// Widget å¯¹è±¡çš„ææ„å‡½æ•°å¯èƒ½ä¼šå‘ç”Ÿé˜»å¡</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_future&lt;<span class="type">double</span>&gt; fut;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>std::packaged_task</code>ä¹Ÿèƒ½åˆ›å»ºå‡ºå…±äº«å¯¹è±¡ï¼Œä½†æ˜¯å…¶è¡ç”Ÿçš„ future éƒ½ä¼šæ‰§è¡Œå¸¸è§„çš„ææ„è¡Œä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">calcValue</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    std::packaged_task&lt;<span class="built_in">int</span>()&gt;       <span class="comment">// ç»™ calcValue åŠ ä¸ŠåŒ…è£…</span></span><br><span class="line">    <span class="built_in">pt</span>(calcValue);                  <span class="comment">// ä½¿ä¹‹èƒ½ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> fut = pt.<span class="built_in">get_future</span>();     <span class="comment">// å–å¾— pt çš„ future</span></span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(std::move(pt))</span></span>;   <span class="comment">// std::packaged_task æ˜¯åªç§»ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    ...                             <span class="comment">// ææ„ std::threadï¼ˆå‚è€ƒæ¡æ¬¾ 37ï¼‰</span></span><br><span class="line">&#125;                                   <span class="comment">// ä»¥å¸¸è§„æ–¹å¼ææ„ future å¯¹è±¡ fut</span></span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-39ï¼šè€ƒè™‘å¯¹ä¸€æ¬¡æ€§äº‹ä»¶é€šä¿¡ä½¿ç”¨-void-çš„-futures">æ¡æ¬¾ 39ï¼šè€ƒè™‘å¯¹ä¸€æ¬¡æ€§äº‹ä»¶é€šä¿¡ä½¿ç”¨ void çš„ futures</h3><p>æœ‰çš„æ—¶å€™ï¼Œè®©ä¸€ä¸ªä»»åŠ¡èƒ½å¤Ÿåœ¨å‘ç”Ÿäº†ç‰¹å®šäº‹ä»¶åï¼Œé€šçŸ¥å¦ä¸€ä¸ªå¼‚æ­¥è¿è¡Œçš„ä»»åŠ¡ï¼Œä¼šæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ä¸ºäº†å®ç°è¿™ç§ç®€å•çš„äº‹ä»¶é€šä¿¡ï¼Œä½¿ç”¨æ¡ä»¶å˜é‡ä¼šæ˜¯ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„åšæ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">std::condition_variable cv;             <span class="comment">// äº‹ä»¶çš„æ¡ä»¶å˜é‡</span></span><br><span class="line">std::mutex m;                           <span class="comment">// é…åˆ cv ä½¿ç”¨çš„äº’æ–¥é‡</span></span><br><span class="line"></span><br><span class="line">...                                     <span class="comment">// æ£€æµ‹äº‹ä»¶</span></span><br><span class="line">cv.<span class="built_in">notify_one</span>();                        <span class="comment">// é€šçŸ¥ååº”ä»»åŠ¡ï¼Œå¯¹å¤šä¸ªä»»åŠ¡ä½¿ç”¨ notify_all</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ååº”ä»»åŠ¡çš„ä»£ç </span></span><br><span class="line">...                                     <span class="comment">// å‡†å¤‡ä½œå‡ºååº”</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(m)</span></span>; <span class="comment">// ä¸ºäº’æ–¥é‡åŠ é”</span></span><br><span class="line"></span><br><span class="line">    cv.<span class="built_in">wait</span>(lk);                        <span class="comment">// ç­‰å¾…é€šçŸ¥åˆ°æ¥</span></span><br><span class="line">    ...                                 <span class="comment">// é’ˆå¯¹äº‹ä»¶ä½œå‡ºååº”</span></span><br><span class="line">&#125;                                       <span class="comment">// é€šè¿‡ lk çš„ææ„å‡½æ•°ä¸º m è§£é”</span></span><br><span class="line">...                                     <span class="comment">// ç»§ç»­ç­‰å¾…ååº”</span></span><br></pre></td></tr></table></figure><p>è¿™ç§é€”å¾„ä¼šå¯¼è‡´ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li><strong>ä»£ç å¼‚å‘³ï¼ˆcode smellï¼‰ï¼š</strong> è™½ç„¶ä»£ç èƒ½å¤Ÿè¿è¡Œï¼Œä½†æ€»æ„Ÿè§‰å“ªé‡Œä¸å¤ªå¯¹åŠ²ã€‚æ­¤å¤„å¯¹äº’æ–¥é‡çš„ä½¿ç”¨ä¼¼ä¹æœ‰äº›å¤šä½™ï¼Œäº’æ–¥é‡æ˜¯ç”¨äºæ§åˆ¶å…±äº«æ•°æ®è®¿é—®çš„ï¼Œä½†æ£€æµ‹å’Œååº”ä»»åŠ¡ä¹‹é—´å¤§å¯ä»¥æ ¹æœ¬ä¸éœ€è¦è¿™ç§ä»‹è´¨ã€‚</li><li>å¦‚æœæ£€æµ‹ä»»åŠ¡åœ¨ååº”ä»»åŠ¡è°ƒç”¨<code>wait</code>ä¹‹å‰å°±é€šçŸ¥äº†æ¡ä»¶å˜é‡ï¼Œåˆ™ååº”ä»»åŠ¡å°†ä¼šå¤±å»å“åº”ã€‚</li><li>ååº”ä»»åŠ¡çš„<code>wait</code>è¯­å¥æ— æ³•åº”å¯¹<strong>è™šå‡å”¤é†’ï¼ˆspurious wakeupsï¼‰</strong>ï¼Œå³ä½¿æ¡ä»¶å˜é‡æ²¡æœ‰å¾—åˆ°é€šçŸ¥ï¼Œé’ˆå¯¹è¯¥æ¡ä»¶å˜é‡ç­‰å¾…çš„ä»£ç ä¹Ÿæœ‰å¯èƒ½è¢«å”¤é†’ã€‚å¦‚æœååº”çº¿ç¨‹å¯ä»¥ç¡®è®¤å®ƒæ‰€ç­‰å¾…çš„äº‹ä»¶æ˜¯å¦å·²ç»å‘ç”Ÿï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡å°† lambda ä¼ é€’ç»™<code>wait</code>æ¥å¤„ç†è¿™ç§æƒ…å†µï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv.<span class="built_in">wait</span>(lk, [] &#123; <span class="keyword">return</span> äº‹ä»¶æ˜¯å¦çœŸçš„å·²ç»å‘ç”Ÿ; &#125;);</span><br></pre></td></tr></table></figure><p>åŸºäº flag çš„è®¾è®¡å¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼Œä½†è¿™ä¸€è®¾è®¡åŸºäºè½®è¯¢è€Œéé˜»å¡ï¼Œä¼šå¯¹ CPU æ ¸å¿ƒäº§ç”Ÿé¢å¤–çš„æ€§èƒ½æ¶ˆè€—ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::atomic&lt;<span class="type">bool</span>&gt; <span class="title">flag</span><span class="params">(<span class="literal">false</span>)</span></span>;  <span class="comment">// å…±äº«çš„ bool flag</span></span><br><span class="line">                                <span class="comment">// å…³äº std::atomicï¼Œå‚è€ƒæ¡æ¬¾ 40</span></span><br><span class="line">...                             <span class="comment">// æ£€æµ‹äº‹ä»¶</span></span><br><span class="line">flag = <span class="literal">true</span>;                    <span class="comment">// é€šçŸ¥ååº”ä»»åŠ¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ååº”ä»»åŠ¡çš„ä»£ç </span></span><br><span class="line">...                             <span class="comment">// å‡†å¤‡ä½œå‡ºååº”</span></span><br><span class="line"><span class="keyword">while</span> (!flag);                  <span class="comment">// ç­‰å¾…äº‹ä»¶</span></span><br><span class="line">...                             <span class="comment">// é’ˆå¯¹äº‹ä»¶ä½œå‡ºååº”</span></span><br></pre></td></tr></table></figure><p>æ¡ä»¶å˜é‡å¯ä»¥å’Œ flag ä¸€èµ·ä½¿ç”¨ï¼Œä½†è¿™æ ·çš„é€šä¿¡æœºåˆ¶è®¾è®¡çœ‹èµ·æ¥ä¸å¤ªè‡ªç„¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">std::condition_variable cv;                 <span class="comment">// åŒå‰</span></span><br><span class="line">std::mutex m;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">flag</span><span class="params">(<span class="literal">false</span>)</span></span>;                           <span class="comment">// é std::atomic å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">...                                         <span class="comment">// æ£€æµ‹äº‹ä»¶</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">g</span><span class="params">(m)</span></span>;       <span class="comment">// ä¸º m åŠ é”</span></span><br><span class="line">    flag = <span class="literal">true</span>;                            <span class="comment">// é€šçŸ¥ååº”ä»»åŠ¡ï¼ˆç¬¬ä¸€éƒ¨åˆ†ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line">cv.<span class="built_in">notify_one</span>();                            <span class="comment">// é€šçŸ¥ååº”ä»»åŠ¡ï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ååº”ä»»åŠ¡çš„ä»£ç </span></span><br><span class="line">...                                         <span class="comment">// å‡†å¤‡ä½œå‡ºååº”</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(m)</span></span>;     <span class="comment">// åŒå‰</span></span><br><span class="line"></span><br><span class="line">    cv.<span class="built_in">wait</span>(lk, [&amp;flag] &#123; <span class="keyword">return</span> flag; &#125;);  <span class="comment">// ä½¿ç”¨ lambda åº”å¯¹è™šå‡å”¤é†’</span></span><br><span class="line">    ...                                     <span class="comment">// é’ˆå¯¹äº‹ä»¶ä½œå‡ºååº”</span></span><br><span class="line">&#125;</span><br><span class="line">...                                         <span class="comment">// ç»§ç»­ç­‰å¾…ååº”</span></span><br></pre></td></tr></table></figure><p>å¦å¤–ä¸€ç§æ–¹æ³•æ˜¯æ‘†è„±æ¡ä»¶å˜é‡ï¼Œäº’æ–¥é‡å’Œ flagï¼Œè®©ååº”ä»»åŠ¡å»ç­‰å¾…æ£€æµ‹ä»»åŠ¡è®¾ç½®çš„ futureã€‚è¿™ç§è®¾è®¡ç®€å•æ˜“è¡Œï¼Œæ£€æµ‹ä»»åŠ¡æœ‰ä¸€ä¸ª<code>std::promise</code>å¯¹è±¡ï¼Œååº”ä»»åŠ¡æœ‰å¯¹åº”çš„ futureã€‚å½“æ£€æµ‹ä»»åŠ¡å‘ç°å®ƒæŸ¥æ‰¾çš„äº‹ä»¶å·²ç»å‘ç”Ÿæ—¶ï¼Œå®ƒä¼šè®¾ç½®<code>std::promise</code>å¯¹è±¡ï¼›ä¸æ­¤åŒæ—¶ï¼Œååº”ä»»åŠ¡è°ƒç”¨<code>wait</code>ä»¥ç­‰å¾…å®ƒçš„ futureã€‚ç”±äºåœ¨æ­¤å¤„æˆ‘ä»¬å¹¶ä¸ä¼šçœŸæ­£å‘ä¿¡é“å‘é€ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥å¯¹äº<code>std::promise</code>ã€<code>std::future</code>å’Œ<code>std::shared_future</code>çš„æ¨¡æ¿ç±»å‹å½¢å‚ï¼Œéƒ½åªéœ€ä½¿ç”¨<code>void</code>å³å¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">std::promise&lt;<span class="type">void</span>&gt; p;</span><br><span class="line"></span><br><span class="line">...                     <span class="comment">// æ£€æµ‹äº‹ä»¶</span></span><br><span class="line">p.<span class="built_in">set_value</span>();          <span class="comment">// é€šçŸ¥ååº”ä»»åŠ¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ååº”ä»»åŠ¡çš„ä»£ç </span></span><br><span class="line">...                     <span class="comment">// å‡†å¤‡ä½œå‡ºååº”</span></span><br><span class="line">p.<span class="built_in">get_future</span>().<span class="built_in">wait</span>();  <span class="comment">// ç­‰å¾… p å¯¹åº”çš„ future</span></span><br><span class="line">...                     <span class="comment">// é’ˆå¯¹äº‹ä»¶ä½œå‡ºååº”</span></span><br></pre></td></tr></table></figure><p>è¿™ç§æ‰‹æ³•æœ‰ä¸¤ä¸ªæœ€å¤§çš„å±€é™æ€§ï¼š</p><ul><li><code>std::promise</code>å’Œ future ä¹‹é—´ä¾èµ–å…±äº«çŠ¶æ€ï¼Œè€Œå…±äº«çŠ¶æ€ä¼šå¸¦æ¥åœ¨å †ä¸Šåˆ†é…å’Œå›æ”¶ç©ºé—´çš„æˆæœ¬ã€‚</li><li><code>std::promise</code>å¯¹è±¡åªèƒ½è®¾ç½®ä¸€æ¬¡ï¼Œè¿™æ„å‘³ç€è¯¥æ‰‹æ³•åªèƒ½åº”ç”¨äºä¸€æ¬¡æ€§é€šä¿¡çš„æƒ…å†µã€‚</li></ul><p>å‡å¦‚ä½ æƒ³åˆ›å»ºå¤šä¸ªèƒ½æš‚åœä¸€æ¬¡çš„çº¿ç¨‹ï¼Œä½¿ç”¨<code>void</code> future æ‰‹æ³•å°±æ˜¯åˆç†çš„é€‰æ‹©ã€‚ä»£ç æ¼”ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">std::promise&lt;<span class="type">void</span>&gt; p;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">detect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> sf = p.<span class="built_in">get_future</span>().<span class="built_in">share</span>();                   <span class="comment">// sf çš„ç±»å‹æ˜¯ std::shared_future&lt;void&gt;</span></span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::thread&gt; vt;                        <span class="comment">// ååº”ä»»åŠ¡çš„å®¹å™¨</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; threadsToRun; ++i) &#123;</span><br><span class="line">        vt.<span class="built_in">emplace_back</span>([sf] &#123; sf.<span class="built_in">wait</span>(); <span class="built_in">react</span>(); &#125;);  <span class="comment">// sf å±€éƒ¨å‰¯æœ¬ä¹‹ä¸Šçš„ wait</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...                                                 <span class="comment">// è‹¥åœ¨æ­¤å¤„æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ detect ä¼šå¤±å»å“åº”ï¼</span></span><br><span class="line"></span><br><span class="line">    p.<span class="built_in">set_value</span>();                                      <span class="comment">// è®©æ‰€æœ‰çº¿ç¨‹å–æ¶ˆæš‚åœ</span></span><br><span class="line"></span><br><span class="line">    ...                                                 <span class="comment">// å®Œæˆå…¶å®ƒå·¥ä½œ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : vt) &#123;                                <span class="comment">// æŠŠæ‰€æœ‰çº¿ç¨‹è®¾ä¸ºä¸å¯è”ç»“çš„çŠ¶æ€</span></span><br><span class="line">        t.<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-40ï¼šå¯¹å¹¶å‘ä½¿ç”¨-std-atomicï¼Œå¯¹ç‰¹æ®Šå†…å­˜ä½¿ç”¨-volatile">æ¡æ¬¾ 40ï¼šå¯¹å¹¶å‘ä½¿ç”¨ std::atomicï¼Œå¯¹ç‰¹æ®Šå†…å­˜ä½¿ç”¨ volatile</h3><p><code>std::atomic</code>å¯ä»¥ä¿è¯å®ƒæä¾›çš„æ“ä½œè¢«å…¶å®ƒçº¿ç¨‹è§†ä¸ºå…·æœ‰åŸå­æ€§ï¼Œå®ƒäº§ç”Ÿçš„æ•ˆæœå’Œå—åˆ°äº’æ–¥é”ä¿æŠ¤çš„æ“ä½œç±»ä¼¼ï¼Œä½†æ˜¯é€šå¸¸<code>std::atomic</code>çš„åŸå­æ“ä½œæ˜¯é€šè¿‡ç‰¹å®šçš„æœºå™¨æŒ‡ä»¤å®ç°çš„ï¼Œè¿™æ¯”é”çš„å®ç°æ›´é«˜æ•ˆã€‚è€ƒè™‘ä»¥ä¸‹åº”ç”¨äº†<code>std::atomic</code>çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">ai</span><span class="params">(<span class="number">0</span>)</span></span>; <span class="comment">// å°† ai åˆå§‹åŒ–ä¸º 0</span></span><br><span class="line">ai = <span class="number">10</span>;                <span class="comment">// åŸå­åœ°å°† ai è®¾ä¸º 10</span></span><br><span class="line">std::cout &lt;&lt; ai;        <span class="comment">// åŸå­åœ°è¯»å– ai åœ°å€¼</span></span><br><span class="line">++ai;                   <span class="comment">// åŸå­åœ°å°† ai è‡ªå¢ä¸º 11</span></span><br><span class="line">--ai;                   <span class="comment">// åŸå­åœ°å°† ai è‡ªå‡ä¸º 10</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code>std::cout &lt;&lt; ai</code>è¯­å¥ä¸­ï¼Œ<code>std::atomic</code>ä»…èƒ½ä¿è¯å¯¹äº<code>ai</code>çš„è¯»å–æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œè€Œä¸èƒ½ä¿è¯æ•´æ¡è¯­å¥éƒ½å…·æœ‰åŸå­æ€§ï¼Œåœ¨è¯»å–<code>ai</code>çš„å€¼å’Œè°ƒç”¨<code>operator&lt;&lt;</code>ä¹‹é—´ï¼Œå¯èƒ½ä¼šæœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹äº†<code>ai</code>çš„å€¼ï¼Œä½†è¿™å¯¹ä½¿ç”¨æŒ‰å€¼ä¼ å‚çš„<code>operator&lt;&lt;</code>å¹¶æ²¡æœ‰ä»€ä¹ˆå½±å“ã€‚</p><p><code>ai</code>çš„è‡ªå¢å’Œè‡ªå‡æ“ä½œæ˜¯<strong>è¯»å–-ä¿®æ”¹-å†™å…¥ï¼ˆread-modify-writeï¼ŒRWMï¼‰</strong> æ“ä½œï¼Œ<code>std::atomic</code>èƒ½ç¡®ä¿å®ƒä»¬æ•´ä½“ä»¥åŸå­æ–¹å¼æ‰§è¡Œã€‚è¿™æ˜¯<code>std::atomic</code>æœ€é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€ï¼š<code>std::atomic</code>å¯¹è±¡ä¹‹ä¸Šçš„æ‰€æœ‰æˆå‘˜å‡½æ•°éƒ½èƒ½è¢«å…¶å®ƒçº¿ç¨‹è§†ä¸ºåŸå­æ€§çš„ã€‚</p><p><code>std::atomic</code>åœ¨ RWM ä¸Šå…·æœ‰çš„ä¼˜åŠ¿ä¸<code>volatile</code>ç›¸æ¯”ååˆ†æ˜æ˜¾ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">ac</span><span class="params">(<span class="number">0</span>)</span></span>; <span class="comment">// atomic counter</span></span><br><span class="line"><span class="function"><span class="keyword">volatile</span> <span class="type">int</span> <span class="title">vc</span><span class="params">(<span class="number">0</span>)</span></span>;     <span class="comment">// volatile counter</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* åœ¨ä¸¤ä¸ªåŒæ—¶è¿è¡Œçš„çº¿ç¨‹ä¸­å„è‡ªæ‰§è¡Œè‡ªå¢æ“ä½œ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹ 1</span></span><br><span class="line">++ac;</span><br><span class="line">++vc;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹ 2</span></span><br><span class="line">++ac;</span><br><span class="line">++vc;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸¤ä¸ªæ‰§è¡Œç»“æŸåï¼Œ<code>ac</code>çš„å€¼ä¸€å®šä¸º 2ï¼Œè€Œ<code>vc</code>å´ä¸ä¸€å®šï¼Œæ•°æ®ç«äº‰å¯¼è‡´å®ƒçš„æœ€ç»ˆç»“æœå®é™…ä¸Šæ˜¯æ— æ³•é¢„æµ‹çš„ï¼Œä¸‹é¢æ˜¯ä¸€ç§å¯èƒ½çš„æƒ…å†µï¼š</p><ol><li>çº¿ç¨‹ 1 è¯»å–<code>vc</code>çš„å€¼ä¸º 0ï¼›</li><li>çº¿ç¨‹ 2 è¯»å–<code>vc</code>çš„å€¼ä»ä¸º 0ï¼›</li><li>çº¿ç¨‹ 1 å°†è¯»å–çš„å€¼ 0 è‡ªå¢ä¸º 1ï¼Œå†™å…¥<code>vc</code>ï¼›</li><li>çº¿ç¨‹ 2 ä¹Ÿå°†è¯»å–çš„å€¼ 0 è‡ªå¢ä¸º 1ï¼Œå†™å…¥<code>vc</code>ï¼›</li><li><code>vc</code>æœ€ç»ˆçš„å€¼ä¸º 1ã€‚</li></ol><p>é™¤äº† RWM ä»¥å¤–ï¼Œ<code>std::atomic</code>è¿˜åœ¨ç¡®ä¿<strong>é¡ºåºä¸€è‡´æ€§ï¼ˆsequential consistencyï¼‰</strong> ä¸Šå…·æœ‰ä¼˜åŠ¿ï¼Œè¿™ç§ä¸€è‡´æ€§æ˜¯å®ƒé»˜è®¤é‡‡ç”¨çš„ï¼ˆå°½ç®¡ C++ è¿˜æ”¯æŒå…¶å®ƒçš„ä¸€è‡´æ€§æ¨¡å‹ï¼Œä½†å®ƒä»¬çš„å®‰å…¨æ€§æ— æ³•å¾—åˆ°ä¿è¯ï¼‰ï¼Œå®ƒè§„å®šï¼šåœ¨æºä»£ç ä¸­ï¼Œ<strong>ä»»ä½•ä½äº<code>std::atomic</code>å˜é‡çš„å†™å…¥æ“ä½œä¹‹å‰çš„ä»£ç ä¸å¾—å‘ç”Ÿäºå†™å…¥æ“ä½œä¹‹å</strong>ã€‚ä½¿ç”¨<code>std::atomic</code>å¯ä»¥ä¿è¯ä»¥ä¸‹ä»£ç ä¸­çš„èµ‹å€¼è¯­å¥ä¸ä¼šè¿›è¡Œé‡æ–°æ’åºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::atomic&lt;<span class="type">bool</span>&gt; <span class="title">valAvailable</span><span class="params">(<span class="literal">false</span>)</span></span>;</span><br><span class="line"><span class="keyword">auto</span> imptValue = <span class="built_in">computeImportantValue</span>();   <span class="comment">// è®¡ç®—å‡ºå€¼</span></span><br><span class="line">valAvailable = <span class="literal">true</span>;                        <span class="comment">// é€šçŸ¥å…¶å®ƒä»»åŠ¡ï¼Œå€¼å·²å¯ç”¨</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸ä½¿ç”¨<code>std::atomic</code>ï¼Œè¯­å¥çš„é¡ºåºå¯èƒ½ä¼šè¢«ç¼–è¯‘å™¨æˆ–åº•å±‚ç¡¬ä»¶é‡æ–°æ’åˆ—ï¼Œä»¥ä½¿å¾—ä»£ç è¿è¡Œå¾—æ›´å¿«ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡æ–°æ’åºåçš„ç»“æœ</span></span><br><span class="line">valAvailable = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">auto</span> imptValue = <span class="built_in">computeImportantValue</span>();</span><br></pre></td></tr></table></figure><p><code>std::atomic</code>æ˜¯åªç§»ç±»å‹ï¼Œå› æ­¤ä»¥ä¸‹ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">x</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> y = x;</span><br><span class="line">y = x;</span><br></pre></td></tr></table></figure><p>æ­£ç¡®çš„æ–¹å¼æ˜¯è°ƒç”¨<code>std::atomic</code>çš„æˆå‘˜å‡½æ•°<code>load</code>å’Œ<code>store</code>æ¥ä»¥åŸå­æ–¹å¼è¯»å–å’Œå†™å…¥ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">y</span><span class="params">(x.load())</span></span>;</span><br><span class="line">y.<span class="built_in">store</span>(x.<span class="built_in">load</span>());</span><br></pre></td></tr></table></figure><p>å°½ç®¡åœ¨å¾ˆå¤šæ—¶å€™<code>load</code>å’Œ<code>store</code>å¹¶ä¸æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯æœ‰äº›å¼€å‘è€…è¿˜æ˜¯å¾ˆå–œæ¬¢ä½¿ç”¨å®ƒä»¬ï¼Œå› ä¸ºè¿™æ ·åšå¯ä»¥åœ¨ä»£ç ä¸­æ˜ç¡®å¼ºè°ƒæ‰€ä½¿ç”¨çš„å˜é‡å¹¶éå¸¸è§„ã€‚è¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸€ä¸ªä»£ç é£æ ¼çš„é—®é¢˜ã€‚</p><p><code>volatile</code>æ˜¯ç”¨æ¥å¤„ç†ç‰¹æ®Šå†…å­˜çš„å·¥å…·ï¼Œå®ƒä¼šè¢«ç”¨åœ¨è¯»å†™æ“ä½œä¸åº”è¯¥è¢«ä¼˜åŒ–çš„å†…å­˜ä¸Šã€‚ä¸€èˆ¬æ¥è®²ï¼Œç¼–è¯‘å™¨ä¼šä¸ºå¸¸è§„å†…å­˜çš„å†—ä½™è¯»å–å’Œå†™å…¥è‡ªåŠ¨æ‰§è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> y = x; <span class="comment">// è¯»å– x</span></span><br><span class="line">y = x;      <span class="comment">// å†æ¬¡è¯»å– x</span></span><br><span class="line"></span><br><span class="line">x = <span class="number">10</span>;     <span class="comment">// å†™å…¥ x</span></span><br><span class="line">x = <span class="number">20</span>;     <span class="comment">// å†æ¬¡å†™å…¥ x</span></span><br></pre></td></tr></table></figure><p>åœ¨ç»è¿‡ä¼˜åŒ–åå°±èƒ½å˜æˆååˆ†ç²¾ç®€çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> y = x; <span class="comment">// è¯»å– x</span></span><br><span class="line"></span><br><span class="line">x = <span class="number">20</span>;     <span class="comment">// å†™å…¥ x</span></span><br></pre></td></tr></table></figure><p>ä½†å¯¹äºç‰¹æ®Šå†…å­˜ï¼Œæˆ‘ä»¬å¯èƒ½ä¸æƒ³è¦ç¼–è¯‘å™¨å»æ‰§è¡Œè¿™ç§ä¼˜åŒ–ã€‚ä¾‹å¦‚ç”¨äºå†…å­˜æ˜ å°„ I/O çš„å†…å­˜ï¼Œè¿™ç§å†…å­˜çš„ä½ç½®å®é™…ä¸Šä¼šè¢«ç”¨äºä¸å¤–éƒ¨è®¾å¤‡é€šä¿¡ï¼Œè€Œéç”¨äºè¯»å–æˆ–å†™å…¥å¸¸è§„å†…å­˜ã€‚è¿™æ—¶ï¼Œ<code>volatile</code>å°±èƒ½æ´¾ä¸Šç”¨åœºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="type">int</span> x; <span class="comment">// ä»¥ volatile å£°æ˜ x</span></span><br><span class="line">...             <span class="comment">// åˆå§‹åŒ– x</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> y = x;     <span class="comment">// è¯»å– x</span></span><br><span class="line">y = x;          <span class="comment">// å†æ¬¡è¯»å– xï¼ˆä¸ä¼šè¢«ä¼˜åŒ–æ‰ï¼‰</span></span><br><span class="line"></span><br><span class="line">x = <span class="number">10</span>;         <span class="comment">// å†™å…¥ xï¼ˆä¸ä¼šè¢«ä¼˜åŒ–æ‰ï¼‰</span></span><br><span class="line">x = <span class="number">20</span>;         <span class="comment">// å†æ¬¡å†™å…¥ x</span></span><br></pre></td></tr></table></figure><p><code>std::atomic</code>å’Œ<code>volatile</code>ç”¨äºä¸åŒçš„ç›®çš„ï¼Œå®ƒä»¬ç”šè‡³å¯ä»¥ä¸€èµ·ä½¿ç”¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> std::atomic&lt;<span class="type">int</span>&gt; vai;  <span class="comment">// é’ˆå¯¹ vai çš„æ“ä½œå…·æœ‰åŸå­æ€§</span></span><br><span class="line">                                <span class="comment">// å¹¶ä¸”ä¸ä¼šè¢«ä¼˜åŒ–æ‰</span></span><br></pre></td></tr></table></figure><h2 id="ç¬¬å…«ç« ï¼šå¾®è°ƒ">ç¬¬å…«ç« ï¼šå¾®è°ƒ</h2><h3 id="æ¡æ¬¾-41ï¼šå¯¹äºç§»åŠ¨æˆæœ¬ä½ä¸”æ€»æ˜¯è¢«æ‹·è´çš„å¯æ‹·è´å½¢å‚ï¼Œè€ƒè™‘å°†å…¶æŒ‰å€¼ä¼ é€’">æ¡æ¬¾ 41ï¼šå¯¹äºç§»åŠ¨æˆæœ¬ä½ä¸”æ€»æ˜¯è¢«æ‹·è´çš„å¯æ‹·è´å½¢å‚ï¼Œè€ƒè™‘å°†å…¶æŒ‰å€¼ä¼ é€’</h3><p>ä¸ºäº†å®ç°å¯¹ä¼ å…¥å‡½æ•°çš„å·¦å€¼å®å‚æ‰§è¡Œæ‹·è´ï¼Œå¯¹å³å€¼å®å‚æ‰§è¡Œç§»åŠ¨ï¼Œæˆ‘ä»¬ä¸€å…±æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;                                  <span class="comment">// æ–¹æ³•ä¸€ï¼š</span></span><br><span class="line"><span class="keyword">public</span>:                                         <span class="comment">// å¯¹å·¦å€¼å’Œå³å€¼åˆ†åˆ«é‡è½½</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addName</span><span class="params">(<span class="type">const</span> std::string&amp; newName)</span> </span>&#123;</span><br><span class="line">        names.<span class="built_in">push_back</span>(newName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addName</span><span class="params">(std::string&amp;&amp; newName)</span> </span>&#123;</span><br><span class="line">        names.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(newName));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt;std::string&gt; names;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;                                  <span class="comment">// æ–¹æ³•äºŒï¼š</span></span><br><span class="line"><span class="keyword">public</span>:                                         <span class="comment">// ä½¿ç”¨ä¸‡èƒ½å¼•ç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">addName</span><span class="params">(T&amp;&amp; newName)</span> </span>&#123;</span><br><span class="line">        names.<span class="built_in">push_back</span>(std::forward&lt;T&gt;(newName));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;                                  <span class="comment">// æ–¹æ³•ä¸‰ï¼š</span></span><br><span class="line"><span class="keyword">public</span>:                                         <span class="comment">// æŒ‰å€¼ä¼ é€’å‚æ•°</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addName</span><span class="params">(std::string newName)</span> </span>&#123;</span><br><span class="line">        names.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(newName));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ C++98 ä¸­ï¼ŒæŒ‰å€¼ä¼ é€’çš„å½¢å‚æ€»ä¼šé€šè¿‡æ‹·è´æ„é€ å‡½æ•°åˆ›å»ºï¼Œä½†åœ¨ C++11 åï¼Œå½¢å‚ä»…åœ¨ä¼ å…¥å·¦å€¼æ—¶æ‰ä¼šè¢«æ‹·è´æ„é€ ï¼Œè€Œå¦‚æœä¼ å…¥çš„æ˜¯ä¸ªå³å€¼ï¼Œå®ƒä¼šè¢«ç§»åŠ¨æ„é€ ã€‚</p><p>å¯¹äºå¯æ‹·è´çš„ï¼Œç§»åŠ¨å¼€é”€ä½çš„ï¼Œå¹¶ä¸”æ€»æ˜¯ä¼šè¢«æ‹·è´çš„å½¢å‚è€Œè¨€ï¼ŒæŒ‰å€¼ä¼ é€’å’ŒæŒ‰å¼•ç”¨ä¼ é€’çš„æ•ˆç‡å¾ˆæ¥è¿‘ï¼Œè€Œä¸”æŒ‰å€¼ä¼ é€’æ›´å®¹æ˜“å®ç°ï¼Œè¿˜å¯èƒ½ä¼šç”Ÿæˆæ›´å°‘çš„ç›®æ ‡ä»£ç ã€‚</p><p>å¯¹äºä¸å¯æ‹·è´çš„å½¢å‚ï¼Œç”±äºå®ƒçš„æ‹·è´æ„é€ å‡½æ•°å·²è¢«ç¦ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦ä¸ºå…¶å·¦å€¼ç±»å‹çš„å®å‚æä¾›æ”¯æŒï¼Œåªéœ€è¦ç¼–å†™ä¸€ä¸ªæ¥å—å³å€¼å¼•ç”¨çš„ç‰ˆæœ¬å°±è¡Œäº†ã€‚è€ƒè™‘ä¸€ä¸ªç±»ï¼Œå®ƒå«æœ‰ä¸€ä¸ª<code>std::unique_ptr</code>ç±»å‹çš„æ•°æ®æˆå‘˜å’Œå¯¹åº”çš„ setterï¼Œè€Œ<code>std::unique_ptr</code>æ˜¯ä¸ªåªç§»ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç¼–å†™å•ä¸ªå‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setPtr</span><span class="params">(std::unique_ptr&lt;std::string&gt;&amp;&amp; ptr)</span> </span>&#123;</span><br><span class="line">        p = std::<span class="built_in">move</span>(ptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::unique_ptr&lt;std::string&gt; p;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Widget w;</span><br><span class="line">...</span><br><span class="line">w.<span class="built_in">setPtr</span>(std::<span class="built_in">make_unique</span>&lt;std::string&gt;(<span class="string">&quot;Modern C++&quot;</span>));</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æŒ‰å€¼ä¼ å‚çš„å‰ææ˜¯å½¢å‚ç§»åŠ¨çš„æˆæœ¬è¶³å¤Ÿä½å»‰ï¼Œå› ä¸ºæŒ‰å€¼ä¼ å‚ä¼šæ¯”æŒ‰å¼•ç”¨ä¼ å‚å¤šä¸€æ¬¡é¢å¤–çš„ç§»åŠ¨æ“ä½œï¼Œå¦‚æœè¿™ä¸ªå‰æä¸æˆç«‹ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸å¿…è¦çš„ç§»åŠ¨å°±ä¸æ‰§è¡Œä¸å¿…è¦çš„æ‹·è´æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚å¦å¤–ï¼Œä½ åº”å½“åªå¯¹ä¸€å®šä¼šè¢«æ‹·è´çš„å½¢å‚è€ƒè™‘ä½¿ç”¨æŒ‰å€¼ä¼ å‚ï¼Œä»¥ä¸‹ä»£ç å°±æ˜¯ä¸€ä¸ªåä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addName</span><span class="params">(std::string newName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((newName.<span class="built_in">length</span>() &gt;= minLen) &amp;&amp;</span><br><span class="line">            (newName.<span class="built_in">length</span>() &lt;= maxLen)) &#123;</span><br><span class="line">            names.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(newName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt;std::string&gt; names;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å³ä½¿æ²¡æœ‰å‘<code>names</code>æ·»åŠ ä»»ä½•å†…å®¹ï¼Œè¯¥å‡½æ•°ä¹Ÿä¼šé€ æˆæ„é€ å’Œææ„<code>newName</code>çš„å¼€é”€ï¼Œè€Œå¦‚æœä½¿ç”¨æŒ‰å¼•ç”¨ä¼ å‚ï¼Œå°±å¯ä»¥é¿å…è¿™ç¬”å¼€é”€ã€‚</p><p>é€šè¿‡æ„é€ æ‹·è´å½¢å‚çš„å¼€é”€å¯èƒ½ä¼šæ¯”é€šè¿‡èµ‹å€¼æ‹·è´å½¢å‚è¦å¤§å¾—å¤šã€‚è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Password</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Password</span><span class="params">(std::string pwd)</span>  <span class="comment">// æŒ‰å€¼ä¼ å‚</span></span></span><br><span class="line"><span class="function">        : text(std::move(pwd)) &#123;</span>&#125;       <span class="comment">// å¯¹ text è¿›è¡Œæ„é€ </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">changeTo</span><span class="params">(std::string newPwd)</span> </span>&#123; <span class="comment">// æŒ‰å€¼ä¼ å‚</span></span><br><span class="line">        text = std::<span class="built_in">move</span>(newPwd);       <span class="comment">// å¯¹ text è¿›è¡Œèµ‹å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string text;                   <span class="comment">// è¡¨ç¤ºå¯†ç </span></span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">initPwd</span><span class="params">(<span class="string">&quot;Supercalifragilisticexpialidocious&quot;</span>)</span></span>;  <span class="comment">// æ—§å¯†ç </span></span><br><span class="line"><span class="function">Password <span class="title">p</span><span class="params">(initPwd)</span></span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">std::string newPassword = <span class="string">&quot;Beware the Jabberwock&quot;</span>;          <span class="comment">// æ–°å¯†ç </span></span><br><span class="line">p.<span class="built_in">changeTo</span>(newPassword);</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤å¤„ï¼Œæ—§å¯†ç æ¯”æ–°å¯†ç æ›´é•¿ï¼Œå› æ­¤ä¸éœ€è¦è¿›è¡Œä»»ä½•å†…å­˜åˆ†é…å’Œå›æ”¶ã€‚å¦‚æœé‡‡ç”¨é‡è½½çš„æ–¹å¼ï¼Œå¯èƒ½å°±ä¸ä¼šå‘ç”Ÿä»»ä½•åŠ¨æ€å†…å­˜ç®¡ç†æ“ä½œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Password</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">changeTo</span><span class="params">(std::string&amp; newPwd)</span> </span>&#123;    <span class="comment">// å¯¹å·¦å€¼çš„é‡è½½</span></span><br><span class="line">        text = newPwd;                      <span class="comment">// è‹¥ text.capacity() &gt;= newPwd.size()</span></span><br><span class="line">                                            <span class="comment">// åˆ™å¯ä»¥å¤ç”¨ text çš„å†…å­˜</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤æƒ…å½¢ä¸‹ï¼Œä½¿ç”¨æŒ‰å€¼ä¼ å‚å°±ä¼šé€ æˆé¢å¤–çš„å†…å­˜åˆ†é…å’Œå›æ”¶çš„å¼€é”€ï¼Œè¿™å¯èƒ½ä¼šæ¯”ç§»åŠ¨<code>std::string</code>çš„å¼€é”€é«˜å‡ºå‡ ä¸ªæ•°é‡çº§ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œé€šè¿‡èµ‹å€¼æ‹·è´ä¸€ä¸ªå½¢å‚è¿›è¡ŒæŒ‰å€¼ä¼ å‚æ‰€é€ æˆçš„é¢å¤–å¼€é”€ï¼Œå–å†³äºä¼ å‚çš„ç±»å‹ï¼Œå·¦å€¼å’Œå³å€¼çš„æ¯”ä¾‹ï¼Œè¿™ä¸ªç±»å‹æ˜¯å¦éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜ï¼Œä»¥åŠï¼Œå¦‚æœéœ€è¦åˆ†é…å†…å­˜çš„è¯ï¼Œèµ‹å€¼æ“ä½œç¬¦çš„å…·ä½“å®ç°ï¼Œè¿˜æœ‰èµ‹å€¼ç›®æ ‡æ‰€å çš„å†…å­˜æ˜¯å¦è‡³å°‘å’Œèµ‹å€¼æºæ‰€å çš„å†…å­˜ä¸€æ ·å¤§ã€‚å¯¹äº<code>std::string</code>æ¥è¯´ï¼Œå¼€é”€è¿˜å–å†³äºå®ç°æ˜¯å¦ä½¿ç”¨äº† SSOï¼ˆå‚è€ƒ<strong>æ¡æ¬¾ 29</strong>ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆè¦èµ‹çš„å€¼æ˜¯å¦åŒ¹é… SSO ç¼“å†²åŒºã€‚</p><p>æœ€åè¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼ŒæŒ‰å€¼ä¼ å‚è‚¯å®šä¼šå¯¼è‡´<strong>å¯¹è±¡åˆ‡ç‰‡ï¼ˆobject slicingï¼‰</strong> çš„é—®é¢˜ï¼Œæ‰€ä»¥åŸºç±»ç±»å‹ä¸é€‚åˆç”¨äºæŒ‰å€¼ä¼ é€’ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123; ... &#125;;                           <span class="comment">//åŸºç±»</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpecialWidget</span> : <span class="keyword">public</span> Widget &#123; ... &#125;;    <span class="comment">//æ´¾ç”Ÿç±»</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">processWidget</span><span class="params">(Widget w)</span></span>;                   <span class="comment">// é’ˆå¯¹ä»»æ„ç±»å‹çš„ Widget çš„å‡½æ•°</span></span><br><span class="line">                                                <span class="comment">// åŒ…æ‹¬æ´¾ç”Ÿç±»å‹</span></span><br><span class="line">... </span><br><span class="line"></span><br><span class="line">SpecialWidget sw;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">processWidget</span>(sw);                              <span class="comment">// å‘ç”Ÿå¯¹è±¡åˆ‡ç‰‡ï¼ŒprocessWidget åªèƒ½çœ‹åˆ° Widget</span></span><br><span class="line">                                                <span class="comment">// è€Œé SpecialWidget</span></span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-42ï¼šè€ƒè™‘ç½®å…¥è€Œéæ’å…¥">æ¡æ¬¾ 42ï¼šè€ƒè™‘ç½®å…¥è€Œéæ’å…¥</h3><p>å‡å¦‚ä½ æƒ³å‘ STL å®¹å™¨ä¸­æ·»åŠ æ–°å…ƒç´ ï¼Œ<strong>æ’å…¥å‡½æ•°ï¼ˆinsertion functionï¼‰</strong> é€šå¸¸æ˜¯åˆä¹é€»è¾‘çš„é€‰æ‹©ï¼Œä½†å¯¹äºæ€§èƒ½ç‹‚äººè€Œè¨€ï¼Œå…¶èƒŒåæ‰€éšå«çš„ä¸´æ—¶å¯¹è±¡å¸¦æ¥çš„å¼€é”€æ˜¯éš¾ä»¥å¿å—çš„ã€‚è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;std::string&gt; vs;    <span class="comment">// æŒæœ‰ std::string å¯¹è±¡çš„å®¹å™¨</span></span><br><span class="line">vs.<span class="built_in">push_back</span>(<span class="string">&quot;xyzzy&quot;</span>);          <span class="comment">// æ·»åŠ å­—ç¬¦ä¸²å­—é¢é‡</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤„æ·»åŠ çš„å­—ç¬¦ä¸²å­—é¢é‡å’Œ<code>std::string</code>ç±»å‹å¹¶ä¸åŒ¹é…ï¼Œå› æ­¤éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª<code>std::string</code>ç±»å‹çš„ä¸´æ—¶å¯¹è±¡ï¼Œç„¶åå†å°†å…¶ç»‘å®šåˆ°<code>push_back</code>å‡½æ•°çš„å³å€¼å¼•ç”¨å½¢å‚ã€‚æ¢å¥è¯è¯´ï¼Œä½ å¯ä»¥æŠŠè¿™å¥è°ƒç”¨çœ‹ä½œä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vs.<span class="built_in">push_back</span>(std::<span class="built_in">string</span>(<span class="string">&quot;xyzzy&quot;</span>));</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¹‹åï¼Œ<code>push_back</code>ä¼šåœ¨<code>std::vector</code>ä¸­æ„é€ å‡ºä¸€ä¸ªå½¢å‚çš„å‰¯æœ¬ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°æ¥å®Œæˆçš„ï¼ˆè¿™å·²ç»æ˜¯ç¬¬äºŒæ¬¡è°ƒç”¨æ„é€ å‡½æ•°äº†ï¼‰ã€‚åœ¨<code>push_back</code>è¿”å›åï¼Œä¸´æ—¶å¯¹è±¡å°†ç«‹åˆ»è¢«é”€æ¯ï¼Œè¿™åˆè°ƒç”¨äº†<code>std::string</code>çš„ææ„å‡½æ•°ã€‚</p><p>ä»åŸç†ä¸Šæ¥è¯´ï¼Œ<strong>ç½®å…¥å‡½æ•°ï¼ˆemplacement functionï¼‰</strong> åœ¨å¤§éƒ¨åˆ†æ—¶å€™åº”è¯¥æ¯”æ’å…¥å‡½æ•°æ›´é«˜æ•ˆï¼Œè€Œä¸”ä¸ä¼šæœ‰æ›´ä½æ•ˆçš„å¯èƒ½æ€§ã€‚<code>emplace_back</code>å‡½æ•°ä½¿ç”¨äº†å®Œç¾è½¬å‘ï¼Œå› æ­¤è°ƒç”¨å®ƒä¸ä¼šå¸¦æ¥ä»»ä½•çš„ä¸´æ—¶å¯¹è±¡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vs.<span class="built_in">emplace_back</span>(<span class="string">&quot;xyzzy&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä½†ä»¤äººé—æ†¾çš„æ˜¯ï¼Œæ’å…¥å‡½æ•°è¿˜æ˜¯æœ‰å¯èƒ½æ¯”ç½®å…¥å‡½æ•°æ›´å¿«çš„ï¼Œè¿™å–å†³äºä¼ é€’çš„å®å‚ç±»å‹ï¼Œä½¿ç”¨çš„å®¹å™¨ç§ç±»ï¼Œç½®å…¥æˆ–æ’å…¥åˆ°å®¹å™¨ä¸­çš„ä½ç½®ï¼Œå®¹å™¨ä¸­ç±»å‹çš„æ„é€ å‡½æ•°çš„å¼‚å¸¸å®‰å…¨æ€§ï¼Œå’Œå¯¹äºç¦æ­¢é‡å¤å€¼çš„å®¹å™¨ï¼ˆ<code>std::set</code>ï¼Œ<code>std::map</code>ï¼Œ<code>std::unordered_set</code>å’Œ<code>set::unordered_map</code>ï¼‰è€Œè¨€ï¼Œè¦æ·»åŠ çš„å€¼æ˜¯å¦å·²ç»åœ¨å®¹å™¨ä¸­ã€‚ä¸è¿‡åœ¨ä»¥ä¸‹è¿™äº›æƒ…å†µï¼Œç½®å…¥å‡½æ•°å¾ˆæœ‰å¯èƒ½ä¼šè¿è¡Œå¾—æ›´å¿«ï¼š</p><ul><li>å¾…æ·»åŠ çš„å€¼æ˜¯é€šè¿‡æ„é€ è€Œéèµ‹å€¼æ–¹å¼åŠ å…¥å®¹å™¨ã€‚ä¸€ä¸ªåä¾‹æ˜¯å‘<code>std::vector</code>ä¸­å·²ç»è¢«å æ®çš„ä½ç½®ç½®å…¥å¯¹è±¡ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;std::string&gt; vs;</span><br><span class="line">...                                 <span class="comment">// å‘ vs ä¸­æ·»åŠ å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">vs.<span class="built_in">emplace</span>(vs.<span class="built_in">begin</span>(), <span class="string">&quot;xyzzy&quot;</span>);    <span class="comment">// å‘ vs çš„å¼€å¤´æ·»åŠ å…ƒç´ ï¼Œè¯¥ä½ç½®å·²ç»å­˜åœ¨å¯¹è±¡</span></span><br><span class="line">                                    <span class="comment">// ä½¿ç”¨çš„æ˜¯èµ‹å€¼è€Œéæ„é€ æ–¹å¼</span></span><br></pre></td></tr></table></figure><blockquote><p>åŸºäºèŠ‚ç‚¹çš„å®¹å™¨ä¸€èˆ¬éƒ½ä½¿ç”¨æ„é€ æ¥æ·»åŠ æ–°å…ƒç´ ï¼Œè€Œå¤§å¤šæ•°æ ‡å‡†åº“å®¹å™¨éƒ½æ˜¯åŸºäºèŠ‚ç‚¹çš„ï¼Œé™¤äº†<code>std::vector</code>ï¼Œ<code>std::deque</code>å’Œ<code>std::string</code>ç­‰ï¼ˆ<code>std::array</code>ä¹Ÿä¸æ˜¯åŸºäºèŠ‚ç‚¹çš„ï¼Œä½†æ˜¯å®ƒä¸æ”¯æŒç½®å…¥å’Œæ’å…¥ï¼Œæ‰€ä»¥å’Œæˆ‘ä»¬çš„è®¨è®ºæ— å…³ï¼‰ã€‚åœ¨ä¸æ˜¯åŸºäºèŠ‚ç‚¹çš„å®¹å™¨ä¸­ï¼Œä½ å¯ä»¥ç¡®ä¿¡<code>emplace_back</code>æ˜¯ä½¿ç”¨æ„é€ æ¥å‘å®¹å™¨æ·»åŠ å…ƒç´ çš„ï¼Œè¿™å¯¹äº<code>std::deque</code>çš„<code>emplace_front</code>ä¹ŸåŒæ ·æˆç«‹ã€‚</p></blockquote><ul><li>ä¼ é€’çš„å®å‚ç±»å‹å’Œå®¹å™¨æ‰€æŒæœ‰çš„ç±»å‹ä¸åŒã€‚</li><li>å®¹å™¨ä¸ä¼šå› ä¸ºå­˜åœ¨é‡å¤å€¼è€Œæ‹’ç»å¾…æ·»åŠ çš„å€¼ã€‚</li></ul><p>åœ¨é¢å¯¹<code>new Widget</code>è¿™æ ·çš„è¡¨è¾¾å¼æ—¶ï¼Œç½®å…¥å‡½æ•°ä¹Ÿæ²¡æœ‰ä»€ä¹ˆä¼˜åŠ¿ã€‚è€ƒè™‘ä»¥ä¸‹ä¸¤ç§å‘<code>std::shared_ptr</code>å®¹å™¨ä¸­æ·»åŠ æ–°å…ƒç´ çš„æ–¹å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">killWidget</span><span class="params">(Widget* pWidget)</span></span>;   <span class="comment">// è‡ªå®šä¹‰åˆ é™¤å™¨</span></span><br><span class="line"></span><br><span class="line">ptrs.<span class="built_in">push_back</span>(std::<span class="built_in">shared_ptr</span>&lt;Widget&gt;(<span class="keyword">new</span> Widget, killWidget));</span><br><span class="line"><span class="comment">// å’Œ ptrs.push_back(&#123; new Widget, killWidget &#125;) ç­‰ä»·</span></span><br><span class="line"></span><br><span class="line">ptrs.<span class="built_in">emplace_back</span>(<span class="keyword">new</span> Widget, killWidget);</span><br></pre></td></tr></table></figure><p>æ­¤å¤„ä½¿ç”¨<code>push_back</code>ä»ç„¶ä¼šåˆ›å»ºå‡º<code>std::shared_ptr</code>ç±»å‹çš„ä¸´æ—¶å¯¹è±¡ï¼Œä½†è¯¥ä¸´æ—¶å¯¹è±¡å´æ‹¥æœ‰äº†æ­£é¢æ„ä¹‰ï¼Œå¦‚æœåœ¨ä¸ºé“¾è¡¨èŠ‚ç‚¹åˆ†é…å†…å­˜æ—¶æŠ›å‡ºäº†å†…å­˜ä¸è¶³çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥<code>std::shared_ptr</code>ä¸´æ—¶å¯¹è±¡å¯ä»¥è‡ªåŠ¨è°ƒç”¨<code>killWidget</code>æ¥é‡Šæ”¾<code>Widget</code>çš„å†…å­˜ï¼›ä½†åœ¨ä½¿ç”¨<code>emplace_back</code>çš„æƒ…å†µä¸‹ï¼Œèµ·åˆ°ä¿éšœä½œç”¨çš„<code>std::shared_ptr</code>ä¸´æ—¶å¯¹è±¡å°†ä¸å†å­˜åœ¨ï¼Œå¦‚æœå‘ç”ŸåŒæ ·çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆ<code>Widget</code>çš„å†…å­˜å°†ä¸å¯é¿å…åœ°è¢«æ³„æ¼ã€‚</p><p>å¦‚æœä½ å‚è€ƒ<strong>æ¡æ¬¾ 21</strong> æ‰€è¿°ï¼Œä½¿ç”¨ç‹¬ç«‹è¯­å¥å°†<code>new Widget</code>äº§ç”Ÿçš„æŒ‡é’ˆè½¬äº¤ç»™èµ„æºç®¡ç†å¯¹è±¡ï¼Œé‚£ä¹ˆä½¿ç”¨ç½®å…¥å‡½æ•°å’Œæ’å…¥å‡½æ•°çš„æ•ˆæœä¹Ÿæ˜¯å·®ä¸å¤šçš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw</span><span class="params">(<span class="keyword">new</span> Widget, killWidget)</span></span>;</span><br><span class="line"></span><br><span class="line">ptrs.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(spw));</span><br><span class="line"><span class="comment">// æˆ– ptrs.emplace_back(std::move(spw))</span></span><br></pre></td></tr></table></figure><p>æœ€åéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œç½®å…¥å‡½æ•°å¯èƒ½ä¼šæ‰§è¡Œåœ¨æ’å…¥å‡½æ•°ä¸­ä¼šè¢«æ‹’ç»çš„ç±»å‹è½¬æ¢ã€‚è¿™æ˜¯å› ä¸ºç½®å…¥å‡½æ•°ä½¿ç”¨çš„æ˜¯ç›´æ¥åˆå§‹åŒ–ï¼Œè€Œæ’å…¥å‡½æ•°ä½¿ç”¨çš„æ˜¯æ‹·è´åˆå§‹åŒ–ï¼Œåªæœ‰ç›´æ¥åˆå§‹åŒ–ä¼šå°†å¸¦æœ‰<code>explicit</code>é™å®šç¬¦çš„æ„é€ å‡½æ•°çº³å…¥è€ƒè™‘èŒƒå›´ã€‚å› æ­¤åœ¨ä½¿ç”¨ç½®å…¥å‡½æ•°æ—¶ï¼Œè¦ç‰¹åˆ«å…³æ³¨æ˜¯å¦ä¼ é€’äº†æ­£ç¡®çš„å®å‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;std::regex&gt; regexes;    <span class="comment">// C++11 æä¾›äº†å¯¹æ­£åˆ™è¡¨è¾¾å¼çš„æ”¯æŒ</span></span><br><span class="line"></span><br><span class="line">regexes.<span class="built_in">push_back</span>(<span class="literal">nullptr</span>);         <span class="comment">// æ— æ³•é€šè¿‡ç¼–è¯‘ï¼</span></span><br><span class="line">regexes.<span class="built_in">emplace_back</span>(<span class="literal">nullptr</span>);      <span class="comment">// èƒ½é€šè¿‡ç¼–è¯‘ï¼Œä½†ä¼šäº§ç”Ÿæœªå®šä¹‰è¡Œä¸º</span></span><br><span class="line">                                    <span class="comment">// ç›¸å½“äºæ‰§è¡Œ std::regex(nullptr)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Cpp </category>
          
          <category> è¯»ä¹¦ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cpp </tag>
            
            <tag> è¯»ä¹¦ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Effective Cpp</title>
      <link href="/posts/bf4dced7.html"/>
      <url>/posts/bf4dced7.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ã€ŠEffectivate C++ã€‹ï¼Œéå¸¸å¥½çš„ä¸€æœ¬è¿›ä¸€æ­¥ç†è§£C++çš„ä¹¦ã€‚</p><p>è½¬è½½è‡ªï¼š<a href="https://joytsing.cn/posts/22113/">https://joytsing.cn/posts/22113/</a></p><p>å¹¶åœ¨å…¶ä¸­æ·»åŠ äº†è‡ªå·±å­¦ä¹ çš„å†…å®¹ã€‚</p><h2 id="ç¬¬ä¸€ç« ï¼šè®©è‡ªå·±ä¹ æƒ¯-C">ç¬¬ä¸€ç« ï¼šè®©è‡ªå·±ä¹ æƒ¯ C++</h2><h3 id="æ¡æ¬¾-1ï¼šè§†-C-ä¸ºä¸€ä¸ªè¯­è¨€è”é‚¦">æ¡æ¬¾ 1ï¼šè§† C++ ä¸ºä¸€ä¸ªè¯­è¨€è”é‚¦</h3><p>C++ æ‹¥æœ‰å¤šç§ä¸åŒçš„ç¼–ç¨‹èŒƒå¼ï¼Œè€Œè¿™äº›èŒƒå¼é›†æˆåœ¨ä¸€ä¸ªè¯­è¨€ä¸­ï¼Œä½¿å¾— C++ æ˜¯ä¸€é—¨å³çµæ´»åˆå¤æ‚çš„è¯­è¨€ï¼š</p><ol><li>ä¼ ç»Ÿçš„é¢å‘è¿‡ç¨‹ Cï¼šåŒºå—ï¼Œè¯­å¥ï¼Œé¢„å¤„ç†å™¨ï¼Œå†…ç½®æ•°æ®ç±»å‹ï¼Œæ•°ç»„ï¼ŒæŒ‡é’ˆã€‚</li><li>é¢å‘å¯¹è±¡çš„ C with Classesï¼šç±»ï¼Œå°è£…ï¼Œç»§æ‰¿ï¼Œå¤šæ€ï¼ŒåŠ¨æ€ç»‘å®šã€‚</li><li>æ¨¡æ¿ç¼–ç¨‹ Template C++ å’Œå ªç§°é»‘é­”æ³•çš„æ¨¡æ¿å…ƒç¼–ç¨‹ï¼ˆTMPï¼‰ã€‚</li><li>C++ æ ‡å‡†åº“ STLã€‚</li></ol><p>C++ é«˜æ•ˆç¼–ç¨‹å®ˆåˆ™è§†æƒ…å†µè€Œå˜åŒ–ï¼Œç¨‹åºè®¾è®¡æ²¡æœ‰é“¶å¼¹ã€‚</p><h3 id="æ¡æ¬¾-2ï¼šå°½é‡ä»¥-const-enum-inline-æ›¿æ¢-define">æ¡æ¬¾ 2ï¼šå°½é‡ä»¥ const, enum, inline æ›¿æ¢ #define</h3><p>é€šä¿—æ¥è¯´ï¼Œ#defineåœ¨é¢„å¤„ç†å±•å¼€ç›´æ¥æ›¿æ¢åˆ°ä»£ç ä¸­ï¼Œä¸å¥½æ’æŸ¥é”™è¯¯~</p><p>åœ¨åŸä¹¦å†™æˆæ—¶ C++11 ä¸­çš„<code>constexpr</code>è¿˜æœªè¯ç”Ÿï¼Œç°åœ¨ä¸€èˆ¬è®¤ä¸ºåº”å½“ç”¨<code>constexpr</code>å®šä¹‰ç¼–è¯‘æœŸå¸¸é‡æ¥æ›¿ä»£å¤§éƒ¨åˆ†çš„<code>#define</code>å®å¸¸é‡å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ASPECT_RATIO 1.653</span></span><br></pre></td></tr></table></figure><p>æ›¿ä»£ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> aspect_ratio = <span class="number">1.653</span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†ç¼–è¯‘æœŸå¸¸é‡å®šä¹‰ä¸ºç±»çš„é™æ€æˆå‘˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GamePlayer</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> numTurns = <span class="number">5</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>enum</code>å¯ä»¥ç”¨äºæ›¿ä»£æ•´å‹çš„å¸¸é‡ï¼Œå¹¶ä¸”åœ¨æ¨¡æ¿å…ƒç¼–ç¨‹ä¸­åº”ç”¨å¹¿æ³›ï¼ˆè§æ¡æ¬¾ 48ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GamePlayer</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> &#123; numTurns = <span class="number">5</span> &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¤§éƒ¨åˆ†<code>#define</code>å®å¸¸é‡åº”å½“ç”¨å†…è”æ¨¡æ¿å‡½æ•°æ›¿ä»£ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CALL_WITH_MAX(a, b) f((a) &gt; (b) ? (a) : (b))</span></span><br></pre></td></tr></table></figure><p>æ›¿ä»£ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">CallWithMax</span><span class="params">(<span class="type">const</span> T&amp; a, <span class="type">const</span> T&amp; b)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">f</span>(a &gt; b ? a : b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®å’Œå‡½æ•°çš„è¡Œä¸ºæœ¬èº«å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œå®åªæ˜¯ç®€å•çš„æ›¿æ¢ï¼Œå¹¶ä¸æ¶‰åŠä¼ å‚å’Œå¤åˆ¶ã€‚</p><h3 id="æ¡æ¬¾-3ï¼šå°½å¯èƒ½ä½¿ç”¨-const">æ¡æ¬¾ 3ï¼šå°½å¯èƒ½ä½¿ç”¨ const</h3><p><strong>const</strong></p><p>const ä¿®é¥°çš„å˜é‡ä¸èƒ½å¤Ÿå†ä½œä¸ºå·¦å€¼ï¼ï¼åˆå§‹åŒ–å®Œæˆåï¼Œå€¼ä¸èƒ½è¢«ä¿®æ”¹ï¼ï¼</p><p><strong>Cå’ŒC++ä¸­constçš„åŒºåˆ«ï¼Ÿ</strong></p><p>Cä¸­ï¼Œconstå°±æ˜¯å½“ä½œä¸€ä¸ªå˜é‡æ¥ç¼–è¯‘ç”ŸæˆæŒ‡ä»¤çš„ã€‚</p><p>C++ä¸­ï¼Œæ‰€æœ‰å‡ºç°constå¸¸é‡åå­—çš„åœ°æ–¹ï¼Œéƒ½è¢«å¸¸é‡çš„åˆå§‹åŒ–æ›¿æ¢äº†ï¼ï¼ï¼</p><p><strong>C++ä¸­çš„constå¿…é¡»åˆå§‹åŒ–</strong></p><hr><p><strong>constå’Œä¸€çº§ã€å¤šçº§æŒ‡é’ˆçš„ç»“åˆ</strong><br>constä¿®é¥°çš„é‡å¸¸å‡ºç°çš„é”™è¯¯æ˜¯ï¼š</p><p>å¸¸é‡ä¸èƒ½å†ä½œä¸ºå·¦å€¼ = ç›´æ¥ä¿®æ”¹å¸¸é‡çš„å€¼</p><p>ä¸èƒ½æŠŠå¸¸é‡çš„åœ°å€æ³„éœ²ç»™â€”ä¸ªæ™®é€šçš„æŒ‡é’ˆæˆ–è€…æ™®é€šçš„å¼•ç”¨å˜é‡ = é—´æ¥ä¿®æ”¹å¸¸é‡çš„</p><p>constå’Œä¸€çº§æŒ‡é’ˆçš„ç»“åˆ</p><p>c++çš„è¯­è¨€è§„èŒƒï¼š<strong>constä¿®é¥°çš„æ˜¯ç¦»å®ƒæœ€è¿‘çš„ç±»å‹</strong></p><p>const int *p = &amp;a; *p = 20 p = &amp;b<br>å¯ä»¥ä»»æ„æŒ‡å‘ä¸åŒçš„intç±»å‹çš„å†…å­˜ï¼Œä½†æ˜¯ä¸èƒ½é€šè¿‡æŒ‡é’ˆé—´æ¥ä¿®æ”¹æŒ‡å‘çš„å†…å­˜çš„å€¼</p><hr><p>è‹¥ä½ æƒ³è®©ä¸€ä¸ªå¸¸é‡åªè¯»ï¼Œé‚£ä½ åº”è¯¥æ˜ç¡®è¯´å‡ºå®ƒæ˜¯constå¸¸é‡ï¼Œå¯¹äºæŒ‡é’ˆæ¥è¯´ï¼Œæ›´æ˜¯å¦‚æ­¤ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> greeting[] = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="type">char</span>* p = greeting;                <span class="comment">// æŒ‡é’ˆå¯ä¿®æ”¹ï¼Œæ•°æ®å¯ä¿®æ”¹</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* p = greeting;          <span class="comment">// æŒ‡é’ˆå¯ä¿®æ”¹ï¼Œæ•°æ®ä¸å¯ä¿®æ”¹</span></span><br><span class="line"><span class="type">char</span> <span class="type">const</span>* p = greeting;          <span class="comment">// æŒ‡é’ˆå¯ä¿®æ”¹ï¼Œæ•°æ®ä¸å¯ä¿®æ”¹</span></span><br><span class="line"><span class="type">char</span>* <span class="type">const</span> p = greeting;          <span class="comment">// æŒ‡é’ˆä¸å¯ä¿®æ”¹ï¼Œæ•°æ®å¯ä¿®æ”¹</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> p = greeting;    <span class="comment">// æŒ‡é’ˆä¸å¯ä¿®æ”¹ï¼Œæ•°æ®ä¸å¯ä¿®æ”¹</span></span><br></pre></td></tr></table></figure><p>å¯¹äº STL è¿­ä»£å™¨ï¼Œåˆ†æ¸…ä½¿ç”¨<code>const</code>è¿˜æ˜¯<code>const_iterator</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> std::vector&lt;<span class="type">int</span>&gt;::iterator iter = vec.<span class="built_in">begin</span>();    <span class="comment">// è¿­ä»£å™¨ä¸å¯ä¿®æ”¹ï¼Œæ•°æ®å¯ä¿®æ”¹</span></span><br><span class="line">std::vector&lt;<span class="type">int</span>&gt;::const_iterator iter = vec.<span class="built_in">begin</span>();    <span class="comment">// è¿­ä»£å™¨å¯ä¿®æ”¹ï¼Œæ•°æ®ä¸å¯ä¿®æ”¹</span></span><br></pre></td></tr></table></figure><p>é¢å¯¹å‡½æ•°å£°æ˜æ—¶ï¼Œå¦‚æœä½ ä¸æƒ³è®©ä¸€ä¸ªå‡½æ•°çš„ç»“æœè¢«æ— æ„ä¹‰åœ°å½“ä½œå·¦å€¼ï¼Œè¯·ä½¿ç”¨constè¿”å›å€¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> Rational <span class="keyword">operator</span>*(<span class="type">const</span> Rational&amp; lhs, <span class="type">const</span> Rational&amp; rhs);</span><br></pre></td></tr></table></figure><p><strong>constæˆå‘˜å‡½æ•°ï¼š</strong></p><p>constæˆå‘˜å‡½æ•°å…è®¸æˆ‘ä»¬æ“æ§constå¯¹è±¡ï¼Œè¿™åœ¨ä¼ é€’å¸¸å¼•ç”¨æ—¶æ˜¾å¾—å°¤ä¸ºé‡è¦ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TextBlock</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>&amp; <span class="keyword">operator</span>[](std::<span class="type">size_t</span> position) <span class="type">const</span> &#123;    <span class="comment">// constå¯¹è±¡ä½¿ç”¨çš„é‡è½½</span></span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>&amp; <span class="keyword">operator</span>[](std::<span class="type">size_t</span> position) &#123;                <span class="comment">// non-constå¯¹è±¡ä½¿ç”¨çš„é‡è½½</span></span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string text;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œconstå’Œnon-constå¯¹è±¡éƒ½æœ‰å…¶å„è‡ªçš„é‡è½½ç‰ˆæœ¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">(<span class="type">const</span> Textblock&amp; ctb)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; ctb[<span class="number">0</span>];            <span class="comment">// è°ƒç”¨ const TextBlock::operator[]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨å¯¹å¾…constå¯¹è±¡çš„æ€åº¦é€šå¸¸æ˜¯ bitwise constnessï¼Œè€Œæˆ‘ä»¬åœ¨ç¼–å†™ç¨‹åºæ—¶é€šå¸¸é‡‡ç”¨ logical constnessï¼Œè¿™å°±æ„å‘³ç€ï¼Œåœ¨ç¡®ä¿å®¢æˆ·ç«¯ä¸ä¼šå¯Ÿè§‰çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¤ä¸ºconstå¯¹è±¡ä¸­çš„æŸäº›æˆå‘˜å˜é‡åº”å½“æ˜¯å…è®¸è¢«æ”¹å˜çš„ï¼Œä½¿ç”¨å…³é”®å­—<code>mutable</code>æ¥æ ‡è®°è¿™äº›æˆå‘˜å˜é‡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CTextBlock</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">std::<span class="type">size_t</span> <span class="title">Length</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">char</span>* pText;</span><br><span class="line">    <span class="keyword">mutable</span> std::<span class="type">size_t</span> textLength;</span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">bool</span> lengthIsValid;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">std::<span class="type">size_t</span> <span class="title">CTextBlock::Length</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!lengthIsValid) &#123;</span><br><span class="line">        textLength = std::<span class="built_in">strlen</span>(pText);    <span class="comment">// å¯ä»¥ä¿®æ”¹mutableæˆå‘˜å˜é‡</span></span><br><span class="line">        lengthIsValid = <span class="literal">true</span>;               <span class="comment">// å¯ä»¥ä¿®æ”¹mutableæˆå‘˜å˜é‡</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> textLength;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨é‡è½½constå’Œnon-constæˆå‘˜å‡½æ•°æ—¶ï¼Œéœ€è¦å°½å¯èƒ½é¿å…ä¹¦å†™é‡å¤çš„å†…å®¹ï¼Œè¿™ä¿ƒä½¿æˆ‘ä»¬å»è¿›è¡Œå¸¸é‡æ€§è½¬é™¤ã€‚åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”å½“é¿å…è½¬å‹çš„å‡ºç°ï¼Œä½†åœ¨æ­¤å¤„ä¸ºäº†å‡å°‘é‡å¤ä»£ç ï¼Œè½¬å‹æ˜¯é€‚å½“çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TextBlock</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>&amp; <span class="keyword">operator</span>[](std::<span class="type">size_t</span> position) <span class="type">const</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡è®¾è¿™é‡Œæœ‰éå¸¸å¤šçš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>&amp; <span class="keyword">operator</span>[](std::<span class="type">size_t</span> position) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;<span class="type">char</span>&amp;&gt;(<span class="built_in">static_cast</span>&lt;<span class="type">const</span> TextBlock&amp;&gt;(*<span class="keyword">this</span>)[position]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string text;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåå‘åšæ³•ï¼šä»¤constç‰ˆæœ¬è°ƒç”¨non-constç‰ˆæœ¬ä»¥é¿å…é‡å¤â€”â€”å¹¶ä¸è¢«å»ºè®®ï¼Œä¸€èˆ¬è€Œè¨€constç‰ˆæœ¬çš„é™åˆ¶æ¯”non-constç‰ˆæœ¬çš„é™åˆ¶æ›´å¤šï¼Œå› æ­¤è¿™æ ·åšä¼šå¸¦æ¥é£é™©ã€‚</p><h3 id="æ¡æ¬¾-4ï¼šç¡®å®šå¯¹è±¡åœ¨ä½¿ç”¨å‰å·²è¢«åˆå§‹åŒ–">æ¡æ¬¾ 4ï¼šç¡®å®šå¯¹è±¡åœ¨ä½¿ç”¨å‰å·²è¢«åˆå§‹åŒ–</h3><p>æ— åˆå€¼å¯¹è±¡åœ¨ C/C++ ä¸­å¹¿æ³›å­˜åœ¨ï¼Œå› æ­¤è¿™ä¸€æ¡æ¬¾å°±å°¤ä¸ºé‡è¦ã€‚åœ¨å®šä¹‰å®Œä¸€ä¸ªå¯¹è±¡åéœ€è¦å°½å¿«ä¸ºå®ƒèµ‹åˆå€¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* text = <span class="string">&quot;A C-style string&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> d;</span><br><span class="line">std::cin &gt;&gt; d;</span><br></pre></td></tr></table></figure><p>å¯¹äºç±»ä¸­çš„æˆå‘˜å˜é‡è€Œè¨€ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§å»ºè®®çš„æ–¹æ³•å®Œæˆåˆå§‹åŒ–å·¥ä½œï¼Œä¸€ç§æ˜¯ç›´æ¥åœ¨å®šä¹‰å¤„èµ‹åˆå€¼ï¼ˆsince C++11ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CTextBlock</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::<span class="type">size_t</span> textLength&#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">bool</span> lengthIsValid&#123; <span class="literal">false</span> &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§æ˜¯ä½¿ç”¨æ„é€ å‡½æ•°æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ABEntry::<span class="built_in">ABEntry</span>(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::string&amp; address,</span><br><span class="line">                 <span class="type">const</span> std::list&lt;PhoneNumber&gt;&amp; phones)</span><br><span class="line">    : <span class="built_in">theName</span>(name),</span><br><span class="line">      <span class="built_in">theAddress</span>(address),</span><br><span class="line">      <span class="built_in">thePhones</span>(phones),</span><br><span class="line">      <span class="built_in">numTimesConsulted</span>(<span class="number">0</span>) &#123;&#125;</span><br></pre></td></tr></table></figure><p>æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨ä¹Ÿå¯ä»¥ç•™ç©ºç”¨æ¥æ‰§è¡Œé»˜è®¤æ„é€ å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ABEntry::<span class="built_in">ABEntry</span>()</span><br><span class="line">    : <span class="built_in">theName</span>(),</span><br><span class="line">      <span class="built_in">theAddress</span>(),</span><br><span class="line">      <span class="built_in">thePhones</span>(),</span><br><span class="line">      <span class="built_in">numTimesConsulted</span>(<span class="number">0</span>) &#123;&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç±»ä¸­æˆå‘˜çš„åˆå§‹åŒ–å…·æœ‰æ¬¡åºæ€§ï¼Œè€Œè¿™æ¬¡åºä¸æˆå‘˜å˜é‡çš„å£°æ˜æ¬¡åºä¸€è‡´ï¼Œä¸æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨çš„æ¬¡åºæ— å…³ã€‚</p><blockquote><p>ç±»ä¸­æˆå‘˜çš„åˆå§‹åŒ–æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯å¼•ç”¨ç±»å‹å¿…é¡»åˆå§‹åŒ–ã€‚</p></blockquote><p><strong>é™æ€å¯¹è±¡çš„åˆå§‹åŒ–ï¼š</strong></p><p>C++ å¯¹äºå®šä¹‰äºä¸åŒç¼–è¯‘å•å…ƒå†…çš„å…¨å±€é™æ€å¯¹è±¡çš„åˆå§‹åŒ–ç›¸å¯¹æ¬¡åºå¹¶æ— æ˜ç¡®å®šä¹‰ï¼Œå› æ­¤ï¼Œä»¥ä¸‹ä»£ç å¯èƒ½ä¼šå‡ºç°ä½¿ç”¨æœªåˆå§‹åŒ–é™æ€å¯¹è±¡çš„æƒ…å†µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File 1</span></span><br><span class="line"><span class="keyword">extern</span> FileSystem tfs;</span><br><span class="line"></span><br><span class="line"><span class="comment">// File 2</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Directory</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Directory</span>() &#123;</span><br><span class="line">        FileSystem disk = tfs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Directory tempDir;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ æ— æ³•ç¡®ä¿ä½äºä¸åŒç¼–è¯‘å•å…ƒå†…çš„<code>tfs</code>ä¸€å®šåœ¨<code>tempDir</code>ä¹‹å‰åˆå§‹åŒ–å®Œæˆã€‚</p><p>è¿™ä¸ªé—®é¢˜çš„ä¸€ä¸ªæœ‰æ•ˆè§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨ <strong>Meyersâ€™ singleton</strong>ï¼Œå°†å…¨å±€é™æ€å¯¹è±¡è½¬åŒ–ä¸ºå±€éƒ¨é™æ€å¯¹è±¡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FileSystem&amp; <span class="title">tfs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> FileSystem fs;</span><br><span class="line">    <span class="keyword">return</span> fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Directory&amp; <span class="title">tempDir</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> Directory td;</span><br><span class="line">    <span class="keyword">return</span> td;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ‰‹æ³•çš„åŸºç¡€åœ¨äºï¼šC++ ä¿è¯ï¼Œå‡½æ•°å†…çš„å±€éƒ¨é™æ€å¯¹è±¡ä¼šåœ¨<strong>è¯¥å‡½æ•°è¢«è°ƒç”¨æœŸé—´</strong>å’Œ<strong>é¦–æ¬¡é‡ä¸Šè¯¥å¯¹è±¡ä¹‹å®šä¹‰å¼</strong>æ—¶è¢«åˆå§‹åŒ–ã€‚</p><p>å½“ç„¶ï¼Œè¿™ç§åšæ³•å¯¹äºå¤šçº¿ç¨‹æ¥è¯´å¹¶ä¸å…·æœ‰ä¼˜åŠ¿ï¼Œæœ€å¥½è¿˜æ˜¯åœ¨å•çº¿ç¨‹å¯åŠ¨é˜¶æ®µæ‰‹åŠ¨è°ƒç”¨å‡½æ•°å®Œæˆåˆå§‹åŒ–ã€‚</p><h2 id="ç¬¬äºŒç« ï¼šæ„é€ -ææ„-èµ‹å€¼è¿ç®—">ç¬¬äºŒç« ï¼šæ„é€ /ææ„/èµ‹å€¼è¿ç®—</h2><h3 id="æ¡æ¬¾-5ï¼šäº†è§£-C-é»˜é»˜ç¼–å†™å¹¶è°ƒç”¨å“ªäº›å‡½æ•°">æ¡æ¬¾ 5ï¼šäº†è§£ C++ é»˜é»˜ç¼–å†™å¹¶è°ƒç”¨å“ªäº›å‡½æ•°</h3><p>è¿™ä¸ªæ¡æ¬¾æˆ‘å°†ä¼šåœ¨å¯¹è±¡æ¨¡å‹ä¸­è¯¦ç»†è§£é‡Šã€‚</p><p>C++ ä¸­çš„ç©ºç±»å¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ç©ºç±»ï¼Œç¼–è¯‘å™¨ä¼šä¸ºå®ƒé¢„ç•™ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Empty</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Empty</span>() &#123; ... &#125;                           <span class="comment">// é»˜è®¤æ„é€ å‡½æ•°ï¼ˆæ²¡æœ‰ä»»ä½•æ„é€ å‡½æ•°æ—¶ï¼‰</span></span><br><span class="line">    <span class="built_in">Empty</span>(<span class="type">const</span> Empty&amp;) &#123; ... &#125;               <span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">Empty</span>(Empty&amp;&amp;) &#123; ... &#125;                    <span class="comment">// ç§»åŠ¨æ„é€ å‡½æ•° (since C++11)</span></span><br><span class="line">    ~<span class="built_in">Empty</span>() &#123; ... &#125;                          <span class="comment">// ææ„å‡½æ•°</span></span><br><span class="line">    </span><br><span class="line">    Empty&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Empty&amp;) &#123; ... &#125;    <span class="comment">// æ‹·è´èµ‹å€¼è¿ç®—ç¬¦</span></span><br><span class="line">    Empty&amp; <span class="keyword">operator</span>=(Empty&amp;&amp;) &#123; ... &#125;         <span class="comment">// ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ (since C++11)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å”¯æœ‰å½“è¿™äº›å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä»¬æ‰ä¼šçœŸæ­£è¢«ç¼–è¯‘å™¨åˆ›å»ºå‡ºæ¥ï¼Œä¸‹é¢ä»£ç å°†é€ æˆä¸Šè¿°æ¯ä¸€ä¸ªå‡½æ•°è¢«åˆ›å»ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Empty e1;                   <span class="comment">// é»˜è®¤æ„é€ å‡½æ•° &amp; ææ„å‡½æ•°</span></span><br><span class="line"><span class="function">Empty <span class="title">e2</span><span class="params">(e1)</span></span>;               <span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">Empty e3 = std::<span class="built_in">move</span>(e2);   <span class="comment">// ç§»åŠ¨æ„é€ å‡½æ•° (since C++11)</span></span><br><span class="line">e2 = e1;                    <span class="comment">// æ‹·è´èµ‹å€¼è¿ç®—ç¬¦</span></span><br><span class="line">e3 = std::<span class="built_in">move</span>(e1);         <span class="comment">// ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ (since C++11)</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦åªæœ‰åœ¨å…è®¸å­˜åœ¨æ—¶æ‰ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œæ¯”å¦‚ä»¥ä¸‹æƒ…å†µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NamedObject</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string&amp; nameValue;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥ç±»ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªstringå¼•ç”¨ç±»å‹ï¼Œç„¶è€Œå¼•ç”¨æ— æ³•æŒ‡å‘ä¸åŒå¯¹è±¡ï¼Œå› æ­¤ç¼–è¯‘å™¨ä¼šæ‹’ç»ä¸ºè¯¥ç±»åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œä»¥ä¸‹æƒ…å½¢ä¹Ÿä¼šå¯¼è‡´æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ä¸ä¼šè‡ªåŠ¨åˆ›å»ºï¼š</p><ol><li>ç±»ä¸­å«æœ‰constæˆå‘˜ã€‚</li><li>åŸºç±»ä¸­å«æœ‰privateçš„æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ã€‚</li></ol><h3 id="æ¡æ¬¾-6ï¼šè‹¥ä¸æƒ³ä½¿ç”¨ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„å‡½æ•°ï¼Œå°±è¯¥æ˜ç¡®æ‹’ç»">æ¡æ¬¾ 6ï¼šè‹¥ä¸æƒ³ä½¿ç”¨ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„å‡½æ•°ï¼Œå°±è¯¥æ˜ç¡®æ‹’ç»</h3><p>muduoç½‘ç»œåº“ä¸­noncopyableç±»çš„è®¾è®¡ï¼Œå¯ä»¥å­¦ä¹ ã€‚</p><p>åŸä¹¦ä¸­ä½¿ç”¨çš„åšæ³•æ˜¯å°†ä¸æƒ³ä½¿ç”¨çš„å‡½æ•°å£°æ˜ä¸ºprivateï¼Œä½†åœ¨ C++11 åæˆ‘ä»¬æœ‰äº†æ›´å¥½çš„åšæ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Uncopyable</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Uncopyable</span>(<span class="type">const</span> Uncopyable&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Uncopyable&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Uncopyable&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-7ï¼šä¸ºå¤šæ€åŸºç±»å£°æ˜è™šææ„å‡½æ•°">æ¡æ¬¾ 7ï¼šä¸ºå¤šæ€åŸºç±»å£°æ˜è™šææ„å‡½æ•°</h3><p><strong>é‡ç‚¹</strong>ï¼šåŸºç±»æŒ‡é’ˆæŒ‡å‘å †ä¸Šnewå‡ºæ¥çš„æ´¾ç”Ÿç±»å¯¹è±¡çš„æ—¶å€™,delete pbåŸºç±»æŒ‡é’ˆï¼Œå®ƒè°ƒç”¨ææ„å‡½æ•°çš„æ—¶å€™ï¼Œå¿…é¡»å‘ç”ŸåŠ¨æ€ç»‘å®šï¼Œè¦ä¸ç„¶å­ç±»çš„ææ„æ— æ³•è°ƒç”¨ã€‚</p><p>å½“æ´¾ç”Ÿç±»å¯¹è±¡ç»ç”±ä¸€ä¸ªåŸºç±»æŒ‡é’ˆè¢«åˆ é™¤ï¼Œè€Œè¯¥åŸºç±»æŒ‡é’ˆå¸¦ç€ä¸€ä¸ªéè™šææ„å‡½æ•°ï¼Œå…¶ç»“æœæ˜¯æœªå®šä¹‰çš„ï¼Œå¯èƒ½ä¼šæ— æ³•å®Œå…¨é”€æ¯æ´¾ç”Ÿç±»çš„æˆå‘˜ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚æ¶ˆé™¤è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•å°±æ˜¯å¯¹åŸºç±»ä½¿ç”¨è™šææ„å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Base</span>();</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ ä¸æƒ³è®©ä¸€ä¸ªç±»æˆä¸ºåŸºç±»ï¼Œé‚£ä¹ˆåœ¨ç±»ä¸­å£°æ˜è™šå‡½æ•°æ˜¯æ˜¯ä¸€ä¸ªåä¸»æ„ï¼Œå› ä¸ºé¢å¤–å­˜å‚¨çš„è™šè¡¨æŒ‡é’ˆä¼šä½¿ç±»çš„ä½“ç§¯å˜å¤§ã€‚</p><blockquote><p>åªè¦åŸºç±»çš„ææ„å‡½æ•°æ˜¯è™šå‡½æ•°ï¼Œé‚£ä¹ˆæ´¾ç”Ÿç±»çš„ææ„å‡½æ•°ä¸è®ºæ˜¯å¦ç”¨virtualå…³é”®å­—å£°æ˜ï¼Œéƒ½è‡ªåŠ¨æˆä¸ºè™šææ„å‡½æ•°ã€‚</p></blockquote><p>è™šææ„å‡½æ•°çš„è¿ä½œæ–¹å¼æ˜¯ï¼Œæœ€æ·±å±‚æ´¾ç”Ÿçš„é‚£ä¸ªç±»çš„ææ„å‡½æ•°æœ€å…ˆè¢«è°ƒç”¨ï¼Œç„¶åæ˜¯å…¶ä¸Šçš„åŸºç±»çš„ææ„å‡½æ•°è¢«ä¾æ¬¡è°ƒç”¨ã€‚</p><p>å¦‚æœä½ æƒ³å°†åŸºç±»ä½œä¸ºæŠ½è±¡ç±»ä½¿ç”¨ï¼Œä½†æ‰‹å¤´ä¸Šåˆæ²¡æœ‰åˆ«çš„è™šå‡½æ•°ï¼Œé‚£ä¹ˆå°†å®ƒçš„ææ„å‡½æ•°è®¾ä¸ºçº¯è™šå‡½æ•°æ˜¯ä¸€ä¸ªä¸é”™çš„æƒ³æ³•ã€‚è€ƒè™‘ä»¥ä¸‹æƒ…å½¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base</span>() = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½†è‹¥æ­¤æ—¶ä»è¯¥åŸºç±»ä¸­æ´¾ç”Ÿå‡ºæ–°çš„ç±»ï¼Œä¼šå‘ç”ŸæŠ¥é”™ï¼Œè¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨æ— æ³•æ‰¾åˆ°åŸºç±»çš„ææ„å‡½æ•°çš„å®ç°ã€‚å› æ­¤ï¼Œå³ä½¿æ˜¯çº¯è™šææ„å‡½æ•°ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ªå‡½æ•°ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Base::~<span class="built_in">Base</span>() &#123;&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…ä»¥ä¸‹å†™æ³•ä¹Ÿè¢«å…è®¸ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base</span>() = <span class="number">0</span> &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-8ï¼šåˆ«è®©å¼‚å¸¸é€ƒç¦»ææ„å‡½æ•°">æ¡æ¬¾ 8ï¼šåˆ«è®©å¼‚å¸¸é€ƒç¦»ææ„å‡½æ•°</h3><p>åœ¨ææ„å‡½æ•°ä¸­åå‡ºå¼‚å¸¸å¹¶ä¸è¢«ç¦æ­¢ï¼Œä½†ä¸ºäº†ç¨‹åºçš„å¯é æ€§ï¼Œåº”å½“æåŠ›é¿å…è¿™ç§è¡Œä¸ºã€‚</p><p>ä¸ºäº†å®ç° RAIIï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°†å¯¹è±¡çš„é”€æ¯æ–¹æ³•å°è£…åœ¨ææ„å‡½æ•°ä¸­ï¼Œå¦‚ä¸‹ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DBConn</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    ~<span class="built_in">DBConn</span>() &#123;</span><br><span class="line">        db.<span class="built_in">close</span>();    <span class="comment">// è¯¥å‡½æ•°å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    DBConnection db;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½†è¿™æ ·æˆ‘ä»¬å°±éœ€è¦åœ¨ææ„å‡½æ•°ä¸­å®Œæˆå¯¹å¼‚å¸¸çš„å¤„ç†ï¼Œä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§çš„åšæ³•ï¼š</p><p>ç¬¬ä¸€ç§ï¼šæ€æ­»ç¨‹åºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DBConn::~<span class="built_in">DBConn</span>() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; db.<span class="built_in">close</span>(); &#125;</span><br><span class="line">    <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">        <span class="comment">// è®°å½•è¿è¡Œæ—¥å¿—ï¼Œä»¥ä¾¿è°ƒè¯•</span></span><br><span class="line">        std::<span class="built_in">abort</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§ï¼šç›´æ¥åä¸‹å¼‚å¸¸ä¸åšå¤„ç†ï¼Œä½†è¿™ç§åšæ³•ä¸è¢«å»ºè®®ã€‚</p><p>ç¬¬ä¸‰ç§ï¼šé‡æ–°è®¾è®¡æ¥å£ï¼Œå°†å¼‚å¸¸çš„å¤„ç†äº¤ç»™å®¢æˆ·ç«¯å®Œæˆï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DBConn</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        db.<span class="built_in">close</span>();</span><br><span class="line">        closed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">DBConn</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (!closed) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                db.<span class="built_in">close</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">catch</span>(...) &#123;</span><br><span class="line">                <span class="comment">// å¤„ç†å¼‚å¸¸</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    DBConnection db;</span><br><span class="line">    <span class="type">bool</span> closed;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ–°è®¾è®¡çš„æ¥å£ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†<code>close</code>å‡½æ•°ä¾›å®¢æˆ·æ‰‹åŠ¨è°ƒç”¨ï¼Œè¿™æ ·å®¢æˆ·ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„æ„æ„¿å¤„ç†å¼‚å¸¸ï¼›è‹¥å®¢æˆ·å¿˜è®°æ‰‹åŠ¨è°ƒç”¨ï¼Œææ„å‡½æ•°æ‰ä¼šè‡ªåŠ¨è°ƒç”¨<code>close</code>å‡½æ•°ã€‚</p><p>å½“ä¸€ä¸ªæ“ä½œå¯èƒ½ä¼šæŠ›å‡ºéœ€è¦å®¢æˆ·å¤„ç†çš„å¼‚å¸¸æ—¶ï¼Œå°†å…¶æš´éœ²åœ¨æ™®é€šå‡½æ•°è€Œéææ„å‡½æ•°ä¸­æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚</p><h3 id="æ¡æ¬¾-9ï¼šç»ä¸åœ¨æ„é€ å’Œææ„è¿‡ç¨‹ä¸­è°ƒç”¨è™šå‡½æ•°">æ¡æ¬¾ 9ï¼šç»ä¸åœ¨æ„é€ å’Œææ„è¿‡ç¨‹ä¸­è°ƒç”¨è™šå‡½æ•°</h3><p><strong>é‡ç‚¹</strong>ï¼š</p><p>1.æ„é€ è°ƒç”¨ï¼š</p><p>æ„é€ è°ƒç”¨è™šå‡½æ•°ï¼Œé™æ€è°ƒç”¨ï¼ˆä»æ‰€åœ¨ç±»å¾€æ ¹ç±»å›æº¯ï¼Œæ‰¾åˆ°è™šå‡½æ•°ï¼Œå°±è°ƒç”¨å“ªä¸€ä¸ªï¼‰ã€é—®é¢˜ï¼šçˆ¶è°ƒç”¨å­å‡ºé—®é¢˜ï¼Œå› ä¸ºå­è¿˜æ²¡æ„é€ å‡ºæ¥ã€‘</p><p>éæ„é€ è°ƒç”¨è™šå‡½æ•°ï¼Œé€šè¿‡è™šè¡¨</p><p>2.ææ„è°ƒç”¨</p><p>ææ„çš„é¡ºåºï¼šå­åˆ°çˆ¶</p><p>åœ¨çˆ¶ç±»ä¸­çš„ææ„è°ƒç”¨è™šå‡½æ•°ï¼Œé‚£ä¹ˆå­ç±»å¯èƒ½é”€æ¯~</p><hr><p>åœ¨åˆ›å»ºæ´¾ç”Ÿç±»å¯¹è±¡æ—¶ï¼ŒåŸºç±»çš„æ„é€ å‡½æ•°æ°¸è¿œä¼šæ—©äºæ´¾ç”Ÿç±»çš„æ„é€ å‡½æ•°è¢«è°ƒç”¨ï¼Œè€ŒåŸºç±»çš„ææ„å‡½æ•°æ°¸è¿œä¼šæ™šäºæ´¾ç”Ÿç±»çš„ææ„å‡½æ•°è¢«è°ƒç”¨ã€‚</p><p>åœ¨æ´¾ç”Ÿç±»å¯¹è±¡çš„åŸºç±»æ„é€ å’Œææ„æœŸé—´ï¼Œå¯¹è±¡çš„ç±»å‹æ˜¯åŸºç±»è€Œéæ´¾ç”Ÿç±»ï¼Œå› æ­¤æ­¤æ—¶è°ƒç”¨è™šå‡½æ•°ä¼šè¢«ç¼–è¯‘å™¨è§£æè‡³åŸºç±»çš„è™šå‡½æ•°ç‰ˆæœ¬ï¼Œé€šå¸¸ä¸ä¼šå¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p><p>é—´æ¥è°ƒç”¨è™šå‡½æ•°æ˜¯ä¸€ä¸ªæ¯”è¾ƒéš¾ä»¥å‘ç°çš„å±é™©è¡Œä¸ºï¼Œéœ€è¦å°½é‡é¿å…ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Transaction</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Transaction</span>() &#123; <span class="built_in">Init</span>(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">LogTransaction</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">LogTransaction</span>();      <span class="comment">// æ­¤å¤„é—´æ¥è°ƒç”¨äº†è™šå‡½æ•°ï¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦åŸºç±»åœ¨æ„é€ æ—¶å°±å¾—çŸ¥æ´¾ç”Ÿç±»çš„æ„é€ ä¿¡æ¯ï¼Œæ¨èçš„åšæ³•æ˜¯åœ¨æ´¾ç”Ÿç±»çš„æ„é€ å‡½æ•°ä¸­å°†å¿…è¦çš„ä¿¡æ¯å‘ä¸Šä¼ é€’ç»™åŸºç±»çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Transaction</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Transaction</span><span class="params">(<span class="type">const</span> std::string&amp; logInfo)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LogTransaction</span><span class="params">(<span class="type">const</span> std::string&amp; logInfo)</span> <span class="type">const</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Transaction::<span class="built_in">Transaction</span>(<span class="type">const</span> std::string&amp; logInfo) &#123;</span><br><span class="line">    <span class="built_in">LogTransaction</span>(logInfo);                           <span class="comment">// æ›´æ”¹ä¸ºäº†éè™šå‡½æ•°è°ƒç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BuyTransaction</span> : <span class="keyword">public</span> Transaction &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BuyTransaction</span>(...)</span><br><span class="line">        : <span class="built_in">Transaction</span>(<span class="built_in">CreateLogString</span>(...)) &#123; ... &#125;    <span class="comment">// å°†ä¿¡æ¯ä¼ é€’ç»™åŸºç±»æ„é€ å‡½æ•°</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> std::string <span class="title">CreateLogString</span><span class="params">(...)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„æ­¤å¤„çš„<code>CreateLogString</code>æ˜¯ä¸€ä¸ªé™æ€æˆå‘˜å‡½æ•°ï¼Œè¿™æ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸ºé™æ€æˆå‘˜å‡½æ•°å¯ä»¥ç¡®ä¿ä¸ä¼šä½¿ç”¨æœªå®Œæˆåˆå§‹åŒ–çš„æˆå‘˜å˜é‡ã€‚</p><h3 id="æ¡æ¬¾-10ï¼šä»¤-operator-è¿”å›ä¸€ä¸ªæŒ‡å‘-this-çš„å¼•ç”¨">æ¡æ¬¾ 10ï¼šä»¤ operator= è¿”å›ä¸€ä¸ªæŒ‡å‘ *this çš„å¼•ç”¨</h3><p>é‡ç‚¹ï¼š</p><p>a=b=c</p><p>thisæ˜¯åœ°å€ï¼Œ*thisæ˜¯å¯¹è±¡ï¼Œè§£å¼•ç”¨ã€‚</p><hr><blockquote><p>å¼•ç”¨çŸ¥è¯†</p></blockquote><p>å¼•ç”¨å’ŒæŒ‡é’ˆåŒºåˆ«</p><ul><li><p>å¼•ç”¨æ˜¯ä¸€ç§æ›´å®‰å…¨çš„æŒ‡é’ˆã€‚</p></li><li><p>å¼•ç”¨æ˜¯å¿…é¡»åˆå§‹åŒ–çš„ï¼Œè€ŒæŒ‡é’ˆå¯ä»¥ä¸åˆå§‹åŒ–</p></li><li><p>å¼•ç”¨åªæœ‰ä¸€çº§å¼•ç”¨ï¼Œæ²¡æœ‰å¤šçº§å¼•ç”¨ï¼›æŒ‡é’ˆå¯ä»¥ä¸€çº§æŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥å¤šçº§æŒ‡é’ˆ</p></li><li><p>å®šä¹‰ä¸€ä¸ªå¼•ç”¨å˜é‡å’Œå®šä¹‰ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œå…¶æ±‡ç¼–æŒ‡ä»¤æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼›é€šè¿‡å¼•ç”¨å˜é‡ä¿®æ”¹æ‰€å¼•ç”¨å†…å­˜çš„å€¼ï¼Œå’Œè¿‡æŒ‡é’ˆè§£å¼•ç”¨ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜çš„å€¼ï¼Œå…¶åº•å±‚æŒ‡ä»¤ä¹Ÿæ˜¯ä¸€æ¨¡ä¸€æ ·çš„</p></li><li><p>å³å€¼å¼•ç”¨</p></li><li><p>int &amp;&amp;c = 20; ä¸“é—¨ç”¨æ¥å¼•ç”¨å³å€¼ç±»å‹ï¼ŒæŒ‡ä»¤ä¸Šï¼Œå¯ä»¥è‡ªåŠ¨äº§ç”Ÿä¸´æ—¶é‡ç„¶åç›´æ¥å¼•ç”¨ä¸´æ—¶é‡ c = 40;</p></li><li><p>å³å€¼å¼•ç”¨å˜é‡æœ¬èº«æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œåªèƒ½ç”¨å·¦å€¼å¼•ç”¨æ¥å¼•ç”¨å®ƒ</p></li><li><p>ä¸èƒ½ç”¨ä¸€ä¸ªå³å€¼å¼•ç”¨å˜é‡æ¥å¼•ç”¨ä¸€ä¸ªå·¦å€¼ã€‚</p></li></ul><hr><p>è™½ç„¶å¹¶ä¸å¼ºåˆ¶æ‰§è¡Œæ­¤æ¡æ¬¾ï¼Œä½†ä¸ºäº†å®ç°è¿é”èµ‹å€¼ï¼Œå¤§éƒ¨åˆ†æ—¶å€™åº”è¯¥è¿™æ ·åšï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>+=(<span class="type">const</span> Widget&amp; rhs) &#123;    <span class="comment">// è¿™ä¸ªæ¡æ¬¾é€‚ç”¨äº</span></span><br><span class="line">        ...                                    <span class="comment">// +=, -=, *= ç­‰ç­‰è¿ç®—ç¬¦</span></span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>=(<span class="type">int</span> rhs) &#123;               <span class="comment">// å³ä½¿å‚æ•°ç±»å‹ä¸æ˜¯ Widget&amp; ä¹Ÿé€‚ç”¨</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-11ï¼šåœ¨-operator-ä¸­å¤„ç†â€œè‡ªæˆ‘èµ‹å€¼â€">æ¡æ¬¾ 11ï¼šåœ¨ operator= ä¸­å¤„ç†â€œè‡ªæˆ‘èµ‹å€¼â€</h3><p>é‡ç‚¹ï¼šç‰¹åˆ¤ï¼Œå‡å°å¼€é”€</p><hr><p>è‡ªæˆ‘èµ‹å€¼æ˜¯åˆæ³•çš„æ“ä½œï¼Œä½†åœ¨ä¸€äº›æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„é”™è¯¯ï¼Œä¾‹å¦‚åœ¨å¤åˆ¶å †ä¸Šçš„èµ„æºæ—¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Widget&amp; <span class="keyword">operator</span>+=(<span class="type">const</span> Widget&amp; rhs) &#123;</span><br><span class="line">    <span class="keyword">delete</span> pRes;                          <span class="comment">// åˆ é™¤å½“å‰æŒæœ‰çš„èµ„æº</span></span><br><span class="line">    pRes = <span class="keyword">new</span> <span class="built_in">Resource</span>(*rhs.pRes);       <span class="comment">// å¤åˆ¶ä¼ å…¥çš„èµ„æº</span></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†è‹¥<code>rhs</code>å’Œ<code>*this</code>æŒ‡å‘çš„æ˜¯ç›¸åŒçš„å¯¹è±¡ï¼Œå°±ä¼šå¯¼è‡´è®¿é—®åˆ°å·²åˆ é™¤çš„æ•°æ®ã€‚</p><p>æœ€ç®€å•çš„è§£å†³æ–¹æ³•æ˜¯åœ¨æ‰§è¡Œåç»­è¯­å¥å‰å…ˆè¿›è¡Œ<strong>è¯åŒæµ‹è¯•ï¼ˆIdentity testï¼‰</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Widget&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Widget&amp; rhs) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == &amp;rhs) <span class="keyword">return</span> *<span class="keyword">this</span>;        <span class="comment">// è‹¥æ˜¯è‡ªæˆ‘èµ‹å€¼ï¼Œåˆ™ä¸åšä»»ä½•äº‹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> pRes;</span><br><span class="line">    pRes = <span class="keyword">new</span> <span class="built_in">Resource</span>(*rhs.pRes);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªå¸¸è§çš„åšæ³•æ˜¯åªå…³æ³¨å¼‚å¸¸å®‰å…¨æ€§ï¼Œè€Œä¸å…³æ³¨æ˜¯å¦è‡ªæˆ‘èµ‹å€¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Widget&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Widget&amp; rhs) &#123;</span><br><span class="line">    Resource* pOrigin = pRes;             <span class="comment">// å…ˆè®°ä½åŸæ¥çš„pResæŒ‡é’ˆ</span></span><br><span class="line">    pRes = <span class="keyword">new</span> <span class="built_in">Resource</span>(*rhs.pRes);       <span class="comment">// å¤åˆ¶ä¼ å…¥çš„èµ„æº</span></span><br><span class="line">    <span class="keyword">delete</span> pOrigin;                       <span class="comment">// åˆ é™¤åŸæ¥çš„èµ„æº</span></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»…ä»…æ˜¯é€‚å½“å®‰æ’è¯­å¥çš„é¡ºåºï¼Œå°±å¯ä»¥åšåˆ°ä½¿æ•´ä¸ªè¿‡ç¨‹å…·æœ‰å¼‚å¸¸å®‰å…¨æ€§ã€‚</p><p>è¿˜æœ‰ä¸€ç§å–å·§çš„åšæ³•æ˜¯ä½¿ç”¨ copy and swap æŠ€æœ¯ï¼Œè¿™ç§æŠ€æœ¯èªæ˜åœ°åˆ©ç”¨äº†æ ˆç©ºé—´ä¼šè‡ªåŠ¨é‡Šæ”¾çš„ç‰¹æ€§ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ææ„å‡½æ•°æ¥å®ç°èµ„æºçš„é‡Šæ”¾ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Widget&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Widget&amp; rhs) &#123;</span><br><span class="line">    Widget <span class="built_in">temp</span>(rhs);</span><br><span class="line">    std::<span class="built_in">swap</span>(*<span class="keyword">this</span>, temp);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°åšæ³•è¿˜å¯ä»¥å†™å¾—æ›´åŠ å·§å¦™ï¼Œå°±æ˜¯åˆ©ç”¨æŒ‰å€¼ä¼ å‚ï¼Œè‡ªåŠ¨è°ƒç”¨æ„é€ å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Widget&amp; <span class="keyword">operator</span>=(Widget rhs) &#123;</span><br><span class="line">    std::<span class="built_in">swap</span>(*<span class="keyword">this</span>, rhs);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-12ï¼šå¤åˆ¶å¯¹è±¡æ—¶å‹¿å¿˜å…¶æ¯ä¸€ä¸ªæˆåˆ†">æ¡æ¬¾ 12ï¼šå¤åˆ¶å¯¹è±¡æ—¶å‹¿å¿˜å…¶æ¯ä¸€ä¸ªæˆåˆ†</h3><p>è¿™ä¸ªæ¡æ¬¾æ­£å¦‚å…¶å­—é¢æ„æ€ï¼Œå½“ä½ å†³å®šæ‰‹åŠ¨å®ç°æ‹·è´æ„é€ å‡½æ•°æˆ–æ‹·è´èµ‹å€¼è¿ç®—ç¬¦æ—¶ï¼Œå¿˜è®°å¤åˆ¶ä»»ä½•ä¸€ä¸ªæˆå‘˜éƒ½å¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„é”™è¯¯ã€‚</p><p>å½“ä½¿ç”¨ç»§æ‰¿æ—¶ï¼Œç»§æ‰¿è‡ªåŸºç±»çš„æˆå‘˜å¾€å¾€å®¹æ˜“å¿˜è®°åœ¨æ´¾ç”Ÿç±»ä¸­å®Œæˆå¤åˆ¶ï¼Œå¦‚æœä½ çš„åŸºç±»æ‹¥æœ‰æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼Œåº”è¯¥è®°å¾—è°ƒç”¨å®ƒä»¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PriorityCustomer</span> : <span class="keyword">public</span> Customer &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">PriorityCustomer</span>(<span class="type">const</span> PriorityCustomer&amp; rhs);</span><br><span class="line">    PriorityCustomer&amp; <span class="keyword">operator</span>=(<span class="type">const</span> PriorityCustomer&amp; rhs);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> priority;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PriorityCustomer::<span class="built_in">PriorityCustomer</span>(<span class="type">const</span> PriorityCustomer&amp; rhs)</span><br><span class="line">    : <span class="built_in">Customer</span>(rhs),                <span class="comment">// è°ƒç”¨åŸºç±»çš„æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">      <span class="built_in">priority</span>(rhs.priority) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PriorityCustomer::PriorityCustomer&amp; <span class="keyword">operator</span>=(<span class="type">const</span> PriorityCustomer&amp; rhs) &#123;</span><br><span class="line">    Customer::<span class="keyword">operator</span>=(rhs);       <span class="comment">// è°ƒç”¨åŸºç±»çš„æ‹·è´èµ‹å€¼è¿ç®—ç¬¦</span></span><br><span class="line">    priority = rhs.priority;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œä¸è¦å°è¯•åœ¨æ‹·è´æ„é€ å‡½æ•°ä¸­è°ƒç”¨æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼Œæˆ–åœ¨æ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„å®ç°ä¸­è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Œä¸€ä¸ªåœ¨åˆå§‹åŒ–æ—¶ï¼Œä¸€ä¸ªåœ¨åˆå§‹åŒ–åï¼Œå®ƒä»¬çš„åŠŸç”¨æ˜¯ä¸åŒçš„ã€‚</p><h2 id="ç¬¬ä¸‰ç« ï¼šèµ„æºç®¡ç†">ç¬¬ä¸‰ç« ï¼šèµ„æºç®¡ç†</h2><h3 id="æ¡æ¬¾-13ï¼šä»¥å¯¹è±¡ç®¡ç†èµ„æº">æ¡æ¬¾ 13ï¼šä»¥å¯¹è±¡ç®¡ç†èµ„æº</h3><p>å¯¹äºä¼ ç»Ÿçš„å †èµ„æºç®¡ç†ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æˆå¯¹çš„<code>new</code>å’Œ<code>delete</code>ï¼Œè¿™æ ·è‹¥å¿˜è®°<code>delete</code>å°±ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åº”å°½å¯èƒ½ä»¥å¯¹è±¡ç®¡ç†èµ„æºï¼Œå¹¶é‡‡ç”¨RAIIï¼ˆResource Acquisition Is Initializeï¼Œèµ„æºå–å¾—æ—¶æœºä¾¿æ˜¯åˆå§‹åŒ–æ—¶æœºï¼‰ï¼Œè®©ææ„å‡½æ•°è´Ÿè´£èµ„æºçš„é‡Šæ”¾ã€‚</p><p>åŸä¹¦æ­¤å¤„å…³äºæ™ºèƒ½æŒ‡é’ˆçš„å†…å®¹å·²ç»è¿‡æ—¶ï¼Œåœ¨ C++11 ä¸­ï¼Œé€šè¿‡ä¸“ä¸€æ‰€æœ‰æƒæ¥ç®¡ç†RAIIå¯¹è±¡å¯ä»¥ä½¿ç”¨<code>std::unique_ptr</code>ï¼Œé€šè¿‡å¼•ç”¨è®¡æ•°æ¥ç®¡ç†RAIIå¯¹è±¡å¯ä»¥ä½¿ç”¨<code>std::shared_ptr</code>ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Investment* CreateInvestment();</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::unique_ptr&lt;Investment&gt; <span class="title">pUniqueInv1</span><span class="params">(CreateInvestment())</span></span>;</span><br><span class="line"><span class="function">std::unique_ptr&lt;Investment&gt; <span class="title">pUniqueInv2</span><span class="params">(std::move(pUniqueInv1))</span></span>;    <span class="comment">// è½¬ç§»èµ„æºæ‰€æœ‰æƒ</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::shared_ptr&lt;Investment&gt; <span class="title">pSharedInv1</span><span class="params">(CreateInvestment())</span></span>;</span><br><span class="line"><span class="function">std::shared_ptr&lt;Investment&gt; <span class="title">pSharedInv2</span><span class="params">(pSharedInv1)</span></span>;               <span class="comment">// å¼•ç”¨è®¡æ•°+1</span></span><br></pre></td></tr></table></figure><p>æ™ºèƒ½æŒ‡é’ˆé»˜è®¤ä¼šè‡ªåŠ¨deleteæ‰€æŒæœ‰çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºæ™ºèƒ½æŒ‡é’ˆæŒ‡å®šæ‰€ç®¡ç†å¯¹è±¡çš„é‡Šæ”¾æ–¹å¼ï¼ˆåˆ é™¤å™¨deleterï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// void GetRidOfInvestment(Investment*) &#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::unique_ptr&lt;Investment, <span class="title">decltype</span><span class="params">(GetRidOfInvestment)</span>*&gt; <span class="title">pUniqueInv</span><span class="params">(CreateInvestment(), GetRidOfInvestment)</span></span>;</span><br><span class="line"><span class="function">std::shared_ptr&lt;Investment&gt; <span class="title">pSharedInv</span><span class="params">(CreateInvestment(), GetRidOfInvestment)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-14ï¼šåœ¨èµ„æºç®¡ç†ç±»ä¸­å°å¿ƒæ‹·è´è¡Œä¸º">æ¡æ¬¾ 14ï¼šåœ¨èµ„æºç®¡ç†ç±»ä¸­å°å¿ƒæ‹·è´è¡Œä¸º</h3><p>æˆ‘ä»¬åº”è¯¥æ°¸è¿œä¿æŒè¿™æ ·çš„æ€è€ƒï¼šå½“ä¸€ä¸ªRAIIå¯¹è±¡è¢«å¤åˆ¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆäº‹ï¼Ÿ</p><p><strong>é€‰æ‹©ä¸€ï¼šç¦æ­¢å¤åˆ¶</strong></p><p>è®¸å¤šæ—¶å€™å…è®¸RAIIå¯¹è±¡è¢«å¤åˆ¶å¹¶ä¸åˆç†ï¼Œå¦‚æœç¡®æ˜¯å¦‚æ­¤ï¼Œé‚£ä¹ˆå°±è¯¥æ˜ç¡®ç¦æ­¢å¤åˆ¶è¡Œä¸ºï¼Œæ¡æ¬¾ 6 å·²ç»é˜è¿°äº†æ€ä¹ˆåšè¿™ä»¶äº‹ã€‚</p><p><strong>é€‰æ‹©äºŒï¼šå¯¹åº•å±‚èµ„æºç¥­å‡ºâ€œå¼•ç”¨è®¡æ•°æ³•â€</strong></p><p>æ­£å¦‚<code>std::shared_ptr</code>æ‰€åšçš„é‚£æ ·ï¼Œæ¯ä¸€æ¬¡å¤åˆ¶å¯¹è±¡å°±ä½¿å¼•ç”¨è®¡æ•°+1ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡ç¦»å¼€å®šä¹‰åŸŸå°±è°ƒç”¨ææ„å‡½æ•°ä½¿å¼•ç”¨è®¡æ•°-1ï¼Œç›´åˆ°å¼•ç”¨è®¡æ•°ä¸º0å°±å½»åº•é”€æ¯èµ„æºã€‚</p><p><strong>é€‰æ‹©ä¸‰ï¼šå¤åˆ¶åº•å±‚èµ„æº</strong></p><p>åœ¨å¤åˆ¶å¯¹è±¡çš„åŒæ—¶å¤åˆ¶åº•å±‚èµ„æºçš„è¡Œä¸ºåˆè¢«ç§°ä½œ<strong>æ·±æ‹·è´ï¼ˆDeep copyingï¼‰</strong>ï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆåœ¨å¤åˆ¶è¿™ä¸ªå¯¹è±¡æ—¶å°±ä¸èƒ½åªå¤åˆ¶æŒ‡é’ˆï¼Œä¹Ÿè¦å¤åˆ¶æŒ‡é’ˆæ‰€æŒ‡å‘çš„æ•°æ®ã€‚</p><p><strong>é€‰æ‹©å››ï¼šè½¬ç§»åº•å±‚èµ„æºçš„æ‰€æœ‰æƒ</strong></p><p>å’Œ<code>std::unique_ptr</code>çš„è¡Œä¸ºç±»ä¼¼ï¼Œæ°¸è¿œä¿æŒåªæœ‰ä¸€ä¸ªå¯¹è±¡æ‹¥æœ‰å¯¹èµ„æºçš„ç®¡ç†æƒï¼Œå½“éœ€è¦å¤åˆ¶å¯¹è±¡æ—¶è½¬ç§»èµ„æºçš„ç®¡ç†æƒã€‚</p><h3 id="æ¡æ¬¾-15ï¼šåœ¨èµ„æºç®¡ç†ç±»ä¸­æä¾›å¯¹åŸå§‹èµ„æºçš„è®¿é—®">æ¡æ¬¾ 15ï¼šåœ¨èµ„æºç®¡ç†ç±»ä¸­æä¾›å¯¹åŸå§‹èµ„æºçš„è®¿é—®</h3><p>å’Œæ‰€æœ‰çš„æ™ºèƒ½æŒ‡é’ˆä¸€æ ·ï¼ŒSTL ä¸­çš„æ™ºèƒ½æŒ‡é’ˆä¹Ÿæä¾›äº†å¯¹åŸå§‹èµ„æºçš„éšå¼è®¿é—®å’Œæ˜¾å¼è®¿é—®ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Investment* pRaw = pSharedInv.<span class="built_in">get</span>();    <span class="comment">// æ˜¾å¼è®¿é—®åŸå§‹èµ„æº</span></span><br><span class="line">Investment raw = *pSharedInv;           <span class="comment">// éšå¼è®¿é—®åŸå§‹èµ„æº</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨è®¾è®¡è‡ªå·±çš„èµ„æºç®¡ç†ç±»æ—¶ï¼Œä¹Ÿè¦è€ƒè™‘åœ¨æä¾›å¯¹åŸå§‹èµ„æºçš„è®¿é—®æ—¶ï¼Œæ˜¯ä½¿ç”¨æ˜¾å¼è®¿é—®è¿˜æ˜¯éšå¼è®¿é—®çš„æ–¹æ³•ï¼Œè¿˜æ˜¯ä¸¤è€…çš†å¯ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Font</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">FontHandle <span class="title">Get</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> handle; &#125;       <span class="comment">// æ˜¾å¼è½¬æ¢å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">FontHandle</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> handle; &#125;  <span class="comment">// éšå¼è½¬æ¢å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    FontHandle handle;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬è€Œè¨€æ˜¾å¼è½¬æ¢æ¯”è¾ƒå®‰å…¨ï¼Œä½†éšå¼è½¬æ¢å¯¹å®¢æˆ·æ¯”è¾ƒæ–¹ä¾¿ã€‚</p><h3 id="æ¡æ¬¾-16ï¼šæˆå¯¹ä½¿ç”¨-new-å’Œ-delete-æ—¶è¦é‡‡ç”¨ç›¸åŒå½¢å¼">æ¡æ¬¾ 16ï¼šæˆå¯¹ä½¿ç”¨ new å’Œ delete æ—¶è¦é‡‡ç”¨ç›¸åŒå½¢å¼</h3><blockquote><p>newå’Œdelete</p></blockquote><p>malloc å’Œ freeï¼Œç§°ä½œ c çš„åº“å‡½æ•°</p><p>new å’Œ deleteï¼Œç§°ä½œè¿ç®—ç¬¦</p><p>newä¸ä»…å¯ä»¥åšå†…å­˜å¼€è¾Ÿï¼Œè¿˜å¯ä»¥åšå†…å­˜åˆå§‹åŒ–æ“ä½œ</p><p>mallocå¼€è¾Ÿå†…å­˜å¤±è´¥ï¼Œæ˜¯é€šè¿‡è¿”å›å€¼å’Œnullptråšæ¯”è¾ƒï¼šè€Œnewå¼€è¾Ÿå†…å­˜å¤±è´¥ï¼Œæ˜¯é€šè¿‡æŠ›å‡ºbad_allocç±»å‹çš„å¼‚å¸¸æ¥åˆ¤æ–­çš„ã€‚</p><p>new å¯ä»¥è®¤ä¸ºæ˜¯ malloc + æ„é€ å‡½æ•°ï¼Œ delete å¯ä»¥è®¤ä¸ºæ˜¯ free + ææ„å‡½æ•°</p><hr><p><strong>é‡ç‚¹</strong>ï¼šä¸æˆå¯¹å‡ºç°æ˜¯é’ˆå¯¹å¯¹è±¡æ¥è¯´ï¼Œå†…ç½®ç±»å‹æ²¡æœ‰é—®é¢˜ã€‚</p><p>å› ä¸º[]çš„æ—¶å€™ï¼Œå†…å­˜ä¼šå¤šå¼€è¾Ÿä¸€æ®µç©ºé—´ä¿å­˜å¯¹è±¡ä¿¡æ¯ï¼Œæ¯”å¦‚ä¸ªæ•°</p><p>newå’Œdelete[]çš„ä¾‹å­ï¼šä¼šå¯¼è‡´å†…å­˜å¤šdelete</p><p>new[]å’Œdeleteçš„ä¾‹å­ï¼šdeleteåªåˆ é™¤æ‰ç¬¬ä¸€å¯¹è±¡ï¼Œå³è°ƒç”¨ç¬¬ä¸€ä¸ªå¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œä½†æ˜¯å¯¹è±¡æœ‰å¤šä¸ªï¼Œå› æ­¤ä¼šå­˜åœ¨é—®é¢˜ã€‚</p><hr><p>ä½¿ç”¨<code>new</code>æ¥åˆ†é…å•ä¸€å¯¹è±¡ï¼Œä½¿ç”¨<code>new[]</code>æ¥åˆ†é…å¯¹è±¡æ•°ç»„ï¼Œå¿…é¡»æ˜ç¡®å®ƒä»¬çš„è¡Œä¸ºå¹¶ä¸ä¸€è‡´ï¼Œåˆ†é…å¯¹è±¡æ•°ç»„æ—¶ä¼šé¢å¤–åœ¨å†…å­˜ä¸­è®°å½•â€œæ•°ç»„å¤§å°â€ï¼Œè€Œä½¿ç”¨<code>delete[]</code>ä¼šæ ¹æ®è®°å½•çš„æ•°ç»„å¤§å°å¤šæ¬¡è°ƒç”¨ææ„å‡½æ•°ï¼Œä½¿ç”¨<code>delete</code>åˆ™ä»…ä»…åªä¼šè°ƒç”¨ä¸€æ¬¡ææ„å‡½æ•°ã€‚å¯¹äºå•ä¸€å¯¹è±¡ä½¿ç”¨<code>delete[]</code>å…¶ç»“æœä¹Ÿæ˜¯æœªå®šä¹‰çš„ï¼Œç¨‹åºå¯èƒ½ä¼šè¯»å–è‹¥å¹²å†…å­˜å¹¶å°†å…¶é”™è¯¯åœ°è§£é‡Šä¸ºæ•°ç»„å¤§å°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>* array = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line"><span class="type">int</span>* object = <span class="keyword">new</span> <span class="type">int</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span>[] array;</span><br><span class="line"><span class="keyword">delete</span> object;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨<code>typedef</code>å®šä¹‰æ•°ç»„ç±»å‹ä¼šå¸¦æ¥é¢å¤–çš„é£é™©ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> std::string AddressLines[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">std::string* pal = <span class="keyword">new</span> AddressLines;    <span class="comment">// pal æ˜¯ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œè€Œéå•ä¸€å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> pal;                             <span class="comment">// è¡Œä¸ºæœªå®šä¹‰</span></span><br><span class="line"><span class="keyword">delete</span>[] pal;                           <span class="comment">// æ­£ç¡®</span></span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-17ï¼šä»¥ç‹¬ç«‹è¯­å¥å°†-newed-å¯¹è±¡ç½®å…¥æ™ºèƒ½æŒ‡é’ˆ">æ¡æ¬¾ 17ï¼šä»¥ç‹¬ç«‹è¯­å¥å°† newed å¯¹è±¡ç½®å…¥æ™ºèƒ½æŒ‡é’ˆ</h3><p><strong>é‡ç‚¹</strong>:è¿™ä¸ªæ¡æ¬¾ç»“åˆeffectivae modern c++å­¦ä¹ </p><p>åŸä¹¦æ­¤å¤„æ‰€è®²å·²è¿‡æ—¶ï¼Œç°åœ¨æ›´å¥½çš„åšæ³•æ˜¯ä½¿ç”¨<code>std::make_unique</code>å’Œ<code>std::make_shared</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> pUniqueInv = std::<span class="built_in">make_unique</span>&lt;Investment&gt;();    <span class="comment">// since C++14</span></span><br><span class="line"><span class="keyword">auto</span> pSharedInv = std::<span class="built_in">make_shared</span>&lt;Investment&gt;();    <span class="comment">// since C++11</span></span><br></pre></td></tr></table></figure><h2 id="ç¬¬å››ç« ï¼šè®¾è®¡ä¸å£°æ˜">ç¬¬å››ç« ï¼šè®¾è®¡ä¸å£°æ˜</h2><h3 id="æ¡æ¬¾-18ï¼šè®©æ¥å£å®¹æ˜“è¢«æ­£ç¡®ä½¿ç”¨ï¼Œä¸æ˜“è¢«è¯¯ç”¨">æ¡æ¬¾ 18ï¼šè®©æ¥å£å®¹æ˜“è¢«æ­£ç¡®ä½¿ç”¨ï¼Œä¸æ˜“è¢«è¯¯ç”¨</h3><ol><li>å¥½çš„æ¥å£å¾ˆå®¹æ˜“è¢«æ­£ç¡®ä½¿ç”¨ï¼Œä¸æ˜“è¢«è¯¯ç”¨ã€‚ä½ åº”åœ¨åœ¨ä½ çš„æ‰€æœ‰æ¥å£ä¸­åŠªåŠ›è¾¾æˆè¿™äº›æ€§è´¨ã€‚</li><li>â€œä¿ƒè¿›æ­£ç¡®ä½¿ç”¨â€çš„åŠæ³•åŒ…æ‹¬æ¥å£çš„ä¸€è‡´æ€§ï¼Œä»¥åŠä¸å†…ç½®ç±»å‹çš„è¡Œä¸ºå…¼å®¹ã€‚</li><li>â€œé˜»æ­¢è¯¯ç”¨â€çš„åŠæ³•åŒ…æ‹¬å»ºç«‹æ–°ç±»å‹ã€é™åˆ¶ç±»å‹ä¸Šçš„æ“ä½œï¼ŒæŸç¼šå¯¹è±¡å€¼ï¼Œä»¥åŠæ¶ˆé™¤å®¢æˆ·çš„èµ„æºç®¡ç†è´£ä»»ã€‚</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‰ä¸ªå‚æ•°ç±»å‹ç›¸åŒçš„å‡½æ•°å®¹æ˜“é€ æˆè¯¯ç”¨</span></span><br><span class="line">Data::<span class="built_in">Data</span>(<span class="type">int</span> month, <span class="type">int</span> day, <span class="type">int</span> year) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡é€‚å½“å®šä¹‰æ–°çš„ç±»å‹åŠ ä»¥é™åˆ¶ï¼Œé™ä½è¯¯ç”¨çš„å¯èƒ½æ€§</span></span><br><span class="line">Data::<span class="built_in">Data</span>(<span class="type">const</span> Month&amp; m, <span class="type">const</span> Day&amp; d, <span class="type">const</span> Year&amp; y) &#123; ... &#125;</span><br></pre></td></tr></table></figure><ol><li>å°½é‡ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Œé¿å…è·¨DLLçš„ new å’Œ deleteï¼Œä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆè‡ªå®šä¹‰åˆ é™¤å™¨æ¥è§£é™¤äº’æ–¥é”ï¼ˆmutexesï¼‰ã€‚</li></ol><h3 id="æ¡æ¬¾-19ï¼šè®¾è®¡-class-çŠ¹å¦‚è®¾è®¡-type">æ¡æ¬¾ 19ï¼šè®¾è®¡ class çŠ¹å¦‚è®¾è®¡ type</h3><p>å‡ ä¹åœ¨è®¾è®¡æ¯ä¸€ä¸ª class æ—¶ï¼Œéƒ½è¦é¢å¯¹å¦‚ä¸‹é—®é¢˜ï¼š</p><p><strong>æ–° type å¯¹è±¡åº”è¯¥å¦‚ä½•è¢«åˆ›å»ºå’Œé”€æ¯ï¼Ÿ</strong> è¿™ä¼šå½±å“åˆ°ç±»ä¸­æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ã€å†…å­˜åˆ†é…å’Œé‡Šæ”¾å‡½æ•°ï¼ˆ<code>operator new</code>ï¼Œ<code>operator new[]</code>ï¼Œ<code>operator delete</code>ï¼Œ<code>operator delete[]</code>ï¼‰çš„è®¾è®¡ã€‚</p><p><strong>å¯¹è±¡çš„åˆå§‹åŒ–å’Œèµ‹å€¼è¯¥æœ‰ä»€ä¹ˆæ ·çš„å·®åˆ«ï¼Ÿ</strong> è¿™ä¼šå½±å“åˆ°æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ä¹‹é—´è¡Œä¸ºçš„å·®å¼‚ã€‚</p><p><strong>æ–° type çš„å¯¹è±¡å¦‚æœè¢«æŒ‰å€¼ä¼ é€’ï¼Œæ„å‘³ç€ä»€ä¹ˆï¼Ÿ</strong> è¿™ä¼šå½±å“åˆ°æ‹·è´æ„é€ å‡½æ•°çš„å®ç°ã€‚</p><p><strong>ä»€ä¹ˆæ˜¯æ–° type çš„åˆæ³•å€¼ï¼Ÿ</strong> ä½ çš„ç±»ä¸­çš„æˆå‘˜å‡½æ•°å¿…é¡»å¯¹ç±»ä¸­æˆå‘˜å˜é‡çš„å€¼è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœä¸åˆæ³•å°±è¦å°½å¿«è§£å†³æˆ–æ˜ç¡®åœ°æŠ›å‡ºå¼‚å¸¸ã€‚</p><p><strong>ä½ çš„æ–° type éœ€è¦é…åˆæŸä¸ªç»§æ‰¿å›¾ç³»å—ï¼Ÿ</strong> ä½ çš„ç±»æ˜¯å¦å—åˆ°åŸºç±»è®¾è®¡åœ°æŸç¼šï¼Œæ˜¯å¦æ‹¥æœ‰è¯¥è¦†å†™åœ°è™šå‡½æ•°ï¼Œæ˜¯å¦å…è®¸è¢«ç»§æ‰¿ï¼ˆè‹¥ä¸æƒ³è¦è¢«ç»§æ‰¿ï¼Œåº”è¯¥å£°æ˜ä¸º<code>final</code>ï¼‰ã€‚</p><p><strong>ä»€ä¹ˆæ ·çš„è¿ç®—ç¬¦å’Œå‡½æ•°å¯¹æ­¤æ–° type è€Œè¨€æ˜¯åˆç†çš„ï¼Ÿ</strong> è¿™ä¼šå½±å“åˆ°ä½ å°†ä¸ºä½ çš„ç±»å£°æ˜å“ªäº›å‡½æ•°å’Œé‡è½½å“ªäº›è¿ç®—ç¬¦ã€‚</p><p><strong>ä»€ä¹ˆæ ·çš„æ ‡å‡†å‡½æ•°åº”è¯¥è¢«é©³å›ï¼Ÿ</strong> è¿™ä¼šå½±å“åˆ°ä½ å°†å“ªäº›æ ‡å‡†å‡½æ•°å£°æ˜ä¸º<code>= delete</code>ã€‚</p><p><strong>è°è¯¥å–ç”¨æ–° type çš„æˆå‘˜ï¼Ÿ</strong> è¿™ä¼šå½±å“åˆ°ä½ å°†ç±»ä¸­å“ªäº›æˆå‘˜è®¾ä¸º publicï¼Œprivate æˆ– protectedï¼Œä¹Ÿå°†å½±å“åˆ°å‹å…ƒç±»å’Œå‹å…ƒå‡½æ•°çš„è®¾ç½®ã€‚</p><p><strong>ä»€ä¹ˆæ˜¯æ–° type çš„â€œæœªå£°æ˜æ¥å£â€ï¼Ÿ</strong> ä¸ºæœªå£°æ˜æ¥å£æä¾›æ•ˆç‡ã€å¼‚å¸¸å®‰å…¨æ€§ä»¥åŠèµ„æºè¿ç”¨ä¸Šçš„ä¿è¯ï¼Œå¹¶åœ¨å®ç°ä»£ç ä¸­åŠ ä¸Šç›¸åº”çš„çº¦æŸæ¡ä»¶ã€‚</p><p><strong>ä½ çš„æ–° type æœ‰å¤šä¹ˆä¸€èˆ¬åŒ–ï¼Ÿ</strong> å¦‚æœä½ æƒ³è¦ä¸€ç³»åˆ—æ–° type å®¶æ—ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘æ¨¡æ¿ç±»ã€‚</p><h3 id="æ¡æ¬¾-20ï¼šå®ä»¥æŒ‰å¸¸å¼•ç”¨ä¼ å‚æ›¿æ¢æŒ‰å€¼ä¼ å‚">æ¡æ¬¾ 20ï¼šå®ä»¥æŒ‰å¸¸å¼•ç”¨ä¼ å‚æ›¿æ¢æŒ‰å€¼ä¼ å‚</h3><p>å½“ä½¿ç”¨æŒ‰å€¼ä¼ å‚æ—¶ï¼Œç¨‹åºä¼šè°ƒç”¨å¯¹è±¡çš„æ‹·è´æ„é€ å‡½æ•°æ„å»ºä¸€ä¸ªåœ¨å‡½æ•°å†…ä½œç”¨çš„å±€éƒ¨å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„å¼€é”€å¯èƒ½ä¼šè¾ƒä¸ºæ˜‚è´µã€‚å¯¹äºä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰ç±»å‹ï¼Œä½¿ç”¨æŒ‰å¸¸å¼•ç”¨ä¼ å‚æ˜¯è¾ƒä¸ºæ¨èçš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ValidateStudent</span><span class="params">(<span class="type">const</span> Student&amp; s)</span></span>;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ²¡æœ‰ä»»ä½•æ–°å¯¹è±¡è¢«åˆ›å»ºï¼Œè¿™ç§ä¼ å‚æ–¹å¼ä¸ä¼šè°ƒç”¨ä»»ä½•æ„é€ å‡½æ•°æˆ–ææ„å‡½æ•°ï¼Œæ‰€ä»¥æ•ˆç‡æ¯”æŒ‰å€¼ä¼ å‚é«˜å¾—å¤šã€‚</p><p>ä½¿ç”¨æŒ‰å¼•ç”¨ä¼ å‚ä¹Ÿå¯ä»¥é¿å…<strong>å¯¹è±¡åˆ‡ç‰‡ï¼ˆObject slicingï¼‰</strong> çš„é—®é¢˜ï¼Œå‚è€ƒä»¥ä¸‹ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Window</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">std::string <span class="title">GetName</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Display</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WindowWithScrollBars</span> : <span class="keyword">public</span> Window &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Display</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„ä¸€ä¸ª<code>WindowWithScrollBars</code>ç±»ç»§æ‰¿è‡ª<code>Window</code>åŸºç±»ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintNameAndDisplay</span><span class="params">(Window w)</span> </span>&#123;    <span class="comment">// æŒ‰å€¼ä¼ å‚ï¼Œä¼šå‘ç”Ÿå¯¹è±¡åˆ‡ç‰‡</span></span><br><span class="line">    std::cout &lt;&lt; w.<span class="built_in">GetName</span>();</span><br><span class="line">    w.<span class="built_in">Display</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„åœ¨ä¼ å‚æ—¶ï¼Œè°ƒç”¨äº†åŸºç±»<code>Window</code>çš„æ‹·è´æ„é€ å‡½æ•°è€Œéæ´¾ç”Ÿç±»çš„æ‹·è´æ„é€ å‡½æ•°ï¼Œå› æ­¤åœ¨å‡½æ•°ç§ä½¿ç”¨çš„æ˜¯ä¸€ä¸ª<code>Window</code>å¯¹è±¡ï¼Œè°ƒç”¨è™šå‡½æ•°æ—¶ä¹Ÿåªèƒ½è°ƒç”¨åˆ°åŸºç±»çš„è™šå‡½æ•°<code>Window::Display</code>ã€‚</p><p>ç”±äºæŒ‰å¼•ç”¨ä¼ é€’ä¸ä¼šåˆ›å»ºæ–°å¯¹è±¡ï¼Œè¿™ä¸ªé—®é¢˜å°±èƒ½å¾—åˆ°é¿å…ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintNameAndDisplay</span><span class="params">(<span class="type">const</span> Window&amp; w)</span> </span>&#123; <span class="comment">// å‚æ•°ä¸ä¼šè¢«åˆ‡ç‰‡</span></span><br><span class="line">    std::cout &lt;&lt; w.<span class="built_in">GetName</span>();</span><br><span class="line">    w.<span class="built_in">Display</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¹¶éæ°¸è¿œéƒ½ä½¿ç”¨æŒ‰å¼•ç”¨ä¼ å‚ï¼Œå¯¹äºå†…ç½®ç±»å‹ã€STLçš„è¿­ä»£å™¨å’Œå‡½æ•°å¯¹è±¡ï¼Œæˆ‘ä»¬è®¤ä¸ºä½¿ç”¨æŒ‰å€¼ä¼ å‚æ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚</p><h3 id="æ¡æ¬¾-21ï¼šå¿…é¡»è¿”å›å¯¹è±¡æ—¶ï¼Œåˆ«å¦„æƒ³è¿”å›å…¶å¼•ç”¨">æ¡æ¬¾ 21ï¼šå¿…é¡»è¿”å›å¯¹è±¡æ—¶ï¼Œåˆ«å¦„æƒ³è¿”å›å…¶å¼•ç”¨</h3><p><strong>è¿”å›ä¸€ä¸ªæŒ‡å‘å‡½æ•°å†…éƒ¨å±€éƒ¨å˜é‡çš„å¼•ç”¨æ˜¯ä¸¥é‡çš„é”™è¯¯ï¼Œå› ä¸ºå±€éƒ¨å˜é‡åœ¨ç¦»å¼€å‡½æ•°æ—¶å°±è¢«é”€æ¯äº†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘å±€éƒ¨é™æ€å˜é‡çš„å¼•ç”¨ä¹Ÿæ˜¯ä¸è¢«æ¨èçš„</strong>ã€‚</p><p>å°½ç®¡è¿”å›å¯¹è±¡ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°äº§ç”Ÿå¼€é”€ï¼Œä½†è¿™å¼€é”€æ¯”èµ·å‡ºé”™è€Œè¨€å¾®ä¸è¶³é“ã€‚</p><h3 id="æ¡æ¬¾-22ï¼šå°†æˆå‘˜å˜é‡å£°æ˜ä¸º-private">æ¡æ¬¾ 22ï¼šå°†æˆå‘˜å˜é‡å£°æ˜ä¸º private</h3><p>å‡ºäºå¯¹å°è£…æ€§çš„è€ƒè™‘ï¼Œåº”è¯¥å°½å¯èƒ½åœ°éšè—ç±»ä¸­çš„æˆå‘˜å˜é‡ï¼Œå¹¶é€šè¿‡å¯¹å¤–æš´éœ²å‡½æ•°æ¥å£æ¥å®ç°å¯¹æˆå‘˜å˜é‡çš„è®¿é—®ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AccessLevels</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">GetReadOnly</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> readOnly; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetReadWrite</span><span class="params">(<span class="type">int</span> value)</span> </span>&#123; readWrite = value; &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">GetReadWrite</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> readWrite; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetWriteOnly</span><span class="params">(<span class="type">int</span> value)</span> </span>&#123; writeOnly = value; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> noAccess;</span><br><span class="line">    <span class="type">int</span> readOnly;</span><br><span class="line">    <span class="type">int</span> readWrite;</span><br><span class="line">    <span class="type">int</span> writeOnly;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸ºæˆå‘˜å˜é‡æä¾› getter å’Œ setter å‡½æ•°ï¼Œæˆ‘ä»¬å°±èƒ½é¿å…å®¢æˆ·åšå‡ºå†™å…¥åªè¯»å˜é‡æˆ–è¯»å–åªå†™å˜é‡è¿™æ ·ä¸è¢«å…è®¸çš„æ“ä½œã€‚</p><p>å°†æˆå‘˜å˜é‡éšè—åœ¨å‡½æ•°æ¥å£çš„èƒŒåï¼Œå¯ä»¥ä¸ºâ€œæ‰€æœ‰å¯èƒ½çš„å®ç°â€æä¾›å¼¹æ€§ã€‚ä¾‹å¦‚è¿™å¯ä½¿å¾—åœ¨æˆå‘˜å˜é‡è¢«è¯»æˆ–å†™æ—¶è½»æ¾é€šçŸ¥å…¶å®ƒå¯¹è±¡ï¼Œå¯ä»¥éªŒè¯ç±»çš„çº¦æŸæ¡ä»¶ä»¥åŠå‡½æ•°çš„æå‰å’Œäº‹åçŠ¶æ€ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ‰§è¡ŒåŒæ­¥æ§åˆ¶â€¦â€¦</p><p><code>protected</code>å’Œ<code>public</code>ä¸€æ ·ï¼Œéƒ½ä¸è¯¥è¢«ä¼˜å…ˆè€ƒè™‘ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªpublicæˆå‘˜å˜é‡ï¼Œæœ€ç»ˆå–æ¶ˆäº†å®ƒï¼Œé‚£ä¹ˆæ‰€æœ‰ä½¿ç”¨å®ƒçš„å®¢æˆ·ä»£ç éƒ½å°†è¢«ç ´åï¼›å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªprotectedæˆå‘˜å˜é‡ï¼Œæœ€ç»ˆå–æ¶ˆäº†å®ƒï¼Œé‚£ä¹ˆæ‰€æœ‰ä½¿ç”¨å®ƒçš„æ´¾ç”Ÿç±»éƒ½å°†è¢«ç ´åã€‚</p><p>ç»¼åˆä»¥ä¸Šè®¨è®ºï¼Œåœ¨ç±»ä¸­åº”å½“å°†æˆå‘˜å˜é‡ä¼˜å…ˆå£°æ˜ä¸º privateã€‚</p><h3 id="æ¡æ¬¾-23ï¼šå®ä»¥éæˆå‘˜ã€éå‹å…ƒå‡½æ•°æ›¿æ¢æˆå‘˜å‡½æ•°">æ¡æ¬¾ 23ï¼šå®ä»¥éæˆå‘˜ã€éå‹å…ƒå‡½æ•°æ›¿æ¢æˆå‘˜å‡½æ•°</h3><p>å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªç±»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WebBrowser</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ClearCache</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ClearHistory</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">RemoveCookies</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦ä¸€æ¬¡æ€§è°ƒç”¨è¿™ä¸‰ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆéœ€è¦é¢å¤–æä¾›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClearEverything</span><span class="params">(WebBrowser&amp; wb)</span> </span>&#123;</span><br><span class="line">    wb.<span class="built_in">ClearCache</span>();</span><br><span class="line">    wb.<span class="built_in">ClearHistory</span>();</span><br><span class="line">    wb.<span class="built_in">RemoveCookies</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œè™½ç„¶æˆå‘˜å‡½æ•°å’Œéæˆå‘˜å‡½æ•°éƒ½å¯ä»¥å®Œæˆæˆ‘ä»¬çš„ç›®æ ‡ï¼Œä½†æ­¤å¤„æ›´å»ºè®®ä½¿ç”¨éæˆå‘˜å‡½æ•°ï¼Œè¿™æ˜¯ä¸ºäº†éµå®ˆä¸€ä¸ªåŸåˆ™ï¼š<strong>è¶Šå°‘çš„ä»£ç å¯ä»¥è®¿é—®æ•°æ®ï¼Œæ•°æ®çš„å°è£…æ€§å°±è¶Šå¼º</strong>ã€‚æ­¤å¤„çš„<code>ClearEverything</code>å‡½æ•°ä»…ä»…æ˜¯è°ƒç”¨äº†<code>WebBrowser</code>çš„ä¸‰ä¸ªpublicæˆå‘˜å‡½æ•°ï¼Œè€Œå¹¶æ²¡æœ‰ä½¿ç”¨åˆ°<code>WebBrowser</code>å†…éƒ¨çš„privateæˆå‘˜ï¼Œå› æ­¤æ²¡æœ‰å¿…è¦è®©å…¶ä¹Ÿæ‹¥æœ‰è®¿é—®ç±»ä¸­privateæˆå‘˜çš„èƒ½åŠ›ã€‚</p><p>è¿™ä¸ªåŸåˆ™å¯¹äºå‹å…ƒå‡½æ•°ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œå› ä¸ºå‹å…ƒå‡½æ•°å’Œæˆå‘˜å‡½æ•°æ‹¥æœ‰ç›¸åŒçš„æƒåŠ›ï¼Œæ‰€ä»¥åœ¨èƒ½ä½¿ç”¨éæˆå‘˜å‡½æ•°å®Œæˆä»»åŠ¡çš„æƒ…å†µä¸‹ï¼Œå°±ä¸è¦ä½¿ç”¨å‹å…ƒå‡½æ•°å’Œæˆå‘˜å‡½æ•°ã€‚</p><p>å¦‚æœä½ è§‰å¾—ä¸€ä¸ªå…¨å±€å‡½æ•°å¹¶ä¸è‡ªç„¶ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘å°†<code>ClearEverything</code>å‡½æ•°æ”¾åœ¨å·¥å…·ç±»ä¸­å……å½“é™æ€æˆå‘˜å‡½æ•°ï¼Œæˆ–ä¸<code>WebBrowser</code>æ”¾åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> WebBrowserStuff &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">WebBrowser</span> &#123; ... &#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ClearEverything</span><span class="params">(WebBrowser&amp; wb)</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-24ï¼šè‹¥æ‰€æœ‰å‚æ•°çš†éœ€ç±»å‹è½¬æ¢ï¼Œè¯·ä¸ºæ­¤é‡‡ç”¨éæˆå‘˜å‡½æ•°">æ¡æ¬¾ 24ï¼šè‹¥æ‰€æœ‰å‚æ•°çš†éœ€ç±»å‹è½¬æ¢ï¼Œè¯·ä¸ºæ­¤é‡‡ç”¨éæˆå‘˜å‡½æ•°</h3><p>ç°åœ¨æˆ‘ä»¬æ‰‹å¤´ä¸Šæ‹¥æœ‰ä¸€ä¸ª<code>Rational</code>ç±»ï¼Œå¹¶ä¸”å®ƒå¯ä»¥å’Œ<code>int</code>éšå¼è½¬æ¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rational</span>(<span class="type">int</span> numerator = <span class="number">0</span>, <span class="type">int</span> denominator = <span class="number">1</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦é‡è½½ä¹˜æ³•è¿ç®—ç¬¦æ¥å®ç°<code>Rational</code>å¯¹è±¡ä¹‹é—´çš„ä¹˜æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">const</span> Rational <span class="keyword">operator</span>*(<span class="type">const</span> Rational&amp; rhs) <span class="type">const</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å°†è¿ç®—ç¬¦é‡è½½æ”¾åœ¨ç±»ä¸­æ˜¯è¡Œå¾—é€šçš„ï¼Œè‡³å°‘å¯¹äº<code>Rational</code>å¯¹è±¡æ¥è¯´æ˜¯å¦‚æ­¤ã€‚ä½†å½“æˆ‘ä»¬è€ƒè™‘æ··åˆè¿ç®—æ—¶ï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Rational <span class="title">oneEight</span><span class="params">(<span class="number">1</span>, <span class="number">8</span>)</span></span>;</span><br><span class="line"><span class="function">Rational <span class="title">oneHalf</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line">Rational result = oneHalf / oneEight;</span><br><span class="line"></span><br><span class="line">result = oneHalf * <span class="number">2</span>;    <span class="comment">// æ­£ç¡®</span></span><br><span class="line">result = <span class="number">2</span> * oneHalf;    <span class="comment">// æŠ¥é”™</span></span><br></pre></td></tr></table></figure><p>å‡å¦‚å°†ä¹˜æ³•è¿ç®—ç¬¦å†™æˆå‡½æ•°å½¢å¼ï¼Œé”™è¯¯çš„åŸå› å°±ä¸€ç›®äº†ç„¶äº†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = oneHalf.<span class="keyword">operator</span>*(<span class="number">2</span>);    <span class="comment">// æ­£ç¡®</span></span><br><span class="line">result = <span class="number">2.</span><span class="keyword">operator</span>*(oneHalf);    <span class="comment">// æŠ¥é”™</span></span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨<code>operator*</code>æ—¶ï¼Œ<code>int</code>ç±»å‹çš„å˜é‡ä¼šéšå¼è½¬æ¢ä¸º<code>Rational</code>å¯¹è±¡ï¼Œå› æ­¤ç”¨<code>Rational</code>å¯¹è±¡ä¹˜ä»¥<code>int</code>å¯¹è±¡æ˜¯åˆæ³•çš„ï¼Œä½†åè¿‡æ¥åˆ™ä¸æ˜¯å¦‚æ­¤ã€‚</p><p>æ‰€ä»¥ï¼Œä¸ºäº†é¿å…è¿™ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬åº”å½“å°†è¿ç®—ç¬¦é‡è½½æ”¾åœ¨ç±»å¤–ï¼Œä½œä¸ºéæˆå‘˜å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> Rational <span class="keyword">operator</span>*(<span class="type">const</span> Rational&amp; lhs, <span class="type">const</span> Rational&amp; rhs);</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-25ï¼šè€ƒè™‘å†™å‡ºä¸€ä¸ªä¸æŠ›å¼‚å¸¸çš„swapå‡½æ•°">æ¡æ¬¾ 25ï¼šè€ƒè™‘å†™å‡ºä¸€ä¸ªä¸æŠ›å¼‚å¸¸çš„swapå‡½æ•°</h3><p>ç”±äº<code>std::swap</code>å‡½æ•°åœ¨ C++11 åæ”¹ä¸ºäº†ç”¨<code>std::move</code>å®ç°ï¼Œå› æ­¤å‡ ä¹å·²ç»æ²¡æœ‰æ€§èƒ½çš„ç¼ºé™·ï¼Œä¹Ÿä¸å†æœ‰åƒåŸä¹¦ä¸­æ‰€è¯´çš„ä¸ºè‡ªå®šä¹‰ç±»å‹å»è‡ªå·±å®ç°çš„å¿…è¦ã€‚ä¸è¿‡åŸä¹¦ä¸­é€éœ²çš„æ€æƒ³è¿˜æ˜¯å€¼å¾—ä¸€å­¦çš„ã€‚</p><p>å¦‚æœæƒ³ä¸ºè‡ªå®šä¹‰ç±»å‹å®ç°è‡ªå·±çš„swapæ–¹æ³•ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ¨¡æ¿å…¨ç‰¹åŒ–ï¼Œå¹¶ä¸”è¿™ç§åšæ³•æ˜¯è¢« STL å…è®¸çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(Widget&amp; other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">using</span> std::swap;</span><br><span class="line">        <span class="built_in">swap</span>(pImpl, other.pImpl);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    WidgetImpl* pImpl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> std &#123;</span><br><span class="line">    <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="type">void</span> <span class="built_in">swap</span>&lt;Widget&gt;(Widget&amp; a, Widget&amp; b) &#123;</span><br><span class="line">        a.<span class="built_in">swap</span>(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œç”±äºå¤–éƒ¨å‡½æ•°å¹¶ä¸èƒ½ç›´æ¥è®¿é—®<code>Widget</code>çš„privateæˆå‘˜å˜é‡ï¼Œå› æ­¤æˆ‘ä»¬å…ˆæ˜¯åœ¨ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ª public æˆå‘˜å‡½æ•°ï¼Œå†ç”±<code>std::swap</code>å»è°ƒç”¨è¿™ä¸ªæˆå‘˜å‡½æ•°ã€‚</p><p>ç„¶è€Œè‹¥<code>Widget</code>å’Œ<code>WidgetImpl</code>æ˜¯ç±»æ¨¡æ¿ï¼Œæƒ…å†µå°±æ²¡æœ‰è¿™ä¹ˆç®€å•äº†ï¼Œå› ä¸º C++ ä¸æ”¯æŒå‡½æ•°æ¨¡æ¿åç‰¹åŒ–ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨é‡è½½çš„æ–¹å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> std &#123;</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">swap</span><span class="params">(Widget&lt;T&gt;&amp; a, Widget&lt;T&gt;&amp; b)</span> </span>&#123;</span><br><span class="line">        a.<span class="built_in">swap</span>(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†å¾ˆæŠ±æ­‰ï¼Œè¿™ç§åšæ³•æ˜¯è¢« STL ç¦æ­¢çš„ï¼Œå› ä¸ºè¿™æ˜¯åœ¨è¯•å›¾å‘ STL ä¸­æ·»åŠ æ–°çš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½é€€è€Œæ±‚å…¶æ¬¡ï¼Œåœ¨å…¶å®ƒå‘½åç©ºé—´ä¸­å®šä¹‰æ–°çš„swapå‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> WidgetStuff &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Widget</span> &#123; ... &#125;;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;<span class="number">3</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(Widget&lt;T&gt;&amp; a, Widget&lt;T&gt;&amp; b)</span> </span>&#123;</span><br><span class="line">        a.<span class="built_in">swap</span>(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¸Œæœ›åœ¨å¯¹è‡ªå®šä¹‰å¯¹è±¡è¿›è¡Œæ“ä½œæ—¶æ‰¾åˆ°æ­£ç¡®çš„swapå‡½æ•°é‡è½½ç‰ˆæœ¬ï¼Œè¿™æ—¶å€™å¦‚æœå†å†™æˆ<code>std::swap</code>ï¼Œå°±ä¼šå¼ºåˆ¶ä½¿ç”¨ STL ä¸­çš„swapå‡½æ•°ï¼Œæ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå› æ­¤éœ€è¦æ”¹å†™æˆï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> std::swap;</span><br><span class="line"><span class="built_in">swap</span>(obj1, obj2);</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼ŒC++ åç§°æŸ¥æ‰¾æ³•åˆ™èƒ½ä¿è¯æˆ‘ä»¬ä¼˜å…ˆä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„swapå‡½æ•°è€Œé STL ä¸­çš„swapå‡½æ•°ã€‚</p><blockquote><p>C++ åç§°æŸ¥æ‰¾æ³•åˆ™ï¼šç¼–è¯‘å™¨ä¼šä»ä½¿ç”¨åå­—çš„åœ°æ–¹å¼€å§‹å‘ä¸ŠæŸ¥æ‰¾ï¼Œç”±å†…å‘å¤–æŸ¥æ‰¾å„çº§ä½œç”¨åŸŸï¼ˆå‘½åç©ºé—´ï¼‰ç›´åˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆå‘½åç©ºé—´ï¼‰ï¼Œæ‰¾åˆ°åŒåçš„å£°æ˜å³åœæ­¢ï¼Œè‹¥æœ€ç»ˆæ²¡æ‰¾åˆ°åˆ™æŠ¥é”™ã€‚ å‡½æ•°åŒ¹é…ä¼˜å…ˆçº§ï¼šæ™®é€šå‡½æ•° &gt; ç‰¹åŒ–å‡½æ•° &gt; æ¨¡æ¿å‡½æ•°</p></blockquote><h2 id="ç¬¬äº”ç« ï¼šå®ç°">ç¬¬äº”ç« ï¼šå®ç°</h2><h3 id="æ¡æ¬¾-26ï¼šå°½å¯èƒ½å»¶åå˜é‡å®šä¹‰å¼å‡ºç°çš„æ—¶é—´">æ¡æ¬¾ 26ï¼šå°½å¯èƒ½å»¶åå˜é‡å®šä¹‰å¼å‡ºç°çš„æ—¶é—´</h3><p><strong>é‡ç‚¹</strong>ï¼š å¯¹è±¡ä¼˜åŒ–éƒ¨åˆ†</p><p>å½“å˜é‡å®šä¹‰å‡ºç°æ—¶ï¼Œç¨‹åºéœ€è¦æ‰¿å—å…¶æ„é€ æˆæœ¬ï¼›å½“å˜é‡ç¦»å¼€å…¶ä½œç”¨åŸŸæ—¶ï¼Œç¨‹åºéœ€è¦æ‰¿å—å…¶ææ„æˆæœ¬ã€‚å› æ­¤ï¼Œé¿å…ä¸å¿…è¦çš„å˜é‡å®šä¹‰ï¼Œä»¥åŠå»¶åå˜é‡å®šä¹‰å¼ç›´åˆ°ä½ ç¡®å®éœ€è¦å®ƒã€‚</p><p>å»¶åå˜é‡å®šä¹‰å¼è¿˜æœ‰ä¸€ä¸ªæ„ä¹‰ï¼Œå³â€œé»˜è®¤æ„é€ +èµ‹å€¼â€æ•ˆç‡ä½äºâ€œç›´æ¥æ„é€ â€ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•ˆç‡ä½</span></span><br><span class="line">std::string encrypted;</span><br><span class="line">encrypted = password;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•ˆç‡é«˜</span></span><br><span class="line"><span class="function">std::string <span class="title">encrypted</span><span class="params">(password)</span></span>;</span><br></pre></td></tr></table></figure><p>å¯¹äºå¾ªç¯ä¸­å˜é‡çš„å®šä¹‰ï¼Œæˆ‘ä»¬ä¸€èˆ¬æœ‰ä¸¤ç§åšæ³•ï¼š</p><p>A. å®šä¹‰äºå¾ªç¯å¤–ï¼Œåœ¨å¾ªç¯ä¸­èµ‹å€¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Widget w;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">    w = å–å†³äº i çš„æŸä¸ªå€¼;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§åšæ³•äº§ç”Ÿçš„å¼€é”€ï¼š1 ä¸ªæ„é€ å‡½æ•° + 1 ä¸ªææ„å‡½æ•° + n ä¸ªèµ‹å€¼æ“ä½œ</p><p>B. å®šä¹‰äºå¾ªç¯å†…ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">    <span class="function">Widget <span class="title">w</span><span class="params">(å–å†³äº i çš„æŸä¸ªå€¼)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§åšæ³•äº§ç”Ÿçš„å¼€é”€ï¼šn ä¸ªæ„é€ å‡½æ•° + n ä¸ªææ„å‡½æ•°</p><p>ç”±äºåšæ³•Aä¼šå°†å˜é‡çš„ä½œç”¨åŸŸæ‰©å¤§ï¼Œå› æ­¤é™¤éçŸ¥é“è¯¥å˜é‡çš„èµ‹å€¼æˆæœ¬æ¯”â€œæ„é€ +ææ„â€æˆæœ¬ä½ï¼Œæˆ–è€…å¯¹è¿™æ®µç¨‹åºçš„æ•ˆç‡è¦æ±‚éå¸¸é«˜ï¼Œå¦åˆ™å»ºè®®ä½¿ç”¨åšæ³•Bã€‚</p><h3 id="æ¡æ¬¾-27ï¼šå°‘åšè½¬å‹åŠ¨ä½œ">æ¡æ¬¾ 27ï¼šå°‘åšè½¬å‹åŠ¨ä½œ</h3><p>C å¼è½¬å‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(T)<span class="function">expression</span></span><br><span class="line"><span class="function"><span class="title">T</span><span class="params">(expression)</span></span></span><br></pre></td></tr></table></figure><p>C++ å¼è½¬å‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">const_cast</span>&lt;T&gt;(expression)</span><br><span class="line"><span class="built_in">dynamic_cast</span>&lt;T&gt;(expression)</span><br><span class="line"><span class="built_in">reinterpret_cast</span>&lt;T&gt;(expression)</span><br><span class="line"><span class="built_in">static_cast</span>&lt;T&gt;(expression)</span><br></pre></td></tr></table></figure><ul><li><code>const_cast</code>ç”¨äºå¸¸é‡æ€§è½¬é™¤ï¼Œè¿™ä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªæœ‰è¿™ä¸ªèƒ½åŠ›çš„ C++ å¼è½¬å‹ã€‚</li><li><code>dynamic_cast</code>ç”¨äºå®‰å…¨åœ°å‘ä¸‹è½¬å‹ï¼Œè¿™ä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ª C å¼è½¬å‹æ— æ³•ä»£æ›¿çš„è½¬å‹æ“ä½œï¼Œå®ƒä¼šæ‰§è¡Œå¯¹ç»§æ‰¿ä½“ç³»çš„æ£€æŸ¥ï¼Œå› æ­¤ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ã€‚åªæœ‰æ‹¥æœ‰è™šå‡½æ•°çš„åŸºç±»æŒ‡é’ˆèƒ½è¿›è¡Œ<code>dynamic_cast</code>ã€‚</li><li><code>reinterpret_cast</code>ç”¨äºåœ¨ä»»æ„ä¸¤ä¸ªç±»å‹é—´è¿›è¡Œä½çº§è½¬å‹ï¼Œæ‰§è¡Œè¯¥è½¬å‹å¯èƒ½ä¼šå¸¦æ¥é£é™©ï¼Œä¹Ÿå¯èƒ½ä¸å…·å¤‡ç§»æ¤æ€§ã€‚</li><li><code>static_cast</code>ç”¨äºè¿›è¡Œå¼ºåˆ¶éšå¼è½¬æ¢ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„è½¬å‹æ“ä½œï¼Œå¯ä»¥å°†å†…ç½®æ•°æ®ç±»å‹äº’ç›¸è½¬æ¢ï¼Œä¹Ÿå¯ä»¥å°†<code>void*</code>å’ŒtypedæŒ‡é’ˆï¼ŒåŸºç±»æŒ‡é’ˆå’Œæ´¾ç”Ÿç±»æŒ‡é’ˆäº’ç›¸è½¬æ¢ã€‚</li></ul><p>å°½é‡åœ¨ C++ ç¨‹åºä¸­ä½¿ç”¨ C++ å¼è½¬å‹ï¼Œå› ä¸º C++ å¼è½¬å‹æ“ä½œåŠŸèƒ½æ›´æ˜ç¡®ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„é”™è¯¯ã€‚</p><p>å”¯ä¸€ä½¿ç”¨ C å¼è½¬å‹çš„æ—¶æœºå¯èƒ½æ˜¯åœ¨è°ƒç”¨ explicit æ„é€ å‡½æ•°æ—¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Widget</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DoSomeWork</span><span class="params">(<span class="type">const</span> Widget&amp; w)</span></span>;</span><br><span class="line"><span class="built_in">DoSomeWork</span>(<span class="built_in">Widget</span>(<span class="number">15</span>));</span><br><span class="line"><span class="comment">// ç­‰ä»·äº DoSomeWork(static_cast&lt;Widget&gt;(15));</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè½¬å‹å¹¶éä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œè€Œæ˜¯å¯èƒ½ä¼šæ›´æ”¹æ•°æ®çš„åº•å±‚è¡¨è¿°ï¼Œæˆ–è€…ä¸ºæŒ‡é’ˆé™„åŠ åç§»å€¼ï¼Œè¿™å’Œå…·ä½“å¹³å°æœ‰å…³ï¼Œå› æ­¤ä¸è¦å¦„å›¾å»æ£æµ‹è½¬å‹åå¯¹è±¡çš„å…·ä½“å¸ƒå±€æ–¹å¼ã€‚</p><p>é¿å…å¯¹<code>*this</code>è¿›è¡Œè½¬å‹ï¼Œå‚è€ƒä»¥ä¸‹ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Window</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnResize</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpecialWindow</span> : <span class="keyword">public</span> Window &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnResize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">static_cast</span>&lt;Window&gt;(*<span class="keyword">this</span>).<span class="built_in">OnResize</span>();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç è¯•å›¾é€šè¿‡è½¬å‹<code>*this</code>æ¥è°ƒç”¨åŸºç±»çš„è™šå‡½æ•°ï¼Œç„¶è€Œè¿™æ˜¯ä¸¥é‡é”™è¯¯çš„ï¼Œè¿™æ ·åšä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„<code>Window</code>å‰¯æœ¬å¹¶åœ¨è¯¥å‰¯æœ¬ä¸Šè°ƒç”¨å‡½æ•°ï¼Œè€Œéåœ¨åŸæœ¬çš„å¯¹è±¡ä¸Šè°ƒç”¨å‡½æ•°ã€‚</p><p>æ­£ç¡®çš„åšæ³•å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SpecialWindow</span> : <span class="keyword">public</span> Window &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnResize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Window::<span class="built_in">OnResize</span>();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“ä½ æƒ³çŸ¥é“ä¸€ä¸ªåŸºç±»æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ä¸€ä¸ªæ´¾ç”Ÿç±»å¯¹è±¡æ—¶ï¼Œä½ éœ€è¦ç”¨åˆ°<code>dynamic_cast</code>ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™ä¼šäº§ç”ŸæŠ¥é”™ã€‚ä½†æ˜¯å¯¹äºç»§æ‰¿ä½“ç³»çš„æ£€æŸ¥å¯èƒ½æ˜¯éå¸¸æ…¢çš„ï¼Œæ‰€ä»¥åœ¨æ³¨é‡æ•ˆç‡çš„ç¨‹åºä¸­åº”å½“é¿å…ä½¿ç”¨<code>dynamic_cast</code>ï¼Œæ”¹ç”¨<code>static_cast</code>æˆ–åˆ«çš„ä»£æ›¿æ–¹æ³•ã€‚</p><h3 id="æ¡æ¬¾-28ï¼šé¿å…è¿”å›-handles-æŒ‡å‘å¯¹è±¡çš„å†…éƒ¨æˆåˆ†">æ¡æ¬¾ 28ï¼šé¿å…è¿”å› handles æŒ‡å‘å¯¹è±¡çš„å†…éƒ¨æˆåˆ†</h3><p>è€ƒè™‘ä»¥ä¸‹<code>Rectangle</code>ç±»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">RectData</span> &#123;</span><br><span class="line">    Point ulhc;</span><br><span class="line">    Point lrhc;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Point&amp; <span class="title">UpperLeft</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> pData-&gt;ulhc; &#125;</span><br><span class="line">    <span class="function">Point&amp; <span class="title">LowerRight</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> pData-&gt;lrhc; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr&lt;RectData&gt; pData;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†å…¶å®æ˜¯åœ¨åšè‡ªæˆ‘çŸ›ç›¾çš„äº‹æƒ…ï¼šæˆ‘ä»¬é€šè¿‡constæˆå‘˜å‡½æ•°è¿”å›äº†ä¸€ä¸ªæŒ‡å‘æˆå‘˜å˜é‡çš„å¼•ç”¨ï¼Œè¿™ä½¿å¾—æˆå‘˜å˜é‡å¯ä»¥åœ¨å¤–éƒ¨è¢«ä¿®æ”¹ï¼Œè€Œè¿™æ˜¯è¿å logical constness çš„åŸåˆ™çš„ã€‚æ¢å¥è¯è¯´ï¼Œä½ <strong>ç»å¯¹ä¸åº”è¯¥ä»¤æˆå‘˜å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘â€œè®¿é—®çº§åˆ«è¾ƒä½â€çš„æˆå‘˜å‡½æ•°</strong>ã€‚</p><p>æ”¹æˆè¿”å›å¸¸å¼•ç”¨å¯ä»¥é¿å…å¯¹æˆå‘˜å˜é‡çš„ä¿®æ”¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">const</span> Point&amp; <span class="title">UpperLeft</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> pData-&gt;ulhc; &#125;</span><br><span class="line"><span class="function"><span class="type">const</span> Point&amp; <span class="title">LowerRight</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> pData-&gt;lrhc; &#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ ·ä¾ç„¶ä¼šå¸¦æ¥ä¸€ä¸ªç§°ä½œ <strong>dangling handlesï¼ˆç©ºæ‚¬å¥æŸ„ï¼‰</strong> çš„é—®é¢˜ï¼Œå½“å¯¹è±¡ä¸å¤å­˜åœ¨æ—¶ï¼Œä½ å°†æ— æ³•é€šè¿‡å¼•ç”¨è·å–åˆ°è¿”å›çš„æ•°æ®ã€‚</p><p>é‡‡ç”¨æœ€ä¿å®ˆçš„åšæ³•ï¼Œè¿”å›ä¸€ä¸ªæˆå‘˜å˜é‡çš„å‰¯æœ¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Point <span class="title">UpperLeft</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> pData-&gt;ulhc; &#125;</span><br><span class="line"><span class="function">Point <span class="title">LowerRight</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> pData-&gt;lrhc; &#125;</span><br></pre></td></tr></table></figure><p>é¿å…è¿”å› handlesï¼ˆåŒ…æ‹¬å¼•ç”¨ã€æŒ‡é’ˆã€è¿­ä»£å™¨ï¼‰æŒ‡å‘å¯¹è±¡å†…éƒ¨ã€‚éµå¾ªè¿™ä¸ªæ¡æ¬¾å¯å¢åŠ å°è£…æ€§ï¼Œä½¿å¾—constæˆå‘˜å‡½æ•°çš„è¡Œä¸ºç¬¦åˆå¸¸é‡æ€§ï¼Œå¹¶å°†å‘ç”Ÿ â€œç©ºæ‚¬å¥æŸ„â€ çš„å¯èƒ½æ€§é™åˆ°æœ€ä½ã€‚</p><h3 id="æ¡æ¬¾-29ï¼šä¸ºâ€œå¼‚å¸¸å®‰å…¨â€è€ŒåŠªåŠ›æ˜¯å€¼å¾—çš„">æ¡æ¬¾ 29ï¼šä¸ºâ€œå¼‚å¸¸å®‰å…¨â€è€ŒåŠªåŠ›æ˜¯å€¼å¾—çš„</h3><p>å¼‚å¸¸å®‰å…¨å‡½æ•°æä¾›ä»¥ä¸‹ä¸‰ä¸ªä¿è¯ä¹‹ä¸€ï¼š</p><p><strong>åŸºæœ¬æ‰¿è¯ºï¼š</strong> å¦‚æœå¼‚å¸¸è¢«æŠ›å‡ºï¼Œç¨‹åºå†…çš„ä»»ä½•äº‹ç‰©ä»ç„¶ä¿æŒåœ¨æœ‰æ•ˆçŠ¶æ€ä¸‹ï¼Œæ²¡æœ‰ä»»ä½•å¯¹è±¡æˆ–æ•°æ®ç»“æ„ä¼šå› æ­¤è´¥åï¼Œæ‰€æœ‰å¯¹è±¡éƒ½å¤„äºä¸€ç§å†…éƒ¨å‰åä¸€è‡´çš„çŠ¶æ€ï¼Œç„¶è€Œç¨‹åºçš„çœŸå®çŠ¶æ€æ˜¯ä¸å¯çŸ¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®¢æˆ·éœ€è¦é¢å¤–æ£€æŸ¥ç¨‹åºå¤„äºå“ªç§çŠ¶æ€å¹¶ä½œå‡ºå¯¹åº”çš„å¤„ç†ã€‚</p><p><strong>å¼ºçƒˆä¿è¯ï¼š</strong> å¦‚æœå¼‚å¸¸è¢«æŠ›å‡ºï¼Œç¨‹åºçŠ¶æ€å®Œå…¨ä¸æ”¹å˜ï¼Œæ¢å¥è¯è¯´ï¼Œç¨‹åºä¼šå›å¤åˆ°â€œè°ƒç”¨å‡½æ•°ä¹‹å‰â€çš„çŠ¶æ€ã€‚</p><p><strong>ä¸æŠ›æ·ï¼ˆnothrowï¼‰ä¿è¯ï¼š</strong> æ‰¿è¯ºç»ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºç¨‹åºæ€»æ˜¯èƒ½å®ŒæˆåŸå…ˆæ‰¿è¯ºçš„åŠŸèƒ½ã€‚ä½œç”¨äºå†…ç½®ç±»å‹èº«ä¸Šçš„æ‰€æœ‰æ“ä½œéƒ½æä¾› nothrow ä¿è¯ã€‚</p><p>åŸä¹¦ä¸­å®ç° nothrow çš„æ–¹æ³•æ˜¯<code>throw()</code>ï¼Œä¸è¿‡è¿™å¥—å¼‚å¸¸è§„èŒƒåœ¨ C++11 ä¸­å·²ç»è¢«å¼ƒç”¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯<code>noexcept</code>å…³é”®å­—ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">DoSomething</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œä½¿ç”¨<code>noexcept</code>å¹¶ä¸ä»£è¡¨å‡½æ•°ç»å¯¹ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå°†ä»£è¡¨å‡ºç°ä¸¥é‡é”™è¯¯ï¼Œä¼šæœ‰æ„æƒ³ä¸åˆ°çš„å‡½æ•°è¢«è°ƒç”¨ï¼ˆå¯ä»¥é€šè¿‡<code>set_unexpected</code>è®¾ç½®ï¼‰ï¼Œæ¥ç€ç¨‹åºä¼šç›´æ¥å´©æºƒã€‚</p><p>å½“å¼‚å¸¸è¢«æŠ›å‡ºæ—¶ï¼Œå¸¦æœ‰å¼‚å¸¸å®‰å…¨æ€§çš„å‡½æ•°ä¼šï¼š</p><ol><li>ä¸æ³„æ¼ä»»ä½•èµ„æºã€‚</li><li>ä¸å…è®¸æ•°æ®è´¥åã€‚</li></ol><p>è€ƒè™‘ä»¥ä¸‹<code>PrettyMenu</code>çš„<code>ChangeBackground</code>å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrettyMenu</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ChangeBackground</span><span class="params">(std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; imgSrc)</span></span>;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Mutex mutex;        <span class="comment">// äº’æ–¥é”</span></span><br><span class="line">    Image* bgImage;     <span class="comment">// ç›®å‰çš„èƒŒæ™¯å›¾åƒ</span></span><br><span class="line">    <span class="type">int</span> imageChanges;   <span class="comment">// èƒŒæ™¯å›¾åƒè¢«æ”¹å˜çš„æ¬¡æ•°</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrettyMenu::ChangeBackground</span><span class="params">(std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; imgSrc)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">lock</span>(&amp;mutex);</span><br><span class="line">    <span class="keyword">delete</span> bgImage;</span><br><span class="line">    ++imageChanges;</span><br><span class="line">    bgImage = <span class="keyword">new</span> <span class="built_in">Image</span>(imgSrc);</span><br><span class="line">    <span class="built_in">unlock</span>(&amp;mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™ä¸ªå‡½æ•°ä¸æ»¡è¶³æˆ‘ä»¬æ‰€è¯´çš„å…·æœ‰å¼‚å¸¸å®‰å…¨æ€§çš„ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œè‹¥åœ¨å‡½æ•°ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œ<code>mutex</code>ä¼šå‘ç”Ÿèµ„æºæ³„æ¼ï¼Œ<code>bgImage</code>å’Œ<code>imageChanges</code>ä¹Ÿä¼šå‘ç”Ÿæ•°æ®è´¥åã€‚</p><p>é€šè¿‡ä»¥å¯¹è±¡ç®¡ç†èµ„æºï¼Œä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆå’Œè°ƒæ¢ä»£ç é¡ºåºï¼Œæˆ‘ä»¬èƒ½å°†å…¶å˜æˆä¸€ä¸ªå…·æœ‰å¼ºçƒˆä¿è¯çš„å¼‚å¸¸å®‰å…¨å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrettyMenu::ChangeBackground</span><span class="params">(std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; imgSrc)</span> </span>&#123;</span><br><span class="line">    <span class="function">Lock <span class="title">m1</span><span class="params">(&amp;mutex)</span></span>;</span><br><span class="line">    bgImage.<span class="built_in">reset</span>(std::<span class="built_in">make_shared</span>&lt;Image&gt;(imgSrc));</span><br><span class="line"></span><br><span class="line">    ++imageChanges;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªå¸¸ç”¨äºæä¾›å¼ºçƒˆä¿è¯çš„æ–¹æ³•æ˜¯æˆ‘ä»¬æ‰€æåˆ°è¿‡çš„ copy and swapï¼Œä¸ºä½ æ‰“ç®—ä¿®æ”¹çš„å¯¹è±¡åšå‡ºä¸€ä»½å‰¯æœ¬ï¼Œå¯¹å‰¯æœ¬æ‰§è¡Œä¿®æ”¹ï¼Œå¹¶åœ¨æ‰€æœ‰ä¿®æ”¹éƒ½æˆåŠŸæ‰§è¡Œåï¼Œç”¨ä¸€ä¸ªä¸ä¼šæŠ›å‡ºå¼‚å¸¸çš„swapæ–¹æ³•å°†åŸä»¶å’Œå‰¯æœ¬äº¤æ¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PMImpl</span> &#123;</span><br><span class="line">    std::shared_ptr&lt;Image&gt; bgImage;</span><br><span class="line">    <span class="type">int</span> imageChanges;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PrettyMenu</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Mutex mutex;</span><br><span class="line">    std::shared_ptr&lt;PMImpl&gt; pImpl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrettyMenu::ChangeBackground</span><span class="params">(std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; imgSrc)</span> </span>&#123;</span><br><span class="line">    <span class="function">Lock <span class="title">m1</span><span class="params">(&amp;mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> pNew = std::<span class="built_in">make_shared</span>&lt;PMImpl&gt;(*pImpl);    <span class="comment">// è·å–å‰¯æœ¬</span></span><br><span class="line">    pNew-&gt;bgImage.<span class="built_in">reset</span>(std::<span class="built_in">make_shared</span>&lt;Image&gt;(imgSrc));</span><br><span class="line">    ++pNew-&gt;imageChanges;</span><br><span class="line"></span><br><span class="line">    std::<span class="built_in">swap</span>(pImpl, pNew);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä¸€ä¸ªå‡½æ•°è°ƒç”¨å…¶å®ƒå‡½æ•°æ—¶ï¼Œå‡½æ•°æä¾›çš„â€œå¼‚å¸¸å®‰å…¨ä¿è¯â€é€šå¸¸æœ€é«˜åªç­‰äºå…¶æ‰€è°ƒç”¨çš„å„ä¸ªå‡½æ•°çš„â€œå¼‚å¸¸å®‰å…¨ä¿è¯â€ä¸­çš„æœ€å¼±è€…ã€‚</p><p>å¼ºçƒˆä¿è¯å¹¶éæ°¸è¿œéƒ½æ˜¯å¯å®ç°çš„ï¼Œç‰¹åˆ«æ˜¯å½“å‡½æ•°åœ¨æ“æ§éå±€éƒ¨å¯¹è±¡æ—¶ï¼Œè¿™æ—¶å°±åªèƒ½é€€è€Œæ±‚å…¶æ¬¡é€‰æ‹©ä¸é‚£ä¹ˆç¾å¥½çš„åŸºæœ¬æ‰¿è¯ºï¼Œå¹¶å°†è¯¥å†³å®šå†™å…¥æ–‡æ¡£ï¼Œè®©å…¶ä»–äººç»´æŠ¤æ—¶ä¸è‡³äºæ¯«æ— å¿ƒç†å‡†å¤‡ã€‚</p><h3 id="æ¡æ¬¾-30ï¼šé€å½»äº†è§£-inlining-çš„é‡Œé‡Œå¤–å¤–">æ¡æ¬¾ 30ï¼šé€å½»äº†è§£ inlining çš„é‡Œé‡Œå¤–å¤–</h3><p><strong>é‡ç‚¹</strong>ï¼š</p><p>inlineå‡½æ•°æ²¡æœ‰å‡½æ•°è°ƒç”¨å¼€é”€ï¼Œç›´æ¥æŠŠå‡½æ•°çš„ä»£ç è¿›è¡Œå±•å¼€</p><p>inlineå‡½æ•°ä¸å†ç”Ÿæˆç›¸åº”çš„å‡½æ•°ç¬¦å·</p><p>é€’å½’çš„å‡½æ•°inlineä¸ä¼šå±•å¼€</p><p>è°·æ­Œé£æ ¼ä¸­ä»‹ç»åˆ°æœ€å¥½æ§åˆ¶åœ¨10è¡Œinlineå‡½æ•°</p><hr><p>å°†å‡½æ•°å£°æ˜ä¸ºå†…è”ä¸€å…±æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ä¸ºå…¶æ˜¾å¼æŒ‡å®š<code>inline</code>å…³é”®å­—ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥å°†æˆå‘˜å‡½æ•°çš„å®šä¹‰å¼å†™åœ¨ç±»ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Age</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> theAge; &#125;  <span class="comment">// éšå¼å£°æ˜ä¸º inline</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> theAge;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨<code>inline</code>è¯ç”Ÿä¹‹åˆï¼Œå®ƒè¢«å½“ä½œæ˜¯ä¸€ç§å¯¹ç¼–è¯‘å™¨çš„ä¼˜åŒ–å»ºè®®ï¼Œå³å°†â€œå¯¹æ­¤å‡½æ•°çš„æ¯ä¸€ä¸ªè°ƒç”¨â€éƒ½ä»¥å‡½æ•°æœ¬ä½“æ›¿æ¢ä¹‹ã€‚ä½†åœ¨ç¼–è¯‘å™¨çš„å…·ä½“å®ç°ä¸­ï¼Œè¯¥è¡Œä¸ºå®Œå…¨è¢«ä¼˜åŒ–ç­‰çº§æ‰€æ§åˆ¶ï¼Œä¸å‡½æ•°æ˜¯å¦å†…è”æ— å…³ã€‚</p><p>åœ¨ç°åœ¨çš„ C++ æ ‡å‡†ä¸­ï¼Œ<code>inline</code>ä½œä¸ºä¼˜åŒ–å»ºè®®çš„å«ä¹‰å·²ç»è¢«å®Œå…¨æŠ›å¼ƒï¼Œå–è€Œä»£ä¹‹çš„æ˜¯â€œå…è®¸å‡½æ•°åœ¨ä¸åŒç¼–è¯‘å•å…ƒä¸­å¤šé‡å®šä¹‰â€ï¼Œä½¿å¾—å¯ä»¥åœ¨å¤´æ–‡ä»¶ä¸­ç›´æ¥ç»™å‡ºå‡½æ•°çš„å®ç°ã€‚</p><p>åœ¨ C++17 ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªæ–°çš„<code>inline</code>ç”¨æ³•ï¼Œä½¿é™æ€æˆå‘˜å˜é‡å¯ä»¥åœ¨ç±»ä¸­ç›´æ¥å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> theAge = <span class="number">0</span>;  <span class="comment">// since C++17</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-31ï¼šå°†æ–‡ä»¶é—´çš„ç¼–è¯‘ä¾å­˜å…³ç³»é™è‡³æœ€ä½">æ¡æ¬¾ 31ï¼šå°†æ–‡ä»¶é—´çš„ç¼–è¯‘ä¾å­˜å…³ç³»é™è‡³æœ€ä½</h3><p>C++ åšæŒå°†ç±»çš„å®ç°ç»†èŠ‚æ”¾ç½®äºç±»çš„å®šä¹‰å¼ä¸­ï¼Œè¿™å°±æ„å‘³ç€ï¼Œå³ä½¿ä½ åªæ”¹å˜ç±»çš„å®ç°è€Œä¸æ”¹å˜ç±»çš„æ¥å£ï¼Œåœ¨æ„å»ºç¨‹åºæ—¶ä¾ç„¶éœ€è¦é‡æ–°ç¼–è¯‘ã€‚è¿™ä¸ªé—®é¢˜çš„æ ¹æºå‡ºåœ¨ç¼–è¯‘å™¨å¿…é¡»åœ¨ç¼–è¯‘æœŸé—´çŸ¥é“å¯¹è±¡çš„å¤§å°ï¼Œå¦‚æœçœ‹ä¸åˆ°ç±»çš„å®šä¹‰å¼ï¼Œå°±æ²¡æœ‰åŠæ³•ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒC++ å¹¶æ²¡æœ‰æŠŠâ€œå°†æ¥å£ä»å®ç°ä¸­åˆ†ç¦»â€è¿™ä»¶äº‹åšå¾—å¾ˆå¥½ã€‚</p><p><strong>ç”¨â€œå£°æ˜çš„ä¾å­˜æ€§â€æ›¿æ¢â€œå®šä¹‰çš„ä¾å­˜æ€§â€ï¼š</strong></p><p>æˆ‘ä»¬å¯ä»¥ç©ä¸€ä¸ªâ€œå°†å¯¹è±¡å®ç°ç»†ç›®éšè—äºä¸€ä¸ªæŒ‡é’ˆèƒŒåâ€çš„æ¸¸æˆï¼Œç§°ä½œ <strong>pimpl idiomï¼ˆpimpl æ˜¯ pointer to implemention çš„ç¼©å†™ï¼‰</strong>ï¼šå°†åŸæ¥çš„ä¸€ä¸ªç±»åˆ†å‰²ä¸ºä¸¤ä¸ªç±»ï¼Œä¸€ä¸ªåªæä¾›æ¥å£ï¼Œå¦ä¸€ä¸ªè´Ÿè´£å®ç°è¯¥æ¥å£ï¼Œç§°ä½œ<strong>å¥æŸ„ç±»ï¼ˆhandle classï¼‰</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// person.hpp è´Ÿè´£å£°æ˜ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PersonImpl</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Person</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr&lt;PersonImpl&gt; pImpl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// person.cpp è´Ÿè´£å®ç°ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PersonImpl</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> data&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person::<span class="built_in">Person</span>() &#123;</span><br><span class="line">    pImpl = std::<span class="built_in">make_shared</span>&lt;PersonImpl&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Person::Print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; pImpl-&gt;data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå‡å¦‚æˆ‘ä»¬è¦ä¿®æ”¹<code>Person</code>çš„privateæˆå‘˜ï¼Œå°±åªéœ€è¦ä¿®æ”¹<code>PersonImpl</code>ä¸­çš„å†…å®¹ï¼Œè€Œ<code>PersonImpl</code>çš„å…·ä½“å®ç°æ˜¯è¢«éšè—èµ·æ¥çš„ï¼Œå¯¹å®ƒçš„ä»»ä½•ä¿®æ”¹éƒ½ä¸ä¼šä½¿å¾—<code>Person</code>å®¢æˆ·ç«¯é‡æ–°ç¼–è¯‘ï¼ŒçœŸæ­£å®ç°äº†â€œç±»çš„æ¥å£å’Œå®ç°åˆ†ç¦»â€ã€‚</p><p><strong>å¦‚æœä½¿ç”¨å¯¹è±¡å¼•ç”¨æˆ–å¯¹è±¡æŒ‡é’ˆå¯ä»¥å®Œæˆä»»åŠ¡ï¼Œå°±ä¸è¦ä½¿ç”¨å¯¹è±¡æœ¬èº«ï¼š</strong></p><p>ä½ å¯ä»¥åªé ä¸€ä¸ªç±»å‹å£°æ˜å¼å°±å®šä¹‰å‡ºæŒ‡å‘è¯¥ç±»å‹çš„å¼•ç”¨å’ŒæŒ‡é’ˆï¼›ä½†å¦‚æœå®šä¹‰æŸç±»å‹çš„å¯¹è±¡ï¼Œå°±éœ€è¦ç”¨åˆ°è¯¥ç±»å‹çš„å®šä¹‰å¼ã€‚</p><p><strong>å¦‚æœèƒ½å¤Ÿï¼Œå°½é‡ä»¥ç±»å£°æ˜å¼æ›¿æ¢ç±»å®šä¹‰å¼ï¼š</strong></p><p>å½“ä½ åœ¨å£°æ˜ä¸€ä¸ªå‡½æ•°è€Œå®ƒç”¨åˆ°æŸä¸ªç±»æ—¶ï¼Œä½ ä¸éœ€è¦è¯¥ç±»çš„å®šä¹‰ï¼›ä½†å½“ä½ è§¦åŠåˆ°è¯¥å‡½æ•°çš„å®šä¹‰å¼åï¼Œå°±å¿…é¡»ä¹ŸçŸ¥é“ç±»çš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Date</span>;                     <span class="comment">// ç±»çš„å£°æ˜å¼</span></span><br><span class="line"><span class="function">Date <span class="title">Today</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClearAppointments</span><span class="params">(Date d)</span></span>; <span class="comment">// æ­¤å¤„å¹¶ä¸éœ€è¦å¾—çŸ¥ç±»çš„å®šä¹‰</span></span><br></pre></td></tr></table></figure><p><strong>ä¸ºå£°æ˜å¼å’Œå®šä¹‰å¼æä¾›ä¸åŒçš„å¤´æ–‡ä»¶ï¼š</strong></p><p>ä¸ºäº†é¿å…é¢‘ç¹åœ°æ·»åŠ å£°æ˜ï¼Œæˆ‘ä»¬åº”è¯¥ä¸ºæ‰€æœ‰è¦ç”¨çš„ç±»å£°æ˜æä¾›ä¸€ä¸ªå¤´æ–‡ä»¶ï¼Œè¿™ç§åšæ³•å¯¹ template ä¹Ÿé€‚ç”¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;datefwd.h&quot;</span>            <span class="comment">// è¿™ä¸ªå¤´æ–‡ä»¶å†…å£°æ˜ class Date</span></span></span><br><span class="line"><span class="function">Date <span class="title">Today</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClearAppointments</span><span class="params">(Date d)</span></span>;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„çš„å¤´æ–‡ä»¶å‘½åæ–¹å¼<code>&quot;datefwd.h&quot;</code>å–è‡ªæ ‡å‡†åº“ä¸­çš„<code>&lt;iosfwd&gt;</code>ã€‚</p><p>ä¸Šé¢æˆ‘ä»¬è®²è¿°äº†æ¥å£ä¸å®ç°åˆ†ç¦»çš„å…¶ä¸­ä¸€ä¸ªæ–¹æ³•â€”â€”æä¾›å¥æŸ„ç±»ï¼Œå¦ä¸€ä¸ªæ–¹æ³•å°±æ˜¯å°†å¥æŸ„ç±»å®šä¹‰ä¸ºæŠ½è±¡åŸºç±»ï¼Œç§°ä½œ<strong>æ¥å£ç±»ï¼ˆinterface classï¼‰</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Person</span>() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Print</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å°†<code>Person</code>å¯¹è±¡å®é™…åˆ›å»ºå‡ºæ¥ï¼Œæˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨å·¥å‚æ¨¡å¼ã€‚å¯ä»¥å°è¯•åœ¨ç±»ä¸­å¡å…¥ä¸€ä¸ªé™æ€æˆå‘˜å‡½æ•°<code>Create</code>ç”¨äºåˆ›å»ºå¯¹è±¡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="type">static</span> std::shared_ptr&lt;Person&gt; <span class="title">Create</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½†æ­¤æ—¶<code>Create</code>å‡½æ•°è¿˜æ— æ³•ä½¿ç”¨ï¼Œéœ€è¦åœ¨æ´¾ç”Ÿç±»ä¸­ç»™å‡º<code>Person</code>ç±»ä¸­çš„å‡½æ•°çš„å…·ä½“å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealPerson</span> : <span class="keyword">public</span> Person &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">RealPerson</span>(...) &#123; ... &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">RealPerson</span>() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> data&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å®Œæˆ<code>Create</code>å‡½æ•°çš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> std::shared_ptr&lt;Person&gt; <span class="title">Person::Create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">make_shared</span>&lt;RealPerson&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯«æ— ç–‘é—®çš„æ˜¯ï¼Œå¥æŸ„ç±»å’Œæ¥å£ç±»éƒ½éœ€è¦é¢å¤–çš„å¼€é”€ï¼šå¥æŸ„ç±»éœ€è¦é€šè¿‡ pimpl å–å¾—å¯¹è±¡æ•°æ®ï¼Œå¢åŠ ä¸€å±‚é—´æ¥è®¿é—®ã€æŒ‡é’ˆå¤§å°å’ŒåŠ¨æ€åˆ†é…å†…å­˜å¸¦æ¥çš„å¼€é”€ï¼›è€Œæ¥å£ç±»ä¼šå¢åŠ å­˜å‚¨è™šè¡¨æŒ‡é’ˆå’Œå®ç°è™šå‡½æ•°è·³è½¬å¸¦æ¥çš„å¼€é”€ã€‚</p><p>è€Œå½“è¿™äº›å¼€é”€è¿‡äºé‡å¤§ä»¥è‡³äºç±»ä¹‹é—´çš„è€¦åˆåº¦åœ¨ç›¸å½¢ä¹‹ä¸‹ä¸æˆä¸ºå…³é”®æ—¶ï¼Œå°±ä»¥å…·è±¡ç±»ï¼ˆconcrete classï¼‰æ›¿æ¢å¥æŸ„ç±»å’Œæ¥å£ç±»ã€‚</p><h2 id="ç¬¬å…­ç« ï¼šç»§æ‰¿ä¸é¢å‘å¯¹è±¡è®¾è®¡">ç¬¬å…­ç« ï¼šç»§æ‰¿ä¸é¢å‘å¯¹è±¡è®¾è®¡</h2><h3 id="æ¡æ¬¾-32ï¼šç¡®å®šä½ çš„publicç»§æ‰¿å¡‘æ¨¡å‡º-is-a-å…³ç³»">æ¡æ¬¾ 32ï¼šç¡®å®šä½ çš„publicç»§æ‰¿å¡‘æ¨¡å‡º is-a å…³ç³»</h3><p>â€œpublicç»§æ‰¿â€æ„å‘³ç€ is-aï¼Œæ‰€è°“ is-aï¼Œå°±æ˜¯æŒ‡é€‚ç”¨äºåŸºç±»èº«ä¸Šçš„æ¯ä¸€ä»¶äº‹æƒ…ä¸€å®šä¹Ÿé€‚ç”¨äºç»§æ‰¿ç±»èº«ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ¯ä¸€ä¸ªæ´¾ç”Ÿç±»å¯¹è±¡ä¹Ÿéƒ½æ˜¯ä¸€ä¸ªåŸºç±»å¯¹è±¡ã€‚</p><p>è¿™çœ‹ä¼¼å¾ˆè‡ªç„¶ï¼Œä½†åœ¨é¢å¯¹è‡ªç„¶è¯­è¨€çš„è¡¨è¿°æ—¶ï¼Œå¾€å¾€ä¼šäº§ç”Ÿæ­§ä¹‰ã€‚</p><p>è€ƒè™‘<code>Bird</code>ç±»å’Œ<code>Penguin</code>ç±»çš„ç»§æ‰¿å…³ç³»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Bird</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Fly</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Penguin</span> : <span class="keyword">public</span> Bird &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>Penguin</code>ç±»ä¼šè·å¾—æ¥è‡ª<code>Bird</code>ç±»çš„é£è¡Œæ–¹æ³•ï¼Œè¿™å°±é€ æˆäº†è¯¯è§£ï¼Œå› ä¸ºä¼é¹…æ°æ°æ˜¯ä¸ä¼šé£çš„é¸Ÿç±»ã€‚ä¸€ç§è§£å†³æ–¹æ³•æ˜¯å½“è°ƒç”¨<code>Penguin</code>ç±»ä¸­çš„<code>Fly</code>å‡½æ•°æ—¶ï¼ŒæŠ›å‡ºä¸€ä¸ªè¿è¡ŒæœŸé”™è¯¯ï¼Œä½†è¿™ç§åšæ³•é€šå¸¸ä¸å¤Ÿç›´è§‚ï¼›å¦ä¸€ä¸ªè§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨åŒç»§æ‰¿ï¼ŒåŒºåˆ†ä¼šé£å’Œä¸ä¼šé£çš„é¸Ÿç±»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Bird</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyingBird</span> : <span class="keyword">public</span> Bird &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Fly</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Penguin</span> : <span class="keyword">public</span> FlyingBird &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½†è‹¥è¦å¤„ç†é¸Ÿç±»çš„å¤šé’Ÿä¸åŒå±æ€§æ—¶ï¼ŒåŒç»§æ‰¿æ¨¡å¼å°±ä¸å¤ªç®¡ç”¨äº†ï¼Œå› æ­¤æˆ‘ä»¬æ€»æ˜¯è¯´ç¨‹åºè®¾è®¡æ²¡æœ‰é“¶å¼¹ã€‚</p><p>å¦ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯ç”¨<code>Square</code>ç±»ç»§æ‰¿è‡ª<code>Rectangle</code>ç±»ï¼Œä»å‡ ä½•å­¦çš„è§’åº¦æ¥è®²è¿™å¾ˆè‡ªç„¶ï¼Œç„¶è€Œæ­£æ–¹å½¢çš„é•¿å®½æ˜¯ç›¸ç­‰çš„ï¼ŒçŸ©å½¢å´ä¸æ˜¯å¦‚æ­¤ï¼Œå› æ­¤<code>Square</code>ç±»å’Œ<code>Rectangle</code>ç±»ä¹Ÿæ— æ³•æ»¡è¶³ä¸¥æ ¼çš„ is-a å…³ç³»ã€‚</p><h3 id="æ¡æ¬¾-33ï¼šé¿å…é®æ©ç»§æ‰¿è€Œæ¥çš„åç§°">æ¡æ¬¾ 33ï¼šé¿å…é®æ©ç»§æ‰¿è€Œæ¥çš„åç§°</h3><p><strong>é‡ç‚¹</strong>ï¼šç®€å•æ¥è¯´ï¼Œçˆ¶ç±»æ–¹æ³•å°±ä¼šè¢«éšè—</p><p>åœ¨ç»§æ‰¿ç»“æ„ä¸­ï¼Œæ´¾ç”Ÿç±»çš„åŒåæˆå‘˜æŠŠåŸºç±»çš„åŒåæˆå‘˜ç»™éšè—äº†ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨çš„æ—¶å€™è°ƒç”¨çš„æ˜¯æ´¾ç”Ÿç±»çš„æˆå‘˜å‡½æ•°ã€‚è¦è°ƒç”¨åŸºç±»é‚£å°±åŠ ä½œç”¨åŸŸï¼Œï¼ˆæ¯”å¦‚ Base::showï¼‰</p><hr><p>ä¹‹å‰æˆ‘ä»¬äº†è§£è¿‡ C++ åç§°æŸ¥æ‰¾æ³•åˆ™ï¼Œè¿™åœ¨ç»§æ‰¿ä½“ç³»ä¸­ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå½“æˆ‘ä»¬åœ¨æ´¾ç”Ÿç±»ä¸­ä½¿ç”¨åˆ°ä¸€ä¸ªåå­—æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä¼˜å…ˆæŸ¥æ‰¾æ´¾ç”Ÿç±»è¦†ç›–çš„ä½œç”¨åŸŸï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œå†å»æŸ¥æ‰¾åŸºç±»çš„ä½œç”¨åŸŸï¼Œæœ€åå†æŸ¥æ‰¾å…¨å±€ä½œç”¨åŸŸã€‚</p><p>è€ƒè™‘ä»¥ä¸‹æƒ…å½¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">mf</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">mf</span><span class="params">(<span class="type">double</span>)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">mf</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¼šå¯¼è‡´æ´¾ç”Ÿç±»æ— æ³•ä½¿ç”¨æ¥è‡ªåŸºç±»çš„é‡è½½å‡½æ•°ï¼Œå› ä¸ºæ´¾ç”Ÿç±»ä¸­çš„åç§°<code>mf</code>æ©ç›–äº†æ¥è‡ªåŸºç±»çš„åç§°<code>mf</code>ã€‚</p><p>å¯¹äºåç§°æ©ç›–é—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨<code>using</code>å…³é”®å­—ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> Base::mf;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>using</code>å…³é”®å­—ä¼šå°†åŸºç±»ä¸­æ‰€æœ‰ä½¿ç”¨åˆ°åç§°<code>mf</code>çš„å‡½æ•°å…¨éƒ¨åŒ…å«åœ¨æ´¾ç”Ÿç±»ä¸­ï¼ŒåŒ…æ‹¬å…¶é‡è½½ç‰ˆæœ¬ã€‚</p><p>è‹¥æœ‰æ—¶æˆ‘ä»¬ä¸æƒ³è¦ä¸€ä¸ªå‡½æ•°çš„å…¨éƒ¨ç‰ˆæœ¬ï¼Œåªæƒ³è¦å•ä¸€ç‰ˆæœ¬ï¼ˆç‰¹åˆ«æ˜¯åœ¨privateç»§æ‰¿æ—¶ï¼‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨<strong>è½¬å‘å‡½æ•°ï¼ˆforwarding functionï¼‰</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf</span><span class="params">(<span class="type">double</span>)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Base::<span class="built_in">mf</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-34ï¼šåŒºåˆ†æ¥å£ç»§æ‰¿å’Œå®ç°ç»§æ‰¿">æ¡æ¬¾ 34ï¼šåŒºåˆ†æ¥å£ç»§æ‰¿å’Œå®ç°ç»§æ‰¿</h3><ol><li>æ¥å£ç»§æ‰¿å’Œå®ç°ç»§æ‰¿ä¸ä¸€æ ·ã€‚åœ¨publicç»§æ‰¿ä¸‹ï¼Œæ´¾ç”Ÿç±»æ€»æ˜¯ç»§æ‰¿åŸºç±»çš„æ¥å£ã€‚</li><li>å£°æ˜ä¸€ä¸ªçº¯è™šå‡½æ•°çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†è®©æ´¾ç”Ÿç±»åªç»§æ‰¿å‡½æ•°æ¥å£ã€‚</li><li>å£°æ˜ç®€æœ´çš„éçº¯è™šå‡½æ•°çš„ç›®çš„ï¼Œæ˜¯è®©æ´¾ç”Ÿç±»ç»§æ‰¿è¯¥å‡½æ•°çš„æ¥å£å’Œç¼ºçœå®ç°ã€‚</li><li>å£°æ˜éè™šå‡½æ•°çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†ä»¤æ´¾ç”Ÿç±»ç»§æ‰¿å‡½æ•°çš„æ¥å£åŠä¸€ä»½å¼ºåˆ¶æ€§å®ç°ã€‚</li></ol><p>é€šå¸¸è€Œè¨€ï¼Œæˆ‘ä»¬ä¸ä¼šä¸ºçº¯è™šå‡½æ•°æä¾›å…·ä½“å®ç°ï¼Œç„¶è€Œè¿™æ ·åšæ˜¯è¢«å…è®¸çš„ï¼Œå¹¶ä¸”ç”¨äºæ›¿ä»£ç®€æœ´çš„éçº¯è™šå‡½æ•°ï¼Œæä¾›æ›´å¹³å¸¸æ›´å®‰å…¨çš„ç¼ºçœå®ç°ã€‚</p><p>ç”¨éçº¯è™šå‡½æ•°æä¾›ç¼ºçœçš„é»˜è®¤å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Airplane</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç¼ºçœå®ç°</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Model</span> : <span class="keyword">public</span> Airplane &#123; ... &#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æœ€ç®€æœ´çš„åšæ³•ï¼Œä½†æ˜¯è¿™æ ·åšä¼šå¸¦æ¥çš„é—®é¢˜æ˜¯ï¼Œç”±äºä¸å¼ºåˆ¶å¯¹è™šå‡½æ•°çš„è¦†å†™ï¼Œåœ¨å®šä¹‰æ–°çš„æ´¾ç”Ÿç±»æ—¶å¯èƒ½ä¼šå¿˜è®°è¿›è¡Œè¦†å†™ï¼Œå¯¼è‡´é”™è¯¯åœ°ä½¿ç”¨äº†ç¼ºçœå®ç°ã€‚</p><p>ä½¿ç”¨çº¯è™šå‡½æ•°å¹¶æä¾›é»˜è®¤å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Airplane</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Fly</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">DefaultFly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç¼ºçœå®ç°</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Model</span> : <span class="keyword">public</span> Airplane &#123; </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Fly</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="built_in">DefaultFly</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å†™æ³•å¯ä»¥æ›¿ä»£ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Airplane</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Fly</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Airplane::Fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç¼ºçœå®ç°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Model</span> : <span class="keyword">public</span> Airplane &#123; </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Fly</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        Airplane::<span class="built_in">Fly</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-35ï¼šè€ƒè™‘è™šå‡½æ•°ä»¥å¤–çš„å…¶å®ƒé€‰æ‹©">æ¡æ¬¾ 35ï¼šè€ƒè™‘è™šå‡½æ•°ä»¥å¤–çš„å…¶å®ƒé€‰æ‹©</h3><p><strong>è—‰ç”±éè™šæ¥å£æ‰‹æ³•å®ç° template methodï¼š</strong></p><p><strong>éè™šæ¥å£ï¼ˆnon-virtual interfaceï¼ŒNVIï¼‰</strong> è®¾è®¡æ‰‹æ³•çš„æ ¸å¿ƒå°±æ˜¯ç”¨ä¸€ä¸ªéè™šå‡½æ•°ä½œä¸º wrapperï¼Œå°†è™šå‡½æ•°éšè—åœ¨å°è£…ä¹‹ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">HealthValue</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        ...    <span class="comment">// åšä¸€äº›å‰ç½®å·¥ä½œ</span></span><br><span class="line">        <span class="type">int</span> retVal = <span class="built_in">DoHealthValue</span>();</span><br><span class="line">        ...    <span class="comment">// åšä¸€äº›åç½®å·¥ä½œ</span></span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">DoHealthValue</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        ...    <span class="comment">// ç¼ºçœç®—æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>NVIæ‰‹æ³•çš„ä¸€ä¸ªä¼˜ç‚¹å°±æ˜¯åœ¨ wrapper ä¸­åšä¸€äº›å‰ç½®å’Œåç½®å·¥ä½œï¼Œç¡®ä¿å¾—ä»¥åœ¨ä¸€ä¸ªè™šå‡½æ•°è¢«è°ƒç”¨ä¹‹å‰è®¾å®šå¥½é€‚å½“åœºæ™¯ï¼Œå¹¶åœ¨è°ƒç”¨ç»“æŸä¹‹åæ¸…ç†åœºæ™¯ã€‚å¦‚æœä½ è®©å®¢æˆ·ç›´æ¥è°ƒç”¨è™šå‡½æ•°ï¼Œå°±æ²¡æœ‰ä»»ä½•å¥½åŠæ³•å¯ä»¥åšè¿™äº›äº‹ã€‚</p><p>NVIæ‰‹æ³•å…è®¸æ´¾ç”Ÿç±»é‡æ–°å®šä¹‰è™šå‡½æ•°ï¼Œä»è€Œèµ‹äºˆå®ƒä»¬â€œå¦‚ä½•å®ç°æœºèƒ½â€çš„æ§åˆ¶èƒ½åŠ›ï¼Œä½†åŸºç±»ä¿ç•™è¯‰è¯´â€œå‡½æ•°ä½•æ—¶è¢«è°ƒç”¨â€çš„æƒåˆ©ã€‚</p><p>åœ¨NVIæ‰‹æ³•ä¸­è™šå‡½æ•°é™¤äº†å¯ä»¥æ˜¯privateï¼Œä¹Ÿå¯ä»¥æ˜¯protectedï¼Œä¾‹å¦‚è¦æ±‚åœ¨æ´¾ç”Ÿç±»çš„è™šå‡½æ•°å®ç°å†…è°ƒç”¨å…¶åŸºç±»çš„å¯¹åº”è™šå‡½æ•°æ—¶ï¼Œå°±å¿…é¡»å¾—è¿™ä¹ˆåšã€‚</p><p><strong>è—‰ç”±å‡½æ•°æŒ‡é’ˆå®ç° Strategy æ¨¡å¼ï¼š</strong></p><p>å‚è€ƒä»¥ä¸‹ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">DefaultHealthCalc</span><span class="params">(<span class="type">const</span> GameCharacter&amp;)</span></span>;        <span class="comment">// ç¼ºçœç®—æ³•</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> HealthCalcFunc = <span class="built_in">int</span>(*)(<span class="type">const</span> GameCharacter&amp;);    <span class="comment">// å®šä¹‰å‡½æ•°æŒ‡é’ˆç±»å‹</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">GameCharacter</span><span class="params">(HealthCalcFunc hcf = DefaultHealthCalc)</span></span></span><br><span class="line"><span class="function">        : healthFunc(hcf) &#123;</span>&#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">HealthValue</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">healthFunc</span>(*<span class="keyword">this</span>); &#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    HealthCalcFunc healthFunc;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åŒä¸€ä¸ªäººç‰©ç±»å‹çš„ä¸åŒå®ä½“å¯ä»¥æœ‰ä¸åŒçš„å¥åº·è®¡ç®—å‡½æ•°ï¼Œå¹¶ä¸”è¯¥è®¡ç®—å‡½æ•°å¯ä»¥åœ¨è¿è¡ŒæœŸå˜æ›´ã€‚</p><p>è¿™é—´æ¥è¡¨æ˜å¥åº·è®¡ç®—å‡½æ•°ä¸å†æ˜¯<code>GameCharacter</code>ç»§æ‰¿ä½“ç³»å†…çš„æˆå‘˜å‡½æ•°ï¼Œå®ƒä¹Ÿæ— æƒä½¿ç”¨épublicæˆå‘˜ã€‚ä¸ºäº†å¡«è¡¥è¿™ä¸ªç¼ºé™·ï¼Œæˆ‘ä»¬å”¯ä¸€çš„åšæ³•æ˜¯å¼±åŒ–ç±»çš„å°è£…ï¼Œå¼•å…¥å‹å…ƒæˆ–æä¾›publicè®¿é—®å‡½æ•°ã€‚</p><p><strong>è—‰ç”± std::function å®Œæˆ Strategy æ¨¡å¼</strong></p><p><code>std::function</code>æ˜¯ C++11 ä¸­å¼•å…¥çš„å‡½æ•°åŒ…è£…å™¨ï¼Œä½¿ç”¨å®ƒèƒ½æä¾›æ¯”å‡½æ•°æŒ‡é’ˆæ›´å¼ºçš„çµæ´»åº¦ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">DefaultHealthCalc</span><span class="params">(<span class="type">const</span> GameCharacter&amp;)</span></span>;        <span class="comment">// ç¼ºçœç®—æ³•</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> HealthCalcFunc = std::function&lt;<span class="built_in">int</span>(<span class="type">const</span> GameCharacter&amp;)&gt;;    <span class="comment">// å®šä¹‰å‡½æ•°åŒ…è£…å™¨ç±»å‹</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">GameCharacter</span><span class="params">(HealthCalcFunc hcf = DefaultHealthCalc)</span></span></span><br><span class="line"><span class="function">        : healthFunc(hcf) &#123;</span>&#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">HealthValue</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">healthFunc</span>(*<span class="keyword">this</span>); &#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    HealthCalcFunc healthFunc;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥å¹¶æ²¡æœ‰å¾ˆå¤§çš„æ”¹å˜ï¼Œä½†å½“æˆ‘ä»¬éœ€è¦æ—¶ï¼Œ<code>std::function</code>å°±èƒ½å±•ç°å‡ºæƒŠäººçš„å¼¹æ€§ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨è¿”å›å€¼ä¸åŒçš„å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">short</span> <span class="title">CalcHealth</span><span class="params">(<span class="type">const</span> GameCharacter&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">GameCharacter <span class="title">chara1</span><span class="params">(CalcHealth)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨å‡½æ•°å¯¹è±¡ï¼ˆä»¿å‡½æ•°ï¼‰</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HealthCalculator</span> &#123;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> GameCharacter&amp;)</span> <span class="type">const</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">GameCharacter <span class="title">chara2</span><span class="params">(HealthCalculator())</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨æŸä¸ªæˆå‘˜å‡½æ•°</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameLevel</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">float</span> <span class="title">Health</span><span class="params">(<span class="type">const</span> GameCharacter&amp;)</span> <span class="type">const</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">GameLevel currentLevel;</span><br><span class="line"><span class="function">GameCharacter <span class="title">chara2</span><span class="params">(std::bind(&amp;GameLevel::Health, currentLevel, std::placeholders::_1))</span></span>;</span><br></pre></td></tr></table></figure><p><strong>å¤å…¸çš„ Strategy æ¨¡å¼ï¼š</strong></p><p>åœ¨å¤å…¸çš„ Strategy æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬å¹¶éç›´æ¥åˆ©ç”¨å‡½æ•°æŒ‡é’ˆï¼ˆæˆ–åŒ…è£…å™¨ï¼‰è°ƒç”¨å‡½æ•°ï¼Œè€Œæ˜¯å†…å«ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ¥è‡ª<code>HealthCalcFunc</code>ç»§æ‰¿ä½“ç³»çš„å¯¹è±¡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HealthCalcFunc</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">Calc</span><span class="params">(<span class="type">const</span> GameCharacter&amp; gc)</span> <span class="type">const</span> </span>&#123; ... &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">HealthCalcFunc defaultHealthCalc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">GameCharacter</span><span class="params">(HealthCalcFunc* phcf = &amp;defaultHealthCalc)</span></span></span><br><span class="line"><span class="function">        : pHealthCalc(phcf) &#123;</span>&#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">HealthValue</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> pHealthCalc-&gt;<span class="built_in">Calc</span>(*<span class="keyword">this</span>); &#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    HealthCalcFunc* pHealthCalc;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè®¾è®¡æ¨¡å¼çš„å¥½å¤„åœ¨äºè¶³å¤Ÿå®¹æ˜“è¾¨è®¤ï¼Œæƒ³è¦æ·»åŠ æ–°çš„è®¡ç®—å‡½æ•°ä¹Ÿåªéœ€è¦ä¸º<code>HealthCalcFunc</code>åŸºç±»æ·»åŠ ä¸€ä¸ªæ´¾ç”Ÿç±»å³å¯ã€‚</p><h3 id="æ¡æ¬¾-36ï¼šç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„éè™šå‡½æ•°">æ¡æ¬¾ 36ï¼šç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„éè™šå‡½æ•°</h3><p>éè™šå‡½æ•°å’Œè™šå‡½æ•°å…·æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼šéè™šå‡½æ•°æ‰§è¡Œçš„æ˜¯é™æ€ç»‘å®šï¼ˆstatically boundï¼Œåˆç§°å‰æœŸç»‘å®šï¼Œearly bindingï¼‰ï¼Œç”±å¯¹è±¡ç±»å‹æœ¬èº«ï¼ˆç§°ä¹‹é™æ€ç±»å‹ï¼‰å†³å®šè¦è°ƒç”¨çš„å‡½æ•°ï¼›è€Œè™šå‡½æ•°æ‰§è¡Œçš„æ˜¯åŠ¨æ€ç»‘å®šï¼ˆdynamically boundï¼Œåˆç§°åæœŸç»‘å®šï¼Œlate bindingï¼‰ï¼Œå†³å®šå› ç´ ä¸åœ¨å¯¹è±¡æœ¬èº«ï¼Œè€Œåœ¨äºâ€œæŒ‡å‘è¯¥å¯¹è±¡ä¹‹æŒ‡é’ˆâ€å½“åˆçš„å£°æ˜ç±»å‹ï¼ˆç§°ä¹‹åŠ¨æ€ç±»å‹ï¼‰ã€‚</p><p>å‰é¢æˆ‘ä»¬å·²ç»è¯´è¿‡ï¼Œpublicç»§æ‰¿æ„å‘³ç€ is-a å…³ç³»ï¼Œè€Œåœ¨åŸºç±»ä¸­å£°æ˜ä¸€ä¸ªéè™šå‡½æ•°å°†ä¼šä¸ºè¯¥ç±»å»ºç«‹èµ·ä¸€ç§ä¸å˜æ€§ï¼ˆinvariantï¼‰ï¼Œå‡Œé©¾å…¶ç‰¹å¼‚æ€§ï¼ˆspecializationï¼‰ã€‚è€Œè‹¥åœ¨æ´¾ç”Ÿç±»ä¸­é‡æ–°å®šä¹‰è¯¥éè™šå‡½æ•°ï¼Œåˆ™ä¼šä½¿äººå¼€å§‹è´¨ç–‘æ˜¯å¦è¯¥ä½¿ç”¨publicç»§æ‰¿çš„å½¢å¼ï¼›å¦‚æœå¿…é¡»ä½¿ç”¨ï¼Œåˆ™åˆæ‰“ç ´äº†åŸºç±»â€œä¸å˜æ€§å‡Œé©¾ç‰¹å¼‚æ€§â€çš„æ€§è´¨ï¼Œå°±æ­¤äº§ç”Ÿäº†è®¾è®¡ä¸Šçš„çŸ›ç›¾ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸è¯¥é‡æ–°å®šä¹‰ä¸€ä¸ªç»§æ‰¿è€Œæ¥çš„éè™šå‡½æ•°ã€‚</p><h3 id="æ¡æ¬¾-37ï¼šç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„ç¼ºçœå‚æ•°å€¼">æ¡æ¬¾ 37ï¼šç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„ç¼ºçœå‚æ•°å€¼</h3><p>é‡ç‚¹ï¼š<strong>ç¼ºçœå‚æ•°å€¼å´æ˜¯é™æ€ç»‘å®š</strong></p><p><strong>ä»€ä¹ˆæ˜¯å¤šæ€ï¼Ÿ</strong></p><p>é™æ€ï¼šç¼–è¯‘æ—¶æœŸçš„å¤šæ€ã€‚ï¼ˆå¤šç§å¤šæ ·çš„å½¢æ€ï¼‰ã€‚å¦‚ å‡½æ•°é‡è½½</p><p>åŠ¨æ€ï¼šè¿è¡Œæ—¶æœŸçš„å¤šæ€</p><hr><p>åœ¨æ¡æ¬¾ 36 ä¸­æˆ‘ä»¬å·²ç»å¦å®šäº†é‡æ–°å®šä¹‰éè™šå‡½æ•°çš„å¯èƒ½æ€§ï¼Œå› æ­¤æ­¤å¤„æˆ‘ä»¬åªè®¨è®ºå¸¦æœ‰ç¼ºçœå‚æ•°å€¼çš„è™šå‡½æ•°ã€‚</p><p>è™šå‡½æ•°æ˜¯åŠ¨æ€ç»‘å®šè€Œæ¥ï¼Œæ„æ€æ˜¯è°ƒç”¨ä¸€ä¸ªè™šå‡½æ•°æ—¶ï¼Œç©¶ç«Ÿè°ƒç”¨å“ªä¸€ä»½å‡½æ•°å®ç°ä»£ç ï¼Œå–å†³äºå‘å‡ºè°ƒç”¨çš„é‚£ä¸ªå¯¹è±¡çš„åŠ¨æ€ç±»å‹ã€‚ä½†ä¸ä¹‹ä¸åŒçš„æ˜¯ï¼Œ<strong>ç¼ºçœå‚æ•°å€¼å´æ˜¯é™æ€ç»‘å®š</strong>ï¼Œæ„æ€æ˜¯ä½ å¯èƒ½ä¼šåœ¨â€œè°ƒç”¨ä¸€ä¸ªå®šä¹‰äºæ´¾ç”Ÿç±»çš„è™šå‡½æ•°â€çš„åŒæ—¶ï¼Œå´ä½¿ç”¨åŸºç±»ä¸ºå®ƒæ‰€æŒ‡å®šçš„ç¼ºçœå‚æ•°å€¼ã€‚è€ƒè™‘ä»¥ä¸‹ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum class</span> <span class="title class_">ShapeColor</span> &#123; Red, Green, Blue &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Draw</span><span class="params">(ShapeColor color = ShapeColor::Red)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span> : <span class="keyword">public</span> Shape &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Draw</span><span class="params">(ShapeColor color = ShapeColor::Green)</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span> : <span class="keyword">public</span> Shape &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Draw</span><span class="params">(ShapeColor color)</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è‹¥å¯¹æ´¾ç”Ÿç±»å¯¹è±¡è°ƒç”¨<code>Draw</code>å‡½æ•°ï¼Œåˆ™ä¼šå‘ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Shape* pr = <span class="keyword">new</span> Rectangle;</span><br><span class="line">Shape* pc = <span class="keyword">new</span> Circle;</span><br><span class="line"></span><br><span class="line">pr-&gt;<span class="built_in">Draw</span>(Shape::ShapeColor::Green);    <span class="comment">// è°ƒç”¨ Rectangle::Draw(Shape::Green)</span></span><br><span class="line">pr-&gt;<span class="built_in">Draw</span>();                            <span class="comment">// è°ƒç”¨ Rectangle::Draw(Shape::Red)</span></span><br><span class="line">pc-&gt;<span class="built_in">Draw</span>();                            <span class="comment">// è°ƒç”¨ Rectangle::Draw(Shape::Red)</span></span><br></pre></td></tr></table></figure><p>è¿™å°±è¿«ä½¿æˆ‘ä»¬åœ¨æŒ‡å®šè™šå‡½æ•°æ—¶ä½¿ç”¨ç›¸åŒçš„ç¼ºçœå‚æ•°å€¼ï¼Œä¸ºäº†é¿å…ä¸å¿…è¦çš„éº»çƒ¦å’Œé”™è¯¯ï¼Œå¯ä»¥è€ƒè™‘æ¡æ¬¾ 35 ä¸­åˆ—å‡ºçš„è™šå‡½æ•°çš„æ›¿ä»£è®¾è®¡ï¼Œä¾‹å¦‚NVIæ‰‹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum class</span> <span class="title class_">ShapeColor</span> &#123; Red, Green, Blue &#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Draw</span><span class="params">(ShapeColor color = ShapeColor::Red)</span> <span class="type">const</span> </span>&#123; <span class="built_in">DoDraw</span>(color); &#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DoDraw</span><span class="params">(ShapeColor color)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span> : <span class="keyword">public</span> Shape &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DoDraw</span><span class="params">(ShapeColor color)</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-38ï¼šé€šè¿‡å¤åˆå¡‘æ¨¡å‡º-has-a-æˆ–â€œæ ¹æ®æŸç‰©å®ç°å‡ºâ€">æ¡æ¬¾ 38ï¼šé€šè¿‡å¤åˆå¡‘æ¨¡å‡º has-a æˆ–â€œæ ¹æ®æŸç‰©å®ç°å‡ºâ€</h3><p>æ‰€è°“<strong>å¤åˆï¼ˆcompositionï¼‰</strong>ï¼ŒæŒ‡çš„æ˜¯æŸç§ç±»å‹çš„å¯¹è±¡å†…å«å®ƒç§ç±»å‹çš„å¯¹è±¡ã€‚å¤åˆé€šå¸¸æ„å‘³ç€ <strong>has-a</strong> æˆ–<strong>æ ¹æ®æŸç‰©å®ç°å‡ºï¼ˆis-implemented-in-terms-ofï¼‰</strong> çš„å…³ç³»ï¼Œå½“å¤åˆå‘ç”Ÿäºåº”ç”¨åŸŸï¼ˆapplication domainï¼‰å†…çš„å¯¹è±¡ä¹‹é—´ï¼Œè¡¨ç°å‡º has-a çš„å…³ç³»ï¼›å½“å®ƒå‘ç”Ÿäºå®ç°åŸŸï¼ˆimplementation domainï¼‰å†…åˆ™æ˜¯è¡¨ç°å‡ºâ€œæ ¹æ®æŸç‰©å®ç°å‡ºâ€çš„å…³ç³»ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ª has-a å…³ç³»çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span> &#123; ... &#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PhoneNumber</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string name;           <span class="comment">// åˆæˆæˆåˆ†ç‰©ï¼ˆcomposed objectï¼‰</span></span><br><span class="line">    Address address;            <span class="comment">// åŒä¸Š</span></span><br><span class="line">    PhoneNumber voiceNumber;    <span class="comment">// åŒä¸Š</span></span><br><span class="line">    PhoneNumber faxNumber;      <span class="comment">// åŒä¸Š</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªâ€œæ ¹æ®æŸç‰©å®ç°å‡ºâ€å…³ç³»çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°† list åº”ç”¨äº Set</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Set</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">member</span><span class="params">(<span class="type">const</span> T&amp; item)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(<span class="type">const</span> T&amp; item)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">const</span> T&amp; item)</span></span>;</span><br><span class="line">    <span class="function">std::<span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::list&lt;T&gt; rep;           <span class="comment">// ç”¨æ¥è¡¨è¿° Set çš„æ•°æ®</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-39ï¼šæ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨privateç»§æ‰¿">æ¡æ¬¾ 39ï¼šæ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨privateç»§æ‰¿</h3><p>privateç»§æ‰¿çš„ç‰¹ç‚¹ï¼š</p><ol><li>å¦‚æœç±»ä¹‹é—´æ˜¯privateç»§æ‰¿å…³ç³»ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¸ä¼šè‡ªåŠ¨å°†ä¸€ä¸ªæ´¾ç”Ÿç±»å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ªåŸºç±»å¯¹è±¡ã€‚</li><li>ç”±privateç»§æ‰¿æ¥çš„æ‰€æœ‰æˆå‘˜ï¼Œåœ¨æ´¾ç”Ÿç±»ä¸­éƒ½ä¼šå˜ä¸ºprivateå±æ€§ï¼Œæ¢å¥è¯è¯´ï¼Œprivateç»§æ‰¿åªç»§æ‰¿å®ç°ï¼Œä¸ç»§æ‰¿æ¥å£ã€‚</li></ol><p>privateç»§æ‰¿çš„æ„ä¹‰æ˜¯â€œæ ¹æ®æŸç‰©å®ç°å‡ºâ€ï¼Œå¦‚æœä½ è¯»è¿‡æ¡æ¬¾ 38ï¼Œå°±ä¼šå‘ç°privateç»§æ‰¿å’Œå¤åˆå…·æœ‰ç›¸åŒçš„æ„ä¹‰ï¼Œäº‹å®ä¸Šä¹Ÿç¡®å®å¦‚æ­¤ï¼Œç»å¤§éƒ¨åˆ†privateç»§æ‰¿çš„ä½¿ç”¨åœºåˆéƒ½å¯ä»¥è¢«â€œpublicç»§æ‰¿+å¤åˆâ€å®Œç¾è§£å†³ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Timer</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Timer</span><span class="params">(<span class="type">int</span> tickFrequency)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnTick</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> : <span class="keyword">private</span> Timer &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnTick</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ›¿ä»£ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">WidgetTimer</span> : <span class="keyword">public</span> Timer &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnTick</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br><span class="line">    WidgetTimer timer;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨åè€…æ¯”å‰è€…å¥½çš„åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>privateç»§æ‰¿æ— æ³•é˜»æ­¢æ´¾ç”Ÿç±»é‡æ–°å®šä¹‰è™šå‡½æ•°ï¼Œä½†è‹¥ä½¿ç”¨publicç»§æ‰¿å®šä¹‰<code>WidgetTimer</code>ç±»å¹¶å¤åˆåœ¨<code>Widget</code>ç±»ä¸­ï¼Œå°±èƒ½é˜²æ­¢åœ¨<code>Widget</code>ç±»ä¸­é‡æ–°å®šä¹‰è™šå‡½æ•°ã€‚</li><li>å¯ä»¥ä»…æä¾›<code>WidgetTimer</code>ç±»çš„å£°æ˜ï¼Œå¹¶å°†<code>WidgetTimer</code>ç±»çš„å…·ä½“å®šä¹‰ç§»è‡³å®ç°æ–‡ä»¶ä¸­ï¼Œä»è€Œé™ä½<code>Widget</code>çš„ç¼–è¯‘ä¾å­˜æ€§ã€‚</li></ol><p>ç„¶è€Œprivateç»§æ‰¿å¹¶éå®Œå…¨ä¸€æ— æ˜¯å¤„ï¼Œä¸€ä¸ªé€‚ç”¨äºå®ƒçš„æç«¯æƒ…å†µæ˜¯<strong>ç©ºç™½åŸºç±»æœ€ä¼˜åŒ–ï¼ˆempty base optimizationï¼ŒEBOï¼‰</strong>ï¼Œå‚è€ƒä»¥ä¸‹ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Empty</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HoldsAnInt</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    Empty e;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæ²¡æœ‰éé™æ€æˆå‘˜å˜é‡ã€è™šå‡½æ•°çš„ç±»ï¼Œçœ‹ä¼¼ä¸éœ€è¦ä»»ä½•å­˜å‚¨ç©ºé—´ï¼Œä½†å®é™…ä¸Š C++ è§„å®šå‡¡æ˜¯ç‹¬ç«‹å¯¹è±¡éƒ½å¿…é¡»æœ‰éé›¶å¤§å°ï¼Œå› æ­¤æ­¤å¤„<code>sizeof(HoldsAnInt)</code>å¿…ç„¶å¤§äº<code>sizeof(int)</code>ï¼Œé€šå¸¸ä¼šå¤šå‡ºä¸€å­—èŠ‚å¤§å°ï¼Œä½†æœ‰æ—¶è€ƒè™‘åˆ°å†…å­˜å¯¹é½ä¹‹ç±»çš„è¦æ±‚ï¼Œå¯èƒ½ä¼šå¤šå‡ºæ›´å¤šçš„ç©ºé—´ã€‚</p><p>ä½¿ç”¨privateç»§æ‰¿å¯ä»¥é¿å…äº§ç”Ÿé¢å¤–å­˜å‚¨ç©ºé—´ï¼Œå°†ä¸Šé¢çš„ä»£ç æ›¿ä»£ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HoldsAnInt</span> : <span class="keyword">private</span> Empty &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-40ï¼šæ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨å¤šé‡ç»§æ‰¿">æ¡æ¬¾ 40ï¼šæ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨å¤šé‡ç»§æ‰¿</h3><p>å¤šé‡ç»§æ‰¿æ˜¯ä¸€ä¸ªå¯èƒ½ä¼šé€ æˆå¾ˆå¤šæ­§ä¹‰å’Œè¯¯è§£çš„è®¾è®¡ï¼Œå› æ­¤åå¯¹å®ƒçš„å£°éŸ³æ­¤èµ·å½¼ä¼ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æ¥è§¦å‡ ä¸ªä½¿ç”¨å¤šé‡ç»§æ‰¿çš„åœºæ™¯ã€‚</p><p>æœ€å…ˆéœ€è¦è®¤æ¸…çš„ä¸€ä»¶äº‹æ˜¯ï¼Œç¨‹åºæœ‰å¯èƒ½ä»ä¸€ä¸ªä»¥ä¸Šçš„åŸºç±»ç»§æ‰¿ç›¸åŒåç§°ï¼Œé‚£ä¼šå¯¼è‡´è¾ƒå¤šçš„æ­§ä¹‰æœºä¼šï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BorrowableItem</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">CheckOut</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ElectronicGadget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">CheckOut</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MP3Player</span> : <span class="keyword">public</span> BorrowableItem, <span class="keyword">public</span> ElectronicGadget &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MP3Player mp;</span><br><span class="line">mp.<span class="built_in">CheckOut</span>();          <span class="comment">// MP3Player::CheckOut ä¸æ˜ç¡®ï¼</span></span><br></pre></td></tr></table></figure><p>å¦‚æœçœŸé‡åˆ°è¿™ç§æƒ…å†µï¼Œå¿…é¡»æ˜ç¡®åœ°æŒ‡å‡ºè¦è°ƒç”¨å“ªä¸€ä¸ªåŸºç±»ä¸­çš„å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mp.BorrowableItem::<span class="built_in">CheckOut</span>();      <span class="comment">// ä½¿ç”¨ BorrowableItem::CheckOut</span></span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨å¤šé‡ç»§æ‰¿æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°è¦å‘½çš„â€œé’»çŸ³å‹ç»§æ‰¿ï¼ˆè±å½¢ç»§æ‰¿ï¼‰â€ï¼š</p><p><img src="https://pic3.zhimg.com/80/v2-882fec69eb599914ab430741992742ca_720w.webp" alt="img"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">File</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InputFile</span> : <span class="keyword">public</span> File &#123; ... &#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OutputFile</span> : <span class="keyword">public</span> File &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IOFile</span> : <span class="keyword">public</span> InputFile, <span class="keyword">public</span> OutputFile &#123; ... &#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™å¿…é¡»é¢å¯¹è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šæ˜¯å¦æ‰“ç®—è®©åŸºç±»å†…çš„æˆå‘˜å˜é‡ç»ç”±æ¯ä¸€æ¡è·¯å¾„è¢«å¤åˆ¶ï¼Ÿå¦‚æœä¸æƒ³è¦è¿™æ ·ï¼Œåº”å½“ä½¿ç”¨è™šç»§æ‰¿ï¼ŒæŒ‡å‡ºå…¶æ„¿æ„å…±äº«åŸºç±»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">File</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InputFile</span> : <span class="keyword">virtual</span> <span class="keyword">public</span> File &#123; ... &#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OutputFile</span> : <span class="keyword">virtual</span> <span class="keyword">public</span> File &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IOFile</span> : <span class="keyword">public</span> InputFile, <span class="keyword">public</span> OutputFile &#123; ... &#125;;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œç”±äºè™šç»§æ‰¿ä¼šåœ¨æ´¾ç”Ÿç±»ä¸­é¢å¤–å­˜å‚¨ä¿¡æ¯æ¥ç¡®è®¤æˆå‘˜æ¥è‡ªäºå“ªä¸ªåŸºç±»ï¼Œè™šç»§æ‰¿é€šå¸¸ä¼šä»˜å‡ºæ›´å¤šç©ºé—´å’Œé€Ÿåº¦çš„ä»£ä»·ï¼Œå¹¶ä¸”ç”±äºè™šåŸºç±»çš„åˆå§‹åŒ–è´£ä»»æ˜¯ç”±ç»§æ‰¿ä½“ç³»ä¸­æœ€åº•å±‚çš„æ´¾ç”Ÿç±»è´Ÿè´£ï¼Œå°±å¯¼è‡´äº†è™šåŸºç±»å¿…é¡»è®¤çŸ¥å…¶è™šåŸºç±»å¹¶ä¸”æ‰¿æ‹…è™šåŸºç±»çš„åˆå§‹åŒ–è´£ä»»ã€‚å› æ­¤æˆ‘ä»¬åº”å½“éµå¾ªä»¥ä¸‹ä¸¤ä¸ªå»ºè®®ï¼š</p><ol><li>éå¿…è¦ä¸ä½¿ç”¨è™šç»§æ‰¿ã€‚</li><li>å¦‚æœå¿…é¡»ä½¿ç”¨è™šç»§æ‰¿ï¼Œå°½å¯èƒ½é¿å…åœ¨è™šåŸºç±»ä¸­æ”¾ç½®æ•°æ®ã€‚</li></ol><p>å¤šé‡ç»§æ‰¿å¯ç”¨äºç»“åˆpublicç»§æ‰¿å’Œprivateç»§æ‰¿ï¼Œpublicç»§æ‰¿ç”¨äºæä¾›æ¥å£ï¼Œprivateç»§æ‰¿ç”¨äºæä¾›å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IPerson ç±»æŒ‡å‡ºè¦å®ç°çš„æ¥å£</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IPerson</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">IPerson</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">Name</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">BirthDate</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseID</span> &#123;  ...  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PersonInfo ç±»æœ‰è‹¥å¹²å·²å®ç°çš„å‡½æ•°</span></span><br><span class="line"><span class="comment">// å¯ç”¨ä»¥å®ç° IPerson æ¥å£</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PersonInfo</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">PersonInfo</span><span class="params">(DatabaseID pid)</span></span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">PersonInfo</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">TheName</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">TheBirthDate</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">ValueDelimOpen</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">ValueDelimClose</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CPerson ç±»ä½¿ç”¨å¤šé‡ç»§æ‰¿</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CPerson</span>: <span class="keyword">public</span> IPerson, <span class="keyword">private</span> PersonInfo &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">CPerson</span><span class="params">(DatabaseID pid)</span>: PersonInfo(pid) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">Name</span><span class="params">()</span> <span class="type">const</span> </span>&#123;       <span class="comment">// å®ç°å¿…è¦çš„ IPerson æˆå‘˜å‡½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> PersonInfo::<span class="built_in">TheName</span>();  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">BirthDate</span><span class="params">()</span> <span class="type">const</span> </span>&#123;  <span class="comment">// å®ç°å¿…è¦çš„ IPerson æˆå‘˜å‡½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> PersonInfo::<span class="built_in">TheBirthDate</span>();  </span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„è™šå‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">ValueDelimOpen</span><span class="params">()</span> <span class="type">const</span> </span>&#123;  <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  &#125;</span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">ValueDelimClose</span><span class="params">()</span> <span class="type">const</span> </span>&#123;  <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸ƒç« ï¼šæ¨¡æ¿ä¸æ³›å‹ç¼–ç¨‹">ç¬¬ä¸ƒç« ï¼šæ¨¡æ¿ä¸æ³›å‹ç¼–ç¨‹</h2><h3 id="æ¡æ¬¾-41ï¼šäº†è§£éšå¼æ¥å£å’Œç¼–è¯‘æœŸå¤šæ€">æ¡æ¬¾ 41ï¼šäº†è§£éšå¼æ¥å£å’Œç¼–è¯‘æœŸå¤šæ€</h3><p>ç±»ä¸æ¨¡æ¿éƒ½æ”¯æŒæ¥å£å’Œå¤šæ€ã€‚å¯¹äºç±»è€Œè¨€æ¥å£æ˜¯æ˜¾å¼çš„ï¼Œä»¥å‡½æ•°ç­¾åä¸ºä¸­å¿ƒï¼Œå¤šæ€åˆ™æ˜¯é€šè¿‡è™šå‡½æ•°å‘ç”Ÿäºè¿è¡ŒæœŸï¼›è€Œå¯¹æ¨¡æ¿å‚æ•°è€Œè¨€ï¼Œæ¥å£æ˜¯éšå¼çš„ï¼Œå¥ åŸºäºæœ‰æ•ˆè¡¨è¾¾å¼ï¼Œå¤šæ€åˆ™æ˜¯é€šè¿‡æ¨¡æ¿å…·ç°åŒ–å’Œå‡½æ•°é‡è½½è§£æï¼ˆfunction overloading resolutionï¼‰å‘ç”Ÿäºç¼–è¯‘æœŸã€‚</p><p>è€ƒè™‘ä»¥ä¸‹ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DoProcessing</span><span class="params">(T&amp; w)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (w.<span class="built_in">size</span>() &gt; <span class="number">10</span> &amp;&amp; w != someNastyWidget) &#123;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç ä¸­ï¼Œ<code>T</code>ç±»å‹çš„éšå¼æ¥å£è¦æ±‚ï¼š</p><ol><li>æä¾›ä¸€ä¸ªåä¸º<code>size</code>çš„æˆå‘˜å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„è¿”å›å€¼å¯ä¸<code>int</code>ï¼ˆ10 çš„ç±»å‹ï¼‰æ‰§è¡Œ<code>operator&gt;</code>ï¼Œæˆ–ç»è¿‡éšå¼è½¬æ¢åå¯æ‰§è¡Œ<code>operator&gt;</code>ã€‚</li><li>å¿…é¡»æ”¯æŒä¸€ä¸ª<code>operator!=</code>å‡½æ•°ï¼Œæ¥å—<code>T</code>ç±»å‹å’Œ<code>someNastyWidget</code>çš„ç±»å‹ï¼Œæˆ–å…¶éšå¼è½¬æ¢åå¾—åˆ°çš„ç±»å‹ã€‚</li></ol><blockquote><p>æ­¤å¤„æ²¡æœ‰è€ƒè™‘<code>operator&amp;&amp;</code>è¢«é‡è½½çš„å¯èƒ½æ€§ã€‚</p></blockquote><p>åŠ è¯¸äºæ¨¡æ¿å‚æ•°èº«ä¸Šçš„éšå¼æ¥å£ï¼Œå°±åƒåŠ è¯¸äºç±»å¯¹è±¡èº«ä¸Šçš„æ˜¾å¼æ¥å£â€œä¸€æ ·çœŸå®â€ï¼Œä¸¤è€…éƒ½åœ¨ç¼–è¯‘æœŸå®Œæˆæ£€æŸ¥ï¼Œä½ æ— æ³•åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨â€œä¸æ”¯æŒæ¨¡æ¿æ‰€è¦æ±‚ä¹‹éšå¼æ¥å£â€çš„å¯¹è±¡ï¼ˆä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ï¼‰ã€‚</p><h3 id="æ¡æ¬¾-42ï¼šäº†è§£-typename-çš„åŒé‡å«ä¹‰">æ¡æ¬¾ 42ï¼šäº†è§£ typename çš„åŒé‡å«ä¹‰</h3><p>åœ¨æ¨¡æ¿å£°æ˜å¼ä¸­ï¼Œä½¿ç”¨<code>class</code>å’Œ<code>typename</code>å…³é”®å­—å¹¶æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œä½†åœ¨æ¨¡æ¿å†…éƒ¨ï¼Œ<code>typename</code>æ‹¥æœ‰æ›´å¤šçš„ä¸€é‡å«ä¹‰ã€‚</p><p>ç†è§£ï¼šä¸ºäº†æ–¹ä¾¿è§£é‡Šï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¼•å…¥ä¸€ä¸ªæ¨¡æ¿ç›¸å…³çš„æ¦‚å¿µï¼šæ¨¡æ¿å†…å‡ºç°çš„åç§°å¦‚æœç›¸ä¾äºæŸä¸ªæ¨¡æ¿å‚æ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>ä»å±åç§°ï¼ˆdependent namesï¼‰</strong>ï¼›å¦‚æœä»å±åç§°åœ¨ç±»å†…å‘ˆåµŒå¥—çŠ¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>åµŒå¥—ä»å±åç§°ï¼ˆnested dependent nameï¼‰</strong>ï¼›å¦‚æœä¸€ä¸ªåç§°å¹¶ä¸å€šèµ–ä»»ä½•æ¨¡æ¿å‚æ•°çš„åç§°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>éä»å±åç§°ï¼ˆnon-dependent namesï¼‰</strong>ã€‚</p><p>è€ƒè™‘ä»¥ä¸‹æ¨¡æ¿ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> C&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Print2nd</span><span class="params">(<span class="type">const</span> C&amp; container)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (container.<span class="built_in">size</span>() &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="function">C::const_iterator <span class="title">iter</span><span class="params">(container.begin())</span></span>;</span><br><span class="line">        ++iter;</span><br><span class="line">        <span class="type">int</span> value = *iter;</span><br><span class="line">        std::cout &lt;&lt; value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†å®é™…ç¼–è¯‘æ—¶å´ä¼šæŠ¥é”™ï¼Œè¿™ä¸€åˆ‡çš„ç½ªé­ç¥¸é¦–ä¾¿æ˜¯<code>C::const_iterator</code>ã€‚æ­¤å¤„çš„<code>C::const_iterator</code>æ˜¯ä¸€ä¸ªæŒ‡å‘æŸç±»å‹çš„<strong>åµŒå¥—ä»å±ç±»å‹åç§°ï¼ˆnested dependent type nameï¼‰</strong>ï¼Œè€ŒåµŒå¥—ä»å±åç§°å¯èƒ½ä¼šå¯¼è‡´è§£æå›°éš¾ï¼Œå› ä¸ºåœ¨ç¼–è¯‘å™¨çŸ¥é“<code>C</code>æ˜¯ä»€ä¹ˆä¹‹å‰ï¼Œæ²¡æœ‰ä»»ä½•åŠæ³•çŸ¥é“<code>C::const_iterator</code>æ˜¯å¦ä¸ºä¸€ä¸ªç±»å‹ï¼Œè¿™å°±å¯¼è‡´å‡ºç°äº†æ­§ä¹‰çŠ¶æ€ï¼Œè€Œ C++ é»˜è®¤å‡è®¾åµŒå¥—ä»å±åç§°ä¸æ˜¯ç±»å‹åç§°ã€‚</p><p>æ˜¾å¼æŒ‡æ˜åµŒå¥—ä»å±ç±»å‹åç§°çš„æ–¹æ³•å°±æ˜¯å°†<code>typename</code>å…³é”®å­—ä½œä¸ºå…¶å‰ç¼€è¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typename</span> C::const_iterator <span class="title">iter</span><span class="params">(container.begin())</span></span>;</span><br></pre></td></tr></table></figure><p>åŒæ ·åœ°ï¼Œè‹¥åµŒå¥—ä»å±åç§°å‡ºç°åœ¨æ¨¡æ¿å‡½æ•°å£°æ˜éƒ¨åˆ†ï¼Œä¹Ÿéœ€è¦æ˜¾å¼åœ°æŒ‡æ˜æ˜¯å¦ä¸ºç±»å‹åç§°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> C&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Print2nd</span><span class="params">(<span class="type">const</span> C&amp; container, <span class="type">const</span> <span class="keyword">typename</span> C::iterator iter)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€è§„åˆ™çš„ä¾‹å¤–æ˜¯ï¼Œ<code>typename</code>ä¸å¯ä»¥å‡ºç°åœ¨åŸºç±»åˆ—è¡¨å†…çš„åµŒå¥—ä»å±ç±»å‹åç§°ä¹‹å‰ï¼Œä¹Ÿä¸å¯ä»¥åœ¨æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨ä¸­ä½œä¸ºåŸºç±»çš„ä¿®é¥°ç¬¦ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base&lt;T&gt;::Nested &#123;    <span class="comment">// åŸºç±»åˆ—è¡¨ä¸­ä¸å…è®¸ä½¿ç”¨ typename</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Derived</span><span class="params">(<span class="type">int</span> x)</span></span></span><br><span class="line"><span class="function">        : Base&lt;T&gt;::Nested(x) &#123;</span>                 <span class="comment">// æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨ä¸­ä¸å…è®¸ä½¿ç”¨ typename</span></span><br><span class="line">        <span class="keyword">typename</span> Base&lt;T&gt;::Nested temp;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ç±»å‹åç§°è¿‡äºå¤æ‚æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>using</code>æˆ–<code>typedef</code>æ¥è¿›è¡Œç®€åŒ–ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> value_type = <span class="keyword">typename</span> std::iterator_traits&lt;IterT&gt;::value_type;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-43ï¼šå­¦ä¹ å¤„ç†æ¨¡æ¿åŒ–åŸºç±»å†…çš„åç§°">æ¡æ¬¾ 43ï¼šå­¦ä¹ å¤„ç†æ¨¡æ¿åŒ–åŸºç±»å†…çš„åç§°</h3><p>åœ¨æ¨¡æ¿ç¼–ç¨‹ä¸­ï¼Œæ¨¡æ¿ç±»çš„ç»§æ‰¿å¹¶ä¸åƒæ™®é€šç±»é‚£ä¹ˆè‡ªç„¶ï¼Œè€ƒè™‘ä»¥ä¸‹æƒ…å½¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MsgInfo</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Company&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MsgSender</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SendClear</span><span class="params">(<span class="type">const</span> MsgInfo&amp; info)</span> </span>&#123; ... &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Company&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoggingMsgSender</span> : <span class="keyword">public</span> MsgSender&lt;Company&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SendClearMsg</span><span class="params">(<span class="type">const</span> MsgInfo&amp; info)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">SendClear</span>(info);        <span class="comment">// è°ƒç”¨åŸºç±»å‡½æ•°ï¼Œè¿™æ®µä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œç”±äºç›´åˆ°æ¨¡æ¿ç±»è¢«çœŸæ­£å®ä¾‹åŒ–ä¹‹å‰ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“<code>MsgSender&lt;Company&gt;</code>å…·ä½“é•¿ä»€ä¹ˆæ ·ï¼Œæœ‰å¯èƒ½å®ƒæ˜¯ä¸€ä¸ªå…¨ç‰¹åŒ–çš„ç‰ˆæœ¬ï¼Œè€Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ä¸å­˜åœ¨<code>SendClear</code>å‡½æ•°ã€‚ç”±äº C++ çš„è®¾è®¡ç­–ç•¥æ˜¯å®æ„¿è¾ƒæ—©è¿›è¡Œè¯Šæ–­ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¼šæ‹’ç»æ‰¿è®¤åœ¨åŸºç±»ä¸­å­˜åœ¨ä¸€ä¸ª<code>SendClear</code>å‡½æ•°ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä»¤ C++â€œè¿›å…¥æ¨¡æ¿åŸºç±»è§‚å¯Ÿâ€çš„è¡Œä¸ºç”Ÿæ•ˆï¼Œæœ‰ä¸‰ç§åŠæ³•è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼š</p><p>ç¬¬ä¸€ç§ï¼šåœ¨åŸºç±»å‡½æ•°è°ƒç”¨åŠ¨ä½œä¹‹å‰åŠ ä¸Š<code>this-&gt;</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">SendClear</span>(info);</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§ï¼šä½¿ç”¨<code>using</code>å£°æ˜å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MsgSender&lt;Company&gt;::SendClear;</span><br><span class="line"><span class="built_in">SendClear</span>(info);</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰ç§ï¼šæ˜ç™½æŒ‡å‡ºè¢«è°ƒç”¨çš„å‡½æ•°ä½äºåŸºç±»å†…ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MsgSender&lt;Company&gt;::<span class="built_in">SendClear</span>(info);</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰ç§åšæ³•æ˜¯æœ€ä¸ä»¤äººæ»¡æ„çš„ï¼Œå¦‚æœè¢«è°ƒç”¨çš„æ˜¯è™šå‡½æ•°ï¼Œä¸Šè¿°çš„æ˜ç¡®èµ„æ ¼ä¿®é¥°ï¼ˆexplicit qualificationï¼‰ä¼šä½¿â€œè™šå‡½æ•°ç»‘å®šè¡Œä¸ºâ€å¤±æ•ˆã€‚</p><h3 id="æ¡æ¬¾-44ï¼šå°†ä¸å‚æ•°æ— å…³çš„ä»£ç æŠ½ç¦»æ¨¡æ¿">æ¡æ¬¾ 44ï¼šå°†ä¸å‚æ•°æ— å…³çš„ä»£ç æŠ½ç¦»æ¨¡æ¿</h3><p>æ¨¡æ¿å¯ä»¥èŠ‚çœæ—¶é—´å’Œé¿å…ä»£ç é‡å¤ï¼Œç¼–è¯‘å™¨ä¼šä¸ºå¡«å…¥çš„æ¯ä¸ªä¸åŒæ¨¡æ¿å‚æ•°å…·ç°åŒ–å‡ºä¸€ä»½å¯¹åº”çš„ä»£ç ï¼Œä½†é•¿æ­¤ä»¥å¤–ï¼Œå¯èƒ½ä¼šé€ æˆä»£ç è†¨èƒ€ï¼ˆcode bloatï¼‰ï¼Œç”Ÿæˆæµ®å¤¸çš„äºŒè¿›åˆ¶ç›®æ ‡ç ã€‚</p><p>åŸºäº<strong>å…±æ€§å’Œå˜æ€§åˆ†æï¼ˆcommonality and variability analysisï¼‰</strong> çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦åˆ†ææ¨¡æ¿ä¸­é‡å¤ä½¿ç”¨çš„éƒ¨åˆ†ï¼Œå°†å…¶æŠ½ç¦»å‡ºæ¨¡æ¿ï¼Œä»¥å‡è½»æ¨¡æ¿å…·ç°åŒ–å¸¦æ¥çš„ä»£ç é‡ã€‚</p><ul><li>å› éç±»å‹æ¨¡æ¿å‚æ•°è€Œé€ æˆçš„ä»£ç è†¨èƒ€ï¼Œå¾€å¾€å¯ä»¥æ¶ˆé™¤ï¼Œåšæ³•æ˜¯ä»¥å‡½æ•°å‚æ•°æˆ–ç±»æˆå‘˜å˜é‡æ›¿æ¢æ¨¡æ¿å‚æ•°ã€‚</li><li>å› ç±»å‹æ¨¡æ¿å‚æ•°è€Œé€ æˆçš„ä»£ç è†¨èƒ€ï¼Œå¾€å¾€å¯ä»¥é™ä½ï¼Œåšæ³•æ˜¯è®©å¸¦æœ‰å®Œå…¨ç›¸åŒäºŒè¿›åˆ¶è¡¨è¿°çš„å…·ç°ç±»å‹å…±äº«å®ç°ä»£ç ã€‚</li></ul><p>å‚è€ƒä»¥ä¸‹çŸ©é˜µç±»çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, std::<span class="type">size_t</span> n&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SquareMatrix</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Invert</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::array&lt;T, n * n&gt; data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SquareMatrixBase</span> &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Invert</span><span class="params">(std::<span class="type">size_t</span> matrixSize)</span></span>;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::array&lt;T, n * n&gt; data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, std::<span class="type">size_t</span> n&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SquareMatrix</span> : <span class="keyword">private</span> SquareMatrixBase&lt;T&gt; &#123;  <span class="comment">// private ç»§æ‰¿å®ç°ï¼Œè§æ¡æ¬¾ 39</span></span><br><span class="line">    <span class="keyword">using</span> SquareMatrixBase&lt;T&gt;::Invert;              <span class="comment">// é¿å…æ©ç›–åŸºç±»å‡½æ•°ï¼Œè§æ¡æ¬¾ 33</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Invert</span><span class="params">()</span> </span>&#123; <span class="keyword">this</span>-&gt;<span class="built_in">Invert</span>(n); &#125;              <span class="comment">// è°ƒç”¨æ¨¡æ¿åŸºç±»å‡½æ•°ï¼Œè§æ¡æ¬¾ 43</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>Invert</code>å¹¶ä¸æ˜¯æˆ‘ä»¬å”¯ä¸€è¦ä½¿ç”¨çš„çŸ©é˜µæ“ä½œå‡½æ•°ï¼Œè€Œä¸”æ¯æ¬¡éƒ½å¾€åŸºç±»ä¼ é€’çŸ©é˜µå°ºå¯¸æ˜¾å¾—å¤ªè¿‡ç¹çï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†æ•°æ®æ”¾åœ¨æ´¾ç”Ÿç±»ä¸­ï¼Œåœ¨åŸºç±»ä¸­å‚¨å­˜æŒ‡é’ˆå’ŒçŸ©é˜µå°ºå¯¸ã€‚ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SquareMatrixBase</span> &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">SquareMatrixBase</span>(std::<span class="type">size_t</span> n, T* pMem)</span><br><span class="line">        : <span class="built_in">size</span>(n), <span class="built_in">pData</span>(pMem) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetDataPtr</span><span class="params">(T* ptr)</span> </span>&#123; pData = ptr; &#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::<span class="type">size_t</span> size;</span><br><span class="line">    T* pData;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, std::<span class="type">size_t</span> n&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SquareMatrix</span> : <span class="keyword">private</span> SquareMatrixBase&lt;T&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SquareMatrix</span>() : <span class="built_in">SquareMatrixBase</span>&lt;T&gt;(n, data.<span class="built_in">data</span>()) &#123;&#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::array&lt;T, n * n&gt; data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œè¿™ç§åšæ³•å¹¶éæ°¸è¿œèƒ½å–å¾—ä¼˜åŠ¿ï¼Œç¡¬æ˜¯ç»‘ç€çŸ©é˜µå°ºå¯¸çš„é‚£ä¸ªç‰ˆæœ¬ï¼Œæœ‰å¯èƒ½ç”Ÿæˆæ¯”å…±äº«ç‰ˆæœ¬æ›´ä½³çš„ä»£ç ã€‚ä¾‹å¦‚åœ¨å°ºå¯¸ä¸“å±ç‰ˆä¸­ï¼Œå°ºå¯¸æ˜¯ä¸ªç¼–è¯‘æœŸå¸¸é‡ï¼Œå› æ­¤å¯ä»¥åœ¨ç¼–è¯‘æœŸè—‰ç”±å¸¸é‡çš„å¹¿ä¼ è¾¾åˆ°æœ€ä¼˜åŒ–ï¼›è€Œåœ¨å…±äº«ç‰ˆæœ¬ä¸­ï¼Œä¸åŒå¤§å°çš„çŸ©é˜µåªæ‹¥æœ‰å•ä¸€ç‰ˆæœ¬çš„å‡½æ•°ï¼Œå¯å‡å°‘å¯æ‰§è¡Œæ–‡ä»¶å¤§å°ï¼Œä¹Ÿå°±å› æ­¤é™ä½ç¨‹åºçš„ working setï¼ˆåœ¨â€œè™šå†…å­˜ç¯å¢ƒâ€ä¸‹æ‰§è¡Œçš„è¿›ç¨‹æ‰€ä½¿ç”¨çš„ä¸€ç»„å†…å­˜é¡µï¼‰ï¼Œå¹¶å¼ºåŒ–æŒ‡ä»¤é«˜é€Ÿç¼“å­˜åŒºå†…çš„å¼•ç”¨é›†ä¸­åŒ–ï¼ˆlocality of referenceï¼‰ï¼Œè¿™äº›éƒ½å¯èƒ½ä½¿ç¨‹åºæ‰§è¡Œå¾—æ›´å¿«é€Ÿã€‚ç©¶ç«Ÿå“ªä¸ªç‰ˆæœ¬æ›´ä½³ï¼Œåªèƒ½ç»ç”±å…·ä½“çš„æµ‹è¯•åå†³å®šã€‚</p><p>åŒæ ·åœ°ï¼Œä¸Šé¢çš„ä»£ç ä¹Ÿä½¿ç”¨åˆ°äº†ç‰ºç‰²å°è£…æ€§çš„<code>protected</code>ï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºç®¡ç†ä¸Šçš„æ··ä¹±å’Œå¤æ‚ï¼Œè€ƒè™‘åˆ°è¿™äº›ï¼Œä¹Ÿè®¸ä¸€ç‚¹ç‚¹æ¨¡æ¿ä»£ç çš„é‡å¤å¹¶éä¸å¯æ¥å—ã€‚</p><h3 id="æ¡æ¬¾-45ï¼šè¿ç”¨æˆå‘˜å‡½æ•°æ¨¡æ¿æ¥å—æ‰€æœ‰å…¼å®¹ç±»å‹">æ¡æ¬¾ 45ï¼šè¿ç”¨æˆå‘˜å‡½æ•°æ¨¡æ¿æ¥å—æ‰€æœ‰å…¼å®¹ç±»å‹</h3><p>C++ è§†æ¨¡æ¿ç±»çš„ä¸åŒå…·ç°ä½“ä¸ºå®Œå…¨ä¸åŒçš„çš„ç±»å‹ï¼Œä½†åœ¨æ³›å‹ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€ä¸ªæ¨¡æ¿ç±»çš„ä¸åŒå…·ç°ä½“èƒ½å¤Ÿç›¸äº’ç±»å‹è½¬æ¢ã€‚</p><p>è€ƒè™‘è®¾è®¡ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆç±»ï¼Œè€Œæ™ºèƒ½æŒ‡é’ˆéœ€è¦æ”¯æŒä¸åŒç±»å‹æŒ‡é’ˆä¹‹é—´çš„éšå¼è½¬æ¢ï¼ˆå¦‚æœå¯ä»¥çš„è¯ï¼‰ï¼Œä»¥åŠæ™®é€šæŒ‡é’ˆåˆ°æ™ºèƒ½æŒ‡é’ˆçš„æ˜¾å¼è½¬æ¢ã€‚å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯æ¨¡æ¿æ‹·è´æ„é€ å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SmartPtr</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span></span><br><span class="line"><span class="function">    <span class="title">SmartPtr</span><span class="params">(<span class="type">const</span> SmartPtr&lt;U&gt;&amp; other)</span></span></span><br><span class="line"><span class="function">        : heldPtr(other.get()) &#123;</span> ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">explicit</span> <span class="title">SmartPtr</span><span class="params">(U* p)</span></span></span><br><span class="line"><span class="function">        : heldPtr(p) &#123;</span> ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T* <span class="title">get</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> heldPtr; &#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T* heldPtr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>get</code>è·å–åŸå§‹æŒ‡é’ˆï¼Œå¹¶å°†åœ¨åŸå§‹æŒ‡é’ˆä¹‹é—´è¿›è¡Œç±»å‹è½¬æ¢æœ¬èº«æä¾›äº†ä¸€ç§ä¿éšœï¼Œå¦‚æœåŸå§‹æŒ‡é’ˆä¹‹é—´ä¸èƒ½éšå¼è½¬æ¢ï¼Œé‚£ä¹ˆå…¶å¯¹åº”çš„æ™ºèƒ½æŒ‡é’ˆä¹‹é—´çš„éšå¼è½¬æ¢ä¼šé€ æˆç¼–è¯‘é”™è¯¯ã€‚</p><p>æ¨¡æ¿æ„é€ å‡½æ•°å¹¶ä¸ä¼šé˜»æ­¢ç¼–è¯‘å™¨æš—è‡ªç”Ÿæˆé»˜è®¤çš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥å¦‚æœä½ æƒ³è¦æ§åˆ¶æ‹·è´æ„é€ çš„æ–¹æ–¹é¢é¢ï¼Œä½ å¿…é¡»åŒæ—¶å£°æ˜æ³›åŒ–æ‹·è´æ„é€ å‡½æ•°å’Œæ™®é€šæ‹·è´æ„é€ å‡½æ•°ï¼Œç›¸åŒè§„åˆ™ä¹Ÿé€‚ç”¨äºèµ‹å€¼è¿ç®—ç¬¦ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">shared_ptr</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">shared_ptr</span>(shared_ptr <span class="type">const</span>&amp; r);                <span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Y&gt;</span></span><br><span class="line"><span class="function">    <span class="title">shared_ptr</span><span class="params">(shared_ptr&lt;Y&gt; <span class="type">const</span>&amp; r)</span></span>;             <span class="comment">// æ³›åŒ–æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    shared_ptr&amp; <span class="keyword">operator</span>=(shared_ptr <span class="type">const</span>&amp; r);     <span class="comment">// æ‹·è´èµ‹å€¼è¿ç®—ç¬¦</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Y&gt;</span><br><span class="line">    shared_ptr&amp; <span class="keyword">operator</span>=(shared_ptr&lt;Y&gt; <span class="type">const</span>&amp; r);  <span class="comment">// æ³›åŒ–æ‹·è´èµ‹å€¼è¿ç®—ç¬¦</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-46ï¼šéœ€è¦ç±»å‹è½¬æ¢æ—¶è¯·ä¸ºæ¨¡æ¿å®šä¹‰éæˆå‘˜å‡½æ•°">æ¡æ¬¾ 46ï¼šéœ€è¦ç±»å‹è½¬æ¢æ—¶è¯·ä¸ºæ¨¡æ¿å®šä¹‰éæˆå‘˜å‡½æ•°</h3><p>è¯¥æ¡æ¬¾ä¸æ¡æ¬¾ 24 ä¸€è„‰ç›¸æ‰¿ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå…ˆçš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rational</span>(<span class="type">const</span> T&amp; numerator = <span class="number">0</span>, <span class="type">const</span> T&amp; denominator = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> T&amp; <span class="title">Numerator</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> T&amp; <span class="title">Denominator</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">const</span> Rational&lt;T&gt; <span class="keyword">operator</span>*(<span class="type">const</span> Rational&lt;T&gt;&amp; lhs, <span class="type">const</span> Rational&lt;T&gt;&amp; rhs) &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">Rational</span>&lt;T&gt;(lhs.<span class="built_in">Numerator</span>() * rhs.<span class="built_in">Numerator</span>(), lhs.<span class="built_in">Denominator</span>() * rhs.<span class="built_in">Denominator</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">Rational&lt;<span class="type">int</span>&gt; <span class="title">oneHalf</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line">Rational&lt;<span class="type">int</span>&gt; result = oneHalf * <span class="number">2</span>;     <span class="comment">// æ— æ³•é€šè¿‡ç¼–è¯‘ï¼</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å¤±è´¥å¯ç¤ºæˆ‘ä»¬ï¼šæ¨¡æ¿å®å‚åœ¨æ¨å¯¼è¿‡ç¨‹ä¸­ï¼Œä»ä¸å°†éšå¼ç±»å‹è½¬æ¢çº³å…¥è€ƒè™‘ã€‚è™½ç„¶ä»¥<code>oneHalf</code>æ¨å¯¼å‡º<code>Rational&lt;int&gt;</code>ç±»å‹æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯è¯•å›¾å°†<code>int</code>ç±»å‹éšå¼è½¬æ¢ä¸º<code>Rational&lt;T&gt;</code>æ˜¯ç»å¯¹ä¼šå¤±è´¥çš„ã€‚</p><p>ç”±äºæ¨¡æ¿ç±»å¹¶ä¸ä¾èµ–æ¨¡æ¿å®å‚æ¨å¯¼ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨æ€»èƒ½å¤Ÿåœ¨<code>Rational&lt;T&gt;</code>å…·ç°åŒ–æ—¶å¾—çŸ¥<code>T</code>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‹å…ƒå£°æ˜å¼åœ¨æ¨¡æ¿ç±»å†…æŒ‡æ¶‰ç‰¹å®šå‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">friend</span> <span class="type">const</span> Rational&lt;T&gt; <span class="keyword">operator</span>*(<span class="type">const</span> Rational&lt;T&gt;&amp; lhs, <span class="type">const</span> Rational&lt;T&gt;&amp; rhs);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨æ¨¡æ¿ç±»å†…ï¼Œæ¨¡æ¿åç§°å¯è¢«ç”¨æ¥ä½œä¸ºâ€œæ¨¡æ¿åŠå…¶å‚æ•°â€çš„ç®€ç•¥è¡¨è¾¾å½¢å¼ï¼Œå› æ­¤ä¸‹é¢çš„å†™æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">friend</span> <span class="type">const</span> Rational <span class="keyword">operator</span>*(<span class="type">const</span> Rational&amp; lhs, <span class="type">const</span> Rational&amp; rhs);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“å¯¹è±¡<code>oneHalf</code>è¢«å£°æ˜ä¸ºä¸€ä¸ª<code>Rational&lt;int&gt;</code>æ—¶ï¼Œ<code>Rational&lt;int&gt;</code>ç±»äºæ˜¯è¢«å…·ç°åŒ–å‡ºæ¥ï¼Œè€Œä½œä¸ºè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå‹å…ƒå‡½æ•°<code>operator*</code>ä¹Ÿå°±è¢«è‡ªåŠ¨å£°æ˜å‡ºæ¥ï¼Œå…¶ä¸ºä¸€ä¸ªæ™®é€šå‡½æ•°è€Œéæ¨¡æ¿å‡½æ•°ï¼Œå› æ­¤åœ¨æ¥å—å‚æ•°æ—¶å¯ä»¥æ­£å¸¸æ‰§è¡Œéšå¼è½¬æ¢ã€‚</p><p>ä¸ºäº†ä½¿ç¨‹åºèƒ½æ­£å¸¸é“¾æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå…¶æä¾›å¯¹åº”çš„å®šä¹‰å¼ï¼Œæœ€ç®€å•æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯ç›´æ¥åˆå¹¶è‡³å£°æ˜å¼å¤„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">friend</span> <span class="type">const</span> Rational <span class="keyword">operator</span>*(<span class="type">const</span> Rational&amp; lhs, <span class="type">const</span> Rational&amp; rhs) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Rational</span>(lhs.<span class="built_in">Numerator</span>() * rhs.<span class="built_in">Numerator</span>(), lhs.<span class="built_in">Denominator</span>() * rhs.<span class="built_in">Denominator</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºå®šä¹‰åœ¨ç±»å†…çš„å‡½æ•°éƒ½ä¼šæš—è‡ªæˆä¸ºå†…è”å‡½æ•°ï¼Œä¸ºäº†é™ä½å†…è”å¸¦æ¥çš„å†²å‡»ï¼Œå¯ä»¥ä½¿<code>operator*</code>è°ƒç”¨ç±»å¤–çš„è¾…åŠ©æ¨¡æ¿å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">class</span> <span class="title class_">Rational</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">const</span> Rational&lt;T&gt; <span class="title">DoMultiply</span><span class="params">(<span class="type">const</span> Rational&lt;T&gt;&amp; lhs, <span class="type">const</span> Rational&lt;T&gt;&amp; rhs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Rational</span>&lt;T&gt;(lhs.<span class="built_in">Numerator</span>() * rhs.<span class="built_in">Numerator</span>(), lhs.<span class="built_in">Denominator</span>() * rhs.<span class="built_in">Denominator</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">friend</span> <span class="type">const</span> Rational <span class="keyword">operator</span>*(<span class="type">const</span> Rational&amp; lhs, <span class="type">const</span> Rational&amp; rhs) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">DoMultiply</span>(lhs, rhs);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-47ï¼šè¯·ä½¿ç”¨-traits-classes-è¡¨ç°ç±»å‹ä¿¡æ¯">æ¡æ¬¾ 47ï¼šè¯·ä½¿ç”¨ traits classes è¡¨ç°ç±»å‹ä¿¡æ¯</h3><p>traits classes å¯ä»¥ä½¿æˆ‘ä»¬åœ¨ç¼–è¯‘æœŸå°±èƒ½è·å–æŸäº›ç±»å‹ä¿¡æ¯ï¼Œå®ƒè¢«å¹¿æ³›è¿ç”¨äº C++ æ ‡å‡†åº“ä¸­ã€‚traits å¹¶ä¸æ˜¯ C++ å…³é”®å­—æˆ–ä¸€ä¸ªé¢„å…ˆå®šä¹‰å¥½çš„æ„ä»¶ï¼šå®ƒä»¬æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œä¹Ÿæ˜¯ C++ ç¨‹åºå‘˜æ‰€å…±åŒéµå®ˆçš„åè®®ï¼Œå¹¶è¦æ±‚å¯¹ç”¨æˆ·è‡ªå®šä¹‰ç±»å‹å’Œå†…ç½®ç±»å‹è¡¨ç°å¾—ä¸€æ ·å¥½ã€‚</p><p>è®¾è®¡å¹¶å®ç°ä¸€ä¸ª trait class çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>ç¡®è®¤è‹¥å¹²ä½ å¸Œæœ›å°†æ¥å¯å–å¾—çš„ç±»å‹ç›¸å…³ä¿¡æ¯ã€‚</li><li>ä¸ºè¯¥ç±»å‹é€‰æ‹©ä¸€ä¸ªåç§°ã€‚</li><li>æä¾›ä¸€ä¸ªæ¨¡æ¿å’Œä¸€ç»„ç‰¹åŒ–ç‰ˆæœ¬ï¼Œå†…å«ä½ å¸Œæœ›æ”¯æŒçš„ç±»å‹ç›¸å…³ä¿¡æ¯ã€‚</li></ol><p>ä»¥è¿­ä»£å™¨ä¸ºä¾‹ï¼Œæ ‡å‡†åº“ä¸­æ‹¥æœ‰å¤šç§ä¸åŒçš„è¿­ä»£å™¨ç§ç±»ï¼Œå®ƒä»¬å„è‡ªæ‹¥æœ‰ä¸åŒçš„åŠŸç”¨å’Œé™åˆ¶ï¼š</p><ol><li><code>input_iterator_tag</code>ï¼šå•å‘è¾“å…¥è¿­ä»£å™¨ï¼Œåªèƒ½å‘å‰ç§»åŠ¨ï¼Œä¸€æ¬¡ä¸€æ­¥ï¼Œå®¢æˆ·åªå¯è¯»å–å®ƒæ‰€æŒ‡çš„ä¸œè¥¿ã€‚</li><li><code>output_iterator_tag</code>ï¼šå•å‘è¾“å‡ºè¿­ä»£å™¨ï¼Œåªèƒ½å‘å‰ç§»åŠ¨ï¼Œä¸€æ¬¡ä¸€æ­¥ï¼Œå®¢æˆ·åªå¯å†™å…¥å®ƒæ‰€æŒ‡çš„ä¸œè¥¿ã€‚</li><li><code>forward_iterator_tag</code>ï¼šå•å‘è®¿é—®è¿­ä»£å™¨ï¼Œåªèƒ½å‘å‰ç§»åŠ¨ï¼Œä¸€æ¬¡ä¸€æ­¥ï¼Œè¯»å†™å‡å…è®¸ã€‚</li><li><code>bidirectional_iterator_tag</code>ï¼šåŒå‘è®¿é—®è¿­ä»£å™¨ï¼Œå»é™¤äº†åªèƒ½å‘å‰ç§»åŠ¨çš„é™åˆ¶ã€‚</li><li><code>random_access_iterator_tag</code>ï¼šéšæœºè®¿é—®è¿­ä»£å™¨ï¼Œæ²¡æœ‰ä¸€æ¬¡ä¸€æ­¥çš„é™åˆ¶ï¼Œå…è®¸éšæ„ç§»åŠ¨ï¼Œå¯ä»¥æ‰§è¡Œâ€œè¿­ä»£å™¨ç®—æœ¯â€ã€‚</li></ol><p>æ ‡å‡†åº“ä¸ºè¿™äº›è¿­ä»£å™¨ç§ç±»æä¾›çš„å·æ ‡ç»“æ„ä½“ï¼ˆtag structï¼‰çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">input_iterator_tag</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">output_iterator_tag</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">forward_iterator_tag</span> : input_iterator_tag &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">bidirectional_iterator_tag</span> : forward_iterator_tag &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">random_access_iterator_tag</span> : bidirectional_iterator_tag &#123;&#125;;</span><br></pre></td></tr></table></figure><p>å°†<code>iterator_category</code>ä½œä¸ºè¿­ä»£å™¨ç§ç±»çš„åç§°ï¼ŒåµŒå…¥å®¹å™¨çš„è¿­ä»£å™¨ä¸­ï¼Œå¹¶ä¸”ç¡®è®¤ä½¿ç”¨é€‚å½“çš„å·æ ‡ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt; ... &gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">deque</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">iterator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">using</span> iterator_category = random_access_iterator;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt; ... &gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">list</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">iterator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">using</span> iterator_category = bidirectional_iterator;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†åšåˆ°ç±»å‹çš„ traits ä¿¡æ¯å¯ä»¥åœ¨ç±»å‹è‡ªèº«ä¹‹å¤–è·å¾—ï¼Œæ ‡å‡†æŠ€æœ¯æ˜¯æŠŠå®ƒæ”¾è¿›ä¸€ä¸ªæ¨¡æ¿åŠå…¶ä¸€ä¸ªæˆ–å¤šä¸ªç‰¹åŒ–ç‰ˆæœ¬ä¸­ã€‚è¿™æ ·çš„æ¨¡æ¿åœ¨æ ‡å‡†åº“ä¸­æœ‰è‹¥å¹²ä¸ªï¼Œå…¶ä¸­é’ˆå¯¹è¿­ä»£å™¨çš„æ˜¯<code>iterator_traits</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">IterT</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">iterator_traits</span> &#123;</span><br><span class="line">    <span class="keyword">using</span> iterator_category = IterT::iterator_category;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ”¯æŒæŒ‡é’ˆè¿­ä»£å™¨ï¼Œ<code>iterator_traits</code>ç‰¹åˆ«é’ˆå¯¹æŒ‡é’ˆç±»å‹æä¾›ä¸€ä¸ªåç‰¹åŒ–ç‰ˆæœ¬ï¼Œè€ŒæŒ‡é’ˆçš„ç±»å‹å’Œéšæœºè®¿é—®è¿­ä»£å™¨ç±»ä¼¼ï¼Œæ‰€ä»¥å¯ä»¥å†™å‡ºå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">IterT</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">iterator_traits</span>&lt;IterT*&gt; &#123;</span><br><span class="line">    <span class="keyword">using</span> iterator_category = random_access_iterator_tag;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬éœ€è¦ä¸ºä¸åŒçš„è¿­ä»£å™¨ç§ç±»åº”ç”¨ä¸åŒçš„ä»£ç æ—¶ï¼Œtraits classes å°±æ´¾ä¸Šç”¨åœºäº†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> IterT, <span class="keyword">typename</span> DisT&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">advance</span><span class="params">(IterT&amp; iter, DisT d)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">typeid</span>(std::iterator_traits&lt;IterT&gt;::iterator_category)</span><br><span class="line">        == <span class="built_in">typeid</span>(std::random_access_iterator_tag)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†è¿™äº›ä»£ç å®é™…ä¸Šæ˜¯é”™è¯¯çš„ï¼Œæˆ‘ä»¬å¸Œæœ›ç±»å‹çš„åˆ¤æ–­èƒ½åœ¨ç¼–è¯‘æœŸå®Œæˆã€‚<code>iterator_category</code>æ˜¯åœ¨ç¼–è¯‘æœŸå†³å®šçš„ï¼Œç„¶è€Œ<code>if</code>å´æ˜¯åœ¨è¿è¡ŒæœŸè¿ä½œçš„ï¼Œæ— æ³•è¾¾æˆæˆ‘ä»¬çš„ç›®æ ‡ã€‚</p><p>åœ¨ C++17 ä¹‹å‰ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸»æµåšæ³•æ˜¯åˆ©ç”¨å‡½æ•°é‡è½½ï¼ˆä¹Ÿæ˜¯åŸä¹¦ä¸­ä»‹ç»çš„åšæ³•ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> IterT, <span class="keyword">typename</span> DisT&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doAdvance</span><span class="params">(IterT&amp; iter, DisT d, std::random_access_iterator_tag)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> IterT, <span class="keyword">typename</span> DisT&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doAdvance</span><span class="params">(IterT&amp; iter, DisT d, std::bidirectional_iterator_tag)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> IterT, <span class="keyword">typename</span> DisT&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doAdvance</span><span class="params">(IterT&amp; iter, DisT d, std::input_iterator_tag)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (d &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">out_of_range</span>(<span class="string">&quot;Negative distance&quot;</span>);       <span class="comment">// å•å‘è¿­ä»£å™¨ä¸å…è®¸è´Ÿè·ç¦»</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> IterT, <span class="keyword">typename</span> DisT&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">advance</span><span class="params">(IterT&amp; iter, DisT d)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">doAdvance</span>(iter, d, std::iterator_traits&lt;IterT&gt;::<span class="built_in">iterator_category</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ C++17 ä¹‹åï¼Œæˆ‘ä»¬æœ‰äº†æ›´ç®€å•æœ‰æ•ˆçš„åšæ³•â€”â€”ä½¿ç”¨<code>if constexpr</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> IterT, <span class="keyword">typename</span> DisT&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Advance</span><span class="params">(IterT&amp; iter, DisT d)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(<span class="keyword">typeid</span>(std::iterator_traits&lt;IterT&gt;::iterator_category)</span></span></span><br><span class="line"><span class="params"><span class="function">        == <span class="keyword">typeid</span>(std::random_access_iterator_tag))</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡æ¬¾-48ï¼šè®¤è¯†æ¨¡æ¿å…ƒç¼–ç¨‹">æ¡æ¬¾ 48ï¼šè®¤è¯†æ¨¡æ¿å…ƒç¼–ç¨‹</h3><p>æ¨¡æ¿å…ƒç¼–ç¨‹ï¼ˆTemplate metaprogrammingï¼ŒTMPï¼‰æ˜¯ç¼–å†™åŸºäºæ¨¡æ¿çš„ C++ ç¨‹åºå¹¶æ‰§è¡Œäºç¼–è¯‘æœŸçš„è¿‡ç¨‹ï¼Œå®ƒå¹¶ä¸æ˜¯åˆ»æ„è¢«è®¾è®¡å‡ºæ¥çš„ï¼Œè€Œæ˜¯å½“åˆ C++ å¼•å…¥æ¨¡æ¿å¸¦æ¥çš„å‰¯äº§å“ï¼Œäº‹å®è¯æ˜æ¨¡æ¿å…ƒç¼–ç¨‹å…·æœ‰å¼ºå¤§çš„ä½œç”¨ï¼Œå¹¶ä¸”ç°åœ¨å·²ç»æˆä¸º C++ æ ‡å‡†çš„ä¸€éƒ¨åˆ†ã€‚å®é™…ä¸Šï¼Œåœ¨æ¡æ¬¾ 47 ä¸­ç¼–å†™ traits classes æ—¶ï¼Œæˆ‘ä»¬å°±å·²ç»åœ¨è¿›è¡Œæ¨¡æ¿å…ƒç¼–ç¨‹äº†ã€‚</p><p>ç”±äºæ¨¡æ¿å…ƒç¨‹åºæ‰§è¡Œäº C++ ç¼–è¯‘æœŸï¼Œå› æ­¤å¯ä»¥å°†ä¸€äº›å·¥ä½œä»è¿è¡ŒæœŸè½¬ç§»è‡³ç¼–è¯‘æœŸï¼Œè¿™å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ç¼–è¯‘æœŸæ—¶å‘ç°ä¸€äº›åŸæœ¬è¦åœ¨è¿è¡ŒæœŸæ—¶æ‰èƒ½å¯Ÿè§‰çš„é”™è¯¯ï¼Œä»¥åŠå¾—åˆ°è¾ƒå°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€è¾ƒçŸ­çš„è¿è¡ŒæœŸã€è¾ƒå°‘çš„å†…å­˜éœ€æ±‚ã€‚å½“ç„¶ï¼Œå‰¯ä½œç”¨å°±æ˜¯ä¼šä½¿ç¼–è¯‘æ—¶é—´å˜é•¿ã€‚</p><p>æ¨¡æ¿å…ƒç¼–ç¨‹å·²è¢«è¯æ˜æ˜¯â€œå›¾çµå®Œå¤‡â€çš„ï¼Œå¹¶ä¸”ä»¥â€œå‡½æ•°å¼è¯­è¨€â€çš„å½¢å¼å‘æŒ¥ä½œç”¨ï¼Œå› æ­¤åœ¨æ¨¡æ¿å…ƒç¼–ç¨‹ä¸­æ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„å¾ªç¯ï¼Œæ‰€æœ‰å¾ªç¯æ•ˆæœåªèƒ½è—‰ç”±é€’å½’å®ç°ï¼Œè€Œé€’å½’åœ¨æ¨¡æ¿å…ƒç¼–ç¨‹ä¸­æ˜¯ç”± <strong>â€œé€’å½’æ¨¡æ¿å…·ç°åŒ–ï¼ˆrecursive template instantiationï¼‰â€</strong> å®ç°çš„ã€‚</p><p>å¸¸ç”¨äºå¼•å…¥æ¨¡æ¿å…ƒç¼–ç¨‹çš„ä¾‹å­æ˜¯åœ¨ç¼–è¯‘æœŸè®¡ç®—é˜¶ä¹˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="type">unsigned</span> n&gt;            <span class="comment">// Factorial&lt;n&gt; = n * Factorial&lt;n-1&gt;</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Factorial</span> &#123;</span><br><span class="line">    <span class="keyword">enum</span> &#123; value = n * Factorial&lt;n<span class="number">-1</span>&gt;::value &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Factorial</span>&lt;<span class="number">0</span>&gt; &#123;           <span class="comment">// å¤„ç†ç‰¹æ®Šæƒ…å†µï¼šFactorial&lt;0&gt; = 1</span></span><br><span class="line">    <span class="keyword">enum</span> &#123; value = <span class="number">1</span> &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::cout &lt;&lt; Factorial&lt;<span class="number">5</span>&gt;::value;</span><br></pre></td></tr></table></figure><p>æ¨¡æ¿å…ƒç¼–ç¨‹å¾ˆé…·ï¼Œä½†å¯¹å…¶è¿›è¡Œè°ƒè¯•å¯èƒ½æ˜¯ç¾éš¾æ€§çš„ï¼Œå› æ­¤åœ¨å®é™…åº”ç”¨ä¸­å¹¶ä¸å¸¸è§ã€‚æˆ‘ä»¬å¯èƒ½ä¼šåœ¨ä¸‹é¢å‡ ç§æƒ…å½¢ä¸­è§åˆ°å®ƒçš„å‡ºåœºï¼š</p><ol><li>ç¡®ä¿é‡åº¦å•ä½æ­£ç¡®ã€‚</li><li>ä¼˜åŒ–çŸ©é˜µè®¡ç®—ã€‚</li><li>å¯ä»¥ç”Ÿæˆå®¢æˆ·å®šåˆ¶ä¹‹è®¾è®¡æ¨¡å¼ï¼ˆcustom design patternï¼‰å®ç°å“ã€‚</li></ol><h2 id="ç¬¬å…«ç« ï¼šå®šåˆ¶-new-å’Œ-delete">ç¬¬å…«ç« ï¼šå®šåˆ¶ new å’Œ delete</h2><h3 id="æ¡æ¬¾-49ï¼šäº†è§£-new-handler-çš„è¡Œä¸º">æ¡æ¬¾ 49ï¼šäº†è§£ new-handler çš„è¡Œä¸º</h3><p>å½“<code>operator new</code>æ— æ³•æ»¡è¶³æŸä¸€å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œä¼šä¸æ–­è°ƒç”¨ä¸€ä¸ªå®¢æˆ·æŒ‡å®šçš„é”™è¯¯å¤„ç†å‡½æ•°ï¼Œå³æ‰€è°“çš„ <strong>new-handler</strong>ï¼Œç›´åˆ°æ‰¾åˆ°è¶³å¤Ÿå†…å­˜ä¸ºæ­¢ï¼Œè°ƒç”¨å£°æ˜äº<code>&lt;new&gt;</code>ä¸­çš„<code>set_new_handler</code>å¯ä»¥æŒ‡å®šè¿™ä¸ªå‡½æ•°ã€‚<code>new_handler</code>å’Œ<code>set_new_handler</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> std &#123;</span><br><span class="line">    <span class="keyword">using</span> new_handler = <span class="built_in">void</span>(*)();</span><br><span class="line">    <span class="function">new_handler <span class="title">set_new_handler</span><span class="params">(new_handler)</span> <span class="keyword">noexcept</span></span>;    <span class="comment">// è¿”å›å€¼ä¸ºåŸæ¥æŒæœ‰çš„ new-handler</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„ new-handler å‡½æ•°å¿…é¡»åšä»¥ä¸‹äº‹æƒ…ä¹‹ä¸€ï¼š</p><p><strong>è®©æ›´å¤šçš„å†…å­˜å¯è¢«ä½¿ç”¨ï¼š</strong> å¯ä»¥è®©ç¨‹åºä¸€å¼€å§‹æ‰§è¡Œå°±åˆ†é…ä¸€å¤§å—å†…å­˜ï¼Œè€Œåå½“ new-handler ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨ï¼Œå°†å®ƒä»¬é‡Šè¿˜ç»™ç¨‹åºä½¿ç”¨ï¼Œé€ æˆ<code>operator new</code>çš„ä¸‹ä¸€æ¬¡å†…å­˜åˆ†é…åŠ¨ä½œå¯èƒ½æˆåŠŸã€‚</p><p><strong>å®‰è£…å¦ä¸€ä¸ª new-handlerï¼š</strong> å¦‚æœç›®å‰è¿™ä¸ª new-handler æ— æ³•å–å¾—æ›´å¤šå†…å­˜ï¼Œå¯ä»¥è°ƒæ¢ä¸ºå¦ä¸€ä¸ªå¯ä»¥å®Œæˆç›®æ ‡çš„ new-handlerï¼ˆä»¤ new-handler ä¿®æ”¹â€œä¼šå½±å“ new-handler è¡Œä¸ºâ€çš„é™æ€æˆ–å…¨å±€æ•°æ®ï¼‰ã€‚</p><p><strong>å¸é™¤ new-handlerï¼š</strong> å°†<code>nullptr</code>ä¼ ç»™<code>set_new_handler</code>ï¼Œè¿™æ ·ä¼šä½¿<code>operator new</code>åœ¨å†…å­˜åˆ†é…ä¸æˆåŠŸæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚</p><p><strong>æŠ›å‡º bad_allocï¼ˆæˆ–æ´¾ç”Ÿè‡ª bad_allocï¼‰çš„å¼‚å¸¸ï¼š</strong> è¿™æ ·çš„å¼‚å¸¸ä¸ä¼šè¢«<code>operator new</code>æ•æ‰ï¼Œå› æ­¤ä¼šè¢«ä¼ æ’­åˆ°å†…å­˜åˆ†é…å¤„ã€‚</p><p><strong>ä¸è¿”å›ï¼š</strong> é€šå¸¸è°ƒç”¨<code>std::abort</code>æˆ–<code>std::exit</code>ã€‚</p><p>æœ‰çš„æ—¶å€™æˆ‘ä»¬æˆ–è®¸ä¼šå¸Œæœ›åœ¨ä¸ºä¸åŒçš„ç±»åˆ†é…å¯¹è±¡æ—¶ï¼Œä½¿ç”¨ä¸åŒçš„æ–¹å¼å¤„ç†å†…å­˜åˆ†é…å¤±è´¥æƒ…å†µã€‚è¿™æ—¶å€™ä½¿ç”¨é™æ€æˆå‘˜æ˜¯ä¸é”™çš„é€‰æ‹©ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> std::new_handler <span class="title">set_new_handler</span><span class="params">(std::new_handler p)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> std::new_handler currentHandler;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åšå’Œ std::set_new_handler ç›¸åŒçš„äº‹æƒ…</span></span><br><span class="line"><span class="function">std::new_handler <span class="title">Widget::set_new_handler</span><span class="params">(std::new_handler p)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    std::new_handler oldHandler = currentHandler;</span><br><span class="line">    currentHandler = p;</span><br><span class="line">    <span class="keyword">return</span> oldHandler; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* Widget::<span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> globalHandler = std::<span class="built_in">set_new_handler</span>(currentHandler);  <span class="comment">// åˆ‡æ¢è‡³ Widget çš„ä¸“å± new-handler</span></span><br><span class="line">    <span class="type">void</span>* ptr = ::<span class="keyword">operator</span> <span class="built_in">new</span>(size);                           <span class="comment">// åˆ†é…å†…å­˜æˆ–æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    std::<span class="built_in">set_new_handler</span>(globalHandler);                        <span class="comment">// åˆ‡æ¢å›å…¨å±€çš„ new-handler</span></span><br><span class="line">    <span class="keyword">return</span> globalHandler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::new_handler Widget::currentHandler = <span class="literal">nullptr</span>;</span><br></pre></td></tr></table></figure><p><code>Widget</code>çš„å®¢æˆ·åº”è¯¥ç±»ä¼¼è¿™æ ·ä½¿ç”¨å…¶ new-handlingï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">OutOfMem</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">Widget::<span class="built_in">set_new_handler</span>(OutOfMem);</span><br><span class="line"><span class="keyword">auto</span> pw1 = <span class="keyword">new</span> Widget;              <span class="comment">// è‹¥åˆ†é…å¤±è´¥ï¼Œåˆ™è°ƒç”¨ OutOfMem</span></span><br><span class="line"></span><br><span class="line">Widget::<span class="built_in">set_new_handler</span>(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">auto</span> pw2 = <span class="keyword">new</span> Widget;              <span class="comment">// è‹¥åˆ†é…å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br></pre></td></tr></table></figure><p>å®ç°è¿™ä¸€æ–¹æ¡ˆçš„ä»£ç å¹¶ä¸å› ç±»çš„ä¸åŒè€Œä¸åŒï¼Œå› æ­¤å¯¹è¿™äº›ä»£ç åŠ ä»¥å¤ç”¨æ˜¯åˆç†çš„æ„æƒ³ã€‚ä¸€ä¸ªç®€å•çš„åšæ³•æ˜¯å»ºç«‹èµ·ä¸€ä¸ªâ€œmixinâ€é£æ ¼çš„åŸºç±»ï¼Œè®©å…¶æ´¾ç”Ÿç±»ç»§æ‰¿å®ƒä»¬æ‰€éœ€çš„<code>set_new_handler</code>å’Œ<code>operator new</code>ï¼Œå¹¶ä¸”ä½¿ç”¨æ¨¡æ¿ç¡®ä¿æ¯ä¸€ä¸ªæ´¾ç”Ÿç±»è·å¾—ä¸€ä¸ªå®ä½“äº’å¼‚çš„<code>currentHandler</code>æˆå‘˜å˜é‡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NewHandlerSupport</span> &#123;       <span class="comment">// â€œmixinâ€é£æ ¼çš„åŸºç±»</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> std::new_handler <span class="title">set_new_handler</span><span class="params">(std::new_handler p)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span></span>;</span><br><span class="line">    ...                         <span class="comment">// å…¶å®ƒçš„ operator new ç‰ˆæœ¬ï¼Œè§æ¡æ¬¾ 52</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> std::new_handler currentHandler;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::new_handler NewHandlerSupport&lt;T&gt;::<span class="built_in">set_new_handler</span>(std::new_handler p) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">    std::new_handler oldHandler = currentHandler;</span><br><span class="line">    currentHandler = p;</span><br><span class="line">    <span class="keyword">return</span> oldHandler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">void</span>* NewHandlerSupport&lt;T&gt;::<span class="function"><span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> globalHandler = std::<span class="built_in">set_new_handler</span>(currentHandler);</span><br><span class="line">    <span class="type">void</span>* ptr = ::<span class="keyword">operator</span> <span class="built_in">new</span>(size);</span><br><span class="line">    std::<span class="built_in">set_new_handler</span>(globalHandler);</span><br><span class="line">    <span class="keyword">return</span> globalHandler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::new_handler NewHandlerSupport&lt;T&gt;::currentHandler = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> : <span class="keyword">public</span> NewHandlerSupport&lt;Widget&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...                         <span class="comment">// ä¸å¿…å†å£°æ˜ set_new_handler å’Œ operator new</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ³¨æ„æ­¤å¤„çš„æ¨¡æ¿å‚æ•°<code>T</code>å¹¶æ²¡æœ‰çœŸæ­£è¢«å½“æˆç±»å‹ä½¿ç”¨ï¼Œè€Œä»…ä»…æ˜¯ç”¨æ¥åŒºåˆ†ä¸åŒçš„æ´¾ç”Ÿç±»ï¼Œä½¿å¾—æ¨¡æ¿æœºåˆ¶ä¸ºæ¯ä¸ªæ´¾ç”Ÿç±»å…·ç°åŒ–å‡ºä¸€ä»½å¯¹åº”çš„<code>currentHandler</code>ã€‚</p><p>è¿™ä¸ªåšæ³•ç”¨åˆ°äº†æ‰€è°“çš„ <strong>CRTPï¼ˆcurious recurring template patternï¼Œå¥‡å¼‚é€’å½’æ¨¡æ¿æ¨¡å¼ï¼‰</strong> ï¼Œé™¤äº†åœ¨ä¸Šè¿°è®¾è®¡æ¨¡å¼ä¸­ç”¨åˆ°ä¹‹å¤–ï¼Œå®ƒä¹Ÿè¢«ç”¨äºå®ç°<strong>é™æ€å¤šæ€</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Derived</span>&gt; </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Base</span> &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Interface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">static_cast</span>&lt;Derived*&gt;(<span class="keyword">this</span>)-&gt;<span class="built_in">Implementation</span>();      <span class="comment">// åœ¨åŸºç±»ä¸­æš´éœ²æ¥å£</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Derived</span> : Base&lt;Derived&gt; &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Implementation</span><span class="params">()</span></span>;                                  <span class="comment">// åœ¨æ´¾ç”Ÿç±»ä¸­æä¾›å®ç°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é™¤äº†ä¼šè°ƒç”¨ new-handler çš„<code>operator new</code>ä»¥å¤–ï¼ŒC++ è¿˜ä¿ç•™äº†ä¼ ç»Ÿçš„â€œåˆ†é…å¤±è´¥ä¾¿è¿”å›ç©ºæŒ‡é’ˆâ€çš„<code>operator new</code>ï¼Œç§°ä¸º nothrow newï¼Œé€šè¿‡<code>std::nothrow</code>å¯¹è±¡æ¥ä½¿ç”¨å®ƒï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Widget* pw1 = <span class="keyword">new</span> Widget;                   <span class="comment">// å¦‚æœåˆ†é…å¤±è´¥ï¼ŒæŠ›å‡º bad_alloc</span></span><br><span class="line"><span class="keyword">if</span> (pw1 == <span class="literal">nullptr</span>) ...                     <span class="comment">// è¿™ä¸ªæµ‹è¯•ä¸€å®šå¤±è´¥</span></span><br><span class="line"></span><br><span class="line">Widget* pw2 = <span class="built_in">new</span> (std::nothrow) Widget;    <span class="comment">// å¦‚æœåˆ†é…å¤±è´¥ï¼Œè¿”å›ç©ºæŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">if</span> (pw2 == <span class="literal">nullptr</span>) ...                     <span class="comment">// è¿™ä¸ªæµ‹è¯•å¯èƒ½æˆåŠŸ</span></span><br></pre></td></tr></table></figure><p>nothrow new å¯¹å¼‚å¸¸çš„å¼ºåˆ¶ä¿è¯æ€§å¹¶ä¸é«˜ï¼Œä½¿ç”¨å®ƒåªèƒ½ä¿è¯<code>operator new</code>ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ— æ³•ä¿è¯åƒ<code>new (std::nothrow) Widget</code>è¿™æ ·çš„è¡¨è¾¾å¼ä¸ä¼šå¯¼è‡´å¼‚å¸¸ï¼Œå› æ­¤å®é™…ä¸Šå¹¶æ²¡æœ‰ä½¿ç”¨ nothrow new çš„å¿…è¦ã€‚</p><h3 id="æ¡æ¬¾-50ï¼šäº†è§£-new-å’Œ-delete-çš„åˆç†æ›¿æ¢æ—¶æœº">æ¡æ¬¾ 50ï¼šäº†è§£ new å’Œ delete çš„åˆç†æ›¿æ¢æ—¶æœº</h3><p>ä»¥ä¸‹æ˜¯å¸¸è§çš„æ›¿æ¢é»˜è®¤<code>operator new</code>å’Œ<code>operator delete</code>çš„ç†ç”±ï¼š</p><p><strong>ç”¨æ¥æ£€æµ‹è¿ç”¨ä¸Šçš„é”™è¯¯ï¼š</strong> å¦‚æœå°†â€œnew æ‰€å¾—å†…å­˜â€delete æ‰å´ä¸å¹¸å¤±è´¥ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼›å¦‚æœåœ¨â€œnew æ‰€å¾—å†…å­˜â€èº«ä¸Šå¤šæ¬¡ delete åˆ™ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚å¦‚æœä»¤<code>operator new</code>æŒæœ‰ä¸€ä¸²åŠ¨æ€åˆ†é…æ‰€å¾—åœ°å€ï¼Œè€Œ<code>operator delete</code>å°†åœ°å€ä»ä¸­ç§»é™¤ï¼Œå°±å¾ˆå®¹æ˜“æ£€æµ‹å‡ºä¸Šè¿°é”™è¯¯ç”¨æ³•ã€‚æ­¤å¤–å„å¼å„æ ·çš„ç¼–ç¨‹é”™è¯¯å¯èƒ½å¯¼è‡´ <strong>â€œoverrunsâ€ï¼ˆå†™å…¥ç‚¹åœ¨åˆ†é…åŒºå—å°¾ç«¯ä¹‹åï¼‰</strong> å’Œ <strong>â€œunderrunsâ€ï¼ˆå†™å…¥ç‚¹åœ¨åˆ†é…åŒºå—èµ·ç‚¹ä¹‹å‰ï¼‰</strong>ï¼Œä»¥é¢å¤–ç©ºé—´æ”¾ç½®ç‰¹å®šçš„ byte pattern ç­¾åï¼Œæ£€æŸ¥ç­¾åæ˜¯å¦åŸå°ä¸åŠ¨å°±å¯ä»¥æ£€æµ‹æ­¤ç±»é”™è¯¯ï¼Œä¸‹é¢ç»™å‡ºäº†ä¸€ä¸ªè¿™æ ·çš„èŒƒä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> signature = <span class="number">0xDEADBEEF</span>;              <span class="comment">// è°ƒè¯•â€œé­”æ•°â€</span></span><br><span class="line"><span class="keyword">using</span> Byte = <span class="type">unsigned</span> <span class="type">char</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line">    <span class="type">size_t</span> realSize = size + <span class="number">2</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>);         <span class="comment">// åˆ†é…é¢å¤–ç©ºé—´ä»¥å¡å…¥ä¸¤ä¸ªç­¾å</span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* pMem = <span class="built_in">malloc</span>(realSize);                    <span class="comment">// è°ƒç”¨ malloc å–å¾—å†…å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (!pMem) <span class="keyword">throw</span> <span class="built_in">bad_alloc</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ç­¾åå†™å…¥å†…å­˜çš„èµ·ç‚¹å’Œå°¾ç«¯</span></span><br><span class="line">    *(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>*&gt;(pMem)) = signature;</span><br><span class="line">    *(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">int</span>*&gt;(<span class="built_in">static_cast</span>&lt;Byte*&gt;(pMem) + realSize - <span class="built_in">sizeof</span>(<span class="type">int</span>))) = signature;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Byte*&gt;(pMem) + <span class="built_in">sizeof</span>(<span class="type">int</span>);    <span class="comment">// è¿”å›æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªç­¾ååçš„å†…å­˜ä½ç½®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šè¿™æ®µä»£ç ä¸èƒ½ä¿è¯å†…å­˜å¯¹é½ï¼Œå¹¶ä¸”æœ‰è®¸å¤šåœ°æ–¹ä¸éµå®ˆ C++ è§„èŒƒï¼Œæˆ‘ä»¬å°†åœ¨æ¡æ¬¾ 51 ä¸­è¿›è¡Œè¯¦ç»†è®¨è®ºã€‚</p><p><strong>ä¸ºäº†æ”¶é›†ä½¿ç”¨ä¸Šçš„ç»Ÿè®¡æ•°æ®ï¼š</strong> å®šåˆ¶ new å’Œ delete åŠ¨æ€å†…å­˜çš„ç›¸å…³ä¿¡æ¯ï¼šåˆ†é…åŒºå—çš„å¤§å°åˆ†å¸ƒï¼Œå¯¿å‘½åˆ†å¸ƒï¼ŒFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ã€LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰æˆ–éšæœºæ¬¡åºçš„å€¾å‘æ€§ï¼Œä¸åŒçš„åˆ†é…/å½’è¿˜å½¢æ€ï¼Œä½¿ç”¨çš„æœ€å¤§åŠ¨æ€åˆ†é…é‡ç­‰ç­‰ã€‚</p><p><strong>ä¸ºäº†å¢åŠ åˆ†é…å’Œå½’è¿˜çš„é€Ÿåº¦ï¼š</strong> æ³›ç”¨å‹åˆ†é…å™¨å¾€å¾€ï¼ˆè™½ç„¶å¹¶éæ€»æ˜¯ï¼‰æ¯”å®šåˆ¶å‹åˆ†é…å™¨æ…¢ï¼Œç‰¹åˆ«æ˜¯å½“å®šåˆ¶å‹åˆ†é…å™¨ä¸“é—¨é’ˆå¯¹æŸç‰¹å®šç±»å‹ä¹‹å¯¹è±¡è®¾è®¡æ—¶ã€‚ç±»ä¸“å±çš„åˆ†é…å™¨å¯ä»¥åšåˆ°â€œåŒºå—å°ºå¯¸å›ºå®šâ€ï¼Œä¾‹å¦‚ Boost æä¾›çš„ Pool ç¨‹åºåº“ã€‚åˆä¾‹å¦‚ï¼Œç¼–è¯‘å™¨æ‰€å¸¦çš„å†…å­˜ç®¡ç†å™¨æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å¦‚æœä½ çš„ç¨‹åºæ˜¯å•çº¿ç¨‹çš„ï¼Œä½ ä¹Ÿå¯ä»¥è€ƒè™‘å†™ä¸€ä¸ªä¸çº¿ç¨‹å®‰å…¨çš„åˆ†é…å™¨æ¥æé«˜é€Ÿåº¦ã€‚å½“ç„¶ï¼Œè¿™éœ€è¦ä½ å¯¹ç¨‹åºè¿›è¡Œåˆ†æï¼Œå¹¶ç¡®è®¤ç¨‹åºç“¶é¢ˆçš„ç¡®å‘ç”Ÿåœ¨é‚£äº›å†…å­˜å‡½æ•°èº«ä¸Šã€‚</p><p><strong>ä¸ºäº†é™ä½ç¼ºçœå†…å­˜ç®¡ç†å™¨å¸¦æ¥çš„ç©ºé—´é¢å¤–å¼€é”€ï¼š</strong> æ³›ç”¨å‹åˆ†é…å™¨å¾€å¾€ï¼ˆè™½ç„¶å¹¶éæ€»æ˜¯ï¼‰è¿˜æ¯”å®šåˆ¶å‹åˆ†é…å™¨ä½¿ç”¨æ›´å¤šå†…å­˜ï¼Œé‚£æ˜¯å› ä¸ºå®ƒä»¬å¸¸å¸¸åœ¨æ¯ä¸€ä¸ªåˆ†é…åŒºå—èº«ä¸Šæ‹›å¼•æŸäº›é¢å¤–å¼€é”€ã€‚é’ˆå¯¹å°å‹å¯¹è±¡è€Œå¼€å‘çš„åˆ†é…å™¨ï¼ˆä¾‹å¦‚ Boost çš„ Pool ç¨‹åºåº“ï¼‰æœ¬è´¨ä¸Šæ¶ˆé™¤äº†è¿™æ ·çš„é¢å¤–å¼€é”€ã€‚</p><p><strong>ä¸ºäº†å¼¥è¡¥ç¼ºçœåˆ†é…å™¨ä¸­çš„éæœ€ä½³å†…å­˜å¯¹é½ï¼ˆsuboptimal alignmentï¼‰ï¼š</strong> è®¸å¤šè®¡ç®—æœºä½“ç³»æ¶æ„è¦æ±‚ç‰¹å®šçš„ç±»å‹å¿…é¡»æ”¾åœ¨ç‰¹å®šçš„å†…å­˜åœ°å€ä¸Šï¼Œå¦‚æœæ²¡æœ‰å¥‰è¡Œè¿™ä¸ªçº¦æŸæ¡ä»¶ï¼Œå¯èƒ½å¯¼è‡´è¿è¡ŒæœŸç¡¬ä»¶å¼‚å¸¸ï¼Œæˆ–è€…è®¿é—®é€Ÿåº¦å˜ä½ã€‚<code>std::max_align_t</code>ç”¨æ¥è¿”å›å½“å‰å¹³å°çš„æœ€å¤§é»˜è®¤å†…å­˜å¯¹é½ç±»å‹ï¼Œå¯¹äº<code>malloc</code>åˆ†é…çš„å†…å­˜ï¼Œå…¶å¯¹é½å’Œ<code>max_align_t</code>ç±»å‹çš„å¯¹é½å¤§å°åº”å½“æ˜¯ä¸€è‡´çš„ï¼Œä½†è‹¥å¯¹<code>malloc</code>è¿”å›çš„æŒ‡é’ˆè¿›è¡Œåç§»ï¼Œå°±æ²¡æœ‰åŠæ³•ä¿è¯å†…å­˜å¯¹é½ã€‚</p><p>åœ¨ C++11 ä¸­ï¼Œæä¾›äº†ä»¥ä¸‹å†…å­˜å¯¹é½ç›¸å…³æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// alignas ç”¨äºæŒ‡å®šæ ˆä¸Šæ•°æ®çš„å†…å­˜å¯¹é½è¦æ±‚</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">alignas</span>(<span class="number">8</span>) testStruct &#123; <span class="type">double</span> data; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// alignof å’Œ std::alignment_of ç”¨äºå¾—åˆ°ç»™å®šç±»å‹çš„å†…å­˜å¯¹é½è¦æ±‚</span></span><br><span class="line">std::cout &lt;&lt; <span class="built_in">alignof</span>(std::<span class="type">max_align_t</span>) &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; std::alignment_of&lt;std::<span class="type">max_align_t</span>&gt;::value &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// std::align ç”¨äºåœ¨ä¸€å¤§å—å†…å­˜ä¸­è·å–ä¸€ä¸ªç¬¦åˆæŒ‡å®šå†…å­˜è¦æ±‚çš„åœ°å€</span></span><br><span class="line"><span class="type">char</span> buffer[] = <span class="string">&quot;memory alignment&quot;</span>;</span><br><span class="line"><span class="type">void</span>* ptr = buffer;</span><br><span class="line">std::<span class="type">size_t</span> space = <span class="built_in">sizeof</span>(buffer) - <span class="number">1</span>;</span><br><span class="line">std::<span class="built_in">align</span>(<span class="built_in">alignof</span>(<span class="type">int</span>), <span class="built_in">sizeof</span>(<span class="type">char</span>), ptr, space);</span><br></pre></td></tr></table></figure><p>åœ¨ C++17 åï¼Œå¯ä»¥ä½¿ç”¨<code>std::align_val_t</code>æ¥é‡è½½éœ€æ±‚é¢å¤–å†…å­˜å¯¹é½çš„<code>operator new</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> count, std::<span class="type">align_val_t</span> al)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>ä¸ºäº†å°†ç›¸å…³å¯¹è±¡æˆç°‡é›†ä¸­ï¼š</strong> å¦‚æœä½ çŸ¥é“ç‰¹å®šçš„æŸä¸ªæ•°æ®ç»“æ„å¾€å¾€è¢«ä¸€èµ·ä½¿ç”¨ï¼Œè€Œä½ åˆå¸Œæœ›åœ¨å¤„ç†è¿™äº›æ•°æ®æ—¶å°†â€œå†…å­˜é¡µé”™è¯¯ï¼ˆpage faultsï¼‰â€çš„é¢‘ç‡é™è‡³æœ€ä½ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä¸ºæ­¤æ•°æ®ç»“æ„åˆ›å»ºä¸€ä¸ªå †ï¼Œå°†å®ƒä»¬æˆç°‡é›†ä¸­åœ¨å°½å¯èƒ½å°‘çš„å†…å­˜é¡µä¸Šã€‚ä¸€èˆ¬å¯ä»¥ä½¿ç”¨ placement new è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼ˆè§æ¡æ¬¾ 52ï¼‰ã€‚</p><p><strong>ä¸ºäº†è·å¾—éä¼ ç»Ÿçš„è¡Œä¸ºï¼š</strong> æœ‰æ—¶å€™ä½ ä¼šå¸Œæœ›<code>operator new</code>å’Œ<code>operator delete</code>åšç¼–è¯‘å™¨ç‰ˆä¸ä¼šåšçš„äº‹æƒ…ï¼Œä¾‹å¦‚åˆ†é…å’Œå½’è¿˜å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰ï¼Œè€Œè¿™äº›äº‹æƒ…åªèƒ½è¢« C API å®Œæˆï¼Œåˆ™å¯ä»¥å°† C API å°åœ¨ C++ çš„å¤–å£³é‡Œï¼Œå†™åœ¨å®šåˆ¶çš„ new å’Œ delete ä¸­ã€‚</p><h3 id="æ¡æ¬¾-51ï¼šç¼–å†™-new-å’Œ-delete-æ—¶éœ€å›ºå®ˆå¸¸è§„">æ¡æ¬¾ 51ï¼šç¼–å†™ new å’Œ delete æ—¶éœ€å›ºå®ˆå¸¸è§„</h3><p>æˆ‘ä»¬åœ¨æ¡æ¬¾ 49 ä¸­å·²ç»æåˆ°è¿‡ä¸€äº›<code>operator new</code>çš„è§„çŸ©ï¼Œæ¯”å¦‚å†…å­˜ä¸è¶³æ—¶å¿…é¡»ä¸æ–­è°ƒç”¨ new-handlerï¼Œå¦‚æœæ— æ³•ä¾›åº”å®¢æˆ·ç”³è¯·çš„å†…å­˜ï¼Œå°±æŠ›å‡º<code>std::bad_alloc</code>å¼‚å¸¸ã€‚C++ è¿˜æœ‰ä¸€ä¸ªå¥‡æ€ªçš„è§„å®šï¼Œå³ä½¿å®¢æˆ·éœ€æ±‚ä¸º0å­—èŠ‚ï¼Œ<code>operator new</code>ä¹Ÿå¾—è¿”å›ä¸€ä¸ªåˆæ³•çš„æŒ‡é’ˆï¼Œè¿™ç§çœ‹ä¼¼è¯¡å¼‚çš„è¡Œä¸ºå…¶å®æ˜¯ä¸ºäº†ç®€åŒ–è¯­è¨€å…¶ä»–éƒ¨åˆ†ã€‚</p><p>æ ¹æ®è¿™äº›è§„çº¦ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºéæˆå‘˜å‡½æ•°ç‰ˆæœ¬çš„<code>operator new</code>ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)      <span class="comment">// å¤„ç†0å­—èŠ‚ç”³è¯·</span></span><br><span class="line">        size = <span class="number">1</span>;       <span class="comment">// å°†å…¶è§†ä¸º1å­—èŠ‚ç”³è¯·</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (...)        <span class="comment">// å¦‚æœåˆ†é…æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">return</span> ...; <span class="comment">// è¿”å›æŒ‡é’ˆæŒ‡å‘åˆ†é…å¾—åˆ°çš„å†…å­˜</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœåˆ†é…å¤±è´¥ï¼Œè°ƒç”¨ç›®å‰çš„ new-handler</span></span><br><span class="line">        <span class="keyword">auto</span> globalHandler = <span class="built_in">get_new_handler</span>(); <span class="comment">// since C++11</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (globalHandler) (*globalHandler)();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> std::<span class="built_in">bad_alloc</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>operator new</code>çš„æˆå‘˜å‡½æ•°ç‰ˆæœ¬ä¸€èˆ¬åªä¼šåˆ†é…å¤§å°åˆšå¥½ä¸ºç±»çš„å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯æƒ…å†µå¹¶ä¸æ€»æ˜¯å¦‚æ­¤ï¼Œæ¯”å¦‚å‡è®¾æˆ‘ä»¬æ²¡æœ‰ä¸ºæ´¾ç”Ÿç±»å£°æ˜å…¶è‡ªå·±çš„<code>operator new</code>ï¼Œé‚£ä¹ˆæ´¾ç”Ÿç±»ä¼šä»åŸºç±»ç»§æ‰¿<code>operator new</code>ï¼Œè¿™å°±å¯¼è‡´æ´¾ç”Ÿç±»å¯ä»¥ä½¿ç”¨å…¶åŸºç±»çš„ new åˆ†é…æ–¹å¼ï¼Œä½†æ´¾ç”Ÿç±»å’ŒåŸºç±»çš„å¤§å°å¾ˆå¤šæ—¶å€™æ˜¯ä¸åŒçš„ã€‚</p><p>å¤„ç†æ­¤æƒ…å†µçš„æœ€ä½³åšæ³•æ˜¯å°†â€œå†…å­˜ç”³è¯·é‡é”™è¯¯â€çš„è°ƒç”¨è¡Œä¸ºæ”¹ä¸ºé‡‡ç”¨æ ‡å‡†çš„<code>operator new</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* Base::<span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (size != <span class="built_in">sizeof</span>(Base))</span><br><span class="line">        <span class="keyword">return</span> ::<span class="keyword">operator</span> <span class="built_in">new</span>(size);    <span class="comment">// è½¬äº¤ç»™æ ‡å‡†çš„ operator new è¿›è¡Œå¤„ç†</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åœ¨<code>operator new</code>çš„æˆå‘˜å‡½æ•°ç‰ˆæœ¬ä¸­æˆ‘ä»¬ä¹Ÿä¸éœ€è¦æ£€æµ‹åˆ†é…çš„å¤§å°æ˜¯å¦ä¸º0äº†ï¼Œå› ä¸ºåœ¨æ¡æ¬¾ 39 ä¸­æˆ‘ä»¬æåˆ°è¿‡ï¼Œéé™„å±å¯¹è±¡å¿…é¡»æœ‰éé›¶å¤§å°ï¼Œæ‰€ä»¥<code>sizeof(Base)</code>æ— è®ºå¦‚ä½•ä¹Ÿä¸èƒ½ä¸º0ã€‚</p><p>å¦‚æœä½ æ‰“ç®—å®ç°<code>operator new[]</code>ï¼Œå³æ‰€è°“çš„ array newï¼Œé‚£ä¹ˆä½ å”¯ä¸€è¦åšçš„ä¸€ä»¶äº‹å°±æ˜¯åˆ†é…ä¸€å—æœªåŠ å·¥çš„åŸå§‹å†…å­˜ï¼Œå› ä¸ºä½ æ— æ³•å¯¹ array ä¹‹å†…è¿„ä»Šå°šæœªå­˜åœ¨çš„å…ƒç´ å¯¹è±¡åšä»»ä½•äº‹æƒ…ï¼Œå®é™…ä¸Šä½ ç”šè‡³æ— æ³•è®¡ç®—è¿™ä¸ª array å°†å«æœ‰å¤šå°‘å…ƒç´ å¯¹è±¡ã€‚</p><p><code>operator delete</code>çš„è§„çº¦æ›´åŠ ç®€å•ï¼Œä½ éœ€è¦è®°ä½çš„å”¯ä¸€ä¸€ä»¶äº‹æƒ…å°±æ˜¯ C++ ä¿è¯ <strong>â€œåˆ é™¤ç©ºæŒ‡é’ˆæ°¸è¿œå®‰å…¨â€</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* rawMemory)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rawMemory == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½’è¿˜ rawMemory æ‰€æŒ‡çš„å†…å­˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>operator delete</code>çš„æˆå‘˜å‡½æ•°ç‰ˆæœ¬è¦å¤šåšçš„å”¯ä¸€ä¸€ä»¶äº‹å°±æ˜¯å°†å¤§å°æœ‰è¯¯çš„åˆ é™¤è¡Œä¸ºè½¬äº¤ç»™æ ‡å‡†çš„<code>operator delete</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> Base::<span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* rawMemory, std::<span class="type">size_t</span> size)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rawMemory == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (size != <span class="built_in">sizeof</span>(Base)) &#123;</span><br><span class="line">        ::<span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(rawMemory)</span></span>;    <span class="comment">// è½¬äº¤ç»™æ ‡å‡†çš„ operator delete è¿›è¡Œå¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½’è¿˜ rawMemory æ‰€æŒ‡çš„å†…å­˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå³å°†è¢«åˆ é™¤çš„å¯¹è±¡æ´¾ç”Ÿè‡ªæŸä¸ªåŸºç±»è€Œåè€…ç¼ºå°‘è™šææ„å‡½æ•°ï¼Œé‚£ä¹ˆ C++ ä¼ ç»™<code>operator delete</code>çš„<code>size</code>å¤§å°å¯èƒ½ä¸æ­£ç¡®ï¼Œè¿™æˆ–è®¸æ˜¯â€œä¸ºå¤šæ€åŸºç±»å£°æ˜è™šææ„å‡½æ•°â€çš„ä¸€ä¸ªè¶³å¤Ÿçš„ç†ç”±ï¼Œèƒ½ä½œä¸ºå¯¹æ¡æ¬¾ 7 çš„è¡¥å……ã€‚</p><h3 id="æ¡æ¬¾-52ï¼šå†™äº†-placement-new-ä¹Ÿè¦å†™-placement-delete">æ¡æ¬¾ 52ï¼šå†™äº† placement new ä¹Ÿè¦å†™ placement delete</h3><p>placement new æœ€åˆçš„å«ä¹‰æŒ‡çš„æ˜¯â€œæ¥å—ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¯¹è±¡è¯¥è¢«æ„é€ ä¹‹å¤„â€çš„<code>operator new</code>ç‰ˆæœ¬ï¼Œå®ƒåœ¨æ ‡å‡†åº“ä¸­çš„ç”¨é€”å¹¿æ³›ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯è´Ÿè´£åœ¨ vector çš„æœªä½¿ç”¨ç©ºé—´ä¸Šåˆ›å»ºå¯¹è±¡ï¼Œå®ƒçš„å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span>, <span class="type">void</span>* pMemory)</span> <span class="keyword">noexcept</span></span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ­¤å¤„è¦è®¨è®ºçš„æ˜¯å¹¿ä¹‰ä¸Šçš„ placement newï¼Œå³å¸¦æœ‰é™„åŠ å‚æ•°çš„<code>operator new</code>ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ç§ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span>, std::ostream&amp; logStream)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> pw = <span class="built_in">new</span> (std::cerr) Widget;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ä½¿ç”¨ new è¡¨è¾¾å¼åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå…±æœ‰ä¸¤ä¸ªå‡½æ•°è¢«è°ƒç”¨ï¼šä¸€ä¸ªæ˜¯ç”¨ä»¥åˆ†é…å†…å­˜çš„<code>operator new</code>ï¼Œä¸€ä¸ªæ˜¯å¯¹è±¡çš„æ„é€ å‡½æ•°ã€‚å‡è®¾ç¬¬ä¸€ä¸ªå‡½æ•°è°ƒç”¨æˆåŠŸï¼Œè€Œç¬¬äºŒä¸ªå‡½æ•°å´æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆä¼šç”± C++ runtime è°ƒç”¨<code>operator delete</code>ï¼Œå½’è¿˜å·²ç»åˆ†é…å¥½çš„å†…å­˜ã€‚</p><p>è¿™ä¸€åˆ‡çš„å‰ææ˜¯ C++ runtime èƒ½å¤Ÿæ‰¾åˆ°<code>operator new</code>å¯¹åº”çš„<code>operator delete</code>ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„ placement newï¼Œè€Œæ²¡æœ‰ä¸ºå…¶å‡†å¤‡å¯¹åº”çš„ placement delete çš„è¯ï¼Œå°±æ— æ³•é¿å…å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚å› æ­¤ï¼Œåˆæ ¼çš„ä»£ç åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size, std::ostream&amp; logStream)</span></span>;   <span class="comment">// placement new</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* pMemory)</span></span>;                             <span class="comment">// delete æ—¶è°ƒç”¨çš„æ­£å¸¸ operator delete</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* pMemory, std::ostream&amp; logStream)</span></span>;    <span class="comment">// placement delete</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªè¦æ³¨æ„çš„é—®é¢˜æ˜¯ï¼Œç”±äºæˆå‘˜å‡½æ•°çš„åç§°ä¼šæ©ç›–å…¶å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„ç›¸åŒåç§°ï¼ˆè§æ¡æ¬¾ 33ï¼‰ï¼Œæ‰€ä»¥æä¾› placement new ä¼šå¯¼è‡´æ— æ³•ä½¿ç”¨æ­£å¸¸ç‰ˆæœ¬çš„<code>operator new</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size, std::ostream&amp; logStream)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> pb = <span class="keyword">new</span> Base;             <span class="comment">// æ— æ³•é€šè¿‡ç¼–è¯‘ï¼</span></span><br><span class="line"><span class="keyword">auto</span> pb = <span class="built_in">new</span> (std::cerr) Base; <span class="comment">// æ­£ç¡®</span></span><br></pre></td></tr></table></figure><p>åŒæ ·é“ç†ï¼Œæ´¾ç”Ÿç±»ä¸­çš„<code>operator new</code>ä¼šæ©ç›–å…¨å±€ç‰ˆæœ¬å’Œç»§æ‰¿è€Œå¾—çš„<code>operator new</code>ç‰ˆæœ¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> pd = <span class="built_in">new</span> (std::clog) Derived;  <span class="comment">// æ— æ³•é€šè¿‡ç¼–è¯‘ï¼</span></span><br><span class="line"><span class="keyword">auto</span> pd = <span class="keyword">new</span> Derived;              <span class="comment">// æ­£ç¡®</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†é¿å…åç§°é®æ©é—®é¢˜ï¼Œéœ€è¦ç¡®ä¿ä»¥ä¸‹å½¢å¼çš„<code>operator new</code>å¯¹äºå®šåˆ¶ç±»å‹ä»ç„¶å¯ç”¨ï¼Œé™¤éä½ çš„æ„å›¾å°±æ˜¯é˜»æ­¢å®¢æˆ·ä½¿ç”¨å®ƒä»¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">operator</span><span class="params">(std::<span class="type">size_t</span>)</span> <span class="title">throw</span><span class="params">(std::bad_alloc)</span></span>;           <span class="comment">// normal new</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">operator</span><span class="params">(std::<span class="type">size_t</span>, <span class="type">void</span>*)</span> <span class="keyword">noexcept</span></span>;                 <span class="comment">// placement new</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">operator</span><span class="params">(std::<span class="type">size_t</span>, <span class="type">const</span> std::<span class="type">nothrow_t</span>&amp;)</span> <span class="keyword">noexcept</span></span>; <span class="comment">// nothrow new</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæœ€ç®€å•çš„å®ç°æ–¹å¼æ˜¯ï¼Œå‡†å¤‡ä¸€ä¸ªåŸºç±»ï¼Œå†…å«æ‰€æœ‰æ­£å¸¸å½¢å¼çš„ new å’Œ deleteï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StadardNewDeleteForms</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// normal new/delete</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ::<span class="keyword">operator</span> <span class="built_in">new</span>(size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* pMemory)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        ::<span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(pMemory)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// placement new/delete</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size, <span class="type">void</span>* ptr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ::<span class="keyword">operator</span> <span class="built_in">new</span>(size, ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* pMemory, <span class="type">void</span>* ptr)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        ::<span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(pMemory, ptr)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// nothrow new/delete</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size, <span class="type">const</span> std::<span class="type">nothrow_t</span>&amp; nt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ::<span class="keyword">operator</span> <span class="built_in">new</span>(size,nt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* pMemory,<span class="type">const</span> std::<span class="type">nothrow_t</span>&amp;)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        ::<span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(pMemory)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å‡¡æ˜¯æƒ³ä»¥è‡ªå®šä¹‰å½¢å¼æ‰©å……æ ‡å‡†å½¢å¼çš„å®¢æˆ·ï¼Œå¯ä»¥åˆ©ç”¨ç»§æ‰¿å’Œ<code>using</code>å£°æ˜å¼ï¼ˆè§æ¡æ¬¾ 33ï¼‰å–å¾—æ ‡å‡†å½¢å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span>: <span class="keyword">public</span> StandardNewDeleteForms&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> StandardNewDeleteForms::<span class="keyword">operator</span> <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">using</span> StandardNewDeleteForms::<span class="keyword">operator</span> <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size, std::ostream&amp; logStream)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="keyword">operator</span> <span class="title">detele</span><span class="params">(std::<span class="type">size_t</span> size, std::ostream&amp; logStream)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¹ç« ï¼šæ‚é¡¹è®¨è®º">ç¬¬ä¹ç« ï¼šæ‚é¡¹è®¨è®º</h2><h3 id="æ¡æ¬¾-53ï¼šä¸è¦è½»å¿½ç¼–è¯‘å™¨çš„è­¦å‘Š">æ¡æ¬¾ 53ï¼šä¸è¦è½»å¿½ç¼–è¯‘å™¨çš„è­¦å‘Š</h3><ol><li>ä¸¥è‚ƒå¯¹å¾…ç¼–è¯‘å™¨å‘å‡ºçš„è­¦å‘Šä¿¡æ¯ã€‚åŠªåŠ›åœ¨ä½ çš„ç¼–è¯‘å™¨çš„æœ€é«˜ï¼ˆæœ€ä¸¥è‹›ï¼‰è­¦å‘Šçº§åˆ«ä¸‹äº‰å–â€œæ— ä»»ä½•è­¦å‘Šâ€çš„è£èª‰ã€‚</li><li>ä¸è¦è¿‡åº¦ä¾èµ–ç¼–è¯‘å™¨çš„è­¦å‘Šèƒ½åŠ›ï¼Œå› ä¸ºä¸åŒçš„ç¼–è¯‘å™¨å¯¹å¾…äº‹æƒ…çš„æ€åº¦ä¸åŒã€‚ä¸€æ—¦ç§»æ¤åˆ°å¦ä¸€ä¸ªç¼–è¯‘å™¨ä¸Šï¼Œä½ åŸæœ¬ä¾èµ–çš„è­¦å‘Šä¿¡æ¯å¯èƒ½ä¼šæ¶ˆå¤±ã€‚</li></ol><h3 id="æ¡æ¬¾-54ï¼šè®©è‡ªå·±ç†Ÿæ‚‰åŒ…æ‹¬-TR1-åœ¨å†…çš„æ ‡å‡†ç¨‹åºåº“">æ¡æ¬¾ 54ï¼šè®©è‡ªå·±ç†Ÿæ‚‰åŒ…æ‹¬ TR1 åœ¨å†…çš„æ ‡å‡†ç¨‹åºåº“</h3><p>å¦‚ä»Š TR1 è‰æ¡ˆå·²å®Œå…¨èå…¥ C++ æ ‡å‡†å½“ä¸­ï¼Œæ²¡æœ‰å†è¿‡å¤šäº†è§£ TR1 æ ‡å‡†åº“çš„å¿…è¦ã€‚</p><h3 id="æ¡æ¬¾-55ï¼šè®©è‡ªå·±ç†Ÿæ‚‰-Boost">æ¡æ¬¾ 55ï¼šè®©è‡ªå·±ç†Ÿæ‚‰ Boost</h3><p>Boost æ˜¯è‹¥å¹²ä¸ªç¨‹åºåº“çš„é›†åˆï¼Œå¹¶ä¸”å½“ä¸­çš„è®¸å¤šåº“å·²ç»è¢« C++ å¸çº³ä¸ºæ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ã€‚ä¸è¿‡åœ¨ç°åœ¨çš„ Modern C++ æ—¶ä»£ï¼Œæ˜¯å¦è¯¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Boost ä»ç„¶æœ‰ä¸€å®šçš„äº‰è®®ï¼Œä¸€äº› Boost ç»„ä»¶å¹¶æ— æ³•åšåˆ°åƒ C++ æ ‡å‡†åº“é‚£æ ·é«˜æ€§èƒ½ï¼Œé›¶å¼€é”€æŠ½è±¡ï¼Œä½†æ¯«æ— ç–‘é—®çš„æ˜¯ï¼ŒBoost çš„å‚è€ƒä»·å€¼æ˜¯æ— æ³•å¿½è§†çš„ï¼Œä½ å¯ä»¥åœ¨ Boost ä¸­æ‰¾åˆ°è®¸å¤šéå¸¸å€¼å¾—å­¦ä¹ å’Œå€Ÿé‰´çš„å®ç°ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Cpp </category>
          
          <category> è¯»ä¹¦ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cpp </tag>
            
            <tag> è¯»ä¹¦ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Modern Cpp</title>
      <link href="/posts/af408df9.html"/>
      <url>/posts/af408df9.html</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>é“¾æ¥åœ°å€ï¼š<a href="https://changkun.de/modern-cpp/">https://changkun.de/modern-cpp/</a></p><p>ä¸€æœ¬éå¸¸å¥½ä¸Šæ‰‹çš„ç°ä»£cppæ•™æï¼Œæ—©åœ¨å»å¹´çš„æ—¶å€™åœ¨å‚åŠ OceanBaseæ¯”èµ›çš„æ—¶å€™å®¤å‹æ¨èçš„å­¦ä¹ èµ„æ–™ã€‚</p><h1>ç¬¬ 1 ç«  è¿ˆå‘ç°ä»£ C++</h1><p><strong>ç¼–è¯‘ç¯å¢ƒ</strong>ï¼šæœ¬ä¹¦å°†ä½¿ç”¨ <code>clang++</code> ä½œä¸ºå”¯ä¸€ä½¿ç”¨çš„ç¼–è¯‘å™¨ï¼ŒåŒæ—¶æ€»æ˜¯åœ¨ä»£ç ä¸­ä½¿ç”¨ <code>-std=c++2a</code> ç¼–è¯‘æ ‡å¿—ã€‚</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&gt;</span> <span class="string">clang++ -v</span></span><br><span class="line"><span class="attribute">Apple LLVM version 10.0.1 (clang-1001.0.46.4)</span></span><br><span class="line"><span class="attribute">Target</span><span class="punctuation">:</span> <span class="string">x86_64-apple-darwin18.6.0</span></span><br><span class="line"><span class="attribute">Thread model</span><span class="punctuation">:</span> <span class="string">posix</span></span><br><span class="line"><span class="attribute">InstalledDir</span><span class="punctuation">:</span> <span class="string">/Library/Developer/CommandLineTools/usr/bin</span></span><br></pre></td></tr></table></figure><h2 id="1-1-è¢«å¼ƒç”¨çš„ç‰¹æ€§">1.1 è¢«å¼ƒç”¨çš„ç‰¹æ€§</h2><p>åœ¨å­¦ä¹ ç°ä»£ C++ ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä» C++11 å¼€å§‹ï¼Œè¢«å¼ƒç”¨çš„ä¸»è¦ç‰¹æ€§ï¼š</p><blockquote><p><strong>æ³¨æ„</strong>ï¼šå¼ƒç”¨å¹¶éå½»åº•ä¸èƒ½ç”¨ï¼Œåªæ˜¯ç”¨äºæš—ç¤ºç¨‹åºå‘˜è¿™äº›ç‰¹æ€§å°†ä»æœªæ¥çš„æ ‡å‡†ä¸­æ¶ˆå¤±ï¼Œåº”è¯¥å°½é‡é¿å…ä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œå·²å¼ƒç”¨çš„ç‰¹æ€§ä¾ç„¶æ˜¯æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”å‡ºäºå…¼å®¹æ€§çš„è€ƒè™‘ï¼Œå¤§éƒ¨åˆ†ç‰¹æ€§å…¶å®ä¼šã€æ°¸ä¹…ã€ä¿ç•™ã€‚</p></blockquote><ul><li><p><strong>ä¸å†å…è®¸å­—ç¬¦ä¸²å­—é¢å€¼å¸¸é‡èµ‹å€¼ç»™ä¸€ä¸ª <code>char \*</code>ã€‚å¦‚æœéœ€è¦ç”¨å­—ç¬¦ä¸²å­—é¢å€¼å¸¸é‡èµ‹å€¼å’Œåˆå§‹åŒ–ä¸€ä¸ª <code>char \*</code>ï¼Œåº”è¯¥ä½¿ç”¨ <code>const char \*</code> æˆ–è€… <code>auto</code>ã€‚</strong></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">char</span> *<span class="built_in">str</span> = <span class="string">&quot;hello world!&quot;</span>; <span class="comment">// å°†å‡ºç°å¼ƒç”¨è­¦å‘Š</span></span><br></pre></td></tr></table></figure></li><li><p><strong>C++98 å¼‚å¸¸è¯´æ˜ã€ <code>unexpected_handler</code>ã€<code>set_unexpected()</code> ç­‰ç›¸å…³ç‰¹æ€§è¢«å¼ƒç”¨ï¼Œåº”è¯¥ä½¿ç”¨ <code>noexcept</code>ã€‚</strong></p></li><li><p><strong><code>auto_ptr</code> è¢«å¼ƒç”¨ï¼Œåº”ä½¿ç”¨ <code>unique_ptr</code>ã€‚</strong></p></li><li><p><strong><code>register</code> å…³é”®å­—è¢«å¼ƒç”¨ï¼Œå¯ä»¥ä½¿ç”¨ä½†ä¸å†å…·å¤‡ä»»ä½•å®é™…å«ä¹‰ã€‚</strong></p></li><li><p><strong><code>bool</code> ç±»å‹çš„ <code>++</code> æ“ä½œè¢«å¼ƒç”¨ã€‚</strong></p></li><li><p><strong>å¦‚æœä¸€ä¸ªç±»æœ‰ææ„å‡½æ•°ï¼Œä¸ºå…¶ç”Ÿæˆæ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„ç‰¹æ€§è¢«å¼ƒç”¨äº†ã€‚</strong></p></li><li><p><strong>C è¯­è¨€é£æ ¼çš„ç±»å‹è½¬æ¢è¢«å¼ƒç”¨ï¼ˆå³åœ¨å˜é‡å‰ä½¿ç”¨ <code>(convert_type)</code>ï¼‰ï¼Œåº”è¯¥ä½¿ç”¨ <code>static_cast</code>ã€<code>reinterpret_cast</code>ã€<code>const_cast</code> æ¥è¿›è¡Œç±»å‹è½¬æ¢ã€‚</strong></p></li><li><p><strong>ç‰¹åˆ«åœ°ï¼Œåœ¨æœ€æ–°çš„ C++17 æ ‡å‡†ä¸­å¼ƒç”¨äº†ä¸€äº›å¯ä»¥ä½¿ç”¨çš„ C æ ‡å‡†åº“ï¼Œä¾‹å¦‚ <code>&lt;ccomplex&gt;</code>ã€<code>&lt;cstdalign&gt;</code>ã€<code>&lt;cstdbool&gt;</code> ä¸ <code>&lt;ctgmath&gt;</code> ç­‰</strong></p></li><li><p>â€¦â€¦ç­‰ç­‰</p></li></ul><p>è¿˜æœ‰ä¸€äº›å…¶ä»–è¯¸å¦‚å‚æ•°ç»‘å®šï¼ˆC++11 æä¾›äº† <code>std::bind</code> å’Œ <code>std::function</code>ï¼‰ã€<code>export</code> ç­‰ç‰¹æ€§ä¹Ÿå‡è¢«å¼ƒç”¨ã€‚å‰é¢æåˆ°çš„è¿™äº›ç‰¹æ€§<strong>å¦‚æœä½ ä»æœªä½¿ç”¨æˆ–è€…å¬è¯´è¿‡ï¼Œä¹Ÿè¯·ä¸è¦å°è¯•å»äº†è§£ä»–ä»¬ï¼Œåº”è¯¥å‘æ–°æ ‡å‡†é æ‹¢</strong>ï¼Œç›´æ¥å­¦ä¹ æ–°ç‰¹æ€§ã€‚æ¯•ç«Ÿï¼ŒæŠ€æœ¯æ˜¯å‘å‰å‘å±•çš„ã€‚</p><h2 id="1-2-ä¸-C-çš„å…¼å®¹æ€§">1.2 ä¸ C çš„å…¼å®¹æ€§</h2><p>å‡ºäºä¸€äº›ä¸å¯æŠ—åŠ›ã€å†å²åŸå› ï¼Œæˆ‘ä»¬ä¸å¾—ä¸åœ¨ C++ ä¸­ä½¿ç”¨ä¸€äº› C è¯­è¨€ä»£ç ï¼ˆç”šè‡³å¤è€çš„ C è¯­è¨€ä»£ç ï¼‰ï¼Œä¾‹å¦‚ Linux ç³»ç»Ÿè°ƒç”¨ã€‚åœ¨ç°ä»£ C++ å‡ºç°ä¹‹å‰ï¼Œå¤§éƒ¨åˆ†äººå½“è°ˆåŠã€C ä¸ C++ çš„åŒºåˆ«æ˜¯ä»€ä¹ˆã€æ—¶ï¼Œæ™®éé™¤äº†å›ç­”é¢å‘å¯¹è±¡çš„ç±»ç‰¹æ€§ã€æ³›å‹ç¼–ç¨‹çš„æ¨¡æ¿ç‰¹æ€§å¤–ï¼Œå°±æ²¡æœ‰å…¶ä»–çš„çœ‹æ³•äº†ï¼Œç”šè‡³ç›´æ¥å›ç­”ã€å·®ä¸å¤šã€ï¼Œä¹Ÿæ˜¯å¤§æœ‰äººåœ¨ã€‚å›¾ 1.2 ä¸­çš„éŸ¦æ©å›¾å¤§è‡´ä¸Šå›ç­”äº† C å’Œ C++ ç›¸å…³çš„å…¼å®¹æƒ…å†µã€‚</p><p><img src="https://changkun.de/modern-cpp/assets/figures/comparison.png" alt="å›¾ 1.2: C å’Œ C++ äº’ç›¸å…¼å®¹æƒ…å†µ"></p><p>å’Œ C++ äº’ç›¸å…¼å®¹æƒ…å†µ</p><p>ä»ç°åœ¨å¼€å§‹ï¼Œä½ çš„è„‘å­é‡Œåº”è¯¥æ ‘ç«‹ã€<strong>C++ ä¸æ˜¯ C çš„ä¸€ä¸ªè¶…é›†</strong>ã€è¿™ä¸ªè§‚å¿µï¼ˆè€Œä¸”ä»ä¸€å¼€å§‹å°±ä¸æ˜¯ï¼Œåé¢çš„<a href="https://changkun.de/modern-cpp/zh-cn/01-intro/#%E8%BF%9B%E4%B8%80%E6%AD%A5%E9%98%85%E8%AF%BB%E7%9A%84%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">è¿›ä¸€æ­¥é˜…è¯»çš„å‚è€ƒæ–‡çŒ®</a>ä¸­ç»™å‡ºäº† C++98 å’Œ C99 ä¹‹é—´çš„åŒºåˆ«ï¼‰ã€‚åœ¨ç¼–å†™ C++ æ—¶ï¼Œä¹Ÿåº”è¯¥å°½å¯èƒ½çš„é¿å…ä½¿ç”¨è¯¸å¦‚ <code>void*</code> ä¹‹ç±»çš„ç¨‹åºé£æ ¼ã€‚è€Œåœ¨ä¸å¾—ä¸ä½¿ç”¨ C æ—¶ï¼Œåº”è¯¥æ³¨æ„ä½¿ç”¨ <code>extern &quot;C&quot;</code> è¿™ç§ç‰¹æ€§ï¼Œå°† C è¯­è¨€çš„ä»£ç ä¸ C++ä»£ç è¿›è¡Œåˆ†ç¦»ç¼–è¯‘ï¼Œå†ç»Ÿä¸€é“¾æ¥è¿™ç§åšæ³•ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// foo.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// foo.c</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x+y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.1.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    [out = std::<span class="built_in">ref</span>(std::cout &lt;&lt; <span class="string">&quot;Result from C code: &quot;</span> &lt;&lt; <span class="built_in">add</span>(<span class="number">1</span>, <span class="number">2</span>))]()&#123;</span><br><span class="line">        out.<span class="built_in">get</span>() &lt;&lt; <span class="string">&quot;.\n&quot;</span>;</span><br><span class="line">    &#125;();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”å…ˆä½¿ç”¨ <code>gcc</code> ç¼–è¯‘ C è¯­è¨€çš„ä»£ç ï¼š</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -<span class="keyword">c</span> foo.<span class="keyword">c</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å‡º <code>foo.o</code> æ–‡ä»¶ï¼Œå†ä½¿ç”¨ <code>clang++</code> å°† C++ ä»£ç å’Œ <code>.o</code> æ–‡ä»¶é“¾æ¥èµ·æ¥ï¼ˆæˆ–è€…éƒ½ç¼–è¯‘ä¸º <code>.o</code> å†ç»Ÿä¸€é“¾æ¥ï¼‰ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">clang</span>++ <span class="number">1</span>.<span class="number">1</span>.cpp foo.o -std=c++<span class="number">2</span>a -o <span class="number">1</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>Makefile</code> æ¥ç¼–è¯‘ä¸Šé¢çš„ä»£ç ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">C = gcc</span><br><span class="line">CXX = clang++</span><br><span class="line"></span><br><span class="line">SOURCE_C = foo.c</span><br><span class="line">OBJECTS_C = foo.o</span><br><span class="line"></span><br><span class="line">SOURCE_CXX = 1.1.cpp</span><br><span class="line"></span><br><span class="line">TARGET = 1.1</span><br><span class="line">LDFLAGS_COMMON = -std=c++2a</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line"><span class="variable">$(C)</span> -c <span class="variable">$(SOURCE_C)</span></span><br><span class="line"><span class="variable">$(CXX)</span> <span class="variable">$(SOURCE_CXX)</span> <span class="variable">$(OBJECTS_C)</span> <span class="variable">$(LDFLAGS_COMMON)</span> -o <span class="variable">$(TARGET)</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -rf *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š<code>Makefile</code> ä¸­çš„ç¼©è¿›æ˜¯åˆ¶è¡¨ç¬¦è€Œä¸æ˜¯ç©ºæ ¼ç¬¦ï¼Œå¦‚æœä½ ç›´æ¥å¤åˆ¶è¿™æ®µä»£ç åˆ°ä½ çš„ç¼–è¾‘å™¨ä¸­ï¼Œåˆ¶è¡¨ç¬¦å¯èƒ½ä¼šè¢«è‡ªåŠ¨æ›¿æ¢æ‰ï¼Œè¯·è‡ªè¡Œç¡®ä¿åœ¨ <code>Makefile</code> ä¸­çš„ç¼©è¿›æ˜¯ç”±åˆ¶è¡¨ç¬¦å®Œæˆçš„ã€‚</p><p>å¦‚æœä½ è¿˜ä¸çŸ¥é“ <code>Makefile</code> çš„ä½¿ç”¨ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæœ¬æ•™ç¨‹ä¸­ä¸ä¼šæ„å»ºè¿‡äºå¤æ‚çš„ä»£ç ï¼Œç®€å•çš„åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ <code>clang++ -std=c++2a</code> ä¹Ÿå¯ä»¥é˜…è¯»æœ¬ä¹¦ã€‚</p></blockquote><p>å¦‚æœä½ æ˜¯é¦–æ¬¡æ¥è§¦ç°ä»£ C++ï¼Œé‚£ä¹ˆä½ å¾ˆå¯èƒ½è¿˜çœ‹ä¸æ‡‚ä¸Šé¢çš„é‚£ä¸€å°æ®µä»£ç ï¼Œå³ï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">out</span> = <span class="keyword">std</span>::ref(<span class="keyword">std</span>::cout &lt;&lt; <span class="string">&quot;Result from C code: &quot;</span> &lt;&lt; <span class="keyword">add</span>(<span class="number">1</span>, <span class="number">2</span>))]()&#123;</span><br><span class="line">    <span class="keyword">out</span>.get() &lt;&lt; <span class="string">&quot;.\n&quot;</span><span class="comment">;</span></span><br><span class="line">&#125;()<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>ä¸å¿…æ‹…å¿ƒï¼Œæœ¬ä¹¦çš„åç»­ç« èŠ‚å°†ä¸ºä½ ä»‹ç»è¿™ä¸€åˆ‡ã€‚</p><h1>ç¬¬ 2 ç«  è¯­è¨€å¯ç”¨æ€§çš„å¼ºåŒ–</h1><p>å½“æˆ‘ä»¬å£°æ˜ã€å®šä¹‰ä¸€ä¸ªå˜é‡æˆ–è€…å¸¸é‡ï¼Œå¯¹ä»£ç è¿›è¡Œæµç¨‹æ§åˆ¶ã€é¢å‘å¯¹è±¡çš„åŠŸèƒ½ã€æ¨¡æ¿ç¼–ç¨‹ç­‰è¿™äº›éƒ½æ˜¯è¿è¡Œæ—¶ä¹‹å‰ï¼Œå¯èƒ½å‘ç”Ÿåœ¨ç¼–å†™ä»£ç æˆ–ç¼–è¯‘å™¨ç¼–è¯‘ä»£ç æ—¶çš„è¡Œä¸ºã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬é€šå¸¸è°ˆåŠ<strong>è¯­è¨€å¯ç”¨æ€§</strong>ï¼Œæ˜¯æŒ‡é‚£äº›å‘ç”Ÿåœ¨è¿è¡Œæ—¶ä¹‹å‰çš„è¯­è¨€è¡Œä¸ºã€‚</p><h2 id="2-1-å¸¸é‡">2.1 å¸¸é‡</h2><h3 id="nullptr">nullptr</h3><p><code>nullptr</code> å‡ºç°çš„ç›®çš„æ˜¯ä¸ºäº†æ›¿ä»£ <code>NULL</code>ã€‚åœ¨æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œä¼ ç»Ÿ C++ ä¼šæŠŠ <code>NULL</code>ã€<code>0</code> è§†ä¸ºåŒä¸€ç§ä¸œè¥¿ï¼Œè¿™å–å†³äºç¼–è¯‘å™¨å¦‚ä½•å®šä¹‰ <code>NULL</code>ï¼Œæœ‰äº›ç¼–è¯‘å™¨ä¼šå°† <code>NULL</code> å®šä¹‰ä¸º <code>((void*)0)</code>ï¼Œæœ‰äº›åˆ™ä¼šç›´æ¥å°†å…¶å®šä¹‰ä¸º <code>0</code>ã€‚</p><p>C++ <strong>ä¸å…è®¸</strong>ç›´æ¥å°† <code>void *</code> éšå¼è½¬æ¢åˆ°å…¶ä»–ç±»å‹ã€‚ä½†å¦‚æœç¼–è¯‘å™¨å°è¯•æŠŠ <code>NULL</code> å®šä¹‰ä¸º <code>((void*)0)</code>ï¼Œé‚£ä¹ˆåœ¨ä¸‹é¢è¿™å¥ä»£ç ä¸­ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char *ch <span class="operator">=</span> NULL<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>æ²¡æœ‰äº† <code>void *</code> éšå¼è½¬æ¢çš„ C++ åªå¥½å°† <code>NULL</code> å®šä¹‰ä¸º <code>0</code>ã€‚è€Œè¿™ä¾ç„¶ä¼šäº§ç”Ÿæ–°çš„é—®é¢˜ï¼Œå°† <code>NULL</code> å®šä¹‰æˆ <code>0</code> å°†å¯¼è‡´ <code>C++</code> ä¸­é‡è½½ç‰¹æ€§å‘ç”Ÿæ··ä¹±ã€‚è€ƒè™‘ä¸‹é¢è¿™ä¸¤ä¸ª <code>foo</code> å‡½æ•°ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆ <code>foo(NULL);</code> è¿™ä¸ªè¯­å¥å°†ä¼šå»è°ƒç”¨ <code>foo(int)</code>ï¼Œä»è€Œå¯¼è‡´ä»£ç è¿åç›´è§‰ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC++11 å¼•å…¥äº† <code>nullptr</code> å…³é”®å­—ï¼Œä¸“é—¨ç”¨æ¥åŒºåˆ†ç©ºæŒ‡é’ˆã€<code>0</code>ã€‚è€Œ <code>nullptr</code> çš„ç±»å‹ä¸º <code>nullptr_t</code>ï¼Œèƒ½å¤Ÿéšå¼çš„è½¬æ¢ä¸ºä»»ä½•æŒ‡é’ˆæˆ–æˆå‘˜æŒ‡é’ˆçš„ç±»å‹ï¼Œä¹Ÿèƒ½å’Œä»–ä»¬è¿›è¡Œç›¸ç­‰æˆ–è€…ä¸ç­‰çš„æ¯”è¾ƒã€‚</p><p>ä½ å¯ä»¥å°è¯•ä½¿ç”¨ <code>clang++</code> ç¼–è¯‘ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;type_traits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">char</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (std::is_same&lt;<span class="keyword">decltype</span>(<span class="literal">NULL</span>), <span class="keyword">decltype</span>(<span class="number">0</span>)&gt;::value)</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;NULL == 0&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">if</span> (std::is_same&lt;<span class="keyword">decltype</span>(<span class="literal">NULL</span>), <span class="keyword">decltype</span>((<span class="type">void</span>*)<span class="number">0</span>)&gt;::value)</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;NULL == (void *)0&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">if</span> (std::is_same&lt;<span class="keyword">decltype</span>(<span class="literal">NULL</span>), std::<span class="type">nullptr_t</span>&gt;::value)</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;NULL == nullptr&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">foo</span>(<span class="number">0</span>);          <span class="comment">// è°ƒç”¨ foo(int)</span></span><br><span class="line">    <span class="comment">// foo(NULL);    // è¯¥è¡Œä¸èƒ½é€šè¿‡ç¼–è¯‘</span></span><br><span class="line">    <span class="built_in">foo</span>(<span class="literal">nullptr</span>);    <span class="comment">// è°ƒç”¨ foo(char*)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">char</span> *)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo(char*) is called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo(int) is called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†è¾“å‡ºï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foo(<span class="type">int</span>) <span class="keyword">is</span> <span class="keyword">called</span></span><br><span class="line">foo(<span class="type">char</span>*) <span class="keyword">is</span> <span class="keyword">called</span></span><br></pre></td></tr></table></figure><p>ä»è¾“å‡ºä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ<code>NULL</code> ä¸åŒäº <code>0</code> ä¸ <code>nullptr</code>ã€‚æ‰€ä»¥ï¼Œè¯·å…»æˆç›´æ¥ä½¿ç”¨ <code>nullptr</code>çš„ä¹ æƒ¯ã€‚</p><p>æ­¤å¤–ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† <code>decltype</code> å’Œ <code>std::is_same</code> è¿™ä¸¤ä¸ªå±äºç°ä»£ C++ çš„è¯­æ³•ï¼Œç®€å•æ¥è¯´ï¼Œ<code>decltype</code> ç”¨äºç±»å‹æ¨å¯¼ï¼Œè€Œ <code>std::is_same</code> ç”¨äºæ¯”è¾ƒä¸¤ä¸ªç±»å‹æ˜¯å¦ç›¸åŒï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢ <a href="https://changkun.de/modern-cpp/zh-cn/02-usability/#decltype">decltype</a> ä¸€èŠ‚ä¸­è¯¦ç»†è®¨è®ºã€‚</p><h3 id="constexpr">constexpr</h3><p>C++ æœ¬èº«å·²ç»å…·å¤‡äº†å¸¸é‡è¡¨è¾¾å¼çš„æ¦‚å¿µï¼Œæ¯”å¦‚ <code>1+2</code>, <code>3*4</code> è¿™ç§è¡¨è¾¾å¼æ€»æ˜¯ä¼šäº§ç”Ÿç›¸åŒçš„ç»“æœå¹¶ä¸”æ²¡æœ‰ä»»ä½•å‰¯ä½œç”¨ã€‚å¦‚æœç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶å°±æŠŠè¿™äº›è¡¨è¾¾å¼ç›´æ¥ä¼˜åŒ–å¹¶æ¤å…¥åˆ°ç¨‹åºè¿è¡Œæ—¶ï¼Œå°†èƒ½å¢åŠ ç¨‹åºçš„æ€§èƒ½ã€‚ä¸€ä¸ªéå¸¸æ˜æ˜¾çš„ä¾‹å­å°±æ˜¯åœ¨æ•°ç»„çš„å®šä¹‰é˜¶æ®µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEN 10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">len_foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="type">int</span> <span class="title">len_foo_constexpr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="type">int</span> <span class="title">fibonacci</span><span class="params">(<span class="type">const</span> <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n == <span class="number">1</span> || n == <span class="number">2</span> ? <span class="number">1</span> : <span class="built_in">fibonacci</span>(n<span class="number">-1</span>)+<span class="built_in">fibonacci</span>(n<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> arr_1[<span class="number">10</span>];                      <span class="comment">// åˆæ³•</span></span><br><span class="line">    <span class="type">char</span> arr_2[LEN];                     <span class="comment">// åˆæ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// char arr_3[len];                  // éæ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> len_2 = len + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="type">int</span> len_2_constexpr = <span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span>;</span><br><span class="line">    <span class="comment">// char arr_4[len_2];                // éæ³•</span></span><br><span class="line">    <span class="type">char</span> arr_4[len_2_constexpr];         <span class="comment">// åˆæ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// char arr_5[len_foo()+5];          // éæ³•</span></span><br><span class="line">    <span class="type">char</span> arr_6[<span class="built_in">len_foo_constexpr</span>() + <span class="number">1</span>]; <span class="comment">// åˆæ³•</span></span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">fibonacci</span>(<span class="number">10</span>) &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// 1, 1, 2, 3, 5, 8, 13, 21, 34, 55</span></span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">fibonacci</span>(<span class="number">10</span>) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>char arr_4[len_2]</code> å¯èƒ½æ¯”è¾ƒä»¤äººå›°æƒ‘ï¼Œå› ä¸º <code>len_2</code> å·²ç»è¢«å®šä¹‰ä¸ºäº†å¸¸é‡ã€‚ä¸ºä»€ä¹ˆ <code>char arr_4[len_2]</code> ä»ç„¶æ˜¯éæ³•çš„å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º C++ æ ‡å‡†ä¸­æ•°ç»„çš„é•¿åº¦å¿…é¡»æ˜¯ä¸€ä¸ªå¸¸é‡è¡¨è¾¾å¼ï¼Œè€Œå¯¹äº <code>len_2</code> è€Œè¨€ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>const</code> å¸¸æ•°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå¸¸é‡è¡¨è¾¾å¼ï¼Œå› æ­¤ï¼ˆå³ä¾¿è¿™ç§è¡Œä¸ºåœ¨å¤§éƒ¨åˆ†ç¼–è¯‘å™¨ä¸­éƒ½æ”¯æŒï¼Œä½†æ˜¯ï¼‰å®ƒæ˜¯ä¸€ä¸ªéæ³•çš„è¡Œä¸ºï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ¥ä¸‹æ¥å³å°†ä»‹ç»çš„ C++11 å¼•å…¥çš„ <code>constexpr</code> ç‰¹æ€§æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼›è€Œå¯¹äº <code>arr_5</code> æ¥è¯´ï¼ŒC++98 ä¹‹å‰çš„ç¼–è¯‘å™¨æ— æ³•å¾—çŸ¥ <code>len_foo()</code> åœ¨è¿è¡ŒæœŸå®é™…ä¸Šæ˜¯è¿”å›ä¸€ä¸ªå¸¸æ•°ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†éæ³•çš„äº§ç”Ÿã€‚</p><blockquote><p>æ³¨æ„ï¼Œç°åœ¨å¤§éƒ¨åˆ†ç¼–è¯‘å™¨å…¶å®éƒ½å¸¦æœ‰è‡ªèº«ç¼–è¯‘ä¼˜åŒ–ï¼Œå¾ˆå¤šéæ³•è¡Œä¸ºåœ¨ç¼–è¯‘å™¨ä¼˜åŒ–çš„åŠ æŒä¸‹ä¼šå˜å¾—åˆæ³•ï¼Œè‹¥éœ€é‡ç°ç¼–è¯‘æŠ¥é”™çš„ç°è±¡éœ€è¦ä½¿ç”¨è€ç‰ˆæœ¬çš„ç¼–è¯‘å™¨ã€‚</p></blockquote><p>C++11 æä¾›äº† <code>constexpr</code> è®©ç”¨æˆ·æ˜¾å¼çš„å£°æ˜å‡½æ•°æˆ–å¯¹è±¡æ„é€ å‡½æ•°åœ¨ç¼–è¯‘æœŸä¼šæˆä¸ºå¸¸é‡è¡¨è¾¾å¼ï¼Œè¿™ä¸ªå…³é”®å­—æ˜ç¡®çš„å‘Šè¯‰ç¼–è¯‘å™¨åº”è¯¥å»éªŒè¯ <code>len_foo</code> åœ¨ç¼–è¯‘æœŸå°±åº”è¯¥æ˜¯ä¸€ä¸ªå¸¸é‡è¡¨è¾¾å¼ã€‚</p><p>æ­¤å¤–ï¼Œ<code>constexpr</code> ä¿®é¥°çš„å‡½æ•°å¯ä»¥ä½¿ç”¨é€’å½’ï¼š</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">constexpr <span class="built_in">int</span> fibonacci(const <span class="built_in">int</span> <span class="built_in">n</span>) &#123;</span><br><span class="line">    return <span class="built_in">n</span> == <span class="number">1</span> || <span class="built_in">n</span> == <span class="number">2</span> ? <span class="number">1</span> <span class="symbol">:</span> fibonacci(<span class="built_in">n</span>-<span class="number">1</span>)+fibonacci(<span class="built_in">n</span>-<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä» C++14 å¼€å§‹ï¼Œ<code>constexpr</code> å‡½æ•°å¯ä»¥åœ¨å†…éƒ¨ä½¿ç”¨å±€éƒ¨å˜é‡ã€å¾ªç¯å’Œåˆ†æ”¯ç­‰ç®€å•è¯­å¥ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç åœ¨ C++11 çš„æ ‡å‡†ä¸‹æ˜¯ä¸èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘çš„ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">constexpr int <span class="built_in">fibonacci</span>(const int n) &#123;</span><br><span class="line">    <span class="built_in">if</span>(n == <span class="number">1</span>) return <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">if</span>(n == <span class="number">2</span>) return <span class="number">1</span>;</span><br><span class="line">    return <span class="built_in">fibonacci</span>(n-<span class="number">1</span>) + <span class="built_in">fibonacci</span>(n-<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºä¸‹é¢è¿™ç±»ç®€åŒ–çš„ç‰ˆæœ¬æ¥ä½¿å¾—å‡½æ•°ä» C++11 å¼€å§‹å³å¯ç”¨ï¼š</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">constexpr <span class="built_in">int</span> fibonacci(const <span class="built_in">int</span> <span class="built_in">n</span>) &#123;</span><br><span class="line">    return <span class="built_in">n</span> == <span class="number">1</span> || <span class="built_in">n</span> == <span class="number">2</span> ? <span class="number">1</span> <span class="symbol">:</span> fibonacci(<span class="built_in">n</span>-<span class="number">1</span>) + fibonacci(<span class="built_in">n</span>-<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2-å˜é‡åŠå…¶åˆå§‹åŒ–">2.2 å˜é‡åŠå…¶åˆå§‹åŒ–</h2><h3 id="if-switch-å˜é‡å£°æ˜å¼ºåŒ–">if/switch å˜é‡å£°æ˜å¼ºåŒ–</h3><p>åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œå˜é‡çš„å£°æ˜è™½ç„¶èƒ½å¤Ÿä½äºä»»ä½•ä½ç½®ï¼Œç”šè‡³äº <code>for</code> è¯­å¥å†…èƒ½å¤Ÿå£°æ˜ä¸€ä¸ªä¸´æ—¶å˜é‡ <code>int</code>ï¼Œä½†å§‹ç»ˆæ²¡æœ‰åŠæ³•åœ¨ <code>if</code> å’Œ <code>switch</code> è¯­å¥ä¸­å£°æ˜ä¸€ä¸ªä¸´æ—¶çš„å˜é‡ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; vec = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨ c++17 ä¹‹å‰</span></span><br><span class="line">    <span class="type">const</span> std::vector&lt;<span class="type">int</span>&gt;::iterator itr = std::<span class="built_in">find</span>(vec.<span class="built_in">begin</span>(), vec.<span class="built_in">end</span>(), <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (itr != vec.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        *itr = <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éœ€è¦é‡æ–°å®šä¹‰ä¸€ä¸ªæ–°çš„å˜é‡</span></span><br><span class="line">    <span class="type">const</span> std::vector&lt;<span class="type">int</span>&gt;::iterator itr2 = std::<span class="built_in">find</span>(vec.<span class="built_in">begin</span>(), vec.<span class="built_in">end</span>(), <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (itr2 != vec.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        *itr2 = <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†è¾“å‡º 1, 4, 3, 4</span></span><br><span class="line">    <span class="keyword">for</span> (std::vector&lt;<span class="type">int</span>&gt;::iterator element = vec.<span class="built_in">begin</span>(); element != vec.<span class="built_in">end</span>(); </span><br><span class="line">        ++element)</span><br><span class="line">        std::cout &lt;&lt; *element &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>itr</code> è¿™ä¸€å˜é‡æ˜¯å®šä¹‰åœ¨æ•´ä¸ª <code>main()</code> çš„ä½œç”¨åŸŸå†…çš„ï¼Œè¿™å¯¼è‡´å½“æˆ‘ä»¬éœ€è¦å†æ¬¡éå†æ•´ä¸ª <code>std::vector</code> æ—¶ï¼Œéœ€è¦é‡æ–°å‘½åå¦ä¸€ä¸ªå˜é‡ã€‚C++17 æ¶ˆé™¤äº†è¿™ä¸€é™åˆ¶ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ <code>if</code>ï¼ˆæˆ– <code>switch</code>ï¼‰ä¸­å®Œæˆè¿™ä¸€æ“ä½œï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†ä¸´æ—¶å˜é‡æ”¾åˆ° if è¯­å¥å†…</span></span><br><span class="line"><span class="symbol">if</span> (const std::vector&lt;int&gt;::iterator <span class="keyword">itr</span> = std::find(vec.begin(), vec<span class="meta">.end</span>(), <span class="number">3</span>)<span class="comment">;</span></span><br><span class="line">    <span class="keyword">itr</span> != vec<span class="meta">.end</span>()) &#123;</span><br><span class="line">    *<span class="keyword">itr</span> = <span class="number">4</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯å’Œ Go è¯­è¨€å¾ˆåƒï¼Ÿ</p><h3 id="åˆå§‹åŒ–åˆ—è¡¨">åˆå§‹åŒ–åˆ—è¡¨</h3><p>åˆå§‹åŒ–æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è¯­è¨€ç‰¹æ€§ï¼Œæœ€å¸¸è§çš„å°±æ˜¯åœ¨å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–æ—¶è¿›è¡Œä½¿ç”¨ã€‚ åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œä¸åŒçš„å¯¹è±¡æœ‰ç€ä¸åŒçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œä¾‹å¦‚æ™®é€šæ•°ç»„ã€ POD ï¼ˆ<strong>P</strong>lain <strong>O</strong>ld <strong>D</strong>ataï¼Œå³æ²¡æœ‰æ„é€ ã€ææ„å’Œè™šå‡½æ•°çš„ç±»æˆ–ç»“æ„ä½“ï¼‰ ç±»å‹éƒ½å¯ä»¥ä½¿ç”¨ <code>&#123;&#125;</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„åˆå§‹åŒ–åˆ—è¡¨ã€‚ è€Œå¯¹äºç±»å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œè¦ä¹ˆéœ€è¦é€šè¿‡æ‹·è´æ„é€ ã€è¦ä¹ˆå°±éœ€è¦ä½¿ç”¨ <code>()</code> è¿›è¡Œã€‚ è¿™äº›ä¸åŒæ–¹æ³•éƒ½é’ˆå¯¹å„è‡ªå¯¹è±¡ï¼Œä¸èƒ½é€šç”¨ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> value_a;</span><br><span class="line">    <span class="type">int</span> value_b;</span><br><span class="line">    <span class="built_in">Foo</span>(<span class="type">int</span> a, <span class="type">int</span> b) : <span class="built_in">value_a</span>(a), <span class="built_in">value_b</span>(b) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// before C++11</span></span><br><span class="line">    <span class="type">int</span> arr[<span class="number">3</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">    <span class="function">Foo <span class="title">foo</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; vec = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;arr[0]: &quot;</span> &lt;&lt; arr[<span class="number">0</span>] &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo:&quot;</span> &lt;&lt; foo.value_a &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; foo.value_b &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span> (std::vector&lt;<span class="type">int</span>&gt;::iterator it = vec.<span class="built_in">begin</span>(); it != vec.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">        std::cout &lt;&lt; *it &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC++11 é¦–å…ˆæŠŠåˆå§‹åŒ–åˆ—è¡¨çš„æ¦‚å¿µç»‘å®šåˆ°ç±»å‹ä¸Šï¼Œç§°å…¶ä¸º <code>std::initializer_list</code>ï¼Œå…è®¸æ„é€ å‡½æ•°æˆ–å…¶ä»–å‡½æ•°åƒå‚æ•°ä¸€æ ·ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼Œè¿™å°±ä¸ºç±»å¯¹è±¡çš„åˆå§‹åŒ–ä¸æ™®é€šæ•°ç»„å’Œ POD çš„åˆå§‹åŒ–æ–¹æ³•æä¾›äº†ç»Ÿä¸€çš„æ¡¥æ¢ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;initializer_list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MagicFoo</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; vec;</span><br><span class="line">    <span class="built_in">MagicFoo</span>(std::initializer_list&lt;<span class="type">int</span>&gt; list) &#123;</span><br><span class="line">        <span class="keyword">for</span> (std::initializer_list&lt;<span class="type">int</span>&gt;::iterator it = list.<span class="built_in">begin</span>();</span><br><span class="line">             it != list.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            vec.<span class="built_in">push_back</span>(*it);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// after C++11</span></span><br><span class="line">    MagicFoo magicFoo = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;magicFoo: &quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (std::vector&lt;<span class="type">int</span>&gt;::iterator it = magicFoo.vec.<span class="built_in">begin</span>(); </span><br><span class="line">        it != magicFoo.vec.<span class="built_in">end</span>(); ++it) </span><br><span class="line">        std::cout &lt;&lt; *it &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ„é€ å‡½æ•°è¢«å«åšåˆå§‹åŒ–åˆ—è¡¨æ„é€ å‡½æ•°ï¼Œå…·æœ‰è¿™ç§æ„é€ å‡½æ•°çš„ç±»å‹å°†åœ¨åˆå§‹åŒ–æ—¶è¢«ç‰¹æ®Šå…³ç…§ã€‚</p><p>åˆå§‹åŒ–åˆ—è¡¨é™¤äº†ç”¨åœ¨å¯¹è±¡æ„é€ ä¸Šï¼Œè¿˜èƒ½å°†å…¶ä½œä¸ºæ™®é€šå‡½æ•°çš„å½¢å‚ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(std::initializer_list&lt;<span class="type">int</span>&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (std::initializer_list&lt;<span class="type">int</span>&gt;::iterator it = list.<span class="built_in">begin</span>();</span><br><span class="line">            it != list.<span class="built_in">end</span>(); ++it) vec.<span class="built_in">push_back</span>(*it);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">magicFoo.<span class="built_in">foo</span>(&#123;<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>&#125;);</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼ŒC++11 è¿˜æä¾›äº†ç»Ÿä¸€çš„è¯­æ³•æ¥åˆå§‹åŒ–ä»»æ„çš„å¯¹è±¡ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Foo</span> foo2 &#123;<span class="number">3</span>, <span class="number">4</span>&#125;;</span><br></pre></td></tr></table></figure><h3 id="ç»“æ„åŒ–ç»‘å®š">ç»“æ„åŒ–ç»‘å®š</h3><p>ç»“æ„åŒ–ç»‘å®šæä¾›äº†ç±»ä¼¼å…¶ä»–è¯­è¨€ä¸­æä¾›çš„å¤šè¿”å›å€¼çš„åŠŸèƒ½ã€‚åœ¨å®¹å™¨ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦åˆ° C++11 æ–°å¢äº† <code>std::tuple</code> å®¹å™¨ç”¨äºæ„é€ ä¸€ä¸ªå…ƒç»„ï¼Œè¿›è€Œå›Šæ‹¬å¤šä¸ªè¿”å›å€¼ã€‚ä½†ç¼ºé™·æ˜¯ï¼ŒC++11/14 å¹¶æ²¡æœ‰æä¾›ä¸€ç§ç®€å•çš„æ–¹æ³•ç›´æ¥ä»å…ƒç»„ä¸­æ‹¿åˆ°å¹¶å®šä¹‰å…ƒç»„ä¸­çš„å…ƒç´ ï¼Œå°½ç®¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>std::tie</code> å¯¹å…ƒç»„è¿›è¡Œæ‹†åŒ…ï¼Œä½†æˆ‘ä»¬ä¾ç„¶å¿…é¡»éå¸¸æ¸…æ¥šè¿™ä¸ªå…ƒç»„åŒ…å«å¤šå°‘ä¸ªå¯¹è±¡ï¼Œå„ä¸ªå¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹ï¼Œéå¸¸éº»çƒ¦ã€‚</p><p>C++17 å®Œå–„äº†è¿™ä¸€è®¾å®šï¼Œç»™å‡ºçš„ç»“æ„åŒ–ç»‘å®šå¯ä»¥è®©æˆ‘ä»¬å†™å‡ºè¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tuple&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::tuple&lt;<span class="type">int</span>, <span class="type">double</span>, std::string&gt; <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">1</span>, <span class="number">2.3</span>, <span class="string">&quot;456&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> [x, y, z] = <span class="built_in">f</span>();</span><br><span class="line">    std::cout &lt;&lt; x &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; z &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äº <code>auto</code> ç±»å‹æ¨å¯¼ä¼šåœ¨ <a href="https://changkun.de/modern-cpp/zh-cn/02-usability/#auto">auto ç±»å‹æ¨å¯¼</a>ä¸€èŠ‚ä¸­è¿›è¡Œä»‹ç»ã€‚</p><h2 id="2-3-ç±»å‹æ¨å¯¼">2.3 ç±»å‹æ¨å¯¼</h2><p>åœ¨ä¼ ç»Ÿ C å’Œ C++ ä¸­ï¼Œå‚æ•°çš„ç±»å‹éƒ½å¿…é¡»æ˜ç¡®å®šä¹‰ï¼Œè¿™å…¶å®å¯¹æˆ‘ä»¬å¿«é€Ÿè¿›è¡Œç¼–ç æ²¡æœ‰ä»»ä½•å¸®åŠ©ï¼Œå°¤å…¶æ˜¯å½“æˆ‘ä»¬é¢å¯¹ä¸€å¤§å †å¤æ‚çš„æ¨¡æ¿ç±»å‹æ—¶ï¼Œå¿…é¡»æ˜ç¡®çš„æŒ‡å‡ºå˜é‡çš„ç±»å‹æ‰èƒ½è¿›è¡Œåç»­çš„ç¼–ç ï¼Œè¿™ä¸ä»…æ‹–æ…¢æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ï¼Œä¹Ÿè®©ä»£ç å˜å¾—åˆè‡­åˆé•¿ã€‚</p><p>C++11 å¼•å…¥äº† <code>auto</code> å’Œ <code>decltype</code> è¿™ä¸¤ä¸ªå…³é”®å­—å®ç°äº†ç±»å‹æ¨å¯¼ï¼Œè®©ç¼–è¯‘å™¨æ¥æ“å¿ƒå˜é‡çš„ç±»å‹ã€‚è¿™ä½¿å¾— C++ ä¹Ÿå…·æœ‰äº†å’Œå…¶ä»–ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒæŸç§æ„ä¹‰ä¸Šæä¾›äº†æ— éœ€æ“å¿ƒå˜é‡ç±»å‹çš„ä½¿ç”¨ä¹ æƒ¯ã€‚</p><h3 id="auto">auto</h3><p><code>auto</code> åœ¨å¾ˆæ—©ä»¥å‰å°±å·²ç»è¿›å…¥äº† C++ï¼Œä½†æ˜¯ä»–å§‹ç»ˆä½œä¸ºä¸€ä¸ªå­˜å‚¨ç±»å‹çš„æŒ‡ç¤ºç¬¦å­˜åœ¨ï¼Œä¸ <code>register</code> å¹¶å­˜ã€‚åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œå¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰å£°æ˜ä¸º <code>register</code> å˜é‡ï¼Œå°†è‡ªåŠ¨è¢«è§†ä¸ºä¸€ä¸ª <code>auto</code> å˜é‡ã€‚è€Œéšç€ <code>register</code> è¢«å¼ƒç”¨ï¼ˆåœ¨ C++17 ä¸­ä½œä¸ºä¿ç•™å…³é”®å­—ï¼Œä»¥åä½¿ç”¨ï¼Œç›®å‰ä¸å…·å¤‡å®é™…æ„ä¹‰ï¼‰ï¼Œå¯¹ <code>auto</code> çš„è¯­ä¹‰å˜æ›´ä¹Ÿå°±éå¸¸è‡ªç„¶äº†ã€‚</p><p>ä½¿ç”¨ <code>auto</code> è¿›è¡Œç±»å‹æ¨å¯¼çš„ä¸€ä¸ªæœ€ä¸ºå¸¸è§è€Œä¸”æ˜¾è‘—çš„ä¾‹å­å°±æ˜¯è¿­ä»£å™¨ã€‚ä½ åº”è¯¥åœ¨å‰é¢çš„å°èŠ‚é‡Œçœ‹åˆ°äº†ä¼ ç»Ÿ C++ ä¸­å†—é•¿çš„è¿­ä»£å†™æ³•ï¼š</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨ C++11 ä¹‹å‰</span></span><br><span class="line"><span class="comment">// ç”±äº cbegin() å°†è¿”å› vector&lt;int&gt;::const_iterator</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ it ä¹Ÿåº”è¯¥æ˜¯ vector&lt;int&gt;::const_iterator ç±»å‹</span></span><br><span class="line"><span class="keyword">for</span>(<span class="built_in">vector</span>&lt;int&gt;::const_iterator it = <span class="built_in">vec</span>.<span class="built_in">cbegin</span>(); it != <span class="built_in">vec</span>.<span class="built_in">cend</span>(); ++it)</span><br></pre></td></tr></table></figure><p>è€Œæœ‰äº† <code>auto</code> ä¹‹åå¯ä»¥ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;initializer_list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MagicFoo</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; vec;</span><br><span class="line">    <span class="built_in">MagicFoo</span>(std::initializer_list&lt;<span class="type">int</span>&gt; list) &#123;</span><br><span class="line">        <span class="comment">// ä» C++11 èµ·, ä½¿ç”¨ auto å…³é”®å­—è¿›è¡Œç±»å‹æ¨å¯¼</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> it = list.<span class="built_in">begin</span>(); it != list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">            vec.<span class="built_in">push_back</span>(*it);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MagicFoo magicFoo = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;magicFoo: &quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = magicFoo.vec.<span class="built_in">begin</span>(); it != magicFoo.vec.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">        std::cout &lt;&lt; *it &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€äº›å…¶ä»–çš„å¸¸è§ç”¨æ³•ï¼š</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> i = <span class="number">5</span>;              <span class="comment">// i è¢«æ¨å¯¼ä¸º int</span></span><br><span class="line"><span class="keyword">auto</span> arr = <span class="keyword">new</span> <span class="keyword">auto</span>(<span class="number">10</span>); <span class="comment">// arr è¢«æ¨å¯¼ä¸º int *</span></span><br></pre></td></tr></table></figure><p>ä» C++ 20 èµ·ï¼Œ<code>auto</code> ç”šè‡³èƒ½ç”¨äºå‡½æ•°ä¼ å‚ï¼Œè€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="keyword">auto</span> x, <span class="keyword">auto</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x+y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> i = <span class="number">5</span>; <span class="comment">// è¢«æ¨å¯¼ä¸º int</span></span><br><span class="line"><span class="keyword">auto</span> j = <span class="number">6</span>; <span class="comment">// è¢«æ¨å¯¼ä¸º int</span></span><br><span class="line">std::cout &lt;&lt; <span class="built_in">add</span>(i, j) &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong>ï¼š<code>auto</code> è¿˜ä¸èƒ½ç”¨äºæ¨å¯¼æ•°ç»„ç±»å‹ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auto auto_arr2[10] = &#123;arr&#125;; // é”™è¯¯, æ— æ³•æ¨å¯¼æ•°ç»„å…ƒç´ ç±»å‹</span><br><span class="line"></span><br><span class="line">2.6.auto.cpp:30:19: error: &#x27;auto_arr2&#x27; declared as<span class="built_in"> array </span>of &#x27;auto&#x27;</span><br><span class="line"> auto auto_arr2[10] = &#123;arr&#125;;</span><br></pre></td></tr></table></figure></blockquote><h3 id="decltype">decltype</h3><p><code>decltype</code> å…³é”®å­—æ˜¯ä¸ºäº†è§£å†³ <code>auto</code> å…³é”®å­—åªèƒ½å¯¹å˜é‡è¿›è¡Œç±»å‹æ¨å¯¼çš„ç¼ºé™·è€Œå‡ºç°çš„ã€‚å®ƒçš„ç”¨æ³•å’Œ <code>typeof</code> å¾ˆç›¸ä¼¼ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">decltype</span><span class="params">(è¡¨è¾¾å¼)</span></span></span><br></pre></td></tr></table></figure><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦è®¡ç®—æŸä¸ªè¡¨è¾¾å¼çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> x = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">auto</span> y = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">decltype</span>(x+y) z;</span><br></pre></td></tr></table></figure><p>ä½ å·²ç»åœ¨å‰é¢çš„ä¾‹å­ä¸­çœ‹åˆ° <code>decltype</code> ç”¨äºæ¨æ–­ç±»å‹çš„ç”¨æ³•ï¼Œä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜¯åˆ¤æ–­ä¸Šé¢çš„å˜é‡ <code>x, y, z</code> æ˜¯å¦æ˜¯åŒä¸€ç±»å‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (std::<span class="variable constant_">is_same</span>&lt;<span class="title function_ invoke__">decltype</span>(x), <span class="keyword">int</span>&gt;::<span class="variable constant_">value</span>)</span><br><span class="line">    std::<span class="variable constant_">cout</span> &lt;&lt; <span class="string">&quot;type x == int&quot;</span> &lt;&lt; std::<span class="variable constant_">endl</span>;</span><br><span class="line"><span class="keyword">if</span> (std::<span class="variable constant_">is_same</span>&lt;<span class="title function_ invoke__">decltype</span>(x), <span class="keyword">float</span>&gt;::<span class="variable constant_">value</span>)</span><br><span class="line">    std::<span class="variable constant_">cout</span> &lt;&lt; <span class="string">&quot;type x == float&quot;</span> &lt;&lt; std::<span class="variable constant_">endl</span>;</span><br><span class="line"><span class="keyword">if</span> (std::<span class="variable constant_">is_same</span>&lt;<span class="title function_ invoke__">decltype</span>(x), <span class="title function_ invoke__">decltype</span>(z)&gt;::<span class="variable constant_">value</span>)</span><br><span class="line">    std::<span class="variable constant_">cout</span> &lt;&lt; <span class="string">&quot;type z == type x&quot;</span> &lt;&lt; std::<span class="variable constant_">endl</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>std::is_same&lt;T, U&gt;</code> ç”¨äºåˆ¤æ–­ <code>T</code> å’Œ <code>U</code> è¿™ä¸¤ä¸ªç±»å‹æ˜¯å¦ç›¸ç­‰ã€‚è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">x </span>== int</span><br><span class="line"><span class="keyword">type</span> <span class="type">z </span>== <span class="keyword">type</span> <span class="type">x</span></span><br></pre></td></tr></table></figure><h3 id="å°¾è¿”å›ç±»å‹æ¨å¯¼">å°¾è¿”å›ç±»å‹æ¨å¯¼</h3><p>ä½ å¯èƒ½ä¼šæ€è€ƒï¼Œåœ¨ä»‹ç» <code>auto</code> æ—¶ï¼Œæˆ‘ä»¬å·²ç»æè¿‡ <code>auto</code> ä¸èƒ½ç”¨äºå‡½æ•°å½¢å‚è¿›è¡Œç±»å‹æ¨å¯¼ï¼Œé‚£ä¹ˆ <code>auto</code> èƒ½ä¸èƒ½ç”¨äºæ¨å¯¼å‡½æ•°çš„è¿”å›ç±»å‹å‘¢ï¼Ÿè¿˜æ˜¯è€ƒè™‘ä¸€ä¸ªåŠ æ³•å‡½æ•°çš„ä¾‹å­ï¼Œåœ¨ä¼ ç»Ÿ C++ ä¸­æˆ‘ä»¬å¿…é¡»è¿™ä¹ˆå†™ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;</span></span><br><span class="line"><span class="function">R <span class="title">add</span><span class="params">(T x, U y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x+y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼štypename å’Œ class åœ¨æ¨¡æ¿å‚æ•°åˆ—è¡¨ä¸­æ²¡æœ‰åŒºåˆ«ï¼Œåœ¨ typename è¿™ä¸ªå…³é”®å­—å‡ºç°ä¹‹å‰ï¼Œéƒ½æ˜¯ä½¿ç”¨ class æ¥å®šä¹‰æ¨¡æ¿å‚æ•°çš„ã€‚ä½†åœ¨æ¨¡æ¿ä¸­å®šä¹‰æœ‰<a href="https://en.cppreference.com/w/cpp/language/dependent_name#The_typename_disambiguator_for_dependent_names">åµŒå¥—ä¾èµ–ç±»å‹</a>çš„å˜é‡æ—¶ï¼Œéœ€è¦ç”¨ typename æ¶ˆé™¤æ­§ä¹‰</p></blockquote><p>è¿™æ ·çš„ä»£ç å…¶å®å˜å¾—å¾ˆä¸‘é™‹ï¼Œå› ä¸ºç¨‹åºå‘˜åœ¨ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿å‡½æ•°çš„æ—¶å€™ï¼Œå¿…é¡»æ˜ç¡®æŒ‡å‡ºè¿”å›ç±»å‹ã€‚ä½†äº‹å®ä¸Šæˆ‘ä»¬å¹¶ä¸çŸ¥é“ <code>add()</code> è¿™ä¸ªå‡½æ•°ä¼šåšä»€ä¹ˆæ ·çš„æ“ä½œï¼Œä»¥åŠè·å¾—ä¸€ä¸ªä»€ä¹ˆæ ·çš„è¿”å›ç±»å‹ã€‚</p><p>åœ¨ C++11 ä¸­è¿™ä¸ªé—®é¢˜å¾—åˆ°è§£å†³ã€‚è™½ç„¶ä½ å¯èƒ½é©¬ä¸Šä¼šååº”å‡ºæ¥ä½¿ç”¨ <code>decltype</code> æ¨å¯¼ <code>x+y</code> çš„ç±»å‹ï¼Œå†™å‡ºè¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">decltype</span>(x+y) <span class="built_in">add</span>(T x, U y)</span><br></pre></td></tr></table></figure><p>ä½†äº‹å®ä¸Šè¿™æ ·çš„å†™æ³•å¹¶ä¸èƒ½é€šè¿‡ç¼–è¯‘ã€‚è¿™æ˜¯å› ä¸ºåœ¨ç¼–è¯‘å™¨è¯»åˆ° decltype(x+y) æ—¶ï¼Œ<code>x</code> å’Œ <code>y</code> å°šæœªè¢«å®šä¹‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC++11 è¿˜å¼•å…¥äº†ä¸€ä¸ªå«åšå°¾è¿”å›ç±»å‹ï¼ˆtrailing return typeï¼‰ï¼Œåˆ©ç”¨ <code>auto</code> å…³é”®å­—å°†è¿”å›ç±»å‹åç½®ï¼š</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">template</span>&lt;typename <span class="type">T</span>, typename <span class="type">U</span>&gt;</span><br><span class="line"><span class="title">auto</span> add2(<span class="type">T</span> x, <span class="type">U</span> y) -&gt; decl<span class="keyword">type</span>(x+y)&#123;</span><br><span class="line">    return x + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¤äººæ¬£æ…°çš„æ˜¯ä» C++14 å¼€å§‹æ˜¯å¯ä»¥ç›´æ¥è®©æ™®é€šå‡½æ•°å…·å¤‡è¿”å›å€¼æ¨å¯¼ï¼Œå› æ­¤ä¸‹é¢çš„å†™æ³•å˜å¾—åˆæ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">add3</span><span class="params">(T x, U y)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ£€æŸ¥ä¸€ä¸‹ç±»å‹æ¨å¯¼æ˜¯å¦æ­£ç¡®ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// after c++11</span></span><br><span class="line"><span class="keyword">auto</span> w = <span class="built_in">add2</span>&lt;<span class="type">int</span>, <span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">2.0</span>);</span><br><span class="line"><span class="keyword">if</span> (std::is_same&lt;<span class="keyword">decltype</span>(w), <span class="type">double</span>&gt;::value) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;w is double: &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">std::cout &lt;&lt; w &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// after c++14</span></span><br><span class="line"><span class="keyword">auto</span> q = <span class="built_in">add3</span>&lt;<span class="type">double</span>, <span class="type">int</span>&gt;(<span class="number">1.0</span>, <span class="number">2</span>);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;q: &quot;</span> &lt;&lt; q &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure><h3 id="decltype-auto">decltype(auto)</h3><p><code>decltype(auto)</code> æ˜¯ C++14 å¼€å§‹æä¾›çš„ä¸€ä¸ªç•¥å¾®å¤æ‚çš„ç”¨æ³•ã€‚</p><blockquote><p>è¦ç†è§£å®ƒä½ éœ€è¦çŸ¥é“ C++ ä¸­å‚æ•°è½¬å‘çš„æ¦‚å¿µï¼Œæˆ‘ä»¬ä¼šåœ¨<a href="https://changkun.de/modern-cpp/zh-cn/03-runtime/index.html">è¯­è¨€è¿è¡Œæ—¶å¼ºåŒ–</a>ä¸€ç« ä¸­è¯¦ç»†ä»‹ç»ï¼Œä½ å¯ä»¥åˆ°æ—¶å†å›æ¥çœ‹è¿™ä¸€å°èŠ‚çš„å†…å®¹ã€‚</p></blockquote><p>ç®€å•æ¥è¯´ï¼Œ<code>decltype(auto)</code> ä¸»è¦ç”¨äºå¯¹è½¬å‘å‡½æ•°æˆ–å°è£…çš„è¿”å›ç±»å‹è¿›è¡Œæ¨å¯¼ï¼Œå®ƒä½¿æˆ‘ä»¬æ— éœ€æ˜¾å¼çš„æŒ‡å®š <code>decltype</code> çš„å‚æ•°è¡¨è¾¾å¼ã€‚è€ƒè™‘çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå½“æˆ‘ä»¬éœ€è¦å¯¹ä¸‹é¢ä¸¤ä¸ªå‡½æ•°è¿›è¡Œå°è£…æ—¶ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::string  <span class="built_in">lookup1</span>();</span><br><span class="line">std::string&amp; <span class="built_in">lookup2</span>();</span><br></pre></td></tr></table></figure><p>åœ¨ C++11 ä¸­ï¼Œå°è£…å®ç°æ˜¯å¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">std</span>::<span class="built_in">string</span> <span class="title function_">look_up_a_string_1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">lookup1</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">std</span>::<span class="built_in">string</span>&amp; <span class="title function_">look_up_a_string_2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">lookup2</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œæœ‰äº† <code>decltype(auto)</code>ï¼Œæˆ‘ä»¬å¯ä»¥è®©ç¼–è¯‘å™¨å®Œæˆè¿™ä¸€ä»¶çƒ¦äººçš„å‚æ•°è½¬å‘ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">decltype</span>(auto) <span class="built_in">look_up_a_string_1</span>() &#123;</span><br><span class="line">    return <span class="built_in">lookup1</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">decltype</span>(auto) <span class="built_in">look_up_a_string_2</span>() &#123;</span><br><span class="line">    return <span class="built_in">lookup2</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-4-æ§åˆ¶æµ">2.4 æ§åˆ¶æµ</h2><h3 id="if-constexpr">if constexpr</h3><p>æ­£å¦‚æœ¬ç« å¼€å¤´å‡ºï¼Œæˆ‘ä»¬çŸ¥é“äº† C++11 å¼•å…¥äº† <code>constexpr</code> å…³é”®å­—ï¼Œå®ƒå°†è¡¨è¾¾å¼æˆ–å‡½æ•°ç¼–è¯‘ä¸ºå¸¸é‡ç»“æœã€‚ä¸€ä¸ªå¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸€ç‰¹æ€§å¼•å…¥åˆ°æ¡ä»¶åˆ¤æ–­ä¸­å»ï¼Œè®©ä»£ç åœ¨ç¼–è¯‘æ—¶å°±å®Œæˆåˆ†æ”¯åˆ¤æ–­ï¼Œå²‚ä¸æ˜¯èƒ½è®©ç¨‹åºæ•ˆç‡æ›´é«˜ï¼ŸC++17 å°† <code>constexpr</code> è¿™ä¸ªå…³é”®å­—å¼•å…¥åˆ° <code>if</code> è¯­å¥ä¸­ï¼Œå…è®¸åœ¨ä»£ç ä¸­å£°æ˜å¸¸é‡è¡¨è¾¾å¼çš„åˆ¤æ–­æ¡ä»¶ï¼Œè€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">print_type_info</span><span class="params">(<span class="type">const</span> T&amp; t)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(std::is_integral&lt;T&gt;::value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t + <span class="number">0.001</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">print_type_info</span>(<span class="number">5</span>) &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">print_type_info</span>(<span class="number">3.14</span>) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç¼–è¯‘æ—¶ï¼Œå®é™…ä»£ç å°±ä¼šè¡¨ç°ä¸ºå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">print_type_info</span><span class="params">(<span class="type">const</span> <span class="type">int</span>&amp; t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> t + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">print_type_info</span><span class="params">(<span class="type">const</span> <span class="type">double</span>&amp; t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> t + <span class="number">0.001</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">print_type_info</span>(<span class="number">5</span>) &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">print_type_info</span>(<span class="number">3.14</span>) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŒºé—´-for-è¿­ä»£">åŒºé—´ for è¿­ä»£</h3><p>ç»ˆäºï¼ŒC++11 å¼•å…¥äº†åŸºäºèŒƒå›´çš„è¿­ä»£å†™æ³•ï¼Œæˆ‘ä»¬æ‹¥æœ‰äº†èƒ½å¤Ÿå†™å‡ºåƒ Python ä¸€æ ·ç®€æ´çš„å¾ªç¯è¯­å¥ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–å‰é¢çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; vec = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> itr = std::<span class="built_in">find</span>(vec.<span class="built_in">begin</span>(), vec.<span class="built_in">end</span>(), <span class="number">3</span>); itr != vec.<span class="built_in">end</span>()) *itr = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> element : vec)</span><br><span class="line">        std::cout &lt;&lt; element &lt;&lt; std::endl; <span class="comment">// read only</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;element : vec) &#123;</span><br><span class="line">        element += <span class="number">1</span>;                      <span class="comment">// writeable</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> element : vec)</span><br><span class="line">        std::cout &lt;&lt; element &lt;&lt; std::endl; <span class="comment">// read only</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-5-æ¨¡æ¿">2.5 æ¨¡æ¿</h2><p>C++ çš„æ¨¡æ¿ä¸€ç›´æ˜¯è¿™é—¨è¯­è¨€çš„ä¸€ç§ç‰¹æ®Šçš„è‰ºæœ¯ï¼Œæ¨¡æ¿ç”šè‡³å¯ä»¥ç‹¬ç«‹ä½œä¸ºä¸€é—¨æ–°çš„è¯­è¨€æ¥è¿›è¡Œä½¿ç”¨ã€‚æ¨¡æ¿çš„å“²å­¦åœ¨äºå°†ä¸€åˆ‡èƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸå¤„ç†çš„é—®é¢˜ä¸¢åˆ°ç¼–è¯‘æœŸè¿›è¡Œå¤„ç†ï¼Œä»…åœ¨è¿è¡Œæ—¶å¤„ç†é‚£äº›æœ€æ ¸å¿ƒçš„åŠ¨æ€æœåŠ¡ï¼Œè¿›è€Œå¤§å¹…ä¼˜åŒ–è¿è¡ŒæœŸçš„æ€§èƒ½ã€‚å› æ­¤æ¨¡æ¿ä¹Ÿè¢«å¾ˆå¤šäººè§†ä½œ C++ çš„é»‘é­”æ³•ä¹‹ä¸€ã€‚</p><h3 id="å¤–éƒ¨æ¨¡æ¿">å¤–éƒ¨æ¨¡æ¿</h3><p>ä¼ ç»Ÿ C++ ä¸­ï¼Œæ¨¡æ¿åªæœ‰åœ¨ä½¿ç”¨æ—¶æ‰ä¼šè¢«ç¼–è¯‘å™¨å®ä¾‹åŒ–ã€‚æ¢å¥è¯è¯´ï¼Œåªè¦åœ¨æ¯ä¸ªç¼–è¯‘å•å…ƒï¼ˆæ–‡ä»¶ï¼‰ä¸­ç¼–è¯‘çš„ä»£ç ä¸­é‡åˆ°äº†è¢«å®Œæ•´å®šä¹‰çš„æ¨¡æ¿ï¼Œéƒ½ä¼šå®ä¾‹åŒ–ã€‚è¿™å°±äº§ç”Ÿäº†é‡å¤å®ä¾‹åŒ–è€Œå¯¼è‡´çš„ç¼–è¯‘æ—¶é—´çš„å¢åŠ ã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•é€šçŸ¥ç¼–è¯‘å™¨ä¸è¦è§¦å‘æ¨¡æ¿çš„å®ä¾‹åŒ–ã€‚</p><p>ä¸ºæ­¤ï¼ŒC++11 å¼•å…¥äº†å¤–éƒ¨æ¨¡æ¿ï¼Œæ‰©å……äº†åŸæ¥çš„å¼ºåˆ¶ç¼–è¯‘å™¨åœ¨ç‰¹å®šä½ç½®å®ä¾‹åŒ–æ¨¡æ¿çš„è¯­æ³•ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ˜¾å¼çš„é€šçŸ¥ç¼–è¯‘å™¨ä½•æ—¶è¿›è¡Œæ¨¡æ¿çš„å®ä¾‹åŒ–ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> <span class="keyword">class</span> <span class="title class_">std</span>::vector&lt;<span class="type">bool</span>&gt;;          <span class="comment">// å¼ºè¡Œå®ä¾‹åŒ–</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="keyword">class</span> <span class="title class_">std</span>::vector&lt;<span class="type">double</span>&gt;; <span class="comment">// ä¸åœ¨è¯¥å½“å‰ç¼–è¯‘æ–‡ä»¶ä¸­å®ä¾‹åŒ–æ¨¡æ¿</span></span><br></pre></td></tr></table></figure><h3 id="å°–æ‹¬å·-â€œ-â€">å°–æ‹¬å· â€œ&gt;â€</h3><p>åœ¨ä¼ ç»Ÿ C++ çš„ç¼–è¯‘å™¨ä¸­ï¼Œ<code>&gt;&gt;</code>ä¸€å¾‹è¢«å½“åšå³ç§»è¿ç®—ç¬¦æ¥è¿›è¡Œå¤„ç†ã€‚ä½†å®é™…ä¸Šæˆ‘ä»¬å¾ˆå®¹æ˜“å°±å†™å‡ºäº†åµŒå¥—æ¨¡æ¿çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;std::vector&lt;<span class="type">int</span>&gt;&gt; matrix;</span><br></pre></td></tr></table></figure><p>è¿™åœ¨ä¼ ç»Ÿ C++ ç¼–è¯‘å™¨ä¸‹æ˜¯ä¸èƒ½å¤Ÿè¢«ç¼–è¯‘çš„ï¼Œè€Œ C++11 å¼€å§‹ï¼Œè¿ç»­çš„å³å°–æ‹¬å·å°†å˜å¾—åˆæ³•ï¼Œå¹¶ä¸”èƒ½å¤Ÿé¡ºåˆ©é€šè¿‡ç¼–è¯‘ã€‚ç”šè‡³äºåƒä¸‹é¢è¿™ç§å†™æ³•éƒ½èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="type">bool</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MagicType</span> &#123;</span><br><span class="line">    <span class="type">bool</span> magic = T;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// in main function:</span></span><br><span class="line">std::vector&lt;MagicType&lt;(1&gt;<span class="number">2</span>)&gt;&gt; magic; <span class="comment">// åˆæ³•, ä½†ä¸å»ºè®®å†™å‡ºè¿™æ ·çš„ä»£ç </span></span><br></pre></td></tr></table></figure><h3 id="ç±»å‹åˆ«åæ¨¡æ¿">ç±»å‹åˆ«åæ¨¡æ¿</h3><p>åœ¨äº†è§£ç±»å‹åˆ«åæ¨¡æ¿ä¹‹å‰ï¼Œéœ€è¦ç†è§£ã€æ¨¡æ¿ã€å’Œã€ç±»å‹ã€ä¹‹é—´çš„ä¸åŒã€‚ä»”ç»†ä½“ä¼šè¿™å¥è¯ï¼š**æ¨¡æ¿æ˜¯ç”¨æ¥äº§ç”Ÿç±»å‹çš„ã€‚**åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œ<code>typedef</code> å¯ä»¥ä¸ºç±»å‹å®šä¹‰ä¸€ä¸ªæ–°çš„åç§°ï¼Œä½†æ˜¯å´æ²¡æœ‰åŠæ³•ä¸ºæ¨¡æ¿å®šä¹‰ä¸€ä¸ªæ–°çš„åç§°ã€‚å› ä¸ºï¼Œæ¨¡æ¿ä¸æ˜¯ç±»å‹ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MagicType</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    T dark;</span><br><span class="line">    U magic;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸åˆæ³•</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typedef</span> MagicType&lt;std::vector&lt;T&gt;, std::string&gt; FakeDarkMagic;</span><br></pre></td></tr></table></figure><p>C++11 ä½¿ç”¨ <code>using</code> å¼•å…¥äº†ä¸‹é¢è¿™ç§å½¢å¼çš„å†™æ³•ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒå¯¹ä¼ ç»Ÿ <code>typedef</code> ç›¸åŒçš„åŠŸæ•ˆï¼š</p><blockquote><p>é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ <code>typedef</code> å®šä¹‰åˆ«åçš„è¯­æ³•æ˜¯ï¼š<code>typedef åŸåç§° æ–°åç§°;</code>ï¼Œä½†æ˜¯å¯¹å‡½æ•°æŒ‡é’ˆç­‰åˆ«åçš„å®šä¹‰è¯­æ³•å´ä¸ç›¸åŒï¼Œè¿™é€šå¸¸ç»™ç›´æ¥é˜…è¯»é€ æˆäº†ä¸€å®šç¨‹åº¦çš„å›°éš¾ã€‚</p></blockquote><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef int <span class="comment">(*process)(void *)</span><span class="punctuation">;</span></span><br><span class="line"><span class="keyword">using</span> NewProcess = int<span class="comment">(*)(void *)</span><span class="punctuation">;</span></span><br><span class="line">template&lt;typename T&gt;</span><br><span class="line"><span class="keyword">using</span> TrueDarkMagic = MagicType&lt;std::vector&lt;T&gt;, std::string&gt;<span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">int main() <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    TrueDarkMagic&lt;bool&gt; you;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="å˜é•¿å‚æ•°æ¨¡æ¿">å˜é•¿å‚æ•°æ¨¡æ¿</h3><p>æ¨¡æ¿ä¸€ç›´æ˜¯ C++ æ‰€ç‹¬æœ‰çš„<strong>é»‘é­”æ³•</strong>ï¼ˆä¸€èµ·å¿µï¼š<strong>Dark Magic</strong>ï¼‰ä¹‹ä¸€ã€‚ åœ¨ C++11 ä¹‹å‰ï¼Œæ— è®ºæ˜¯ç±»æ¨¡æ¿è¿˜æ˜¯å‡½æ•°æ¨¡æ¿ï¼Œéƒ½åªèƒ½æŒ‰å…¶æŒ‡å®šçš„æ ·å­ï¼Œ æ¥å—ä¸€ç»„å›ºå®šæ•°é‡çš„æ¨¡æ¿å‚æ•°ï¼›è€Œ C++11 åŠ å…¥äº†æ–°çš„è¡¨ç¤ºæ–¹æ³•ï¼Œ å…è®¸ä»»æ„ä¸ªæ•°ã€ä»»æ„ç±»åˆ«çš„æ¨¡æ¿å‚æ•°ï¼ŒåŒæ—¶ä¹Ÿä¸éœ€è¦åœ¨å®šä¹‰æ—¶å°†å‚æ•°çš„ä¸ªæ•°å›ºå®šã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Ts&gt; <span class="keyword">class</span> <span class="title class_">Magic</span>;</span><br></pre></td></tr></table></figure><p>æ¨¡æ¿ç±» Magic çš„å¯¹è±¡ï¼Œèƒ½å¤Ÿæ¥å—ä¸å—é™åˆ¶ä¸ªæ•°çš„ typename ä½œä¸ºæ¨¡æ¿çš„å½¢å¼å‚æ•°ï¼Œä¾‹å¦‚ä¸‹é¢çš„å®šä¹‰ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Magic</span>&lt;<span class="type">int</span>,</span><br><span class="line">            std::vector&lt;<span class="type">int</span>&gt;,</span><br><span class="line">            std::map&lt;std::string,</span><br><span class="line">            std::vector&lt;<span class="type">int</span>&gt;&gt;&gt; darkMagic;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶æ˜¯ä»»æ„å½¢å¼ï¼Œæ‰€ä»¥ä¸ªæ•°ä¸º <code>0</code> çš„æ¨¡æ¿å‚æ•°ä¹Ÿæ˜¯å¯ä»¥çš„ï¼š<code>class Magic&lt;&gt; nothing;</code>ã€‚</p><p>å¦‚æœä¸å¸Œæœ›äº§ç”Ÿçš„æ¨¡æ¿å‚æ•°ä¸ªæ•°ä¸º <code>0</code>ï¼Œå¯ä»¥æ‰‹åŠ¨çš„å®šä¹‰è‡³å°‘ä¸€ä¸ªæ¨¡æ¿å‚æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Require, <span class="keyword">typename</span>... Args&gt; <span class="keyword">class</span> <span class="title class_">Magic</span>;</span><br></pre></td></tr></table></figure><p>å˜é•¿å‚æ•°æ¨¡æ¿ä¹Ÿèƒ½è¢«ç›´æ¥è°ƒæ•´åˆ°åˆ°æ¨¡æ¿å‡½æ•°ä¸Šã€‚ä¼ ç»Ÿ C ä¸­çš„ <code>printf</code> å‡½æ•°ï¼Œ è™½ç„¶ä¹Ÿèƒ½è¾¾æˆä¸å®šä¸ªæ•°çš„å½¢å‚çš„è°ƒç”¨ï¼Œä½†å…¶å¹¶éç±»åˆ«å®‰å…¨ã€‚ è€Œ C++11 é™¤äº†èƒ½å®šä¹‰ç±»åˆ«å®‰å…¨çš„å˜é•¿å‚æ•°å‡½æ•°å¤–ï¼Œ è¿˜å¯ä»¥ä½¿ç±»ä¼¼ <code>printf</code> çš„å‡½æ•°èƒ½è‡ªç„¶åœ°å¤„ç†éè‡ªå¸¦ç±»åˆ«çš„å¯¹è±¡ã€‚ é™¤äº†åœ¨æ¨¡æ¿å‚æ•°ä¸­èƒ½ä½¿ç”¨ <code>...</code> è¡¨ç¤ºä¸å®šé•¿æ¨¡æ¿å‚æ•°å¤–ï¼Œ å‡½æ•°å‚æ•°ä¹Ÿä½¿ç”¨åŒæ ·çš„è¡¨ç¤ºæ³•ä»£è¡¨ä¸å®šé•¿å‚æ•°ï¼Œ è¿™ä¹Ÿå°±ä¸ºæˆ‘ä»¬ç®€å•ç¼–å†™å˜é•¿å‚æ•°å‡½æ•°æä¾›äº†ä¾¿æ·çš„æ‰‹æ®µï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Args&gt; <span class="type">void</span> <span class="title">printf</span><span class="params">(<span class="type">const</span> std::string &amp;str, Args... args)</span></span>;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å®šä¹‰äº†å˜é•¿çš„æ¨¡æ¿å‚æ•°ï¼Œå¦‚ä½•å¯¹å‚æ•°è¿›è¡Œè§£åŒ…å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>sizeof...</code> æ¥è®¡ç®—å‚æ•°çš„ä¸ªæ•°ï¼Œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">magic</span><span class="params">(Ts... args)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="keyword">sizeof</span>...(args) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä¼ é€’ä»»æ„ä¸ªå‚æ•°ç»™ <code>magic</code> å‡½æ•°ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">magic</span>(); <span class="comment">// è¾“å‡º0</span></span><br><span class="line"><span class="built_in">magic</span>(<span class="number">1</span>); <span class="comment">// è¾“å‡º1</span></span><br><span class="line"><span class="built_in">magic</span>(<span class="number">1</span>, &quot;&quot;); <span class="comment">// è¾“å‡º2</span></span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œå¯¹å‚æ•°è¿›è¡Œè§£åŒ…ï¼Œåˆ°ç›®å‰ä¸ºæ­¢è¿˜æ²¡æœ‰ä¸€ç§ç®€å•çš„æ–¹æ³•èƒ½å¤Ÿå¤„ç†å‚æ•°åŒ…ï¼Œä½†æœ‰ä¸¤ç§ç»å…¸çš„å¤„ç†æ‰‹æ³•ï¼š</p><p><strong>1. é€’å½’æ¨¡æ¿å‡½æ•°</strong></p><p>é€’å½’æ˜¯éå¸¸å®¹æ˜“æƒ³åˆ°çš„ä¸€ç§æ‰‹æ®µï¼Œä¹Ÿæ˜¯æœ€ç»å…¸çš„å¤„ç†æ–¹æ³•ã€‚è¿™ç§æ–¹æ³•ä¸æ–­é€’å½’åœ°å‘å‡½æ•°ä¼ é€’æ¨¡æ¿å‚æ•°ï¼Œè¿›è€Œè¾¾åˆ°é€’å½’éå†æ‰€æœ‰æ¨¡æ¿å‚æ•°çš„ç›®çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T0&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printf1</span><span class="params">(T0 value)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; value &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printf1</span><span class="params">(T value, Ts... args)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; value &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">printf1</span>(args...);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf1</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="string">&quot;123&quot;</span>, <span class="number">1.1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. å˜å‚æ¨¡æ¿å±•å¼€</strong></p><p>ä½ åº”è¯¥æ„Ÿå—åˆ°äº†è¿™å¾ˆç¹çï¼Œåœ¨ C++17 ä¸­å¢åŠ äº†å˜å‚æ¨¡æ¿å±•å¼€çš„æ”¯æŒï¼Œäºæ˜¯ä½ å¯ä»¥åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å®Œæˆ <code>printf</code> çš„ç¼–å†™ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T0, <span class="keyword">typename</span>... T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printf2</span><span class="params">(T0 t0, T... t)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; t0 &lt;&lt; std::endl;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(<span class="keyword">sizeof</span>...(t) &gt; <span class="number">0</span>)</span> <span class="title">printf2</span><span class="params">(t...)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>äº‹å®ä¸Šï¼Œæœ‰æ—¶å€™æˆ‘ä»¬è™½ç„¶ä½¿ç”¨äº†å˜å‚æ¨¡æ¿ï¼Œå´ä¸ä¸€å®šéœ€è¦å¯¹å‚æ•°åšé€ä¸ªéå†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>std::bind</code> åŠå®Œç¾è½¬å‘ç­‰ç‰¹æ€§å®ç°å¯¹å‡½æ•°å’Œå‚æ•°çš„ç»‘å®šï¼Œä»è€Œè¾¾åˆ°æˆåŠŸè°ƒç”¨çš„ç›®çš„ã€‚</p></blockquote><p><strong>3. åˆå§‹åŒ–åˆ—è¡¨å±•å¼€</strong></p><p>é€’å½’æ¨¡æ¿å‡½æ•°æ˜¯ä¸€ç§æ ‡å‡†çš„åšæ³•ï¼Œä½†ç¼ºç‚¹æ˜¾è€Œæ˜“è§çš„åœ¨äºå¿…é¡»å®šä¹‰ä¸€ä¸ªç»ˆæ­¢é€’å½’çš„å‡½æ•°ã€‚</p><p>è¿™é‡Œä»‹ç»ä¸€ç§ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨å±•å¼€çš„é»‘é­”æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span>... Ts&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">printf3</span><span class="params">(T value, Ts... args)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; value &lt;&lt; std::endl;</span><br><span class="line">    (<span class="type">void</span>) std::initializer_list&lt;T&gt;&#123;([&amp;args] &#123;</span><br><span class="line">        std::cout &lt;&lt; args &lt;&lt; std::endl;</span><br><span class="line">    &#125;(), value)...&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä»£ç ä¸­ï¼Œé¢å¤–ä½¿ç”¨äº† C++11 ä¸­æä¾›çš„åˆå§‹åŒ–åˆ—è¡¨ä»¥åŠ Lambda è¡¨è¾¾å¼çš„ç‰¹æ€§ï¼ˆä¸‹ä¸€èŠ‚ä¸­å°†æåˆ°ï¼‰ã€‚</p><p>é€šè¿‡åˆå§‹åŒ–åˆ—è¡¨ï¼Œ<code>(lambda è¡¨è¾¾å¼, value)...</code> å°†ä¼šè¢«å±•å¼€ã€‚ç”±äºé€—å·è¡¨è¾¾å¼çš„å‡ºç°ï¼Œé¦–å…ˆä¼šæ‰§è¡Œå‰é¢çš„ lambda è¡¨è¾¾å¼ï¼Œå®Œæˆå‚æ•°çš„è¾“å‡ºã€‚ ä¸ºäº†é¿å…ç¼–è¯‘å™¨è­¦å‘Šï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>std::initializer_list</code> æ˜¾å¼çš„è½¬ä¸º <code>void</code>ã€‚</p><h3 id="æŠ˜å è¡¨è¾¾å¼">æŠ˜å è¡¨è¾¾å¼</h3><p>C++ 17 ä¸­å°†å˜é•¿å‚æ•°è¿™ç§ç‰¹æ€§è¿›ä¸€æ­¥å¸¦ç»™äº†è¡¨è¾¾å¼ï¼Œè€ƒè™‘ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ... T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">sum</span><span class="params">(T ... t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (t + ...);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">sum</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="éç±»å‹æ¨¡æ¿å‚æ•°æ¨å¯¼">éç±»å‹æ¨¡æ¿å‚æ•°æ¨å¯¼</h3><p>å‰é¢æˆ‘ä»¬ä¸»è¦æåŠçš„æ˜¯æ¨¡æ¿å‚æ•°çš„ä¸€ç§å½¢å¼ï¼šç±»å‹æ¨¡æ¿å‚æ•°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">add</span><span class="params">(T t, U u)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> t+u;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ¨¡æ¿çš„å‚æ•° <code>T</code> å’Œ <code>U</code> ä¸ºå…·ä½“çš„ç±»å‹ã€‚ ä½†è¿˜æœ‰ä¸€ç§å¸¸è§æ¨¡æ¿å‚æ•°å½¢å¼å¯ä»¥è®©ä¸åŒå­—é¢é‡æˆä¸ºæ¨¡æ¿å‚æ•°ï¼Œå³éç±»å‹æ¨¡æ¿å‚æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="type">int</span> BufSize&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">buffer_t</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">T&amp; <span class="title">alloc</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">(T&amp; item)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T data[BufSize];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">buffer_t</span>&lt;<span class="type">int</span>, <span class="number">100</span>&gt; buf; <span class="comment">// 100 ä½œä¸ºæ¨¡æ¿å‚æ•°</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ç§æ¨¡æ¿å‚æ•°å½¢å¼ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>100</code> ä½œä¸ºæ¨¡æ¿çš„å‚æ•°è¿›è¡Œä¼ é€’ã€‚ åœ¨ C++11 å¼•å…¥äº†ç±»å‹æ¨å¯¼è¿™ä¸€ç‰¹æ€§åï¼Œæˆ‘ä»¬ä¼šå¾ˆè‡ªç„¶çš„é—®ï¼Œæ—¢ç„¶æ­¤å¤„çš„æ¨¡æ¿å‚æ•° ä»¥å…·ä½“çš„å­—é¢é‡è¿›è¡Œä¼ é€’ï¼Œèƒ½å¦è®©ç¼–è¯‘å™¨è¾…åŠ©æˆ‘ä»¬è¿›è¡Œç±»å‹æ¨å¯¼ï¼Œ é€šè¿‡ä½¿ç”¨å ä½ç¬¦ <code>auto</code> ä»è€Œä¸å†éœ€è¦æ˜ç¡®æŒ‡æ˜ç±»å‹ï¼Ÿ å¹¸è¿çš„æ˜¯ï¼ŒC++17 å¼•å…¥äº†è¿™ä¸€ç‰¹æ€§ï¼Œæˆ‘ä»¬çš„ç¡®å¯ä»¥ <code>auto</code> å…³é”®å­—ï¼Œè®©ç¼–è¯‘å™¨è¾…åŠ©å®Œæˆå…·ä½“ç±»å‹çš„æ¨å¯¼ï¼Œ ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">auto</span> value&gt; <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; value &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">foo</span>&lt;<span class="number">10</span>&gt;();  <span class="comment">// value è¢«æ¨å¯¼ä¸º int ç±»å‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-é¢å‘å¯¹è±¡">2.6 é¢å‘å¯¹è±¡</h2><h3 id="å§”æ‰˜æ„é€ ">å§”æ‰˜æ„é€ </h3><p>C++11 å¼•å…¥äº†å§”æ‰˜æ„é€ çš„æ¦‚å¿µï¼Œè¿™ä½¿å¾—æ„é€ å‡½æ•°å¯ä»¥åœ¨åŒä¸€ä¸ªç±»ä¸­ä¸€ä¸ªæ„é€ å‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œä»è€Œè¾¾åˆ°ç®€åŒ–ä»£ç çš„ç›®çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> value1;</span><br><span class="line">    <span class="type">int</span> value2;</span><br><span class="line">    <span class="built_in">Base</span>() &#123;</span><br><span class="line">        value1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Base</span>(<span class="type">int</span> value) : <span class="built_in">Base</span>() &#123; <span class="comment">// å§”æ‰˜ Base() æ„é€ å‡½æ•°</span></span><br><span class="line">        value2 = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">Base <span class="title">b</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line">    std::cout &lt;&lt; b.value1 &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; b.value2 &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»§æ‰¿æ„é€ ">ç»§æ‰¿æ„é€ </h3><p>åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œæ„é€ å‡½æ•°å¦‚æœéœ€è¦ç»§æ‰¿æ˜¯éœ€è¦å°†å‚æ•°ä¸€ä¸€ä¼ é€’çš„ï¼Œè¿™å°†å¯¼è‡´æ•ˆç‡ä½ä¸‹ã€‚C++11 åˆ©ç”¨å…³é”®å­— <code>using</code> å¼•å…¥äº†ç»§æ‰¿æ„é€ å‡½æ•°çš„æ¦‚å¿µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> value1;</span><br><span class="line">    <span class="type">int</span> value2;</span><br><span class="line">    <span class="built_in">Base</span>() &#123;</span><br><span class="line">        value1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Base</span>(<span class="type">int</span> value) : <span class="built_in">Base</span>() &#123; <span class="comment">// å§”æ‰˜ Base() æ„é€ å‡½æ•°</span></span><br><span class="line">        value2 = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Subclass</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> Base::Base; <span class="comment">// ç»§æ‰¿æ„é€ </span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">Subclass <span class="title">s</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line">    std::cout &lt;&lt; s.value1 &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; s.value2 &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ˜¾å¼è™šå‡½æ•°é‡è½½">æ˜¾å¼è™šå‡½æ•°é‡è½½</h3><p>åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œç»å¸¸å®¹æ˜“å‘ç”Ÿæ„å¤–é‡è½½è™šå‡½æ•°çš„äº‹æƒ…ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> Base &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span>()</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> SubClass: Base &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span>()</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>SubClass::foo</code> å¯èƒ½å¹¶ä¸æ˜¯ç¨‹åºå‘˜å°è¯•é‡è½½è™šå‡½æ•°ï¼Œåªæ˜¯æ°å¥½åŠ å…¥äº†ä¸€ä¸ªå…·æœ‰ç›¸åŒåå­—çš„å‡½æ•°ã€‚å¦ä¸€ä¸ªå¯èƒ½çš„æƒ…å½¢æ˜¯ï¼Œå½“åŸºç±»çš„è™šå‡½æ•°è¢«åˆ é™¤åï¼Œå­ç±»æ‹¥æœ‰æ—§çš„å‡½æ•°å°±ä¸å†é‡è½½è¯¥è™šæ‹Ÿå‡½æ•°å¹¶æ‘‡èº«ä¸€å˜æˆä¸ºäº†ä¸€ä¸ªæ™®é€šçš„ç±»æ–¹æ³•ï¼Œè¿™å°†é€ æˆç¾éš¾æ€§çš„åæœã€‚</p><p>C++11 å¼•å…¥äº† <code>override</code> å’Œ <code>final</code> è¿™ä¸¤ä¸ªå…³é”®å­—æ¥é˜²æ­¢ä¸Šè¿°æƒ…å½¢çš„å‘ç”Ÿã€‚</p><h4 id="override">override</h4><p>å½“é‡è½½è™šå‡½æ•°æ—¶ï¼Œå¼•å…¥ <code>override</code> å…³é”®å­—å°†æ˜¾å¼çš„å‘ŠçŸ¥ç¼–è¯‘å™¨è¿›è¡Œé‡è½½ï¼Œç¼–è¯‘å™¨å°†æ£€æŸ¥åŸºå‡½æ•°æ˜¯å¦å­˜åœ¨è¿™æ ·çš„å…¶å‡½æ•°ç­¾åä¸€è‡´çš„è™šå‡½æ•°ï¼Œå¦åˆ™å°†æ— æ³•é€šè¿‡ç¼–è¯‘ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Base</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SubClass</span>: Base &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span>)</span> <span class="keyword">override</span></span>; <span class="comment">// åˆæ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">float</span>)</span> <span class="keyword">override</span></span>; <span class="comment">// éæ³•, çˆ¶ç±»æ²¡æœ‰æ­¤è™šå‡½æ•°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="final">final</h4><p><code>final</code> åˆ™æ˜¯ä¸ºäº†é˜²æ­¢ç±»è¢«ç»§ç»­ç»§æ‰¿ä»¥åŠç»ˆæ­¢è™šå‡½æ•°ç»§ç»­é‡è½½å¼•å…¥çš„ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Base</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">final</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SubClass1</span> <span class="keyword">final</span>: Base &#123;</span><br><span class="line">&#125;; <span class="comment">// åˆæ³•</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SubClass2</span> : SubClass1 &#123;</span><br><span class="line">&#125;; <span class="comment">// éæ³•, SubClass1 å·² final</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SubClass3</span>: Base &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span></span>; <span class="comment">// éæ³•, foo å·² final</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ˜¾å¼ç¦ç”¨é»˜è®¤å‡½æ•°">æ˜¾å¼ç¦ç”¨é»˜è®¤å‡½æ•°</h3><p>åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œå¦‚æœç¨‹åºå‘˜æ²¡æœ‰æä¾›ï¼Œç¼–è¯‘å™¨ä¼šé»˜è®¤ä¸ºå¯¹è±¡ç”Ÿæˆé»˜è®¤æ„é€ å‡½æ•°ã€ å¤åˆ¶æ„é€ ã€èµ‹å€¼ç®—ç¬¦ä»¥åŠææ„å‡½æ•°ã€‚ å¦å¤–ï¼ŒC++ ä¹Ÿä¸ºæ‰€æœ‰ç±»å®šä¹‰äº†è¯¸å¦‚ <code>new</code> <code>delete</code> è¿™æ ·çš„è¿ç®—ç¬¦ã€‚ å½“ç¨‹åºå‘˜æœ‰éœ€è¦æ—¶ï¼Œå¯ä»¥é‡è½½è¿™éƒ¨åˆ†å‡½æ•°ã€‚</p><p>è¿™å°±å¼•å‘äº†ä¸€äº›éœ€æ±‚ï¼šæ— æ³•ç²¾ç¡®æ§åˆ¶é»˜è®¤å‡½æ•°çš„ç”Ÿæˆè¡Œä¸ºã€‚ ä¾‹å¦‚ç¦æ­¢ç±»çš„æ‹·è´æ—¶ï¼Œå¿…é¡»å°†å¤åˆ¶æ„é€ å‡½æ•°ä¸èµ‹å€¼ç®—ç¬¦å£°æ˜ä¸º <code>private</code>ã€‚ å°è¯•ä½¿ç”¨è¿™äº›æœªå®šä¹‰çš„å‡½æ•°å°†å¯¼è‡´ç¼–è¯‘æˆ–é“¾æ¥é”™è¯¯ï¼Œåˆ™æ˜¯ä¸€ç§éå¸¸ä¸ä¼˜é›…çš„æ–¹å¼ã€‚</p><p>å¹¶ä¸”ï¼Œç¼–è¯‘å™¨äº§ç”Ÿçš„é»˜è®¤æ„é€ å‡½æ•°ä¸ç”¨æˆ·å®šä¹‰çš„æ„é€ å‡½æ•°æ— æ³•åŒæ—¶å­˜åœ¨ã€‚ è‹¥ç”¨æˆ·å®šä¹‰äº†ä»»ä½•æ„é€ å‡½æ•°ï¼Œç¼–è¯‘å™¨å°†ä¸å†ç”Ÿæˆé»˜è®¤æ„é€ å‡½æ•°ï¼Œ ä½†æœ‰æ—¶å€™æˆ‘ä»¬å´å¸Œæœ›åŒæ—¶æ‹¥æœ‰è¿™ä¸¤ç§æ„é€ å‡½æ•°ï¼Œè¿™å°±é€ æˆäº†å°´å°¬ã€‚</p><p>C++11 æä¾›äº†ä¸Šè¿°éœ€æ±‚çš„è§£å†³æ–¹æ¡ˆï¼Œå…è®¸æ˜¾å¼çš„å£°æ˜é‡‡ç”¨æˆ–æ‹’ç»ç¼–è¯‘å™¨è‡ªå¸¦çš„å‡½æ•°ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Magic</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Magic</span>() = <span class="keyword">default</span>; <span class="comment">// æ˜¾å¼å£°æ˜ä½¿ç”¨ç¼–è¯‘å™¨ç”Ÿæˆçš„æ„é€ </span></span><br><span class="line">    Magic&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Magic&amp;) = <span class="keyword">delete</span>; <span class="comment">// æ˜¾å¼å£°æ˜æ‹’ç»ç¼–è¯‘å™¨ç”Ÿæˆæ„é€ </span></span><br><span class="line">    <span class="built_in">Magic</span>(<span class="type">int</span> magic_number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¼ºç±»å‹æšä¸¾">å¼ºç±»å‹æšä¸¾</h3><p>åœ¨ä¼ ç»Ÿ C++ä¸­ï¼Œæšä¸¾ç±»å‹å¹¶éç±»å‹å®‰å…¨ï¼Œæšä¸¾ç±»å‹ä¼šè¢«è§†ä½œæ•´æ•°ï¼Œåˆ™ä¼šè®©ä¸¤ç§å®Œå…¨ä¸åŒçš„æšä¸¾ç±»å‹å¯ä»¥è¿›è¡Œç›´æ¥çš„æ¯”è¾ƒï¼ˆè™½ç„¶ç¼–è¯‘å™¨ç»™å‡ºäº†æ£€æŸ¥ï¼Œä½†å¹¶éæ‰€æœ‰ï¼‰ï¼Œ<strong>ç”šè‡³åŒä¸€ä¸ªå‘½åç©ºé—´ä¸­çš„ä¸åŒæšä¸¾ç±»å‹çš„æšä¸¾å€¼åå­—ä¸èƒ½ç›¸åŒ</strong>ï¼Œè¿™é€šå¸¸ä¸æ˜¯æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ç»“æœã€‚</p><p>C++11 å¼•å…¥äº†æšä¸¾ç±»ï¼ˆenumeration classï¼‰ï¼Œå¹¶ä½¿ç”¨ <code>enum class</code> çš„è¯­æ³•è¿›è¡Œå£°æ˜ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="symbol">new_enum</span> : <span class="symbol">unsigned</span> <span class="symbol">int</span> &#123;</span><br><span class="line">    value1,</span><br><span class="line">    value2,</span><br><span class="line">    value3 = <span class="number">100</span>,</span><br><span class="line">    value4 = <span class="number">100</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å®šä¹‰çš„æšä¸¾å®ç°äº†ç±»å‹å®‰å…¨ï¼Œé¦–å…ˆä»–ä¸èƒ½å¤Ÿè¢«éšå¼çš„è½¬æ¢ä¸ºæ•´æ•°ï¼ŒåŒæ—¶ä¹Ÿä¸èƒ½å¤Ÿå°†å…¶ä¸æ•´æ•°æ•°å­—è¿›è¡Œæ¯”è¾ƒï¼Œ æ›´ä¸å¯èƒ½å¯¹ä¸åŒçš„æšä¸¾ç±»å‹çš„æšä¸¾å€¼è¿›è¡Œæ¯”è¾ƒã€‚ä½†ç›¸åŒæšä¸¾å€¼ä¹‹é—´å¦‚æœæŒ‡å®šçš„å€¼ç›¸åŒï¼Œé‚£ä¹ˆå¯ä»¥è¿›è¡Œæ¯”è¾ƒï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (new_enum<span class="number">::</span>value3 == new_enum<span class="number">::</span>value4) &#123;</span><br><span class="line">    // ä¼šè¾“å‡º</span><br><span class="line">    st<span class="number">d::</span>cout &lt;&lt; &quot;new_enum<span class="number">::</span>value3 == new_enum<span class="number">::</span>value4&quot; &lt;&lt; st<span class="number">d::</span>endl<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªè¯­æ³•ä¸­ï¼Œæšä¸¾ç±»å‹åé¢ä½¿ç”¨äº†å†’å·åŠç±»å‹å…³é”®å­—æ¥æŒ‡å®šæšä¸¾ä¸­æšä¸¾å€¼çš„ç±»å‹ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä¸ºæšä¸¾èµ‹å€¼ï¼ˆæœªæŒ‡å®šæ—¶å°†é»˜è®¤ä½¿ç”¨ <code>int</code>ï¼‰ã€‚</p><p>è€Œæˆ‘ä»¬å¸Œæœ›è·å¾—æšä¸¾å€¼çš„å€¼æ—¶ï¼Œå°†å¿…é¡»æ˜¾å¼çš„è¿›è¡Œç±»å‹è½¬æ¢ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡è½½ <code>&lt;&lt;</code> è¿™ä¸ªç®—ç¬¦æ¥è¿›è¡Œè¾“å‡ºï¼Œå¯ä»¥æ”¶è—ä¸‹é¢è¿™ä¸ªä»£ç æ®µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(</span><br><span class="line">    <span class="keyword">typename</span> std::enable_if&lt;std::is_enum&lt;T&gt;::value,</span><br><span class="line">        std::ostream&gt;::type&amp; stream, <span class="type">const</span> T&amp; e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> stream &lt;&lt; <span class="keyword">static_cast</span>&lt;<span class="keyword">typename</span> std::underlying_type&lt;T&gt;::type&gt;(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶ï¼Œä¸‹é¢çš„ä»£ç å°†èƒ½å¤Ÿè¢«ç¼–è¯‘ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::cout &lt;&lt; new_enum::value3 &lt;&lt; std::endl</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“">æ€»ç»“</h2><p>æœ¬èŠ‚ä»‹ç»äº†ç°ä»£ C++ ä¸­å¯¹è¯­è¨€å¯ç”¨æ€§çš„å¢å¼ºï¼Œå…¶ä¸­ç¬”è€…è®¤ä¸ºæœ€ä¸ºé‡è¦çš„å‡ ä¸ªç‰¹æ€§æ˜¯å‡ ä¹æ‰€æœ‰äººéƒ½éœ€è¦äº†è§£å¹¶ç†Ÿç»ƒä½¿ç”¨çš„ï¼š</p><ol><li><code>auto</code> ç±»å‹æ¨å¯¼</li><li>èŒƒå›´ <code>for</code> è¿­ä»£</li><li>åˆå§‹åŒ–åˆ—è¡¨</li><li>å˜å‚æ¨¡æ¿</li></ol><h2 id="ä¹ é¢˜">ä¹ é¢˜</h2><ol><li><p>ä½¿ç”¨ç»“æ„åŒ–ç»‘å®šï¼Œä»…ç”¨ä¸€è¡Œå‡½æ•°å†…ä»£ç å®ç°å¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Key, <span class="keyword">typename</span> Value, <span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(std::map&lt;Key, Value&gt;&amp; m, F foo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::map&lt;std::string, <span class="type">long</span> <span class="type">long</span> <span class="type">int</span>&gt; m &#123;</span><br><span class="line">        &#123;<span class="string">&quot;a&quot;</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;b&quot;</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;c&quot;</span>, <span class="number">3</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">update</span>(m, [](std::string key) &#123;</span><br><span class="line">        <span class="keyword">return</span> std::hash&lt;std::string&gt;&#123;&#125;(key);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; [key, value] : m)</span><br><span class="line">        std::cout &lt;&lt; key &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; value &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å°è¯•ç”¨<a href="https://changkun.de/modern-cpp/zh-cn/02-usability/#%E6%8A%98%E5%8F%A0%E8%A1%A8%E8%BE%BE%E5%BC%8F">æŠ˜å è¡¨è¾¾å¼</a>å®ç°ç”¨äºè®¡ç®—å‡å€¼çš„å‡½æ•°ï¼Œä¼ å…¥å…è®¸ä»»æ„å‚æ•°</p></li></ol><h1>ç¬¬ 3 ç«  è¯­è¨€è¿è¡ŒæœŸçš„å¼ºåŒ–</h1><h2 id="3-1-Lambda-è¡¨è¾¾å¼">3.1 Lambda è¡¨è¾¾å¼</h2><p>Lambda è¡¨è¾¾å¼æ˜¯ç°ä»£ C++ ä¸­æœ€é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œè€Œ Lambda è¡¨è¾¾å¼ï¼Œå®é™…ä¸Šå°±æ˜¯æä¾›äº†ä¸€ä¸ªç±»ä¼¼åŒ¿åå‡½æ•°çš„ç‰¹æ€§ï¼Œ è€ŒåŒ¿åå‡½æ•°åˆ™æ˜¯åœ¨éœ€è¦ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯åˆä¸æƒ³è´¹åŠ›å»å‘½åä¸€ä¸ªå‡½æ•°çš„æƒ…å†µä¸‹å»ä½¿ç”¨çš„ã€‚è¿™æ ·çš„åœºæ™¯å…¶å®æœ‰å¾ˆå¤šå¾ˆå¤šï¼Œ æ‰€ä»¥åŒ¿åå‡½æ•°å‡ ä¹æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€çš„æ ‡é…ã€‚</p><h3 id="åŸºç¡€">åŸºç¡€</h3><p>Lambda è¡¨è¾¾å¼çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[æ•è·åˆ—è¡¨]</span>(å‚æ•°åˆ—è¡¨) <span class="built_in">mutable</span>(å¯é€‰) å¼‚å¸¸å±æ€§ -&gt; è¿”å›ç±»å‹ &#123;</span><br><span class="line"><span class="comment">// å‡½æ•°ä½“</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¯­æ³•è§„åˆ™é™¤äº† <code>[æ•è·åˆ—è¡¨]</code> å†…çš„ä¸œè¥¿å¤–ï¼Œå…¶ä»–éƒ¨åˆ†éƒ½å¾ˆå¥½ç†è§£ï¼Œåªæ˜¯ä¸€èˆ¬å‡½æ•°çš„å‡½æ•°åè¢«ç•¥å»ï¼Œ è¿”å›å€¼ä½¿ç”¨äº†ä¸€ä¸ª <code>-&gt;</code> çš„å½¢å¼è¿›è¡Œï¼ˆæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å‰é¢çš„å°¾è¿”å›ç±»å‹å·²ç»æåˆ°è¿‡è¿™ç§å†™æ³•äº†ï¼‰ã€‚</p><p>æ‰€è°“æ•è·åˆ—è¡¨ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºå‚æ•°çš„ä¸€ç§ç±»å‹ï¼ŒLambda è¡¨è¾¾å¼å†…éƒ¨å‡½æ•°ä½“åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸èƒ½å¤Ÿä½¿ç”¨å‡½æ•°ä½“å¤–éƒ¨çš„å˜é‡çš„ï¼Œ è¿™æ—¶å€™æ•è·åˆ—è¡¨å¯ä»¥èµ·åˆ°ä¼ é€’å¤–éƒ¨æ•°æ®çš„ä½œç”¨ã€‚æ ¹æ®ä¼ é€’çš„è¡Œä¸ºï¼Œæ•è·åˆ—è¡¨ä¹Ÿåˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p><h4 id="1-å€¼æ•è·">1. å€¼æ•è·</h4><p>ä¸å‚æ•°ä¼ å€¼ç±»ä¼¼ï¼Œå€¼æ•è·çš„å‰ææ˜¯å˜é‡å¯ä»¥æ‹·è´ï¼Œä¸åŒä¹‹å¤„åˆ™åœ¨äºï¼Œè¢«æ•è·çš„å˜é‡åœ¨ Lambda è¡¨è¾¾å¼è¢«åˆ›å»ºæ—¶æ‹·è´ï¼Œ è€Œéè°ƒç”¨æ—¶æ‰æ‹·è´ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">lambda_value_capture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">auto</span> copy_value = [value] &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;;</span><br><span class="line">    value = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">auto</span> stored_value = <span class="built_in">copy_value</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;stored_value = &quot;</span> &lt;&lt; stored_value &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è¿™æ—¶, stored_value == 1, è€Œ value == 100.</span></span><br><span class="line">    <span class="comment">// å› ä¸º copy_value åœ¨åˆ›å»ºæ—¶å°±ä¿å­˜äº†ä¸€ä»½ value çš„æ‹·è´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-å¼•ç”¨æ•è·">2. å¼•ç”¨æ•è·</h4><p>ä¸å¼•ç”¨ä¼ å‚ç±»ä¼¼ï¼Œå¼•ç”¨æ•è·ä¿å­˜çš„æ˜¯å¼•ç”¨ï¼Œå€¼ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">lambda_reference_capture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">auto</span> copy_value = [&amp;value] &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;;</span><br><span class="line">    value = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">auto</span> stored_value = <span class="built_in">copy_value</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;stored_value = &quot;</span> &lt;&lt; stored_value &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è¿™æ—¶, stored_value == 100, value == 100.</span></span><br><span class="line">    <span class="comment">// å› ä¸º copy_value ä¿å­˜çš„æ˜¯å¼•ç”¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-éšå¼æ•è·">3. éšå¼æ•è·</h4><p>æ‰‹åŠ¨ä¹¦å†™æ•è·åˆ—è¡¨æœ‰æ—¶å€™æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™ç§æœºæ¢°æ€§çš„å·¥ä½œå¯ä»¥äº¤ç»™ç¼–è¯‘å™¨æ¥å¤„ç†ï¼Œè¿™æ—¶å€™å¯ä»¥åœ¨æ•è·åˆ—è¡¨ä¸­å†™ä¸€ä¸ª <code>&amp;</code> æˆ– <code>=</code> å‘ç¼–è¯‘å™¨å£°æ˜é‡‡ç”¨å¼•ç”¨æ•è·æˆ–è€…å€¼æ•è·.</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œæ•è·æä¾›äº† Lambda è¡¨è¾¾å¼å¯¹å¤–éƒ¨å€¼è¿›è¡Œä½¿ç”¨çš„åŠŸèƒ½ï¼Œæ•è·åˆ—è¡¨çš„æœ€å¸¸ç”¨çš„å››ç§å½¢å¼å¯ä»¥æ˜¯ï¼š</p><ul><li>[] ç©ºæ•è·åˆ—è¡¨</li><li>[name1, name2, â€¦] æ•è·ä¸€ç³»åˆ—å˜é‡</li><li>[&amp;] å¼•ç”¨æ•è·, è®©ç¼–è¯‘å™¨è‡ªè¡Œæ¨å¯¼å¼•ç”¨åˆ—è¡¨</li><li>[=] å€¼æ•è·, è®©ç¼–è¯‘å™¨è‡ªè¡Œæ¨å¯¼å€¼æ•è·åˆ—è¡¨</li></ul><h4 id="4-è¡¨è¾¾å¼æ•è·">4. è¡¨è¾¾å¼æ•è·</h4><blockquote><p>è¿™éƒ¨åˆ†å†…å®¹éœ€è¦äº†è§£åé¢é©¬ä¸Šè¦æåˆ°çš„å³å€¼å¼•ç”¨ä»¥åŠæ™ºèƒ½æŒ‡é’ˆ</p></blockquote><p>ä¸Šé¢æåˆ°çš„å€¼æ•è·ã€å¼•ç”¨æ•è·éƒ½æ˜¯å·²ç»åœ¨å¤–å±‚ä½œç”¨åŸŸå£°æ˜çš„å˜é‡ï¼Œå› æ­¤è¿™äº›æ•è·æ–¹å¼æ•è·çš„å‡ä¸ºå·¦å€¼ï¼Œè€Œä¸èƒ½æ•è·å³å€¼ã€‚</p><p>C++14 ç»™ä¸äº†æˆ‘ä»¬æ–¹ä¾¿ï¼Œå…è®¸æ•è·çš„æˆå‘˜ç”¨ä»»æ„çš„è¡¨è¾¾å¼è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™å°±å…è®¸äº†å³å€¼çš„æ•è·ï¼Œ è¢«å£°æ˜çš„æ•è·å˜é‡ç±»å‹ä¼šæ ¹æ®è¡¨è¾¾å¼è¿›è¡Œåˆ¤æ–­ï¼Œåˆ¤æ–­æ–¹å¼ä¸ä½¿ç”¨ <code>auto</code> æœ¬è´¨ä¸Šæ˜¯ç›¸åŒçš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span>  <span class="comment">// std::make_unique</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span> <span class="comment">// std::move</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lambda_expression_capture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> important = std::<span class="built_in">make_unique</span>&lt;<span class="type">int</span>&gt;(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">auto</span> add = [v1 = <span class="number">1</span>, v2 = std::<span class="built_in">move</span>(important)](<span class="type">int</span> x, <span class="type">int</span> y) -&gt; <span class="type">int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> x+y+v1+(*v2);</span><br><span class="line">    &#125;;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">add</span>(<span class="number">3</span>,<span class="number">4</span>) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œimportant æ˜¯ä¸€ä¸ªç‹¬å æŒ‡é’ˆï¼Œæ˜¯ä¸èƒ½å¤Ÿè¢« â€œ=â€ å€¼æ•è·åˆ°ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å°†å…¶è½¬ç§»ä¸ºå³å€¼ï¼Œåœ¨è¡¨è¾¾å¼ä¸­åˆå§‹åŒ–ã€‚</p><h3 id="æ³›å‹-Lambda">æ³›å‹ Lambda</h3><p>ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬æåˆ°äº† <code>auto</code> å…³é”®å­—ä¸èƒ½å¤Ÿç”¨åœ¨å‚æ•°è¡¨é‡Œï¼Œè¿™æ˜¯å› ä¸ºè¿™æ ·çš„å†™æ³•ä¼šä¸æ¨¡æ¿çš„åŠŸèƒ½äº§ç”Ÿå†²çªã€‚ ä½†æ˜¯ Lambda è¡¨è¾¾å¼å¹¶ä¸æ˜¯æ™®é€šå‡½æ•°ï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰æ˜ç¡®æŒ‡æ˜å‚æ•°è¡¨ç±»å‹çš„æƒ…å†µä¸‹ï¼ŒLambda è¡¨è¾¾å¼å¹¶ä¸èƒ½å¤Ÿæ¨¡æ¿åŒ–ã€‚ å¹¸è¿çš„æ˜¯ï¼Œè¿™ç§éº»çƒ¦åªå­˜åœ¨äº C++11 ä¸­ï¼Œä» C++14 å¼€å§‹ï¼ŒLambda å‡½æ•°çš„å½¢å¼å‚æ•°å¯ä»¥ä½¿ç”¨ <code>auto</code> å…³é”®å­—æ¥äº§ç”Ÿæ„ä¹‰ä¸Šçš„æ³›å‹ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">auto <span class="built_in">add</span> = [](auto x, auto y) &#123;</span><br><span class="line">    return x+y;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">add</span>(1, 2);</span><br><span class="line"><span class="built_in">add</span>(1.1, 2.2);</span><br></pre></td></tr></table></figure><h2 id="3-2-å‡½æ•°å¯¹è±¡åŒ…è£…å™¨">3.2 å‡½æ•°å¯¹è±¡åŒ…è£…å™¨</h2><p>è¿™éƒ¨åˆ†å†…å®¹è™½ç„¶å±äºæ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä»æœ¬è´¨ä¸Šæ¥çœ‹ï¼Œå®ƒå´å¢å¼ºäº† C++ è¯­è¨€è¿è¡Œæ—¶çš„èƒ½åŠ›ï¼Œ è¿™éƒ¨åˆ†å†…å®¹ä¹Ÿç›¸å½“é‡è¦ï¼Œæ‰€ä»¥æ”¾åˆ°è¿™é‡Œæ¥è¿›è¡Œä»‹ç»ã€‚</p><h3 id="std-function"><code>std::function</code></h3><p>Lambda è¡¨è¾¾å¼çš„æœ¬è´¨æ˜¯ä¸€ä¸ªå’Œå‡½æ•°å¯¹è±¡ç±»å‹ç›¸ä¼¼çš„ç±»ç±»å‹ï¼ˆç§°ä¸ºé—­åŒ…ç±»å‹ï¼‰çš„å¯¹è±¡ï¼ˆç§°ä¸ºé—­åŒ…å¯¹è±¡ï¼‰ï¼Œ å½“ Lambda è¡¨è¾¾å¼çš„æ•è·åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œé—­åŒ…å¯¹è±¡è¿˜èƒ½å¤Ÿè½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆå€¼è¿›è¡Œä¼ é€’ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> foo = <span class="built_in">void</span>(<span class="type">int</span>); <span class="comment">// å®šä¹‰å‡½æ•°ç±»å‹, using çš„ä½¿ç”¨è§ä¸Šä¸€èŠ‚ä¸­çš„åˆ«åè¯­æ³•</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">functional</span><span class="params">(foo f)</span> </span>&#123; <span class="comment">// å‚æ•°åˆ—è¡¨ä¸­å®šä¹‰çš„å‡½æ•°ç±»å‹ foo è¢«è§†ä¸ºé€€åŒ–åçš„å‡½æ•°æŒ‡é’ˆç±»å‹ foo*</span></span><br><span class="line">    <span class="built_in">f</span>(<span class="number">1</span>); <span class="comment">// é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨å‡½æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> f = [](<span class="type">int</span> value) &#123;</span><br><span class="line">        std::cout &lt;&lt; value &lt;&lt; std::endl;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">functional</span>(f); <span class="comment">// ä¼ é€’é—­åŒ…å¯¹è±¡ï¼Œéšå¼è½¬æ¢ä¸º foo* ç±»å‹çš„å‡½æ•°æŒ‡é’ˆå€¼</span></span><br><span class="line">    <span class="built_in">f</span>(<span class="number">1</span>); <span class="comment">// lambda è¡¨è¾¾å¼è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ç»™å‡ºäº†ä¸¤ç§ä¸åŒçš„è°ƒç”¨å½¢å¼ï¼Œä¸€ç§æ˜¯å°† Lambda ä½œä¸ºå‡½æ•°ç±»å‹ä¼ é€’è¿›è¡Œè°ƒç”¨ï¼Œ è€Œå¦ä¸€ç§åˆ™æ˜¯ç›´æ¥è°ƒç”¨ Lambda è¡¨è¾¾å¼ï¼Œåœ¨ C++11 ä¸­ï¼Œç»Ÿä¸€äº†è¿™äº›æ¦‚å¿µï¼Œå°†èƒ½å¤Ÿè¢«è°ƒç”¨çš„å¯¹è±¡çš„ç±»å‹ï¼Œ ç»Ÿä¸€ç§°ä¹‹ä¸ºå¯è°ƒç”¨ç±»å‹ã€‚è€Œè¿™ç§ç±»å‹ï¼Œä¾¿æ˜¯é€šè¿‡ <code>std::function</code> å¼•å…¥çš„ã€‚</p><p>C++11 <code>std::function</code> æ˜¯ä¸€ç§é€šç”¨ã€å¤šæ€çš„å‡½æ•°å°è£…ï¼Œ å®ƒçš„å®ä¾‹å¯ä»¥å¯¹ä»»ä½•å¯ä»¥è°ƒç”¨çš„ç›®æ ‡å®ä½“è¿›è¡Œå­˜å‚¨ã€å¤åˆ¶å’Œè°ƒç”¨æ“ä½œï¼Œ å®ƒä¹Ÿæ˜¯å¯¹ C++ ä¸­ç°æœ‰çš„å¯è°ƒç”¨å®ä½“çš„ä¸€ç§ç±»å‹å®‰å…¨çš„åŒ…è£¹ï¼ˆç›¸å¯¹æ¥è¯´ï¼Œå‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼‰ï¼Œ æ¢å¥è¯è¯´ï¼Œå°±æ˜¯å‡½æ•°çš„å®¹å™¨ã€‚å½“æˆ‘ä»¬æœ‰äº†å‡½æ•°çš„å®¹å™¨ä¹‹åä¾¿èƒ½å¤Ÿæ›´åŠ æ–¹ä¾¿çš„å°†å‡½æ•°ã€å‡½æ•°æŒ‡é’ˆä½œä¸ºå¯¹è±¡è¿›è¡Œå¤„ç†ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> para)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> para;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// std::function åŒ…è£…äº†ä¸€ä¸ªè¿”å›å€¼ä¸º int, å‚æ•°ä¸º int çš„å‡½æ•°</span></span><br><span class="line">    std::function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; func = foo;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> important = <span class="number">10</span>;</span><br><span class="line">    std::function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; func2 = [&amp;](<span class="type">int</span> value) -&gt; <span class="type">int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>+value+important;</span><br><span class="line">    &#125;;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">func</span>(<span class="number">10</span>) &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">func2</span>(<span class="number">10</span>) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="std-bind-å’Œ-std-placeholder"><code>std::bind</code> å’Œ <code>std::placeholder</code></h3><p>è€Œ <code>std::bind</code> åˆ™æ˜¯ç”¨æ¥ç»‘å®šå‡½æ•°è°ƒç”¨çš„å‚æ•°çš„ï¼Œ å®ƒè§£å†³çš„éœ€æ±‚æ˜¯æˆ‘ä»¬æœ‰æ—¶å€™å¯èƒ½å¹¶ä¸ä¸€å®šèƒ½å¤Ÿä¸€æ¬¡æ€§è·å¾—è°ƒç”¨æŸä¸ªå‡½æ•°çš„å…¨éƒ¨å‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°ï¼Œ æˆ‘ä»¬å¯ä»¥å°†éƒ¨åˆ†è°ƒç”¨å‚æ•°æå‰ç»‘å®šåˆ°å‡½æ•°èº«ä¸Šæˆä¸ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œç„¶ååœ¨å‚æ•°é½å…¨åï¼Œå®Œæˆè°ƒç”¨ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> c)</span> </span>&#123;</span><br><span class="line">    ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°†å‚æ•°1,2ç»‘å®šåˆ°å‡½æ•° foo ä¸Šï¼Œ</span></span><br><span class="line">    <span class="comment">// ä½†ä½¿ç”¨ std::placeholders::_1 æ¥å¯¹ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œå ä½</span></span><br><span class="line">    <span class="keyword">auto</span> bindFoo = std::<span class="built_in">bind</span>(foo, std::placeholders::_1, <span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// è¿™æ—¶è°ƒç”¨ bindFoo æ—¶ï¼Œåªéœ€è¦æä¾›ç¬¬ä¸€ä¸ªå‚æ•°å³å¯</span></span><br><span class="line">    <span class="built_in">bindFoo</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>**æç¤ºï¼š**æ³¨æ„ <code>auto</code> å…³é”®å­—çš„å¦™ç”¨ã€‚æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¸å¤ªç†Ÿæ‚‰ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ç±»å‹ï¼Œ ä½†æ˜¯æˆ‘ä»¬å´å¯ä»¥é€šè¿‡ <code>auto</code> çš„ä½¿ç”¨æ¥è§„é¿è¿™ä¸€é—®é¢˜çš„å‡ºç°ã€‚</p></blockquote><h2 id="3-3-å³å€¼å¼•ç”¨">3.3 å³å€¼å¼•ç”¨</h2><p>å³å€¼å¼•ç”¨æ˜¯ C++11 å¼•å…¥çš„ä¸ Lambda è¡¨è¾¾å¼é½åçš„é‡è¦ç‰¹æ€§ä¹‹ä¸€ã€‚å®ƒçš„å¼•å…¥è§£å†³äº† C++ ä¸­å¤§é‡çš„å†å²é—ç•™é—®é¢˜ï¼Œ æ¶ˆé™¤äº†è¯¸å¦‚ <code>std::vector</code>ã€<code>std::string</code> ä¹‹ç±»çš„é¢å¤–å¼€é”€ï¼Œ ä¹Ÿæ‰ä½¿å¾—å‡½æ•°å¯¹è±¡å®¹å™¨ <code>std::function</code> æˆä¸ºäº†å¯èƒ½ã€‚</p><h3 id="å·¦å€¼ã€å³å€¼çš„çº¯å³å€¼ã€å°†äº¡å€¼ã€å³å€¼">å·¦å€¼ã€å³å€¼çš„çº¯å³å€¼ã€å°†äº¡å€¼ã€å³å€¼</h3><p>è¦å¼„æ˜ç™½å³å€¼å¼•ç”¨åˆ°åº•æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Œå¿…é¡»è¦å¯¹å·¦å€¼å’Œå³å€¼åšä¸€ä¸ªæ˜ç¡®çš„ç†è§£ã€‚</p><p><strong>å·¦å€¼</strong> (lvalue, left value)ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯èµ‹å€¼ç¬¦å·å·¦è¾¹çš„å€¼ã€‚å‡†ç¡®æ¥è¯´ï¼Œ å·¦å€¼æ˜¯è¡¨è¾¾å¼ï¼ˆä¸ä¸€å®šæ˜¯èµ‹å€¼è¡¨è¾¾å¼ï¼‰åä¾ç„¶å­˜åœ¨çš„æŒä¹…å¯¹è±¡ã€‚</p><p><strong>å³å€¼</strong> (rvalue, right value)ï¼Œå³è¾¹çš„å€¼ï¼Œæ˜¯æŒ‡è¡¨è¾¾å¼ç»“æŸåå°±ä¸å†å­˜åœ¨çš„ä¸´æ—¶å¯¹è±¡ã€‚</p><p>è€Œ C++11 ä¸­ä¸ºäº†å¼•å…¥å¼ºå¤§çš„å³å€¼å¼•ç”¨ï¼Œå°†å³å€¼çš„æ¦‚å¿µè¿›è¡Œäº†è¿›ä¸€æ­¥çš„åˆ’åˆ†ï¼Œåˆ†ä¸ºï¼šçº¯å³å€¼ã€å°†äº¡å€¼ã€‚</p><p><strong>çº¯å³å€¼</strong> (prvalue, pure rvalue)ï¼Œçº¯ç²¹çš„å³å€¼ï¼Œè¦ä¹ˆæ˜¯çº¯ç²¹çš„å­—é¢é‡ï¼Œä¾‹å¦‚ <code>10</code>, <code>true</code>ï¼› è¦ä¹ˆæ˜¯æ±‚å€¼ç»“æœç›¸å½“äºå­—é¢é‡æˆ–åŒ¿åä¸´æ—¶å¯¹è±¡ï¼Œä¾‹å¦‚ <code>1+2</code>ã€‚éå¼•ç”¨è¿”å›çš„ä¸´æ—¶å˜é‡ã€è¿ç®—è¡¨è¾¾å¼äº§ç”Ÿçš„ä¸´æ—¶å˜é‡ã€ åŸå§‹å­—é¢é‡ã€Lambda è¡¨è¾¾å¼éƒ½å±äºçº¯å³å€¼ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­—é¢é‡é™¤äº†å­—ç¬¦ä¸²å­—é¢é‡ä»¥å¤–ï¼Œå‡ä¸ºçº¯å³å€¼ã€‚è€Œå­—ç¬¦ä¸²å­—é¢é‡æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œç±»å‹ä¸º <code>const char</code> æ•°ç»„ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;type_traits&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main() &#123;</span><br><span class="line">    // æ­£ç¡®ï¼Œ<span class="string">&quot;01234&quot;</span> ç±»å‹ä¸º <span class="keyword">const</span> <span class="type">char</span> [<span class="number">6</span>]ï¼Œå› æ­¤æ˜¯å·¦å€¼</span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> (&amp;left)[<span class="number">6</span>] = <span class="string">&quot;01234&quot;</span>;</span><br><span class="line"></span><br><span class="line">    // æ–­è¨€æ­£ç¡®ï¼Œç¡®å®æ˜¯ <span class="keyword">const</span> <span class="type">char</span> [<span class="number">6</span>] ç±»å‹ï¼Œæ³¨æ„ decltype(<span class="type">expr</span>) åœ¨ <span class="type">expr</span> æ˜¯å·¦å€¼</span><br><span class="line">    // ä¸”éæ— æ‹¬å·åŒ…è£¹çš„ id è¡¨è¾¾å¼ä¸ç±»æˆå‘˜è¡¨è¾¾å¼æ—¶ï¼Œä¼šè¿”å›å·¦å€¼å¼•ç”¨</span><br><span class="line">    static_assert(std::is_same&lt;decltype(<span class="string">&quot;01234&quot;</span>), <span class="keyword">const</span> <span class="type">char</span>(&amp;)[<span class="number">6</span>]&gt;::value, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    // é”™è¯¯ï¼Œ<span class="string">&quot;01234&quot;</span> æ˜¯å·¦å€¼ï¼Œä¸å¯è¢«å³å€¼å¼•ç”¨</span><br><span class="line">    // <span class="keyword">const</span> <span class="type">char</span> (&amp;&amp;right)[<span class="number">6</span>] = <span class="string">&quot;01234&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ³¨æ„ï¼Œæ•°ç»„å¯ä»¥è¢«éšå¼è½¬æ¢æˆç›¸å¯¹åº”çš„æŒ‡é’ˆç±»å‹ï¼Œè€Œè½¬æ¢è¡¨è¾¾å¼çš„ç»“æœï¼ˆå¦‚æœä¸æ˜¯å·¦å€¼å¼•ç”¨ï¼‰åˆ™ä¸€å®šæ˜¯ä¸ªå³å€¼ï¼ˆå³å€¼å¼•ç”¨ä¸ºå°†äº¡å€¼ï¼Œå¦åˆ™ä¸ºçº¯å³å€¼ï¼‰ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="type">char</span>*   p   = <span class="string">&quot;01234&quot;</span>;  // æ­£ç¡®ï¼Œ<span class="string">&quot;01234&quot;</span> è¢«éšå¼è½¬æ¢ä¸º <span class="keyword">const</span> <span class="type">char</span>*</span><br><span class="line"><span class="keyword">const</span> <span class="type">char</span>*&amp;&amp; pr  = <span class="string">&quot;01234&quot;</span>;  // æ­£ç¡®ï¼Œ<span class="string">&quot;01234&quot;</span> è¢«éšå¼è½¬æ¢ä¸º <span class="keyword">const</span> <span class="type">char</span>*ï¼Œè¯¥è½¬æ¢çš„ç»“æœæ˜¯çº¯å³å€¼</span><br><span class="line">// <span class="keyword">const</span> <span class="type">char</span>*&amp; pl = <span class="string">&quot;01234&quot;</span>; // é”™è¯¯ï¼Œæ­¤å¤„ä¸å­˜åœ¨ <span class="keyword">const</span> <span class="type">char</span>* ç±»å‹çš„å·¦å€¼</span><br></pre></td></tr></table></figure><p><strong>å°†äº¡å€¼</strong> (xvalue, expiring value)ï¼Œæ˜¯ C++11 ä¸ºäº†å¼•å…¥å³å€¼å¼•ç”¨è€Œæå‡ºçš„æ¦‚å¿µï¼ˆå› æ­¤åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œ çº¯å³å€¼å’Œå³å€¼æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼‰ï¼Œä¹Ÿå°±æ˜¯å³å°†è¢«é”€æ¯ã€å´èƒ½å¤Ÿè¢«ç§»åŠ¨çš„å€¼ã€‚</p><p>å°†äº¡å€¼å¯èƒ½ç¨æœ‰äº›éš¾ä»¥ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹è¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; temp = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::vector&lt;<span class="type">int</span>&gt; v = <span class="built_in">foo</span>();</span><br></pre></td></tr></table></figure><p>åœ¨è¿™æ ·çš„ä»£ç ä¸­ï¼Œå°±ä¼ ç»Ÿçš„ç†è§£è€Œè¨€ï¼Œå‡½æ•° <code>foo</code> çš„è¿”å›å€¼ <code>temp</code> åœ¨å†…éƒ¨åˆ›å»ºç„¶åè¢«èµ‹å€¼ç»™ <code>v</code>ï¼Œ ç„¶è€Œ <code>v</code> è·å¾—è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œä¼šå°†æ•´ä¸ª <code>temp</code> æ‹·è´ä¸€ä»½ï¼Œç„¶åæŠŠ <code>temp</code> é”€æ¯ï¼Œå¦‚æœè¿™ä¸ª <code>temp</code> éå¸¸å¤§ï¼Œ è¿™å°†é€ æˆå¤§é‡é¢å¤–çš„å¼€é”€ï¼ˆè¿™ä¹Ÿå°±æ˜¯ä¼ ç»Ÿ C++ ä¸€ç›´è¢«è¯Ÿç—…çš„é—®é¢˜ï¼‰ã€‚åœ¨æœ€åä¸€è¡Œä¸­ï¼Œ<code>v</code> æ˜¯å·¦å€¼ã€ <code>foo()</code> è¿”å›çš„å€¼å°±æ˜¯å³å€¼ï¼ˆä¹Ÿæ˜¯çº¯å³å€¼ï¼‰ã€‚ä½†æ˜¯ï¼Œ<code>v</code> å¯ä»¥è¢«åˆ«çš„å˜é‡æ•è·åˆ°ï¼Œ è€Œ <code>foo()</code> äº§ç”Ÿçš„é‚£ä¸ªè¿”å›å€¼ä½œä¸ºä¸€ä¸ªä¸´æ—¶å€¼ï¼Œä¸€æ—¦è¢« <code>v</code> å¤åˆ¶åï¼Œå°†ç«‹å³è¢«é”€æ¯ï¼Œæ— æ³•è·å–ã€ä¹Ÿä¸èƒ½ä¿®æ”¹ã€‚ è€Œå°†äº¡å€¼å°±å®šä¹‰äº†è¿™æ ·ä¸€ç§è¡Œä¸ºï¼šä¸´æ—¶çš„å€¼èƒ½å¤Ÿè¢«è¯†åˆ«ã€åŒæ—¶åˆèƒ½å¤Ÿè¢«ç§»åŠ¨ã€‚</p><p>åœ¨ C++11 ä¹‹åï¼Œç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬åšäº†ä¸€äº›å·¥ä½œï¼Œæ­¤å¤„çš„å·¦å€¼ <code>temp</code> ä¼šè¢«è¿›è¡Œæ­¤éšå¼å³å€¼è½¬æ¢ï¼Œ ç­‰ä»·äº <code>static_cast&lt;std::vector&lt;int&gt; &amp;&amp;&gt;(temp)</code>ï¼Œè¿›è€Œæ­¤å¤„çš„ <code>v</code> ä¼šå°† <code>foo</code> å±€éƒ¨è¿”å›çš„å€¼è¿›è¡Œç§»åŠ¨ã€‚ ä¹Ÿå°±æ˜¯åé¢æˆ‘ä»¬å°†ä¼šæåˆ°çš„ç§»åŠ¨è¯­ä¹‰ã€‚</p><h3 id="å³å€¼å¼•ç”¨å’Œå·¦å€¼å¼•ç”¨">å³å€¼å¼•ç”¨å’Œå·¦å€¼å¼•ç”¨</h3><p>è¦æ‹¿åˆ°ä¸€ä¸ªå°†äº¡å€¼ï¼Œå°±éœ€è¦ç”¨åˆ°å³å€¼å¼•ç”¨ï¼š<code>T &amp;&amp;</code>ï¼Œå…¶ä¸­ <code>T</code> æ˜¯ç±»å‹ã€‚ å³å€¼å¼•ç”¨çš„å£°æ˜è®©è¿™ä¸ªä¸´æ—¶å€¼çš„ç”Ÿå‘½å‘¨æœŸå¾—ä»¥å»¶é•¿ã€åªè¦å˜é‡è¿˜æ´»ç€ï¼Œé‚£ä¹ˆå°†äº¡å€¼å°†ç»§ç»­å­˜æ´»ã€‚</p><p>C++11 æä¾›äº† <code>std::move</code> è¿™ä¸ªæ–¹æ³•å°†å·¦å€¼å‚æ•°æ— æ¡ä»¶çš„è½¬æ¢ä¸ºå³å€¼ï¼Œ æœ‰äº†å®ƒæˆ‘ä»¬å°±èƒ½å¤Ÿæ–¹ä¾¿çš„è·å¾—ä¸€ä¸ªå³å€¼ä¸´æ—¶å¯¹è±¡ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reference</span><span class="params">(std::string&amp; str)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å·¦å€¼&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reference</span><span class="params">(std::string&amp;&amp; str)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å³å€¼&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string lv1 = <span class="string">&quot;string,&quot;</span>; <span class="comment">// lv1 æ˜¯ä¸€ä¸ªå·¦å€¼</span></span><br><span class="line">    <span class="comment">// std::string&amp;&amp; r1 = lv1; // éæ³•, å³å€¼å¼•ç”¨ä¸èƒ½å¼•ç”¨å·¦å€¼</span></span><br><span class="line">    std::string&amp;&amp; rv1 = std::<span class="built_in">move</span>(lv1); <span class="comment">// åˆæ³•, std::moveå¯ä»¥å°†å·¦å€¼è½¬ç§»ä¸ºå³å€¼</span></span><br><span class="line">    std::cout &lt;&lt; rv1 &lt;&lt; std::endl; <span class="comment">// string,</span></span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> std::string&amp; lv2 = lv1 + lv1; <span class="comment">// åˆæ³•, å¸¸é‡å·¦å€¼å¼•ç”¨èƒ½å¤Ÿå»¶é•¿ä¸´æ—¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">    <span class="comment">// lv2 += &quot;Test&quot;; // éæ³•, å¸¸é‡å¼•ç”¨æ— æ³•è¢«ä¿®æ”¹</span></span><br><span class="line">    std::cout &lt;&lt; lv2 &lt;&lt; std::endl; <span class="comment">// string,string,</span></span><br><span class="line"></span><br><span class="line">    std::string&amp;&amp; rv2 = lv1 + lv2; <span class="comment">// åˆæ³•, å³å€¼å¼•ç”¨å»¶é•¿ä¸´æ—¶å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">    rv2 += <span class="string">&quot;Test&quot;</span>; <span class="comment">// åˆæ³•, éå¸¸é‡å¼•ç”¨èƒ½å¤Ÿä¿®æ”¹ä¸´æ—¶å˜é‡</span></span><br><span class="line">    std::cout &lt;&lt; rv2 &lt;&lt; std::endl; <span class="comment">// string,string,string,Test</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">reference</span>(rv2); <span class="comment">// è¾“å‡ºå·¦å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>rv2</code> è™½ç„¶å¼•ç”¨äº†ä¸€ä¸ªå³å€¼ï¼Œä½†ç”±äºå®ƒæ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œæ‰€ä»¥ <code>rv2</code> ä¾ç„¶æ˜¯ä¸€ä¸ªå·¦å€¼ã€‚</p><p>æ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„å†å²é—ç•™é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// int &amp;a = std::move(1);    // ä¸åˆæ³•ï¼Œéå¸¸é‡å·¦å¼•ç”¨æ— æ³•å¼•ç”¨å³å€¼</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> &amp;b = std::<span class="built_in">move</span>(<span class="number">1</span>); <span class="comment">// åˆæ³•, å¸¸é‡å·¦å¼•ç”¨å…è®¸å¼•ç”¨å³å€¼</span></span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; a &lt;&lt; b &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸å…è®¸éå¸¸é‡å¼•ç”¨ç»‘å®šåˆ°éå·¦å€¼ï¼Ÿè¿™æ˜¯å› ä¸ºè¿™ç§åšæ³•å­˜åœ¨é€»è¾‘é”™è¯¯ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">increase</span>(<span class="params"><span class="built_in">int</span> &amp; v</span>)</span> &#123;</span><br><span class="line">    v++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span>()</span> &#123;</span><br><span class="line">    <span class="built_in">double</span> s = <span class="number">1</span>;</span><br><span class="line">    increase(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äº <code>int&amp;</code> ä¸èƒ½å¼•ç”¨ <code>double</code> ç±»å‹çš„å‚æ•°ï¼Œå› æ­¤å¿…é¡»äº§ç”Ÿä¸€ä¸ªä¸´æ—¶å€¼æ¥ä¿å­˜ <code>s</code> çš„å€¼ï¼Œ ä»è€Œå½“ <code>increase()</code> ä¿®æ”¹è¿™ä¸ªä¸´æ—¶å€¼æ—¶ï¼Œè°ƒç”¨å®Œæˆå <code>s</code> æœ¬èº«å¹¶æ²¡æœ‰è¢«ä¿®æ”¹ã€‚</p><p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆå¸¸é‡å¼•ç”¨å…è®¸ç»‘å®šåˆ°éå·¦å€¼ï¼ŸåŸå› å¾ˆç®€å•ï¼Œå› ä¸º Fortran éœ€è¦ã€‚</p><h3 id="ç§»åŠ¨è¯­ä¹‰">ç§»åŠ¨è¯­ä¹‰</h3><p>ä¼ ç»Ÿ C++ é€šè¿‡æ‹·è´æ„é€ å‡½æ•°å’Œèµ‹å€¼æ“ä½œç¬¦ä¸ºç±»å¯¹è±¡è®¾è®¡äº†æ‹·è´/å¤åˆ¶çš„æ¦‚å¿µï¼Œä½†ä¸ºäº†å®ç°å¯¹èµ„æºçš„ç§»åŠ¨æ“ä½œï¼Œ è°ƒç”¨è€…å¿…é¡»ä½¿ç”¨å…ˆå¤åˆ¶ã€å†ææ„çš„æ–¹å¼ï¼Œå¦åˆ™å°±éœ€è¦è‡ªå·±å®ç°ç§»åŠ¨å¯¹è±¡çš„æ¥å£ã€‚ è¯•æƒ³ï¼Œæ¬å®¶çš„æ—¶å€™æ˜¯æŠŠå®¶é‡Œçš„ä¸œè¥¿ç›´æ¥æ¬åˆ°æ–°å®¶å»ï¼Œè€Œä¸æ˜¯å°†æ‰€æœ‰ä¸œè¥¿å¤åˆ¶ä¸€ä»½ï¼ˆé‡ä¹°ï¼‰å†æ”¾åˆ°æ–°å®¶ã€ å†æŠŠåŸæ¥çš„ä¸œè¥¿å…¨éƒ¨æ‰”æ‰ï¼ˆé”€æ¯ï¼‰ï¼Œè¿™æ˜¯éå¸¸åäººç±»çš„ä¸€ä»¶äº‹æƒ…ã€‚</p><p>ä¼ ç»Ÿçš„ C++ æ²¡æœ‰åŒºåˆ†ã€ç§»åŠ¨ã€å’Œã€æ‹·è´ã€çš„æ¦‚å¿µï¼Œé€ æˆäº†å¤§é‡çš„æ•°æ®æ‹·è´ï¼Œæµªè´¹æ—¶é—´å’Œç©ºé—´ã€‚ å³å€¼å¼•ç”¨çš„å‡ºç°æ°å¥½å°±è§£å†³äº†è¿™ä¸¤ä¸ªæ¦‚å¿µçš„æ··æ·†é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> *pointer;</span><br><span class="line">    <span class="built_in">A</span>():<span class="built_in">pointer</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">1</span>)) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ„é€ &quot;</span> &lt;&lt; pointer &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">A</span>(A&amp; a):<span class="built_in">pointer</span>(<span class="keyword">new</span> <span class="built_in">int</span>(*a.pointer)) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ‹·è´&quot;</span> &lt;&lt; pointer &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="comment">// æ— æ„ä¹‰çš„å¯¹è±¡æ‹·è´</span></span><br><span class="line">    <span class="built_in">A</span>(A&amp;&amp; a):<span class="built_in">pointer</span>(a.pointer) &#123;</span><br><span class="line">        a.pointer = <span class="literal">nullptr</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ç§»åŠ¨&quot;</span> &lt;&lt; pointer &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">A</span>()&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ææ„&quot;</span> &lt;&lt; pointer &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">delete</span> pointer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–</span></span><br><span class="line"><span class="function">A <span class="title">return_rvalue</span><span class="params">(<span class="type">bool</span> test)</span> </span>&#123;</span><br><span class="line">    A a,b;</span><br><span class="line">    <span class="keyword">if</span>(test) <span class="keyword">return</span> a; <span class="comment">// ç­‰ä»·äº static_cast&lt;A&amp;&amp;&gt;(a);</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> b;     <span class="comment">// ç­‰ä»·äº static_cast&lt;A&amp;&amp;&gt;(b);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A obj = <span class="built_in">return_rvalue</span>(<span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;obj:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; obj.pointer &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; *obj.pointer &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼š</p><ol><li>é¦–å…ˆä¼šåœ¨ <code>return_rvalue</code> å†…éƒ¨æ„é€ ä¸¤ä¸ª <code>A</code> å¯¹è±¡ï¼Œäºæ˜¯è·å¾—ä¸¤ä¸ªæ„é€ å‡½æ•°çš„è¾“å‡ºï¼›</li><li>å‡½æ•°è¿”å›åï¼Œäº§ç”Ÿä¸€ä¸ªå°†äº¡å€¼ï¼Œè¢« <code>A</code> çš„ç§»åŠ¨æ„é€ ï¼ˆ<code>A(A&amp;&amp;)</code>ï¼‰å¼•ç”¨ï¼Œä»è€Œå»¶é•¿ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶å°†è¿™ä¸ªå³å€¼ä¸­çš„æŒ‡é’ˆæ‹¿åˆ°ï¼Œä¿å­˜åˆ°äº† <code>obj</code> ä¸­ï¼Œè€Œå°†äº¡å€¼çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º <code>nullptr</code>ï¼Œé˜²æ­¢äº†è¿™å—å†…å­˜åŒºåŸŸè¢«é”€æ¯ã€‚</li></ol><p>ä»è€Œé¿å…äº†æ— æ„ä¹‰çš„æ‹·è´æ„é€ ï¼ŒåŠ å¼ºäº†æ€§èƒ½ã€‚å†æ¥çœ‹çœ‹æ¶‰åŠæ ‡å‡†åº“çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span> <span class="comment">// std::cout</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span> <span class="comment">// std::move</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span> <span class="comment">// std::vector</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span> <span class="comment">// std::string</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    std::string str = <span class="string">&quot;Hello world.&quot;</span>;</span><br><span class="line">    std::vector&lt;std::string&gt; v;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ä½¿ç”¨ push_back(const T&amp;), å³äº§ç”Ÿæ‹·è´è¡Œä¸º</span></span><br><span class="line">    v.<span class="built_in">push_back</span>(str);</span><br><span class="line">    <span class="comment">// å°†è¾“å‡º &quot;str: Hello world.&quot;</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;str: &quot;</span> &lt;&lt; str &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ä½¿ç”¨ push_back(const T&amp;&amp;), ä¸ä¼šå‡ºç°æ‹·è´è¡Œä¸º</span></span><br><span class="line">    <span class="comment">// è€Œæ•´ä¸ªå­—ç¬¦ä¸²ä¼šè¢«ç§»åŠ¨åˆ° vector ä¸­ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ std::move ä¼šç”¨æ¥å‡å°‘æ‹·è´å‡ºç°çš„å¼€é”€</span></span><br><span class="line">    <span class="comment">// è¿™æ­¥æ“ä½œå, str ä¸­çš„å€¼ä¼šå˜ä¸ºç©º</span></span><br><span class="line">    v.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(str));</span><br><span class="line">    <span class="comment">// å°†è¾“å‡º &quot;str: &quot;</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;str: &quot;</span> &lt;&lt; str &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®Œç¾è½¬å‘">å®Œç¾è½¬å‘</h3><p>å‰é¢æˆ‘ä»¬æåˆ°äº†ï¼Œä¸€ä¸ªå£°æ˜çš„å³å€¼å¼•ç”¨å…¶å®æ˜¯ä¸€ä¸ªå·¦å€¼ã€‚è¿™å°±ä¸ºæˆ‘ä»¬è¿›è¡Œå‚æ•°è½¬å‘ï¼ˆä¼ é€’ï¼‰é€ æˆäº†é—®é¢˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">reference</span><span class="params">(<span class="type">int</span>&amp; v)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å·¦å€¼&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reference</span><span class="params">(<span class="type">int</span>&amp;&amp; v)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å³å€¼&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pass</span><span class="params">(T&amp;&amp; v)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ™®é€šä¼ å‚:&quot;</span>;</span><br><span class="line">    <span class="built_in">reference</span>(v); <span class="comment">// å§‹ç»ˆè°ƒç”¨ reference(int&amp;)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ä¼ é€’å³å€¼:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">pass</span>(<span class="number">1</span>); <span class="comment">// 1æ˜¯å³å€¼, ä½†è¾“å‡ºæ˜¯å·¦å€¼</span></span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ä¼ é€’å·¦å€¼:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> l = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">pass</span>(l); <span class="comment">// l æ˜¯å·¦å€¼, è¾“å‡ºå·¦å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº <code>pass(1)</code> æ¥è¯´ï¼Œè™½ç„¶ä¼ é€’çš„æ˜¯å³å€¼ï¼Œä½†ç”±äº <code>v</code> æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œæ‰€ä»¥åŒæ—¶ä¹Ÿæ˜¯å·¦å€¼ã€‚ å› æ­¤ <code>reference(v)</code> ä¼šè°ƒç”¨ <code>reference(int&amp;)</code>ï¼Œè¾“å‡ºã€å·¦å€¼ã€ã€‚ è€Œå¯¹äº<code>pass(l)</code>è€Œè¨€ï¼Œ<code>l</code>æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œä¸ºä»€ä¹ˆä¼šæˆåŠŸä¼ é€’ç»™ <code>pass(T&amp;&amp;)</code> å‘¢ï¼Ÿ</p><p>è¿™æ˜¯åŸºäº<strong>å¼•ç”¨åç¼©è§„åˆ™</strong>çš„ï¼šåœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½å¤Ÿå¯¹ä¸€ä¸ªå¼•ç”¨ç±»å‹ç»§ç»­è¿›è¡Œå¼•ç”¨ï¼Œ ä½† C++ ç”±äºå³å€¼å¼•ç”¨çš„å‡ºç°è€Œæ”¾å®½äº†è¿™ä¸€åšæ³•ï¼Œä»è€Œäº§ç”Ÿäº†å¼•ç”¨åç¼©è§„åˆ™ï¼Œå…è®¸æˆ‘ä»¬å¯¹å¼•ç”¨è¿›è¡Œå¼•ç”¨ï¼Œ æ—¢èƒ½å·¦å¼•ç”¨ï¼Œåˆèƒ½å³å¼•ç”¨ã€‚ä½†æ˜¯å´éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š</p><table><thead><tr><th style="text-align:left">å‡½æ•°å½¢å‚ç±»å‹</th><th style="text-align:left">å®å‚å‚æ•°ç±»å‹</th><th style="text-align:left">æ¨å¯¼åå‡½æ•°å½¢å‚ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left">T&amp;</td><td style="text-align:left">å·¦å¼•ç”¨</td><td style="text-align:left">T&amp;</td></tr><tr><td style="text-align:left">T&amp;</td><td style="text-align:left">å³å¼•ç”¨</td><td style="text-align:left">T&amp;</td></tr><tr><td style="text-align:left">T&amp;&amp;</td><td style="text-align:left">å·¦å¼•ç”¨</td><td style="text-align:left">T&amp;</td></tr><tr><td style="text-align:left">T&amp;&amp;</td><td style="text-align:left">å³å¼•ç”¨</td><td style="text-align:left">T&amp;&amp;</td></tr></tbody></table><p>å› æ­¤ï¼Œæ¨¡æ¿å‡½æ•°ä¸­ä½¿ç”¨ <code>T&amp;&amp;</code> ä¸ä¸€å®šèƒ½è¿›è¡Œå³å€¼å¼•ç”¨ï¼Œå½“ä¼ å…¥å·¦å€¼æ—¶ï¼Œæ­¤å‡½æ•°çš„å¼•ç”¨å°†è¢«æ¨å¯¼ä¸ºå·¦å€¼ã€‚ æ›´å‡†ç¡®çš„è®²ï¼Œ<strong>æ— è®ºæ¨¡æ¿å‚æ•°æ˜¯ä»€ä¹ˆç±»å‹çš„å¼•ç”¨ï¼Œå½“ä¸”ä»…å½“å®å‚ç±»å‹ä¸ºå³å¼•ç”¨æ—¶ï¼Œæ¨¡æ¿å‚æ•°æ‰èƒ½è¢«æ¨å¯¼ä¸ºå³å¼•ç”¨ç±»å‹</strong>ã€‚ è¿™æ‰ä½¿å¾— <code>v</code> ä½œä¸ºå·¦å€¼çš„æˆåŠŸä¼ é€’ã€‚</p><p>å®Œç¾è½¬å‘å°±æ˜¯åŸºäºä¸Šè¿°è§„å¾‹äº§ç”Ÿçš„ã€‚æ‰€è°“å®Œç¾è½¬å‘ï¼Œå°±æ˜¯ä¸ºäº†è®©æˆ‘ä»¬åœ¨ä¼ é€’å‚æ•°çš„æ—¶å€™ï¼Œ ä¿æŒåŸæ¥çš„å‚æ•°ç±»å‹ï¼ˆå·¦å¼•ç”¨ä¿æŒå·¦å¼•ç”¨ï¼Œå³å¼•ç”¨ä¿æŒå³å¼•ç”¨ï¼‰ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ <code>std::forward</code> æ¥è¿›è¡Œå‚æ•°çš„è½¬å‘ï¼ˆä¼ é€’ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reference</span><span class="params">(<span class="type">int</span>&amp; v)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å·¦å€¼å¼•ç”¨&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reference</span><span class="params">(<span class="type">int</span>&amp;&amp; v)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å³å€¼å¼•ç”¨&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pass</span><span class="params">(T&amp;&amp; v)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;              æ™®é€šä¼ å‚: &quot;</span>;</span><br><span class="line">    <span class="built_in">reference</span>(v);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;       std::move ä¼ å‚: &quot;</span>;</span><br><span class="line">    <span class="built_in">reference</span>(std::<span class="built_in">move</span>(v));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;    std::forward ä¼ å‚: &quot;</span>;</span><br><span class="line">    <span class="built_in">reference</span>(std::forward&lt;T&gt;(v));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;static_cast&lt;T&amp;&amp;&gt; ä¼ å‚: &quot;</span>;</span><br><span class="line">    <span class="built_in">reference</span>(<span class="built_in">static_cast</span>&lt;T&amp;&amp;&gt;(v));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ä¼ é€’å³å€¼:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">pass</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ä¼ é€’å·¦å€¼:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> v = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">pass</span>(v);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ä¼ é€’å³å€¼:</span><br><span class="line">              æ™®é€šä¼ å‚: å·¦å€¼å¼•ç”¨</span><br><span class="line">       std::move ä¼ å‚: å³å€¼å¼•ç”¨</span><br><span class="line">    std::forward ä¼ å‚: å³å€¼å¼•ç”¨</span><br><span class="line"><span class="keyword">static_cast</span>&lt;T&amp;&amp;&gt; ä¼ å‚: å³å€¼å¼•ç”¨</span><br><span class="line">ä¼ é€’å·¦å€¼:</span><br><span class="line">              æ™®é€šä¼ å‚: å·¦å€¼å¼•ç”¨</span><br><span class="line">       std::move ä¼ å‚: å³å€¼å¼•ç”¨</span><br><span class="line">    std::forward ä¼ å‚: å·¦å€¼å¼•ç”¨</span><br><span class="line"><span class="keyword">static_cast</span>&lt;T&amp;&amp;&gt; ä¼ å‚: å·¦å€¼å¼•ç”¨</span><br></pre></td></tr></table></figure><p>æ— è®ºä¼ é€’å‚æ•°ä¸ºå·¦å€¼è¿˜æ˜¯å³å€¼ï¼Œæ™®é€šä¼ å‚éƒ½ä¼šå°†å‚æ•°ä½œä¸ºå·¦å€¼è¿›è¡Œè½¬å‘ï¼› ç”±äºç±»ä¼¼çš„åŸå› ï¼Œ<code>std::move</code> æ€»ä¼šæ¥å—åˆ°ä¸€ä¸ªå·¦å€¼ï¼Œä»è€Œè½¬å‘è°ƒç”¨äº†<code>reference(int&amp;&amp;)</code> è¾“å‡ºå³å€¼å¼•ç”¨ã€‚</p><p>å”¯ç‹¬ <code>std::forward</code> å³æ²¡æœ‰é€ æˆä»»ä½•å¤šä½™çš„æ‹·è´ï¼ŒåŒæ—¶<strong>å®Œç¾è½¬å‘</strong>(ä¼ é€’)äº†å‡½æ•°çš„å®å‚ç»™äº†å†…éƒ¨è°ƒç”¨çš„å…¶ä»–å‡½æ•°ã€‚</p><p><code>std::forward</code> å’Œ <code>std::move</code> ä¸€æ ·ï¼Œæ²¡æœ‰åšä»»ä½•äº‹æƒ…ï¼Œ<code>std::move</code> å•çº¯çš„å°†å·¦å€¼è½¬åŒ–ä¸ºå³å€¼ï¼Œ <code>std::forward</code> ä¹Ÿåªæ˜¯å•çº¯çš„å°†å‚æ•°åšäº†ä¸€ä¸ªç±»å‹çš„è½¬æ¢ï¼Œä»ç°è±¡ä¸Šæ¥çœ‹ï¼Œ <code>std::forward&lt;T&gt;(v)</code> å’Œ <code>static_cast&lt;T&amp;&amp;&gt;(v)</code> æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚</p><p>è¯»è€…å¯èƒ½ä¼šå¥½å¥‡ï¼Œä¸ºä½•ä¸€æ¡è¯­å¥èƒ½å¤Ÿé’ˆå¯¹ä¸¤ç§ç±»å‹çš„è¿”å›å¯¹åº”çš„å€¼ï¼Œ æˆ‘ä»¬å†ç®€å•çœ‹ä¸€çœ‹ <code>std::forward</code> çš„å…·ä½“å®ç°æœºåˆ¶ï¼Œ<code>std::forward</code> åŒ…å«ä¸¤ä¸ªé‡è½½ï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">template&lt;<span class="built_in">typename</span> <span class="variable">_Tp</span>&gt;</span><br><span class="line">constexpr <span class="variable">_Tp</span>&amp;&amp; forward(<span class="built_in">typename</span> std::remove_reference&lt;<span class="variable">_Tp</span>&gt;::<span class="built_in">type</span>&amp; <span class="variable">__t</span>) noexcept</span><br><span class="line">&#123; return static_cast&lt;<span class="variable">_Tp</span>&amp;&amp;&gt;(<span class="variable">__t</span>); &#125;</span><br><span class="line"></span><br><span class="line">template&lt;<span class="built_in">typename</span> <span class="variable">_Tp</span>&gt;</span><br><span class="line">constexpr <span class="variable">_Tp</span>&amp;&amp; forward(<span class="built_in">typename</span> std::remove_reference&lt;<span class="variable">_Tp</span>&gt;::<span class="built_in">type</span>&amp;&amp; <span class="variable">__t</span>) noexcept</span><br><span class="line">&#123;</span><br><span class="line">    static_assert(!std::is_lvalue_reference&lt;<span class="variable">_Tp</span>&gt;::value, <span class="string">&quot;template argument&quot;</span></span><br><span class="line">        <span class="string">&quot; substituting _Tp is an lvalue reference type&quot;</span>);</span><br><span class="line">    return static_cast&lt;<span class="variable">_Tp</span>&amp;&amp;&gt;(<span class="variable">__t</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä»½å®ç°ä¸­ï¼Œ<code>std::remove_reference</code> çš„åŠŸèƒ½æ˜¯æ¶ˆé™¤ç±»å‹ä¸­çš„å¼•ç”¨ï¼Œ <code>std::is_lvalue_reference</code> åˆ™ç”¨äºæ£€æŸ¥ç±»å‹æ¨å¯¼æ˜¯å¦æ­£ç¡®ï¼Œåœ¨ <code>std::forward</code> çš„ç¬¬äºŒä¸ªå®ç°ä¸­ æ£€æŸ¥äº†æ¥æ”¶åˆ°çš„å€¼ç¡®å®æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œè¿›è€Œä½“ç°äº†åç¼©è§„åˆ™ã€‚</p><p>å½“ <code>std::forward</code> æ¥å—å·¦å€¼æ—¶ï¼Œ<code>_Tp</code> è¢«æ¨å¯¼ä¸ºå·¦å€¼ï¼Œæ‰€ä»¥è¿”å›å€¼ä¸ºå·¦å€¼ï¼›è€Œå½“å…¶æ¥å—å³å€¼æ—¶ï¼Œ <code>_Tp</code> è¢«æ¨å¯¼ä¸º å³å€¼å¼•ç”¨ï¼Œåˆ™åŸºäºåç¼©è§„åˆ™ï¼Œè¿”å›å€¼ä¾¿æˆä¸ºäº† <code>&amp;&amp; + &amp;&amp;</code> çš„å³å€¼ã€‚ å¯è§ <code>std::forward</code> çš„åŸç†åœ¨äºå·§å¦™çš„åˆ©ç”¨äº†æ¨¡æ¿ç±»å‹æ¨å¯¼ä¸­äº§ç”Ÿçš„å·®å¼‚ã€‚</p><p>è¿™æ—¶æˆ‘ä»¬èƒ½å›ç­”è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆåœ¨ä½¿ç”¨å¾ªç¯è¯­å¥çš„è¿‡ç¨‹ä¸­ï¼Œ<code>auto&amp;&amp;</code> æ˜¯æœ€å®‰å…¨çš„æ–¹å¼ï¼Ÿ å› ä¸ºå½“ <code>auto</code> è¢«æ¨å¯¼ä¸ºä¸åŒçš„å·¦å³å¼•ç”¨æ—¶ï¼Œä¸ <code>&amp;&amp;</code> çš„åç¼©ç»„åˆæ˜¯å®Œç¾è½¬å‘ã€‚</p><h2 id="æ€»ç»“-2">æ€»ç»“</h2><p>æœ¬ç« ä»‹ç»äº†ç°ä»£ C++ ä¸­æœ€ä¸ºé‡è¦çš„å‡ ä¸ªè¯­è¨€è¿è¡Œæ—¶çš„å¢å¼ºï¼Œå…¶ä¸­ç¬”è€…è®¤ä¸ºæœ¬èŠ‚ä¸­æåˆ°çš„æ‰€æœ‰ç‰¹æ€§éƒ½æ˜¯å€¼å¾—æŒæ¡çš„ï¼š</p><ol><li>Lambda è¡¨è¾¾å¼</li><li>å‡½æ•°å¯¹è±¡å®¹å™¨ std::function</li><li>å³å€¼å¼•ç”¨</li></ol><h1>ç¬¬ 4 ç«  å®¹å™¨</h1><h2 id="4-1-çº¿æ€§å®¹å™¨">4.1 çº¿æ€§å®¹å™¨</h2><h3 id="std-array"><code>std::array</code></h3><p>çœ‹åˆ°è¿™ä¸ªå®¹å™¨çš„æ—¶å€™è‚¯å®šä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼š</p><ol><li>ä¸ºä»€ä¹ˆè¦å¼•å…¥ <code>std::array</code> è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ <code>std::vector</code>ï¼Ÿ</li><li>å·²ç»æœ‰äº†ä¼ ç»Ÿæ•°ç»„ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ <code>std::array</code>?</li></ol><p>å…ˆå›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä¸ <code>std::vector</code> ä¸åŒï¼Œ<code>std::array</code> å¯¹è±¡çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå¦‚æœå®¹å™¨å¤§å°æ˜¯å›ºå®šçš„ï¼Œé‚£ä¹ˆå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ <code>std::array</code> å®¹å™¨ã€‚ å¦å¤–ç”±äº <code>std::vector</code> æ˜¯è‡ªåŠ¨æ‰©å®¹çš„ï¼Œå½“å­˜å…¥å¤§é‡çš„æ•°æ®åï¼Œå¹¶ä¸”å¯¹å®¹å™¨è¿›è¡Œäº†åˆ é™¤æ“ä½œï¼Œ å®¹å™¨å¹¶ä¸ä¼šè‡ªåŠ¨å½’è¿˜è¢«åˆ é™¤å…ƒç´ ç›¸åº”çš„å†…å­˜ï¼Œè¿™æ—¶å€™å°±éœ€è¦æ‰‹åŠ¨è¿è¡Œ <code>shrink_to_fit()</code> é‡Šæ”¾è¿™éƒ¨åˆ†å†…å­˜ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;size:&quot;</span> &lt;&lt; v.<span class="built_in">size</span>() &lt;&lt; std::endl;         <span class="comment">// è¾“å‡º 0</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;capacity:&quot;</span> &lt;&lt; v.<span class="built_in">capacity</span>() &lt;&lt; std::endl; <span class="comment">// è¾“å‡º 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚ä¸‹å¯çœ‹å‡º std::vector çš„å­˜å‚¨æ˜¯è‡ªåŠ¨ç®¡ç†çš„ï¼ŒæŒ‰éœ€è‡ªåŠ¨æ‰©å¼ </span></span><br><span class="line"><span class="comment">// ä½†æ˜¯å¦‚æœç©ºé—´ä¸è¶³ï¼Œéœ€è¦é‡æ–°åˆ†é…æ›´å¤šå†…å­˜ï¼Œè€Œé‡åˆ†é…å†…å­˜é€šå¸¸æ˜¯æ€§èƒ½ä¸Šæœ‰å¼€é”€çš„æ“ä½œ</span></span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">3</span>);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;size:&quot;</span> &lt;&lt; v.<span class="built_in">size</span>() &lt;&lt; std::endl;         <span class="comment">// è¾“å‡º 3</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;capacity:&quot;</span> &lt;&lt; v.<span class="built_in">capacity</span>() &lt;&lt; std::endl; <span class="comment">// è¾“å‡º 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œçš„è‡ªåŠ¨æ‰©å¼ é€»è¾‘ä¸ Golang çš„ slice å¾ˆåƒ</span></span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">4</span>);</span><br><span class="line">v.<span class="built_in">push_back</span>(<span class="number">5</span>);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;size:&quot;</span> &lt;&lt; v.<span class="built_in">size</span>() &lt;&lt; std::endl;         <span class="comment">// è¾“å‡º 5</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;capacity:&quot;</span> &lt;&lt; v.<span class="built_in">capacity</span>() &lt;&lt; std::endl; <span class="comment">// è¾“å‡º 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚ä¸‹å¯çœ‹å‡ºå®¹å™¨è™½ç„¶æ¸…ç©ºäº†å…ƒç´ ï¼Œä½†æ˜¯è¢«æ¸…ç©ºå…ƒç´ çš„å†…å­˜å¹¶æ²¡æœ‰å½’è¿˜</span></span><br><span class="line">v.<span class="built_in">clear</span>();                                             </span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;size:&quot;</span> &lt;&lt; v.<span class="built_in">size</span>() &lt;&lt; std::endl;         <span class="comment">// è¾“å‡º 0</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;capacity:&quot;</span> &lt;&lt; v.<span class="built_in">capacity</span>() &lt;&lt; std::endl; <span class="comment">// è¾“å‡º 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é¢å¤–å†…å­˜å¯é€šè¿‡ shrink_to_fit() è°ƒç”¨è¿”å›ç»™ç³»ç»Ÿ</span></span><br><span class="line">v.<span class="built_in">shrink_to_fit</span>();</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;size:&quot;</span> &lt;&lt; v.<span class="built_in">size</span>() &lt;&lt; std::endl;         <span class="comment">// è¾“å‡º 0</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;capacity:&quot;</span> &lt;&lt; v.<span class="built_in">capacity</span>() &lt;&lt; std::endl; <span class="comment">// è¾“å‡º 0</span></span><br></pre></td></tr></table></figure><p>è€Œç¬¬äºŒä¸ªé—®é¢˜å°±æ›´åŠ ç®€å•ï¼Œä½¿ç”¨ <code>std::array</code> èƒ½å¤Ÿè®©ä»£ç å˜å¾—æ›´åŠ â€œç°ä»£åŒ–â€ï¼Œè€Œä¸”å°è£…äº†ä¸€äº›æ“ä½œå‡½æ•°ï¼Œæ¯”å¦‚è·å–æ•°ç»„å¤§å°ä»¥åŠæ£€æŸ¥æ˜¯å¦éç©ºï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿå‹å¥½çš„ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„å®¹å™¨ç®—æ³•ï¼Œæ¯”å¦‚ <code>std::sort</code>ã€‚</p><p>ä½¿ç”¨ <code>std::array</code> å¾ˆç®€å•ï¼Œåªéœ€æŒ‡å®šå…¶ç±»å‹å’Œå¤§å°å³å¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">std::array&lt;<span class="type">int</span>, 4&gt; arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line"></span><br><span class="line">arr.<span class="built_in">empty</span>(); <span class="comment">// æ£€æŸ¥å®¹å™¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">arr.<span class="built_in">size</span>();  <span class="comment">// è¿”å›å®¹çº³çš„å…ƒç´ æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿­ä»£å™¨æ”¯æŒ</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> &amp;i : arr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨ lambda è¡¨è¾¾å¼æ’åº</span></span><br><span class="line">std::<span class="built_in">sort</span>(arr.<span class="built_in">begin</span>(), arr.<span class="built_in">end</span>(), [](<span class="type">int</span> a, <span class="type">int</span> b) &#123;</span><br><span class="line">    <span class="keyword">return</span> b &lt; a;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„å¤§å°å‚æ•°å¿…é¡»æ˜¯å¸¸é‡è¡¨è¾¾å¼</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> len = <span class="number">4</span>;</span><br><span class="line">std::array&lt;<span class="type">int</span>, len&gt; arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éæ³•,ä¸åŒäº C é£æ ¼æ•°ç»„ï¼Œstd::array ä¸ä¼šè‡ªåŠ¨é€€åŒ–æˆ T*</span></span><br><span class="line"><span class="comment">// int *arr_p = arr;</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å¼€å§‹ç”¨ä¸Šäº† <code>std::array</code> æ—¶ï¼Œéš¾å…ä¼šé‡åˆ°è¦å°†å…¶å…¼å®¹ C é£æ ¼çš„æ¥å£ï¼Œè¿™é‡Œæœ‰ä¸‰ç§åšæ³•ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void <span class="built_in">foo</span>(int *p, int len) &#123;</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::array&lt;int, <span class="number">4</span>&gt; arr = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C é£æ ¼æ¥å£ä¼ å‚</span></span><br><span class="line"><span class="comment">// foo(arr, arr.size()); // éæ³•, æ— æ³•éšå¼è½¬æ¢</span></span><br><span class="line"><span class="built_in">foo</span>(&amp;arr[<span class="number">0</span>], arr.size());</span><br><span class="line"><span class="built_in">foo</span>(arr.data(), arr<span class="selector-class">.size</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ `std::sort`</span></span><br><span class="line">std::<span class="built_in">sort</span>(arr.<span class="built_in">begin</span>(), arr.<span class="built_in">end</span>());</span><br></pre></td></tr></table></figure><h3 id="std-forward-list"><code>std::forward_list</code></h3><p><code>std::forward_list</code> æ˜¯ä¸€ä¸ªåˆ—è¡¨å®¹å™¨ï¼Œä½¿ç”¨æ–¹æ³•å’Œ <code>std::list</code> åŸºæœ¬ç±»ä¼¼ï¼Œå› æ­¤æˆ‘ä»¬å°±ä¸èŠ±è´¹ç¯‡å¹…è¿›è¡Œä»‹ç»äº†ã€‚</p><p>éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œå’Œ <code>std::list</code> çš„åŒå‘é“¾è¡¨çš„å®ç°ä¸åŒï¼Œ<code>std::forward_list</code> ä½¿ç”¨å•å‘é“¾è¡¨è¿›è¡Œå®ç°ï¼Œ æä¾›äº† <code>O(1)</code> å¤æ‚åº¦çš„å…ƒç´ æ’å…¥ï¼Œä¸æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ï¼ˆè¿™ä¹Ÿæ˜¯é“¾è¡¨çš„ç‰¹ç‚¹ï¼‰ï¼Œ ä¹Ÿæ˜¯æ ‡å‡†åº“å®¹å™¨ä¸­å”¯ä¸€ä¸€ä¸ªä¸æä¾› <code>size()</code> æ–¹æ³•çš„å®¹å™¨ã€‚å½“ä¸éœ€è¦åŒå‘è¿­ä»£æ—¶ï¼Œå…·æœ‰æ¯” <code>std::list</code> æ›´é«˜çš„ç©ºé—´åˆ©ç”¨ç‡ã€‚</p><h2 id="4-2-æ— åºå®¹å™¨">4.2 æ— åºå®¹å™¨</h2><p>æˆ‘ä»¬å·²ç»ç†ŸçŸ¥äº†ä¼ ç»Ÿ C++ ä¸­çš„æœ‰åºå®¹å™¨ <code>std::map</code>/<code>std::set</code>ï¼Œè¿™äº›å…ƒç´ å†…éƒ¨é€šè¿‡çº¢é»‘æ ‘è¿›è¡Œå®ç°ï¼Œ æ’å…¥å’Œæœç´¢çš„å¹³å‡å¤æ‚åº¦å‡ä¸º <code>O(log(size))</code>ã€‚åœ¨æ’å…¥å…ƒç´ æ—¶å€™ï¼Œä¼šæ ¹æ® <code>&lt;</code> æ“ä½œç¬¦æ¯”è¾ƒå…ƒç´ å¤§å°å¹¶åˆ¤æ–­å…ƒç´ æ˜¯å¦ç›¸åŒï¼Œ å¹¶é€‰æ‹©åˆé€‚çš„ä½ç½®æ’å…¥åˆ°å®¹å™¨ä¸­ã€‚å½“å¯¹è¿™ä¸ªå®¹å™¨ä¸­çš„å…ƒç´ è¿›è¡Œéå†æ—¶ï¼Œè¾“å‡ºç»“æœä¼šæŒ‰ç…§ <code>&lt;</code> æ“ä½œç¬¦çš„é¡ºåºæ¥é€ä¸ªéå†ã€‚</p><p>è€Œæ— åºå®¹å™¨ä¸­çš„å…ƒç´ æ˜¯ä¸è¿›è¡Œæ’åºçš„ï¼Œå†…éƒ¨é€šè¿‡ Hash è¡¨å®ç°ï¼Œæ’å…¥å’Œæœç´¢å…ƒç´ çš„å¹³å‡å¤æ‚åº¦ä¸º <code>O(constant)</code>ï¼Œ åœ¨ä¸å…³å¿ƒå®¹å™¨å†…éƒ¨å…ƒç´ é¡ºåºæ—¶ï¼Œèƒ½å¤Ÿè·å¾—æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚</p><p>C++11 å¼•å…¥äº†çš„ä¸¤ç»„æ— åºå®¹å™¨åˆ†åˆ«æ˜¯ï¼š<code>std::unordered_map</code>/<code>std::unordered_multimap</code> å’Œ <code>std::unordered_set</code>/<code>std::unordered_multiset</code>ã€‚</p><p>å®ƒä»¬çš„ç”¨æ³•å’ŒåŸæœ‰çš„ <code>std::map</code>/<code>std::multimap</code>/<code>std::set</code>/<code>set::multiset</code> åŸºæœ¬ç±»ä¼¼ï¼Œ ç”±äºè¿™äº›å®¹å™¨æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œä¾¿ä¸ä¸€ä¸€ä¸¾ä¾‹ï¼Œæˆ‘ä»¬ç›´æ¥æ¥æ¯”è¾ƒä¸€ä¸‹<code>std::map</code>å’Œ<code>std::unordered_map</code>ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸¤ç»„ç»“æ„æŒ‰åŒæ ·çš„é¡ºåºåˆå§‹åŒ–</span></span><br><span class="line">    std::unordered_map&lt;<span class="type">int</span>, std::string&gt; u = &#123;</span><br><span class="line">        &#123;<span class="number">1</span>, <span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3</span>, <span class="string">&quot;3&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="number">2</span>, <span class="string">&quot;2&quot;</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    std::map&lt;<span class="type">int</span>, std::string&gt; v = &#123;</span><br><span class="line">        &#123;<span class="number">1</span>, <span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3</span>, <span class="string">&quot;3&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="number">2</span>, <span class="string">&quot;2&quot;</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†åˆ«å¯¹ä¸¤ç»„ç»“æ„è¿›è¡Œéå†</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;std::unordered_map&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">const</span> <span class="keyword">auto</span> &amp; n : u)</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Key:[&quot;</span> &lt;&lt; n.first &lt;&lt; <span class="string">&quot;] Value:[&quot;</span> &lt;&lt; n.second &lt;&lt; <span class="string">&quot;]\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;std::map&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">const</span> <span class="keyword">auto</span> &amp; n : v)</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Key:[&quot;</span> &lt;&lt; n.first &lt;&lt; <span class="string">&quot;] Value:[&quot;</span> &lt;&lt; n.second &lt;&lt; <span class="string">&quot;]\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">std</span>::unordered_map</span><br><span class="line"><span class="attribute">Key</span>:[<span class="number">2</span>] Value:[<span class="number">2</span>]</span><br><span class="line"><span class="attribute">Key</span>:[<span class="number">3</span>] Value:[<span class="number">3</span>]</span><br><span class="line"><span class="attribute">Key</span>:[<span class="number">1</span>] Value:[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="attribute">std</span>::map</span><br><span class="line"><span class="attribute">Key</span>:[<span class="number">1</span>] Value:[<span class="number">1</span>]</span><br><span class="line"><span class="attribute">Key</span>:[<span class="number">2</span>] Value:[<span class="number">2</span>]</span><br><span class="line"><span class="attribute">Key</span>:[<span class="number">3</span>] Value:[<span class="number">3</span>]</span><br></pre></td></tr></table></figure><h2 id="4-3-å…ƒç»„">4.3 å…ƒç»„</h2><p>äº†è§£è¿‡ Python çš„ç¨‹åºå‘˜åº”è¯¥çŸ¥é“å…ƒç»„çš„æ¦‚å¿µï¼Œçºµè§‚ä¼ ç»Ÿ C++ ä¸­çš„å®¹å™¨ï¼Œé™¤äº† <code>std::pair</code> å¤–ï¼Œ ä¼¼ä¹æ²¡æœ‰ç°æˆçš„ç»“æ„èƒ½å¤Ÿç”¨æ¥å­˜æ”¾ä¸åŒç±»å‹çš„æ•°æ®ï¼ˆé€šå¸¸æˆ‘ä»¬ä¼šè‡ªå·±å®šä¹‰ç»“æ„ï¼‰ã€‚ ä½† <code>std::pair</code> çš„ç¼ºé™·æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œåªèƒ½ä¿å­˜ä¸¤ä¸ªå…ƒç´ ã€‚</p><h3 id="å…ƒç»„åŸºæœ¬æ“ä½œ">å…ƒç»„åŸºæœ¬æ“ä½œ</h3><p>å…³äºå…ƒç»„çš„ä½¿ç”¨æœ‰ä¸‰ä¸ªæ ¸å¿ƒçš„å‡½æ•°ï¼š</p><ol><li><code>std::make_tuple</code>: æ„é€ å…ƒç»„</li><li><code>std::get</code>: è·å¾—å…ƒç»„æŸä¸ªä½ç½®çš„å€¼</li><li><code>std::tie</code>: å…ƒç»„æ‹†åŒ…</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tuple&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">get_student</span><span class="params">(<span class="type">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è¿”å›ç±»å‹è¢«æ¨æ–­ä¸º std::tuple&lt;double, char, std::string&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">3.8</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">2.9</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&quot;æå››&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">1.7</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&quot;ç‹äº”&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">0.0</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="comment">// å¦‚æœåªå†™ 0 ä¼šå‡ºç°æ¨æ–­é”™è¯¯, ç¼–è¯‘å¤±è´¥</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> student = <span class="built_in">get_student</span>(<span class="number">0</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ID: 0, &quot;</span></span><br><span class="line">    &lt;&lt; <span class="string">&quot;GPA: &quot;</span> &lt;&lt; std::<span class="built_in">get</span>&lt;<span class="number">0</span>&gt;(student) &lt;&lt; <span class="string">&quot;, &quot;</span></span><br><span class="line">    &lt;&lt; <span class="string">&quot;æˆç»©: &quot;</span> &lt;&lt; std::<span class="built_in">get</span>&lt;<span class="number">1</span>&gt;(student) &lt;&lt; <span class="string">&quot;, &quot;</span></span><br><span class="line">    &lt;&lt; <span class="string">&quot;å§“å: &quot;</span> &lt;&lt; std::<span class="built_in">get</span>&lt;<span class="number">2</span>&gt;(student) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> gpa;</span><br><span class="line">    <span class="type">char</span> grade;</span><br><span class="line">    std::string name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…ƒç»„è¿›è¡Œæ‹†åŒ…</span></span><br><span class="line">    std::<span class="built_in">tie</span>(gpa, grade, name) = <span class="built_in">get_student</span>(<span class="number">1</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ID: 1, &quot;</span></span><br><span class="line">    &lt;&lt; <span class="string">&quot;GPA: &quot;</span> &lt;&lt; gpa &lt;&lt; <span class="string">&quot;, &quot;</span></span><br><span class="line">    &lt;&lt; <span class="string">&quot;æˆç»©: &quot;</span> &lt;&lt; grade &lt;&lt; <span class="string">&quot;, &quot;</span></span><br><span class="line">    &lt;&lt; <span class="string">&quot;å§“å: &quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>std::get</code> é™¤äº†ä½¿ç”¨å¸¸é‡è·å–å…ƒç»„å¯¹è±¡å¤–ï¼ŒC++14 å¢åŠ äº†ä½¿ç”¨ç±»å‹æ¥è·å–å…ƒç»„ä¸­çš„å¯¹è±¡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::tuple&lt;std::string, <span class="type">double</span>, <span class="type">double</span>, <span class="type">int</span>&gt; <span class="title">t</span><span class="params">(<span class="string">&quot;123&quot;</span>, <span class="number">4.5</span>, <span class="number">6.7</span>, <span class="number">8</span>)</span></span>;</span><br><span class="line">std::cout &lt;&lt; std::<span class="built_in">get</span>&lt;std::string&gt;(t) &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; std::<span class="built_in">get</span>&lt;<span class="type">double</span>&gt;(t) &lt;&lt; std::endl; <span class="comment">// éæ³•, å¼•å‘ç¼–è¯‘æœŸé”™è¯¯</span></span><br><span class="line">std::cout &lt;&lt; std::<span class="built_in">get</span>&lt;<span class="number">3</span>&gt;(t) &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure><h3 id="è¿è¡ŒæœŸç´¢å¼•">è¿è¡ŒæœŸç´¢å¼•</h3><p>å¦‚æœä½ ä»”ç»†æ€è€ƒä¸€ä¸‹å¯èƒ½å°±ä¼šå‘ç°ä¸Šé¢ä»£ç çš„é—®é¢˜ï¼Œ<code>std::get&lt;&gt;</code> ä¾èµ–ä¸€ä¸ªç¼–è¯‘æœŸçš„å¸¸é‡ï¼Œæ‰€ä»¥ä¸‹é¢çš„æ–¹å¼æ˜¯ä¸åˆæ³•çš„ï¼š</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> <span class="built_in">index</span> = <span class="number">1</span>;</span><br><span class="line">s<span class="symbol">td:</span><span class="symbol">:ge</span><span class="built_in">t</span>&lt;<span class="built_in">index</span>&gt;(<span class="built_in">t</span>);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¦æ€ä¹ˆå¤„ç†ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œä½¿ç”¨ <code>std::variant&lt;&gt;</code>ï¼ˆC++ 17 å¼•å…¥ï¼‰ï¼Œæä¾›ç»™ <code>variant&lt;&gt;</code> çš„ç±»å‹æ¨¡æ¿å‚æ•° å¯ä»¥è®©ä¸€ä¸ª <code>variant&lt;&gt;</code> ä»è€Œå®¹çº³æä¾›çš„å‡ ç§ç±»å‹çš„å˜é‡ï¼ˆåœ¨å…¶ä»–è¯­è¨€ï¼Œä¾‹å¦‚ Python/JavaScript ç­‰ï¼Œè¡¨ç°ä¸ºåŠ¨æ€ç±»å‹ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;variant&gt;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">size_t</span> n, <span class="keyword">typename</span>... T&gt;</span><br><span class="line"><span class="keyword">constexpr</span> std::variant&lt;T...&gt; _tuple_index(<span class="type">const</span> std::tuple&lt;T...&gt;&amp; tpl, <span class="type">size_t</span> i) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(n &gt;= <span class="keyword">sizeof</span>...(T))</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throw</span> <span class="title">std::out_of_range</span><span class="params">(<span class="string">&quot;è¶Šç•Œ.&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (i == n)</span><br><span class="line">        <span class="keyword">return</span> std::variant&lt;T...&gt;&#123; std::in_place_index&lt;n&gt;, std::<span class="built_in">get</span>&lt;n&gt;(tpl) &#125;;</span><br><span class="line">    <span class="keyword">return</span> _tuple_index&lt;(n &lt; <span class="keyword">sizeof</span>...(T)<span class="number">-1</span> ? n+<span class="number">1</span> : <span class="number">0</span>)&gt;(tpl, i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span>... T&gt;</span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> std::variant&lt;T...&gt; <span class="title">tuple_index</span><span class="params">(<span class="type">const</span> std::tuple&lt;T...&gt;&amp; tpl, <span class="type">size_t</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _tuple_index&lt;<span class="number">0</span>&gt;(tpl, i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T0, <span class="keyword">typename</span> ... Ts&gt;</span><br><span class="line">std::ostream &amp; <span class="keyword">operator</span>&lt;&lt; (std::ostream &amp; s, std::variant&lt;T0, Ts...&gt; <span class="type">const</span> &amp; v) &#123; </span><br><span class="line">    std::<span class="built_in">visit</span>([&amp;](<span class="keyword">auto</span> &amp;&amp; x)&#123; s &lt;&lt; x;&#125;, v); </span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±èƒ½ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">std::cout &lt;&lt; <span class="built_in">tuple_index</span>(t, i) &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure><h3 id="å…ƒç»„åˆå¹¶ä¸éå†">å…ƒç»„åˆå¹¶ä¸éå†</h3><p>è¿˜æœ‰ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚å°±æ˜¯åˆå¹¶ä¸¤ä¸ªå…ƒç»„ï¼Œè¿™å¯ä»¥é€šè¿‡ <code>std::tuple_cat</code> æ¥å®ç°ï¼š</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">auto</span> new_tuple = <span class="title function_">std::tuple_cat</span>(get_student(<span class="number">1</span>), <span class="title function_">std::move</span>(t))<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>é©¬ä¸Šå°±èƒ½å¤Ÿå‘ç°ï¼Œåº”è¯¥å¦‚ä½•å¿«é€Ÿéå†ä¸€ä¸ªå…ƒç»„ï¼Ÿä½†æ˜¯æˆ‘ä»¬åˆšæ‰ä»‹ç»äº†å¦‚ä½•åœ¨è¿è¡ŒæœŸé€šè¿‡éå¸¸æ•°ç´¢å¼•ä¸€ä¸ª <code>tuple</code> é‚£ä¹ˆéå†å°±å˜å¾—ç®€å•äº†ï¼Œ é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªå…ƒç»„çš„é•¿åº¦ï¼Œå¯ä»¥ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">tuple_len</span><span class="params">(T &amp;tpl)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> std::tuple_size&lt;T&gt;::value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½å¤Ÿå¯¹å…ƒç»„è¿›è¡Œè¿­ä»£äº†ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿­ä»£</span></span><br><span class="line"><span class="keyword">for</span>(int i = <span class="number">0</span>; i != tuple_len(<span class="keyword">new</span><span class="type">_tuple</span>); ++i)</span><br><span class="line">    <span class="comment">// è¿è¡ŒæœŸç´¢å¼•</span></span><br><span class="line">    std:<span class="type"></span>:cout &lt;&lt; tuple_index(<span class="keyword">new</span><span class="type">_tuple</span>, i) &lt;&lt; std:<span class="type"></span>:endl;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“-3">æ€»ç»“</h2><p>æœ¬ç« ç®€å•ä»‹ç»äº†ç°ä»£ C++ ä¸­æ–°å¢çš„å®¹å™¨ï¼Œå®ƒä»¬çš„ç”¨æ³•å’Œä¼ ç»Ÿ C++ ä¸­å·²æœ‰çš„å®¹å™¨ç±»ä¼¼ï¼Œç›¸å¯¹ç®€å•ï¼Œå¯ä»¥æ ¹æ®å®é™…åœºæ™¯ä¸°å¯Œçš„é€‰æ‹©éœ€è¦ä½¿ç”¨çš„å®¹å™¨ï¼Œä»è€Œè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</p><p><code>std::tuple</code> è™½ç„¶æœ‰æ•ˆï¼Œä½†æ˜¯æ ‡å‡†åº“æä¾›çš„åŠŸèƒ½æœ‰é™ï¼Œæ²¡åŠæ³•æ»¡è¶³è¿è¡ŒæœŸç´¢å¼•å’Œè¿­ä»£çš„éœ€æ±‚ï¼Œå¥½åœ¨æˆ‘ä»¬è¿˜æœ‰å…¶ä»–çš„æ–¹æ³•å¯ä»¥è‡ªè¡Œå®ç°ã€‚</p><h1>ç¬¬ 5 ç«  æ™ºèƒ½æŒ‡é’ˆä¸å†…å­˜ç®¡ç†</h1><h2 id="5-1-RAII-ä¸å¼•ç”¨è®¡æ•°">5.1 RAII ä¸å¼•ç”¨è®¡æ•°</h2><p>äº†è§£ <code>Objective-C</code>/<code>Swift</code> çš„ç¨‹åºå‘˜åº”è¯¥çŸ¥é“å¼•ç”¨è®¡æ•°çš„æ¦‚å¿µã€‚å¼•ç”¨è®¡æ•°è¿™ç§è®¡æ•°æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜æ³„éœ²è€Œäº§ç”Ÿçš„ã€‚ åŸºæœ¬æƒ³æ³•æ˜¯å¯¹äºåŠ¨æ€åˆ†é…çš„å¯¹è±¡ï¼Œè¿›è¡Œå¼•ç”¨è®¡æ•°ï¼Œæ¯å½“å¢åŠ ä¸€æ¬¡å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±ä¼šå¢åŠ ä¸€æ¬¡ï¼Œ æ¯åˆ é™¤ä¸€æ¬¡å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°å°±ä¼šå‡ä¸€ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡ä¸ºé›¶æ—¶ï¼Œå°±è‡ªåŠ¨åˆ é™¤æŒ‡å‘çš„å †å†…å­˜ã€‚</p><p>åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œã€è®°å¾—ã€æ‰‹åŠ¨é‡Šæ”¾èµ„æºï¼Œæ€»ä¸æ˜¯æœ€ä½³å®è·µã€‚å› ä¸ºæˆ‘ä»¬å¾ˆæœ‰å¯èƒ½å°±å¿˜è®°äº†å»é‡Šæ”¾èµ„æºè€Œå¯¼è‡´æ³„éœ²ã€‚ æ‰€ä»¥é€šå¸¸çš„åšæ³•æ˜¯å¯¹äºä¸€ä¸ªå¯¹è±¡è€Œè¨€ï¼Œæˆ‘ä»¬åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™ç”³è¯·ç©ºé—´ï¼Œè€Œåœ¨ææ„å‡½æ•°ï¼ˆåœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è°ƒç”¨ï¼‰çš„æ—¶å€™é‡Šæ”¾ç©ºé—´ï¼Œ ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ RAII èµ„æºè·å–å³åˆå§‹åŒ–æŠ€æœ¯ã€‚</p><p>å‡¡äº‹éƒ½æœ‰ä¾‹å¤–ï¼Œæˆ‘ä»¬æ€»ä¼šæœ‰éœ€è¦å°†å¯¹è±¡åœ¨è‡ªç”±å­˜å‚¨ä¸Šåˆ†é…çš„éœ€æ±‚ï¼Œåœ¨ä¼ ç»Ÿ C++ é‡Œæˆ‘ä»¬åªå¥½ä½¿ç”¨ <code>new</code> å’Œ <code>delete</code> å» ã€è®°å¾—ã€å¯¹èµ„æºè¿›è¡Œé‡Šæ”¾ã€‚è€Œ C++11 å¼•å…¥äº†æ™ºèƒ½æŒ‡é’ˆçš„æ¦‚å¿µï¼Œä½¿ç”¨äº†å¼•ç”¨è®¡æ•°çš„æƒ³æ³•ï¼Œè®©ç¨‹åºå‘˜ä¸å†éœ€è¦å…³å¿ƒæ‰‹åŠ¨é‡Šæ”¾å†…å­˜ã€‚ è¿™äº›æ™ºèƒ½æŒ‡é’ˆåŒ…æ‹¬ <code>std::shared_ptr</code>/<code>std::unique_ptr</code>/<code>std::weak_ptr</code>ï¼Œä½¿ç”¨å®ƒä»¬éœ€è¦åŒ…å«å¤´æ–‡ä»¶ <code>&lt;memory&gt;</code>ã€‚</p><blockquote><p>æ³¨æ„ï¼šå¼•ç”¨è®¡æ•°ä¸æ˜¯åƒåœ¾å›æ”¶ï¼Œå¼•ç”¨è®¡æ•°èƒ½å¤Ÿå°½å¿«æ”¶å›ä¸å†è¢«ä½¿ç”¨çš„å¯¹è±¡ï¼ŒåŒæ—¶åœ¨å›æ”¶çš„è¿‡ç¨‹ä¸­ä¹Ÿä¸ä¼šé€ æˆé•¿æ—¶é—´çš„ç­‰å¾…ï¼Œ æ›´èƒ½å¤Ÿæ¸…æ™°æ˜ç¡®çš„è¡¨æ˜èµ„æºçš„ç”Ÿå‘½å‘¨æœŸã€‚</p></blockquote><h2 id="5-2-std-shared-ptr">5.2 <code>std::shared_ptr</code></h2><p><code>std::shared_ptr</code> æ˜¯ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒèƒ½å¤Ÿè®°å½•å¤šå°‘ä¸ª <code>shared_ptr</code> å…±åŒæŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œæ¶ˆé™¤æ˜¾å¼çš„è°ƒç”¨ <code>delete</code>ï¼Œå½“å¼•ç”¨è®¡æ•°å˜ä¸ºé›¶çš„æ—¶å€™å°±ä¼šå°†å¯¹è±¡è‡ªåŠ¨åˆ é™¤ã€‚</p><p>ä½†è¿˜ä¸å¤Ÿï¼Œå› ä¸ºä½¿ç”¨ <code>std::shared_ptr</code> ä»ç„¶éœ€è¦ä½¿ç”¨ <code>new</code> æ¥è°ƒç”¨ï¼Œè¿™ä½¿å¾—ä»£ç å‡ºç°äº†æŸç§ç¨‹åº¦ä¸Šçš„ä¸å¯¹ç§°ã€‚</p><p><code>std::make_shared</code> å°±èƒ½å¤Ÿç”¨æ¥æ¶ˆé™¤æ˜¾å¼çš„ä½¿ç”¨ <code>new</code>ï¼Œæ‰€ä»¥<code>std::make_shared</code> ä¼šåˆ†é…åˆ›å»ºä¼ å…¥å‚æ•°ä¸­çš„å¯¹è±¡ï¼Œ å¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ç±»å‹çš„<code>std::shared_ptr</code>æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(std::shared_ptr&lt;<span class="type">int</span>&gt; i)</span> </span>&#123;</span><br><span class="line">    (*i)++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// auto pointer = new int(10); // illegal, no direct assignment</span></span><br><span class="line">    <span class="comment">// Constructed a std::shared_ptr</span></span><br><span class="line">    <span class="keyword">auto</span> pointer = std::<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">foo</span>(pointer);</span><br><span class="line">    std::cout &lt;&lt; *pointer &lt;&lt; std::endl; <span class="comment">// 11</span></span><br><span class="line">    <span class="comment">// The shared_ptr will be destructed before leaving the scope</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>std::shared_ptr</code> å¯ä»¥é€šè¿‡ <code>get()</code> æ–¹æ³•æ¥è·å–åŸå§‹æŒ‡é’ˆï¼Œé€šè¿‡ <code>reset()</code> æ¥å‡å°‘ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œ å¹¶é€šè¿‡<code>use_count()</code>æ¥æŸ¥çœ‹ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> pointer = std::<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">auto</span> pointer2 = pointer; <span class="comment">// å¼•ç”¨è®¡æ•°+1</span></span><br><span class="line"><span class="keyword">auto</span> pointer3 = pointer; <span class="comment">// å¼•ç”¨è®¡æ•°+1</span></span><br><span class="line"><span class="type">int</span> *p = pointer.<span class="built_in">get</span>();  <span class="comment">// è¿™æ ·ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer.use_count() = &quot;</span> &lt;&lt; pointer.<span class="built_in">use_count</span>() &lt;&lt; std::endl;   <span class="comment">// 3</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer2.use_count() = &quot;</span> &lt;&lt; pointer2.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 3</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer3.use_count() = &quot;</span> &lt;&lt; pointer3.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line">pointer2.<span class="built_in">reset</span>();</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;reset pointer2:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer.use_count() = &quot;</span> &lt;&lt; pointer.<span class="built_in">use_count</span>() &lt;&lt; std::endl;   <span class="comment">// 2</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer2.use_count() = &quot;</span></span><br><span class="line">          &lt;&lt; pointer2.<span class="built_in">use_count</span>() &lt;&lt; std::endl;           <span class="comment">// pointer2 å·² reset; 0</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer3.use_count() = &quot;</span> &lt;&lt; pointer3.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 2</span></span><br><span class="line">pointer3.<span class="built_in">reset</span>();</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;reset pointer3:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer.use_count() = &quot;</span> &lt;&lt; pointer.<span class="built_in">use_count</span>() &lt;&lt; std::endl;   <span class="comment">// 1</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer2.use_count() = &quot;</span> &lt;&lt; pointer2.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 0</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer3.use_count() = &quot;</span></span><br><span class="line">          &lt;&lt; pointer3.<span class="built_in">use_count</span>() &lt;&lt; std::endl;           <span class="comment">// pointer3 å·² reset; 0</span></span><br></pre></td></tr></table></figure><h2 id="5-3-std-unique-ptr">5.3 <code>std::unique_ptr</code></h2><p><code>std::unique_ptr</code> æ˜¯ä¸€ç§ç‹¬å çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒç¦æ­¢å…¶ä»–æ™ºèƒ½æŒ‡é’ˆä¸å…¶å…±äº«åŒä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œä¿è¯ä»£ç çš„å®‰å…¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::unique_ptr&lt;<span class="type">int</span>&gt; pointer = std::<span class="built_in">make_unique</span>&lt;<span class="type">int</span>&gt;(<span class="number">10</span>); <span class="comment">// make_unique ä» C++14 å¼•å…¥</span></span><br><span class="line">std::unique_ptr&lt;<span class="type">int</span>&gt; pointer2 = pointer; <span class="comment">// éæ³•</span></span><br></pre></td></tr></table></figure><blockquote><p><code>make_unique</code> å¹¶ä¸å¤æ‚ï¼ŒC++11 æ²¡æœ‰æä¾› <code>std::make_unique</code>ï¼Œå¯ä»¥è‡ªè¡Œå®ç°ï¼š</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename T, typename <span class="params">...</span>Args&gt;</span><br><span class="line">std<span class="type">::unique_ptr</span>&lt;T&gt; make_unique( Args&amp;&amp; <span class="params">...</span>args ) &#123;</span><br><span class="line"><span class="keyword">return</span> std<span class="type">::unique_ptr</span>&lt;T&gt;( <span class="literal">new</span> T( std<span class="type">::forward</span>&lt;Args&gt;(args)<span class="params">...</span> ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰æä¾›ï¼ŒC++ æ ‡å‡†å§”å‘˜ä¼šä¸»å¸­ Herb Sutter åœ¨ä»–çš„<a href="https://herbsutter.com/gotw/_102/">åšå®¢</a>ä¸­æåˆ°åŸå› æ˜¯å› ä¸ºã€è¢«ä»–ä»¬å¿˜è®°äº†ã€ã€‚</p></blockquote><p>æ—¢ç„¶æ˜¯ç‹¬å ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ä¸å¯å¤åˆ¶ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>std::move</code> å°†å…¶è½¬ç§»ç»™å…¶ä»–çš„ <code>unique_ptr</code>ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">    <span class="built_in">Foo</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;Foo::Foo&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">    ~<span class="built_in">Foo</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;Foo::~Foo&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;Foo::foo&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">const</span> Foo &amp;)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;f(const Foo&amp;)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;Foo&gt; <span class="title">p1</span><span class="params">(std::make_unique&lt;Foo&gt;())</span></span>;</span><br><span class="line">    <span class="comment">// p1 ä¸ç©º, è¾“å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (p1) p1-&gt;<span class="built_in">foo</span>();</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">std::unique_ptr&lt;Foo&gt; <span class="title">p2</span><span class="params">(std::move(p1))</span></span>;</span><br><span class="line">        <span class="comment">// p2 ä¸ç©º, è¾“å‡º</span></span><br><span class="line">        <span class="built_in">f</span>(*p2);</span><br><span class="line">        <span class="comment">// p2 ä¸ç©º, è¾“å‡º</span></span><br><span class="line">        <span class="keyword">if</span>(p2) p2-&gt;<span class="built_in">foo</span>();</span><br><span class="line">        <span class="comment">// p1 ä¸ºç©º, æ— è¾“å‡º</span></span><br><span class="line">        <span class="keyword">if</span>(p1) p1-&gt;<span class="built_in">foo</span>();</span><br><span class="line">        p1 = std::<span class="built_in">move</span>(p2);</span><br><span class="line">        <span class="comment">// p2 ä¸ºç©º, æ— è¾“å‡º</span></span><br><span class="line">        <span class="keyword">if</span>(p2) p2-&gt;<span class="built_in">foo</span>();</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;p2 è¢«é”€æ¯&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// p1 ä¸ç©º, è¾“å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (p1) p1-&gt;<span class="built_in">foo</span>();</span><br><span class="line">    <span class="comment">// Foo çš„å®ä¾‹ä¼šåœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è¢«é”€æ¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-4-std-weak-ptr">5.4 <code>std::weak_ptr</code></h2><p>å¦‚æœä½ ä»”ç»†æ€è€ƒ <code>std::shared_ptr</code> å°±ä¼šå‘ç°ä¾ç„¶å­˜åœ¨ç€èµ„æºæ— æ³•é‡Šæ”¾çš„é—®é¢˜ã€‚çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">B</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    std::shared_ptr&lt;B&gt; pointer;</span><br><span class="line">    ~<span class="built_in">A</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;A è¢«é”€æ¯&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">B</span> &#123;</span><br><span class="line">    std::shared_ptr&lt;A&gt; pointer;</span><br><span class="line">    ~<span class="built_in">B</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;B è¢«é”€æ¯&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> a = std::<span class="built_in">make_shared</span>&lt;A&gt;();</span><br><span class="line">    <span class="keyword">auto</span> b = std::<span class="built_in">make_shared</span>&lt;B&gt;();</span><br><span class="line">    a-&gt;pointer = b;</span><br><span class="line">    b-&gt;pointer = a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœæ˜¯ A, B éƒ½ä¸ä¼šè¢«é”€æ¯ï¼Œè¿™æ˜¯å› ä¸º a,b å†…éƒ¨çš„ pointer åŒæ—¶åˆå¼•ç”¨äº† <code>a,b</code>ï¼Œè¿™ä½¿å¾— <code>a,b</code> çš„å¼•ç”¨è®¡æ•°å‡å˜ä¸ºäº† 2ï¼Œè€Œç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œ<code>a,b</code> æ™ºèƒ½æŒ‡é’ˆè¢«ææ„ï¼Œå´åªèƒ½é€ æˆè¿™å—åŒºåŸŸçš„å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œè¿™æ ·å°±å¯¼è‡´äº† <code>a,b</code> å¯¹è±¡æŒ‡å‘çš„å†…å­˜åŒºåŸŸå¼•ç”¨è®¡æ•°ä¸ä¸ºé›¶ï¼Œè€Œå¤–éƒ¨å·²ç»æ²¡æœ‰åŠæ³•æ‰¾åˆ°è¿™å—åŒºåŸŸäº†ï¼Œä¹Ÿå°±é€ æˆäº†å†…å­˜æ³„éœ²ï¼Œå¦‚å›¾ 5.1ï¼š</p><p><img src="https://changkun.de/modern-cpp/assets/figures/pointers1.png" alt="å›¾ 5.1">å›¾ 5.1</p><p>è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å°±æ˜¯ä½¿ç”¨å¼±å¼•ç”¨æŒ‡é’ˆ <code>std::weak_ptr</code>ï¼Œ<code>std::weak_ptr</code>æ˜¯ä¸€ç§å¼±å¼•ç”¨ï¼ˆç›¸æ¯”è¾ƒè€Œè¨€ <code>std::shared_ptr</code> å°±æ˜¯ä¸€ç§å¼ºå¼•ç”¨ï¼‰ã€‚å¼±å¼•ç”¨ä¸ä¼šå¼•èµ·å¼•ç”¨è®¡æ•°å¢åŠ ï¼Œå½“æ¢ç”¨å¼±å¼•ç”¨æ—¶å€™ï¼Œæœ€ç»ˆçš„é‡Šæ”¾æµç¨‹å¦‚å›¾ 5.2 æ‰€ç¤ºï¼š</p><p><img src="https://changkun.de/modern-cpp/assets/figures/pointers2.png" alt="å›¾ 5.2">å›¾ 5.2</p><p>åœ¨ä¸Šå›¾ä¸­ï¼Œæœ€åä¸€æ­¥åªå‰©ä¸‹ Bï¼Œè€Œ B å¹¶æ²¡æœ‰ä»»ä½•æ™ºèƒ½æŒ‡é’ˆå¼•ç”¨å®ƒï¼Œå› æ­¤è¿™å—å†…å­˜èµ„æºä¹Ÿä¼šè¢«é‡Šæ”¾ã€‚</p><p><code>std::weak_ptr</code> æ²¡æœ‰ <code>*</code> è¿ç®—ç¬¦å’Œ <code>-&gt;</code> è¿ç®—ç¬¦ï¼Œæ‰€ä»¥ä¸èƒ½å¤Ÿå¯¹èµ„æºè¿›è¡Œæ“ä½œï¼Œå®ƒå¯ä»¥ç”¨äºæ£€æŸ¥ <code>std::shared_ptr</code> æ˜¯å¦å­˜åœ¨ï¼Œå…¶ <code>expired()</code> æ–¹æ³•èƒ½åœ¨èµ„æºæœªè¢«é‡Šæ”¾æ—¶ï¼Œä¼šè¿”å› <code>false</code>ï¼Œå¦åˆ™è¿”å› <code>true</code>ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä¹Ÿå¯ä»¥ç”¨äºè·å–æŒ‡å‘åŸå§‹å¯¹è±¡çš„ <code>std::shared_ptr</code> æŒ‡é’ˆï¼Œå…¶ <code>lock()</code> æ–¹æ³•åœ¨åŸå§‹å¯¹è±¡æœªè¢«é‡Šæ”¾æ—¶ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘åŸå§‹å¯¹è±¡çš„ <code>std::shared_ptr</code> æŒ‡é’ˆï¼Œè¿›è€Œè®¿é—®åŸå§‹å¯¹è±¡çš„èµ„æºï¼Œå¦åˆ™è¿”å›<code>nullptr</code>ã€‚</p><h2 id="æ€»ç»“-4">æ€»ç»“</h2><p>æ™ºèƒ½æŒ‡é’ˆè¿™ç§æŠ€æœ¯å¹¶ä¸æ–°å¥‡ï¼Œåœ¨å¾ˆå¤šè¯­è¨€ä¸­éƒ½æ˜¯ä¸€ç§å¸¸è§çš„æŠ€æœ¯ï¼Œç°ä»£ C++ å°†è¿™é¡¹æŠ€æœ¯å¼•è¿›ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šæ¶ˆé™¤äº† <code>new</code>/<code>delete</code> çš„æ»¥ç”¨ï¼Œæ˜¯ä¸€ç§æ›´åŠ æˆç†Ÿçš„ç¼–ç¨‹èŒƒå¼ã€‚</p><h1>ç¬¬ 6 ç«  æ­£åˆ™è¡¨è¾¾å¼</h1><h2 id="6-1-æ­£åˆ™è¡¨è¾¾å¼ç®€ä»‹">6.1 æ­£åˆ™è¡¨è¾¾å¼ç®€ä»‹</h2><p>æ­£åˆ™è¡¨è¾¾å¼ä¸æ˜¯ C++ è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼Œè¿™é‡Œä»…åšç®€å•çš„ä»‹ç»ã€‚</p><p>æ­£åˆ™è¡¨è¾¾å¼æè¿°äº†ä¸€ç§å­—ç¬¦ä¸²åŒ¹é…çš„æ¨¡å¼ã€‚ä¸€èˆ¬ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä¸»è¦æ˜¯å®ç°ä¸‹é¢ä¸‰ä¸ªéœ€æ±‚ï¼š</p><ol><li>æ£€æŸ¥ä¸€ä¸ªä¸²æ˜¯å¦åŒ…å«æŸç§å½¢å¼çš„å­ä¸²ï¼›</li><li>å°†åŒ¹é…çš„å­ä¸²æ›¿æ¢ï¼›</li><li>ä»æŸä¸ªä¸²ä¸­å–å‡ºç¬¦åˆæ¡ä»¶çš„å­ä¸²ã€‚</li></ol><p>æ­£åˆ™è¡¨è¾¾å¼æ˜¯ç”±æ™®é€šå­—ç¬¦ï¼ˆä¾‹å¦‚ a åˆ° zï¼‰ä»¥åŠç‰¹æ®Šå­—ç¬¦ç»„æˆçš„æ–‡å­—æ¨¡å¼ã€‚æ¨¡å¼æè¿°åœ¨æœç´¢æ–‡æœ¬æ—¶è¦åŒ¹é…çš„ä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ä¸²ã€‚ æ­£åˆ™è¡¨è¾¾å¼ä½œä¸ºä¸€ä¸ªæ¨¡æ¿ï¼Œå°†æŸä¸ªå­—ç¬¦æ¨¡å¼ä¸æ‰€æœç´¢çš„å­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…ã€‚</p><h3 id="æ™®é€šå­—ç¬¦">æ™®é€šå­—ç¬¦</h3><p>æ™®é€šå­—ç¬¦åŒ…æ‹¬æ²¡æœ‰æ˜¾å¼æŒ‡å®šä¸ºå…ƒå­—ç¬¦çš„æ‰€æœ‰å¯æ‰“å°å’Œä¸å¯æ‰“å°å­—ç¬¦ã€‚è¿™åŒ…æ‹¬æ‰€æœ‰å¤§å†™å’Œå°å†™å­—æ¯ã€æ‰€æœ‰æ•°å­—ã€æ‰€æœ‰æ ‡ç‚¹ç¬¦å·å’Œä¸€äº›å…¶ä»–ç¬¦å·ã€‚</p><h3 id="ç‰¹æ®Šå­—ç¬¦">ç‰¹æ®Šå­—ç¬¦</h3><p>ç‰¹æ®Šå­—ç¬¦æ˜¯æ­£åˆ™è¡¨è¾¾å¼é‡Œæœ‰ç‰¹æ®Šå«ä¹‰çš„å­—ç¬¦ï¼Œä¹Ÿæ˜¯æ­£åˆ™è¡¨è¾¾å¼çš„æ ¸å¿ƒåŒ¹é…è¯­æ³•ã€‚å‚è§ä¸‹è¡¨ï¼š</p><table><thead><tr><th style="text-align:left">ç‰¹åˆ«å­—ç¬¦</th><th style="text-align:left">æè¿°</th></tr></thead><tbody><tr><td style="text-align:left"><code>$</code></td><td style="text-align:left">åŒ¹é…è¾“å…¥å­—ç¬¦ä¸²çš„ç»“å°¾ä½ç½®ã€‚</td></tr><tr><td style="text-align:left"><code>(</code>,<code>)</code></td><td style="text-align:left">æ ‡è®°ä¸€ä¸ªå­è¡¨è¾¾å¼çš„å¼€å§‹å’Œç»“æŸä½ç½®ã€‚å­è¡¨è¾¾å¼å¯ä»¥è·å–ä¾›ä»¥åä½¿ç”¨ã€‚</td></tr><tr><td style="text-align:left"><code>*</code></td><td style="text-align:left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–å¤šæ¬¡ã€‚</td></tr><tr><td style="text-align:left"><code>+</code></td><td style="text-align:left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼ä¸€æ¬¡æˆ–å¤šæ¬¡ã€‚</td></tr><tr><td style="text-align:left"><code>.</code></td><td style="text-align:left">åŒ¹é…é™¤æ¢è¡Œç¬¦ <code>\n</code> ä¹‹å¤–çš„ä»»ä½•å•å­—ç¬¦ã€‚</td></tr><tr><td style="text-align:left"><code>[</code></td><td style="text-align:left">æ ‡è®°ä¸€ä¸ªä¸­æ‹¬å·è¡¨è¾¾å¼çš„å¼€å§‹ã€‚</td></tr><tr><td style="text-align:left"><code>?</code></td><td style="text-align:left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–ä¸€æ¬¡ï¼Œæˆ–æŒ‡æ˜ä¸€ä¸ªéè´ªå©ªé™å®šç¬¦ã€‚</td></tr><tr><td style="text-align:left"><code>\</code></td><td style="text-align:left">å°†ä¸‹ä¸€ä¸ªå­—ç¬¦æ ‡è®°ä¸ºæˆ–ç‰¹æ®Šå­—ç¬¦ã€æˆ–åŸä¹‰å­—ç¬¦ã€æˆ–å‘åå¼•ç”¨ã€æˆ–å…«è¿›åˆ¶è½¬ä¹‰ç¬¦ã€‚ä¾‹å¦‚ï¼Œ <code>n</code> åŒ¹é…å­—ç¬¦ <code>n</code>ã€‚<code>\n</code> åŒ¹é…æ¢è¡Œç¬¦ã€‚åºåˆ— <code>\\</code> åŒ¹é… <code>'\'</code> å­—ç¬¦ï¼Œè€Œ <code>\(</code> åˆ™åŒ¹é… <code>'('</code> å­—ç¬¦ã€‚</td></tr><tr><td style="text-align:left"><code>^</code></td><td style="text-align:left">åŒ¹é…è¾“å…¥å­—ç¬¦ä¸²çš„å¼€å§‹ä½ç½®ï¼Œé™¤éåœ¨æ–¹æ‹¬å·è¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼Œæ­¤æ—¶å®ƒè¡¨ç¤ºä¸æ¥å—è¯¥å­—ç¬¦é›†åˆã€‚</td></tr><tr><td style="text-align:left"><code>&#123;</code></td><td style="text-align:left">æ ‡è®°é™å®šç¬¦è¡¨è¾¾å¼çš„å¼€å§‹ã€‚</td></tr><tr><td style="text-align:left">`</td><td style="text-align:left">`</td></tr></tbody></table><h3 id="é™å®šç¬¦">é™å®šç¬¦</h3><p>é™å®šç¬¦ç”¨æ¥æŒ‡å®šæ­£åˆ™è¡¨è¾¾å¼çš„ä¸€ä¸ªç»™å®šçš„ç»„ä»¶å¿…é¡»è¦å‡ºç°å¤šå°‘æ¬¡æ‰èƒ½æ»¡è¶³åŒ¹é…ã€‚è§ä¸‹è¡¨ï¼š</p><table><thead><tr><th style="text-align:left">å­—ç¬¦</th><th style="text-align:left">æè¿°</th></tr></thead><tbody><tr><td style="text-align:left"><code>*</code></td><td style="text-align:left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–å¤šæ¬¡ã€‚ä¾‹å¦‚ï¼Œ<code>foo*</code> èƒ½åŒ¹é… <code>fo</code> ä»¥åŠ <code>foooo</code>ã€‚<code>*</code> ç­‰ä»·äº<code>&#123;0,&#125;</code>ã€‚</td></tr><tr><td style="text-align:left"><code>+</code></td><td style="text-align:left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼ä¸€æ¬¡æˆ–å¤šæ¬¡ã€‚ä¾‹å¦‚ï¼Œ<code>foo+</code> èƒ½åŒ¹é… <code>foo</code> ä»¥åŠ <code>foooo</code>ï¼Œä½†ä¸èƒ½åŒ¹é… <code>fo</code>ã€‚<code>+</code> ç­‰ä»·äº <code>&#123;1,&#125;</code>ã€‚</td></tr><tr><td style="text-align:left"><code>?</code></td><td style="text-align:left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–ä¸€æ¬¡ã€‚ä¾‹å¦‚ï¼Œ<code>Your(s)?</code> å¯ä»¥åŒ¹é… <code>Your</code> æˆ– <code>Yours</code> ä¸­çš„<code>Your</code> ã€‚<code>?</code> ç­‰ä»·äº <code>&#123;0,1&#125;</code>ã€‚</td></tr><tr><td style="text-align:left"><code>&#123;n&#125;</code></td><td style="text-align:left"><code>n</code> æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚åŒ¹é…ç¡®å®šçš„ <code>n</code> æ¬¡ã€‚ä¾‹å¦‚ï¼Œ<code>o&#123;2&#125;</code> ä¸èƒ½åŒ¹é… <code>for</code> ä¸­çš„ <code>o</code>ï¼Œä½†æ˜¯èƒ½åŒ¹é… <code>foo</code> ä¸­çš„ä¸¤ä¸ª <code>o</code>ã€‚</td></tr><tr><td style="text-align:left"><code>&#123;n,&#125;</code></td><td style="text-align:left"><code>n</code> æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚è‡³å°‘åŒ¹é… <code>n</code> æ¬¡ã€‚ä¾‹å¦‚ï¼Œ<code>o&#123;2,&#125;</code> ä¸èƒ½åŒ¹é… <code>for</code> ä¸­çš„ <code>o</code>ï¼Œä½†èƒ½åŒ¹é… <code>foooooo</code> ä¸­çš„æ‰€æœ‰ <code>o</code>ã€‚<code>o&#123;1,&#125;</code> ç­‰ä»·äº <code>o+</code>ã€‚<code>o&#123;0,&#125;</code> åˆ™ç­‰ä»·äº <code>o*</code>ã€‚</td></tr><tr><td style="text-align:left"><code>&#123;n,m&#125;</code></td><td style="text-align:left"><code>m</code> å’Œ <code>n</code> å‡ä¸ºéè´Ÿæ•´æ•°ï¼Œå…¶ä¸­ <code>n</code> å°äºç­‰äº <code>m</code>ã€‚æœ€å°‘åŒ¹é… <code>n</code> æ¬¡ä¸”æœ€å¤šåŒ¹é… <code>m</code> æ¬¡ã€‚ä¾‹å¦‚ï¼Œ<code>o&#123;1,3&#125;</code> å°†åŒ¹é… <code>foooooo</code> ä¸­çš„å‰ä¸‰ä¸ª <code>o</code>ã€‚<code>o&#123;0,1&#125;</code> ç­‰ä»·äº <code>o?</code>ã€‚æ³¨æ„ï¼Œåœ¨é€—å·å’Œä¸¤ä¸ªæ•°ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼ã€‚</td></tr></tbody></table><p>æœ‰äº†è¿™ä¸¤å¼ è¡¨ï¼Œæˆ‘ä»¬é€šå¸¸å°±èƒ½å¤Ÿè¯»æ‡‚å‡ ä¹æ‰€æœ‰çš„æ­£åˆ™è¡¨è¾¾å¼äº†ã€‚</p><h2 id="6-2-std-regex-åŠå…¶ç›¸å…³">6.2 std::regex åŠå…¶ç›¸å…³</h2><p>å¯¹å­—ç¬¦ä¸²å†…å®¹è¿›è¡ŒåŒ¹é…çš„æœ€å¸¸è§æ‰‹æ®µå°±æ˜¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€‚ å¯æƒœåœ¨ä¼ ç»Ÿ C++ ä¸­æ­£åˆ™è¡¨è¾¾å¼ä¸€ç›´æ²¡æœ‰å¾—åˆ°è¯­è¨€å±‚é¢çš„æ”¯æŒï¼Œæ²¡æœ‰çº³å…¥æ ‡å‡†åº“ï¼Œ è€Œ C++ ä½œä¸ºä¸€é—¨é«˜æ€§èƒ½è¯­è¨€ï¼Œåœ¨åå°æœåŠ¡çš„å¼€å‘ä¸­ï¼Œå¯¹ URL èµ„æºé“¾æ¥è¿›è¡Œåˆ¤æ–­æ—¶ï¼Œ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä¹Ÿæ˜¯å·¥ä¸šç•Œæœ€ä¸ºæˆç†Ÿçš„æ™®éåšæ³•ã€‚</p><p>ä¸€èˆ¬çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ <code>boost</code> çš„æ­£åˆ™è¡¨è¾¾å¼åº“ã€‚ è€Œ C++11 æ­£å¼å°†æ­£åˆ™è¡¨è¾¾å¼çš„çš„å¤„ç†æ–¹æ³•çº³å…¥æ ‡å‡†åº“çš„è¡Œåˆ—ï¼Œä»è¯­è¨€çº§ä¸Šæä¾›äº†æ ‡å‡†çš„æ”¯æŒï¼Œ ä¸å†ä¾èµ–ç¬¬ä¸‰æ–¹ã€‚</p><p>C++11 æä¾›çš„æ­£åˆ™è¡¨è¾¾å¼åº“æ“ä½œ <code>std::string</code> å¯¹è±¡ï¼Œ æ¨¡å¼ <code>std::regex</code> (æœ¬è´¨æ˜¯ <code>std::basic_regex</code>)è¿›è¡Œåˆå§‹åŒ–ï¼Œ é€šè¿‡ <code>std::regex_match</code> è¿›è¡ŒåŒ¹é…ï¼Œ ä»è€Œäº§ç”Ÿ <code>std::smatch</code> ï¼ˆæœ¬è´¨æ˜¯ <code>std::match_results</code> å¯¹è±¡ï¼‰ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç®€å•ä»‹ç»è¿™ä¸ªåº“çš„ä½¿ç”¨ã€‚è€ƒè™‘ä¸‹é¢çš„æ­£åˆ™è¡¨è¾¾å¼:</p><ul><li><code>[a-z]+\.txt</code>: åœ¨è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¸­, <code>[a-z]</code> è¡¨ç¤ºåŒ¹é…ä¸€ä¸ªå°å†™å­—æ¯, <code>+</code> å¯ä»¥ä½¿å‰é¢çš„è¡¨è¾¾å¼åŒ¹é…å¤šæ¬¡ï¼Œ å› æ­¤ <code>[a-z]+</code> èƒ½å¤ŸåŒ¹é…ä¸€ä¸ªå°å†™å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²ã€‚ åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ä¸€ä¸ª <code>.</code> è¡¨ç¤ºåŒ¹é…ä»»æ„å­—ç¬¦ï¼Œè€Œ <code>\.</code> åˆ™è¡¨ç¤ºåŒ¹é…å­—ç¬¦ <code>.</code>ï¼Œ æœ€åçš„ <code>txt</code> è¡¨ç¤ºä¸¥æ ¼åŒ¹é… <code>txt</code> åˆ™ä¸‰ä¸ªå­—æ¯ã€‚å› æ­¤è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„æ‰€è¦åŒ¹é…çš„å†…å®¹å°±æ˜¯ç”±çº¯å°å†™å­—æ¯ç»„æˆçš„æ–‡æœ¬æ–‡ä»¶ã€‚</li></ul><p><code>std::regex_match</code> ç”¨äºåŒ¹é…å­—ç¬¦ä¸²å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œæœ‰å¾ˆå¤šä¸åŒçš„é‡è½½å½¢å¼ã€‚ æœ€ç®€å•çš„ä¸€ä¸ªå½¢å¼å°±æ˜¯ä¼ å…¥ <code>std::string</code> ä»¥åŠä¸€ä¸ª <code>std::regex</code> è¿›è¡ŒåŒ¹é…ï¼Œ å½“åŒ¹é…æˆåŠŸæ—¶ï¼Œä¼šè¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å› <code>false</code>ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;regex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::string fnames[] = &#123;<span class="string">&quot;foo.txt&quot;</span>, <span class="string">&quot;bar.txt&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;a0.txt&quot;</span>, <span class="string">&quot;AAA.txt&quot;</span>&#125;;</span><br><span class="line">    <span class="comment">// åœ¨ C++ ä¸­ \ ä¼šè¢«ä½œä¸ºå­—ç¬¦ä¸²å†…çš„è½¬ä¹‰ç¬¦ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä¸ºä½¿ \. ä½œä¸ºæ­£åˆ™è¡¨è¾¾å¼ä¼ é€’è¿›å»ç”Ÿæ•ˆï¼Œéœ€è¦å¯¹ \ è¿›è¡ŒäºŒæ¬¡è½¬ä¹‰ï¼Œä»è€Œæœ‰ \\.</span></span><br><span class="line">    <span class="function">std::regex <span class="title">txt_regex</span><span class="params">(<span class="string">&quot;[a-z]+\\.txt&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;fname: fnames)</span><br><span class="line">        std::cout &lt;&lt; fname &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; std::<span class="built_in">regex_match</span>(fname, txt_regex) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§å¸¸ç”¨çš„å½¢å¼å°±æ˜¯ä¾æ¬¡ä¼ å…¥ <code>std::string</code>/<code>std::smatch</code>/<code>std::regex</code> ä¸‰ä¸ªå‚æ•°ï¼Œ å…¶ä¸­ <code>std::smatch</code> çš„æœ¬è´¨å…¶å®æ˜¯ <code>std::match_results</code>ã€‚ æ•…è€Œåœ¨æ ‡å‡†åº“çš„å®ç°ä¸­ï¼Œ <code>std::smatch</code> è¢«å®šä¹‰ä¸ºäº† <code>std::match_results&lt;std::string::const_iterator&gt;</code>ï¼Œ ä¹Ÿå°±æ˜¯ä¸€ä¸ªå­ä¸²è¿­ä»£å™¨ç±»å‹çš„ <code>match_results</code>ã€‚ ä½¿ç”¨ <code>std::smatch</code> å¯ä»¥æ–¹ä¾¿çš„å¯¹åŒ¹é…çš„ç»“æœè¿›è¡Œè·å–ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">std::regex <span class="built_in">base_regex</span>(<span class="string">&quot;([a-z]+)\\.txt&quot;</span>);</span><br><span class="line">std::smatch base_match;</span><br><span class="line">for(const auto &amp;fname: fnames) &#123;</span><br><span class="line">    if (std::<span class="built_in">regex_match</span>(fname, base_match, base_regex)) &#123;</span><br><span class="line">        // std::smatch çš„ç¬¬ä¸€ä¸ªå…ƒç´ åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸²</span><br><span class="line">        // std::smatch çš„ç¬¬äºŒä¸ªå…ƒç´ åŒ¹é…äº†ç¬¬ä¸€ä¸ªæ‹¬å·è¡¨è¾¾å¼</span><br><span class="line">        if (base_match.<span class="built_in">size</span>() == <span class="number">2</span>) &#123;</span><br><span class="line">            std::string base = base_match[<span class="number">1</span>].<span class="built_in">str</span>();</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;sub-match[0]: &quot;</span> &lt;&lt; base_match[<span class="number">0</span>].<span class="built_in">str</span>() &lt;&lt; std::endl;</span><br><span class="line">            std::cout &lt;&lt; fname &lt;&lt; <span class="string">&quot; sub-match[1]: &quot;</span> &lt;&lt; base &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸¤ä¸ªä»£ç æ®µçš„è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">foo<span class="selector-class">.txt</span>: <span class="number">1</span></span><br><span class="line">bar<span class="selector-class">.txt</span>: <span class="number">1</span></span><br><span class="line">test: <span class="number">0</span></span><br><span class="line">a0<span class="selector-class">.txt</span>: <span class="number">0</span></span><br><span class="line">AAA<span class="selector-class">.txt</span>: <span class="number">0</span></span><br><span class="line">sub-match<span class="selector-attr">[0]</span>: foo<span class="selector-class">.txt</span></span><br><span class="line">foo<span class="selector-class">.txt</span> sub-match<span class="selector-attr">[1]</span>: foo</span><br><span class="line">sub-match<span class="selector-attr">[0]</span>: bar<span class="selector-class">.txt</span></span><br><span class="line">bar<span class="selector-class">.txt</span> sub-match<span class="selector-attr">[1]</span>: bar</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“-5">æ€»ç»“</h2><p>æœ¬èŠ‚ç®€å•ä»‹ç»äº†æ­£åˆ™è¡¨è¾¾å¼æœ¬èº«ï¼Œç„¶åæ ¹æ®ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„ä¸»è¦éœ€æ±‚ï¼Œé€šè¿‡ä¸€ä¸ªå®é™…çš„ä¾‹å­ä»‹ç»äº†æ­£åˆ™è¡¨è¾¾å¼åº“çš„ä½¿ç”¨ã€‚</p><h1>ç¬¬ 7 ç«  å¹¶è¡Œä¸å¹¶å‘</h1><h2 id="7-1-å¹¶è¡ŒåŸºç¡€">7.1 å¹¶è¡ŒåŸºç¡€</h2><p><code>std::thread</code> ç”¨äºåˆ›å»ºä¸€ä¸ªæ‰§è¡Œçš„çº¿ç¨‹å®ä¾‹ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€åˆ‡å¹¶å‘ç¼–ç¨‹çš„åŸºç¡€ï¼Œä½¿ç”¨æ—¶éœ€è¦åŒ…å« <code>&lt;thread&gt;</code> å¤´æ–‡ä»¶ï¼Œ å®ƒæä¾›äº†å¾ˆå¤šåŸºæœ¬çš„çº¿ç¨‹æ“ä½œï¼Œä¾‹å¦‚ <code>get_id()</code> æ¥è·å–æ‰€åˆ›å»ºçº¿ç¨‹çš„çº¿ç¨‹ IDï¼Œä½¿ç”¨ <code>join()</code> æ¥ç­‰å¾…ä¸€ä¸ªçº¿ç¨‹ç»“æŸï¼ˆä¸è¯¥çº¿ç¨‹æ±‡åˆï¼‰ç­‰ç­‰ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">([]()&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        std::cout &lt;&lt; <span class="string">&quot;hello world.&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-2-äº’æ–¥é‡ä¸ä¸´ç•ŒåŒº">7.2 äº’æ–¥é‡ä¸ä¸´ç•ŒåŒº</h2><p>æˆ‘ä»¬åœ¨æ“ä½œç³»ç»Ÿã€äº¦æˆ–æ˜¯æ•°æ®åº“çš„ç›¸å…³çŸ¥è¯†ä¸­å·²ç»äº†è§£è¿‡äº†æœ‰å…³å¹¶å‘æŠ€æœ¯çš„åŸºæœ¬çŸ¥è¯†ï¼Œ<code>mutex</code> å°±æ˜¯å…¶ä¸­çš„æ ¸å¿ƒä¹‹ä¸€ã€‚ C++11 å¼•å…¥äº† <code>mutex</code> ç›¸å…³çš„ç±»ï¼Œå…¶æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½æ”¾åœ¨ <code>&lt;mutex&gt;</code> å¤´æ–‡ä»¶ä¸­ã€‚</p><p><code>std::mutex</code> æ˜¯ C++11 ä¸­æœ€åŸºæœ¬çš„ <code>mutex</code> ç±»ï¼Œé€šè¿‡å®ä¾‹åŒ– <code>std::mutex</code> å¯ä»¥åˆ›å»ºäº’æ–¥é‡ï¼Œ è€Œé€šè¿‡å…¶æˆå‘˜å‡½æ•° <code>lock()</code> å¯ä»¥è¿›è¡Œä¸Šé”ï¼Œ<code>unlock()</code> å¯ä»¥è¿›è¡Œè§£é”ã€‚ ä½†æ˜¯åœ¨å®é™…ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å¥½ä¸å»ç›´æ¥è°ƒç”¨æˆå‘˜å‡½æ•°ï¼Œ å› ä¸ºè°ƒç”¨æˆå‘˜å‡½æ•°å°±éœ€è¦åœ¨æ¯ä¸ªä¸´ç•ŒåŒºçš„å‡ºå£å¤„è°ƒç”¨ <code>unlock()</code>ï¼Œå½“ç„¶ï¼Œè¿˜åŒ…æ‹¬å¼‚å¸¸ã€‚ è¿™æ—¶å€™ C++11 è¿˜ä¸ºäº’æ–¥é‡æä¾›äº†ä¸€ä¸ª RAII è¯­æ³•çš„æ¨¡æ¿ç±» <code>std::lock_guard</code>ã€‚ RAII åœ¨ä¸å¤±ä»£ç ç®€æ´æ€§çš„åŒæ—¶ï¼Œå¾ˆå¥½çš„ä¿è¯äº†ä»£ç çš„å¼‚å¸¸å®‰å…¨æ€§ã€‚</p><p>åœ¨ RAII ç”¨æ³•ä¸‹ï¼Œå¯¹äºä¸´ç•ŒåŒºçš„äº’æ–¥é‡çš„åˆ›å»ºåªéœ€è¦åœ¨ä½œç”¨åŸŸçš„å¼€å§‹éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> v = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">critical_section</span><span class="params">(<span class="type">int</span> change_v)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> std::mutex mtx;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œç«äº‰æ“ä½œ</span></span><br><span class="line">    v = change_v;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¦»å¼€æ­¤ä½œç”¨åŸŸå mtx ä¼šè¢«é‡Šæ”¾</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(critical_section, <span class="number">2</span>)</span>, <span class="title">t2</span><span class="params">(critical_section, <span class="number">3</span>)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; v &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äº C++ ä¿è¯äº†æ‰€æœ‰æ ˆå¯¹è±¡åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ä¼šè¢«é”€æ¯ï¼Œæ‰€ä»¥è¿™æ ·çš„ä»£ç ä¹Ÿæ˜¯å¼‚å¸¸å®‰å…¨çš„ã€‚ æ— è®º <code>critical_section()</code> æ­£å¸¸è¿”å›ã€è¿˜æ˜¯åœ¨ä¸­é€”æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½ä¼šå¼•å‘å †æ ˆå›é€€ï¼Œä¹Ÿå°±è‡ªåŠ¨è°ƒç”¨äº† <code>unlock()</code>ã€‚</p><p>è€Œ <code>std::unique_lock</code> åˆ™æ˜¯ç›¸å¯¹äº <code>std::lock_guard</code> å‡ºç°çš„ï¼Œ<code>std::unique_lock</code> æ›´åŠ çµæ´»ï¼Œ <code>std::unique_lock</code> çš„å¯¹è±¡ä¼šä»¥ç‹¬å æ‰€æœ‰æƒï¼ˆæ²¡æœ‰å…¶ä»–çš„ <code>unique_lock</code> å¯¹è±¡åŒæ—¶æ‹¥æœ‰æŸä¸ª <code>mutex</code> å¯¹è±¡çš„æ‰€æœ‰æƒï¼‰ çš„æ–¹å¼ç®¡ç† <code>mutex</code> å¯¹è±¡ä¸Šçš„ä¸Šé”å’Œè§£é”çš„æ“ä½œã€‚æ‰€ä»¥åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæ¨èä½¿ç”¨ <code>std::unique_lock</code>ã€‚</p><p><code>std::lock_guard</code> ä¸èƒ½æ˜¾å¼çš„è°ƒç”¨ <code>lock</code> å’Œ <code>unlock</code>ï¼Œ è€Œ <code>std::unique_lock</code> å¯ä»¥åœ¨å£°æ˜åçš„ä»»æ„ä½ç½®è°ƒç”¨ï¼Œ å¯ä»¥ç¼©å°é”çš„ä½œç”¨èŒƒå›´ï¼Œæä¾›æ›´é«˜çš„å¹¶å‘åº¦ã€‚</p><p>å¦‚æœä½ ç”¨åˆ°äº†æ¡ä»¶å˜é‡ <code>std::condition_variable::wait</code> åˆ™å¿…é¡»ä½¿ç”¨ <code>std::unique_lock</code> ä½œä¸ºå‚æ•°ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> v = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">critical_section</span><span class="params">(<span class="type">int</span> change_v)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> std::mutex mtx;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œç«äº‰æ“ä½œ</span></span><br><span class="line">    v = change_v;</span><br><span class="line">    std::cout &lt;&lt; v &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// å°†é”è¿›è¡Œé‡Šæ”¾</span></span><br><span class="line">    lock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ­¤æœŸé—´ï¼Œä»»ä½•äººéƒ½å¯ä»¥æŠ¢å¤º v çš„æŒæœ‰æƒ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹å¦ä¸€ç»„ç«äº‰æ“ä½œï¼Œå†æ¬¡åŠ é”</span></span><br><span class="line">    lock.<span class="built_in">lock</span>();</span><br><span class="line">    v += <span class="number">1</span>;</span><br><span class="line">    std::cout &lt;&lt; v &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(critical_section, <span class="number">2</span>)</span>, <span class="title">t2</span><span class="params">(critical_section, <span class="number">3</span>)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-3-æœŸç‰©">7.3 æœŸç‰©</h2><p>æœŸç‰©ï¼ˆFutureï¼‰è¡¨ç°ä¸º <code>std::future</code>ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªè®¿é—®å¼‚æ­¥æ“ä½œç»“æœçš„é€”å¾„ï¼Œè¿™å¥è¯å¾ˆä¸å¥½ç†è§£ã€‚ ä¸ºäº†ç†è§£è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£ä¸€ä¸‹åœ¨ C++11 ä¹‹å‰çš„å¤šçº¿ç¨‹è¡Œä¸ºã€‚</p><p>è¯•æƒ³ï¼Œå¦‚æœæˆ‘ä»¬çš„ä¸»çº¿ç¨‹ A å¸Œæœ›æ–°å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹ B å»æ‰§è¡ŒæŸä¸ªæˆ‘ä»¬é¢„æœŸçš„ä»»åŠ¡ï¼Œå¹¶è¿”å›æˆ‘ä¸€ä¸ªç»“æœã€‚ è€Œè¿™æ—¶å€™ï¼Œçº¿ç¨‹ A å¯èƒ½æ­£åœ¨å¿™å…¶ä»–çš„äº‹æƒ…ï¼Œæ— æš‡é¡¾åŠ B çš„ç»“æœï¼Œ æ‰€ä»¥æˆ‘ä»¬ä¼šå¾ˆè‡ªç„¶çš„å¸Œæœ›èƒ½å¤Ÿåœ¨æŸä¸ªç‰¹å®šçš„æ—¶é—´è·å¾—çº¿ç¨‹ B çš„ç»“æœã€‚</p><p>åœ¨ C++11 çš„ <code>std::future</code> è¢«å¼•å…¥ä¹‹å‰ï¼Œé€šå¸¸çš„åšæ³•æ˜¯ï¼š åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ Aï¼Œåœ¨çº¿ç¨‹ A é‡Œå¯åŠ¨ä»»åŠ¡ Bï¼Œå½“å‡†å¤‡å®Œæ¯•åå‘é€ä¸€ä¸ªäº‹ä»¶ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨å…¨å±€å˜é‡ä¸­ã€‚ è€Œä¸»å‡½æ•°çº¿ç¨‹ A é‡Œæ­£åœ¨åšå…¶ä»–çš„äº‹æƒ…ï¼Œå½“éœ€è¦ç»“æœçš„æ—¶å€™ï¼Œè°ƒç”¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å‡½æ•°æ¥è·å¾—æ‰§è¡Œçš„ç»“æœã€‚</p><p>è€Œ C++11 æä¾›çš„ <code>std::future</code> ç®€åŒ–äº†è¿™ä¸ªæµç¨‹ï¼Œå¯ä»¥ç”¨æ¥è·å–å¼‚æ­¥ä»»åŠ¡çš„ç»“æœã€‚ è‡ªç„¶åœ°ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½å¤Ÿæƒ³è±¡åˆ°æŠŠå®ƒä½œä¸ºä¸€ç§ç®€å•çš„çº¿ç¨‹åŒæ­¥æ‰‹æ®µï¼Œå³å±éšœï¼ˆbarrierï¼‰ã€‚</p><p>ä¸ºäº†çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬è¿™é‡Œé¢å¤–ä½¿ç”¨ <code>std::packaged_task</code>ï¼Œå®ƒå¯ä»¥ç”¨æ¥å°è£…ä»»ä½•å¯ä»¥è°ƒç”¨çš„ç›®æ ‡ï¼Œä»è€Œç”¨äºå®ç°å¼‚æ­¥çš„è°ƒç”¨ã€‚ ä¸¾ä¾‹æ¥è¯´ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°†ä¸€ä¸ªè¿”å›å€¼ä¸º7çš„ lambda è¡¨è¾¾å¼å°è£…åˆ° task ä¸­</span></span><br><span class="line">    <span class="comment">// std::packaged_task çš„æ¨¡æ¿å‚æ•°ä¸ºè¦å°è£…å‡½æ•°çš„ç±»å‹</span></span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">()</span>&gt; <span class="title">task</span><span class="params">([]()&#123;<span class="keyword">return</span> <span class="number">7</span>;&#125;)</span></span>;</span><br><span class="line">    <span class="comment">// è·å¾— task çš„æœŸç‰©</span></span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; result = task.<span class="built_in">get_future</span>(); <span class="comment">// åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ task</span></span><br><span class="line">    std::<span class="built_in">thread</span>(std::<span class="built_in">move</span>(task)).<span class="built_in">detach</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;waiting...&quot;</span>;</span><br><span class="line">    result.<span class="built_in">wait</span>(); <span class="comment">// åœ¨æ­¤è®¾ç½®å±éšœï¼Œé˜»å¡åˆ°æœŸç‰©çš„å®Œæˆ</span></span><br><span class="line">    <span class="comment">// è¾“å‡ºæ‰§è¡Œç»“æœ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;done!&quot;</span> &lt;&lt; std:: endl &lt;&lt; <span class="string">&quot;future result is &quot;</span></span><br><span class="line">              &lt;&lt; result.<span class="built_in">get</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å°è£…å¥½è¦è°ƒç”¨çš„ç›®æ ‡åï¼Œå¯ä»¥ä½¿ç”¨ <code>get_future()</code> æ¥è·å¾—ä¸€ä¸ª <code>std::future</code> å¯¹è±¡ï¼Œä»¥ä¾¿ä¹‹åå®æ–½çº¿ç¨‹åŒæ­¥ã€‚</p><h2 id="7-4-æ¡ä»¶å˜é‡">7.4 æ¡ä»¶å˜é‡</h2><p>æ¡ä»¶å˜é‡ <code>std::condition_variable</code> æ˜¯ä¸ºäº†è§£å†³æ­»é”è€Œç”Ÿï¼Œå½“äº’æ–¥æ“ä½œä¸å¤Ÿç”¨è€Œå¼•å…¥çš„ã€‚ æ¯”å¦‚ï¼Œçº¿ç¨‹å¯èƒ½éœ€è¦ç­‰å¾…æŸä¸ªæ¡ä»¶ä¸ºçœŸæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œ è€Œä¸€ä¸ªå¿™ç­‰å¾…å¾ªç¯ä¸­å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰å…¶ä»–çº¿ç¨‹éƒ½æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºä½¿å¾—æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­»é”ã€‚ æ‰€ä»¥ï¼Œ<code>condition_variable</code> å®ä¾‹è¢«åˆ›å»ºå‡ºç°ä¸»è¦å°±æ˜¯ç”¨äºå”¤é†’ç­‰å¾…çº¿ç¨‹ä»è€Œé¿å…æ­»é”ã€‚ <code>std::condition_variable</code>çš„ <code>notify_one()</code> ç”¨äºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼› <code>notify_all()</code> åˆ™æ˜¯é€šçŸ¥æ‰€æœ‰çº¿ç¨‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::queue&lt;<span class="type">int</span>&gt; produced_nums;</span><br><span class="line">    std::mutex mtx;</span><br><span class="line">    std::condition_variable cv;</span><br><span class="line">    <span class="type">bool</span> notified = <span class="literal">false</span>;  <span class="comment">// é€šçŸ¥ä¿¡å·</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿäº§è€…</span></span><br><span class="line">    <span class="keyword">auto</span> producer = [&amp;]() &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; ; i++) &#123;</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">900</span>));</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;producing &quot;</span> &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">            produced_nums.<span class="built_in">push</span>(i);</span><br><span class="line">            notified = <span class="literal">true</span>;</span><br><span class="line">            cv.<span class="built_in">notify_all</span>(); <span class="comment">// æ­¤å¤„ä¹Ÿå¯ä»¥ä½¿ç”¨ notify_one</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// æ¶ˆè´¹è€…</span></span><br><span class="line">    <span class="keyword">auto</span> consumer = [&amp;]() &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            std::unique_lock&lt;std::mutex&gt; <span class="built_in">lock</span>(mtx);</span><br><span class="line">            <span class="keyword">while</span> (!notified) &#123;  <span class="comment">// é¿å…è™šå‡å”¤é†’</span></span><br><span class="line">                cv.<span class="built_in">wait</span>(lock);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// çŸ­æš‚å–æ¶ˆé”ï¼Œä½¿å¾—ç”Ÿäº§è€…æœ‰æœºä¼šåœ¨æ¶ˆè´¹è€…æ¶ˆè´¹ç©ºå‰ç»§ç»­ç”Ÿäº§</span></span><br><span class="line">            lock.<span class="built_in">unlock</span>();</span><br><span class="line">            <span class="comment">// æ¶ˆè´¹è€…æ…¢äºç”Ÿäº§è€…</span></span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span>));</span><br><span class="line">            lock.<span class="built_in">lock</span>();</span><br><span class="line">            <span class="keyword">while</span> (!produced_nums.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;consuming &quot;</span> &lt;&lt; produced_nums.<span class="built_in">front</span>() &lt;&lt; std::endl;</span><br><span class="line">                produced_nums.<span class="built_in">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            notified = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†åˆ«åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¿è¡Œ</span></span><br><span class="line">    <span class="function">std::thread <span class="title">p</span><span class="params">(producer)</span></span>;</span><br><span class="line">    std::thread cs[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">        cs[i] = std::<span class="built_in">thread</span>(consumer);</span><br><span class="line">    &#125;</span><br><span class="line">    p.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">        cs[i].<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ç”Ÿäº§è€…ä¸­æˆ‘ä»¬è™½ç„¶å¯ä»¥ä½¿ç”¨ <code>notify_one()</code>ï¼Œä½†å®é™…ä¸Šå¹¶ä¸å»ºè®®åœ¨æ­¤å¤„ä½¿ç”¨ï¼Œ å› ä¸ºåœ¨å¤šæ¶ˆè´¹è€…çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„æ¶ˆè´¹è€…å®ç°ä¸­ç®€å•æ”¾å¼ƒäº†é”çš„æŒæœ‰ï¼Œè¿™ä½¿å¾—å¯èƒ½è®©å…¶ä»–æ¶ˆè´¹è€… äº‰å¤ºæ­¤é”ï¼Œä»è€Œæ›´å¥½çš„åˆ©ç”¨å¤šä¸ªæ¶ˆè´¹è€…ä¹‹é—´çš„å¹¶å‘ã€‚è¯è™½å¦‚æ­¤ï¼Œä½†å®é™…ä¸Šå› ä¸º <code>std::mutex</code> çš„æ’ä»–æ€§ï¼Œ æˆ‘ä»¬æ ¹æœ¬æ— æ³•æœŸå¾…å¤šä¸ªæ¶ˆè´¹è€…èƒ½çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶è¡Œæ¶ˆè´¹é˜Ÿåˆ—çš„ä¸­ç”Ÿäº§çš„å†…å®¹ï¼Œæˆ‘ä»¬ä»éœ€è¦ç²’åº¦æ›´ç»†çš„æ‰‹æ®µã€‚</p><h2 id="7-5-åŸå­æ“ä½œä¸å†…å­˜æ¨¡å‹">7.5 åŸå­æ“ä½œä¸å†…å­˜æ¨¡å‹</h2><p>ç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šå¯¹å‰ä¸€å°èŠ‚ä¸­ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹çš„ä¾‹å­å¯èƒ½å­˜åœ¨ç¼–è¯‘å™¨ä¼˜åŒ–å¯¼è‡´ç¨‹åºå‡ºé”™çš„æƒ…å†µäº§ç”Ÿç–‘æƒ‘ã€‚ ä¾‹å¦‚ï¼Œå¸ƒå°”å€¼ <code>notified</code> æ²¡æœ‰è¢« <code>volatile</code> ä¿®é¥°ï¼Œç¼–è¯‘å™¨å¯èƒ½å¯¹æ­¤å˜é‡å­˜åœ¨ä¼˜åŒ–ï¼Œä¾‹å¦‚å°†å…¶ä½œä¸ºä¸€ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œ ä»è€Œå¯¼è‡´æ¶ˆè´¹è€…çº¿ç¨‹æ°¸è¿œæ— æ³•è§‚å¯Ÿåˆ°æ­¤å€¼çš„å˜åŒ–ã€‚è¿™æ˜¯ä¸€ä¸ªå¥½é—®é¢˜ï¼Œä¸ºäº†è§£é‡Šæ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥è®¨è®º ä» C++ 11 èµ·å¼•å…¥çš„å†…å­˜æ¨¡å‹è¿™ä¸€æ¦‚å¿µã€‚æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸ªé—®é¢˜ï¼Œä¸‹é¢è¿™æ®µä»£ç è¾“å‡ºç»“æœæ˜¯å¤šå°‘ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">([&amp;]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">while</span> (flag != <span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> b = a;</span></span></span><br><span class="line"><span class="params"><span class="function">        std::cout &lt;&lt; <span class="string">&quot;b = &quot;</span> &lt;&lt; b &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">([&amp;]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        a = <span class="number">5</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">        flag = <span class="number">1</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ç›´è§‚ä¸Šçœ‹ï¼Œ<code>t2</code> ä¸­ <code>a = 5;</code> è¿™ä¸€æ¡è¯­å¥ä¼¼ä¹æ€»åœ¨ <code>flag = 1;</code> ä¹‹å‰å¾—åˆ°æ‰§è¡Œï¼Œè€Œ <code>t1</code> ä¸­ <code>while (flag != 1)</code> ä¼¼ä¹ä¿è¯äº† <code>std::cout &lt;&lt; &quot;b = &quot; &lt;&lt; b &lt;&lt; std::endl;</code> ä¸ä¼šå†æ ‡è®°è¢«æ”¹å˜å‰æ‰§è¡Œã€‚ä»é€»è¾‘ä¸Šçœ‹ï¼Œä¼¼ä¹ <code>b</code> çš„å€¼åº”è¯¥ç­‰äº 5ã€‚ ä½†å®é™…æƒ…å†µè¿œæ¯”æ­¤å¤æ‚å¾—å¤šï¼Œæˆ–è€…è¯´è¿™æ®µä»£ç æœ¬èº«å±äºæœªå®šä¹‰çš„è¡Œä¸ºï¼Œå› ä¸ºå¯¹äº <code>a</code> å’Œ <code>flag</code> è€Œè¨€ï¼Œä»–ä»¬åœ¨ä¸¤ä¸ªå¹¶è¡Œçš„çº¿ç¨‹ä¸­è¢«è¯»å†™ï¼Œ å‡ºç°äº†ç«äº‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå³ä¾¿æˆ‘ä»¬å¿½ç•¥ç«äº‰è¯»å†™ï¼Œä»ç„¶å¯èƒ½å— CPU çš„ä¹±åºæ‰§è¡Œï¼Œç¼–è¯‘å™¨å¯¹æŒ‡ä»¤çš„é‡æ’çš„å½±å“ï¼Œ å¯¼è‡´ <code>a = 5</code> å‘ç”Ÿåœ¨ <code>flag = 1</code> ä¹‹åã€‚ä»è€Œ <code>b</code> å¯èƒ½è¾“å‡º 0ã€‚</p><h3 id="åŸå­æ“ä½œ">åŸå­æ“ä½œ</h3><p><code>std::mutex</code> å¯ä»¥è§£å†³ä¸Šé¢å‡ºç°çš„å¹¶å‘è¯»å†™çš„é—®é¢˜ï¼Œä½†äº’æ–¥é”æ˜¯æ“ä½œç³»ç»Ÿçº§çš„åŠŸèƒ½ï¼Œ è¿™æ˜¯å› ä¸ºä¸€ä¸ªäº’æ–¥é”çš„å®ç°é€šå¸¸åŒ…å«ä¸¤æ¡åŸºæœ¬åŸç†ï¼š</p><ol><li>æä¾›çº¿ç¨‹é—´è‡ªåŠ¨çš„çŠ¶æ€è½¬æ¢ï¼Œå³ã€é”ä½ã€è¿™ä¸ªçŠ¶æ€</li><li>ä¿éšœåœ¨äº’æ–¥é”æ“ä½œæœŸé—´ï¼Œæ‰€æ“ä½œå˜é‡çš„å†…å­˜ä¸ä¸´ç•ŒåŒºå¤–è¿›è¡Œéš”ç¦»</li></ol><p>è¿™æ˜¯ä¸€ç»„éå¸¸å¼ºçš„åŒæ­¥æ¡ä»¶ï¼Œæ¢å¥è¯è¯´å½“æœ€ç»ˆç¼–è¯‘ä¸º CPU æŒ‡ä»¤æ—¶ä¼šè¡¨ç°ä¸ºéå¸¸å¤šçš„æŒ‡ä»¤ï¼ˆæˆ‘ä»¬ä¹‹åå†æ¥çœ‹å¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„äº’æ–¥é”ï¼‰ã€‚ è¿™å¯¹äºä¸€ä¸ªä»…éœ€åŸå­çº§æ“ä½œï¼ˆæ²¡æœ‰ä¸­é—´æ€ï¼‰çš„å˜é‡ï¼Œä¼¼ä¹å¤ªè‹›åˆ»äº†ã€‚</p><p>å…³äºåŒæ­¥æ¡ä»¶çš„ç ”ç©¶æœ‰ç€éå¸¸ä¹…è¿œçš„å†å²ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¸è¿›è¡Œèµ˜è¿°ã€‚è¯»è€…åº”è¯¥æ˜ç™½ï¼Œç°ä»£ CPU ä½“ç³»ç»“æ„æä¾›äº† CPU æŒ‡ä»¤çº§çš„åŸå­æ“ä½œï¼Œ å› æ­¤åœ¨ C++11 ä¸­å¤šçº¿ç¨‹ä¸‹å…±äº«å˜é‡çš„è¯»å†™è¿™ä¸€é—®é¢˜ä¸Šï¼Œè¿˜å¼•å…¥äº† <code>std::atomic</code> æ¨¡æ¿ï¼Œä½¿å¾—æˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ªåŸå­ç±»å‹ï¼Œå°†ä¸€ä¸ª åŸå­ç±»å‹è¯»å†™æ“ä½œä»ä¸€ç»„æŒ‡ä»¤ï¼Œæœ€å°åŒ–åˆ°å•ä¸ª CPU æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">int</span>&gt; counter;</span><br></pre></td></tr></table></figure><p>å¹¶ä¸ºæ•´æ•°æˆ–æµ®ç‚¹æ•°çš„åŸå­ç±»å‹æä¾›äº†åŸºæœ¬çš„æ•°å€¼æˆå‘˜å‡½æ•°ï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œ åŒ…æ‹¬ <code>fetch_add</code>, <code>fetch_sub</code> ç­‰ï¼ŒåŒæ—¶é€šè¿‡é‡è½½æ–¹ä¾¿çš„æä¾›äº†å¯¹åº”çš„ <code>+</code>ï¼Œ<code>-</code> ç‰ˆæœ¬ã€‚ æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line">std::atomic&lt;<span class="type">int</span>&gt; count = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">([]()&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        count.fetch_add(<span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">([]()&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        count++;        <span class="comment">// ç­‰ä»·äº fetch_add</span></span></span></span><br><span class="line"><span class="params"><span class="function">        count += <span class="number">1</span>;     <span class="comment">// ç­‰ä»·äº fetch_add</span></span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    std::cout &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¹¶éæ‰€æœ‰çš„ç±»å‹éƒ½èƒ½æä¾›åŸå­æ“ä½œï¼Œè¿™æ˜¯å› ä¸ºåŸå­æ“ä½œçš„å¯è¡Œæ€§å–å†³äºå…·ä½“çš„ CPU æ¶æ„ï¼Œä»¥åŠæ‰€å®ä¾‹åŒ–çš„ç±»å‹ç»“æ„æ˜¯å¦èƒ½å¤Ÿæ»¡è¶³è¯¥ CPU æ¶æ„å¯¹å†…å­˜å¯¹é½ æ¡ä»¶çš„è¦æ±‚ï¼Œå› è€Œæˆ‘ä»¬æ€»æ˜¯å¯ä»¥é€šè¿‡ <code>std::atomic&lt;T&gt;::is_lock_free</code> æ¥æ£€æŸ¥è¯¥åŸå­ç±»å‹æ˜¯å¦éœ€æ”¯æŒåŸå­æ“ä½œï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="type">float</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> z;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::atomic&lt;A&gt; a;</span><br><span class="line">    std::cout &lt;&lt; std::boolalpha &lt;&lt; a.<span class="built_in">is_lock_free</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸€è‡´æ€§æ¨¡å‹">ä¸€è‡´æ€§æ¨¡å‹</h3><p>å¹¶è¡Œæ‰§è¡Œçš„å¤šä¸ªçº¿ç¨‹ï¼Œä»æŸç§å®è§‚å±‚é¢ä¸Šè®¨è®ºï¼Œå¯ä»¥ç²—ç•¥çš„è§†ä¸ºä¸€ç§åˆ†å¸ƒå¼ç³»ç»Ÿã€‚ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä»»ä½•é€šä¿¡ä¹ƒè‡³æœ¬åœ°æ“ä½œéƒ½éœ€è¦æ¶ˆè€—ä¸€å®šæ—¶é—´ï¼Œç”šè‡³å‡ºç°ä¸å¯é çš„é€šä¿¡ã€‚</p><p>å¦‚æœæˆ‘ä»¬å¼ºè¡Œå°†ä¸€ä¸ªå˜é‡ <code>v</code> åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„æ“ä½œè®¾ä¸ºåŸå­æ“ä½œï¼Œå³ä»»ä½•ä¸€ä¸ªçº¿ç¨‹åœ¨æ“ä½œå®Œ <code>v</code> åï¼Œ å…¶ä»–çº¿ç¨‹å‡èƒ½<strong>åŒæ­¥</strong>æ„ŸçŸ¥åˆ° <code>v</code> çš„å˜åŒ–ï¼Œåˆ™å¯¹äºå˜é‡ <code>v</code> è€Œè¨€ï¼Œè¡¨ç°ä¸ºé¡ºåºæ‰§è¡Œçš„ç¨‹åºï¼Œå®ƒå¹¶æ²¡æœ‰ç”±äºå¼•å…¥å¤šçº¿ç¨‹ è€Œå¾—åˆ°ä»»ä½•æ•ˆç‡ä¸Šçš„æ”¶ç›Šã€‚å¯¹æ­¤æœ‰ä»€ä¹ˆåŠæ³•èƒ½å¤Ÿé€‚å½“çš„åŠ é€Ÿå‘¢ï¼Ÿç­”æ¡ˆä¾¿æ˜¯å‰Šå¼±åŸå­æ“ä½œçš„åœ¨è¿›ç¨‹é—´çš„åŒæ­¥æ¡ä»¶ã€‚</p><p>ä»åŸç†ä¸Šçœ‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥å¯¹åº”ä¸ºä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹ï¼Œè€Œçº¿ç¨‹é—´çš„é€šä¿¡ä¹Ÿå‡ ä¹ç­‰ä»·äºé›†ç¾¤èŠ‚ç‚¹é—´çš„é€šä¿¡ã€‚ å‰Šå¼±è¿›ç¨‹é—´çš„åŒæ­¥æ¡ä»¶ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šè€ƒè™‘å››ç§ä¸åŒçš„ä¸€è‡´æ€§æ¨¡å‹ï¼š</p><ol><li><p>çº¿æ€§ä¸€è‡´æ€§ï¼šåˆç§°å¼ºä¸€è‡´æ€§æˆ–åŸå­ä¸€è‡´æ€§ã€‚å®ƒè¦æ±‚ä»»ä½•ä¸€æ¬¡è¯»æ“ä½œéƒ½èƒ½è¯»åˆ°æŸä¸ªæ•°æ®çš„æœ€è¿‘ä¸€æ¬¡å†™çš„æ•°æ®ï¼Œå¹¶ä¸”æ‰€æœ‰çº¿ç¨‹çš„æ“ä½œé¡ºåºä¸å…¨å±€æ—¶é’Ÿä¸‹çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">x</span>.<span class="keyword">store</span>(<span class="number">1</span>)      <span class="keyword">x</span>.<span class="keyword">load</span>()</span><br><span class="line">T<span class="number">1</span> ---------+----------------+------&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">T<span class="number">2</span> -------------------+-------------&gt;</span><br><span class="line">                <span class="keyword">x</span>.<span class="keyword">store</span>(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ç§æƒ…å†µä¸‹çº¿ç¨‹ <code>T1</code>, <code>T2</code> å¯¹ <code>x</code> çš„ä¸¤æ¬¡å†™æ“ä½œæ˜¯åŸå­çš„ï¼Œä¸” <code>x.store(1)</code> æ˜¯ä¸¥æ ¼çš„å‘ç”Ÿåœ¨ <code>x.store(2)</code> ä¹‹å‰ï¼Œ<code>x.store(2)</code> ä¸¥æ ¼çš„å‘ç”Ÿåœ¨ <code>x.load()</code> ä¹‹å‰ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œçº¿æ€§ä¸€è‡´æ€§å¯¹å…¨å±€æ—¶é’Ÿçš„è¦æ±‚æ˜¯éš¾ä»¥å®ç°çš„ï¼Œè¿™ä¹Ÿæ˜¯äººä»¬ä¸æ–­ç ”ç©¶æ¯”è¿™ä¸ªä¸€è‡´æ€§æ›´å¼±æ¡ä»¶ä¸‹å…¶ä»–ä¸€è‡´æ€§çš„ç®—æ³•çš„åŸå› ã€‚</p></li><li><p>é¡ºåºä¸€è‡´æ€§ï¼šåŒæ ·è¦æ±‚ä»»ä½•ä¸€æ¬¡è¯»æ“ä½œéƒ½èƒ½è¯»åˆ°æ•°æ®æœ€è¿‘ä¸€æ¬¡å†™å…¥çš„æ•°æ®ï¼Œä½†æœªè¦æ±‚ä¸å…¨å±€æ—¶é’Ÿçš„é¡ºåºä¸€è‡´ã€‚</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">x</span>.<span class="keyword">store</span>(<span class="number">1</span>)  <span class="keyword">x</span>.<span class="keyword">store</span>(<span class="number">3</span>)   <span class="keyword">x</span>.<span class="keyword">load</span>()</span><br><span class="line">T<span class="number">1</span> ---------+-----------+----------+-----&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">T<span class="number">2</span> ---------------+----------------------&gt;</span><br><span class="line">              <span class="keyword">x</span>.<span class="keyword">store</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">æˆ–è€…</span><br><span class="line"></span><br><span class="line">        <span class="keyword">x</span>.<span class="keyword">store</span>(<span class="number">1</span>)  <span class="keyword">x</span>.<span class="keyword">store</span>(<span class="number">3</span>)   <span class="keyword">x</span>.<span class="keyword">load</span>()</span><br><span class="line">T<span class="number">1</span> ---------+-----------+----------+-----&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">T<span class="number">2</span> ------+-------------------------------&gt;</span><br><span class="line">      <span class="keyword">x</span>.<span class="keyword">store</span>(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>åœ¨é¡ºåºä¸€è‡´æ€§çš„è¦æ±‚ä¸‹ï¼Œ<code>x.load()</code> å¿…é¡»è¯»åˆ°æœ€è¿‘ä¸€æ¬¡å†™å…¥çš„æ•°æ®ï¼Œå› æ­¤ <code>x.store(2)</code> ä¸ <code>x.store(1)</code> å¹¶æ— ä»»ä½•å…ˆåä¿éšœï¼Œå³ åªè¦ <code>T2</code> çš„ <code>x.store(2)</code> å‘ç”Ÿåœ¨ <code>x.store(3)</code> ä¹‹å‰å³å¯ã€‚</p></li><li><p>å› æœä¸€è‡´æ€§ï¼šå®ƒçš„è¦æ±‚è¿›ä¸€æ­¥é™ä½ï¼Œåªéœ€è¦æœ‰å› æœå…³ç³»çš„æ“ä½œé¡ºåºå¾—åˆ°ä¿éšœï¼Œè€Œéå› æœå…³ç³»çš„æ“ä½œé¡ºåºåˆ™ä¸åšè¦æ±‚ã€‚</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">      a = <span class="number">1</span>      b = <span class="number">2</span></span><br><span class="line"><span class="type">T1</span> ----+-----------+----------------------------&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">T2</span> ------+--------------------+--------+--------&gt;</span><br><span class="line">      x.store(<span class="number">3</span>)         c = a + b    y.load()</span><br><span class="line"></span><br><span class="line">æˆ–è€…</span><br><span class="line"></span><br><span class="line">      a = <span class="number">1</span>      b = <span class="number">2</span></span><br><span class="line"><span class="type">T1</span> ----+-----------+----------------------------&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">T2</span> ------+--------------------+--------+--------&gt;</span><br><span class="line">      x.store(<span class="number">3</span>)          y.load()   c = a + b</span><br><span class="line"></span><br><span class="line">äº¦æˆ–è€…</span><br><span class="line"></span><br><span class="line">     b = <span class="number">2</span>       a = <span class="number">1</span></span><br><span class="line"><span class="type">T1</span> ----+-----------+----------------------------&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">T2</span> ------+--------------------+--------+--------&gt;</span><br><span class="line">      y.load()            c = a + b  x.store(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ç»™å‡ºçš„ä¸‰ç§ä¾‹å­éƒ½æ˜¯å±äºå› æœä¸€è‡´çš„ï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªæœ‰ <code>c</code> å¯¹ <code>a</code> å’Œ <code>b</code> äº§ç”Ÿä¾èµ–ï¼Œè€Œ <code>x</code> å’Œ <code>y</code> åœ¨æ­¤ä¾‹å­ä¸­è¡¨ç°ä¸ºæ²¡æœ‰å…³ç³»ï¼ˆä½†å®é™…æƒ…å†µä¸­æˆ‘ä»¬éœ€è¦æ›´è¯¦ç»†çš„ä¿¡æ¯æ‰èƒ½ç¡®å®š <code>x</code> ä¸ <code>y</code> ç¡®å®æ— å…³ï¼‰</p></li><li><p>æœ€ç»ˆä¸€è‡´æ€§ï¼šæ˜¯æœ€å¼±çš„ä¸€è‡´æ€§è¦æ±‚ï¼Œå®ƒåªä¿éšœæŸä¸ªæ“ä½œåœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´èŠ‚ç‚¹ä¸Šä¼šè¢«è§‚å¯Ÿåˆ°ï¼Œä½†å¹¶æœªè¦æ±‚è¢«è§‚å¯Ÿåˆ°çš„æ—¶é—´ã€‚å› æ­¤æˆ‘ä»¬ç”šè‡³å¯ä»¥å¯¹æ­¤æ¡ä»¶ç¨ä½œåŠ å¼ºï¼Œä¾‹å¦‚è§„å®šæŸä¸ªæ“ä½œè¢«è§‚å¯Ÿåˆ°çš„æ—¶é—´æ€»æ˜¯æœ‰ç•Œçš„ã€‚å½“ç„¶è¿™å·²ç»ä¸åœ¨æˆ‘ä»¬çš„è®¨è®ºèŒƒå›´ä¹‹å†…äº†ã€‚</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    x.store(<span class="number">3</span>)  x.store(<span class="number">4</span>)</span><br><span class="line"><span class="type">T1</span> ----+-----------+--------------------------------------------&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">T2</span> ---------+------------+--------------------+--------+--------&gt;</span><br><span class="line">         x.read      x.read()           x.read()   x.read()</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„æƒ…å†µä¸­ï¼Œå¦‚æœæˆ‘ä»¬å‡è®¾ x çš„åˆå§‹å€¼ä¸º 0ï¼Œåˆ™ <code>T2</code> ä¸­å››æ¬¡ <code>x.read()</code> ç»“æœå¯èƒ½ä½†ä¸é™äºä»¥ä¸‹æƒ…å†µï¼š</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">3<span class="number"> 4 </span>4<span class="number"> 4 </span>// x çš„å†™æ“ä½œè¢«å¾ˆå¿«è§‚å¯Ÿåˆ°</span><br><span class="line">0<span class="number"> 3 </span>3<span class="number"> 4 </span>// x çš„å†™æ“ä½œè¢«è§‚å¯Ÿåˆ°çš„æ—¶é—´å­˜åœ¨ä¸€å®šå»¶è¿Ÿ</span><br><span class="line">0<span class="number"> 0 </span>0<span class="number"> 4 </span>// æœ€åä¸€æ¬¡è¯»æ“ä½œè¯»åˆ°äº† x çš„æœ€ç»ˆå€¼ï¼Œä½†æ­¤å‰çš„å˜åŒ–å¹¶æœªè§‚å¯Ÿåˆ°</span><br><span class="line">0<span class="number"> 0 </span>0<span class="number"> 0 </span>// åœ¨å½“å‰æ—¶é—´æ®µå†… x çš„å†™æ“ä½œå‡æœªè¢«è§‚å¯Ÿåˆ°ï¼Œ</span><br><span class="line">        // ä½†æœªæ¥æŸä¸ªæ—¶é—´ç‚¹ä¸Šä¸€å®šèƒ½è§‚å¯Ÿåˆ° x ä¸º<span class="number"> 4 </span>çš„æƒ…å†µ</span><br></pre></td></tr></table></figure></li></ol><h3 id="å†…å­˜é¡ºåº">å†…å­˜é¡ºåº</h3><p>ä¸ºäº†è¿½æ±‚æè‡´çš„æ€§èƒ½ï¼Œå®ç°å„ç§å¼ºåº¦è¦æ±‚çš„ä¸€è‡´æ€§ï¼ŒC++11 ä¸ºåŸå­æ“ä½œå®šä¹‰äº†å…­ç§ä¸åŒçš„å†…å­˜é¡ºåº <code>std::memory_order</code> çš„é€‰é¡¹ï¼Œè¡¨è¾¾äº†å››ç§å¤šçº¿ç¨‹é—´çš„åŒæ­¥æ¨¡å‹ï¼š</p><ol><li><p>å®½æ¾æ¨¡å‹ï¼šåœ¨æ­¤æ¨¡å‹ä¸‹ï¼Œå•ä¸ªçº¿ç¨‹å†…çš„åŸå­æ“ä½œéƒ½æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œä¸å…è®¸æŒ‡ä»¤é‡æ’ï¼Œä½†ä¸åŒçº¿ç¨‹é—´åŸå­æ“ä½œçš„é¡ºåºæ˜¯ä»»æ„çš„ã€‚ç±»å‹é€šè¿‡ <code>std::memory_order_relaxed</code> æŒ‡å®šã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">int</span>&gt; counter = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">std::vector&lt;std::thread&gt; vt;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i) &#123;</span><br><span class="line">    vt.<span class="built_in">emplace_back</span>([&amp;]()&#123;</span><br><span class="line">        counter.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : vt) &#123;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;current counter:&quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure></li><li><p>é‡Šæ”¾/æ¶ˆè´¹æ¨¡å‹ï¼šåœ¨æ­¤æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬å¼€å§‹é™åˆ¶è¿›ç¨‹é—´çš„æ“ä½œé¡ºåºï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹éœ€è¦ä¿®æ”¹æŸä¸ªå€¼ï¼Œä½†å¦ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹è¯¥å€¼çš„æŸæ¬¡æ“ä½œäº§ç”Ÿä¾èµ–ï¼Œå³åè€…ä¾èµ–å‰è€…ã€‚å…·ä½“è€Œè¨€ï¼Œçº¿ç¨‹ A å®Œæˆäº†ä¸‰æ¬¡å¯¹ <code>x</code> çš„å†™æ“ä½œï¼Œçº¿ç¨‹ <code>B</code> ä»…ä¾èµ–å…¶ä¸­ç¬¬ä¸‰æ¬¡ <code>x</code> çš„å†™æ“ä½œï¼Œä¸ <code>x</code> çš„å‰ä¸¤æ¬¡å†™è¡Œä¸ºæ— å…³ï¼Œåˆ™å½“ <code>A</code> ä¸»åŠ¨ <code>x.release()</code> æ—¶å€™ï¼ˆå³ä½¿ç”¨ <code>std::memory_order_release</code>ï¼‰ï¼Œé€‰é¡¹ <code>std::memory_order_consume</code> èƒ½å¤Ÿç¡®ä¿ <code>B</code> åœ¨è°ƒç”¨ <code>x.load()</code> æ—¶å€™è§‚å¯Ÿåˆ° <code>A</code> ä¸­ç¬¬ä¸‰æ¬¡å¯¹ <code>x</code> çš„å†™æ“ä½œã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸º nullptr é˜²æ­¢ consumer çº¿ç¨‹ä»é‡æŒ‡é’ˆè¿›è¡Œè¯»å–</span></span><br><span class="line">std::<span class="variable constant_">atomic</span>&lt;<span class="keyword">int</span>*&gt; <span class="title function_ invoke__">ptr</span>(nullptr);</span><br><span class="line"><span class="keyword">int</span> v;</span><br><span class="line">std::<span class="variable constant_">thread</span> <span class="title function_ invoke__">producer</span>([&amp;]() &#123;</span><br><span class="line">    <span class="keyword">int</span>* p = <span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">42</span>);</span><br><span class="line">    v = <span class="number">1024</span>;</span><br><span class="line">    ptr.<span class="title function_ invoke__">store</span>(p, std::<span class="variable constant_">memory_order_release</span>);</span><br><span class="line">&#125;);</span><br><span class="line">std::<span class="variable constant_">thread</span> <span class="title function_ invoke__">consumer</span>([&amp;]() &#123;</span><br><span class="line">    <span class="keyword">int</span>* p;</span><br><span class="line">    <span class="keyword">while</span>(!(p = ptr.<span class="title function_ invoke__">load</span>(std::<span class="variable constant_">memory_order_consume</span>)));</span><br><span class="line"></span><br><span class="line">    std::<span class="variable constant_">cout</span> &lt;&lt; <span class="string">&quot;p: &quot;</span> &lt;&lt; *p &lt;&lt; std::<span class="variable constant_">endl</span>;</span><br><span class="line">    std::<span class="variable constant_">cout</span> &lt;&lt; <span class="string">&quot;v: &quot;</span> &lt;&lt; v &lt;&lt; std::<span class="variable constant_">endl</span>;</span><br><span class="line">&#125;);</span><br><span class="line">producer.<span class="title function_ invoke__">join</span>();</span><br><span class="line">consumer.<span class="title function_ invoke__">join</span>();</span><br></pre></td></tr></table></figure></li><li><p>é‡Šæ”¾/è·å–æ¨¡å‹ï¼šåœ¨æ­¤æ¨¡å‹ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥åŠ ç´§å¯¹ä¸åŒçº¿ç¨‹é—´åŸå­æ“ä½œçš„é¡ºåºçš„é™åˆ¶ï¼Œåœ¨é‡Šæ”¾ <code>std::memory_order_release</code> å’Œè·å– <code>std::memory_order_acquire</code> ä¹‹é—´è§„å®šæ—¶åºï¼Œå³å‘ç”Ÿåœ¨é‡Šæ”¾ï¼ˆreleaseï¼‰æ“ä½œä¹‹å‰çš„<strong>æ‰€æœ‰</strong>å†™æ“ä½œï¼Œå¯¹å…¶ä»–çº¿ç¨‹çš„ä»»ä½•è·å–ï¼ˆacquireï¼‰æ“ä½œéƒ½æ˜¯å¯è§çš„ï¼Œäº¦å³å‘ç”Ÿé¡ºåºï¼ˆhappens-beforeï¼‰ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>std::memory_order_release</code> ç¡®ä¿äº†å®ƒä¹‹å‰çš„å†™æ“ä½œä¸ä¼šå‘ç”Ÿåœ¨é‡Šæ”¾æ“ä½œä¹‹åï¼Œæ˜¯ä¸€ä¸ªå‘åçš„å±éšœï¼ˆbackwardï¼‰ï¼Œè€Œ <code>std::memory_order_acquire</code> ç¡®ä¿äº†å®ƒä¹‹å‰çš„å†™è¡Œä¸ºä¸ä¼šå‘ç”Ÿåœ¨è¯¥è·å–æ“ä½œä¹‹åï¼Œæ˜¯ä¸€ä¸ªå‘å‰çš„å±éšœï¼ˆforwardï¼‰ã€‚å¯¹äºé€‰é¡¹ <code>std::memory_order_acq_rel</code> è€Œè¨€ï¼Œåˆ™ç»“åˆäº†è¿™ä¸¤è€…çš„ç‰¹ç‚¹ï¼Œå”¯ä¸€ç¡®å®šäº†ä¸€ä¸ªå†…å­˜å±éšœï¼Œä½¿å¾—å½“å‰çº¿ç¨‹å¯¹å†…å­˜çš„è¯»å†™ä¸ä¼šè¢«é‡æ’å¹¶è¶Šè¿‡æ­¤æ“ä½œçš„å‰åï¼š</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line">std::atomic&lt;<span class="type">int</span>&gt; flag = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function">std::thread <span class="title">release</span><span class="params">([&amp;]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    v.push_back(<span class="number">42</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">    flag.store(<span class="number">1</span>, std::memory_order_release);</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span></span>;</span><br><span class="line"><span class="function">std::thread <span class="title">acqrel</span><span class="params">([&amp;]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int</span> expected = <span class="number">1</span>; <span class="comment">// must before compare_exchange_strong</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">while</span>(!flag.compare_exchange_strong(expected, <span class="number">2</span>, std::memory_order_acq_rel))</span></span></span><br><span class="line"><span class="params"><span class="function">        expected = <span class="number">1</span>; <span class="comment">// must after compare_exchange_strong</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">// flag has changed to 2</span></span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span></span>;</span><br><span class="line"><span class="function">std::thread <span class="title">acquire</span><span class="params">([&amp;]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">while</span>(flag.load(std::memory_order_acquire) &lt; <span class="number">2</span>);</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    std::cout &lt;&lt; v.at(<span class="number">0</span>) &lt;&lt; std::endl; <span class="comment">// must be 42</span></span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span></span>;</span><br><span class="line">release.<span class="built_in">join</span>();</span><br><span class="line">acqrel.<span class="built_in">join</span>();</span><br><span class="line">acquire.<span class="built_in">join</span>();</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤ä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨äº† <code>compare_exchange_strong</code> æ¯”è¾ƒäº¤æ¢åŸè¯­ï¼ˆCompare-and-swap primitiveï¼‰ï¼Œå®ƒæœ‰ä¸€ä¸ªæ›´å¼±çš„ç‰ˆæœ¬ï¼Œå³ <code>compare_exchange_weak</code>ï¼Œå®ƒå…è®¸å³ä¾¿äº¤æ¢æˆåŠŸï¼Œä¹Ÿä»ç„¶è¿”å› <code>false</code> å¤±è´¥ã€‚å…¶åŸå› æ˜¯å› ä¸ºåœ¨æŸäº›å¹³å°ä¸Šè™šå‡æ•…éšœå¯¼è‡´çš„ï¼Œå…·ä½“è€Œè¨€ï¼Œå½“ CPU è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼Œå¦ä¸€çº¿ç¨‹åŠ è½½åŒä¸€åœ°å€äº§ç”Ÿçš„ä¸ä¸€è‡´ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ<code>compare_exchange_strong</code> çš„æ€§èƒ½å¯èƒ½ç¨å·®äº <code>compare_exchange_weak</code>ï¼Œä½†å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œé‰´äºå…¶ä½¿ç”¨çš„å¤æ‚åº¦è€Œè¨€ï¼Œ<code>compare_exchange_weak</code> åº”è¯¥è¢«æœ‰é™è€ƒè™‘ã€‚</p></li><li><p>é¡ºåºä¸€è‡´æ¨¡å‹ï¼šåœ¨æ­¤æ¨¡å‹ä¸‹ï¼ŒåŸå­æ“ä½œæ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼Œè¿›è€Œå¯èƒ½å¯¹æ€§èƒ½äº§ç”ŸæŸè€—ã€‚å¯æ˜¾å¼çš„é€šè¿‡ <code>std::memory_order_seq_cst</code> è¿›è¡ŒæŒ‡å®šã€‚æœ€åæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;<span class="type">int</span>&gt; counter = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">std::vector&lt;std::thread&gt; vt;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i) &#123;</span><br><span class="line">    vt.<span class="built_in">emplace_back</span>([&amp;]()&#123;</span><br><span class="line">        counter.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_seq_cst);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : vt) &#123;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;current counter:&quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸ç¬¬ä¸€ä¸ªå®½æ¾æ¨¡å‹çš„ä¾‹å­æœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œä»…ä»…åªæ˜¯å°†åŸå­æ“ä½œçš„å†…å­˜é¡ºåºä¿®æ”¹ä¸ºäº† <code>memory_order_seq_cst</code>ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œç¼–å†™ç¨‹åºæµ‹é‡è¿™ä¸¤ç§ä¸åŒå†…å­˜é¡ºåºå¯¼è‡´çš„æ€§èƒ½å·®å¼‚ã€‚</p></li></ol><h2 id="æ€»ç»“-6">æ€»ç»“</h2><p>C++11 è¯­è¨€å±‚æä¾›äº†å¹¶å‘ç¼–ç¨‹çš„ç›¸å…³æ”¯æŒï¼Œæœ¬èŠ‚ç®€å•çš„ä»‹ç»äº† <code>std::thread</code>, <code>std::mutex</code>, <code>std::future</code> è¿™äº›å¹¶å‘ç¼–ç¨‹ä¸­ä¸å¯å›é¿çš„é‡è¦å·¥å…·ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜ä»‹ç»äº† C++11 æœ€é‡è¦çš„å‡ ä¸ªç‰¹æ€§ä¹‹ä¸€çš„ã€å†…å­˜æ¨¡å‹ã€ï¼Œ å®ƒä»¬ä¸º C++ åœ¨æ ‡å‡†åŒ–é«˜æ€§èƒ½è®¡ç®—ä¸­æä¾›äº†é‡è¦çš„åŸºç¡€ã€‚</p><ol><li><p>è¯·ç¼–å†™ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ± ï¼Œæä¾›å¦‚ä¸‹åŠŸèƒ½ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ThreadPool <span class="title">p</span><span class="params">(<span class="number">4</span>)</span></span>; <span class="comment">// æŒ‡å®šå››ä¸ªå·¥ä½œçº¿ç¨‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†ä»»åŠ¡åœ¨æ± ä¸­å…¥é˜Ÿï¼Œå¹¶è¿”å›ä¸€ä¸ª std::future</span></span><br><span class="line"><span class="keyword">auto</span> f = pool.<span class="built_in">enqueue</span>([](<span class="type">int</span> life) &#123;</span><br><span class="line">    <span class="keyword">return</span> meaning;</span><br><span class="line">&#125;, <span class="number">42</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä» future ä¸­è·å¾—æ‰§è¡Œç»“æœ</span></span><br><span class="line">std::cout &lt;&lt; f.<span class="built_in">get</span>() &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure></li><li><p>è¯·ä½¿ç”¨ <code>std::atomic&lt;bool&gt;</code> å®ç°ä¸€ä¸ªäº’æ–¥é”ã€‚</p></li></ol><h1>ç¬¬ 8 ç«  æ–‡ä»¶ç³»ç»Ÿ</h1><p>æ–‡ä»¶ç³»ç»Ÿåº“æä¾›äº†æ–‡ä»¶ç³»ç»Ÿã€è·¯å¾„ã€å¸¸è§„æ–‡ä»¶ã€ç›®å½•ç­‰ç­‰ç›¸å…³ç»„ä»¶è¿›è¡Œæ“ä½œçš„ç›¸å…³åŠŸèƒ½ã€‚å’Œæ­£åˆ™è¡¨è¾¾å¼åº“ç±»ä¼¼ï¼Œä»–ä¹Ÿæ˜¯æœ€å…ˆç”± boost å‘èµ·ï¼Œå¹¶æœ€ç»ˆè¢«åˆå¹¶ä¸º C++ æ ‡å‡†çš„ä¼—å¤šåº“ä¹‹ä¸€ã€‚</p><h1>ç¬¬ 9 ç«  å…¶ä»–æ‚é¡¹</h1><h2 id="9-1-æ–°ç±»å‹">9.1 æ–°ç±»å‹</h2><h3 id="long-long-int"><code>long long int</code></h3><p><code>long long int</code> å¹¶ä¸æ˜¯ C++11 æœ€å…ˆå¼•å…¥çš„ï¼Œå…¶å®æ—©åœ¨ C99ï¼Œ <code>long long int</code> å°±å·²ç»è¢«çº³å…¥ C æ ‡å‡†ä¸­ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†çš„ç¼–è¯‘å™¨æ—©å·²æ”¯æŒã€‚ C++11 çš„å·¥ä½œåˆ™æ˜¯æ­£å¼æŠŠå®ƒçº³å…¥æ ‡å‡†åº“ï¼Œ è§„å®šäº†ä¸€ä¸ª <code>long long int</code> ç±»å‹è‡³å°‘å…·å¤‡ 64 ä½çš„æ¯”ç‰¹æ•°ã€‚</p><h2 id="9-2-noexcept-çš„ä¿®é¥°å’Œæ“ä½œ">9.2 noexcept çš„ä¿®é¥°å’Œæ“ä½œ</h2><p>C++ ç›¸æ¯”äº C çš„ä¸€å¤§ä¼˜åŠ¿å°±åœ¨äº C++ æœ¬èº«å°±å®šä¹‰äº†ä¸€å¥—å®Œæ•´çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ã€‚ ç„¶è€Œåœ¨ C++11 ä¹‹å‰ï¼Œå‡ ä¹æ²¡æœ‰äººå»ä½¿ç”¨åœ¨å‡½æ•°ååä¹¦å†™å¼‚å¸¸å£°æ˜è¡¨è¾¾å¼ï¼Œ ä» C++11 å¼€å§‹ï¼Œè¿™å¥—æœºåˆ¶è¢«å¼ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å»è®¨è®ºä¹Ÿä¸å»ä»‹ç»ä»¥å‰è¿™å¥—æœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œå¦‚ä½•ä½¿ç”¨ï¼Œ ä½ æ›´ä¸åº”è¯¥ä¸»åŠ¨å»äº†è§£å®ƒã€‚</p><p>C++11 å°†å¼‚å¸¸çš„å£°æ˜ç®€åŒ–ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p><ol><li>å‡½æ•°å¯èƒ½æŠ›å‡ºä»»ä½•å¼‚å¸¸</li><li>å‡½æ•°ä¸èƒ½æŠ›å‡ºä»»ä½•å¼‚å¸¸</li></ol><p>å¹¶ä½¿ç”¨ <code>noexcept</code> å¯¹è¿™ä¸¤ç§è¡Œä¸ºè¿›è¡Œé™åˆ¶ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">may_throw</span>()</span>; <span class="comment">// å¯èƒ½æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">no_throw</span>() noexcept</span>; <span class="comment">// ä¸å¯èƒ½æŠ›å‡ºå¼‚å¸¸</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>noexcept</code> ä¿®é¥°è¿‡çš„å‡½æ•°å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨ <code>std::terminate()</code> æ¥ç«‹å³ç»ˆæ­¢ç¨‹åºè¿è¡Œã€‚</p><p><code>noexcept</code> è¿˜èƒ½å¤Ÿåšæ“ä½œç¬¦ï¼Œç”¨äºæ“ä½œä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå½“è¡¨è¾¾å¼æ— å¼‚å¸¸æ—¶ï¼Œè¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å› <code>false</code>ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">may_throw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">auto</span> non_block_throw = []&#123;</span><br><span class="line">    <span class="built_in">may_throw</span>();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">no_throw</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> block_throw = []() <span class="keyword">noexcept</span> &#123;</span><br><span class="line">    <span class="built_in">no_throw</span>();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; std::boolalpha</span><br><span class="line">        &lt;&lt; <span class="string">&quot;may_throw() noexcept? &quot;</span> &lt;&lt; <span class="built_in">noexcept</span>(<span class="built_in">may_throw</span>()) &lt;&lt; std::endl</span><br><span class="line">        &lt;&lt; <span class="string">&quot;no_throw() noexcept? &quot;</span> &lt;&lt; <span class="built_in">noexcept</span>(<span class="built_in">no_throw</span>()) &lt;&lt; std::endl</span><br><span class="line">        &lt;&lt; <span class="string">&quot;lmay_throw() noexcept? &quot;</span> &lt;&lt; <span class="built_in">noexcept</span>(<span class="built_in">non_block_throw</span>()) &lt;&lt; std::endl</span><br><span class="line">        &lt;&lt; <span class="string">&quot;lno_throw() noexcept? &quot;</span> &lt;&lt; <span class="built_in">noexcept</span>(<span class="built_in">block_throw</span>()) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>noexcept</code> ä¿®é¥°å®Œä¸€ä¸ªå‡½æ•°ä¹‹åèƒ½å¤Ÿèµ·åˆ°å°é”å¼‚å¸¸æ‰©æ•£çš„åŠŸæ•ˆï¼Œå¦‚æœå†…éƒ¨äº§ç”Ÿå¼‚å¸¸ï¼Œå¤–éƒ¨ä¹Ÿä¸ä¼šè§¦å‘ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    may_throw();</span><br><span class="line">&#125; <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ•è·å¼‚å¸¸, æ¥è‡ª may_throw()&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    non_block_throw();</span><br><span class="line">&#125; <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ•è·å¼‚å¸¸, æ¥è‡ª non_block_throw()&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    block_throw();</span><br><span class="line">&#125; <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ•è·å¼‚å¸¸, æ¥è‡ª block_throw()&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¾“å‡ºä¸ºï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ•è·å¼‚å¸¸, æ¥è‡ª <span class="built_in">may_throw</span>()</span><br><span class="line">æ•è·å¼‚å¸¸, æ¥è‡ª <span class="built_in">non_block_throw</span>()</span><br></pre></td></tr></table></figure><h2 id="9-3-å­—é¢é‡">9.3 å­—é¢é‡</h2><h3 id="åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡">åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡</h3><p>ä¼ ç»Ÿ C++ é‡Œé¢è¦ç¼–å†™ä¸€ä¸ªå……æ»¡ç‰¹æ®Šå­—ç¬¦çš„å­—ç¬¦ä¸²å…¶å®æ˜¯éå¸¸ç—›è‹¦çš„ä¸€ä»¶äº‹æƒ…ï¼Œ æ¯”å¦‚ä¸€ä¸ªåŒ…å« HTML æœ¬ä½“çš„å­—ç¬¦ä¸²éœ€è¦æ·»åŠ å¤§é‡çš„è½¬ä¹‰ç¬¦ï¼Œ ä¾‹å¦‚ä¸€ä¸ªWindows ä¸Šçš„æ–‡ä»¶è·¯å¾„ç»å¸¸ä¼šï¼š<code>C:\\File\\To\\Path</code>ã€‚</p><p>C++11 æä¾›äº†åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡çš„å†™æ³•ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²å‰æ–¹ä½¿ç”¨ <code>R</code> æ¥ä¿®é¥°è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œ åŒæ—¶ï¼Œå°†åŸå§‹å­—ç¬¦ä¸²ä½¿ç”¨æ‹¬å·åŒ…è£¹ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main() &#123;</span><br><span class="line">    std::string <span class="built_in">str</span> = <span class="string">R&quot;(C:\File\To\Path)&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">str</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰å­—é¢é‡">è‡ªå®šä¹‰å­—é¢é‡</h3><p>C++11 å¼•è¿›äº†è‡ªå®šä¹‰å­—é¢é‡çš„èƒ½åŠ›ï¼Œé€šè¿‡é‡è½½åŒå¼•å·åç¼€è¿ç®—ç¬¦å®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// å­—ç¬¦ä¸²å­—é¢é‡è‡ªå®šä¹‰å¿…é¡»è®¾ç½®å¦‚ä¸‹çš„å‚æ•°åˆ—è¡¨</span><br><span class="line">std::string operato<span class="string">r&quot;&quot;</span> _wow1(const char *wow1, size_t <span class="built_in">len</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> std::string(wow1)+<span class="string">&quot;woooooooooow, amazing&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::string operato<span class="string">r&quot;&quot;</span> _wow2 (unsigned long long i) &#123;</span><br><span class="line">    <span class="keyword">return</span> std::to_string(i)+<span class="string">&quot;woooooooooow, amazing&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main() &#123;</span><br><span class="line">    auto <span class="built_in">str</span> = <span class="string">&quot;abc&quot;</span>_wow1;</span><br><span class="line">    auto num = 1_wow2;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">str</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; num &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰å­—é¢é‡æ”¯æŒå››ç§å­—é¢é‡ï¼š</p><ol><li>æ•´å‹å­—é¢é‡ï¼šé‡è½½æ—¶å¿…é¡»ä½¿ç”¨ <code>unsigned long long</code>ã€<code>const char *</code>ã€æ¨¡æ¿å­—é¢é‡ç®—ç¬¦å‚æ•°ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯å‰è€…ï¼›</li><li>æµ®ç‚¹å‹å­—é¢é‡ï¼šé‡è½½æ—¶å¿…é¡»ä½¿ç”¨ <code>long double</code>ã€<code>const char *</code>ã€æ¨¡æ¿å­—é¢é‡ç®—ç¬¦ï¼›</li><li>å­—ç¬¦ä¸²å­—é¢é‡ï¼šå¿…é¡»ä½¿ç”¨ <code>(const char *, size_t)</code> å½¢å¼çš„å‚æ•°è¡¨ï¼›</li><li>å­—ç¬¦å­—é¢é‡ï¼šå‚æ•°åªèƒ½æ˜¯ <code>char</code>, <code>wchar_t</code>, <code>char16_t</code>, <code>char32_t</code> è¿™å‡ ç§ç±»å‹ã€‚</li></ol><h2 id="9-4-å†…å­˜å¯¹é½">9.4 å†…å­˜å¯¹é½</h2><p>C++ 11 å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„å…³é”®å­— <code>alignof</code> å’Œ <code>alignas</code> æ¥æ”¯æŒå¯¹å†…å­˜å¯¹é½è¿›è¡Œæ§åˆ¶ã€‚ <code>alignof</code> å…³é”®å­—èƒ½å¤Ÿè·å¾—ä¸€ä¸ªä¸å¹³å°ç›¸å…³çš„ <code>std::size_t</code> ç±»å‹çš„å€¼ï¼Œç”¨äºæŸ¥è¯¢è¯¥å¹³å°çš„å¯¹é½æ–¹å¼ã€‚ å½“ç„¶æˆ‘ä»¬æœ‰æ—¶å€™å¹¶ä¸æ»¡è¶³äºæ­¤ï¼Œç”šè‡³å¸Œæœ›è‡ªå®šå®šä¹‰ç»“æ„çš„å¯¹é½æ–¹å¼ï¼ŒåŒæ ·ï¼ŒC++ 11 è¿˜å¼•å…¥äº† <code>alignas</code> æ¥é‡æ–°ä¿®é¥°æŸä¸ªç»“æ„çš„å¯¹é½æ–¹å¼ã€‚æˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Storage</span> &#123;</span><br><span class="line">    <span class="type">char</span>      a;</span><br><span class="line">    <span class="type">int</span>       b;</span><br><span class="line">    <span class="type">double</span>    c;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> d;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">alignas</span>(std::<span class="type">max_align_t</span>) AlignasStorage &#123;</span><br><span class="line">    <span class="type">char</span>      a;</span><br><span class="line">    <span class="type">int</span>       b;</span><br><span class="line">    <span class="type">double</span>    c;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> d;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">alignof</span>(Storage) &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">alignof</span>(AlignasStorage) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>std::max_align_t</code> è¦æ±‚æ¯ä¸ªæ ‡é‡ç±»å‹çš„å¯¹é½æ–¹å¼ä¸¥æ ¼ä¸€æ ·ï¼Œå› æ­¤å®ƒå‡ ä¹æ˜¯æœ€å¤§æ ‡é‡æ²¡æœ‰å·®å¼‚ï¼Œ è¿›è€Œå¤§éƒ¨åˆ†å¹³å°ä¸Šå¾—åˆ°çš„ç»“æœä¸º <code>long double</code>ï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œå¾—åˆ°çš„ <code>AlignasStorage</code> çš„å¯¹é½è¦æ±‚æ˜¯ 8 æˆ– 16ã€‚</p><h2 id="æ€»ç»“-7">æ€»ç»“</h2><p>æœ¬èŠ‚ä»‹ç»çš„å‡ ä¸ªç‰¹æ€§æ˜¯ä»ä»æœªä»‹ç»çš„ç°ä»£ C++ æ–°ç‰¹æ€§é‡Œä½¿ç”¨é¢‘æ¬¡è¾ƒé å‰çš„ç‰¹æ€§äº†ï¼Œ<code>noexcept</code> æ˜¯æœ€ä¸ºé‡è¦çš„ç‰¹æ€§ï¼Œå®ƒçš„ä¸€ä¸ªåŠŸèƒ½åœ¨äºèƒ½å¤Ÿé˜»æ­¢å¼‚å¸¸çš„æ‰©æ•£ä¼ æ’­ï¼Œæœ‰æ•ˆçš„è®©ç¼–è¯‘å™¨æœ€å¤§é™åº¦çš„ä¼˜åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Cpp </category>
          
          <category> è¯»ä¹¦ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cpp </tag>
            
            <tag> è¯»ä¹¦ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hellow World</title>
      <link href="/posts/659c4f50.html"/>
      <url>/posts/659c4f50.html</url>
      
        <content type="html"><![CDATA[<h1>Hello World</h1><p>è¿™æ˜¯æˆ‘ç¬¬äºŒæ¬¡ä½¿ç”¨<a href="https://hexo.io/">Hexo</a>æ¡†æ¶ä½¿ç”¨githubæ­å»ºåšå®¢ï¼ŒPSï¼šä¹‹å‰çš„Hexoæœ‰ç‚¹æï¼ŒQAQ</p><p>å½“å‰é‡‡ç”¨çš„ä¸»é¢˜æ˜¯<a href="https://github.com/jerryc127/hexo-theme-butterfly">ButterFly</a></p><p>å‚è€ƒ<a href="https://github.com/fomalhaut1998/hexo-theme-Fomalhaut">hexo-theme-Fomalhaut</a>åœ¨ä¸Šé¢æ·»åŠ äº†å±äºè‡ªå·±çš„å°æ ·å¼</p><p>ä¹‹åä¼šå°†è¿™é˜¶æ®µçœ‹è¿‡çš„ä¹¦ç±ä»¥åŠçŸ¥è¯†ä»¥éšç¬”çš„å½¢å¼è®°å½•åœ¨åšå®¢ä¸­ï¼Œæ–¹ä¾¿ä¹‹åå¤ä¹ ï¼ˆ ä»¥å‰ä¹Ÿæœ‰å†™åšå®¢çš„ä¹ æƒ¯ï¼Œä¸è¿‡æ˜¯åœ¨CSDNå’Œåšå®¢å›­ï¼‰</p><p>ã€PicGo+é˜¿é‡Œäº‘OSSã€‘å›¾åºŠè®¾ç½®å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/688458825">https://zhuanlan.zhihu.com/p/688458825</a></p><p>å¦‚æœæƒ³è”ç³»æˆ‘çš„è¯ï¼Œæˆ‘çš„QQæ˜¯1280032578</p>]]></content>
      
      
      <categories>
          
          <category> æ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ‚è°ˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</title>
      <link href="/posts/2013454d.html"/>
      <url>/posts/2013454d.html</url>
      
        <content type="html"><![CDATA[<h1>1.Markdownè¯­æ³•è‡ªå¸¦æ ¼å¼</h1><div class="note info flat"><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/u014061630/article/details/81359144">Markdownè¯­æ³•å›¾æ–‡å…¨é¢è¯¦è§£(10åˆ†é’Ÿå­¦ä¼š)</a></p></div><div class="note warning flat"><p>æ³¨æ„ï¼šæ­¤é¡µé¢å¶å°”ä¼šå­˜åœ¨CSSå†²çªé—®é¢˜!</p></div><h2 id="1-1-ä»£ç å—">1.1 ä»£ç å—</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">\```shell</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VSCodeç»ˆç«¯</span></span><br><span class="line">hexo clean; hexo s</span><br><span class="line">hexo clean; hexo g; hexo d</span><br><span class="line">git add .; git commit -m &quot;npm publish&quot;; npm version patch; </span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Cmderç»ˆç«¯</span></span><br><span class="line">hexo clean &amp;&amp; hexo s</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br><span class="line">git add . &amp;&amp; git commit -m &quot;npm publish&quot; &amp;&amp; npm version patch</span><br><span class="line">git push</span><br><span class="line">\```</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VSCodeç»ˆç«¯</span></span><br><span class="line">hexo clean; hexo s</span><br><span class="line">hexo clean; hexo g; hexo d</span><br><span class="line">git add .; git commit -m &quot;npm publish&quot;; npm version patch; </span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Cmderç»ˆç«¯</span></span><br><span class="line">hexo clean &amp;&amp; hexo s</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br><span class="line">git add . &amp;&amp; git commit -m &quot;npm publish&quot; &amp;&amp; npm version patch</span><br><span class="line">git push</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-2-å¤šçº§æ ‡é¢˜">1.2 å¤šçº§æ ‡é¢˜</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># H1</span></span><br><span class="line"><span class="section">## H2</span></span><br><span class="line"><span class="section">### H3</span></span><br><span class="line"><span class="section">#### H4</span></span><br><span class="line"><span class="section">##### H5</span></span><br><span class="line"><span class="section">###### H6</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p>è§æœ¬æ–‡ç« æ ‡é¢˜!</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-3-æ–‡å­—æ ·å¼">1.3 æ–‡å­—æ ·å¼</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">u</span>&gt;</span></span>ä¸‹åˆ’çº¿æ¼”ç¤º<span class="language-xml"><span class="tag">&lt;/<span class="name">u</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">æ–‡å­—<span class="strong">**åŠ ç²—**</span>æ¼”ç¤º</span><br><span class="line"></span><br><span class="line">æ–‡å­—<span class="emphasis">*æ–œä½“*</span>æ¼”ç¤º</span><br><span class="line"></span><br><span class="line">æ–‡æœ¬<span class="code">`é«˜äº®`</span>æ¼”ç¤º</span><br><span class="line"></span><br><span class="line">æ–‡æœ¬~~åˆ é™¤~~çº¿æ¼”ç¤º</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">size</span> = <span class="string">5</span>&gt;</span></span>5å·å­—<span class="language-xml"><span class="tag">&lt;/<span class="name">font</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">face</span>=<span class="string">&quot;é»‘ä½“&quot;</span>&gt;</span></span>é»‘ä½“<span class="language-xml"><span class="tag">&lt;/<span class="name">font</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">blue</span>&gt;</span></span>è“è‰²<span class="language-xml"><span class="tag">&lt;/<span class="name">font</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">td</span> <span class="attr">bgcolor</span>=<span class="string">MistyRose</span>&gt;</span></span>è¿™é‡Œçš„èƒŒæ™¯è‰²æ˜¯ï¼šMistyRosenï¼Œæ­¤å¤„è¾“å…¥ä»»æ„æƒ³è¾“å…¥çš„å†…å®¹<span class="language-xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p><u>ä¸‹åˆ’çº¿æ¼”ç¤º</u></p><p>æ–‡å­—<strong>åŠ ç²—</strong>æ¼”ç¤º</p><p>æ–‡å­—<em>æ–œä½“</em>æ¼”ç¤º</p><p>æ–‡æœ¬<code>é«˜äº®</code>æ¼”ç¤º</p><p>æ–‡æœ¬<s>åˆ é™¤</s>çº¿æ¼”ç¤º</p><p><font size = 5>5å·å­—</font><br><font face="é»‘ä½“">é»‘ä½“</font><br><font color=blue>è“è‰²</font></p><table><tr><td bgcolor=MistyRose>è¿™é‡Œçš„èƒŒæ™¯è‰²æ˜¯ï¼šMistyRosenï¼Œæ­¤å¤„è¾“å…¥ä»»æ„æƒ³è¾“å…¥çš„å†…å®¹</td></tr></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="note info flat"><p>ä¸Šè¿°è¦ç‚¹å¯å‚è€ƒ:<a href="https://blog.csdn.net/qq_43732429/article/details/108034518">ã€Markdownè¯­æ³•ã€‘å­—ä½“é¢œè‰²å¤§å°åŠæ–‡å­—åº•è‰²è®¾ç½®</a></p></div><h2 id="1-4-å¼•ç”¨">1.4 å¼•ç”¨</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="quote">&gt;  Java</span></span><br><span class="line"><span class="quote">&gt; äºŒçº§å¼•ç”¨æ¼”ç¤º</span></span><br><span class="line"><span class="quote">&gt; MySQL</span></span><br><span class="line"><span class="quote">&gt; &gt;å¤–é”®</span></span><br><span class="line"><span class="quote">&gt; &gt;</span></span><br><span class="line"><span class="quote">&gt; &gt;äº‹åŠ¡</span></span><br><span class="line"><span class="quote">&gt; &gt;</span></span><br><span class="line"><span class="quote">&gt; &gt;<span class="strong">**è¡Œçº§é”**</span>(å¼•ç”¨å†…éƒ¨ä¸€æ ·å¯ä»¥ç”¨æ ¼å¼)</span></span><br><span class="line"><span class="quote">&gt; </span></span><br><span class="line"><span class="quote">&gt; ....</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><blockquote><p>Java<br>äºŒçº§å¼•ç”¨æ¼”ç¤º<br>MySQL</p><blockquote><p>å¤–é”®</p><p>äº‹åŠ¡</p><p><strong>è¡Œçº§é”</strong>(å¼•ç”¨å†…éƒ¨ä¸€æ ·å¯ä»¥ç”¨æ ¼å¼)</p></blockquote><p>â€¦</p></blockquote><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-5-åˆ†å‰²çº¿">1.5 åˆ†å‰²çº¿</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="strong">**<span class="emphasis">*</span></span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><hr><hr><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-6-åˆ—è¡¨-è·Ÿç©ºæ ¼éƒ½å¯ä»¥">1.6 åˆ—è¡¨(*,+,-è·Ÿç©ºæ ¼éƒ½å¯ä»¥)</h2><h3 id="1-6-1-æ— åºåˆ—è¡¨">1.6.1 æ— åºåˆ—è¡¨</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">*</span> Java</span><br><span class="line"><span class="bullet">*</span> Python</span><br><span class="line"><span class="bullet">*</span> ...</span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> Java</span><br><span class="line"><span class="bullet">+</span> Python</span><br><span class="line"><span class="bullet">+</span> ...</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Java</span><br><span class="line"><span class="bullet">-</span> Python</span><br><span class="line"><span class="bullet">-</span> ...</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ul><li>Java</li><li>Python</li><li>â€¦</li></ul><ul><li>Java</li><li>Python</li><li>â€¦</li></ul><ul><li>Java</li><li>Python</li><li>â€¦</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="1-6-2-æœ‰åºåˆ—è¡¨">1.6.2 æœ‰åºåˆ—è¡¨</h3><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># æ³¨æ„åé¢æœ‰ç©ºæ ¼</span></span><br><span class="line"><span class="bullet">1.</span> </span><br><span class="line"><span class="bullet">2.</span> </span><br><span class="line"><span class="bullet">3.</span> </span><br><span class="line"><span class="bullet">4.</span> </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li></li><li></li><li></li><li></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-7-å›¾ç‰‡">1.7 å›¾ç‰‡</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># æœ¬åœ°å›¾ç‰‡</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/assets/pusheencode.webp&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;ç¤ºä¾‹å›¾ç‰‡&quot;</span> <span class="attr">style</span>=<span class="string">&quot;zoom:50%;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="section"># åœ¨çº¿å›¾ç‰‡</span></span><br><span class="line">![<span class="string">code</span>](<span class="link">https://cdn.jsdelivr.net/gh/fomalhaut1998/markdown_pic/img/code.png</span>)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p>æœ¬åœ°å›¾ç‰‡:<br><img src="/assets/pusheencode.webp" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /><br>åœ¨çº¿å›¾ç‰‡:<br><img src="https://cdn.jsdelivr.net/gh/fomalhaut1998/markdown_pic/img/code.png" alt="code"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-8-è¡¨æ ¼">1.8 è¡¨æ ¼</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| é¡¹ç›®æ ‡å· | èµ„é‡‘     | å¤‡æ³¨ |</span><br><span class="line">| -------- | -------- | ---- |</span><br><span class="line">| 1        | 100ï¼Œ000 | æ—    |</span><br><span class="line">| 2        | 200ï¼Œ000 | æ—    |</span><br><span class="line">| 3        | 300,600  | é‡è¦ |</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><table><thead><tr><th>é¡¹ç›®æ ‡å·</th><th>èµ„é‡‘</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>1</td><td>100ï¼Œ000</td><td>æ— </td></tr><tr><td>2</td><td>200ï¼Œ000</td><td>æ— </td></tr><tr><td>3</td><td>300,600</td><td>é‡è¦</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="1-9-å…¬å¼">1.9 å…¬å¼</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$$</span><br><span class="line">\Gamma(z)=\int<span class="emphasis">_0^\infty t^&#123;z-1&#125;e^&#123;-t&#125;dt.</span></span><br><span class="line"><span class="emphasis">$$</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p>$$<br>\Gamma(z)=\int_0^\infty t^{z-1}e^{-t}dt.<br>$$</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1>2.Butterflyå¤–æŒ‚æ ‡ç­¾</h1><div class="note info flat"><p>è¿™éƒ¨åˆ†å‚è€ƒå®‰çŸ¥é±¼:<a href="https://anzhiy.cn/posts/7d58.html">åŸºäºButterflyçš„å¤–æŒ‚æ ‡ç­¾å¼•å…¥</a></p></div><h2 id="2-1-è¡Œå†…æ–‡æœ¬æ ·å¼-text">2.1 è¡Œå†…æ–‡æœ¬æ ·å¼ text</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% u æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% emp æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% wavy æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% del æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% kbd æ–‡æœ¬å†…å®¹ %&#125;</span><br><span class="line">&#123;% psw æ–‡æœ¬å†…å®¹ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> å¸¦ &#123;% u ä¸‹åˆ’çº¿ %&#125; çš„æ–‡æœ¬</span><br><span class="line"><span class="bullet">2.</span> å¸¦ &#123;% emp ç€é‡å· %&#125; çš„æ–‡æœ¬</span><br><span class="line"><span class="bullet">3.</span> å¸¦ &#123;% wavy æ³¢æµªçº¿ %&#125; çš„æ–‡æœ¬</span><br><span class="line"><span class="bullet">4.</span> å¸¦ &#123;% del åˆ é™¤çº¿ %&#125; çš„æ–‡æœ¬</span><br><span class="line"><span class="bullet">5.</span> é”®ç›˜æ ·å¼çš„æ–‡æœ¬ &#123;% kbd command %&#125; + &#123;% kbd D %&#125;</span><br><span class="line"><span class="bullet">6.</span> å¯†ç æ ·å¼çš„æ–‡æœ¬ï¼š&#123;% psw è¿™é‡Œæ²¡æœ‰éªŒè¯ç  %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><ol><li>å¸¦ <u>ä¸‹åˆ’çº¿</u> çš„æ–‡æœ¬</li><li>å¸¦ <emp>ç€é‡å·</emp> çš„æ–‡æœ¬</li><li>å¸¦ <wavy>æ³¢æµªçº¿</wavy> çš„æ–‡æœ¬</li><li>å¸¦ <del>åˆ é™¤çº¿</del> çš„æ–‡æœ¬</li><li>é”®ç›˜æ ·å¼çš„æ–‡æœ¬ <kbd>command</kbd> + <kbd>D</kbd></li><li>å¯†ç æ ·å¼çš„æ–‡æœ¬ï¼š<psw>è¿™é‡Œæ²¡æœ‰éªŒè¯ç </psw></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-2-è¡Œå†…æ–‡æœ¬-span">2.2 è¡Œå†…æ–‡æœ¬ span</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% span æ ·å¼å‚æ•°(å‚æ•°ä»¥ç©ºæ ¼åˆ’åˆ†), æ–‡æœ¬å†…å®¹ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>å­—ä½“</code>: logo, code</li><li><code>é¢œè‰²</code>: red,yellow,green,cyan,blue,gray</li><li><code>å¤§å°</code>: small, h4, h3, h2, h1, large, huge, ultra</li><li><code>å¯¹é½æ–¹å‘</code>: left, center, right</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> å½©è‰²æ–‡å­—</span><br><span class="line">åœ¨ä¸€æ®µè¯ä¸­æ–¹ä¾¿æ’å…¥å„ç§é¢œè‰²çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬ï¼š&#123;% span red, çº¢è‰² %&#125;ã€&#123;% span yellow, é»„è‰² %&#125;ã€&#123;% span green, ç»¿è‰² %&#125;ã€&#123;% span cyan, é’è‰² %&#125;ã€&#123;% span blue, è“è‰² %&#125;ã€&#123;% span gray, ç°è‰² %&#125;ã€‚</span><br><span class="line"><span class="bullet">-</span> è¶…å¤§å·æ–‡å­—</span><br><span class="line">æ–‡æ¡£ã€Œå¼€å§‹ã€é¡µé¢ä¸­çš„æ ‡é¢˜éƒ¨åˆ†å°±æ˜¯è¶…å¤§å·æ–‡å­—ã€‚</span><br><span class="line">&#123;% span center logo large, Volantis %&#125;</span><br><span class="line">&#123;% span center small, A Wonderful Theme for Hexo %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><ul><li>å½©è‰²æ–‡å­—<br>åœ¨ä¸€æ®µè¯ä¸­æ–¹ä¾¿æ’å…¥å„ç§é¢œè‰²çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬ï¼š<span class='p red'>çº¢è‰²</span>ã€<span class='p yellow'>é»„è‰²</span>ã€<span class='p green'>ç»¿è‰²</span>ã€<span class='p cyan'>é’è‰²</span>ã€<span class='p blue'>è“è‰²</span>ã€<span class='p gray'>ç°è‰²</span>ã€‚</li><li>è¶…å¤§å·æ–‡å­—<br>æ–‡æ¡£ã€Œå¼€å§‹ã€é¡µé¢ä¸­çš„æ ‡é¢˜éƒ¨åˆ†å°±æ˜¯è¶…å¤§å·æ–‡å­—ã€‚<br><span class='p center logo large'>Volantis</span><br><span class='p center small'>A Wonderful Theme for Hexo</span></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-3-æ®µè½æ–‡æœ¬-p">2.3 æ®µè½æ–‡æœ¬ p</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% p æ ·å¼å‚æ•°(å‚æ•°ä»¥ç©ºæ ¼åˆ’åˆ†), æ–‡æœ¬å†…å®¹ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>å­—ä½“</code>: logo, code</li><li><code>é¢œè‰²</code>: red,yellow,green,cyan,blue,gray</li><li><code>å¤§å°</code>: small, h4, h3, h2, h1, large, huge, ultra</li><li><code>å¯¹é½æ–¹å‘</code>: left, center, right</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> å½©è‰²æ–‡å­—</span><br><span class="line">åœ¨ä¸€æ®µè¯ä¸­æ–¹ä¾¿æ’å…¥å„ç§é¢œè‰²çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬ï¼š&#123;% p red, çº¢è‰² %&#125;ã€&#123;% p yellow, é»„è‰² %&#125;ã€&#123;% p green, ç»¿è‰² %&#125;ã€&#123;% p cyan, é’è‰² %&#125;ã€&#123;% p blue, è“è‰² %&#125;ã€&#123;% p gray, ç°è‰² %&#125;ã€‚</span><br><span class="line"><span class="bullet">-</span> è¶…å¤§å·æ–‡å­—</span><br><span class="line">æ–‡æ¡£ã€Œå¼€å§‹ã€é¡µé¢ä¸­çš„æ ‡é¢˜éƒ¨åˆ†å°±æ˜¯è¶…å¤§å·æ–‡å­—ã€‚</span><br><span class="line">&#123;% p center logo large, Volantis %&#125;</span><br><span class="line">&#123;% p center small, A Wonderful Theme for Hexo %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><ul><li>å½©è‰²æ–‡å­—<br>åœ¨ä¸€æ®µè¯ä¸­æ–¹ä¾¿æ’å…¥å„ç§é¢œè‰²çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬ï¼š<p class='p red'>çº¢è‰²</p>ã€<p class='p yellow'>é»„è‰²</p>ã€<p class='p green'>ç»¿è‰²</p>ã€<p class='p cyan'>é’è‰²</p>ã€<p class='p blue'>è“è‰²</p>ã€<p class='p gray'>ç°è‰²</p>ã€‚</li><li>è¶…å¤§å·æ–‡å­—<br>æ–‡æ¡£ã€Œå¼€å§‹ã€é¡µé¢ä¸­çš„æ ‡é¢˜éƒ¨åˆ†å°±æ˜¯è¶…å¤§å·æ–‡å­—ã€‚</li></ul><p class='p center logo large'>Volantis</p><p class='p center small'>A Wonderful Theme for Hexo</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-4-å¼•ç”¨note">2.4 å¼•ç”¨note</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">é€šç”¨é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">è¯­æ³•æ ¼å¼</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -5">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">note:</span><br><span class="line">  # Note tag style values:</span><br><span class="line">  #  - simple    bs-callout old alert style. Default.</span><br><span class="line">  #  - modern    bs-callout new (v2-v3) alert style.</span><br><span class="line">  #  - flat      flat callout style with background, like on Mozilla or StackOverflow.</span><br><span class="line">  #  - disabled  disable all CSS styles import of note tag.</span><br><span class="line">  style: simple</span><br><span class="line">  icons: false</span><br><span class="line">  border<span class="emphasis">_radius: 3</span></span><br><span class="line"><span class="emphasis">  # Offset lighter of background in % for modern and flat styles (modern: -12 | 12; flat: -18 | 6).</span></span><br><span class="line"><span class="emphasis">  # Offset also applied to label tag variables. This option can work with disabled note tag.</span></span><br><span class="line"><span class="emphasis">  light_</span>bg<span class="emphasis">_offset: 0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># è‡ªå¸¦icon</span></span><br><span class="line">&#123;% note [class] [no-icon] [style] %&#125;</span><br><span class="line">Any content (support inline tags too.io).</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"><span class="section"># å¤–éƒ¨icon</span></span><br><span class="line">&#123;% note [color] [icon] [style] %&#125;</span><br><span class="line">Any content (support inline tags too.io).</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.è‡ªå¸¦icon</p><table><thead><tr><th>å‚æ•°</th><th style="text-align:center">ç”¨æ³•</th></tr></thead><tbody><tr><td>class</td><td style="text-align:center">ã€å¯é€‰ã€‘æ ‡è¯†ï¼Œä¸åŒçš„æ ‡è¯†æœ‰ä¸åŒçš„é…è‰² ï¼ˆ default / primary / success / info / warning / danger ï¼‰</td></tr><tr><td>no-icon</td><td style="text-align:center">ã€å¯é€‰ã€‘ä¸æ˜¾ç¤º icon</td></tr><tr><td>style</td><td style="text-align:center">ã€å¯é€‰ã€‘å¯ä»¥è¦†ç›–é…ç½®ä¸­çš„ style ï¼ˆsimple/modern/flat/disabledï¼‰</td></tr></tbody></table><p>2.å¤–éƒ¨icon</p><table><thead><tr><th>å‚æ•°</th><th style="text-align:center">ç”¨æ³•</th></tr></thead><tbody><tr><td>class</td><td style="text-align:center">ã€å¯é€‰ã€‘æ ‡è¯†ï¼Œä¸åŒçš„æ ‡è¯†æœ‰ä¸åŒçš„é…è‰² ï¼ˆ default / blue / pink / red / purple / orange / green ï¼‰</td></tr><tr><td>no-icon</td><td style="text-align:center">ã€å¯é€‰ã€‘å¯é…ç½®è‡ªå®šä¹‰ icon (åªæ”¯æŒ fontawesome å›¾æ ‡, ä¹Ÿå¯ä»¥é…ç½® no-icon )</td></tr><tr><td>style</td><td style="text-align:center">ã€å¯é€‰ã€‘å¯ä»¥è¦†ç›–é…ç½®ä¸­çš„ style ï¼ˆsimple/modern/flat/disabledï¼‰</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><details class="folding-tag" blue><summary> 1.è‡ªå¸¦icon </summary>              <div class='content'>              <p>1.<code>simple</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note simple %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default simple %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary simple %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success simple %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info simple %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning simple %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger simple %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>2.<code>modern</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note modern %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default modern %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary modern %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success modern %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info modern %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning modern %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger modern %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>3.<code>flat</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note flat %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default flat %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary flat %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success flat %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info flat %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning flat %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger flat %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>4.<code>disabled</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note disabled %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default disabled %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary disabled %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success disabled %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info disabled %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning disabled %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger disabled %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>5.<code>no-icon</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note no-icon %&#125;é»˜è®¤ æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note default no-icon %&#125;default æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary no-icon %&#125;primary æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success no-icon %&#125;success æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info no-icon %&#125;info æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning no-icon %&#125;warning æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger no-icon %&#125;danger æç¤ºå—æ ‡ç­¾&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>              </div>            </details><details class="folding-tag" blue><summary> 2.å¤–éƒ¨icon </summary>              <div class='content'>              <p>1.<code>simple</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; simple %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; simple %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; simple %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; simple%&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; simple %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; simple %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; simple %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>2.<code>modern</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; modern %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; modern %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; modern %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; modern%&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; modern %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; modern %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; modern %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>3.<code>flat</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; flat %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; flat %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; flat %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; flat%&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; flat %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; flat %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; flat %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>4.<code>disabled</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note &#x27;fab fa-cc-visa&#x27; disabled %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue &#x27;fas fa-bullhorn&#x27; disabled %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink &#x27;fas fa-car-crash&#x27; disabled %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red &#x27;fas fa-fan&#x27; disabled %&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange &#x27;fas fa-battery-half&#x27; disabled %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple &#x27;far fa-hand-scissors&#x27; disabled %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green &#x27;fab fa-internet-explorer&#x27; disabled %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>5.<code>no-icon</code>æ ·å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% note no-icon %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note blue no-icon %&#125;2021å¹´å¿«åˆ°äº†....&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note pink no-icon %&#125;å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note red no-icon %&#125;è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note orange no-icon %&#125;ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note purple no-icon %&#125;å‰ªåˆ€çŸ³å¤´å¸ƒ&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note green no-icon %&#125;å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>              </div>            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -5"><details class="folding-tag" blue><summary> 1.è‡ªå¸¦icon </summary>              <div class='content'>              <p>1.<code>simple</code>æ ·å¼</p><div class="note simple"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default simple"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary simple"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success simple"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info simple"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning simple"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger simple"><p>danger æç¤ºå—æ ‡ç­¾</p></div>2.`modern`æ ·å¼<div class="note modern"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default modern"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary modern"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success modern"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info modern"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning modern"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger modern"><p>danger æç¤ºå—æ ‡ç­¾</p></div><p>3.<code>flat</code>æ ·å¼</p><div class="note flat"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default flat"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary flat"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success flat"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info flat"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning flat"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger flat"><p>danger æç¤ºå—æ ‡ç­¾</p></div><p>4.<code>disabled</code>æ ·å¼</p><div class="note disabled"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default disabled"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary disabled"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success disabled"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info disabled"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning disabled"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger disabled"><p>danger æç¤ºå—æ ‡ç­¾</p></div><p>5.<code>no-icon</code>æ ·å¼</p><div class="note no-icon flat"><p>é»˜è®¤ æç¤ºå—æ ‡ç­¾</p></div><div class="note default no-icon flat"><p>default æç¤ºå—æ ‡ç­¾</p></div><div class="note primary no-icon flat"><p>primary æç¤ºå—æ ‡ç­¾</p></div><div class="note success no-icon flat"><p>success æç¤ºå—æ ‡ç­¾</p></div><div class="note info no-icon flat"><p>info æç¤ºå—æ ‡ç­¾</p></div><div class="note warning no-icon flat"><p>warning æç¤ºå—æ ‡ç­¾</p></div><div class="note danger no-icon flat"><p>danger æç¤ºå—æ ‡ç­¾</p></div>              </div>            </details><details class="folding-tag" blue><summary> 2.å¤–éƒ¨icon </summary>              <div class='content'>              <p>1.<code>simple</code>æ ·å¼</p><div class="note icon-padding simple"><i class="note-icon fab fa-cc-visa"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue icon-padding simple"><i class="note-icon fas fa-bullhorn"></i><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink icon-padding simple"><i class="note-icon fas fa-car-crash"></i><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red icon-padding simple"><i class="note-icon fas fa-fan"></i><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange icon-padding simple"><i class="note-icon fas fa-battery-half"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple icon-padding simple"><i class="note-icon far fa-hand-scissors"></i><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green icon-padding simple"><i class="note-icon fab fa-internet-explorer"></i><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div><p>2.<code>modern</code>æ ·å¼</p><div class="note icon-padding modern"><i class="note-icon fab fa-cc-visa"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink icon-padding modern"><i class="note-icon fas fa-car-crash"></i><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red icon-padding modern"><i class="note-icon fas fa-fan"></i><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange icon-padding modern"><i class="note-icon fas fa-battery-half"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple icon-padding modern"><i class="note-icon far fa-hand-scissors"></i><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green icon-padding modern"><i class="note-icon fab fa-internet-explorer"></i><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div><p>3.<code>flat</code>æ ·å¼</p><div class="note icon-padding flat"><i class="note-icon fab fa-cc-visa"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue icon-padding flat"><i class="note-icon fas fa-bullhorn"></i><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink icon-padding flat"><i class="note-icon fas fa-car-crash"></i><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red icon-padding flat"><i class="note-icon fas fa-fan"></i><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange icon-padding flat"><i class="note-icon fas fa-battery-half"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple icon-padding flat"><i class="note-icon far fa-hand-scissors"></i><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green icon-padding flat"><i class="note-icon fab fa-internet-explorer"></i><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div><p>4.<code>disabled</code>æ ·å¼</p><div class="note icon-padding disabled"><i class="note-icon fab fa-cc-visa"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue icon-padding disabled"><i class="note-icon fas fa-bullhorn"></i><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink icon-padding disabled"><i class="note-icon fas fa-car-crash"></i><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red icon-padding disabled"><i class="note-icon fas fa-fan"></i><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange icon-padding disabled"><i class="note-icon fas fa-battery-half"></i><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple icon-padding disabled"><i class="note-icon far fa-hand-scissors"></i><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green icon-padding disabled"><i class="note-icon fab fa-internet-explorer"></i><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div><p>5.<code>no-icon</code>æ ·å¼</p><div class="note no-icon flat"><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note blue no-icon flat"><p>2021å¹´å¿«åˆ°äº†â€¦</p></div><div class="note pink no-icon flat"><p>å°å¿ƒå¼€è½¦ å®‰å…¨è‡³ä¸Š</p></div><div class="note red no-icon flat"><p>è¿™æ˜¯ä¸‰ç‰‡å‘¢ï¼Ÿè¿˜æ˜¯å››ç‰‡ï¼Ÿ</p></div><div class="note orange no-icon flat"><p>ä½ æ˜¯åˆ· Visa è¿˜æ˜¯ UnionPay</p></div><div class="note purple no-icon flat"><p>å‰ªåˆ€çŸ³å¤´å¸ƒ</p></div><div class="note green no-icon flat"><p>å‰ç«¯æœ€è®¨åŒçš„æµè§ˆå™¨</p></div>              </div>            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-5-ä¸Šæ ‡æ ‡ç­¾-tip">2.5 ä¸Šæ ‡æ ‡ç­¾ tip</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip [å‚æ•°ï¼Œå¯é€‰] %&#125;æ–‡æœ¬å†…å®¹&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>æ ·å¼</code>: success,error,warning,bolt,ban,home,sync,cogs,key,bell</li><li><code>è‡ªå®šä¹‰å›¾æ ‡</code>: æ”¯æŒfontawesomeã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip %&#125;default&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip info %&#125;info&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip success %&#125;success&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip error %&#125;error&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip warning %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip bolt %&#125;bolt&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban %&#125;ban&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip home %&#125;home&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip sync %&#125;sync&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip cogs %&#125;cogs&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip key %&#125;key&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip bell %&#125;bell&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip fa-atom %&#125;è‡ªå®šä¹‰font awesomeå›¾æ ‡&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class="tip "><p>default</p></div><div class="tip info"><p>info</p></div><div class="tip success"><p>success</p></div><div class="tip error"><p>error</p></div><div class="tip warning"><p>warning</p></div><div class="tip bolt"><p>bolt</p></div><div class="tip ban"><p>ban</p></div><div class="tip home"><p>home</p></div><div class="tip sync"><p>sync</p></div><div class="tip cogs"><p>cogs</p></div><div class="tip key"><p>key</p></div><div class="tip bell"><p>bell</p></div><div class="tip fa-atom"><p>è‡ªå®šä¹‰font awesomeå›¾æ ‡</p></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-6-åŠ¨æ€æ ‡ç­¾-anima">2.6 åŠ¨æ€æ ‡ç­¾ anima</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip [å‚æ•°ï¼Œå¯é€‰] %&#125;æ–‡æœ¬å†…å®¹&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><div class="note info flat"><ol><li>å°†æ‰€éœ€çš„CSSç±»æ·»åŠ åˆ°å›¾æ ‡ï¼ˆæˆ–DOMä¸­çš„ä»»ä½•å…ƒç´ ï¼‰ã€‚</li><li>å¯¹äºçˆ¶çº§æ‚¬åœæ ·å¼ï¼Œéœ€è¦ç»™ç›®æ ‡å…ƒç´ æ·»åŠ æŒ‡å®šCSSç±»ï¼ŒåŒæ—¶è¿˜è¦ç»™ç›®æ ‡å…ƒç´ çš„çˆ¶çº§å…ƒç´ æ·»åŠ CSSç±»<code>faa-parent animated-hover</code>ã€‚ï¼ˆè¯¦æƒ…è§ç¤ºä¾‹åŠç¤ºä¾‹æºç ï¼‰<br>You can regulate the speed of the animation by adding the CSS class or . faa-fastfaa-slow</li><li>å¯ä»¥é€šè¿‡ç»™ç›®æ ‡å…ƒç´ æ·»åŠ CSSç±»<code>faa-fast</code>æˆ–<code>faa-slow</code>æ¥æ§åˆ¶åŠ¨ç”»å¿«æ…¢ã€‚</li></ol></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.On DOM loadï¼ˆå½“é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-horizontal animated %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-flash animated %&#125;ban&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><p>2.è°ƒæ•´åŠ¨ç”»é€Ÿåº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-horizontal animated faa-fast %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-flash animated faa-slow %&#125;ban&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><p>3.On hoverï¼ˆå½“é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-horizontal animated-hover %&#125;warning&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-flash animated-hover %&#125;ban&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><p>4.On parent hoverï¼ˆå½“é¼ æ ‡æ‚¬åœåœ¨çˆ¶çº§å…ƒç´ æ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tip warning faa-parent animated-hover %&#125;<span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;faa-horizontal&quot;</span>&gt;</span></span>warning<span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>&#123;% endtip %&#125;</span><br><span class="line">&#123;% tip ban faa-parent animated-hover %&#125;<span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;faa-flash&quot;</span>&gt;</span></span>ban<span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>&#123;% endtip %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.On DOM loadï¼ˆå½“é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰</p><div class="tip warning faa-horizontal animated"><p>warning</p></div><div class="tip ban faa-flash animated"><p>ban</p></div>2.è°ƒæ•´åŠ¨ç”»é€Ÿåº¦<div class="tip warning faa-horizontal animated faa-fast"><p>warning</p></div><div class="tip ban faa-flash animated faa-slow"><p>ban</p></div>3.On hoverï¼ˆå½“é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰<div class="tip warning faa-horizontal animated-hover"><p>warning</p></div><div class="tip ban faa-flash animated-hover"><p>ban</p></div>4.On parent hoverï¼ˆå½“é¼ æ ‡æ‚¬åœåœ¨çˆ¶çº§å…ƒç´ æ—¶æ˜¾ç¤ºåŠ¨ç”»ï¼‰<div class="tip warning faa-parent animated-hover"><p class="faa-horizontal">warning</p></div><div class="tip ban faa-parent animated-hover"><p class="faa-flash">ban</p></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-7-å¤é€‰åˆ—è¡¨-checkbox">2.7 å¤é€‰åˆ—è¡¨ checkbox</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% checkbox æ ·å¼å‚æ•°ï¼ˆå¯é€‰ï¼‰, æ–‡æœ¬ï¼ˆæ”¯æŒç®€å•mdï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>æ ·å¼</code>: plus, minus, times</li><li><code>é¢œè‰²</code>: red,yellow,green,cyan,blue,gray</li><li><code>é€‰ä¸­çŠ¶æ€</code>: checked</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% checkbox çº¯æ–‡æœ¬æµ‹è¯• %&#125;</span><br><span class="line">&#123;% checkbox checked, æ”¯æŒç®€å•çš„ [<span class="string">markdown</span>](<span class="link">https://guides.github.com/features/mastering-markdown/</span>) è¯­æ³• %&#125;</span><br><span class="line">&#123;% checkbox red, æ”¯æŒè‡ªå®šä¹‰é¢œè‰² %&#125;</span><br><span class="line">&#123;% checkbox green checked, ç»¿è‰² + é»˜è®¤é€‰ä¸­ %&#125;</span><br><span class="line">&#123;% checkbox yellow checked, é»„è‰² + é»˜è®¤é€‰ä¸­ %&#125;</span><br><span class="line">&#123;% checkbox cyan checked, é’è‰² + é»˜è®¤é€‰ä¸­ %&#125;</span><br><span class="line">&#123;% checkbox blue checked, è“è‰² + é»˜è®¤é€‰ä¸­ %&#125;</span><br><span class="line">&#123;% checkbox plus green checked, å¢åŠ  %&#125;</span><br><span class="line">&#123;% checkbox minus yellow checked, å‡å°‘ %&#125;</span><br><span class="line">&#123;% checkbox times red checked, å‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class='checkbox'><input type="checkbox" />            <p>çº¯æ–‡æœ¬æµ‹è¯•</p>            </div><div class='checkbox checked'><input type="checkbox" checked="checked"/>            <p>æ”¯æŒç®€å•çš„ <a href="https://guides.github.com/features/mastering-markdown/">markdown</a> è¯­æ³•</p>            </div><div class='checkbox red'><input type="checkbox" />            <p>æ”¯æŒè‡ªå®šä¹‰é¢œè‰²</p>            </div><div class='checkbox green checked'><input type="checkbox" checked="checked"/>            <p>ç»¿è‰² + é»˜è®¤é€‰ä¸­</p>            </div><div class='checkbox yellow checked'><input type="checkbox" checked="checked"/>            <p>é»„è‰² + é»˜è®¤é€‰ä¸­</p>            </div><div class='checkbox cyan checked'><input type="checkbox" checked="checked"/>            <p>é’è‰² + é»˜è®¤é€‰ä¸­</p>            </div><div class='checkbox blue checked'><input type="checkbox" checked="checked"/>            <p>è“è‰² + é»˜è®¤é€‰ä¸­</p>            </div><div class='checkbox plus green checked'><input type="checkbox" checked="checked"/>            <p>å¢åŠ </p>            </div><div class='checkbox minus yellow checked'><input type="checkbox" checked="checked"/>            <p>å‡å°‘</p>            </div><div class='checkbox times red checked'><input type="checkbox" checked="checked"/>            <p>å‰</p>            </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-8-å•é€‰åˆ—è¡¨-radio">2.8 å•é€‰åˆ—è¡¨ radio</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% radio æ ·å¼å‚æ•°ï¼ˆå¯é€‰ï¼‰, æ–‡æœ¬ï¼ˆæ”¯æŒç®€å•mdï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>é¢œè‰²</code>: red,yellow,green,cyan,blue,gray</li><li><code>é€‰ä¸­çŠ¶æ€</code>: checked</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% radio çº¯æ–‡æœ¬æµ‹è¯• %&#125;</span><br><span class="line">&#123;% radio checked, æ”¯æŒç®€å•çš„ [<span class="string">markdown</span>](<span class="link">https://guides.github.com/features/mastering-markdown/</span>) è¯­æ³• %&#125;</span><br><span class="line">&#123;% radio red, æ”¯æŒè‡ªå®šä¹‰é¢œè‰² %&#125;</span><br><span class="line">&#123;% radio green, ç»¿è‰² %&#125;</span><br><span class="line">&#123;% radio yellow, é»„è‰² %&#125;</span><br><span class="line">&#123;% radio cyan, é’è‰² %&#125;</span><br><span class="line">&#123;% radio blue, è“è‰² %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class='checkbox'><input type="radio" />            <p>çº¯æ–‡æœ¬æµ‹è¯•</p>            </div><div class='checkbox checked'><input type="radio" checked="checked"/>            <p>æ”¯æŒç®€å•çš„ <a href="https://guides.github.com/features/mastering-markdown/">markdown</a> è¯­æ³•</p>            </div><div class='checkbox red'><input type="radio" />            <p>æ”¯æŒè‡ªå®šä¹‰é¢œè‰²</p>            </div><div class='checkbox green'><input type="radio" />            <p>ç»¿è‰²</p>            </div><div class='checkbox yellow'><input type="radio" />            <p>é»„è‰²</p>            </div><div class='checkbox cyan'><input type="radio" />            <p>é’è‰²</p>            </div><div class='checkbox blue'><input type="radio" />            <p>è“è‰²</p>            </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-9-æ—¶é—´è½´-timeline">2.9 æ—¶é—´è½´ timeline</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% timeline æ—¶é—´çº¿æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰[,color] %&#125;</span><br><span class="line">&lt;!-- timeline æ—¶é—´èŠ‚ç‚¹ï¼ˆæ ‡é¢˜ï¼‰ --&gt;</span><br><span class="line">æ­£æ–‡å†…å®¹</span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line">&lt;!-- timeline æ—¶é—´èŠ‚ç‚¹ï¼ˆæ ‡é¢˜ï¼‰ --&gt;</span><br><span class="line">æ­£æ–‡å†…å®¹</span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line">&#123;% endtimeline %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>title</code>:æ ‡é¢˜/æ—¶é—´çº¿</li><li><code>color</code>:<code>timeline</code>é¢œè‰²:default(ç•™ç©º) / blue / pink / red / purple / orange / green</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;% timeline æ—¶é—´è½´æ ·å¼,blue %&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- timeline 2020-07-24 [<span class="string">2.6.6 -&gt; 3.0</span>](<span class="link">https://github.com/volantis-x/hexo-theme-volantis/releases</span>) --&gt;</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> å¦‚æœæœ‰ <span class="code">`hexo-lazyload-image`</span> æ’ä»¶ï¼Œéœ€è¦åˆ é™¤å¹¶é‡æ–°å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œè®¾ç½® <span class="code">`lazyload.isSPA: true`</span>ã€‚</span><br><span class="line"><span class="bullet">2.</span> 2.x ç‰ˆæœ¬çš„ css å’Œ js ä¸é€‚ç”¨äº 3.x ç‰ˆæœ¬ï¼Œå¦‚æœä½¿ç”¨äº† <span class="code">`use_cdn: true`</span> åˆ™éœ€è¦åˆ é™¤ã€‚</span><br><span class="line"><span class="bullet">3.</span> 2.x ç‰ˆæœ¬çš„ fancybox æ ‡ç­¾åœ¨ 3.x ç‰ˆæœ¬ä¸­è¢«é‡å‘½åä¸º gallery ã€‚</span><br><span class="line"><span class="bullet">4.</span> 2.x ç‰ˆæœ¬çš„ç½®é¡¶ <span class="code">`top: true`</span> æ”¹ä¸ºäº† <span class="code">`pin: true`</span>ï¼Œå¹¶ä¸”åŒæ ·é€‚ç”¨äº <span class="code">`layout: page`</span> çš„é¡µé¢ã€‚</span><br><span class="line"><span class="bullet">5.</span> å¦‚æœä½¿ç”¨äº† <span class="code">`hexo-offline`</span> æ’ä»¶ï¼Œå»ºè®®å¸è½½ï¼Œ3.0 ç‰ˆæœ¬é»˜è®¤å¼€å¯äº† pjax æœåŠ¡ã€‚</span><br><span class="line"></span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- timeline 2020-05-15 [<span class="string">2.6.3 -&gt; 2.6.6</span>](<span class="link">https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.6</span>) --&gt;</span><br><span class="line"></span><br><span class="line">ä¸éœ€è¦é¢å¤–å¤„ç†ã€‚</span><br><span class="line"></span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- timeline 2020-04-20 [<span class="string">2.6.2 -&gt; 2.6.3</span>](<span class="link">https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.3</span>) --&gt;</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> å…¨å±€æœç´¢ <span class="code">`seotitle`</span> å¹¶æ›¿æ¢ä¸º <span class="code">`seo_title`</span>ã€‚</span><br><span class="line"><span class="bullet">2.</span> group ç»„ä»¶çš„ç´¢å¼•è§„åˆ™æœ‰å˜ï¼Œä½¿ç”¨ group ç»„ä»¶çš„æ–‡ç« å†…ï¼Œ<span class="code">`group: group_name`</span> å¯¹åº”çš„ç»„ä»¶åå¿…é¡»æ˜¯ <span class="code">`group_name`</span>ã€‚</span><br><span class="line"><span class="bullet">2.</span> group ç»„ä»¶çš„åˆ—è¡¨åä¼˜å…ˆæ˜¾ç¤ºæ–‡ç« çš„ <span class="code">`short_title`</span> å…¶æ¬¡æ˜¯ <span class="code">`title`</span>ã€‚</span><br><span class="line"></span><br><span class="line">&lt;!-- endtimeline --&gt;</span><br><span class="line"></span><br><span class="line">&#123;% endtimeline %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class="timeline blue"><div class='timeline-item headline'><div class='timeline-item-title'><div class='item-circle'><p>æ—¶é—´è½´æ ·å¼</p></div></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2020-07-24 <a href="https://github.com/volantis-x/hexo-theme-volantis/releases">2.6.6 -&gt; 3.0</a></p></div></div><div class='timeline-item-content'><ol><li>å¦‚æœæœ‰ <code>hexo-lazyload-image</code> æ’ä»¶ï¼Œéœ€è¦åˆ é™¤å¹¶é‡æ–°å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œè®¾ç½® <code>lazyload.isSPA: true</code>ã€‚</li><li>2.x ç‰ˆæœ¬çš„ css å’Œ js ä¸é€‚ç”¨äº 3.x ç‰ˆæœ¬ï¼Œå¦‚æœä½¿ç”¨äº† <code>use_cdn: true</code> åˆ™éœ€è¦åˆ é™¤ã€‚</li><li>2.x ç‰ˆæœ¬çš„ fancybox æ ‡ç­¾åœ¨ 3.x ç‰ˆæœ¬ä¸­è¢«é‡å‘½åä¸º gallery ã€‚</li><li>2.x ç‰ˆæœ¬çš„ç½®é¡¶ <code>top: true</code> æ”¹ä¸ºäº† <code>pin: true</code>ï¼Œå¹¶ä¸”åŒæ ·é€‚ç”¨äº <code>layout: page</code> çš„é¡µé¢ã€‚</li><li>å¦‚æœä½¿ç”¨äº† <code>hexo-offline</code> æ’ä»¶ï¼Œå»ºè®®å¸è½½ï¼Œ3.0 ç‰ˆæœ¬é»˜è®¤å¼€å¯äº† pjax æœåŠ¡ã€‚</li></ol></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2020-05-15 <a href="https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.6">2.6.3 -&gt; 2.6.6</a></p></div></div><div class='timeline-item-content'><p>ä¸éœ€è¦é¢å¤–å¤„ç†ã€‚</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2020-04-20 <a href="https://github.com/volantis-x/hexo-theme-volantis/releases/tag/2.6.3">2.6.2 -&gt; 2.6.3</a></p></div></div><div class='timeline-item-content'><ol><li>å…¨å±€æœç´¢ <code>seotitle</code> å¹¶æ›¿æ¢ä¸º <code>seo_title</code>ã€‚</li><li>group ç»„ä»¶çš„ç´¢å¼•è§„åˆ™æœ‰å˜ï¼Œä½¿ç”¨ group ç»„ä»¶çš„æ–‡ç« å†…ï¼Œ<code>group: group_name</code> å¯¹åº”çš„ç»„ä»¶åå¿…é¡»æ˜¯ <code>group_name</code>ã€‚</li><li>group ç»„ä»¶çš„åˆ—è¡¨åä¼˜å…ˆæ˜¾ç¤ºæ–‡ç« çš„ <code>short_title</code> å…¶æ¬¡æ˜¯ <code>title</code>ã€‚</li></ol></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-10-é“¾æ¥å¡ç‰‡-link">2.10 é“¾æ¥å¡ç‰‡ link</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% link æ ‡é¢˜, é“¾æ¥, å›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% link ç³–æœå±‹æ•™ç¨‹è´´, https://akilar.top/posts/615e2dec/, https://cdn.cbd.int/akilar-candyassets@1.0.36/image/siteicon/favicon.ico %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><div class="tag link"><a class="link-card" title="ç³–æœå±‹æ•™ç¨‹è´´" href="https://akilar.top/posts/615e2dec/"><div class="left"><img src="https://cdn.cbd.int/akilar-candyassets@1.0.36/image/siteicon/favicon.ico"/></div><div class="right"><p class="text">ç³–æœå±‹æ•™ç¨‹è´´</p><p class="url">https://akilar.top/posts/615e2dec/</p></div></a></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-11-æŒ‰é’®-btns">2.11 æŒ‰é’® btns</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns æ ·å¼å‚æ•° %&#125;</span><br><span class="line">&#123;% cell æ ‡é¢˜, é“¾æ¥, å›¾ç‰‡æˆ–è€…å›¾æ ‡ %&#125;</span><br><span class="line">&#123;% cell æ ‡é¢˜, é“¾æ¥, å›¾ç‰‡æˆ–è€…å›¾æ ‡ %&#125;</span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li>åœ†è§’æ ·å¼ï¼šrounded, circle</li><li>å¢åŠ æ–‡å­—æ ·å¼ï¼šå¯ä»¥åœ¨å®¹å™¨å†…å¢åŠ  <code>&lt;b&gt;</code>æ ‡é¢˜<code>&lt;/b&gt;</code>å’Œ<code>&lt;p&gt;</code>æè¿°æ–‡å­—<code>&lt;/p&gt;</code></li><li>å¸ƒå±€æ–¹å¼ï¼š<br>é»˜è®¤ä¸ºè‡ªåŠ¨å®½åº¦ï¼Œé€‚åˆè§†é‡å†…åªæœ‰ä¸€ä¸¤ä¸ªçš„æƒ…å†µã€‚</li></ol><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>wide</td><td>å®½ä¸€ç‚¹çš„æŒ‰é’®</td></tr><tr><td>fill</td><td>å¡«å……å¸ƒå±€ï¼Œè‡ªåŠ¨é“ºæ»¡è‡³å°‘ä¸€è¡Œï¼Œå¤šäº†ä¼šæ¢è¡Œ</td></tr><tr><td>center</td><td>å±…ä¸­ï¼ŒæŒ‰é’®ä¹‹é—´æ˜¯å›ºå®šé—´è·</td></tr><tr><td>around</td><td>å±…ä¸­åˆ†æ•£</td></tr><tr><td>grid2</td><td>ç­‰å®½æœ€å¤š2åˆ—ï¼Œå±å¹•å˜çª„ä¼šé€‚å½“å‡å°‘åˆ—æ•°</td></tr><tr><td>grid3</td><td>ç­‰å®½æœ€å¤š3åˆ—ï¼Œå±å¹•å˜çª„ä¼šé€‚å½“å‡å°‘åˆ—æ•°</td></tr><tr><td>grid4</td><td>ç­‰å®½æœ€å¤š4åˆ—ï¼Œå±å¹•å˜çª„ä¼šé€‚å½“å‡å°‘åˆ—æ•°</td></tr><tr><td>grid5</td><td>ç­‰å®½æœ€å¤š5åˆ—ï¼Œå±å¹•å˜çª„ä¼šé€‚å½“å‡å°‘åˆ—æ•°</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.å¦‚æœéœ€è¦æ˜¾ç¤ºç±»ä¼¼ã€Œå›¢é˜Ÿæˆå‘˜ã€ä¹‹ç±»çš„ä¸€ç»„å«æœ‰å¤´åƒçš„é“¾æ¥</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns circle grid5 %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% cell xaoxuu, https://xaoxuu.com, https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png %&#125;</span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><p>2.æˆ–è€…å«æœ‰å›¾æ ‡çš„æŒ‰é’®</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns rounded grid5 %&#125;</span><br><span class="line">&#123;% cell ä¸‹è½½æºç , /, fas fa-download %&#125;</span><br><span class="line">&#123;% cell æŸ¥çœ‹æ–‡æ¡£, /, fas fa-book-open %&#125;</span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><p>3.åœ†å½¢å›¾æ ‡ + æ ‡é¢˜ + æè¿° + å›¾ç‰‡ + ç½‘æ ¼5åˆ— + å±…ä¸­</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% btns circle center grid5 %&#125;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;https://apps.apple.com/cn/app/heart-mate-pro-hrm-utility/id1463348922?ls=1&#x27;</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&#x27;fab fa-apple&#x27;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">b</span>&gt;</span></span>å¿ƒç‡ç®¡å®¶<span class="language-xml"><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span></span><br><span class="line">  &#123;% p red, ä¸“ä¸šç‰ˆ %&#125;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_pro.png&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;https://apps.apple.com/cn/app/heart-mate-lite-hrm-utility/id1475747930?ls=1&#x27;</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&#x27;fab fa-apple&#x27;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">b</span>&gt;</span></span>å¿ƒç‡ç®¡å®¶<span class="language-xml"><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span></span><br><span class="line">  &#123;% p green, å…è´¹ç‰ˆ %&#125;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_lite.png&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">&#123;% endbtns %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.å¦‚æœéœ€è¦æ˜¾ç¤ºç±»ä¼¼ã€Œå›¢é˜Ÿæˆå‘˜ã€ä¹‹ç±»çš„ä¸€ç»„å«æœ‰å¤´åƒçš„é“¾æ¥</p><div class="btns circle grid5">            <a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a><a class="button" href='https://xaoxuu.com' title='xaoxuu'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png'>xaoxuu</a>          </div>2.æˆ–è€…å«æœ‰å›¾æ ‡çš„æŒ‰é’®<div class="btns rounded grid5">            <a class="button" href='/' title='ä¸‹è½½æºç '><i class='fas fa-download'></i>ä¸‹è½½æºç </a><a class="button" href='/' title='æŸ¥çœ‹æ–‡æ¡£'><i class='fas fa-book-open'></i>æŸ¥çœ‹æ–‡æ¡£</a>          </div>3.åœ†å½¢å›¾æ ‡ + æ ‡é¢˜ + æè¿° + å›¾ç‰‡ + ç½‘æ ¼5åˆ— + å±…ä¸­<div class="btns circle center grid5">            <a href='https://apps.apple.com/cn/app/heart-mate-pro-hrm-utility/id1463348922?ls=1'>  <i class='fab fa-apple'></i>  <b>å¿ƒç‡ç®¡å®¶</b>  <p class='p red'>ä¸“ä¸šç‰ˆ</p>  <img src='https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_pro.png'></a><a href='https://apps.apple.com/cn/app/heart-mate-lite-hrm-utility/id1475747930?ls=1'>  <i class='fab fa-apple'></i>  <b>å¿ƒç‡ç®¡å®¶</b>  <p class='p green'>å…è´¹ç‰ˆ</p>  <img src='https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/qrcode/heartmate_lite.png'></a>          </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-12-githubå¡ç‰‡-ghcard">2.12 githubå¡ç‰‡ ghcard</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% ghcard ç”¨æˆ·å, å…¶å®ƒå‚æ•°ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br><span class="line">&#123;% ghcard ç”¨æˆ·å/ä»“åº“, å…¶å®ƒå‚æ•°ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><p>ä½¿ç”¨<code>,</code>åˆ†å‰²å„ä¸ªå‚æ•°ã€‚å†™æ³•ä¸ºï¼š<code>å‚æ•°å=å‚æ•°å€¼</code><br>ä»¥ä¸‹åªå†™å‡ ä¸ªå¸¸ç”¨å‚æ•°å€¼ã€‚</p><table><thead><tr><th><strong>å‚æ•°å</strong></th><th>å–å€¼</th><th>é‡Šä¹‰</th></tr></thead><tbody><tr><td>hide</td><td>stars,commits,prs,issues,contribs</td><td>éšè—æŒ‡å®šç»Ÿè®¡</td></tr><tr><td>count_private</td><td>true</td><td>å°†ç§äººé¡¹ç›®è´¡çŒ®æ·»åŠ åˆ°æ€»æäº¤è®¡æ•°ä¸­</td></tr><tr><td>show_icons</td><td>true</td><td>æ˜¾ç¤ºå›¾æ ‡</td></tr><tr><td>theme</td><td>æŸ¥é˜…:<a href="https://github.com/anuraghazra/github-readme-stats/blob/master/themes/README.md">Available Themes</a></td><td>ä¸»é¢˜</td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.ç”¨æˆ·ä¿¡æ¯å¡ç‰‡</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| &#123;% ghcard fomalhaut1998 %&#125; | &#123;% ghcard fomalhaut1998, theme=vue %&#125; |</span><br><span class="line">| -- | -- |</span><br><span class="line">| &#123;% ghcard fomalhaut1998, theme=buefy %&#125; | &#123;% ghcard fomalhaut1998, theme=solarized-light %&#125; |</span><br><span class="line">| &#123;% ghcard fomalhaut1998, theme=onedark %&#125; | &#123;% ghcard fomalhaut1998, theme=solarized-dark %&#125; |</span><br><span class="line">| &#123;% ghcard fomalhaut1998, theme=algolia %&#125; | &#123;% ghcard fomalhaut1998, theme=calm %&#125; |</span><br></pre></td></tr></table></figure><p>2.ä»“åº“ä¿¡æ¯å¡ç‰‡</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=vue %&#125; |</span><br><span class="line">| -- | -- |</span><br><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis, theme=buefy %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=solarized-light %&#125; |</span><br><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis, theme=onedark %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=solarized-dark %&#125; |</span><br><span class="line">| &#123;% ghcard volantis-x/hexo-theme-volantis, theme=algolia %&#125; | &#123;% ghcard volantis-x/hexo-theme-volantis, theme=calm %&#125; |</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.ç”¨æˆ·ä¿¡æ¯å¡ç‰‡</p><table><thead><tr><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&show_owner=true"/></a></th><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=vue&show_owner=true"/></a></th></tr></thead><tbody><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=buefy&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=solarized-light&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=onedark&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=solarized-dark&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=algolia&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/fomalhaut1998"><img src="https://github-readme-stats.vercel.app/api/?username=fomalhaut1998&theme=calm&show_owner=true"/></a></td></tr></tbody></table><p>2.ä»“åº“ä¿¡æ¯å¡ç‰‡</p><table><thead><tr><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&show_owner=true"/></a></th><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=vue&show_owner=true"/></a></th></tr></thead><tbody><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=buefy&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=solarized-light&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=onedark&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=solarized-dark&show_owner=true"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=algolia&show_owner=true"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/volantis-x/hexo-theme-volantis"><img src="https://github-readme-stats.vercel.app/api/pin/?username=volantis-x&repo=hexo-theme-volantis&theme=calm&show_owner=true"/></a></td></tr></tbody></table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-13-githubå¾½æ ‡-ghbdage">2.13 githubå¾½æ ‡ ghbdage</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage [right],[left],[logo]||[color],[link],[title]||[option] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>left</code>ï¼šå¾½æ ‡å·¦è¾¹çš„ä¿¡æ¯ï¼Œå¿…é€‰å‚æ•°ã€‚</li><li><code>right</code>: å¾½æ ‡å³è¾¹çš„ä¿¡æ¯ï¼Œå¿…é€‰å‚æ•°ï¼Œ</li><li><code>logo</code>ï¼šå¾½æ ‡å›¾æ ‡ï¼Œå›¾æ ‡åç§°è¯¦è§<a href="https://simpleicons.org/">simpleicons</a>ï¼Œå¯é€‰å‚æ•°ã€‚</li><li><code>color</code>ï¼šå¾½æ ‡å³è¾¹çš„é¢œè‰²ï¼Œå¯é€‰å‚æ•°ã€‚</li><li><code>link</code>ï¼šæŒ‡å‘çš„é“¾æ¥ï¼Œå¯é€‰å‚æ•°ã€‚</li><li><code>title</code>ï¼šå¾½æ ‡çš„é¢å¤–ä¿¡æ¯ï¼Œå¯é€‰å‚æ•°ã€‚ä¸»è¦ç”¨äºä¼˜åŒ–SEOï¼Œä½†<code>object</code>æ ‡ç­¾ä¸ä¼šåƒ<code>a</code>æ ‡ç­¾ä¸€æ ·åœ¨é¼ æ ‡æ‚¬åœæ˜¾ç¤º<code>title</code>ä¿¡æ¯ã€‚</li><li><code>option</code>ï¼šè‡ªå®šä¹‰å‚æ•°ï¼Œæ”¯æŒ<a href="https://shields.io/">shields.io</a>çš„å…¨éƒ¨APIå‚æ•°æ”¯æŒï¼Œå…·ä½“å‚æ•°å¯ä»¥å‚çœ‹ä¸Šæ–‡ä¸­çš„æ‹“å±•å†™æ³•ç¤ºä¾‹ã€‚å½¢å¼ä¸º<code>name1=value2&amp;name2=value2</code>ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.åŸºæœ¬å‚æ•°,å®šä¹‰å¾½æ ‡å·¦å³æ–‡å­—å’Œå›¾æ ‡</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage Theme,Butterfly %&#125;</span><br><span class="line">&#123;% bdage Frame,Hexo,hexo %&#125;</span><br></pre></td></tr></table></figure><p>2.ä¿¡æ¯å‚æ•°ï¼Œå®šä¹‰å¾½æ ‡å³ä¾§å†…å®¹èƒŒæ™¯è‰²ï¼ŒæŒ‡å‘é“¾æ¥</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage CDN,JsDelivr,jsDelivr||abcdef,https://metroui.org.ua/index.html,æœ¬ç«™ä½¿ç”¨JsDelivrä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ %&#125;</span><br><span class="line">//å¦‚æœæ˜¯è·¨é¡ºåºçœç•¥å¯é€‰å‚æ•°ï¼Œä»ç„¶éœ€è¦å†™ä¸ªé€—å·,ç”¨ä½œåˆ†å‰²</span><br><span class="line">&#123;% bdage Source,GitHub,GitHub||,https://github.com/ %&#125;</span><br></pre></td></tr></table></figure><p>3.æ‹“å±•å‚æ•°ï¼Œæ”¯æŒshieldsçš„APIçš„å…¨éƒ¨å‚æ•°å†…å®¹</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bdage Hosted,Vercel,Vercel||brightgreen,https://vercel.com/,æœ¬ç«™é‡‡ç”¨åŒçº¿éƒ¨ç½²ï¼Œé»˜è®¤çº¿è·¯æ‰˜ç®¡äºVercel||style=social&amp;logoWidth=20 %&#125;</span><br><span class="line">//å¦‚æœæ˜¯è·¨é¡ºåºçœç•¥å¯é€‰å‚æ•°ç»„ï¼Œä»ç„¶éœ€è¦å†™åŒç«–çº¿||ç”¨ä½œåˆ†å‰²</span><br><span class="line">&#123;% bdage Hosted,Vercel,Vercel||||style=social&amp;logoWidth=20&amp;logoColor=violet %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.åŸºæœ¬å‚æ•°,å®šä¹‰å¾½æ ‡å·¦å³æ–‡å­—å’Œå›¾æ ‡</p><p><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/Butterfly-Theme-orange?logo=&color=orange&link=&"></object><br><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/Hexo-Frame-orange?logo=hexo&color=orange&link=&"></object></p><p>2.ä¿¡æ¯å‚æ•°ï¼Œå®šä¹‰å¾½æ ‡å³ä¾§å†…å®¹èƒŒæ™¯è‰²ï¼ŒæŒ‡å‘é“¾æ¥</p><p><object class="ghbdage" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨JsDelivrä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ" standby="loading..." data="https://img.shields.io/badge/JsDelivr-CDN-orange?logo=jsDelivr&color=abcdef&link=https://metroui.org.ua/index.html&"></object><br>//å¦‚æœæ˜¯è·¨é¡ºåºçœç•¥å¯é€‰å‚æ•°ï¼Œä»ç„¶éœ€è¦å†™ä¸ªé€—å·,ç”¨ä½œåˆ†å‰²<br><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/GitHub-Source-orange?logo=GitHub&color=orange&link=https://github.com/&"></object></p><p>3.æ‹“å±•å‚æ•°ï¼Œæ”¯æŒshieldsçš„APIçš„å…¨éƒ¨å‚æ•°å†…å®¹</p><p><object class="ghbdage" style="margin-inline:5px" title="æœ¬ç«™é‡‡ç”¨åŒçº¿éƒ¨ç½²ï¼Œé»˜è®¤çº¿è·¯æ‰˜ç®¡äºVercel" standby="loading..." data="https://img.shields.io/badge/Vercel-Hosted-orange?logo=Vercel&color=brightgreen&link=https://vercel.com/&style=social&logoWidth=20"></object><br>//å¦‚æœæ˜¯è·¨é¡ºåºçœç•¥å¯é€‰å‚æ•°ç»„ï¼Œä»ç„¶éœ€è¦å†™åŒç«–çº¿||ç”¨ä½œåˆ†å‰²<br><object class="ghbdage" style="margin-inline:5px" title="" standby="loading..." data="https://img.shields.io/badge/Vercel-Hosted-orange?logo=Vercel&color=orange&link=&style=social&logoWidth=20&logoColor=violet"></object></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-14-ç½‘ç«™å¡ç‰‡-sites">2.14 ç½‘ç«™å¡ç‰‡ sites</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% sitegroup %&#125;</span><br><span class="line">&#123;% site æ ‡é¢˜, url=é“¾æ¥, screenshot=æˆªå›¾é“¾æ¥, avatar=å¤´åƒé“¾æ¥ï¼ˆå¯é€‰ï¼‰, description=æè¿°ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br><span class="line">&#123;% site æ ‡é¢˜, url=é“¾æ¥, screenshot=æˆªå›¾é“¾æ¥, avatar=å¤´åƒé“¾æ¥ï¼ˆå¯é€‰ï¼‰, description=æè¿°ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br><span class="line">&#123;% endsitegroup %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% sitegroup %&#125;</span><br><span class="line">&#123;% site xaoxuu, url=https://xaoxuu.com, screenshot=https://i.loli.net/2020/08/21/VuSwWZ1xAeUHEBC.jpg, avatar=https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/avatar/avatar.png, description=ç®€çº¦é£æ ¼ %&#125;</span><br><span class="line">&#123;% site inkss, url=https://inkss.cn, screenshot=https://i.loli.net/2020/08/21/Vzbu3i8fXs6Nh5Y.jpg, avatar=https://cdn.jsdelivr.net/gh/inkss/common@master/static/web/avatar.jpg, description=è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­— %&#125;</span><br><span class="line">&#123;% site MHuiG, url=https://blog.mhuig.top, screenshot=https://i.loli.net/2020/08/22/d24zpPlhLYWX6D1.png, avatar=https://cdn.jsdelivr.net/gh/MHuiG/imgbed@master/data/p.png, description=è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­— %&#125;</span><br><span class="line">&#123;% site Colsrch, url=https://colsrch.top, screenshot=https://i.loli.net/2020/08/22/dFRWXm52OVu8qfK.png, avatar=https://cdn.jsdelivr.net/gh/Colsrch/images/Colsrch/avatar.jpg, description=è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­— %&#125;</span><br><span class="line">&#123;% site Linhk1606, url=https://linhk1606.github.io, screenshot=https://i.loli.net/2020/08/21/3PmGLCKicnfow1x.png, avatar=https://i.loli.net/2020/02/09/PN7I5RJfFtA93r2.png, description=è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­— %&#125;</span><br><span class="line">&#123;% endsitegroup %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><div class="site-card-group"><a class="site-card" href="https://fomalhaut1998.com"><div class="img"><img src="https://i.loli.net/2020/08/21/VuSwWZ1xAeUHEBC.jpg"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/fomalhaut1998/cdn-assets/avatar/avatar.png"/><span class="title">fomalhaut1998</span><span class="desc">ç®€çº¦é£æ ¼</span></div></a><a class="site-card" href="https://inkss.cn"><div class="img"><img src="https://i.loli.net/2020/08/21/Vzbu3i8fXs6Nh5Y.jpg"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/inkss/common@master/static/web/avatar.jpg"/><span class="title">inkss</span><span class="desc">è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­—</span></div></a><a class="site-card" href="https://blog.mhuig.top"><div class="img"><img src="https://i.loli.net/2020/08/22/d24zpPlhLYWX6D1.png"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/MHuiG/imgbed@master/data/p.png"/><span class="title">MHuiG</span><span class="desc">è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­—</span></div></a><a class="site-card" href="https://colsrch.top"><div class="img"><img src="https://i.loli.net/2020/08/22/dFRWXm52OVu8qfK.png"/></div><div class="info"><img src="https://cdn.jsdelivr.net/gh/Colsrch/images/Colsrch/avatar.jpg"/><span class="title">Colsrch</span><span class="desc">è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­—</span></div></a><a class="site-card" href="https://linhk1606.github.io"><div class="img"><img src="https://i.loli.net/2020/08/21/3PmGLCKicnfow1x.png"/></div><div class="info"><img src="https://i.loli.net/2020/02/09/PN7I5RJfFtA93r2.png"/><span class="title">Linhk1606</span><span class="desc">è¿™æ˜¯ä¸€æ®µå…³äºè¿™ä¸ªç½‘ç«™çš„æè¿°æ–‡å­—</span></div></a></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-15-è¡Œå†…å›¾ç‰‡-inlineimage">2.15 è¡Œå†…å›¾ç‰‡ inlineimage</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% inlineimage å›¾ç‰‡é“¾æ¥, height=é«˜åº¦ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>é«˜åº¦</code>ï¼šheight=20px</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¿™æ˜¯ &#123;% inlineimage https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/0000.gif %&#125; ä¸€æ®µè¯ã€‚</span><br><span class="line"></span><br><span class="line">è¿™åˆæ˜¯ &#123;% inlineimage https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/5150.gif, height=40px %&#125; ä¸€æ®µè¯ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>è¿™æ˜¯ <img no-lazy class="inline" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/0000.gif" style="height:1.5em"/> ä¸€æ®µè¯ã€‚</p><p>è¿™åˆæ˜¯ <img no-lazy class="inline" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/aru-l/5150.gif" style="height:40px;"/> ä¸€æ®µè¯ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-16-å•å¼ å›¾ç‰‡-image">2.16 å•å¼ å›¾ç‰‡ image</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image é“¾æ¥, width=å®½åº¦ï¼ˆå¯é€‰ï¼‰, height=é«˜åº¦ï¼ˆå¯é€‰ï¼‰, alt=æè¿°ï¼ˆå¯é€‰ï¼‰, bg=å ä½é¢œè‰²ï¼ˆå¯é€‰ï¼‰ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li>å›¾ç‰‡å®½åº¦é«˜åº¦ï¼šwidth=300px, height=32px</li><li>å›¾ç‰‡æè¿°ï¼šalt=å›¾ç‰‡æè¿°ï¼ˆbutterflyéœ€è¦åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­å¼€å¯å›¾ç‰‡æè¿°ï¼‰</li><li>å ä½èƒŒæ™¯è‰²ï¼šbg=#f2f2f2</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.æ·»åŠ æè¿°ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, alt=æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚ %&#125;</span><br></pre></td></tr></table></figure><p>2.æŒ‡å®šå®½åº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, width=400px %&#125;</span><br></pre></td></tr></table></figure><p>3.æŒ‡å®šå®½åº¦å¹¶æ·»åŠ æè¿°ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, width=400px, alt=æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚ %&#125;</span><br></pre></td></tr></table></figure><p>4.è®¾ç½®å ä½èƒŒæ™¯è‰²ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg, width=400px, bg=#1D0C04, alt=ä¼˜åŒ–ä¸åŒå®½åº¦æµè§ˆçš„è§‚æ„Ÿ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.æ·»åŠ æè¿°ï¼š</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" alt="æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚"/></div><span class="image-caption">æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚</span></div>2..æŒ‡å®šå®½åº¦<div class="img-wrap"><div class="img-bg"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" style="width:400px;"/></div></div>3.æŒ‡å®šå®½åº¦å¹¶æ·»åŠ æè¿°ï¼š<div class="img-wrap"><div class="img-bg"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" alt="æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚" style="width:400px;"/></div><span class="image-caption">æ¯å¤©ä¸‹è¯¾å›å®¿èˆçš„è·¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•…äº‹ã€‚</span></div>4.è®¾ç½®å ä½èƒŒæ™¯è‰²ï¼š<div class="img-wrap"><div class="img-bg" style="background:#1D0C04"><img class="img" src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg" alt="ä¼˜åŒ–ä¸åŒå®½åº¦æµè§ˆçš„è§‚æ„Ÿ" style="width:400px;"/></div><span class="image-caption">ä¼˜åŒ–ä¸åŒå®½åº¦æµè§ˆçš„è§‚æ„Ÿ</span></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-17-éŸ³é¢‘-audio">2.17 éŸ³é¢‘ audio</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% audio éŸ³é¢‘é“¾æ¥ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% audio https://github.com/volantis-x/volantis-docs/releases/download/assets/Lumia1020.mp3 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><div class="audio"><audio controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/Lumia1020.mp3' type='audio/mp3'>Your browser does not support the audio tag.</audio></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-18-è§†é¢‘-video">2.18 è§†é¢‘ video</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% video è§†é¢‘é“¾æ¥ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>å¯¹é½æ–¹å‘</code>ï¼šleft, center, right</li><li><code>åˆ—æ•°</code>ï¼šé€—å·åé¢ç›´æ¥å†™åˆ—æ•°ï¼Œæ”¯æŒ 1 ï½ 4 åˆ—ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.100%å®½åº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br></pre></td></tr></table></figure><p>2.50%å®½åº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% videos, 2 %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% endvideos %&#125;</span><br></pre></td></tr></table></figure><p>3.25%å®½åº¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% videos, 4 %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG<span class="emphasis">_0341.mov %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% video https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_</span>0341.mov %&#125;</span><br><span class="line">&#123;% endvideos %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.100%å®½åº¦</p><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div>2.50%å®½åº¦<div class="videos" col='2'><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div></div>3.25%å®½åº¦<div class="videos" col='4'><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://github.com/volantis-x/volantis-docs/releases/download/assets/IMG_0341.mov' type='video/mp4'>Your browser does not support the video tag.</video></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-19-ç›¸å†Œ-gallery">2.19 ç›¸å†Œ gallery</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><p>1.gallerygroup ç›¸å†Œå›¾åº“</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery-group-main&quot;</span>&gt;</span></span></span><br><span class="line">&#123;% galleryGroup name description link img-url %&#125;</span><br><span class="line">&#123;% galleryGroup name description link img-url %&#125;</span><br><span class="line">&#123;% galleryGroup name description link img-url %&#125;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>2.gallery ç›¸å†Œ</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% gallery %&#125;</span><br><span class="line">markdown åœ–ç‰‡æ ¼å¼</span><br><span class="line">&#123;% endgallery %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ul><li>gallerygroup ç›¸å†Œå›¾åº“</li></ul><table><thead><tr><th>å‚æ•°å</th><th>é‡Šä¹‰</th></tr></thead><tbody><tr><td>name</td><td>å›¾åº“åå­—</td></tr><tr><td>description</td><td>å›¾åº“æè¿°</td></tr><tr><td>link</td><td>é“¾æ¥åˆ°å¯¹åº”ç›¸å†Œçš„åœ°å€</td></tr><tr><td>img-url</td><td>å›¾åº“å°é¢</td></tr></tbody></table><ul><li><p>gallery ç›¸å†Œ</p><p>åŒºåˆ«äºæ—§ç‰ˆçš„Galleryç›¸å†Œ,æ–°çš„Galleryç›¸å†Œä¼šè‡ªåŠ¨æ ¹æ®å›¾ç‰‡é•¿åº¦è¿›è¡Œæ’ç‰ˆï¼Œä¹¦å†™ä¹Ÿæ›´åŠ æ–¹ä¾¿ï¼Œä¸markdownæ ¼å¼ä¸€æ ·ã€‚å¯æ ¹æ®éœ€è¦æ’å…¥åˆ°ç›¸åº”çš„mdã€‚æ— éœ€å†è‡ªå·±é…ç½®é•¿å®½ã€‚<strong>å»ºè®®åœ¨ç²˜è´´æ—¶æ•…æ„ä½¿ç”¨é•¿çŸ­ã€å¤§å°ã€æ¨ªç«–ä¸ä¸€çš„å›¾ç‰‡</strong>ï¼Œä¼šæœ‰æ›´å¥½çš„æ•ˆæœã€‚ï¼ˆå°ºå¯¸å®Œå…¨ç›¸åŒçš„å›¾ç‰‡åªä¼šå¹³é“ºè¾“å‡ºï¼Œæ•ˆæœå¾ˆç³Ÿç³•ï¼‰</p></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.gallerygroup ç›¸å†Œå›¾åº“</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery-group-main&quot;</span>&gt;</span></span></span><br><span class="line">&#123;% galleryGroup MC åœ¨Rikkaã®å…­èŠ±æœåŠ¡å™¨é‡Œç•™ä¸‹çš„è¶³è¿¹ &#x27;/gallery/MC/&#x27; https://cdn.cbd.int/akilar-candyassets@1.0.36/image/1.jpg %&#125;</span><br><span class="line">&#123;% galleryGroup Gundam å“¦å’§å“‡gundamå“’ï¼ &#x27;/gallery/Gundam/&#x27; https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907110508327.png %&#125;</span><br><span class="line">&#123;% galleryGroup I-am-Akilar æŸç§æ„ä¹‰ä¸Šä¹Ÿç®—è‡ªæ‹å§ &#x27;/gallery/I-am-Akilar/&#x27; https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907113116651.png %&#125;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>2.gallery ç›¸å†Œ</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% gallery %&#125;</span><br><span class="line">![](<span class="link">https://i.loli.net/2019/12/25/Fze9jchtnyJXMHN.jpg</span>)</span><br><span class="line">![](<span class="link">https://i.loli.net/2019/12/25/ryLVePaqkYm4TEK.jpg</span>)</span><br><span class="line">&#123;% endgallery %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.gallerygroup ç›¸å†Œå›¾åº“</p><div class="gallery-group-main">  <figure class="gallery-group">  <img class="gallery-group-img no-lightbox" src='https://cdn.cbd.int/akilar-candyassets@1.0.36/image/1.jpg' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">MC</div>  <p>åœ¨Rikkaã®å…­èŠ±æœåŠ¡å™¨é‡Œç•™ä¸‹çš„è¶³è¿¹</p>  <a href='/gallery/MC/'></a>  </figcaption>  </figure>  <figure class="gallery-group">  <img class="gallery-group-img no-lightbox" src='https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907110508327.png' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">Gundam</div>  <p>å“¦å’§å“‡gundamå“’ï¼</p>  <a href='/gallery/Gundam/'></a>  </figcaption>  </figure>  <figure class="gallery-group">  <img class="gallery-group-img no-lightbox" src='https://cdn.cbd.int/akilar-candyassets@1.0.36/image/20200907113116651.png' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">I-am-Akilar</div>  <p>æŸç§æ„ä¹‰ä¸Šä¹Ÿç®—è‡ªæ‹å§</p>  <a href='/gallery/I-am-Akilar/'></a>  </figcaption>  </figure></div>2.gallery ç›¸å†Œ<div class="fj-gallery"><p><img src="https://i.loli.net/2019/12/25/Fze9jchtnyJXMHN.jpg" alt=""><br><img src="https://i.loli.net/2019/12/25/ryLVePaqkYm4TEK.jpg" alt=""></p>          </div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-20-æŠ˜å æ¡†-folding">2.20 æŠ˜å æ¡† folding</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><p>1.gallerygroup ç›¸å†Œå›¾åº“</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% folding å‚æ•°ï¼ˆå¯é€‰ï¼‰, æ ‡é¢˜ %&#125;</span><br><span class="line">![](<span class="link">https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg</span>)</span><br><span class="line">&#123;% endfolding %&#125;</span><br></pre></td></tr></table></figure><!-- tab å‚æ•°é…ç½® --><ol><li><p><code>é¢œè‰²</code>ï¼šblue, cyan, green, yellow, red</p></li><li><p><code>çŠ¶æ€</code>ï¼šçŠ¶æ€å¡«å†™ open ä»£è¡¨é»˜è®¤æ‰“å¼€ã€‚</p></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;% folding æŸ¥çœ‹å›¾ç‰‡æµ‹è¯• %&#125;</span><br><span class="line"></span><br><span class="line">![](<span class="link">https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg</span>)</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding cyan open, æŸ¥çœ‹é»˜è®¤æ‰“å¼€çš„æŠ˜å æ¡† %&#125;</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯ä¸€ä¸ªé»˜è®¤æ‰“å¼€çš„æŠ˜å æ¡†ã€‚</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding green, æŸ¥çœ‹ä»£ç æµ‹è¯• %&#125;</span><br><span class="line">å‡è£…è¿™é‡Œæœ‰ä»£ç å—ï¼ˆä»£ç å—æ²¡æ³•åµŒå¥—ä»£ç å—ï¼‰</span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding yellow, æŸ¥çœ‹åˆ—è¡¨æµ‹è¯• %&#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> haha</span><br><span class="line"><span class="bullet">-</span> hehe</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding red, æŸ¥çœ‹åµŒå¥—æµ‹è¯• %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding blue, æŸ¥çœ‹åµŒå¥—æµ‹è¯•2 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% folding æŸ¥çœ‹åµŒå¥—æµ‹è¯•3 %&#125;</span><br><span class="line"></span><br><span class="line">hahaha <span class="language-xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/tieba/%E6%BB%91%E7%A8%BD.png&#x27;</span> <span class="attr">style</span>=<span class="string">&#x27;height:24px&#x27;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endfolding %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><details class="folding-tag" ><summary> æŸ¥çœ‹å›¾ç‰‡æµ‹è¯• </summary>              <div class='content'>              <p><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg" alt=""></p>              </div>            </details><details class="folding-tag" cyan open><summary> æŸ¥çœ‹é»˜è®¤æ‰“å¼€çš„æŠ˜å æ¡† </summary>              <div class='content'>              <p>è¿™æ˜¯ä¸€ä¸ªé»˜è®¤æ‰“å¼€çš„æŠ˜å æ¡†ã€‚</p>              </div>            </details><details class="folding-tag" green><summary> æŸ¥çœ‹ä»£ç æµ‹è¯• </summary>              <div class='content'>              <p>å‡è£…è¿™é‡Œæœ‰ä»£ç å—ï¼ˆä»£ç å—æ²¡æ³•åµŒå¥—ä»£ç å—ï¼‰</p>              </div>            </details><details class="folding-tag" yellow><summary> æŸ¥çœ‹åˆ—è¡¨æµ‹è¯• </summary>              <div class='content'>              <ul><li>haha</li><li>hehe</li></ul>              </div>            </details><details class="folding-tag" red><summary> æŸ¥çœ‹åµŒå¥—æµ‹è¯• </summary>              <div class='content'>              <details class="folding-tag" blue><summary> æŸ¥çœ‹åµŒå¥—æµ‹è¯•2 </summary>              <div class='content'>              <details class="folding-tag" ><summary> æŸ¥çœ‹åµŒå¥—æµ‹è¯•3 </summary>              <div class='content'>              <p>hahaha <span><img src='https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/tieba/%E6%BB%91%E7%A8%BD.png' style='height:24px'></span></p>              </div>            </details>              </div>            </details>              </div>            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-21-åˆ†æ -tab">2.21 åˆ†æ  tab</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">é…ç½®å‚æ•°</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs Unique name, [index] %&#125;</span><br><span class="line">&lt;!-- tab [Tab caption] [@icon] --&gt;</span><br><span class="line">Any content (support inline tags too).</span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><p>Unique name :</p><ul><li><p>é€‰é¡¹å¡å—æ ‡ç­¾çš„å”¯ä¸€åç§°ï¼Œä¸å¸¦é€—å·ã€‚</p></li><li><p>å°†åœ¨#idä¸­ç”¨ä½œæ¯ä¸ªæ ‡ç­¾åŠå…¶ç´¢å¼•å·çš„å‰ç¼€ã€‚</p></li><li><p>å¦‚æœåç§°ä¸­åŒ…å«ç©ºæ ¼ï¼Œåˆ™å¯¹äºç”Ÿæˆ#idï¼Œæ‰€æœ‰ç©ºæ ¼å°†ç”±ç ´æŠ˜å·ä»£æ›¿ã€‚</p></li><li><p>ä»…å½“å‰å¸–å­/é¡µé¢çš„URLå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼</p></li></ul></li><li><p>[index]:</p><ul><li><p>æ´»åŠ¨é€‰é¡¹å¡çš„ç´¢å¼•å·ã€‚</p></li><li><p>å¦‚æœæœªæŒ‡å®šï¼Œå°†é€‰æ‹©ç¬¬ä¸€ä¸ªæ ‡ç­¾ï¼ˆ1ï¼‰ã€‚</p></li><li><p>å¦‚æœindexä¸º-1ï¼Œåˆ™ä¸ä¼šé€‰æ‹©ä»»ä½•é€‰é¡¹å¡ã€‚</p></li><li><p>å¯é€‰å‚æ•°ã€‚</p></li></ul></li><li><p>[Tab caption]:</p><ul><li><p>å½“å‰é€‰é¡¹å¡çš„æ ‡é¢˜ã€‚</p></li><li><p>å¦‚æœæœªæŒ‡å®šæ ‡é¢˜ï¼Œåˆ™å¸¦æœ‰åˆ¶è¡¨ç¬¦ç´¢å¼•åç¼€çš„å”¯ä¸€åç§°å°†ç”¨ä½œåˆ¶è¡¨ç¬¦çš„æ ‡é¢˜ã€‚</p></li><li><p>å¦‚æœæœªæŒ‡å®šæ ‡é¢˜ï¼Œä½†æŒ‡å®šäº†å›¾æ ‡ï¼Œåˆ™æ ‡é¢˜å°†ä¸ºç©ºã€‚</p></li><li><p>å¯é€‰å‚æ•°ã€‚</p></li></ul></li><li><p>[@icon]:</p><ul><li><p>FontAwesomeå›¾æ ‡åç§°ï¼ˆå…¨åï¼Œçœ‹èµ·æ¥åƒâ€œ fas fa-fontâ€ï¼‰</p></li><li><p>å¯ä»¥æŒ‡å®šå¸¦ç©ºæ ¼æˆ–ä¸å¸¦ç©ºæ ¼ï¼›</p></li><li><p>ä¾‹å¦‚â€™Tab caption @iconâ€™ å’Œ â€˜Tab caption@iconâ€™.</p></li><li><p>å¯é€‰å‚æ•°ã€‚</p></li></ul></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.Demo 1 - é¢„è®¾é€‰æ‹©ç¬¬ä¸€ä¸ªã€é»˜è®¤ã€‘</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test1 %&#125;</span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 1.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 2.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 3.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><p>2.Demo 2 - é¢„è®¾é€‰æ‹©tabs</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test2, 3 %&#125;</span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 1.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 2.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 3.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><p>3.Demo 3 - æ²¡æœ‰é¢„è®¾å€¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test3, -1 %&#125;</span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 1.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 2.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab --&gt;</span><br><span class="line"><span class="strong">**This is Tab 3.**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><p>4.Demo 4 - è‡ªå®šä¹‰Tabå + åªæœ‰icon + iconå’ŒTabå</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tabs test4 %&#125;</span><br><span class="line">&lt;!-- tab ç¬¬ä¸€ä¸ªTab --&gt;</span><br><span class="line"><span class="strong">**tabåå­—ä¸ºç¬¬ä¸€ä¸ªTab**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab @fab fa-apple-pay --&gt;</span><br><span class="line"><span class="strong">**åªæœ‰å›¾æ ‡ æ²¡æœ‰Tabåå­—**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- tab ç‚¸å¼¹@fas fa-bomb --&gt;</span><br><span class="line"><span class="strong">**åå­—+icon**</span></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.Demo 1 - é¢„è®¾é€‰æ‹©ç¬¬ä¸€ä¸ªã€é»˜è®¤ã€‘</p><div class="tabs" id="test1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test1-1">test1 1</button></li><li class="tab"><button type="button" data-href="#test1-2">test1 2</button></li><li class="tab"><button type="button" data-href="#test1-3">test1 3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test1-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test1-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test1-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>2.Demo 2 - é¢„è®¾é€‰æ‹©tabs</p><div class="tabs" id="test2"><ul class="nav-tabs"><li class="tab"><button type="button" data-href="#test2-1">test2 1</button></li><li class="tab"><button type="button" data-href="#test2-2">test2 2</button></li><li class="tab active"><button type="button" data-href="#test2-3">test2 3</button></li></ul><div class="tab-contents"><div class="tab-item-content" id="test2-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test2-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content active" id="test2-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>3.Demo 3 - æ²¡æœ‰é¢„è®¾å€¼</p><div class="tabs" id="test3"><ul class="nav-tabs"><li class="tab"><button type="button" data-href="#test3-1">test3 1</button></li><li class="tab"><button type="button" data-href="#test3-2">test3 2</button></li><li class="tab"><button type="button" data-href="#test3-3">test3 3</button></li></ul><div class="tab-contents"><div class="tab-item-content" id="test3-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test3-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test3-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>4.Demo 4 - è‡ªå®šä¹‰Tabå + åªæœ‰icon + iconå’ŒTabå</p><div class="tabs" id="test4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test4-1">ç¬¬ä¸€ä¸ªTab</button></li><li class="tab"><button type="button" data-href="#test4-2"><i class="fab fa-apple-pay" style="text-align: center;"></i></button></li><li class="tab"><button type="button" data-href="#test4-3"><i class="fas fa-bomb"></i>ç‚¸å¼¹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test4-1"><p><strong>tabåå­—ä¸ºç¬¬ä¸€ä¸ªTab</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test4-2"><p><strong>åªæœ‰å›¾æ ‡ æ²¡æœ‰Tabåå­—</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test4-3"><p><strong>åå­—+icon</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-22-è¯—è¯æ ‡ç­¾-poem">2.22 è¯—è¯æ ‡ç­¾ poem</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><ol><li><code>title</code>ï¼šè¯—è¯æ ‡é¢˜</li><li><code>author</code>ï¼šä½œè€…ï¼Œå¯ä»¥ä¸å†™</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% poem æ°´è°ƒæ­Œå¤´,è‹è½¼ %&#125;</span><br><span class="line">ä¸™è¾°ä¸­ç§‹ï¼Œæ¬¢é¥®è¾¾æ—¦ï¼Œå¤§é†‰ï¼Œä½œæ­¤ç¯‡ï¼Œå…¼æ€€å­ç”±ã€‚</span><br><span class="line">æ˜æœˆå‡ æ—¶æœ‰ï¼ŸæŠŠé…’é—®é’å¤©ã€‚</span><br><span class="line">ä¸çŸ¥å¤©ä¸Šå®«é˜™ï¼Œä»Šå¤•æ˜¯ä½•å¹´ï¼Ÿ</span><br><span class="line">æˆ‘æ¬²ä¹˜é£å½’å»ï¼Œåˆæç¼æ¥¼ç‰å®‡ï¼Œé«˜å¤„ä¸èƒœå¯’ã€‚</span><br><span class="line">èµ·èˆå¼„æ¸…å½±ï¼Œä½•ä¼¼åœ¨äººé—´ï¼Ÿ</span><br><span class="line"></span><br><span class="line">è½¬æœ±é˜ï¼Œä½ç»®æˆ·ï¼Œç…§æ— çœ ã€‚</span><br><span class="line">ä¸åº”æœ‰æ¨ï¼Œä½•äº‹é•¿å‘åˆ«æ—¶åœ†ï¼Ÿ</span><br><span class="line">äººæœ‰æ‚²æ¬¢ç¦»åˆï¼Œæœˆæœ‰é˜´æ™´åœ†ç¼ºï¼Œæ­¤äº‹å¤éš¾å…¨ã€‚</span><br><span class="line">ä½†æ„¿äººé•¿ä¹…ï¼Œåƒé‡Œå…±å©µå¨Ÿã€‚</span><br><span class="line">&#123;% endpoem %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><div class='poem'><div class='poem-title'>æ°´è°ƒæ­Œå¤´</div><div class='poem-author'>è‹è½¼</div><p>ä¸™è¾°ä¸­ç§‹ï¼Œæ¬¢é¥®è¾¾æ—¦ï¼Œå¤§é†‰ï¼Œä½œæ­¤ç¯‡ï¼Œå…¼æ€€å­ç”±ã€‚<br>æ˜æœˆå‡ æ—¶æœ‰ï¼ŸæŠŠé…’é—®é’å¤©ã€‚<br>ä¸çŸ¥å¤©ä¸Šå®«é˜™ï¼Œä»Šå¤•æ˜¯ä½•å¹´ï¼Ÿ<br>æˆ‘æ¬²ä¹˜é£å½’å»ï¼Œåˆæç¼æ¥¼ç‰å®‡ï¼Œé«˜å¤„ä¸èƒœå¯’ã€‚<br>èµ·èˆå¼„æ¸…å½±ï¼Œä½•ä¼¼åœ¨äººé—´ï¼Ÿ</p><p>è½¬æœ±é˜ï¼Œä½ç»®æˆ·ï¼Œç…§æ— çœ ã€‚<br>ä¸åº”æœ‰æ¨ï¼Œä½•äº‹é•¿å‘åˆ«æ—¶åœ†ï¼Ÿ<br>äººæœ‰æ‚²æ¬¢ç¦»åˆï¼Œæœˆæœ‰é˜´æ™´åœ†ç¼ºï¼Œæ­¤äº‹å¤éš¾å…¨ã€‚<br>ä½†æ„¿äººé•¿ä¹…ï¼Œåƒé‡Œå…±å©µå¨Ÿã€‚</p></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-23-é˜¿é‡Œå›¾æ ‡-icon">2.23 é˜¿é‡Œå›¾æ ‡ icon</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% icon [icon-xxxx],[font-size] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>icon-xxxx</code>ï¼šè¡¨ç¤ºå›¾æ ‡<code>font-class</code>,å¯ä»¥åœ¨è‡ªå·±çš„é˜¿é‡ŒçŸ¢é‡å›¾æ ‡åº“é¡¹ç›®çš„<code>font-class</code>å¼•ç”¨æ–¹æ¡ˆå†…æŸ¥è¯¢å¹¶å¤åˆ¶ã€‚</li><li><code>font-size</code>ï¼šè¡¨ç¤ºå›¾æ ‡å¤§å°ï¼Œç›´æ¥å¡«å†™æ•°å­—å³å¯ï¼Œå•ä½ä¸º<code>em</code>ã€‚å›¾æ ‡å¤§å°é»˜è®¤å€¼ä¸º<code>1em</code>ã€‚</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;% icon icon-rat<span class="emphasis">_zi %&#125;&#123;% icon icon-rat,2 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-ox_</span>chou,3 %&#125;&#123;% icon icon-ox,4 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-tiger<span class="emphasis">_yin,5 %&#125;&#123;% icon icon-tiger,6 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-rabbit_</span>mao,1 %&#125;&#123;% icon icon-rabbit,2 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-dragon<span class="emphasis">_chen,3 %&#125;&#123;% icon icon-dragon,4 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-snake_</span>si,5 %&#125;&#123;% icon icon-snake,6 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-horse<span class="emphasis">_wu %&#125;&#123;% icon icon-horse,2 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-goat_</span>wei,3 %&#125;&#123;% icon icon-goat,4 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-monkey<span class="emphasis">_shen,5 %&#125;&#123;% icon icon-monkey,6 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-rooster_</span>you %&#125;&#123;% icon icon-rooster,2 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% icon icon-dog<span class="emphasis">_xu,3 %&#125;&#123;% icon icon-dog,4 %&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">&#123;% icon icon-boar_</span>hai,5 %&#125;&#123;% icon icon-boar,6 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-rat_zi"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-rat"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-ox_chou"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-ox"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-tiger_yin"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-tiger"></use></svg></p><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-rabbit_mao"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-rabbit"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-dragon_chen"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-dragon"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-snake_si"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-snake"></use></svg></p><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-horse_wu"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-horse"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-goat_wei"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-goat"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-monkey_shen"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-monkey"></use></svg></p><p><svg class="icon" style="width:1em; height:1em" aria-hidden="true"><use xlink:href="#icon-rooster_you"></use></svg><svg class="icon" style="width:2em; height:2em" aria-hidden="true"><use xlink:href="#icon-rooster"></use></svg></p><p><svg class="icon" style="width:3em; height:3em" aria-hidden="true"><use xlink:href="#icon-dog_xu"></use></svg><svg class="icon" style="width:4em; height:4em" aria-hidden="true"><use xlink:href="#icon-dog"></use></svg></p><p><svg class="icon" style="width:5em; height:5em" aria-hidden="true"><use xlink:href="#icon-boar_hai"></use></svg><svg class="icon" style="width:6em; height:6em" aria-hidden="true"><use xlink:href="#icon-boar"></use></svg></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-24-ç‰¹æ•ˆæ ‡ç­¾wow">2.24 ç‰¹æ•ˆæ ‡ç­¾wow</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ¸²æŸ“æ¼”ç¤º</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow [animete],[duration],[delay],[offset],[iteration] %&#125;</span><br><span class="line">å†…å®¹</span><br><span class="line">&#123;% endwow %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>animate</code>: åŠ¨ç”»æ ·å¼ï¼Œæ•ˆæœè¯¦è§<a href="https://animate.style/">animate.csså‚è€ƒæ–‡æ¡£</a></li><li><code>duration</code>: é€‰å¡«é¡¹ï¼ŒåŠ¨ç”»æŒç»­æ—¶é—´ï¼Œå•ä½å¯ä»¥æ˜¯<code>ms</code>ä¹Ÿå¯ä»¥æ˜¯<code>s</code>ã€‚ä¾‹å¦‚<code>3s</code>ï¼Œ<code>700ms</code>ã€‚</li><li><code>delay</code>: é€‰å¡«é¡¹ï¼ŒåŠ¨ç”»å¼€å§‹çš„å»¶è¿Ÿæ—¶é—´ï¼Œå•ä½å¯ä»¥æ˜¯<code>ms</code>ä¹Ÿå¯ä»¥æ˜¯<code>s</code>ã€‚ä¾‹å¦‚<code>3s</code>ï¼Œ<code>700ms</code>ã€‚</li><li><code>offset</code>: é€‰å¡«é¡¹ï¼Œå¼€å§‹åŠ¨ç”»çš„è·ç¦»ï¼ˆç›¸å¯¹æµè§ˆå™¨åº•éƒ¨ï¼‰</li><li><code>iteration</code>: é€‰å¡«é¡¹ï¼ŒåŠ¨ç”»é‡å¤çš„æ¬¡æ•°</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><p>1.flipåŠ¨ç”»æ•ˆæœã€‚</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__zoomIn,5s,5s,100,10 %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note blue &#x27;fas fa-bullhorn&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`zoomIn`åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­`5s`ï¼Œå»¶æ—¶`5s`ï¼Œç¦»åº•éƒ¨`100`è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤`10`æ¬¡</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><p>2.zoomInåŠ¨ç”»æ•ˆæœï¼ŒæŒç»­5sï¼Œå»¶æ—¶5sï¼Œç¦»åº•éƒ¨100è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤10æ¬¡</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__zoomIn,5s,5s,100,10 %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note blue &#x27;fas fa-bullhorn&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`zoomIn`åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­`5s`ï¼Œå»¶æ—¶`5s`ï¼Œç¦»åº•éƒ¨`100`è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤`10`æ¬¡</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><p>3.slideInRightåŠ¨ç”»æ•ˆæœï¼ŒæŒç»­5sï¼Œå»¶æ—¶5s</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__slideInRight,5s,5s %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note orange &#x27;fas fa-car&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`slideInRight`åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­`5s`ï¼Œå»¶æ—¶`5s`ã€‚</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><p>4.heartBeatåŠ¨ç”»æ•ˆæœï¼Œå»¶æ—¶5sï¼Œé‡å¤10æ¬¡ã€‚æ­¤å¤„æ³¨æ„ä¸ç”¨çš„å‚æ•°ä½ç½®è¦ç•™ç©ºï¼Œç”¨é€—å·é—´éš”ã€‚</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% wow animate<span class="strong">__heartBeat,,5s,,10 %&#125;</span></span><br><span class="line"><span class="strong">&#123;% note red &#x27;fas fa-battery-half&#x27; modern%&#125;</span></span><br><span class="line"><span class="strong">`heartBeat`åŠ¨ç”»æ•ˆæœï¼Œå»¶æ—¶`5s`ï¼Œé‡å¤`10`æ¬¡ã€‚</span></span><br><span class="line"><span class="strong">&#123;% endnote %&#125;</span></span><br><span class="line"><span class="strong">&#123;% endwow %&#125;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>1.flipåŠ¨ç”»æ•ˆæœã€‚</p><div class='wow animate__zoomIn' data-wow-duration='5s' data-wow-delay='5s' data-wow-offset='100'  data-wow-iteration='10' ><div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i><p><code>zoomIn</code>åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­<code>5s</code>ï¼Œå»¶æ—¶<code>5s</code>ï¼Œç¦»åº•éƒ¨<code>100</code>è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤<code>10</code>æ¬¡</p></div></div><p>2.zoomInåŠ¨ç”»æ•ˆæœï¼ŒæŒç»­5sï¼Œå»¶æ—¶5sï¼Œç¦»åº•éƒ¨100è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤10æ¬¡</p><div class='wow animate__zoomIn' data-wow-duration='5s' data-wow-delay='5s' data-wow-offset='100'  data-wow-iteration='10' ><div class="note blue icon-padding modern"><i class="note-icon fas fa-bullhorn"></i><p><code>zoomIn</code>åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­<code>5s</code>ï¼Œå»¶æ—¶<code>5s</code>ï¼Œç¦»åº•éƒ¨<code>100</code>è·ç¦»æ—¶å¯åŠ¨ï¼Œé‡å¤<code>10</code>æ¬¡</p></div></div><p>3.slideInRightåŠ¨ç”»æ•ˆæœï¼ŒæŒç»­5sï¼Œå»¶æ—¶5s</p><div class='wow animate__slideInRight' data-wow-duration='5s' data-wow-delay='5s' data-wow-offset=''  data-wow-iteration='' ><div class="note orange icon-padding modern"><i class="note-icon fas fa-car"></i><p><code>slideInRight</code>åŠ¨ç”»æ•ˆæœï¼ŒæŒç»­<code>5s</code>ï¼Œå»¶æ—¶<code>5s</code>ã€‚</p></div></div><p>4.heartBeatåŠ¨ç”»æ•ˆæœï¼Œå»¶æ—¶5sï¼Œé‡å¤10æ¬¡ã€‚æ­¤å¤„æ³¨æ„ä¸ç”¨çš„å‚æ•°ä½ç½®è¦ç•™ç©ºï¼Œç”¨é€—å·é—´éš”ã€‚</p><div class='wow animate__heartBeat' data-wow-duration='' data-wow-delay='5s' data-wow-offset=''  data-wow-iteration='10' ><div class="note red icon-padding modern"><i class="note-icon fas fa-battery-half"></i><p><code>heartBeat</code>åŠ¨ç”»æ•ˆæœï¼Œå»¶æ—¶<code>5s</code>ï¼Œé‡å¤<code>10</code>æ¬¡ã€‚</p></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-25-è¿›åº¦æ¡-progress">2.25  è¿›åº¦æ¡ progress</h2><div class="note info flat"><p>è¿›åº¦æ¡æ ‡ç­¾å‚è€ƒ<a href="https://rongbuqiu.com/jdt.html">æ²‚ä½°å­œçŒ«-ç»™HEXOæ–‡ç« æ·»åŠ å½©è‰²è¿›åº¦æ¡</a>ã€‚<br>æºæ ·å¼æå–è‡ª<a href="https://zwying0814.gitbook.io/cuteen/">Cuteen</a>ä¸»é¢˜ã€‚</p></div><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% progress [width] [color] [text] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>width</code>: 0åˆ°100çš„é˜¿æ‹‰ä¼¯æ•°å­—</li><li><code>color</code>: é¢œè‰²ï¼Œå–å€¼æœ‰red,yellow,green,cyan,blue,gray</li><li><code>text</code>:è¿›åº¦æ¡ä¸Šçš„æ–‡å­—å†…å®¹</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% progress 10 red è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 30 yellow è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 50 green è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 70 cyan è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 90 blue è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br><span class="line">&#123;% progress 100 gray è¿›åº¦æ¡æ ·å¼é¢„è§ˆ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-red"  style="width: 10%" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-yellow"  style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-green"  style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-cyan"  style="width: 70%" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-blue"  style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-gray"  style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"><p>è¿›åº¦æ¡æ ·å¼é¢„è§ˆ</p></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-26-æ³¨é‡Š-notation">2.26 æ³¨é‡Š notation</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% nota [label] , [text] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><p><code>label</code>: æ³¨é‡Šè¯æ±‡</p></li><li><p><code>text</code>: æ‚¬åœæ˜¾ç¤ºçš„æ³¨è§£å†…å®¹</p></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% nota æŠŠé¼ æ ‡ç§»åŠ¨åˆ°æˆ‘ä¸Šé¢è¯•è¯• ,å¯ä»¥çœ‹åˆ°æ³¨è§£å†…å®¹å‡ºç°åœ¨é¡¶æ  %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p><span class='nota' data-nota='å¯ä»¥çœ‹åˆ°æ³¨è§£å†…å®¹å‡ºç°åœ¨é¡¶æ '>æŠŠé¼ æ ‡ç§»åŠ¨åˆ°æˆ‘ä¸Šé¢è¯•è¯•</span></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-27-æ°”æ³¡æ³¨é‡Š-bubble">2.27 æ°”æ³¡æ³¨é‡Š bubble</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bubble [content] , [notation] ,[background-color] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>content</code>: æ³¨é‡Šè¯æ±‡</li><li><code>notation</code>: æ‚¬åœæ˜¾ç¤ºçš„æ³¨è§£å†…å®¹</li><li><code>background-color</code>: å¯é€‰ï¼Œæ°”æ³¡èƒŒæ™¯è‰²ã€‚é»˜è®¤ä¸ºâ€œ#71a4e3â€</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æœ€è¿‘æˆ‘å­¦åˆ°äº†ä¸å°‘æ–°ç©æ„å„¿ï¼ˆè™½ç„¶å¯¹å¾ˆå¤šå¤§ä½¬æ¥è¯´è¿™äº›å·²ç»æ˜¯æ—§æŠ€æœ¯äº†ï¼‰ï¼Œæ¯”å¦‚CSSçš„&#123;% bubble å…„å¼Ÿç›¸é‚»é€‰æ‹©å™¨,&quot;ä¾‹å¦‚ h1 + p &#123;margin-top:50px;&#125;&quot; %&#125;ï¼Œ&#123;% bubble flexå¸ƒå±€,&quot;Flex æ˜¯ Flexible Box çš„ç¼©å†™ï¼Œæ„ä¸º&quot;å¼¹æ€§å¸ƒå±€&quot;ï¼Œç”¨æ¥ä¸ºç›’çŠ¶æ¨¡å‹æä¾›æœ€å¤§çš„çµæ´»æ€§&quot;,&quot;#ec5830&quot; %&#125;ï¼Œ&#123;% bubble transformå˜æ¢,&quot;transform å±æ€§å‘å…ƒç´ åº”ç”¨ 2D æˆ– 3D è½¬æ¢ã€‚è¯¥å±æ€§å…è®¸æˆ‘ä»¬å¯¹å…ƒç´ è¿›è¡Œæ—‹è½¬ã€ç¼©æ”¾ã€ç§»åŠ¨æˆ–å€¾æ–œã€‚&quot;,&quot;#1db675&quot; %&#125;ï¼Œanimationçš„&#123;% bubble è´å¡å°”é€Ÿåº¦æ›²çº¿,&quot;è´å¡å°”æ›²çº¿(BÃ©zier curve)ï¼Œåˆç§°è´å…¹æ›²çº¿æˆ–è´æµåŸƒæ›²çº¿ï¼Œæ˜¯åº”ç”¨äºäºŒç»´å›¾å½¢åº”ç”¨ç¨‹åºçš„æ•°å­¦æ›²çº¿ã€‚ä¸€èˆ¬çš„çŸ¢é‡å›¾å½¢è½¯ä»¶é€šè¿‡å®ƒæ¥ç²¾ç¡®ç”»å‡ºæ›²çº¿ï¼Œè´å…¹æ›²çº¿ç”±çº¿æ®µä¸èŠ‚ç‚¹ç»„æˆï¼ŒèŠ‚ç‚¹æ˜¯å¯æ‹–åŠ¨çš„æ”¯ç‚¹ï¼Œçº¿æ®µåƒå¯ä¼¸ç¼©çš„çš®ç­‹&quot;,&quot;#de4489&quot; %&#125;å†™æ³•ï¼Œè¿˜æœ‰ä»Šå¤©åˆšçœ‹åˆ°çš„&#123;% bubble clip-path,&quot;clip-pathå±æ€§ä½¿ç”¨è£å‰ªæ–¹å¼åˆ›å»ºå…ƒç´ çš„å¯æ˜¾ç¤ºåŒºåŸŸã€‚åŒºåŸŸå†…çš„éƒ¨åˆ†æ˜¾ç¤ºï¼ŒåŒºåŸŸå¤–çš„éšè—ã€‚&quot;,&quot;#868fd7&quot; %&#125;å±æ€§ã€‚è¿™äº›å¯¹æˆ‘æ¥è¯´å¾ˆæ–°é¢–çš„æ¦‚å¿µç‹ ç‹ çš„å†²å‡»ç€æˆ‘ä»¥å‰ç§¯ç´¯èµ·æ¥çš„è®¾è®¡æ€è·¯ã€‚</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>æœ€è¿‘æˆ‘å­¦åˆ°äº†ä¸å°‘æ–°ç©æ„å„¿ï¼ˆè™½ç„¶å¯¹å¾ˆå¤šå¤§ä½¬æ¥è¯´è¿™äº›å·²ç»æ˜¯æ—§æŠ€æœ¯äº†ï¼‰ï¼Œæ¯”å¦‚CSSçš„<span class="bubble-content">å…„å¼Ÿç›¸é‚»é€‰æ‹©å™¨</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#71a4e3;">ä¾‹å¦‚ h1 + p {margin-top:50px;}</span></span>ï¼Œ<span class="bubble-content">flexå¸ƒå±€</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#ec5830;">Flex æ˜¯ Flexible Box çš„ç¼©å†™ï¼Œæ„ä¸ºå¼¹æ€§å¸ƒå±€&quot;ï¼Œç”¨æ¥ä¸ºç›’çŠ¶æ¨¡å‹æä¾›æœ€å¤§çš„çµæ´»æ€§&quot;</span></span>ï¼Œ<span class="bubble-content">transformå˜æ¢</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#1db675;">transform å±æ€§å‘å…ƒç´ åº”ç”¨ 2D æˆ– 3D è½¬æ¢ã€‚è¯¥å±æ€§å…è®¸æˆ‘ä»¬å¯¹å…ƒç´ è¿›è¡Œæ—‹è½¬ã€ç¼©æ”¾ã€ç§»åŠ¨æˆ–å€¾æ–œã€‚</span></span>ï¼Œanimationçš„<span class="bubble-content">è´å¡å°”é€Ÿåº¦æ›²çº¿</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#de4489;">è´å¡å°”æ›²çº¿(BÃ©zier curve)ï¼Œåˆç§°è´å…¹æ›²çº¿æˆ–è´æµåŸƒæ›²çº¿ï¼Œæ˜¯åº”ç”¨äºäºŒç»´å›¾å½¢åº”ç”¨ç¨‹åºçš„æ•°å­¦æ›²çº¿ã€‚ä¸€èˆ¬çš„çŸ¢é‡å›¾å½¢è½¯ä»¶é€šè¿‡å®ƒæ¥ç²¾ç¡®ç”»å‡ºæ›²çº¿ï¼Œè´å…¹æ›²çº¿ç”±çº¿æ®µä¸èŠ‚ç‚¹ç»„æˆï¼ŒèŠ‚ç‚¹æ˜¯å¯æ‹–åŠ¨çš„æ”¯ç‚¹ï¼Œçº¿æ®µåƒå¯ä¼¸ç¼©çš„çš®ç­‹</span></span>å†™æ³•ï¼Œè¿˜æœ‰ä»Šå¤©åˆšçœ‹åˆ°çš„<span class="bubble-content">clip-path</span><span class="bubble-notation"><span class="bubble-item" style="background-color:#868fd7;">clip-pathå±æ€§ä½¿ç”¨è£å‰ªæ–¹å¼åˆ›å»ºå…ƒç´ çš„å¯æ˜¾ç¤ºåŒºåŸŸã€‚åŒºåŸŸå†…çš„éƒ¨åˆ†æ˜¾ç¤ºï¼ŒåŒºåŸŸå¤–çš„éšè—ã€‚</span></span>å±æ€§ã€‚è¿™äº›å¯¹æˆ‘æ¥è¯´å¾ˆæ–°é¢–çš„æ¦‚å¿µç‹ ç‹ çš„å†²å‡»ç€æˆ‘ä»¥å‰ç§¯ç´¯èµ·æ¥çš„è®¾è®¡æ€è·¯ã€‚</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-28-å¼•ç”¨æ–‡çŒ®-reference">2.28 å¼•ç”¨æ–‡çŒ® reference</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% referto [id] , [literature] %&#125;</span><br><span class="line">&#123;% referfrom [id] , [literature] , [url] %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><p>referto å¼•ç”¨ä¸Šæ ‡</p><ul><li><p><code>id</code>: ä¸Šæ ‡åºå·å†…å®¹ï¼Œéœ€ä¸referfromæ ‡ç­¾çš„idå¯¹åº”æ‰èƒ½å®ç°è·³è½¬</p></li><li><p><code>literature</code>: å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®åç§°</p></li></ul></li><li><p>referfrom å¼•ç”¨å‡ºå¤„</p><ul><li><p><code>id</code>: åºå·å†…å®¹ï¼Œéœ€ä¸refertoæ ‡ç­¾çš„idå¯¹åº”æ‰èƒ½å®ç° è·³è½¬</p></li><li><p><code>literature</code>: å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®åç§°</p></li><li><p><code>url</code>: å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®é“¾æ¥ï¼Œå¯çœç•¥</p></li></ul></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Akilarã®ç³–æœå±‹(akilar.top)æ˜¯ä¸€ä¸ªç§äººæ€§è´¨çš„åšå®¢&#123;% referto &#x27;[1]&#x27;,&#x27;Akilarã®ç³–æœå±‹ç¾¤èŠç®€ä»‹&#x27; %&#125;ï¼Œä»å„ç±»æ•™ç¨‹è‡³ç”Ÿæ´»ç‚¹æ»´ï¼Œæ— è¯ä¸è°ˆã€‚å»ºç¾¤çš„ç›®çš„æ˜¯æä¾›ä¸€ä¸ªé—²èŠçš„åœºæ‰€ã€‚åšå®¢é‡‡ç”¨Hexoæ¡†æ¶&#123;% referto &#x27;[2]&#x27;,&#x27;Hexoä¸­æ–‡æ–‡æ¡£&#x27; %&#125;ï¼ŒButterflyä¸»é¢˜&#123;% referto &#x27;[3]&#x27;,&#x27;Butterfly å®‰è£…æ–‡æ¡£(ä¸€) å¿«é€Ÿå¼€å§‹&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">æœ¬é¡¹ç›®å‚è€ƒäº†Volantis&#123;% referto &#x27;[4]&#x27;,&#x27;hexo-theme-volantis æ ‡ç­¾æ’ä»¶&#x27; %&#125;çš„æ ‡ç­¾æ ·å¼ã€‚å¼•å…¥<span class="code">`[tag].js`</span>ï¼Œå¹¶é’ˆå¯¹<span class="code">`butterfly`</span>ä¸»é¢˜ä¿®æ”¹äº†ç›¸åº”çš„<span class="code">`[tag].styl`</span>ã€‚åœ¨æ­¤é¸£è°¢<span class="code">`Volantis`</span>ä¸»é¢˜ä¼—å¼€å‘è€…ã€‚</span><br><span class="line">ä¸»è¦å‚è€ƒå†…å®¹åŒ…æ‹¬å„ä¸ªvolantisçš„å†…ç½®æ ‡ç­¾æ’ä»¶æ–‡æ¡£&#123;% referto &#x27;[5]&#x27;,&#x27;Volantisæ–‡æ¡£:å†…ç½®æ ‡ç­¾æ’ä»¶&#x27; %&#125;</span><br><span class="line">Butterflyä¸»é¢˜çš„å„ä¸ªè¡ç”Ÿé­”æ”¹&#123;% referto &#x27;[6]&#x27;,&#x27;Butterfly å®‰è£…æ–‡æ¡£:æ ‡ç­¾å¤–æŒ‚ï¼ˆTag Plugins&#x27; %&#125;&#123;% referto &#x27;[7]&#x27;,&#x27;å°å¼‹ã®ç”Ÿæ´»é¦†å…¨æ ·å¼é¢„è§ˆ&#x27; %&#125;&#123;% referto &#x27;[8]&#x27;,&#x27;l-lin-font-awesome-animation&#x27; %&#125;&#123;% referto &#x27;[9]&#x27;,&#x27;å°åº·çš„butterflyä¸»é¢˜ä½¿ç”¨æ–‡æ¡£&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% referfrom &#x27;[1]&#x27;,&#x27;Akilarã®ç³–æœå±‹ç¾¤èŠç®€ä»‹&#x27;,&#x27;https://jq.qq.com/?<span class="emphasis">_wv=1027&amp;k=pGLB2C0N&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[2]&#x27;,&#x27;Hexoä¸­æ–‡æ–‡æ¡£&#x27;,&#x27;https://hexo.io/zh-cn/docs/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[3]&#x27;,&#x27;Butterfly å®‰è£…æ–‡æ¡£(ä¸€) å¿«é€Ÿå¼€å§‹&#x27;,&#x27;https://butterfly.js.org/posts/21cfbf15/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[4]&#x27;,&#x27;hexo-theme-volantis æ ‡ç­¾æ’ä»¶&#x27;,&#x27;https://volantis.js.org/v5/tag-plugins/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[5]&#x27;,&#x27;Volantisæ–‡æ¡£:å†…ç½®æ ‡ç­¾æ’ä»¶&#x27;,&#x27;https://volantis.js.org/tag-plugins/&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[6]&#x27;,&#x27;Butterfly å®‰è£…æ–‡æ¡£:æ ‡ç­¾å¤–æŒ‚ï¼ˆTag Plugins&#x27;,&#x27;https://butterfly.js.org/posts/4aa8abbe/#%E6%A8%99%E7%B1%A4%E5%A4%96%E6%8E%9B%EF%BC%88Tag-Plugins%EF%BC%89&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[7]&#x27;,&#x27;å°å¼‹ã®ç”Ÿæ´»é¦†å…¨æ ·å¼é¢„è§ˆ&#x27;,&#x27;https://lovelijunyi.gitee.io/posts/c898.html&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[8]&#x27;,&#x27;l-lin-font-awesome-animation&#x27;,&#x27;https://github.com/l-lin/font-awesome-animation&#x27; %&#125;</span></span><br><span class="line"><span class="emphasis">&#123;% referfrom &#x27;[9]&#x27;,&#x27;å°åº·çš„butterflyä¸»é¢˜ä½¿ç”¨æ–‡æ¡£&#x27;,&#x27;https://www.antmoe.com/posts/3b43914f/&#x27; %&#125;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>Akilarã®ç³–æœå±‹(akilar.top)æ˜¯ä¸€ä¸ªç§äººæ€§è´¨çš„åšå®¢<span class="hidden-anchor" id="referto_[1]"></span><sup class="reference"><a href="#referfrom_[1]">[1]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Akilarã®ç³–æœå±‹ç¾¤èŠç®€ä»‹</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span>ï¼Œä»å„ç±»æ•™ç¨‹è‡³ç”Ÿæ´»ç‚¹æ»´ï¼Œæ— è¯ä¸è°ˆã€‚å»ºç¾¤çš„ç›®çš„æ˜¯æä¾›ä¸€ä¸ªé—²èŠçš„åœºæ‰€ã€‚åšå®¢é‡‡ç”¨Hexoæ¡†æ¶<span class="hidden-anchor" id="referto_[2]"></span><sup class="reference"><a href="#referfrom_[2]">[2]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Hexoä¸­æ–‡æ–‡æ¡£</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span>ï¼ŒButterflyä¸»é¢˜<span class="hidden-anchor" id="referto_[3]"></span><sup class="reference"><a href="#referfrom_[3]">[3]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Butterfly å®‰è£…æ–‡æ¡£(ä¸€) å¿«é€Ÿå¼€å§‹</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span></p><p>æœ¬é¡¹ç›®å‚è€ƒäº†Volantis<span class="hidden-anchor" id="referto_[4]"></span><sup class="reference"><a href="#referfrom_[4]">[4]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">hexo-theme-volantis æ ‡ç­¾æ’ä»¶</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span>çš„æ ‡ç­¾æ ·å¼ã€‚å¼•å…¥<code>[tag].js</code>ï¼Œå¹¶é’ˆå¯¹<code>butterfly</code>ä¸»é¢˜ä¿®æ”¹äº†ç›¸åº”çš„<code>[tag].styl</code>ã€‚åœ¨æ­¤é¸£è°¢<code>Volantis</code>ä¸»é¢˜ä¼—å¼€å‘è€…ã€‚<br>ä¸»è¦å‚è€ƒå†…å®¹åŒ…æ‹¬å„ä¸ªvolantisçš„å†…ç½®æ ‡ç­¾æ’ä»¶æ–‡æ¡£<span class="hidden-anchor" id="referto_[5]"></span><sup class="reference"><a href="#referfrom_[5]">[5]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Volantisæ–‡æ¡£:å†…ç½®æ ‡ç­¾æ’ä»¶</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span><br>Butterflyä¸»é¢˜çš„å„ä¸ªè¡ç”Ÿé­”æ”¹<span class="hidden-anchor" id="referto_[6]"></span><sup class="reference"><a href="#referfrom_[6]">[6]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">Butterfly å®‰è£…æ–‡æ¡£:æ ‡ç­¾å¤–æŒ‚ï¼ˆTag Plugins</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span><span class="hidden-anchor" id="referto_[7]"></span><sup class="reference"><a href="#referfrom_[7]">[7]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">å°å¼‹ã®ç”Ÿæ´»é¦†å…¨æ ·å¼é¢„è§ˆ</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span><span class="hidden-anchor" id="referto_[8]"></span><sup class="reference"><a href="#referfrom_[8]">[8]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">l-lin-font-awesome-animation</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span><span class="hidden-anchor" id="referto_[9]"></span><sup class="reference"><a href="#referfrom_[9]">[9]</a></sup><span class="reference-bubble"><span class="reference-item"><span class="reference-literature">å°åº·çš„butterflyä¸»é¢˜ä½¿ç”¨æ–‡æ¡£</span><span class="reference-title">å‚è€ƒèµ„æ–™</span></span></span></p><div class="reference-source"><span class="hidden-anchor" id="referfrom_[1]"></span><a class="reference-anchor" href="#referto_[1]">[1]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://jq.qq.com/?_wv=1027&k=pGLB2C0N">Akilarã®ç³–æœå±‹ç¾¤èŠç®€ä»‹</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[2]"></span><a class="reference-anchor" href="#referto_[2]">[2]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://hexo.io/zh-cn/docs/">Hexoä¸­æ–‡æ–‡æ¡£</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[3]"></span><a class="reference-anchor" href="#referto_[3]">[3]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://butterfly.js.org/posts/21cfbf15/">Butterfly å®‰è£…æ–‡æ¡£(ä¸€) å¿«é€Ÿå¼€å§‹</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[4]"></span><a class="reference-anchor" href="#referto_[4]">[4]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://volantis.js.org/v5/tag-plugins/">hexo-theme-volantis æ ‡ç­¾æ’ä»¶</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[5]"></span><a class="reference-anchor" href="#referto_[5]">[5]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://volantis.js.org/tag-plugins/">Volantisæ–‡æ¡£:å†…ç½®æ ‡ç­¾æ’ä»¶</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[6]"></span><a class="reference-anchor" href="#referto_[6]">[6]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://butterfly.js.org/posts/4aa8abbe/#%E6%A8%99%E7%B1%A4%E5%A4%96%E6%8E%9B%EF%BC%88Tag-Plugins%EF%BC%89">Butterfly å®‰è£…æ–‡æ¡£:æ ‡ç­¾å¤–æŒ‚ï¼ˆTag Plugins</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[7]"></span><a class="reference-anchor" href="#referto_[7]">[7]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://lovelijunyi.gitee.io/posts/c898.html">å°å¼‹ã®ç”Ÿæ´»é¦†å…¨æ ·å¼é¢„è§ˆ</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[8]"></span><a class="reference-anchor" href="#referto_[8]">[8]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://github.com/l-lin/font-awesome-animation">l-lin-font-awesome-animation</a></div><div class="reference-source"><span class="hidden-anchor" id="referfrom_[9]"></span><a class="reference-anchor" href="#referto_[9]">[9]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" href="https://www.antmoe.com/posts/3b43914f/">å°åº·çš„butterflyä¸»é¢˜ä½¿ç”¨æ–‡æ¡£</a></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-29-PDFå±•ç¤º">2.29 PDFå±•ç¤º</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% pdf æ–‡ä»¶è·¯å¾„ %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li><code>æ–‡ä»¶è·¯å¾„</code>: å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„æˆ–è€…æ˜¯åœ¨çº¿é“¾æ¥</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.æœ¬åœ°æ–‡ä»¶:åœ¨mdæ–‡ä»¶è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªåŒåæ–‡ä»¶å¤¹ï¼Œå…¶å†…æ”¾pdfæ–‡ä»¶åä¸ºxxx.pdfçš„æ–‡ä»¶</span></span><br><span class="line">&#123;% pdf xxx.pdf %&#125;</span><br><span class="line"><span class="section"># 2.åœ¨çº¿é“¾æ¥</span></span><br><span class="line">&#123;% pdf https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/pdf/å°ä½œæ–‡è®²ä¹‰.pdf %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><p>2.åœ¨çº¿é“¾æ¥(è¦æ”¾åˆ°æœ€å¤–å±‚æ‰èƒ½èµ·ä½œç”¨)</p><pre><code>&lt;div class=&quot;row&quot;&gt;&lt;embed src=&quot;https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/pdf/å°ä½œæ–‡è®²ä¹‰.pdf&quot; width=&quot;100%&quot; height=&quot;550&quot; type=&quot;application/pdf&quot;&gt;&lt;/div&gt;</code></pre><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-30-Hexo-tag-map-æ’ä»¶">2.30 Hexo-tag-map æ’ä»¶</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% + æ ‡ç­¾å€¼ + ç»åº¦ + çº¬åº¦ + æ–‡æœ¬ + ç¼©æ”¾ç­‰çº§ + å®½ + é«˜ + é»˜è®¤å›¾å±‚ + %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><table><thead><tr><th style="text-align:center">åœ°å›¾å</th><th style="text-align:center">æ ‡ç­¾å€¼ &lt;å¿…å¡«&gt;</th><th style="text-align:center">å®½ (é»˜è®¤ 100%) / é«˜ (é»˜è®¤ 360px)</th><th style="text-align:center">ç¼©æ”¾ç­‰çº§ (é»˜è®¤ 14)</th><th style="text-align:center">å®½ (é»˜è®¤ 100%) / é«˜ (é»˜è®¤ 360px)</th><th style="text-align:center">é»˜è®¤å›¾å±‚ (é»˜è®¤ 1)</th></tr></thead><tbody><tr><td style="text-align:center">æ··åˆåœ°å›¾</td><td style="text-align:center">map</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 3~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~7</td></tr><tr><td style="text-align:center">è°·æ­Œåœ°å›¾</td><td style="text-align:center">googleMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~20</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~3</td></tr><tr><td style="text-align:center">é«˜å¾·åœ°å›¾</td><td style="text-align:center">gaodeMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 3~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~3</td></tr><tr><td style="text-align:center">ç™¾åº¦åœ°å›¾</td><td style="text-align:center">baiduMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 4~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~2</td></tr><tr><td style="text-align:center">Geoq åœ°å›¾</td><td style="text-align:center">geoqMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~5</td></tr><tr><td style="text-align:center">openstreet åœ°å›¾</td><td style="text-align:center">openstreetMap</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">å–å€¼ 1~18</td><td style="text-align:center">ç™¾åˆ†æ•°æˆ–å…·ä½“å€¼ (100% æˆ– 360px)</td><td style="text-align:center">ä¸æ”¯æŒæ­¤å‚æ•°</td></tr></tbody></table><ol><li>å‚æ•°ä¹‹é—´ï¼Œç”¨è‹±æ–‡é€—å·ç›¸éš”</li><li>å‚æ•°å¿…é¡»æŒ‰ä¸Šè¿°äº‹ä¾‹é¡ºåºè¾“å…¥ï¼Œä¸å¾—ä¸ºç©º</li><li>åŒä¸€ä¸ªé¡µé¢ï¼ŒåŒä¸€ç»„ç»çº¬åº¦å€¼ï¼Œåªèƒ½æ’å…¥ä¸€ä¸ªç›¸åŒæ ‡ç­¾å€¼çš„åœ°å›¾ (è‹¥æœ‰éœ€è¦ï¼Œå¯ä»¥å°†ç¬¬äºŒä¸ªåœ°å›¾ä¸Šï¼Œç»åº¦æˆ–çº¬åº¦æœ«å°¾åˆ é™¤ä¸€ä¸¤ä¸ªæ•°)</li><li>å‚æ•°å–å€¼å¿…é¡»åœ¨ä¸Šè¿°èŒƒå›´å†…</li><li>é»˜è®¤å›¾å±‚ï¼šå³åœ°å›¾å åŠ å±‚çš„å€¼ï¼Œé»˜è®¤å¸¸è§„åœ°å›¾è¿˜æ˜¯å«æ˜Ÿåœ°å›¾ï¼Œå¯æŒ‰åœ°å›¾æ˜¾ç¤ºé¡ºåºå–å€¼</li><li>ç¼©æ”¾ç­‰çº§ï¼Œæ•°å­—è¶Šå¤§ï¼Œåœ°å›¾æ¯”ä¾‹å°ºè¶Šå°ï¼Œæ˜¾ç¤ºçš„è¶Šç²¾ç»†</li><li>é™¤æ ‡ç­¾å€¼å¤–ï¼Œå…¶ä»–å‚æ•°é€‰å¡«ï¼Œä½† æ¯ä¸ªå‚æ•°çš„å·¦è¾¹çš„å‚æ•°å¿…å¡«</li><li>è°·æ­Œåœ°å›¾éœ€è¦å¤–ç½‘æ‰èƒ½åŠ è½½æŸ¥çœ‹</li></ol><p>åæ ‡è·å–ï¼š<a href="https://lbs.amap.com/tools/picker">é«˜å¾·åœ°å›¾åæ ‡æ‹¾å–ç³»ç»Ÿ</a> ã€<a href="https://api.map.baidu.com/lbsapi/getpoint/index.html">ç™¾åº¦åœ°å›¾åæ ‡æ‹¾å–ç³»ç»Ÿ</a></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% map 120.101101,30.239119 %&#125;</span><br><span class="line">&#123;% googleMap 120.101101,30.239119, è¿™é‡Œæ˜¯è¥¿æ¹–çµéšå¯ºï¼Œæ®è¯´æ±‚å§»ç¼˜å¾ˆçµéªŒå“¦ï¼ %&#125;</span><br><span class="line">&#123;% geoqMap 120.101101,30.239119, è¿™é‡Œæ˜¯è¥¿æ¹–çµéšå¯ºï¼Œæ®è¯´æ±‚å§»ç¼˜å¾ˆçµéªŒå“¦ï¼, 13, 90%, 320px, 3 %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><link rel="stylesheet" href="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.css"><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.js"></script><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet.ChineseTmsProviders@1.0.4.js"></script><div class="map-box" style="margin: 0.8rem 0 1.6rem 0;"><div id="map-120.101101-30.239119" style="max-width:100%; height:360px;display: block;margin:0 auto;z-index:1;border-radius: 5px;"></div></div><script type="text/javascript">var normalm=L.tileLayer.chinaProvider('GaoDe.Normal.Map',{maxZoom:20,minZoom:1,attribution:'é«˜å¾·åœ°å›¾'});var imgm=L.tileLayer.chinaProvider('GaoDe.Satellite.Map',{maxZoom:20,minZoom:1,attribution:'é«˜å¾·åœ°å›¾'});var imga=L.tileLayer.chinaProvider('GaoDe.Satellite.Annotion',{maxZoom:20,minZoom:1,attribution:'é«˜å¾·åœ°å›¾'});var normalMap=L.tileLayer.chinaProvider('Google.Normal.Map',{maxZoom:20,minZoom:1,attribution:'Google Maps'}),satelliteMap=L.tileLayer.chinaProvider('Google.Satellite.Map',{maxZoom:21,minZoom:1,attribution:'Google Maps'});routeMap=L.tileLayer.chinaProvider('Google.Satellite.Annotion',{maxZoom:21,minZoom:1});var normalMap=L.tileLayer.chinaProvider('Google.Normal.Map',{maxZoom:21,minZoom:1,attribution:'Google Maps'}),satelliteMap=L.tileLayer.chinaProvider('Google.Satellite.Map',{maxZoom:21,minZoom:1,attribution:'Google Maps'}),routeMap=L.tileLayer.chinaProvider('Google.Satellite.Annotion',{maxZoom:21,minZoom:1,attribution:'Google Maps'});var normalm1=L.tileLayer.chinaProvider('Geoq.Normal.Map',{maxZoom:21,minZoom:1,attribution:'GeoQ'});var normal=L.layerGroup([normalm]),image=L.layerGroup([imgm,imga]);var baseLayers={"é«˜å¾·åœ°å›¾":normal,"æ™ºå›¾åœ°å›¾":normalm1,"è°·æ­Œåœ°å›¾":normalMap,"é«˜å¾·å«æ˜Ÿåœ°å›¾":imgm,"è°·æ­Œå«æ˜Ÿåœ°å›¾":satelliteMap,"é«˜å¾·å«æ˜Ÿæ ‡æ³¨":image,"è°·æ­Œå«æ˜Ÿæ ‡æ³¨":routeMap};var mymap=L.map('map-120.101101-30.239119',{center:[30.239119,120.101101],zoom:14,layers:[normal],zoomControl:false});L.control.layers(baseLayers,null).addTo(mymap);L.control.zoom({zoomInTitle:'æ”¾å¤§',zoomOutTitle:'ç¼©å°'}).addTo(mymap);</script><br><link rel="stylesheet" href="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.css"><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.js"></script><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet.ChineseTmsProviders@1.0.4.js"></script><div id="googleMap-120.101101-30.239119" style="max-width:100%; height:360px;display: block;margin:0 auto;z-index:1;border-radius: 5px;"></div><script type="text/javascript">var normalMap=L.tileLayer.chinaProvider('Google.Normal.Map',{maxZoom:22,minZoom:1,attribution:'Google Maps'}),satelliteMap=L.tileLayer.chinaProvider('Google.Satellite.Map',{maxZoom:22,minZoom:1,attribution:'Google Maps'}),routeMap=L.tileLayer.chinaProvider('Google.Satellite.Annotion',{maxZoom:22,minZoom:1,attribution:'Google Maps'});var baseLayers={"è°·æ­Œåœ°å›¾":normalMap,"è°·æ­Œå«æ˜Ÿå›¾":satelliteMap,"è°·æ­Œå«æ˜Ÿæ ‡æ³¨": routeMap};var overlayLayers={};var mymap=L.map("googleMap-120.101101-30.239119",{center:[30.239119,120.101101],zoom:14,layers:[normalMap],zoomControl:false});L.control.layers(baseLayers,null).addTo(mymap);L.control.zoom({zoomInTitle:'æ”¾å¤§',zoomOutTitle:'ç¼©å°'}).addTo(mymap);var marker = L.marker(['30.239119','120.101101']).addTo(mymap);marker.bindPopup("è¿™é‡Œæ˜¯è¥¿æ¹–çµéšå¯ºï¼Œæ®è¯´æ±‚å§»ç¼˜å¾ˆçµéªŒå“¦ï¼").openPopup();</script><br><link rel="stylesheet" href="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.css"><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet@1.7.1.js"></script><script data-pjax src="//unpkg.com/hexo-tag-map/lib/leaflet.ChineseTmsProviders@1.0.4.js"></script><div id="geoqMap-120.101101-30.239119" style="max-width:90%; height:320px;display: block;margin:0 auto;z-index:1;border-radius: 5px;"></div><script type="text/javascript">var normalm1=L.tileLayer.chinaProvider('Geoq.Normal.Map',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm2=L.tileLayer.chinaProvider('Geoq.Normal.PurplishBlue',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm3=L.tileLayer.chinaProvider('Geoq.Normal.Gray',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm4=L.tileLayer.chinaProvider('Geoq.Normal.Warm',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normalm5=L.tileLayer.chinaProvider('Geoq.Theme.Hydro',{maxZoom:20,minZoom:1,attribution:'GeoQ'});var normal=L.layerGroup([normalm1,normalm2,normalm3,normalm4,normalm5]);var baseLayers={"æ™ºå›¾åœ°å›¾":normalm1,"åˆå¤œè“":normalm2,"ç°è‰²":normalm3,"æš–è‰²":normalm4,"æ°´ç³»":normalm5};var mymap=L.map("geoqMap-120.101101-30.239119",{center:[30.239119,120.101101],zoom:13,layers:[normalm3],zoomControl:false});L.control.layers(baseLayers,null).addTo(mymap);L.control.zoom({zoomInTitle:'æ”¾å¤§',zoomOutTitle:'ç¼©å°'}).addTo(mymap);var marker = L.marker(['30.239119','120.101101']).addTo(mymap);marker.bindPopup("è¿™é‡Œæ˜¯è¥¿æ¹–çµéšå¯ºï¼Œæ®è¯´æ±‚å§»ç¼˜å¾ˆçµéªŒå“¦ï¼").openPopup();</script><br><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="2-31-éšè—å—">2.31 éšè—å—</h2><div class="tabs" id="åˆ†æ "><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ†æ -1">æ ‡ç­¾è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -2">å‚æ•°é…ç½®</button></li><li class="tab"><button type="button" data-href="#åˆ†æ -3">ç¤ºä¾‹æºç </button></li><li class="tab"><button type="button" data-href="#åˆ†æ -4">æ¸²æŸ“æ¼”ç¤º</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ†æ -1"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% hideBlock display,bg,color %&#125;</span><br><span class="line">content</span><br><span class="line">&#123;% endhideBlock %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -2"><ol><li>contentï¼šè¦éšè—çš„å†…å®¹</li><li>displayï¼šå±•ç¤ºå‰æŒ‰é’®æ˜¾ç¤ºçš„æ–‡å­—ï¼ˆå¯é€‰ï¼‰</li><li>bgï¼šæŒ‰é’®çš„èƒŒæ™¯é¢œè‰²ï¼ˆå¯é€‰ï¼‰</li><li>colorï¼šæŒ‰é’®æ˜¾ç¤ºçš„æ–‡å­—çš„é¢œè‰²ï¼ˆå¯é€‰ï¼‰</li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -3"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% hideBlock ç‚¹æˆ‘é¢„è§ˆ, blue %&#125;</span><br><span class="line">è¿™é‡Œæœ‰å¼ å›¾ç‰‡ï¼š</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://s1.vika.cn/space/2022/10/30/b35fce448bc9404a8d65c3ce1e6e46eb&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;image (1)&quot;</span> <span class="attr">style</span>=<span class="string">&quot;zoom:67%;&quot;</span> /&gt;</span></span></span><br><span class="line">&#123;% endhideBlock %&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ†æ -4"><div class="hide-block"><button type="button" class="hide-button" style="background-color:  blue;">ç‚¹æˆ‘é¢„è§ˆ    </button><div class="hide-content"><p>è¿™é‡Œæœ‰å¼ å›¾ç‰‡ï¼š<br><img src="https://s1.vika.cn/space/2022/10/30/b35fce448bc9404a8d65c3ce1e6e46eb" alt="image (1)" style="zoom:67%;" /></p></div></div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
      
      
      <categories>
          
          <category> æ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ‚è°ˆ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
