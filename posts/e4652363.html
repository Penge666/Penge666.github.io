<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Elasticsearch索引学习 | Penge666</title><meta name="keywords" content="Elasticsearch"><meta name="author" content="Penge666"><meta name="copyright" content="Penge666"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Elasticsearch索引原理">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch索引学习">
<meta property="og:url" content="https://penge666.github.io/posts/e4652363.html">
<meta property="og:site_name" content="Penge666">
<meta property="og:description" content="Elasticsearch索引原理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://penge666.github.io/assets/photo1/default_cover_61.webp">
<meta property="article:published_time" content="2023-11-25T11:12:05.000Z">
<meta property="article:modified_time" content="2024-10-04T13:27:53.660Z">
<meta property="article:author" content="Penge666">
<meta property="article:tag" content="Elasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://penge666.github.io/assets/photo1/default_cover_61.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://penge666.github.io/posts/e4652363"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Elasticsearch索引学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-04 21:27:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Penge666" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/hhh.jpeg" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">149</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei"></use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Penge666</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei"></use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="检索站内任何你想要的信息"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> 搜索</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="美化设置-自定义你的风格" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="浅色和深色模式转换" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">Elasticsearch索引学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">发表于 </span><time class="post-meta-date-created" datetime="2023-11-25T11:12:05.000Z" title="发表于 2023-11-25 19:12:05">2023-11-25</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-04T13:27:53.660Z" title="更新于 2024-10-04 21:27:53">2024-10-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/Elasticsearch/">Elasticsearch</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">字数总计:</span><span class="word-count">9876</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Elasticsearch索引学习"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>当时光的列车缓缓驶过酋长球场，32岁的亨利就在那里，深情的目光望过去都是自己22岁的影子；还是那辆列车，随着时光送走了匆匆过客，静静开往另一片大陆，33岁的亨利就在那里，深情的目光望去依稀浮现自己25岁的模样；远方的期许固然美好，而列车的短暂停留更好像岁月的美丽回眸，当时光奏出回家的天籁，35岁的亨利就在那里，深情的目光望去勾勒出自己29岁的动人画面；渐行渐远的车辙，默默带走了属于四座城市的喧嚣，却指引着一路跟随的人们去追寻着那段逝去的时光，当岁月含泪悄悄转身，37岁的亨利就在那里，深情的目光望过去，试图回到原点，那个出发的站台，记起自己背起行囊时，那十七岁的样子。</p>
<p>~</p>
<blockquote>
<p><strong>Elasticsearch 是一个分布式可扩展的实时搜索和分析引擎.</strong></p>
</blockquote>
<p>Elasticsearch【文档数据库】 是一个建立在全文搜索引擎 Apache Lucene™ 基础上的搜索引擎。 当然 Elasticsearch 并不仅仅是 Lucene 那么简单，它不仅包括了全文搜索功能，还可以进行以下工作：</p>
<ul>
<li>分布式实时文件存储，并将每一个字段都编入索引，使其可以被搜索。</li>
<li>实时分析的分布式搜索引擎。</li>
<li>可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据。</li>
</ul>
<p>在介绍Elasticsearch索引之前，先了解下Lucene。</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/elasticsearch">https://www.elastic.co/cn/elasticsearch</a></p>
<p><strong>JAVA</strong>：<strong>特别强调，这里安装的版本务必要和之后SpringBoot中的elasticsearch的版本一致才行，要不然后面会报错。</strong></p>
<h2 id="Lucene执行原理">Lucene执行原理</h2>
<p><strong>介绍</strong>：Lucene是apache下的一个开放源代码的<strong>全文检索引擎工具包</strong>。提供了完整的查询引擎和索引引擎，部分文本分析引擎。Lucene的目的是为软件开发人员提供一个简单易用的工具包，以方便的在目标系统中实现全文检索的功能。</p>
<p>**应用场景：**对于数据量大、数据结构不固定的数据可采用全文检索方式搜索，比如百度、Google等搜索引擎、论坛站内搜索、电商网站站内搜索等。</p>
<h3 id="索引和搜索原理">索引和搜索原理</h3>
<p><strong>全文索引和搜索流程图：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601191634869.png" alt="image-20240601191634869"></p>
<p>1、绿色表示索引过程，对要搜索的原始内容进行索引构建一个索引库，索引过程包括：</p>
<p>确定原始内容即要搜索的内容–&gt;采集文档–&gt;创建文档–&gt;分析文档–&gt;索引文档</p>
<p>2、红色表示搜索过程，从索引库中搜索内容，搜索过程包括：</p>
<p>用户通过搜索界面–&gt;创建查询–&gt;执行搜索，从索引库搜索–&gt;渲染搜索结果</p>
<h3 id="创建索引">创建索引</h3>
<p>对文档索引的过程，将用户要搜索的文档内容进行索引，索引存储在索引库（index）中。</p>
<p>这里我们要搜索的文档是磁盘上的文本文件，根据案例描述：凡是文件名或文件内容包括关键字的文件都要找出来，这里要对文件名和文件内容创建索引。</p>
<p><strong>1) 获取原始文档</strong></p>
<p><strong>原始文档</strong> 是指要索引和搜索的内容。原始内容包括互联网上的网页（爬虫）、数据库中的数据（sql查询）、磁盘上的文件（IO流获取）等。</p>
<p>从互联网上、数据库、文件系统中等获取需要搜索的原始信息，这个过程就是信息采集，信息采集的目的是为了对原始内容进行索引。</p>
<p>在Internet上采集信息的软件通常称为爬虫或蜘蛛，也称为网络机器人，爬虫访问互联网上的每一个网页，将获取到的网页内容存储起来。</p>
<ul>
<li>
<p>Lucene不提供信息采集的类库，需要自己编写一个爬虫程序实现信息采集，也可以通过一些开源软件实现信息采集，如下：</p>
</li>
<li>
<p>Nutch（<a target="_blank" rel="noopener" href="http://lucene.apache.org/nutch%EF%BC%89">http://lucene.apache.org/nutch）</a>, Nutch是apache的一个子项目，包括大规模爬虫工具，能够抓取和分辨web网站数据。</p>
</li>
<li>
<p>jsoup（<a target="_blank" rel="noopener" href="http://jsoup.org/">http://jsoup.org/</a> ），jsoup 是一款Java 的HTML解析器，可直接解析某个URL地址、HTML文本内容。它提供了一套非常省力的API，可通过DOM，CSS以及类似于jQuery的操作方法来取出和操作数据。</p>
</li>
<li>
<p>heritrix（<a target="_blank" rel="noopener" href="http://sourceforge.net/projects/archive-crawler/files/%EF%BC%89%EF%BC%8CHeritrix">http://sourceforge.net/projects/archive-crawler/files/），Heritrix</a> 是一个由 java 开发的、开源的网络爬虫，用户可以使用它来从网上抓取想要的资源。其最出色之处在于它良好的可扩展性，方便用户实现自己的抓取逻辑。</p>
</li>
</ul>
<p>获取磁盘上文件的内容，可以通过文件流来读取文本文件的内容，对于pdf、doc、xls等文件可通过第三方提供的解析工具读取文件内容，比如Apache POI读取doc和xls的文件内容。</p>
<p><strong>2）创建文档对象</strong></p>
<p>获取原始内容的目的是为了索引，在索引前需要将原始内容创建成文档（Document），文档中包括一个一个的域（Field），域中存储内容。</p>
<p>这里我们可以将磁盘上的一个文件当成一个document，Document中包括一些Field（file_name文件名称、file_path文件路径、file_size文件大小、file_content文件内容），如下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601191751345.png" alt="image-20240601191751345"></p>
<p>注意：每个Document可以有多个Field，不同的Document可以有不同的Field，同一个Document可以有相同的Field（域名和域值都相同）</p>
<p>每个文档都有一个唯一的编号，就是文档id。</p>
<p><strong>3） 分析文档</strong></p>
<p>将原始内容创建为包含域（Field）的文档（document），需要再对域中的内容进行分析，分析的过程是经过对原始文档提取单词、将字母转为小写、去除标点符号、去除停用词等过程生成最终的语汇单元，可以将语汇单元理解为一个一个的单词。</p>
<p>比如下边的文档经过分析如下：</p>
<p>原文档内容：</p>
<p>Lucene is a Java full-text search engine. Lucene is not a complete</p>
<p>application, but rather a code library and API that can easily be used</p>
<p>to add search capabilities to applications.</p>
<p>分析后得到的语汇单元：</p>
<p>lucene、java、full、search、engine。。。。</p>
<p>每个单词叫做一个<strong>Term</strong>，不同的域中拆分出来的相同的单词是不同的term。term中包含两部分一部分是文档的域名，另一部分是单词的内容。</p>
<p>例如：文件名中包含apache和文件内容中包含的apache是不同的term。</p>
<p><strong>4） 创建索引</strong></p>
<p>对所有文档分析得出的语汇单元进行索引，索引的目的是为了搜索，最终要实现只搜索被索引的语汇单元从而找到Document（文档）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601191816646.png" alt="image-20240601191816646"></p>
<p>注意：创建索引是对语汇单元索引，通过词语找文档，这种索引的结构叫<strong>倒排索引结构</strong>。</p>
<p>传统方法是根据文件找到该文件的内容，在文件内容中匹配搜索关键字，这种方法是顺序扫描方法，数据量大、搜索慢。</p>
<p><strong>倒排索引结构</strong>是根据内容（词语）找文档。</p>
<p><strong>倒排索引结构也叫反向索引结构，包括索引和文档两部分，索引即词汇表，它的规模较小，而文档集合较大。</strong></p>
<h3 id="查询索引">查询索引</h3>
<p>查询索引也是搜索的过程。搜索就是用户输入关键字，从索引（index）中进行搜索的过程。根据关键字搜索索引，根据索引找到对应的文档，从而找到要搜索的内容（这里指磁盘上的文件）。</p>
<p><strong>1） 用户查询接口</strong></p>
<p>全文检索系统提供用户搜索的界面供用户提交搜索的关键字，搜索完成展示搜索结果。</p>
<p>Lucene不提供制作用户搜索界面的功能，需要根据自己的需求开发搜索界面。</p>
<p><strong>2） 创建查询</strong></p>
<p>用户输入查询关键字执行搜索之前需要先构建一个查询对象，查询对象中可以指定查询要搜索的Field文档域、查询关键字等，查询对象会生成具体的查询语法，</p>
<p>例如：语法 “fileName:lucene”表示要搜索Field域的内容为“lucene”的文档</p>
<p><strong>3） 执行查询</strong></p>
<p>搜索索引过程：</p>
<p>根据查询语法在倒排索引词典表中分别找出对应搜索词的索引，从而找到索引所链接的文档链表。</p>
<p>比如搜索语法为“fileName:lucene”表示搜索出fileName域中包含Lucene的文档。</p>
<p>搜索过程就是在索引上查找域为fileName，并且关键字为Lucene的term，并根据term找到文档id列表。</p>
<p><strong>4） 渲染结果</strong></p>
<p>以一个友好的界面将查询结果展示给用户，用户根据搜索结果找自己想要的信息，为了帮助用户很快找到自己的结果，提供了很多展示的效果，比如搜索结果中将关键字高亮显示，百度提供的快照等。</p>
<h2 id="Elasticsearch索引">Elasticsearch索引</h2>
<h3 id="基本概念">基本概念</h3>
<p>先说Elasticsearch的文件存储，Elasticsearch是面向文档型数据库，一条数据在这里就是一个文档，用JSON作为文档序列化的格式，比如下面这条用户数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot; :     &quot;John&quot;,</span><br><span class="line">    &quot;sex&quot; :      &quot;Male&quot;,</span><br><span class="line">    &quot;age&quot; :      25,</span><br><span class="line">    &quot;birthDate&quot;: &quot;1990/05/01&quot;,</span><br><span class="line">    &quot;about&quot; :    &quot;I love to go rock climbing&quot;,</span><br><span class="line">    &quot;interests&quot;: [ &quot;sports&quot;, &quot;music&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/mysql">MySQL</a>这样的数据库存储就会容易想到建立一张User表，有balabala的字段等，在Elasticsearch里这就是一个<em>文档</em>，当然这个文档会属于一个User的<em>类型</em>，各种各样的类型存在于一个<em>索引</em>当中。这里有一份简易的将Elasticsearch和关系型数据术语对照表:</p>
<p><strong>关系数据库 ⇒ 数据库 ⇒ 表 ⇒ 行 ⇒ 列(Columns)</strong></p>
<p><strong>Elasticsearch ⇒ 索引 ⇒ 类型 ⇒ 文档 ⇒ 字段(Fields)</strong></p>
<p>一个 Elasticsearch 集群可以包含多个索引(数据库)，也就是说其中包含了很多类型(表)。这些类型中包含了很多的文档(行)，然后每个文档中又包含了很多的字段(列)。</p>
<p>Elasticsearch的交互，可以使用<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/java">Java </a>API，也可以直接使用HTTP的Restful API方式，比如我们打算插入一条记录，可以简单发送一个HTTP的请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /megacorp/employee/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot; :     &quot;John&quot;,</span><br><span class="line">    &quot;sex&quot; :      &quot;Male&quot;,</span><br><span class="line">    &quot;age&quot; :      25,</span><br><span class="line">    &quot;about&quot; :    &quot;I love to go rock climbing&quot;,</span><br><span class="line">    &quot;interests&quot;: [ &quot;sports&quot;, &quot;music&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新，查询也是类似这样的操作，具体操作手册可以参见<a target="_blank" rel="noopener" href="http://www.learnes.net/data/README.html">Elasticsearch权威指南</a></p>
<h3 id="索引">索引</h3>
<p>Elasticsearch最关键的就是提供强大的索引能力了，其实InfoQ的这篇<a target="_blank" rel="noopener" href="http://www.infoq.com/cn/articles/database-timestamp-02?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk">时间序列数据库的秘密(2)——索引</a>写的非常好，我这里也是围绕这篇结合自己的理解进一步梳理下，也希望可以帮助大家更好的理解这篇文章。</p>
<p>Elasticsearch索引的精髓：</p>
<blockquote>
<p>一切设计都是为了提高搜索的性能</p>
</blockquote>
<p>另一层意思：为了提高搜索的性能，难免会牺牲某些其他方面，比如插入/更新，否则其他数据库不用混了:)</p>
<p>前面看到往Elasticsearch里插入一条记录，其实就是直接PUT一个json的对象，这个对象有多个fields，比如上面例子中的<em>name, sex, age, about, interests</em>，那么在插入这些数据到Elasticsearch的同时，Elasticsearch还默默<a target="_blank" rel="noopener" href="https://neway6655.github.io/elasticsearch/2015/09/11/elasticsearch-study-notes.html#fn:1">1</a>的为这些字段建立索引–倒排索引，因为Elasticsearch最核心功能是搜索。</p>
<p><strong>Elasticsearch是如何做到快速索引的</strong></p>
<p>InfoQ那篇文章里说Elasticsearch使用的倒排索引比关系型数据库的B-Tree索引快，为什么呢？</p>
<p><strong>什么是B-Tree索引?</strong></p>
<p>上大学读书时老师教过我们，二叉树查找效率是logN，同时插入新的节点不必移动全部节点，所以用树型结构存储索引，能同时兼顾插入和查询的性能。</p>
<p>因此在这个基础上，再结合磁盘的读取特性(顺序读/随机读)，传统关系型数据库采用了B-Tree/B+Tree这样的<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/datastructure">数据结构</a>。</p>
<p>为了提高查询的效率，减少磁盘寻道次数，将多个值作为一个数组通过连续区间存放，一次寻道读取多个数据，同时也降低树的高度。</p>
<p><strong>倒排索引的概念在之前已经了解过了</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601192226162.png" alt="image-20240601192226162"></p>
<p>继续上面的例子，假设有这么几条数据(为了简单，去掉about, interests这两个field):</p>
<table>
<thead>
<tr>
<th style="text-align:left">ID</th>
<th style="text-align:center">Name</th>
<th style="text-align:right">Age</th>
<th style="text-align:right">Sex</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:center">Kate</td>
<td style="text-align:right">24</td>
<td style="text-align:right">Female</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:center">John</td>
<td style="text-align:right">24</td>
<td style="text-align:right">Male</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:center">Bill</td>
<td style="text-align:right">29</td>
<td style="text-align:right">Male</td>
</tr>
</tbody>
</table>
<p>ID是Elasticsearch自建的文档id，那么Elasticsearch建立的索引如下:</p>
<p><strong>Name:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">Term</th>
<th style="text-align:center">Posting List</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Kate</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:left">John</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:left">Bill</td>
<td style="text-align:center">3</td>
</tr>
</tbody>
</table>
<p><strong>Age:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">Term</th>
<th style="text-align:center">Posting List</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">24</td>
<td style="text-align:center">[1,2]</td>
</tr>
<tr>
<td style="text-align:left">29</td>
<td style="text-align:center">3</td>
</tr>
</tbody>
</table>
<p><strong>Sex:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">Term</th>
<th style="text-align:center">Posting List</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Female</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:left">Male</td>
<td style="text-align:center">[2,3]</td>
</tr>
</tbody>
</table>
<p><strong>Posting List</strong></p>
<p>Elasticsearch分别为每个field都建立了一个倒排索引，Kate, John, 24, Female这些叫term，而[1,2]就是<strong>Posting List</strong>。Posting list就是一个int的数组，存储了所有符合某个term的文档id。</p>
<p>看到这里，不要认为就结束了，精彩的部分才刚开始…</p>
<p>通过posting list这种索引方式似乎可以很快进行查找，比如要找age=24的同学，爱回答问题的小明马上就举手回答：我知道，id是1，2的同学。但是，如果这里有上千万的记录呢？如果是想通过name来查找呢？</p>
<p><strong>Term Dictionary</strong></p>
<p>Elasticsearch为了能快速找到某个term，将所有的term排个序，二分法查找term，logN的查找效率，就像通过字典查找一样，这就是<strong>Term Dictionary</strong>。现在再看起来，似乎和传统数据库通过B-Tree的方式类似啊，为什么说比B-Tree的查询快呢？</p>
<h4 id="Term-Index"><strong>Term Index</strong></h4>
<p>B-Tree通过减少磁盘寻道次数来提高查询性能，Elasticsearch也是采用同样的思路，直接通过内存查找term，不读磁盘，但是如果term太多，term dictionary也会很大，放内存不现实，于是有了<strong>Term Index</strong>，就像字典里的索引页一样，A开头的有哪些term，分别在哪页，可以理解term index是一颗树：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601192341799.png" alt="image-20240601192341799"></p>
<p>这棵树不会包含所有的term，它包含的是term的一些前缀。通过term index可以快速地定位到term dictionary的某个offset，然后从这个位置再往后顺序查找。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601192401034.png" alt="image-20240601192401034"></p>
<p>所以term index不需要存下所有的term，而仅仅是他们的一些前缀与Term Dictionary的block之间的映射关系，再结合FST(Finite State Transducers)的压缩技术，可以使term index缓存到内存中。从term index查到对应的term dictionary的block位置之后，再去磁盘上找term，大大减少了磁盘随机读的次数。</p>
<p>这时候爱提问的小明又举手了:”那个FST是神马东东啊?”</p>
<p>一看就知道小明是一个上大学读书的时候跟我一样不认真听课的孩子，数据结构老师一定讲过什么是FST。但没办法，我也忘了，这里再补下课：</p>
<blockquote>
<p>FSTs are finite-state machines that <strong>map</strong> a <strong>term (byte sequence)</strong> to an arbitrary <strong>output</strong>.</p>
</blockquote>
<p>假设我们现在要将mop, moth, pop, star, stop and top(term index里的term前缀)映射到序号：0，1，2，3，4，5(term dictionary的block位置)。最简单的做法就是定义个Map&lt;String, Integer&gt;，大家找到自己的位置对应入座就好了，但从内存占用少的角度想想，有没有更优的办法呢？答案就是：<strong>FST</strong>.</p>
<p><strong>FST简单介绍</strong></p>
<p>FST的设计非常紧凑，它通过状态（State）和转换（Transition）来表示数据。每个状态都代表一个特定的字节序列（如一个单词或短语），转换则代表从一个状态到另一个状态的过程。每个状态和转换都可以附带一个输出值。所有这些信息都可以用极小的空间存储，因为它们主要是索引和引用，而不是实际的数据。</p>
<p>此外，FST使用了一种称为“前缀共享”的技术来进一步减少内存使用。这意味着如果两个或更多的字节序列有相同的前缀（即它们的开始部分相同），那么这些序列的状态和转换将被共享，而不是为每个序列单独存储。这大大减少了需要存储的状态和转换的数量。</p>
<p>例如，对于单词 “cat” 和 “car”，在FST中，它们的前两个字母 “c” 和 “a” 的状态和转换将被共享，只有最后一个字母 “t” 和 “r” 的状态和转换需要单独存储。</p>
<p>因此，通过这种紧凑的数据结构和前缀共享的技术，FST能够在内存占用方面非常高效，即使处理大量的字节序列数据也能保持较<strong>低的内存使用率。</strong></p>
<h4 id="压缩技巧">压缩技巧</h4>
<p>Elasticsearch里除了上面说到用<strong>FST压缩term index</strong>外，<strong>对posting list也有压缩技巧</strong>。 小明喝完咖啡又举手了:”posting list不是已经只存储文档id了吗？还需要压缩？”</p>
<p>嗯，我们再看回最开始的例子，如果Elasticsearch需要对同学的性别进行索引(这时传统关系型数据库已经哭晕在厕所……)，会怎样？如果有上千万个同学，而世界上只有男/女这样两个性别，每个posting list都会有至少百万个文档id。 Elasticsearch是如何有效的对这些文档id压缩的呢？</p>
<p><strong>Frame Of Reference</strong></p>
<blockquote>
<p>增量编码压缩，将大数变小数，按字节存储</p>
</blockquote>
<p>首先，Elasticsearch要求posting list是有序的(为了提高搜索的性能，再任性的要求也得满足)，这样做的一个好处是方便压缩，看下面这个图例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601192621925.png" alt="image-20240601192621925"></p>
<p>后-前</p>
<p>如果数学不是体育老师教的话，还是比较容易看出来这种压缩技巧的。</p>
<p>原理就是通过增量，将原来的大数变成小数仅存储增量值，再精打细算按bit排好队，最后通过字节存储，而不是大大咧咧的尽管是2也是用int(4个字节)来存储。</p>
<p><strong>Roaring bitmaps</strong></p>
<p>说到Roaring bitmaps，就必须先从bitmap说起。Bitmap是一种数据结构，假设有某个posting list：</p>
<p>[1,3,4,7,10]</p>
<p>对应的bitmap就是：</p>
<p>[1,0,1,1,0,0,1,0,0,1]</p>
<p>非常直观，用0/1表示某个值是否存在，比如10这个值就对应第10位，对应的bit值是1，这样用一个字节就可以代表8个文档id，旧版本(5.0之前)的Lucene就是用这样的方式来压缩的，但这样的压缩方式仍然不够高效，如果有1亿个文档，那么需要12.5MB的存储空间，这仅仅是对应一个索引字段(我们往往会有很多个索引字段)。于是有人想出了Roaring bitmaps这样更高效的数据结构。</p>
<p>Bitmap的缺点是存储空间随着文档个数线性增长，Roaring bitmaps需要打破这个魔咒就一定要用到某些指数特性：</p>
<p>将posting list按照65535为界限分块，比如第一块所包含的文档id范围在0~65535之间，第二块的id范围是65536~131071，以此类推。再用**&lt;商，余数&gt;的组合表示每一组id**，这样每组里的id范围都在0~65535内了，剩下的就好办了，既然每组id不会变得无限大，那么我们就可以通过最有效的方式对这里的id存储。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601192657405.png" alt="image-20240601192657405"></p>
<p>细心的小明这时候又举手了:”为什么是以65535为界限?”</p>
<p>程序员的世界里除了1024外，65535也是一个经典值，因为它=2^16-1，正好是用2个字节能表示的最大数，一个short的存储单位，注意到上图里的最后一行“If a block has more than 4096 values, encode as a bit set, and otherwise as a simple array using 2 bytes per value”，如果是大块，用节省点用bitset存，小块就豪爽点，2个字节我也不计较了，用一个short[]存着方便。</p>
<p>那为什么用4096来区分采用数组还是bitmap的阀值呢？</p>
<p>这个是从内存大小考虑的，当block块里元素超过4096后，用bitmap更剩空间： 采用bitmap需要的空间是恒定的: 65536/8 = 8192bytes 而如果采用short[]，所需的空间是: 2*N(N为数组元素个数) 小明手指一掐N=4096刚好是边界:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601192729149.png" alt="image-20240601192729149"></p>
<p>还是节省内存使用率！</p>
<p><strong>联合索引</strong></p>
<p>上面说了半天都是单field索引，如果多个field索引的联合查询，倒排索引如何满足快速查询的要求呢？</p>
<ul>
<li>利用跳表(Skip list)的数据结构快速做“与”运算，或者</li>
<li>利用上面提到的bitset按位“与”</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240601192846071.png" alt="image-20240601192846071"></p>
<p>如果使用跳表，对最短的posting list中的每个id，逐个在另外两个posting list中查找看是否存在，最后得到交集的结果。</p>
<p>如果使用bitset，就很直观了，直接按位与，得到的结果就是最后的交集。</p>
<p><strong>总结</strong></p>
<p>Elasticsearch的索引思路:</p>
<blockquote>
<p>将磁盘里的东西尽量搬进内存，减少磁盘随机读取次数(同时也利用磁盘顺序读特性)，结合各种奇技淫巧的压缩<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/datastructure">算法</a>，用及其苛刻的态度使用内存。</p>
</blockquote>
<p>所以，对于使用Elasticsearch进行索引时需要注意:</p>
<ul>
<li>不需要索引的字段，一定要明确定义出来，因为默认是自动建索引的</li>
<li>同样的道理，对于String类型的字段，不需要analysis的也需要明确定义出来，因为默认也是会analysis的</li>
<li>选择有规律的ID很重要，随机性太大的ID(比如java的UUID)不利于查询</li>
</ul>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/laoyang360/article/details/52244917">Elasticsearch学习，请先看这一篇！</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/cyony/article/details/65437708">Elasticsearch索引原理</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/rodge-run/p/6551152.html">Lucene入门简介</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Y_hanxiong/article/details/131632139">2023最新整理的 Elasticsearch 21道面试题</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/buchizicai/p/17093719.html">ElasticSearch (ES从入门到精通一篇就够了)</a></li>
</ul>
<h2 id="QA">QA</h2>
<h3 id="为什么-Elasticsearch-可以存储更多数据？">为什么 Elasticsearch 可以存储更多数据？</h3>
<p>Elasticsearch 相较于 MySQL 能存储更多数据，主要原因在于其<strong>分布式架构</strong>、<strong>数据存储机制</strong>、<strong>索引结构的优化</strong>以及<strong>扩展性设计</strong>。以下简明比较说明了两者在这些方面的差异：</p>
<ol>
<li><strong>分布式架构 vs 单节点架构（默认）</strong></li>
</ol>
<ul>
<li><strong>Elasticsearch</strong>：原生支持<strong>分布式存储</strong>，数据被自动切分为多个<strong>分片（Shards）</strong>，分布在不同的**节点（Nodes）**上。随着数据量增大，只需增加更多节点，它会自动调整存储和处理能力。这种设计使得 Elasticsearch 能够轻松处理海量数据。</li>
<li><strong>MySQL</strong>：默认是<strong>单节点架构</strong>，所有数据存储在一个节点上。虽然 MySQL 支持主从复制、分片等分布式特性，但这些功能需要手动配置，且复杂度较高，扩展性不如 Elasticsearch。</li>
</ul>
<p><strong>总结</strong>：Elasticsearch 的分布式设计使它能够轻松扩展到数百个节点，处理大规模数据存储和查询，而 MySQL 扩展性较差。</p>
<ol start="2">
<li><strong>索引机制：倒排索引 vs B-tree</strong></li>
</ol>
<ul>
<li><strong>Elasticsearch</strong>：基于<strong>倒排索引（Inverted Index）</strong>，这是全文搜索引擎的核心数据结构。倒排索引为每个词项建立索引，指向包含该词的文档，这使得它在处理<strong>非结构化数据</strong>（如文本、日志等）时效率极高，并且可以快速搜索海量文档。</li>
<li><strong>MySQL</strong>：使用<strong>B-tree</strong> 或 <strong>哈希索引</strong> 进行数据存储和检索，适用于<strong>结构化数据</strong>的<strong>精确匹配</strong>和<strong>范围查询</strong>。但当数据规模巨大时，B-tree 索引效率会下降，且 MySQL 不擅长处理非结构化数据的全文搜索。</li>
</ul>
<p><strong>总结</strong>：Elasticsearch 的倒排索引专为海量数据的全文搜索设计，能够高效地处理和存储大量非结构化数据，而 MySQL 的索引机制更适合小规模、结构化数据的存储和查询。</p>
<ol start="3">
<li><strong>压缩与存储优化</strong></li>
</ol>
<ul>
<li><strong>Elasticsearch</strong>：对存储进行了大量优化，支持<strong>压缩索引</strong>、<strong>稀疏存储</strong>等技术。Elasticsearch 通过将数据压缩成二进制形式，减少了存储空间的占用。其索引和存储设计使得即使在存储海量数据时，也能保持较低的存储开销。</li>
<li><strong>MySQL</strong>：虽然 MySQL 也支持某些压缩技术（例如 InnoDB 的压缩表），但整体上没有 Elasticsearch 那样专门为大规模数据存储进行优化。对于海量数据的存储，MySQL 的存储开销通常更大。</li>
</ul>
<p><strong>总结</strong>：Elasticsearch 的压缩和稀疏存储技术使其能够更高效地存储大规模数据，相比之下，MySQL 的压缩和存储优化相对有限。</p>
<ol start="4">
<li><strong>扩展性：水平扩展 vs 垂直扩展</strong></li>
</ol>
<ul>
<li><strong>Elasticsearch</strong>：主要基于<strong>水平扩展（Horizontal Scaling）</strong>，通过增加更多节点来扩展集群的容量和性能。当数据量增大时，Elasticsearch 可以自动将数据分片分布到新节点上，轻松应对海量数据。</li>
<li><strong>MySQL</strong>：默认只能依赖<strong>垂直扩展（Vertical Scaling）</strong>，通过增加服务器的硬件资源（如 CPU、内存、存储）来提升性能。当单节点达到物理极限时，需要手动进行分片或使用复杂的集群方案，且扩展难度较大。</li>
</ul>
<p><strong>总结</strong>：Elasticsearch 的水平扩展能力使其在数据规模和查询性能上具有极高的灵活性，而 MySQL 的扩展能力在面对大规模数据时往往乏力。</p>
<ol start="5">
<li><strong>数据类型处理：非结构化 vs 结构化</strong></li>
</ol>
<ul>
<li><strong>Elasticsearch</strong>：专为<strong>非结构化数据</strong>（如文本、日志、文档）设计，能够高效存储和检索大量复杂的文本数据。它的全文搜索、复杂查询能力使其能够处理各种类型的数据，包括 JSON 文档等半结构化数据。</li>
<li><strong>MySQL</strong>：主要用于存储<strong>结构化数据</strong>，擅长处理表格化的数据和关系型查询。虽然 MySQL 可以存储 JSON 数据，但对非结构化数据的处理能力较弱，全文搜索性能也不如 Elasticsearch。</li>
</ul>
<p><strong>总结</strong>：Elasticsearch 在处理和存储非结构化数据时表现更好，而 MySQL 更适合处理结构化数据。</p>
<h3 id="ElasticSearch为什么快？"><strong>ElasticSearch为什么快？</strong></h3>
<ol>
<li><strong>分布式存储</strong>：
<ul>
<li><strong>举例</strong>：假设有 10 万条日志数据需要被索引和搜索。Elasticsearch 会将这些数据分布到多个节点上进行存储和索引处理。这样，每个节点只需处理部分数据，极大地减轻了单个节点的压力，提升了系统整体的查询能力。</li>
</ul>
</li>
<li><strong>索引分片</strong>：
<ul>
<li><strong>举例</strong>：当你查询一个包含大量文档的索引时，Elasticsearch 会将查询分解成多个子任务，每个子任务分别在不同的分片上执行。假如该索引有 5 个分片，查询请求会并行地在 5 个分片上执行，提升了查询速度。</li>
</ul>
</li>
<li><strong>全文索引</strong>：
<ul>
<li><strong>举例</strong>：比如你要搜索一篇文档中提到的“机器学习”这个关键词，Elasticsearch 通过全文索引技术，将文档内容索引成倒排索引结构，快速定位出“机器学习”所在的所有文档，快速返回查询结果。</li>
</ul>
</li>
<li><strong>倒排索引</strong>：
<ul>
<li><strong>举例</strong>：在一个新闻网站的数据库中，当用户搜索“经济新闻”时，Elasticsearch 使用倒排索引快速定位包含“经济新闻”关键词的所有文章，而不需要遍历数据库中的每篇文章，极大提升了查询速度。</li>
</ul>
</li>
<li><strong>索引优化</strong>：
<ul>
<li><strong>举例</strong>：Elasticsearch 可以自动对索引进行压缩和合并。例如，旧的日志数据可以通过索引优化压缩成更小的存储文件，同时保持高效的查询能力，减小了存储空间占用并加快了查询速度。</li>
</ul>
</li>
<li><strong>预存储索引</strong>：
<ul>
<li><strong>举例</strong>：对于热门查询，比如“世界杯新闻”，Elasticsearch 可以提前将查询结果存储起来。当用户再次查询相同关键词时，直接返回已经计算好的结果，避免重新索引计算，大幅提升查询速度。</li>
</ul>
</li>
<li><strong>高级查询引擎</strong>：
<ul>
<li><strong>举例</strong>：假设你要根据多个条件（如日期范围、关键词、地域等）对某个新闻数据库进行复杂查询，Elasticsearch 的高级查询引擎可以根据这些条件快速构建优化的查询计划，并从多个维度返回精准的结果。</li>
</ul>
</li>
<li><strong>异步请求处理</strong>：
<ul>
<li><strong>举例</strong>：当系统负载较高时，比如网站用户突然增多，大量请求涌入，Elasticsearch 能将部分用户请求转换为异步处理，这样用户可以立即收到响应，系统再稍后处理查询任务，避免用户长时间等待。</li>
</ul>
</li>
<li><strong>内存存储</strong>：
<ul>
<li><strong>举例</strong>：如果你的系统经常查询同一批次的数据，Elasticsearch 会将这些数据缓存在内存中。当再次查询时，直接从内存中返回结果，大幅提高查询速度，而无需再次从磁盘中读取数据。</li>
</ul>
</li>
</ol>
<h3 id="Elasticsearch支持事务吗？"><strong>Elasticsearch支持事务吗？</strong></h3>
<p>ES虽然也可以认为是一个数据库，但是他并不支持传统意义上的ACID事务，因为ES它被设计出来是主要用作搜索引擎的，主要是提升查询效率的。如果支持复杂的事务操作意味着就要牺牲性能优势。</p>
<p>虽然<strong>Elasticsearch 不支持传统的事务</strong>，但是他是可以<strong>确保单个文档的更改(如创建、更新、删除)是原子性的</strong>。这意味着任何文档级的操作都完整地成功或完整地失败，但不保证跨多个文档或操作的一致性。</p>
<h3 id="什么是ElasticSearch的深度分页问题？">什么是ElasticSearch的深度分页问题？</h3>
<p><strong>深度分页问题</strong> 是指在 Elasticsearch 中，随着查询结果页数的增加，查询性能显著下降的问题。具体表现为，当用户请求 <strong>非常靠后的结果页</strong> 时（如第 10000 页），查询的响应时间变得非常慢，甚至耗尽系统资源。</p>
<p>原因：</p>
<ol>
<li><strong>每次分页都需要遍历大量数据</strong>：
<ul>
<li>Elasticsearch 在分页查询时，仍然需要从头开始扫描、排序和跳过之前的所有文档，直到找到目标页的数据。例如，查询第 10000 页的结果时，需要跳过前 9999 页的数据，这导致了大量的计算和内存开销。</li>
</ul>
</li>
<li><strong>大数据量的排序开销</strong>：
<ul>
<li>Elasticsearch 在分页时会对匹配条件的所有文档进行排序（通常基于 <code>_score</code> 或指定字段）。当查询结果页数很大时，排序的文档数量非常多，导致内存消耗剧增，影响性能。</li>
</ul>
</li>
</ol>
<p>举例：</p>
<p>如果你在一个包含上百万条商品记录的电商网站上查询第 10000 页的商品数据，Elasticsearch 需要扫描所有前 9999 页的数据，再根据分页参数 <code>from</code> 和 <code>size</code> 跳过这些数据，这会随着页数的增加，导致查询时间和资源消耗急剧上升。</p>
<p>解决方案：</p>
<ol>
<li><strong>使用 <code>search_after</code></strong>：
<ul>
<li>通过 <code>search_after</code> 参数，基于上一个查询结果的排序标记来获取下一页数据，避免深度分页时的跳过计算。</li>
</ul>
</li>
<li><strong>使用 <code>scroll</code> API</strong>：
<ul>
<li>如果需要处理大量数据，可以使用 <strong>滚动查询</strong>（<code>scroll</code>），它在一次查询中锁定数据快照，分批次读取大数据集，避免每次重新排序和扫描。</li>
</ul>
</li>
<li><strong>限制最大分页深度</strong>：
<ul>
<li>许多系统会限制用户只能分页到一定深度（如 100 页），以避免资源占用过高。</li>
</ul>
</li>
</ol>
<h3 id="MySQL-和-Elasticsearch-数据类型"><strong>MySQL</strong> 和 Elasticsearch 数据类型</h3>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>MySQL 类型</strong></th>
<th style="text-align:left"><strong>Elasticsearch 类型</strong></th>
<th style="text-align:left"><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>VARCHAR</strong></td>
<td style="text-align:left"><code>text</code>, <code>keyword</code></td>
<td style="text-align:left">根据是否需要全文搜索或精确搜索选择使用 <code>text</code> 或 <code>keyword</code>。</td>
</tr>
<tr>
<td style="text-align:left"><strong>CHAR</strong></td>
<td style="text-align:left"><code>keyword</code></td>
<td style="text-align:left">通常映射为 <code>keyword</code>，因为它们用于存储较短的、不经常变化的字符串。</td>
</tr>
<tr>
<td style="text-align:left"><strong>BLOB/TEXT</strong></td>
<td style="text-align:left"><code>text</code></td>
<td style="text-align:left">大文本块使用 <code>text</code> 类型，支持全文检索。</td>
</tr>
<tr>
<td style="text-align:left"><strong>INT, BIGINT</strong></td>
<td style="text-align:left"><code>long</code></td>
<td style="text-align:left">大多数整数类型映射为 <code>long</code>，以支持更大的数值。</td>
</tr>
<tr>
<td style="text-align:left"><strong>TINYINT</strong></td>
<td style="text-align:left"><code>byte</code></td>
<td style="text-align:left">较小的整数可以映射为 <code>byte</code> 类型。</td>
</tr>
<tr>
<td style="text-align:left"><strong>DECIMAL, FLOAT, DOUBLE</strong></td>
<td style="text-align:left"><code>double</code>, <code>float</code></td>
<td style="text-align:left">根据精确度需求选择 <code>double</code> 或 <code>float</code>。</td>
</tr>
<tr>
<td style="text-align:left"><strong>DATE, DATETIME, TIMESTAMP</strong></td>
<td style="text-align:left"><code>date</code></td>
<td style="text-align:left">所有的日期时间类型均可映射为 <code>date</code>。</td>
</tr>
<tr>
<td style="text-align:left"><strong>TINYINT(1)</strong></td>
<td style="text-align:left"><code>boolean</code></td>
<td style="text-align:left"><code>TINYINT(1)</code> 通常用于布尔值，映射为 Elasticsearch 的 <code>boolean</code> 类型。</td>
</tr>
</tbody>
</table>
<p>说明：</p>
<ul>
<li><strong><code>text</code></strong>：用于存储需要进行全文检索的长文本字段，适合搜索内容。</li>
<li><strong><code>keyword</code></strong>：用于存储短字符串，适合需要精确匹配的字段，如标签、ID 等。</li>
<li><strong><code>long</code></strong>：用于存储大整数，适合 MySQL 中的 <code>INT</code> 或 <code>BIGINT</code> 类型。</li>
<li><strong><code>byte</code></strong>：适合存储小整数，如 <code>TINYINT</code>。</li>
<li><strong><code>double</code>, <code>float</code></strong>：适合存储浮点数，具体选择取决于精度要求。</li>
<li><strong><code>date</code></strong>：用于存储日期或时间戳。</li>
<li><strong><code>boolean</code></strong>：用于存储布尔值，适合 <code>TINYINT(1)</code> 类型。</li>
</ul>
<h3 id="如何保证ES和数据库的数据一致性？">如何保证ES和数据库的数据一致性？</h3>
<p>在实际应用中，通常会使用关系型数据库（如 MySQL）作为<strong>主数据存储</strong>，而使用 ElasticSearch 进行<strong>全文检索</strong>和<strong>快速查询</strong>。为了确保两者之间的数据一致性，需要采取一些策略和设计模式。</p>
<p><strong>1. 双写方案</strong></p>
<p>在双写方案中，应用程序在写入数据库的同时，也同步写入 ElasticSearch。即每次对数据库进行增删改操作时，都会同时更新 ES 索引。</p>
<p>1.1 问题</p>
<ul>
<li><strong>数据不一致风险</strong>：双写过程中，如果数据库写入成功，但 ElasticSearch 写入失败，数据会出现不一致的情况。</li>
<li><strong>网络延迟</strong>：由于数据库和 ElasticSearch 的写入是两个独立的操作，网络延迟或故障可能导致某个操作失败。</li>
</ul>
<p>1.2 解决方案：<strong>事务性保证</strong></p>
<p>可以通过<strong>分布式事务</strong>或<strong>补偿机制</strong>来解决双写过程中数据不一致的问题。例如：</p>
<ul>
<li><strong>事务消息</strong>：使用消息队列（如 Kafka）来进行数据库和 ES 的双写，将数据更新操作放入消息队列中，保证数据库和 ES 的更新要么都成功，要么都失败（确保最终一致性）。</li>
<li><strong>最终一致性</strong>：即使发生网络故障，系统可以检测到数据不一致并通过定期对账机制进行修复，确保最终数据一致。</li>
</ul>
<p>【补偿任务（Compensation Task）通常是指在系统或流程中，为了纠正或弥补之前的错误、失败或不完整操作而执行的任务】</p>
<p>举例：</p>
<ul>
<li><strong>订单系统</strong>：当用户下单时，数据库会记录订单信息，同时通过异步任务或消息队列将订单数据写入 ElasticSearch。若 ElasticSearch 写入失败，系统可以通过重试机制或补偿任务来确保订单数据最终能够同步到 ES 中。</li>
</ul>
<p><strong>2. 基于消息队列的异步同步方案</strong></p>
<p>这是使用最广泛的一种方案。核心思想是使用消息队列（如 Kafka、RabbitMQ）来保证数据库和 ElasticSearch 之间的同步。</p>
<p>步骤：</p>
<ol>
<li><strong>数据库写入</strong>：应用程序先操作数据库，执行增、删、改。</li>
<li><strong>发布消息</strong>：操作完成后，生成变更事件并发布到消息队列中。</li>
<li><strong>消费消息</strong>：消费者从消息队列中读取消息，执行对 ElasticSearch 的增删改，保证 ElasticSearch 中的数据与数据库保持同步。</li>
</ol>
<p>2.1 优势</p>
<ul>
<li><strong>解耦</strong>：通过消息队列解耦数据库和 ElasticSearch 的写入，可以处理高并发和数据同步延迟问题。</li>
<li><strong>可靠性</strong>：消息队列可以设置消息的持久化，保证即使系统故障后，消息仍然不会丢失。</li>
<li><strong>可扩展性</strong>：消息队列可以水平扩展，支持高负载下的异步处理。</li>
</ul>
<p>2.2 问题</p>
<ul>
<li><strong>延时</strong>：由于 ElasticSearch 的写入是异步的，可能会存在数据延迟，无法做到强一致性。</li>
<li><strong>消息丢失</strong>：如果消息队列中消息丢失，可能导致数据不一致。</li>
</ul>
<p>2.3 解决方案</p>
<ul>
<li><strong>消息持久化</strong>：确保消息队列中的消息持久化，防止消息丢失。</li>
<li><strong>重试机制</strong>：如果 ElasticSearch 写入失败，可以通过重试机制确保数据最终写入 ES。</li>
<li><strong>定期对账</strong>：可以定期从数据库中获取数据与 ES 中的数据进行比对，修复不一致的数据。</li>
</ul>
<p>举例：</p>
<ul>
<li><strong>电商系统的商品同步</strong>：当数据库中商品信息发生变更时，生成一条变更消息并发送到 Kafka。ElasticSearch 消费者从 Kafka 中获取消息，更新商品数据到 ES 索引。如果更新失败，消费者可以通过重试机制确保最终同步成功。</li>
</ul>
<p><strong>3.扫描表定时同步</strong></p>
<p>这种方式是通过定期任务扫描数据库表，批量更新 ES。适合对数据实时性要求较低的场景。</p>
<p>优点：</p>
<ul>
<li><strong>无侵入性</strong>：不需要修改业务代码，完全通过定时任务进行数据同步。</li>
<li><strong>实现简单</strong>：不依赖其他复杂的机制，直接从数据库读取数据并更新到 ES。</li>
</ul>
<p>缺点：</p>
<ul>
<li><strong>实时性差</strong>：数据更新的延迟较大，无法做到实时同步。</li>
<li><strong>性能问题</strong>：频繁扫描数据库会给数据库带来额外的负担，影响数据库的性能。</li>
</ul>
<p>举例：</p>
<ul>
<li><strong>数据报表系统</strong>：如果一个报表系统的数据更新频率较低，可以每小时定时扫描数据库表，将最新数据批量更新到 ES 中，供后续查询使用。</li>
</ul>
<p><strong>4.监听 Binlog 同步</strong></p>
<p>这种方式通过监听数据库的 <strong>binlog</strong> 日志，同步数据库的变更操作到 ES。可以使用成熟的框架（如 Canal）来捕获 binlog 事件并更新到 ES。</p>
<p><strong>步骤：</strong></p>
<ol>
<li><strong>MySQL 写入数据</strong>：当用户执行订单操作（如创建订单、支付订单、发货等）时，订单信息会首先写入 MySQL 数据库，生成一条增、删、改操作的记录。</li>
<li><strong>生成 Binlog 日志</strong>：MySQL 会自动生成一条 <strong>Binlog</strong> 日志，记录该订单的变化（如新增、修改、删除操作），包括订单的详细信息（如订单 ID、订单状态等）。</li>
<li><strong>监听 Binlog</strong>：使用像 <strong>Canal</strong> 这样的工具，监听 MySQL 的 Binlog 日志。当有新的日志产生时，Canal 会捕获该 Binlog 事件，并解析出订单的变化信息。</li>
<li><strong>同步到 ElasticSearch</strong>：
<ul>
<li>Canal 解析出具体的数据库变更操作（如订单的创建、状态更新等）。</li>
<li>解析后的数据通过 Canal 的客户端或自行开发的同步服务，更新到 ElasticSearch 中。</li>
<li>比如，如果订单状态更新为“已支付”，Canal 会将这一变更信息推送至 ElasticSearch，更新对应订单的状态。</li>
</ul>
</li>
</ol>
<p>举例：</p>
<ul>
<li><strong>电商系统订单同步</strong>：当用户下单、支付或者取消订单时，数据库会记录这些变更，并生成 binlog。通过监听这些 binlog 事件，可以实时将订单状态更新到 ES 中，确保搜索时能够获取最新的订单状态。</li>
</ul>
<h3 id="ES锁的支持">ES锁的支持</h3>
<p>支持乐观，不支持悲观~</p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Elasticsearch索引学习</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://penge666.github.io/posts/e4652363.html">https://penge666.github.io/posts/e4652363.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Penge666</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2023-11-25</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-10-04</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Elasticsearch/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Elasticsearch</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂作者</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/93a1f5a2.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_2.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Kafka基本术语</div></div></a></div><div class="next-post pull-right"><a href="/posts/5bce731.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_78.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">初识MQ</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/ce1714.html" title="倒排索引"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_136.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-09-21</div><div class="title">倒排索引</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lucene%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-text">Lucene执行原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%92%8C%E6%90%9C%E7%B4%A2%E5%8E%9F%E7%90%86"><span class="toc-text">索引和搜索原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95"><span class="toc-text">查询索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elasticsearch%E7%B4%A2%E5%BC%95"><span class="toc-text">Elasticsearch索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Term-Index"><span class="toc-text">Term Index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E6%8A%80%E5%B7%A7"><span class="toc-text">压缩技巧</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QA"><span class="toc-text">QA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-Elasticsearch-%E5%8F%AF%E4%BB%A5%E5%AD%98%E5%82%A8%E6%9B%B4%E5%A4%9A%E6%95%B0%E6%8D%AE%EF%BC%9F"><span class="toc-text">为什么 Elasticsearch 可以存储更多数据？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ElasticSearch%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB%EF%BC%9F"><span class="toc-text">ElasticSearch为什么快？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch%E6%94%AF%E6%8C%81%E4%BA%8B%E5%8A%A1%E5%90%97%EF%BC%9F"><span class="toc-text">Elasticsearch支持事务吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFElasticSearch%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-text">什么是ElasticSearch的深度分页问题？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL-%E5%92%8C-Elasticsearch-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">MySQL 和 Elasticsearch 数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81ES%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%9F"><span class="toc-text">如何保证ES和数据库的数据一致性？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES%E9%94%81%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-text">ES锁的支持</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">格言🧬</p><div class="bg-ad"><div>用勇气改变可以改变的事，用胸怀接受不能接受的事，用智慧分辨两者的不同✨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://github.com/Penge666/">点击开启星辰之旅</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">猜你想看💡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">惊喜网站</a><a href="/box/nav/">网址导航</a></li><li><a href="/social/link/">我的朋友</a><a href="/comments/">留点什么</a></li><li><a href="/personal/about/">关于作者</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">推荐友链⌛</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://www.fomal.cc/" title="Fomalhaut🥝"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2024</b></span><span><b>&nbsp;&nbsp;By Penge666</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="本站采用多线部署，主线路托管于Vercel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="本站数据分析得益于51la技术支持"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="本站已加入萌ICP豪华套餐，萌ICP备20226665号"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/萌ICP备-20226665-fe1384.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="本网站经Service Worker分流至缤纷云对象存储"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-缤纷云-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="本站使用网盾星球提供CDN加速与防护"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-网盾星球-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本网站源码由Github提供存储仓库"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="右键模式" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>美化设置</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/分布式/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍡 Kevinの分布式学习笔记 (8)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/操作系统/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍉 Kevinの操作系统笔记 (21)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/Cpp/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍟 KevinのCpp基础笔记 (39)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/数据结构/Cpp/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍟 KevinのCpp基础笔记 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/数据库/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍨 Kevinの数据库笔记 (12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://Penge666.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_20.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdown语法与外挂标签写法汇总</a><div class="blog-slider__text">🥧本文汇总Markdown格式以及外挂标签在网页端的渲染效果，可作为文档进行查询</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --></body></html>