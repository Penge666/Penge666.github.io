<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>WebSocket协议 | Penge666</title><meta name="keywords" content="计算机网络"><meta name="author" content="Penge666"><meta name="copyright" content="Penge666"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="WebSocket协议及原理">
<meta property="og:type" content="article">
<meta property="og:title" content="WebSocket协议">
<meta property="og:url" content="https://penge666.github.io/posts/5447b09e.html">
<meta property="og:site_name" content="Penge666">
<meta property="og:description" content="WebSocket协议及原理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://penge666.github.io/assets/photo1/default_cover_7.webp">
<meta property="article:published_time" content="2024-06-18T02:20:28.000Z">
<meta property="article:modified_time" content="2024-06-18T02:34:55.873Z">
<meta property="article:author" content="Penge666">
<meta property="article:tag" content="计算机网络">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://penge666.github.io/assets/photo1/default_cover_7.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://penge666.github.io/posts/5447b09e"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WebSocket协议',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-18 10:34:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Penge666" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/hhh.jpeg" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">83</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei"></use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Penge666</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei"></use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="检索站内任何你想要的信息"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> 搜索</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="美化设置-自定义你的风格" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="浅色和深色模式转换" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">WebSocket协议</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">发表于 </span><time class="post-meta-date-created" datetime="2024-06-18T02:20:28.000Z" title="发表于 2024-06-18 10:20:28">2024-06-18</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-18T02:34:55.873Z" title="更新于 2024-06-18 10:34:55">2024-06-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">字数总计:</span><span class="word-count">2w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">阅读时长:</span><span>83分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WebSocket协议"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="0-前言">0.前言</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102135047.png" alt="image-20240618102135047"></p>
<p>WebSocket协议是基于TCP的一种新的网络协议。它实现了浏览器与服务器全双工(full-duplex)通信——允许服务器主动发送信息给客户端。</p>
<p>WebSocket通信协议于2011年被IETF定为标准RFC 6455，并被RFC7936所补充规范。</p>
<h2 id="1-WebSocket简介">1.WebSocket简介</h2>
<p>webSocket是什么:</p>
<p>1、WebSocket是一种在单个TCP连接上进行全双工通信的协议</p>
<p>2、WebSocket使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据</p>
<p>3、在WebSocket API中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输</p>
<p>4、需要安装第三方包：cmd中：go get -u -v <a href="https://link.zhihu.com/?target=http%3A//github.com/gorilla/websocket">github.com/gorilla/websocket</a></p>
<p>WebSocket 是一种标准协议，用于在客户端和服务端之间进行双向数据传输。但它跟 HTTP 没什么关系，它是一种基于 TCP 的一种独立实现。</p>
<p>以前客户端想知道服务端的处理进度，要不停地使用 Ajax 进行轮询，让浏览器隔个几秒就向服务器发一次请求，这对服务器压力较高。另外一种轮询就是采用 long poll 的方式，这就跟打电话差不多，没收到消息就一直不挂电话，也就是说，客户端发起连接后，如果没消息，就一直不返回 Response 给客户端，连接阶段一直是阻塞的。</p>
<p>而 WebSocket 解决了 HTTP 的这几个难题。首先，当服务器完成协议升级后（ HTTP -&gt; WebSocket ），服务端可以主动推送信息给客户端，解决了轮询造成的同步延迟问题。由于 WebSocket 只需要一次 HTTP 握手，服务端就能一直与客户端保持通讯，直到关闭连接，这样就解决了服务器需要反复解析 HTTP 协议，减少了资源的开销。</p>
<p>WebSocket协议支持（在受控环境中运行不受信任的代码的）客户端与（选择加入该代码的通信的）远程主机之间进行全双工通信。用于此的安全模型是Web浏览器常用的基于原始的安全模式。 协议包括一个开放的握手以及随后的TCP层上的消息帧。 该技术的目标是为基于浏览器的、需要和服务器进行双向通信的（服务器不能依赖于打开多个HTTP连接（例如，使用XMLHttpRequest或和长轮询））应用程序提供一种通信机制。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102203194.png" alt="image-20240618102203194"></p>
<p>websocket 是一个基于应用层的网络协议，建立在tcp 协议之上，和 http 协议可以说是兄弟的关系，但是这个兄弟有点依赖 http ，为什么这么说呢？我们都知道 HTTP 实现了三次握手来建立通信连接，实际上 websocket 的创始人很聪明，他不想重复的去造轮子，反正我兄弟已经实现了握手了，我干嘛还要重写一套呢？先让它去冲锋陷阵呢，我坐收渔翁之利不是更香 吗，所以一般来说，我们会先用 HTTP 先进行三次握手，再向服务器请求升级为websocket 协议，这就好比说，嘿兄弟你先去给我排个队占个坑位建个小房子，到时候我在把这房子改造成摩天大楼。而且一般来说 80 和 443 端口一般 web 服务端都会外放出去，这样可以有效的避免防火墙的限制。当然，你创建的 websocket 服务端进程的端口也需要外放出去。</p>
<p>很多人会想问，web开发 使用 HTTP 协议不是已经差不多够用了吗？为什么还要我再多学一种呢？这不是搞事情嘛，仔细想想，一门新技术的产生必然有原因的，如果没有需求，我们干嘛那么蛋疼去写那么多东西，就是因为 HTTP 这个协议有些业务需求支持太过于鸡肋了，从 HTTP 0.9 到现在的 HTTP3.0 ，HTTP协议可以说说是在普通的web开发领域已经是十分完善且高效的了，说这个协议养活了全球半数的公司也不为过吧，像 2.0 服务器推送技术，3.0 采用了 UDP 而放弃了原来的 TCP ,这些改动都是为了进一步提升协议的性能，然而大家现在还是基本使用的 HTTP 1.1 这个最为经典的协议, 也是让开发者挺尴尬的。</p>
<p>绝大多数的web开发都是应用层开发者,大多数都是基于已有的应用层去开发应用，可以说我们最熟悉、日常打交道最多的就是应用层协议了，底下 TCP/IP 协议我们基本很少会去处理，当然大厂可能就不一样了，自己弄一套协议也是正常的，这大概也是程序员和码农的区别吧，搬砖还是创新，差别还是很大的。网络这种分层协议的好处我在之前的文章也说过了，这种隔离性很方便就可以让我们基于原来的基础去拓展，具有较好的兼容性。</p>
<p>总的来说，它就是一种依赖HTTP协议的，支持全双工通信的一种应用层网络协议。</p>
<h2 id="2-WebSocket产生背景">2.WebSocket产生背景</h2>
<p>简单的说，WebSocket协议之前，双工通信是通过多个http链接来实现，这导致了效率低下。WebSocket解决了这个问题。下面是标准RFC6455中的产生背景概述。</p>
<p>长久以来, 创建实现客户端和用户端之间双工通讯的web app都会造成HTTP轮询的滥用: 客户端向主机不断发送不同的HTTP呼叫来进行询问。</p>
<p><strong>这会导致一系列的问题：</strong></p>
<ul>
<li>1.服务器被迫为每个客户端使用许多不同的底层TCP连接：一个用于向客户端发送信息，其它用于接收每个传入消息。</li>
<li>2.有些协议有很高的开销，每一个客户端和服务器之间都有HTTP头。</li>
<li>3.客户端脚本被迫维护从传出连接到传入连接的映射来追踪回复。</li>
</ul>
<p>一个更简单的解决方案是使用单个TCP连接双向通信。 这就是WebSocket协议所提供的功能。 结合WebSocket API ，WebSocket协议提供了一个用来替代HTTP轮询实现网页到远程主机的双向通信的方法。</p>
<p>WebSocket协议被设计来取代用HTTP作为传输层的双向通讯技术,这些技术只能牺牲效率和可依赖性其中一方来提高另一方，因为HTTP最初的目的不是为了双向通讯。</p>
<h2 id="3-WebSocket实现原理">3.WebSocket实现原理</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102242067.png" alt="image-20240618102242067"></p>
<p>在实现websocket连线过程中，需要通过浏览器发出websocket连线请求，然后服务器发出回应，这个过程通常称为“握手” 。在 WebSocket API，浏览器和服务器只需要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。在此WebSocket 协议中，为我们实现即时服务带来了两大好处：</p>
<ol>
<li>
<p>Header：互相沟通的Header是很小的-大概只有 2 Bytes。</p>
</li>
<li>
<p>Server Push：服务器的推送，服务器不再被动的接收到浏览器的请求之后才返回数据，而是在有新数据时就主动推送给浏览器。</p>
</li>
</ol>
<h2 id="4-WebSocket协议举例">4.WebSocket协议举例</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102254393.png" alt="image-20240618102254393"></p>
<p>浏览器请求:</p>
<ul>
<li>GET /webfin/websocket/ HTTP/1.1。</li>
<li>Host: localhost。</li>
<li>Upgrade: websocket。</li>
<li>Connection: Upgrade。</li>
<li>Sec-WebSocket-Key: xqBt3ImNzJbYqRINxEFlkg==。</li>
<li>Origin: <a href="https://link.zhihu.com/?target=http%3A//xn--zfru1gfr6bz63i/">http://服务器地址</a>。</li>
<li>Sec-WebSocket-Version: 13。</li>
</ul>
<p>服务器回应:</p>
<ul>
<li>HTTP/1.1 101 Switching Protocols。</li>
<li>Upgrade: websocket。</li>
<li>Connection: Upgrade。</li>
<li>Sec-WebSocket-Accept: K7DJLdLooIwIG/MOpvWFB3y3FE8=。</li>
<li>WebSocket借用http请求进行握手，相比正常的http请求，多了一些内容。其中：</li>
<li>Upgrade: websocket。</li>
<li>Connection: Upgrade。</li>
<li>表示希望将http协议升级到Websocket协议。Sec-WebSocket-Key是浏览器随机生成的base64 encode的值，用来询问服务器是否是支持WebSocket。</li>
</ul>
<p>服务器返回:</p>
<ul>
<li>Upgrade: websocket。</li>
<li>Connection: Upgrade。</li>
<li>告诉浏览器即将升级的是Websocket协议</li>
</ul>
<p>Sec-WebSocket-Accept是将请求包“Sec-WebSocket-Key”的值，与”258EAFA5-E914-47DA-95CA-C5AB0DC85B11″这个字符串进行拼接，然后对拼接后的字符串进行sha-1运算，再进行base64编码得到的。用来说明自己是WebSocket助理服务器。</p>
<p>Sec-WebSocket-Version是WebSocket协议版本号。RFC6455要求使用的版本是13，之前草案的版本均应当被弃用。</p>
<h2 id="5-WebSocket使用">5.WebSocket使用</h2>
<h3 id="5-1-WebSocket-介绍">5.1 WebSocket 介绍</h3>
<p>WebSocket 发起单个请求，服务端不需要等待客服端，客户端在任何时候也能发消息到服务端，减少了轮询时候的延迟.经历一次连接后，服务器能给客户端发多次。下图是轮询与WebSocket的区别。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102307422.png" alt="image-20240618102307422"></p>
<p>基于http的实时消息是相当的复杂，在无状态的请求中维持回话的状态增加了复杂度，跨域也很麻烦，使用ajax处理请求有序请求需要考虑更多。通过ajax进行交流也不简单。每一个延伸http功能的目的不是增加他的复杂度。websocket 可以大大简化实时通信应用中的链接。</p>
<p>Websocket是一种底层网络协议，可以让你在这个基础上建立别的标准协议。比如在WebSocket的客户端的基础上使用XMPP登录不同的聊天服务器，因为所有的XMPP服务理解相同的标准协议。WebSocket是web应用的一种创新。</p>
<p>为了与其他平台竞争，WebSocket是H5应用提供的一部分先进功能。每个操作系统都需要网络功能，能够让应用使用Sockets与别的主机进行通信，是每个大平台的核心功能。在很多方面，让Web应用表现的像操作系统平台是html5的趋势。像socket这样底层的网络协议APIs不会符合原始的安全模型，也不会有web api那样的设计风格。WebSocket给H5应用提供TCP的方式不会消弱网络安全且有现代的Api。</p>
<p>WebSocket是Html5平台的一个重要组件也是开发者强有力的工具。简单的说，你需要WebSocket创建世界级的web应用。它弥补了http不适合实时通信的重大缺陷。异步、双向通信模式，通过传输层协议使WebSocket具有普遍灵活性。想象一下你能用WebSocket创建正真实实时应用的所有方式。比如聊天、协作文档编辑、大规模多人在线游戏（MMO）,股票交易应用等等。</p>
<p>WebSocket是一个协议，但也有一个WebSocket API，这让你的应用去控制WebSocket的协议去响应被服务端触发的事件。API是W3C开发，协议是IETE制定。现代浏览器支持WebSocket API，这包括使用全双工和双向链接的方法和特性。让你执行像打开关闭链接、发送接收消息、监听服务端事件等必要操作。</p>
<h3 id="5-2-WebSocket-API">5.2 WebSocket API</h3>
<p>WebSocket API其实就是一个使用WebSocket协议的接口，通过它来建立全双工通道来收发消息，简单易学，要连接远程服务器，只需要创建一个WebSocket对象实体，并传入一个服务端的URL。在客户端和服务端一开始握手的期间，http协议升级到WebSocket协议就建立了连接，底层都是TCP协议。一旦建立连接，通过WebSocket接口可以反复的发送消息。在你的代码里面，你可以使用异步事件监听连接生命周期的每个阶段。</p>
<p>WebSocket API是纯事件驱动，一旦建立全双工连接，当服务端给客户端发送数据或者资源，它能自动发送状态改变的数据和通知。所以你不需要为了状态的更新而去轮训Server，在客户端监听即可。</p>
<p>首先，我们需要通过调用WebSocket构造函数来创建一个WebSocket连接，构造函数会返回一个WebSocket实例，可以用来监听事件。这些事件会告诉你什么时候连接建立，什么时候消息到达，什么时候连接关闭了，以及什么时候发生了错误。WebSocket协议定义了两种URL方案，WS和WSS分别代表了客户端和服务端之间未加密和加密的通信。WS(WebSocket)类似于Http URL，而WSS（WebSocket Security）URL 表示连接是基于安全传输层（TLS/SSL）和https的连接是同样的安全机制。</p>
<p>WebSocket的构造函数需要一个URL参数和一个可选的协议参数（一个或者多个协议的名字），协议的参数例如XMPP（Extensible Messaging and Presence Protocol）、SOAP（Simple Object Access Protocol）或者自定义协议。而URL参数需要以WS://或者WSS://开头，例如：ws://<a href="https://link.zhihu.com/?target=http%3A//www.websocket.org">http://www.websocket.org</a>，如果URL有语法错误，构造函数会抛出异常。</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create new WebSocket connection</span></span><br><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://www.websocket.org&quot;</span>);</span><br><span class="line"><span class="comment">//测试了下链接不上。</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102319312.png" alt="image-20240618102319312"></p>
<p>第二个参数是协议名称，是可选的，服务端和客服端使用的协议必须一致，这样收发消息彼此才能理解，你可以定义一个或多个客户端使用的协议，服务端会选择一个来使用，一个客服端和一个服务端之间只能有一个协议。当然都得基于WebSocket，WebSocket的重大好处之一就是基于WebSocket协议的广泛使用，让你的Web能够拥有传统桌面程序那样的能力。</p>
<p>言归正传，我们回到构造函数，在第一次握手之后，和协议的名称一起，客户端会发送一个Sec-WebSocket-Protocol 头，服务端会选择0个或一个协议，响应会带上同样的Sec-WebSocket-Protocol 头，否则会关闭连接。通过协议协商（Protocol negotiation ），我们可以知道给定的WebSocket服务器所支持的协议和版本，然后应用选择协议使用。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Connecting to the server with one protocol called myProtocol</span></span><br><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> <span class="type">WebSocket</span>(<span class="string">&quot;ws://echo.websocket.org&quot;</span>, <span class="string">&quot;myProtocol&quot;</span>);</span><br><span class="line"><span class="comment">//myProtocol 是假设的一个定义好的且符合标准的协议。</span></span><br></pre></td></tr></table></figure>
<p>你可以传递一个协议的数组。</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> echoSocket = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://echo.websocket.org&quot;</span>, [<span class="string">&quot;com.kaazing.echo&quot;</span>,<span class="string">&quot;example.imaginary.protocol&quot;</span>])</span><br><span class="line"><span class="comment">//服务端会选择其中一个使用</span></span><br><span class="line">echoSocket.onopen = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line"><span class="comment">// Check the protocol chosen by the server</span></span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(echoSocket.protocol);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：com.kaazing.ech</p>
<p>协议这个参数有三种。</p>
<p>1.注册协议：根据RFC6455（WebSocket 协议）和IANA被官方注册的标准协议。例如 微软的SOAP。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102325187.png" alt="image-20240618102325187"></p>
<p>看到两个华为的：</p>
<p>2.开放协议：被广泛使用的标注协议，例如XMPP和STOMP。但没有被正式注册。</p>
<p>3.自定义协议：自己编写和使用的WebSocket的协议。 协议会再后续章节给出详细介绍，下面先看事件、对象和方法以及实例。</p>
<h3 id="5-3-WebSocket事件">5.3 WebSocket事件</h3>
<p>WebSocket API是纯事件驱动，通过监听事件可以处理到来的数据和改变的链接状态。客户端不需要为了更新数据而轮训服务器。服务端发送数据后，消息和事件会异步到达。WebSocket编程遵循一个异步编程模型，只需要对WebSocket对象增加回调函数就可以监听事件。你也可以使用addEventListener()方法来监听。而一个WebSocket对象分四类不同事件。</p>
<h4 id="5-3-1-open">5.3.1 open</h4>
<p>一旦服务端响应WebSocket连接请求，就会触发open事件。响应的回调函数称为onopen。</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Event handler for the WebSocket connection opening</span></span><br><span class="line">ws.onopen = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;Connection open...&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>open事件触发的时候，意味着协议握手结束，WebSocket已经准备好收发数据。如果你的应用收到open事件，就可以确定服务端已经处理了建立连接的请求，且同意和你的应用通信。</p>
<h4 id="5-3-2-Message"><strong>5.3.2 Message</strong></h4>
<p>当消息被接受会触发消息事件，响应的回调函数叫做onmessage。如下：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接受文本消息的事件处理实例：</span></span><br><span class="line">ws.onmessage = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">typeof</span> e.data === <span class="string">&quot;string&quot;</span>)&#123;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;String message received&quot;</span>, e, e.data);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;Other message received&quot;</span>, e, e.data);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>除了文本消息，WebSocket消息机制还能处理二进制数据，有Blob和ArrayBuffer两种类型，在读取到数据之前需要决定好数据的类型。</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置二进制数据类型为blob（默认类型）</span></span><br><span class="line">ws.binaryType = <span class="string">&quot;blob&quot;</span>;</span><br><span class="line"><span class="comment">// Event handler for receiving Blob messages</span></span><br><span class="line">ws.onmessage = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line"><span class="keyword">if</span>(e.data instanceof Blob)&#123;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;Blob message received&quot;</span>, e.data);</span><br><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> Blob(e.data);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ArrayBuffer</span></span><br><span class="line">ws.<span class="property">binaryType</span> = <span class="string">&quot;arraybuffer&quot;</span>;</span><br><span class="line">ws.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line"><span class="keyword">if</span>(e.<span class="property">data</span> <span class="keyword">instanceof</span> <span class="title class_">ArrayBuffer</span>)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ArrayBuffer Message Received&quot;</span>, + e.<span class="property">data</span>);</span><br><span class="line"><span class="comment">// e.data即ArrayBuffer类型</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(e.<span class="property">data</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-3-3-Error">5.3.<strong>3 Error</strong></h4>
<p>如果发生意外的失败会触发error事件，相应的函数称为onerror,错误会导致连接关闭。如果你收到一个错误事件，那么你很快会收到一个关闭事件，在关闭事件中也许会告诉你错误的原因。而对错误事件的处理比较适合做重连的逻辑。</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//异常处理</span></span><br><span class="line">ws.onerror = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;WebSocket Error: &quot;</span> , e);</span><br><span class="line"><span class="comment">//Custom function for handling errors</span></span><br><span class="line">handleErrors(e);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-3-4-Close"><strong>5.3.4 Close</strong></h4>
<p>不言而喻，当连接关闭的时候回触发这个事件，对应onclose方法，连接关闭之后，服务端和客户端就不能再收发消息。</p>
<p>WebSocket的规范其实还定义了ping和pong 架构（frames），可以用来做keep-alive，心跳，网络状态查询，latency instrumentation（延迟仪表？），但是目前 WebSocket API还没有公布这些特性，尽管浏览器支持了ping，但不会触发ping事件，相反，浏览器会自动响应pong，第八章会将更多关于ping和pong的细节。</p>
<p>当然你可以调用close方法断开与服务端的链接来触发onclose事件：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws.onclose = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;Connection closed&quot;</span>, e);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>连接失败和成功的关闭握手都会触发关闭事件，WebSocket的对象的readyState属性就代表连接的状态（2代表正在关闭，3代表已经关闭）。关闭事件有三个属性可以用来做异常处理和重获： wasClean,code和reason。wasClean是一个bool值，代表连接是否干净的关闭。 如果是响应服务端的close事件，这个值为true，如果是别的原因，比如因为是底层TCP连接关闭，wasClean为false。code和reason代表关闭连接时服务端发送的状态，这两个属性和给入close方法的code和reason参数是对应的，稍后会描述细节。</p>
<h3 id="5-4-WebSocket-方法">5.4 WebSocket 方法</h3>
<p><strong>WebSocket 对象有两个方法：send()和close()。</strong></p>
<h4 id="5-4-1-send">5.4.1 send()</h4>
<p>一旦在服务端和客户端建立了全双工的双向连接，可以使用send方法去发送消息。</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送一个文本消息</span></span><br><span class="line">ws.send(<span class="string">&quot;Hello WebSocket!&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>当连接是open的时候send()方法传送数据，当连接关闭或获取不到的时候回抛出异常。一个通常的错误是人们喜欢在连接open之前发送消息。如下所示：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这将不会工作</span></span><br><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> <span class="type">WebSocket</span>(<span class="string">&quot;ws://echo.websocket.org&quot;</span>)</span><br><span class="line">ws.send(<span class="string">&quot;Initial data&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>正确的姿势如下，应该等待open事件触发后再发送消息。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var <span class="keyword">ws</span> = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://echo.websocket.org&quot;</span>)</span><br><span class="line"><span class="keyword">ws</span>.onopen = <span class="keyword">function</span>(<span class="keyword">e</span>) &#123;</span><br><span class="line"><span class="keyword">ws</span>.s</span><br></pre></td></tr></table></figure>
<p>如果想通过响应别的事件去发送消息，可以检查readyState属性的值为open的时候来实现。</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function <span class="built_in">myEventHandler</span>(data) &#123;</span><br><span class="line">if (ws.readyState === WebSocket.OPEN) &#123;</span><br><span class="line"><span class="comment">//open的时候即可发送</span></span><br><span class="line">ws<span class="selector-class">.send</span>(data);</span><br><span class="line">&#125; else &#123;</span><br><span class="line"><span class="comment">// Do something else in this case.</span></span><br><span class="line"><span class="comment">//Possibly ignore the data or enqueue it.</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发送二进制数据：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Send a Blob</span></span><br><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="type">Blob</span>(<span class="string">&quot;blob contents&quot;</span>);</span><br><span class="line">ws.send(blob);</span><br><span class="line"><span class="comment">// Send an ArrayBuffer</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="type">Uint8Array</span>([<span class="number">8</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">9</span>]);</span><br><span class="line">ws.send(a.buffer);</span><br></pre></td></tr></table></figure>
<p>Blob对象和JavaScript File API一起使用的时候相当有用，可以发送或接受文件，大部分的多媒体文件，图像，视频和音频文件。这一章末尾会结合File API提供读取文件内容来发送WebSocket消息的实例代码。</p>
<h4 id="5-4-2-close"><strong>5.4.2 close()</strong></h4>
<p>使用close方法来关闭连接，如果连接以及关闭，这方法将什么也不做。调用close方法只后，将不能发送数据。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ws.close()<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>close方法可以传入两个可选的参数，code（numerical）和reason（string）,以告诉服务端为什么终止连接。第三章讲到关闭握手的时候再详细讨论这两个参数。</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 成功结束会话</span></span><br><span class="line">ws.<span class="keyword">close</span>(<span class="number">1000</span>, <span class="string">&quot;Closing normally&quot;</span>)<span class="comment">;</span></span><br><span class="line"><span class="comment">//1000是状态码，代表正常结束。</span></span><br></pre></td></tr></table></figure>
<h3 id="5-5-WebSocket-属性">5.5 WebSocket 属性</h3>
<p>WebSocket对象有三个属性，readyState，bufferedAmount和Protocol。</p>
<h4 id="5-5-1-readyState"><strong>5.5.1 readyState</strong></h4>
<p>WebSocket对象通过只读属性readyState来传达连接状态，它会更加连接状态自动改变。下表展示了readyState属性的四个不同的值。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102337677.png" alt="image-20240618102337677"></p>
<p>了解当前连接的状态有助于我们调试。</p>
<h4 id="5-5-2-bufferedAmount"><strong>5.5.2 bufferedAmount</strong></h4>
<p>有时候需要检查传输数据的大小，尤其是客户端传输大量数据的时候。虽然send()方法会马上执行，但数据并不是马上传输。浏览器会缓存应用流出的数据，你可以使用bufferedAmount属性检查已经进入队列但还未被传输的数据大小。这个值不包含协议框架、操作系统缓存和网络软件的开销。</p>
<p>下面这个例子展示了如何使用bufferedAmount属性每秒更新发送。如果网络不能处理这个频率，它会自适应。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10k</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">THRESHOLD</span> = <span class="number">10240</span>;</span><br><span class="line"><span class="comment">//建立连接</span></span><br><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://echo.websocket.org&quot;</span>);</span><br><span class="line"><span class="comment">// Listen for the opening event</span></span><br><span class="line">ws.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"><span class="built_in">setInterval</span>( <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">//缓存未满的时候发送</span></span><br><span class="line"><span class="keyword">if</span> (ws.<span class="property">bufferedAmount</span> &lt; <span class="variable constant_">THRESHOLD</span>) &#123;</span><br><span class="line">ws.<span class="title function_">send</span>(<span class="title function_">getApplicationState</span>());</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//使用bufferedAmount属性发送数据可以避免网络饱和。</span></span><br></pre></td></tr></table></figure>
<h4 id="5-5-3-protocol"><strong>5.5.3 protocol</strong></h4>
<p>在构造函数中，protocol参数让服务端知道客户端使用的WebSocket协议。而WebSocket对象的这个属性就是指的最终服务端确定下来的协议名称，当服务端没有选择客户端提供的协议或者在连接握手结束之前，这个属性都是空的。</p>
<p>完整实例：</p>
<p>现在我们已经过了一遍WebSocket的构造函数、事件、属性和方法，接下来通过一个完整的实例来学习WebSocket API。实例使用“Echo”服务器：ws://<a href="https://link.zhihu.com/?target=http%3A//echo.websocket.org">http://echo.websocket.org</a>，它能够接受和返回发过去的数据。这样有助于理解WebSocket API是如何和服务器交互的。</p>
<p>首先，我们先建立连接，让页面展示客户端连接服务端的信息，然后发送、接受消息，最后关闭连接。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Websocket Echo Client<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;output&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化连接和事件</span></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">            output = document.getElementById(<span class="string">&quot;output&quot;</span>);</span><br><span class="line">            ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://echo.websocket.org/echo&quot;</span>);</span><br><span class="line">            <span class="comment">// 监听open</span></span><br><span class="line">            ws.onopen = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">                <span class="built_in">log</span>(<span class="string">&quot;Connected&quot;</span>);</span><br><span class="line">                sendMessage(<span class="string">&quot;Hello WebSocket!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 监听close</span></span><br><span class="line">            ws.onclose = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">                <span class="built_in">log</span>(<span class="string">&quot;Disconnected: &quot;</span> + e.reason);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//监听errors</span></span><br><span class="line">            ws.onerror = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">                <span class="built_in">log</span>(<span class="string">&quot;Error &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 监听 messages </span></span><br><span class="line">            ws.onmessage = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">                <span class="built_in">log</span>(<span class="string">&quot;Message received: &quot;</span> + e.data);</span><br><span class="line">                <span class="comment">//收到消息后关闭</span></span><br><span class="line">                ws.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">sendMessage</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">            ws.send(msg);</span><br><span class="line">            <span class="built_in">log</span>(<span class="string">&quot;Message sent&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// logging</span></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">log</span>(<span class="params">s</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> p = document.createElement(<span class="string">&quot;p&quot;</span>);</span><br><span class="line">            p.style.wordWrap = <span class="string">&quot;break-word&quot;</span>;</span><br><span class="line">            p.textContent = s;</span><br><span class="line">            output.appendChild(p);</span><br><span class="line">            <span class="comment">// Also log information on the javascript console</span></span><br><span class="line">            <span class="built_in">console</span>.<span class="built_in">log</span>(s);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Start </span></span><br><span class="line">        setup();</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102346962.png" alt="image-20240618102346962"></p>
<p>判断浏览器是否支持：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (window.WebSocket)&#123;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;This browser supports WebSocket!&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;This browser does not support WebSocket.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102427323.png" alt="image-20240618102427323"></p>
<h2 id="6-WebSocket语言支持">6.WebSocket语言支持</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102445482.png" alt="image-20240618102445482"></p>
<ul>
<li>所有主流浏览器都支持RFC6455。但是具体的WebSocket版本有区别。</li>
<li>php jetty netty ruby Kaazing nginx python Tomcat Django erlang</li>
<li>WebSocket浏览器支持</li>
<li>WebSocket浏览器支持</li>
<li>netty .net等语言均可以用来实现支持WebSocket的服务器。</li>
<li>websocket api在浏览器端的广泛实现似乎只是一个时间问题了, 值得注意的是服务器端没有标准的api, 各个实现都有自己的一套api, 并且tcp也没有类似的提案, 所以使用websocket开发服务器端有一定的风险.可能会被锁定在某个平台上或者将来被迫升级。</li>
</ul>
<p>WebSocket是HTML5出的东西（协议），也就是说HTTP协议没有变化，或者说没关系，但HTTP是不支持持久连接的（长连接，循环连接的不算）。</p>
<ul>
<li>首先HTTP有1.1和1.0之说，也就是所谓的keep-alive，把多个HTTP请求合并为一个，但是Websocket其实是一个新协议，跟HTTP协议基本没有关系，只是为了兼容现有浏览器的握手规范而已，也就是说它是HTTP协议上的一种补充可以通过这样一张图理解：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102450054.png" alt="image-20240618102450054"></p>
<ul>
<li>有交集，但是并不是全部。另外Html5是指的一系列新的API，或- 者说新规范，新技术。Http协议本身只有1.0和1.1，而且跟Html本身没有直接关系。</li>
<li>通俗来说，你可以用HTTP 协议 传输非Html 数据 ，就是这样=。=</li>
<li>再简单来说， 层级不一样 。</li>
</ul>
<h2 id="7-WebSocket通信">7.WebSocket通信</h2>
<h3 id="7-1-连接握手">7.1 连接握手</h3>
<p>连接握手分为两个步骤：请求和应答。WebSocket利用了HTTP协议来建立连接，使用的是HTTP的协议升级机制。</p>
<h4 id="7-1-1-请求">7.1.1 请求</h4>
<p>一个标准的HTTP请求，格式如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102455041.png" alt="image-20240618102455041"></p>
<p>请求头的具体格式定义参见**<a href="https://link.zhihu.com/?target=https%3A//link.csdn.net/%3Ftarget%3Dhttps%3A//www.w3.org/Protocols/rfc2616/rfc2616-sec5.html">Request-Line格式</a>**。</p>
<p><strong>请求header中的字段解析:</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102500391.png" alt="image-20240618102500391"></p>
<p>协议升级机制</p>
<p>Origin</p>
<p>所有浏览器将会发送一个 Origin请求头。 你可以将这个请求头用于安全方面（检查是否是同一个域，白名单/ 黑名单等），如果你不喜欢这个请求发起源，你可以发送一个403 Forbidden。需要注意的是非浏览器只能发送一个模拟的 Origin。大多数应用会拒绝不含这个请求头的请求。</p>
<p>Sec-WebSocket-Key</p>
<p>由客户端随机生成的，提供基本的防护，防止恶意或者无意的连接。</p>
<h4 id="7-1-2-应答">7.1.2 应答</h4>
<p><strong>返回字段解析：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102505962.png" alt="image-20240618102505962"></p>
<p>Connection</p>
<p>可以参见 rfc7230 6.1 和 rfc7230 6.7。</p>
<p>Sec-WebSocket-Accept</p>
<p>它通过客户端发送的Sec-WebSocket-Key 计算出来。计算方法：</p>
<p>将 Sec-WebSocket-Key 跟 258EAFA5-E914-47DA-95CA-C5AB0DC85B11 拼接；</p>
<p>通过 SHA1 计算出摘要，并转成 base64 字符串。</p>
<p>Sec-WebSocket-Key / Sec-WebSocket-Accept 的主要作用还是为了避免一些网络通信过程中，一些非期待的数据包，”乱入“进来，导致一些错误的响应，并不能用于实现登录认证和数据安全，这些功能还需要应用层自己实现。</p>
<h3 id="7-2-数据传输（双工）">7.2 数据传输（双工）</h3>
<p>WebSocket 以 frame 为单位传输数据, frame 是客户端和服务端数据传输的最小单元。当一条消息过长时, 通信方可以将该消息拆分成多个 frame 发送, 接收方收到以后重新拼接、解码从而还原出完整的消息, 在 WebSocket 中, frame 有多种类型, frame 的类型由 frame 头部的 Opcode 字段指示, WebSocket frame 的结构如下所示:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102511307.png" alt="image-20240618102511307"></p>
<p>该结构的字段语义如下:</p>
<p>FIN, 长度为 1 比特, 该标志位用于指示当前的 frame 是消息的最后一个分段, 因为 WebSocket 支持将长消息切分为若干个 frame 发送, 切分以后, 除了最后一个 frame, 前面的 frame 的 FIN 字段都为 0, 最后一个 frame 的 FIN 字段为 1, 当然, 若消息没有分段, 那么一个 frame 便包含了完成的消息, 此时其 FIN 字段值为 1。</p>
<p>RSV 1 ~ 3, 这三个字段为保留字段, 只有在 WebSocket 扩展时用, 若不启用扩展, 则该三个字段应置为 1, 若接收方收到 RSV 1 ~ 3 不全为 0 的 frame, 并且双方没有协商使用 WebSocket 协议扩展, 则接收方应立即终止 WebSocket 连接。</p>
<p>Opcode, 长度为 4 比特, 该字段将指示 frame 的类型, RFC 6455 定义的 Opcode 共有如下几种:</p>
<ul>
<li>0x0, 代表当前是一个 continuation frame，既被切分的长消息的每个分片frame</li>
<li>0x1, 代表当前是一个 text frame</li>
<li>0x2, 代表当前是一个 binary frame</li>
<li>0x3 ~ 7, 目前保留, 以后将用作更多的非控制类 frame</li>
<li>0x8, 代表当前是一个 connection close, 用于关闭 WebSocket 连接</li>
<li>0x9, 代表当前是一个 ping frame</li>
<li>0xA, 代表当前是一个 pong frame</li>
<li>0xB ~ F, 目前保留, 以后将用作更多的控制类 frame</li>
</ul>
<ol>
<li>Mask, 长度为 1 比特, 该字段是一个标志位, 用于指示 frame 的数据 (Payload) 是否使用掩码掩盖, RFC 6455 规定当且仅当由客户端向服务端发送的 frame, 需要使用掩码覆盖, 掩码覆盖主要为了解决代理缓存污染攻击 (更多细节见 RFC 6455 Section 10.3)。</li>
<li>Payload Len, 以字节为单位指示 frame Payload 的长度, 该字段的长度可变, 可能为 7 比特, 也可能为 7 + 16 比特, 也可能为 7 + 64 比特. 具体来说, 当 Payload 的实际长度在 [0, 125] 时, 则 Payload Len 字段的长度为 7 比特, 它的值直接代表了 Payload 的实际长度; 当 Payload 的实际长度为 126 时, 则 Payload Len 后跟随的 16 位将被解释为 16-bit 的无符号整数, 该整数的值指示 Payload 的实际长度; 当 Payload 的实际长度为 127 时, 其后的 64 比特将被解释为 64-bit 的无符号整数, 该整数的值指示 Payload 的实际长度。</li>
<li>Masking-key, 该字段为可选字段, 当 Mask 标志位为 1 时, 代表这是一个掩码覆盖的 frame, 此时 Masking-key 字段存在, 其长度为 32 位, RFC 6455 规定所有由客户端发往服务端的 frame 都必须使用掩码覆盖, 即对于所有由客户端发往服务端的 frame, 该字段都必须存在, 该字段的值是由客户端使用熵值足够大的随机数发生器生成, 关于掩码覆盖, 将下面讨论, 若 Mask 标识位 0, 则 frame 中将设置该字段 (注意是不设置该字段, 而不仅仅是不给该字段赋值)。</li>
<li>Payload, 该字段的长度是任意的, 该字段即为 frame 的数据部分, 若通信双方协商使用了 WebSocket 扩展, 则该扩展数据 (Extension data) 也将存放在此处, 扩展数据 + 应用数据, 它们的长度和便为 Payload Len 字段指示的值。</li>
</ol>
<p>以下是一个客户端和服务端相互传递文本消息的示例</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102516687.png" alt="image-20240618102516687"></p>
<p><strong>其中模拟了长消息被切分为多个帧（continuation frame）的例子。</strong></p>
<h3 id="7-3-关闭请求">7.3 关闭请求</h3>
<p><strong>关闭相对简单，由客户端或服务端发送关闭帧，即可完成关闭。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102521173.png" alt="image-20240618102521173"></p>
<h2 id="8-WebSocket协议进一步理解">8.WebSocket协议进一步理解</h2>
<p>WebSocket是一种在单个TCP连接上进行全双工通信的协议。WebSocket通信协议于2011年被IETF定为标准RFC 6455，并由RFC7936补充规范。WebSocket API也被W3C定为标准。</p>
<h3 id="8-1-WebSocket是什么"><strong>8.1 WebSocket是什么</strong></h3>
<p>WebSocket 协议在2008年诞生，2011年成为国际标准。主流浏览器都已经支持。</p>
<p>WebSocket 是一种全新的协议。它将 TCP 的 Socket（套接字）应用在了网页上，从而使通信双方建立起一个保持在活动状态连接通道，并且属于全双工通信。</p>
<p>WebSocket 协议在2008年诞生，2011年成为国际标准。主流浏览器都已经支持。WebSocket 协议借用 HTTP协议 的 101 switch protocol 来达到协议转换，从HTTP协议切换WebSocket通信协议。它的最大特点就是，服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话。</p>
<h3 id="8-2-WebSocket出现之前的实时技术">8.2 WebSocket出现之前的实时技术</h3>
<p>轮询：最早的一种实现实时 Web 应用的方案。客户端以一定的时间间隔向服务端发出请求，以频繁请求的方式来保持客户端和服务器端的通信。</p>
<p>长轮询：长轮询也采用轮询的方式，不过采取的是阻塞模型，客户端发起连接后，如果没消息，就一直不返回Response给客户端。直到有消息才返回，返回完之后，客户端再次建立连接，周而复始。</p>
<p>其他方式：如xhr-streaming、隐藏iframe、ActiveX控件、SSE。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102526317.png" alt="image-20240618102526317"></p>
<p>轮询技术非真正实时技术。使用 Ajax 方式模拟实时效果，每次客户端和服务器端交互，都是一次 HTTP 的请求和应答过程，且每次的 HTTP 请求和应答都带有完整 HTTP 头信息，增加传输的数据量。需构建两个http连接。客户端和服务器端编程实现比较复杂，为模拟真实的实时效果，需构造两个 HTTP 连接来模拟客户端和服务器的双向通信，一个连接用来处理客户端到服务器端的数据传输，一个连接用来处理服务器端到客户端的数据传输，增加了编程实现的复杂度、服务器端的负载，制约了应用系统的扩展性。</p>
<h3 id="8-3-WebSocket应用场景">8.3 WebSocket应用场景</h3>
<p>BS架构下的即时通讯、游戏等应用需要客户端与服务端间的双向通信，而HTTP的请求/响应模型并不适合这种场景。会存在一定的问题：</p>
<ul>
<li>服务器端被迫提供两类接口，一类提供给客户端轮询新消息，一类提供给客户端推送消息给服务器端。</li>
<li>HTTP协议有较多的额外开销，每次发送消息都会有一个HTTP header信息，而且如果不用Keep-Alive每次还都要握手。</li>
<li>客户端的脚本比如JS可能还需要跟踪整个过程，发送一个消息后，我可能需要跟踪这个消息的返回。</li>
</ul>
<p>Websocket出现使得浏览器提供socket的支持成为可能，从而在浏览器和服务器之间建立一条基于tcp的双向连接通道，web开发人员可以很方便的利用websocket构建实时web应用。<strong>WebSocket适用于以下场景:</strong></p>
<ul>
<li>在线聊天场景：例如qq聊天、淘宝与客服聊天、在线客服等等。这种场景都是需要实时的接收服务器推送的内容。</li>
<li>协同办公：例如腾讯在线文档，腾讯的在线文档是支持多人编辑的，在excel中，一旦有人修改就要立即同步给所有人。</li>
<li>直播弹幕：例如虎牙、斗鱼等各大直播平台，在直播时都是有弹幕的，遇到一些精彩片段时，往往会有弹幕刷屏。在这种情况下使用WebSocket会有一个更好的用户体验。</li>
<li>位置共享：例如微信里位置共享，这种场景需要用户实时的共享自己的位置给服务器，服务器收到位置信息后，要实时的推送给其它共享者的，实时性要求较高；百度地图导航系统，在自己位置到达某个地方之后，语音会立即播报前面道路情况，比如上高架、下地道、拐弯、直行、学校慢行等等。这种场景实时性特别高，汽车速度很快，延迟1秒钟，可能就错过了最佳提醒时机。</li>
<li>其他通过定义WebSocket子协议的扩展支持：例如sip、mqtt、xmpp、stomp等。</li>
</ul>
<h3 id="8-4-WebSocket协议栈">8.4 WebSocket协议栈</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102531782.png" alt="image-20240618102531782"></p>
<p>**WebSocket是基于TCP的应用层协议。**需要特别注意的是：虽然WebSocket协议在建立连接时会使用HTTP协议，但这并意味着WebSocket协议是基于HTTP协议实现的。</p>
<h3 id="8-5-WebSocket与HTTP的区别">8.5 WebSocket与HTTP的区别</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102537661.png" alt="image-20240618102537661"></p>
<ul>
<li>通信方式不同。WebSocket是双向通信模式，客户端与服务器之间只有在握手阶段是使用HTTP协议的“请求-响应”模式交互，而一旦连接建立之后的通信则使用双向模式交互，不论是客户端还是服务端都可以随时将数据发送给对方；而HTTP协议则至始至终都采用“请求-响应”模式进行通信。也正因为如此，HTTP协议的通信效率没有WebSocket高。</li>
<li>协议格式不同。HTTP协议的一个数据包就是一条完整的消息；而WebSocket客户端与服务端通信的最小单位是帧，由1个或多个帧组成一条完整的消息。即：发送端将消息切割成多个帧，并发送给服务端；服务端接收消息帧，并将关联的帧重新组装成完整的消息。</li>
</ul>
<h3 id="8-6-WebSocket握手过程">8.6 WebSocket握手过程</h3>
<p><strong>客户端到服务端:</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102545826.png" alt="image-20240618102545826"></p>
<ul>
<li>GET ws://localhost…… HTTP/1.1 ：打开阶段握手，使用http1.1协议。</li>
<li>Upgrade：websocket，表示请求为特殊http请求，请求的目的是要将客户端和服务端的通信协议从http升级为websocket。</li>
<li>Sec-websocket-key：Base64 encode 的值，是浏览器随机生成的。客户端向服务端提供的握手信息。</li>
</ul>
<p><strong>服务端到客户端:</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102551698.png" alt="image-20240618102551698"></p>
<ul>
<li>101状态码：表示切换协议。服务器根据客户端的请求切换到Websocket协议。</li>
<li>Sec-websocket-accept: 将请求头中的Set-websocket-key添加字符串并做SHA-1加密后做Base64编码，告知客户端服务器能够发起websocket连接。</li>
</ul>
<p><strong>客户端发起连接的约定:</strong></p>
<ul>
<li>如果请求为wss,则在TCP建立后，进行TLS连接建立。</li>
<li>请求的方式必须为GET，HTTP版本至少为HTTP1.1。</li>
<li>请求头中必须有Host。</li>
<li>请求头中必须有Upgrade，取值必须为websocket。</li>
<li>请求头中必须有Connection，取值必须为Upgrade。</li>
<li>请求头中必须有Sec-WebSocket-Key，取值为16字节随机数的Base64编码。</li>
<li>请求头中必须有Sec-WebSocket-Version，取值为13。</li>
<li>请求头中可选Sec-WebSocket-Protocol，取值为客户端期望的一个或多个子协议(多个以逗号分割)。</li>
<li>请求头中可选Sec-WebSocket-Extensitons，取值为子协议支持的扩展集(一般是压缩方式)。</li>
<li>可以包含cookie、Authorization等HTTP规范内合法的请求头。</li>
</ul>
<p><strong>客户端检查服务端的响应:</strong></p>
<ul>
<li>服务端返回状态码为101代表升级成功，否则判定连接失败。</li>
<li>响应头中缺少Upgrade或取值不是websocket，判定连接失败。</li>
<li>响应头中缺少Connection或取值不是Upgrade，判定连接失败。</li>
<li>响应头中缺少Sec-WebSocket-Accept或取值非法（其值为请求头中的Set-websocket-key添加字符串并做SHA-1加密后做Base64编码），判定连接失败。</li>
<li>响应头中有Sec-WebSocket-Extensions,但取值不是请求头中的子集，判定连接失败。</li>
<li>响应头中有Sec-WebSocket-Protocol,但取值不是请求头中的子集，判定连接失败。</li>
</ul>
<p><strong>服务端处理客户端连接:</strong></p>
<ul>
<li>服务端根据请求中的Sec-WebSocket-Protocol 字段，选择一个子协议返回，如果不返回，表示不同意请求的任何子协议。如果请求中未携带，也不返回。</li>
<li>如果建立连接成功，返回状态码为101。</li>
<li>响应头Connection设置为Upgrade。</li>
<li>响应头Upgrade设置为websocket。</li>
<li>Sec-WebSocket-Accpet根据请求头Set-websocket-key计算得到，计算方式为：Set-websocket-key的值添加字符串： 258EAFA5-E914-47DA-95CA-C5AB0DC85B11并做SHA-1加密后得到16进制表示的字符串，将每两位当作一个字节进行分隔，得到字节数组，对字节数组做Base64编码。</li>
</ul>
<h3 id="8-7-WebSocket帧格式">8.7 WebSocket帧格式</h3>
<p><strong>WebSocket通信流程如下:</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102600446.png" alt="image-20240618102600446"></p>
<p><strong>Websocket帧格式如下:</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102605562.png" alt="image-20240618102605562"></p>
<p><strong>第一部分:</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102609366.png" alt="image-20240618102609366"></p>
<p>FIN：1位，用于描述消息是否结束，如果为1则该消息为消息尾部，如果为零则还有后续数据包。</p>
<p>RSV1,RSV2,RSV3：各1位，用于扩展定义，如果没有扩展约定的情况则必须为0。</p>
<p>OPCODE：4位，用于表示消息接收类型，如果接收到未知的opcode，接收端必须关闭连接。</p>
<p>OPCODE说明:</p>
<ul>
<li>0x0表示附加数据帧，当前数据帧为分片的数据帧。</li>
<li>0x1表示文本数据帧，采用UTF-8编码。</li>
<li>0x2表示二进制数据帧。</li>
<li>0x3-7暂时无定义，为以后的非控制帧保留。</li>
<li>0x8表示连接关闭。</li>
<li>0x9表示ping。</li>
<li>0xA表示pong。</li>
<li>0xB-F暂时无定义，为以后的控制帧保留。</li>
</ul>
<p><strong>第二部分:</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102614081.png" alt="image-20240618102614081"></p>
<ul>
<li>MASK：1位，用于标识PayloadData是否经过掩码处理。服务端发送给客户端的数据帧不能使用掩码，客户端发送给服务端的数据帧必须使用掩码。如果一个帧的数据使用了掩码，那么在Maksing-key部分必须是一个32个bit位的掩码，用来给服务端解码数据。</li>
<li>Payload len：数据的长度：默认位7个bit位。如果数据的长度小于125个字节（注意：是字节）则用默认的7个bit来标示数据的长度。如果数据的长度为126个字节，则用后面相邻的2个字节来保存一个16bit位的无符号整数作为数据的长度。如果数据的长度大于126个字节，则用后面相邻的8个字节来保存一个64bit位的无符号整数作为数据的长度。</li>
<li>payload len本来是只能用7bit来表达的，也就是最多一个frame的payload只能有127个字节，为了表示更大的长度，给出的解决方案是添加扩展payload len字段。当payload实际长度超过126（包括），但在2^16-1长度内，则将payload len置为126，payload的实际长度由长为16bit的extended payload length来表达。当payload实际长度超过216（包括），但在264-1长度内，则将payload置为127，payload的实际长度由长为64bit的extended payload length来表达。</li>
</ul>
<p><strong>第三部分:</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102620063.png" alt="img"></p>
<p>数据掩码：如果MASK设置位0，则该部分可以省略，如果MASK设置位1，则Masking-key是一个32位的掩码。用来解码客户端发送给服务端的数据帧。</p>
<p><strong>第四部分:</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102625050.png" alt="image-20240618102625050"></p>
<p>数据：该部分，也是最后一部分，是帧真正要发送的数据，可以是任意长度。</p>
<h3 id="8-8-WebSocket分片传输">8.8 WebSocket分片传输</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102630470.png" alt="image-20240618102630470"></p>
<p>控制帧可能插在一个Message的多个分片之间，但一个Message的分片不能交替传输(除非有扩展特别定义)。</p>
<p>控制帧不可分片。</p>
<p>分片需要按照分送方提交顺序传递给接收方，但由于IP路由特性，实际并不能保证顺序到达。</p>
<p>控制帧包括:</p>
<ul>
<li>Close：用于关闭连接，可以携带数据，表示关闭原因。</li>
<li>Ping：可以携带数据。</li>
<li>Pong：用于Keep-alive，返回最近一次Ping中的数据，可以只发送Pong帧，做单向心跳。</li>
</ul>
<p>连接关闭时状态码说明:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102638253.png" alt="image-20240618102638253"></p>
<h3 id="8-9-WebSocket相关扩展">8.9 WebSocket相关扩展</h3>
<p>Stomp：</p>
<p>STOMP是基于帧的协议，它的前身是TTMP协议（一个简单的基于文本的协议），专为消息中间件设计。是属于消息队列的一种协议, 和AMQP, JMS平级。它的简单性恰巧可以用于定义websocket的消息体格式. STOMP协议很多MQ都已支持, 比如RabbitMq, ActiveMq。生产者（发送消息）、消息代理、消费者（订阅然后收到消息）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102644517.png" alt="image-20240618102644517"></p>
<p>\2. SockJs：</p>
<p>SockJS是一个浏览器JavaScript库，它提供了一个类似于网络的对象。SockJS提供了一个连贯的、跨浏览器的Javascript API，它在浏览器和web服务器之间创建了一个低延迟、全双工、跨域通信通道。</p>
<p>SockJS的一大好处在于提供了浏览器兼容性。优先使用原生WebSocket，如果在不支持websocket的浏览器中，会自动降为轮询的方式。 除此之外，spring也对socketJS提供了支持。</p>
<p>\3. <a href="https://link.zhihu.com/?target=http%3A//Socket.io">Socket.io</a>：</p>
<p><a href="https://link.zhihu.com/?target=http%3A//Socket.io">http://Socket.io</a>实际上是WebSocket的父集，<a href="https://link.zhihu.com/?target=http%3A//Socket.io">http://Socket.io</a>封装了WebSocket和轮询等方法，会根据情况选择方法来进行通讯。</p>
<p><a href="https://link.zhihu.com/?target=http%3A//Sockei.io">http://Sockei.io</a>最早由Node.js实现，Node.js提供了高效的服务端运行环境，但由于Browser对HTML5的支持不一，为了兼容所有浏览器，提供实时的用户体验，并为开发者提供客户端与服务端一致的编程体验，于是<a href="https://link.zhihu.com/?target=http%3A//Socket.io">http://Socket.io</a>诞生了。Java模仿Node.js实现了Java版的<a href="https://link.zhihu.com/?target=http%3A//Netty-socket.io">http://Netty-socket.io</a>库。</p>
<p><a href="https://link.zhihu.com/?target=http%3A//Socket.io">http://Socket.io</a>将WebSocket和Polling机制以及其它的实时通信方式封装成通用的接口，并在服务端实现了这些实时机制相应代码，包括：AJAX Long Polling、Adobe Flash Socket、AJAX multipart streaming、Forever Iframem、JSONP Polling。</p>
<h2 id="9-WebSocket-能解决什么问题">9.WebSocket 能解决什么问题</h2>
<p>工程师应该是以解决问题为主的，如果不会解决问题，只会伸手，必然不会长远，有思考，才会有突破，才能高效的处理事情，所以 websocket 到底解决了什么问题呢？它存在的价值是什么？</p>
<p>这还是得从HTTP说起，大家应该都很熟悉这门协议，我们简单说一下它的特点：</p>
<p>•三次握手、四次挥手 的方式建立连接和关闭连接</p>
<p>•支持长连接和短连接两种连接方式</p>
<p>•有同源策略的限制（端口，协议，域名）</p>
<p>•单次 请求-响应 机制，只支持单向通信</p>
<p>其中最鸡肋的就是最后一个特点，单向通信，什么意思呐？ 就是说只能由一方发起请求（客户端），另一方响应请求（服务端），而且每一次的请求都是一个单独的事件，请求之间还无法具有关联性，也就是说我上个请求和下个请求完全是隔离的，无法具有连续性。</p>
<p>也许你觉得这样的说法比较难懂，我们来举一个栗子：</p>
<p>每个人都打过电话吧，电话打通后可以一直聊天是不是觉得很舒服啊，这是一种全双工的通信方式，双方都可以主动传递信息。彼此的聊天也具有连续性。我们简单把这种方式理解为 websocket 协议支持的方式。</p>
<p>如果打电话变成了 HTTP 那种方式呢？ 那就不叫打电话了，而是联通爸爸的智能语音助手了，我们知道客户端和服务端本身的身份并不是固定的，只要你可以发起通信，就可以充当客户端，能响应请求，就可以当做服务端，但是在HTTP的世界里一般来说，客户端（大多数情况下是浏览器）和服务器一般是固定的，我们打电话 去查话费，会询问要人工服务还是智能助手，如果选了助手，你只要问她问题，她就会找对应的答案来回答你（响应你），一般都是简单的业务，你不问她也不会跟你闲聊，主动才有故事啊！</p>
<p>但是实际上有很多的业务是需要双方都有主动性的，半双工的模式肯定是不够用的，例如聊天室，跟机器人聊天没意思啊，又例如主动推送，我无聊的时候手都不想点屏幕，你能不能主动一点给我推一些好玩的信息过来。</p>
<p>只要做过前后端分离的同学应该都被跨域的问题折磨过。浏览器的这种同源策略，会导致 不同端口/不同域名/不同协议 的请求会有限制，当然这问题前后端都能处理，然而 websocket 就没有这种要求，他支持任何域名或者端口的访问（协议固定了只能是 ws/wss) ,所以它让人用的更加舒服</p>
<p>所以，上面 HTTP 存在的这些问题，websocket 都能解决！！！</p>
<h2 id="10-WebSocket工作原理">10.WebSocket工作原理</h2>
<p>主动是 websocket 的一大特点，像之前如果客户端想知道服务端对某个事件的处理进度，就只能通过轮训( Poll )的方式去询问，十分的耗费资源，会存在十分多的无效请求。下面我简单说推送技术的三种模型区别：</p>
<ul>
<li>•pull (主动获取) 即客户端主动发起请求，获取消息</li>
<li>•poll (周期性主动获取) 即周期性的主动发起请求，获取消息</li>
<li>•push (主动推送) 服务端主动推送消息给客户端</li>
</ul>
<p>pull 和 poll 的唯一区别只在于周期性，但是很明显周期性的去询问，对业务来说清晰度很高，这也是为什么很多小公司都是基于轮训的方式去处理业务，因为简单嘛，能力不够机器来撑。这也是很多公司都会面临的问题，如果业务达到了瓶颈，使劲的堆机器，如果用新技术或者更高级的作法，开发成本和维护成本也会变高，还不如简单一点去增加机器配置。</p>
<p>如果两个人需要通话，首先需要建立一个连接，而且必须是一个长链接，大家都不希望讲几句话就得重新打吧，根据上面说的，websocket 会复用之前 HTTP 建立好的长链接，然后再进行升级，所以他和轮训的区别大致如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102652651.png" alt="image-20240618102652651"></p>
<p>图片省去了建立连接的过程，我们可以发现，基于轮训的方式，必须由客户端手动去请求，才会有响应，而基于 websocket 协议，不再需要你主动约妹子了，妹子也可以主动去约你，这才是公平的世界。</p>
<p>为了更好的阐述这个连接的原理，可以使用swoole 自带的 创建websocket 的功能进行测试，服务端代码如下，如果连接不上，可以看看是不是检查一下端口开放情况（iptables/filewall)和网络的连通性，代码如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>创建websocket服务器对象，监听<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9501</span>端口</span><br><span class="line"><span class="variable">$ws</span> = new Swoole\WebSocket\Server(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">9501</span>);</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>监听WebSocket连接打开事件</span><br><span class="line"><span class="variable">$ws</span>-&gt;on(<span class="string">&#x27;open&#x27;</span>, <span class="keyword">function</span> (<span class="variable">$ws</span>, <span class="variable">$request</span>) &#123;</span><br><span class="line">    var_dump(<span class="variable">$request</span>-&gt;fd, <span class="variable">$request</span>-&gt;get, <span class="variable">$request</span>-&gt;server); <span class="regexp">//</span>request 对象包含请求的相关信息</span><br><span class="line">    <span class="regexp">//</span><span class="variable">$ws</span>-&gt;push(<span class="variable">$request</span>-&gt;fd, <span class="string">&quot;hello, welcome\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>监听WebSocket消息事件</span><br><span class="line"><span class="variable">$ws</span>-&gt;on(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="variable">$ws</span>, <span class="variable">$frame</span>) &#123;  <span class="regexp">//</span> frame 是存储信息的变量，也就是传输帧</span><br><span class="line">    echo <span class="string">&quot;Message: &#123;$frame-&gt;data&#125;\n&quot;</span>;</span><br><span class="line">    <span class="variable">$ws</span>-&gt;push(<span class="variable">$frame</span>-&gt;fd, <span class="string">&quot;server: &#123;$frame-&gt;data&#125;&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>监听WebSocket连接关闭事件</span><br><span class="line"><span class="variable">$ws</span>-&gt;on(<span class="string">&#x27;close&#x27;</span>, <span class="keyword">function</span> (<span class="variable">$ws</span>, <span class="variable">$fd</span>) &#123; <span class="regexp">//</span> fd 是客户端的标志</span><br><span class="line">    echo <span class="string">&quot;client-&#123;$fd&#125; is closed\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable">$ws</span>-&gt;start(); <span class="regexp">//</span> 启动这个进程</span><br></pre></td></tr></table></figure>
<p>我们可以发现，相比于 HTTP 的头部，websocket 的数据结构十分的简单小巧，没有像 HTTP 协议一样老是带着笨重的头部，这一设计让websocket的报文可以在体量上更具优势，所以传输效率来说更高 。</p>
<p>当然，我们传输的文本也不能在大街上裸跑啊，既然 HTTP 都有衣服穿了（HTTPS），websocket（ws) 当然也有 （wss）。</p>
<p>在以前的文章我们也简单聊过 HTTPS 是个什么东西，大家不了解可以去翻一下之前的文章，总的来说就是使用了非对称加密算法进行了对称加密密钥的传输，后续采用对称加密解密的方式进行数据安全处理。</p>
<p>如果你的业务需要支撑双全工的通信，那么 websocket 便是一个很不错的选择。网上大多数关于 websocket 的文章，大多是基于前端学习者的角度，他们使用 Chrome 的console 的调试实验，本篇文章更多是基于后端开发者的角度。希望对你有所帮助。</p>
<h2 id="11-进一步解析什么是WebSocket协议">11.进一步解析什么是WebSocket协议</h2>
<h3 id="11-1websocket特点">11.1websocket特点</h3>
<p>1.websocket优点</p>
<ul>
<li>保持连接状态：websocket需要先创建连接，使其成为有状态的协议。</li>
<li>更好支持二进制：定义了二进制帧，增加安全性。</li>
<li>支持扩展：定义了扩展，可以自己实现部分部分自定义。</li>
<li>压缩效果好：可以沿用上下文的内容，有更好的压缩效果。</li>
</ul>
<p>2.websocket缺点</p>
<ul>
<li>开发要求高： 前端后端都增加了一定的难度。</li>
<li>推送消息相对复杂。</li>
<li>HTTP协议已经很成熟，现今websocket则太新了一点。</li>
</ul>
<h3 id="11-2websocket协议通信过程">11.2websocket协议通信过程</h3>
<p><strong>协议有两个部分：handshake（握手）和 data transfer（数据传输）。</strong></p>
<p>1.handshake</p>
<h4 id="11-2-1-客户端">11.2.1 客户端</h4>
<p>客户端握手报文是在HTTP的基础上发送一次HTTP协议升级请求。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>server.example.com</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span><span class="punctuation">: </span>dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span><span class="punctuation">: </span>chat, superchat</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br></pre></td></tr></table></figure>
<p>Sec-WebSocket-Key 是由浏览器随机生成的，提供基本的防护，防止恶意或者无意的连接。</p>
<p>Sec-WebSocket-Version 表示 WebSocket 的版本，最初 WebSocket 协议太多，不同厂商都有自己的协议版本，不过现在已经定下来了。如果服务端不支持该版本，需要返回一个 Sec-WebSocket-Versionheader，里面包含服务端支持的版本号。</p>
<h4 id="11-2-2-服务端">11.2.2 服务端</h4>
<p>服务端响应握手也是在HTTP协议基础上回应一个Switching Protocols。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Accept</span><span class="punctuation">: </span>s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span><span class="punctuation">: </span>chat</span><br></pre></td></tr></table></figure>
<p>Linux下对应实现代码，注释在代码中。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">websocket_handshake</span><span class="params">(<span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> linebuf[<span class="number">128</span>];</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> sec_data[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> sec_accept[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(linebuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(linebuf));<span class="comment">//清空以暂存一行报文</span></span><br><span class="line">        index = <span class="built_in">readline</span>(ev-&gt;buffer, index, linebuf);<span class="comment">//获取一行报文</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(linebuf, <span class="string">&quot;Sec-WebSocket-Key&quot;</span>))<span class="comment">//如果一行报文里面包括了Sec-WebSocket-Key</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">strcat</span>(linebuf, GUID);<span class="comment">//和GUID连接起来</span></span><br><span class="line">            <span class="built_in">SHA1</span>(linebuf+WEBSOCK_KEY_LENGTH, <span class="built_in">strlen</span>(linebuf+WEBSOCK_KEY_LENGTH), sec_data);<span class="comment">//SHA1</span></span><br><span class="line">            <span class="built_in">base64_encode</span>(sec_data, <span class="built_in">strlen</span>(sec_data), sec_accept);<span class="comment">//base64编码</span></span><br><span class="line">            <span class="built_in">memset</span>(ev-&gt;buffer, <span class="number">0</span>, MAX_BUFLEN);<span class="comment">//清空服务端数据缓冲区</span></span><br><span class="line"></span><br><span class="line">            ev-&gt;length = <span class="built_in">sprintf</span>(ev-&gt;buffer,<span class="comment">//组装握手响应报文到数据缓冲区，下一步有进行下发</span></span><br><span class="line">                                 <span class="string">&quot;HTTP/1.1 101 Switching Protocols\r\n&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Upgrade: websocket\r\n&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Connection: Upgrade\r\n&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Sec-websocket-Accept: %s\r\n\r\n&quot;</span>, sec_accept);</span><br><span class="line">            <span class="keyword">break</span>;   </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">while</span>(index != <span class="number">-1</span> &amp;&amp; (ev-&gt;buffer[index] != <span class="string">&#x27;\r&#x27;</span>) || (ev-&gt;buffer[index] != <span class="string">&#x27;\n&#x27;</span>));<span class="comment">//遇到空行之前</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11-2-3-data-transfer">11.2.3 data transfer</h4>
<p>先看数据包格式。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102700462.png" alt="image-20240618102700462"></p>
<p>FIN：指示这是消息中的最后一个片段。第一个片段也可能是最后的片段。</p>
<p>RSV1, RSV2, RSV3：一般情况下全为 0。当客户端、服务端协商采用 WebSocket 扩展时，这三个标志位可以非0，且值的含义由扩展进行定义。如果出现非零的值，且并没有采用 WebSocket 扩展，连接出错。</p>
<p>opcode：操作代码。</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">%<span class="selector-tag">x0</span></span>：表示一个延续帧。当 Opcode 为 0 时，表示本次数据传输采用了数据分片，当前收到的数据帧为其中一个数据分片；</span><br><span class="line"><span class="tag">%<span class="selector-tag">x1</span></span>：表示这是一个文本帧（frame）；</span><br><span class="line"><span class="tag">%<span class="selector-tag">x2</span></span>：表示这是一个二进制帧（frame）；</span><br><span class="line"><span class="tag">%<span class="selector-tag">x3</span></span>-7：保留的操作代码，用于后续定义的非控制帧；</span><br><span class="line"><span class="tag">%<span class="selector-tag">x8</span></span>：表示连接断开；</span><br><span class="line"><span class="tag">%<span class="selector-tag">x9</span></span>：表示这是一个 ping 操作；</span><br><span class="line"><span class="tag">%<span class="selector-tag">xA</span></span>：表示这是一个 pong 操作；</span><br><span class="line"><span class="tag">%<span class="selector-tag">xB</span></span>-F：保留的操作代码，用于后续定义的控制帧。</span><br></pre></td></tr></table></figure>
<ul>
<li>mask：是否需要掩码。</li>
<li>Payload length: 7bit or 7 + 16bit or 7 + 64bit</li>
</ul>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> 表示数据载荷的长度</span><br><span class="line"><span class="keyword">x</span> 为 <span class="number">0</span>~<span class="number">126</span>：数据的长度为 <span class="keyword">x</span> 字节；</span><br><span class="line"><span class="keyword">x</span> 为 <span class="number">126</span>：后续 <span class="number">2</span> 个字节代表一个 <span class="number">16</span> 位的无符号整数，该无符号整数的值为数据的长度；</span><br><span class="line"><span class="keyword">x</span> 为 <span class="number">127</span>：后续 <span class="number">8</span> 个字节代表一个 <span class="number">64</span> 位的无符号整数（最高位为 <span class="number">0</span>），该无符号整数的值为数据的长度。</span><br></pre></td></tr></table></figure>
<p>payload data：消息体。 下面是服务端的代码实现：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GUID            <span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span></span></span><br><span class="line"><span class="keyword">enum</span>			</span><br><span class="line">&#123; </span><br><span class="line">    WS_HANDSHAKE = <span class="number">0</span>,		<span class="comment">//握手</span></span><br><span class="line">    WS_TANSMISSION = <span class="number">1</span>,		<span class="comment">//通信</span></span><br><span class="line">    WS_END = <span class="number">2</span>,				<span class="comment">//end</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_ws_ophdr</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> opcode:<span class="number">4</span>,</span><br><span class="line">    rsv3:<span class="number">1</span>,</span><br><span class="line">    rsv2:<span class="number">1</span>,</span><br><span class="line">    rsv1:<span class="number">1</span>,</span><br><span class="line">    fin:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> pl_len:<span class="number">7</span>,</span><br><span class="line">    mask:<span class="number">1</span>;</span><br><span class="line">&#125;ws_ophdr;<span class="comment">//协议前两个字节</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_ws_head_126</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> payload_lenght;</span><br><span class="line">    <span class="type">char</span> mask_key[<span class="number">4</span>];</span><br><span class="line">&#125;ws_head_126;<span class="comment">//协议mask和消息体长度</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*解码*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">websocket_umask</span><span class="params">(<span class="type">char</span> *payload, <span class="type">int</span> length, <span class="type">char</span> *mask_key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( ; i&lt;length; i++)</span><br><span class="line">    payload[i] ^= mask_key[i%<span class="number">4</span>];<span class="comment">//异或</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">websocket_transmission</span><span class="params">(<span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ws_ophdr *ophdr = (ws_ophdr*)ev-&gt;buffer;<span class="comment">//协议前两个自己</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ws_recv_data length=%d\n&quot;</span>, ophdr-&gt;pl_len);</span><br><span class="line">    <span class="keyword">if</span>(ophdr-&gt;pl_len &lt;<span class="number">126</span>)<span class="comment">//如果消息体长度小于126</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * payload = ev-&gt;buffer + <span class="built_in">sizeof</span>(ws_ophdr) + <span class="number">4</span>;<span class="comment">//获取消息地址</span></span><br><span class="line">        <span class="keyword">if</span>(ophdr-&gt;mask)<span class="comment">//如果消息是掩码</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">websocket_umask</span>(payload, ophdr-&gt;pl_len, ev-&gt;buffer+<span class="number">2</span>);<span class="comment">//解码，异或</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;payload:%s\n&quot;</span>, payload);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;payload : %s\n&quot;</span>, payload);<span class="comment">//消息回显</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (hdr-&gt;pl_len == <span class="number">126</span>) &#123;</span><br><span class="line">		ws_head_126 *hdr126 = ev-&gt;buffer + <span class="built_in">sizeof</span>(ws_ophdr);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ws_head_127 *hdr127 = ev-&gt;buffer + <span class="built_in">sizeof</span>(ws_ophdr);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">websocket_request</span><span class="params">(<span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ev-&gt;status_machine == WS_HANDSHAKE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">websocket_handshake</span>(ev);<span class="comment">//握手</span></span><br><span class="line">        ev-&gt;status_machine = WS_TANSMISSION;<span class="comment">//设置标志位</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ev-&gt;status_machine == WS_TANSMISSION)&#123;</span><br><span class="line">        <span class="built_in">websocket_transmission</span>(ev);<span class="comment">//通信</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>代码是基于reactor百万并发服务器框架实现的。</strong></p>
<h3 id="11-3-epoll反应堆模型下实现http协议">11.3.epoll反应堆模型下实现http协议</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://penge666blog.oss-cn-beijing.aliyuncs.com/img/image-20240618102724950.png" alt="image-20240618102724950"></p>
<p>1.客户端结构体</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd;				<span class="comment">//clientfd</span></span><br><span class="line">    <span class="type">int</span> events;			<span class="comment">//事件：读、写或异常</span></span><br><span class="line">    <span class="type">int</span> status;			<span class="comment">//是否位于epfd红黑监听树上</span></span><br><span class="line">    <span class="type">void</span> *arg;			<span class="comment">//参数</span></span><br><span class="line">    <span class="type">long</span> last_active;	<span class="comment">//上次数据收发的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> (*callback)(<span class="type">int</span> fd, <span class="type">int</span> event, <span class="type">void</span> *arg);	<span class="comment">//回调函数，单回调，后面修改成多回调</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buffer[MAX_BUFLEN];				<span class="comment">//数据缓冲区</span></span><br><span class="line">    <span class="type">int</span> length;										<span class="comment">//数据长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*http param*/</span></span><br><span class="line">    <span class="type">int</span> method;						<span class="comment">//http协议请求头部</span></span><br><span class="line">    <span class="type">char</span> resource[MAX_BUFLEN];		<span class="comment">//请求的资源</span></span><br><span class="line">    <span class="type">int</span> ret_code;					<span class="comment">//响应状态码</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><a href="https://link.zhihu.com/?target=http%3A//2.int">2.int</a> http_response(struct qsevent *ev)</p>
<p>当客户端发送tcp连接时，服务端的listenfd会触发输入事件会调用ev-&gt;callback即accept_cb回调函数响应连接并获得clientfd，连接之后，http数据报文发送上来，服务端的clientfd触发输入事件会调用ev-&gt;callback即recv_cb回调函数进行数据接收，并解析http报文。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">http_request</span><span class="params">(<span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> linebuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;<span class="comment">//用于从buffer中获取每一行的请求报文</span></span><br><span class="line">    <span class="type">int</span> idx = <span class="built_in">readline</span>(ev-&gt;buffer, <span class="number">0</span>, linebuf);<span class="comment">//读取第一行请求方法，readline函数，后面介绍</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strstr</span>(linebuf, <span class="string">&quot;GET&quot;</span>))<span class="comment">//strstr判断是否存在GET请求方法</span></span><br><span class="line">    &#123;</span><br><span class="line">        ev-&gt;method = HTTP_METHOD_GET;<span class="comment">//GET方法表示客户端需要获取资源</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(linebuf[<span class="built_in">sizeof</span>(<span class="string">&quot;GET &quot;</span>) + i] != <span class="string">&#x27; &#x27;</span>)i++;<span class="comment">//跳过空格</span></span><br><span class="line">        linebuf[<span class="built_in">sizeof</span>(<span class="string">&quot;GET &quot;</span>) + i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">sprintf</span>(ev-&gt;resource, <span class="string">&quot;./%s/%s&quot;</span>, HTTP_METHOD_ROOT, linebuf+<span class="built_in">sizeof</span>(<span class="string">&quot;GET &quot;</span>));<span class="comment">//将资源的名字以文件路径形式存储在ev-&gt;resource中</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;resource:%s\n&quot;</span>, ev-&gt;resource);<span class="comment">//回显</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strstr</span>(linebuf, <span class="string">&quot;POST&quot;</span>))<span class="comment">//POST的请求方法，暂时没写，方法差不多</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://link.zhihu.com/?target=http%3A//3.int">http://3.int</a> http_response(struct qsevent *ev)</p>
<p>服务器对客户端的响应报文数据进行http封装储存在buffer中，事件触发时在send_cb回调函数发送给客户端。详细解释请看代码注释。</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">int <span class="title function_">http_response</span>(<span class="params">struct</span> <span class="params">qsevent</span> *<span class="params">ev</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">ev</span> <span class="operator">==</span> <span class="variable">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="title function_">memset</span>(<span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">buffer</span>, <span class="number">0</span>, <span class="variable">MAX_BUFLEN</span>);<span class="comment">//清空缓冲区准备储存报文</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">printf</span>(<span class="string">&quot;resource:%s<span class="char escape_">\n</span>&quot;</span>, <span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">resource</span>);<span class="comment">//resource：客户端请求的资源文件，通过http_reques函数获取</span></span><br><span class="line">    int <span class="variable">filefd</span> <span class="operator">=</span> <span class="title function_">open</span>(<span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">resource</span>, <span class="variable">O_RDONLY</span>);<span class="comment">//只读方式打开获得文件句柄</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">filefd</span> <span class="operator">==</span> <span class="number">-1</span>)<span class="comment">//获取失败则发送404 NOT FOUND</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">ret_code</span> <span class="operator">=</span> <span class="number">404</span>;<span class="comment">//404状态码</span></span><br><span class="line">        <span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">length</span> <span class="operator">=</span> <span class="title function_">sprintf</span>(<span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">buffer</span>,<span class="comment">//将下面数据传入ev-&gt;buffer</span></span><br><span class="line">        					 <span class="comment">/***状态行***/</span></span><br><span class="line">        					 <span class="comment">/*版本号 状态码 状态码描述 */</span></span><br><span class="line">                             <span class="string">&quot;HTTP/1.1 404 NOT FOUND<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                             <span class="comment">/***消息报头***/</span></span><br><span class="line">                             <span class="comment">/*获取当前时间*/</span></span><br><span class="line">                             <span class="string">&quot;date: Thu, 11 Nov 2021 12:28:52 GMT<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                             <span class="comment">/*响应正文类型；              编码方式*/</span></span><br><span class="line">                             <span class="string">&quot;Content-Type: text/html;charset=ISO-8859-1<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                             <span class="comment">/*响应正文长度          空行*/</span></span><br><span class="line">                             <span class="string">&quot;Content-Length: 85<span class="char escape_">\r</span><span class="char escape_">\n</span><span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                             <span class="comment">/***响应正文***/</span></span><br><span class="line">                             <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;H1&gt;404&lt;/H1&gt;&lt;/body&gt;&lt;/html&gt;<span class="char escape_">\r</span><span class="char escape_">\n</span><span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">struct</span> <span class="variable">stat</span> <span class="variable">stat_buf</span>;			<span class="comment">//文件信息</span></span><br><span class="line">        <span class="title function_">fstat</span>(<span class="variable">filefd</span>, <span class="operator">&amp;</span><span class="variable">stat_buf</span>);		<span class="comment">//fstat通过文件句柄获取文件信息</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_">S_ISDIR</span>(<span class="variable">stat_buf</span>.<span class="property">st_mode</span>))	<span class="comment">//如果文件是一个目录</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="title function_">printf</span>(<span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">buffer</span>, <span class="comment">//同上，将404放入buffer中</span></span><br><span class="line">                   <span class="string">&quot;HTTP/1.1 404 Not Found<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                   <span class="string">&quot;Date: Thu, 11 Nov 2021 12:28:52 GMT<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                   <span class="string">&quot;Content-Type: text/html;charset=ISO-8859-1<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                   <span class="string">&quot;Content-Length: 85<span class="char escape_">\r</span><span class="char escape_">\n</span><span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;H1&gt;404&lt;/H1&gt;&lt;/body&gt;&lt;/html&gt;<span class="char escape_">\r</span><span class="char escape_">\n</span><span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span> );</span><br><span class="line"></span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">S_ISREG</span>(<span class="variable">stat_buf</span>.<span class="property">st_mode</span>)) <span class="comment">//如果文件是存在</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">ret_code</span> <span class="operator">=</span> <span class="number">200</span>;		<span class="comment">//200状态码</span></span><br><span class="line"></span><br><span class="line">            <span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">length</span> <span class="operator">=</span> <span class="title function_">sprintf</span>(<span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">buffer</span>, <span class="comment">//length记录长度，buffer储存响应报文</span></span><br><span class="line">                                 <span class="string">&quot;HTTP/1.1 200 OK<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Date: Thu, 11 Nov 2021 12:28:52 GMT<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Content-Type: text/html;charset=ISO-8859-1<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Content-Length: %ld<span class="char escape_">\r</span><span class="char escape_">\n</span><span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span>, </span><br><span class="line">                                 <span class="variable">stat_buf</span>.<span class="property">st_size</span> );<span class="comment">//文件长度储存在stat_buf.st_size中</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">ev</span><span class="operator">-</span><span class="operator">&gt;</span><span class="variable">length</span>;<span class="comment">//返回报文长度</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.总代码</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HTTP_METHOD_ROOT    <span class="string">&quot;html&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BUFLEN          4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EPOLLSIZE       1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EPOLL_EVENTS    1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HTTP_METHOD_GET     0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HTTP_METHOD_POST    1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*NCALLBACK)</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>, <span class="type">void</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> events;</span><br><span class="line">    <span class="type">int</span> status;</span><br><span class="line">    <span class="type">void</span> *arg;</span><br><span class="line">    <span class="type">long</span> last_active;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> (*callback)(<span class="type">int</span> fd, <span class="type">int</span> event, <span class="type">void</span> *arg);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buffer[MAX_BUFLEN];</span><br><span class="line">    <span class="type">int</span> length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*http param*/</span></span><br><span class="line">    <span class="type">int</span> method;</span><br><span class="line">    <span class="type">char</span> resource[MAX_BUFLEN];</span><br><span class="line">    <span class="type">int</span> ret_code;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qseventblock</span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *eventsarrry;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsreactor</span>&#123;</span><br><span class="line">    <span class="type">int</span> epfd;</span><br><span class="line">    <span class="type">int</span> blkcnt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *evblk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">recv_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">send_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span> *<span class="built_in">qsreactor_idx</span>(<span class="keyword">struct</span> qsreactor *reactor, <span class="type">int</span> sockfd);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">readline</span><span class="params">(<span class="type">char</span> *allbuf, <span class="type">int</span> idx, <span class="type">char</span> *linebuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(allbuf);    </span><br><span class="line">    <span class="keyword">for</span>( ; idx&lt;len; idx++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(allbuf[idx] == <span class="string">&#x27;\r&#x27;</span> &amp;&amp; allbuf[idx+<span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> idx+<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        *(linebuf++) = allbuf[idx];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">qs_event_set</span><span class="params">(<span class="keyword">struct</span> qsevent *ev, <span class="type">int</span> fd, NCALLBACK callback, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ev-&gt;events = <span class="number">0</span>;</span><br><span class="line">    ev-&gt;fd = fd;</span><br><span class="line">    ev-&gt;arg = arg;</span><br><span class="line">    ev-&gt;callback = callback;</span><br><span class="line">    ev-&gt;last_active = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qs_event_add</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> events, <span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> epv = &#123;<span class="number">0</span>, &#123;<span class="number">0</span>&#125;&#125;;;</span><br><span class="line">    epv.events = ev-&gt;events = events;</span><br><span class="line">    epv.data.ptr = ev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ev-&gt;status == <span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_MOD, ev-&gt;fd, &amp;epv) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;EPOLL_CTL_MOD error\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(ev-&gt;status == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, ev-&gt;fd, &amp;epv) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;EPOLL_CTL_ADD error\n&quot;</span>);    </span><br><span class="line">            <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ev-&gt;status = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qs_event_del</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> epv = &#123;<span class="number">0</span>, &#123;<span class="number">0</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">if</span>(ev-&gt;status != <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    ev-&gt;status = <span class="number">0</span>;</span><br><span class="line">    epv.data.ptr = ev;</span><br><span class="line">    <span class="keyword">if</span>((<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_DEL, ev-&gt;fd, &amp;epv)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;EPOLL_CTL_DEL error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sock</span><span class="params">(<span class="type">short</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">fcntl</span>(fd, F_SETFL, O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> ser_addr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;ser_addr, <span class="number">0</span>, <span class="built_in">sizeof</span>(ser_addr));</span><br><span class="line">    ser_addr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    ser_addr.sin_family = AF_INET;</span><br><span class="line">    ser_addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bind</span>(fd, (<span class="keyword">struct</span> sockaddr*)&amp;ser_addr, <span class="built_in">sizeof</span>(ser_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(fd, <span class="number">20</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;listen error\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;listener[%d] lstening..\n&quot;</span>, fd);</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">http_request</span><span class="params">(<span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> linebuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> idx = <span class="built_in">readline</span>(ev-&gt;buffer, <span class="number">0</span>, linebuf);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strstr</span>(linebuf, <span class="string">&quot;GET&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        ev-&gt;method = HTTP_METHOD_GET;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(linebuf[<span class="built_in">sizeof</span>(<span class="string">&quot;GET &quot;</span>) + i] != <span class="string">&#x27; &#x27;</span>)i++;</span><br><span class="line">        linebuf[<span class="built_in">sizeof</span>(<span class="string">&quot;GET &quot;</span>) + i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">sprintf</span>(ev-&gt;resource, <span class="string">&quot;./%s/%s&quot;</span>, HTTP_METHOD_ROOT, linebuf+<span class="built_in">sizeof</span>(<span class="string">&quot;GET &quot;</span>));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;resource:%s\n&quot;</span>, ev-&gt;resource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strstr</span>(linebuf, <span class="string">&quot;POST&quot;</span>))</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">http_response</span><span class="params">(<span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ev == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(ev-&gt;buffer, <span class="number">0</span>, MAX_BUFLEN);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;resource:%s\n&quot;</span>, ev-&gt;resource);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> filefd = <span class="built_in">open</span>(ev-&gt;resource, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(filefd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ev-&gt;ret_code = <span class="number">404</span>;</span><br><span class="line">        ev-&gt;length = <span class="built_in">sprintf</span>(ev-&gt;buffer,</span><br><span class="line">                             <span class="string">&quot;HTTP/1.1 404 NOT FOUND\r\n&quot;</span></span><br><span class="line">                             <span class="string">&quot;date: Thu, 11 Nov 2021 12:28:52 GMT\r\n&quot;</span></span><br><span class="line">                             <span class="string">&quot;Content-Type: text/html;charset=ISO-8859-1\r\n&quot;</span></span><br><span class="line">                             <span class="string">&quot;Content-Length: 85\r\n\r\n&quot;</span></span><br><span class="line">                             <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;H1&gt;404&lt;/H1&gt;&lt;/body&gt;&lt;/html&gt;\r\n\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> stat stat_buf;</span><br><span class="line">        <span class="built_in">fstat</span>(filefd, &amp;stat_buf);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">S_ISDIR</span>(stat_buf.st_mode))</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(ev-&gt;buffer, </span><br><span class="line">                   <span class="string">&quot;HTTP/1.1 404 Not Found\r\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;Date: Thu, 11 Nov 2021 12:28:52 GMT\r\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;Content-Type: text/html;charset=ISO-8859-1\r\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;Content-Length: 85\r\n\r\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;H1&gt;404&lt;/H1&gt;&lt;/body&gt;&lt;/html&gt;\r\n\r\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">S_ISREG</span>(stat_buf.st_mode)) </span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            ev-&gt;ret_code = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">            ev-&gt;length = <span class="built_in">sprintf</span>(ev-&gt;buffer, </span><br><span class="line">                                 <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Date: Thu, 11 Nov 2021 12:28:52 GMT\r\n&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Content-Type: text/html;charset=ISO-8859-1\r\n&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Content-Length: %ld\r\n\r\n&quot;</span>, </span><br><span class="line">                                 stat_buf.st_size );</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ev-&gt;length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_init</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(reactor, <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsreactor));</span><br><span class="line">    reactor-&gt;epfd = <span class="built_in">epoll_create</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;epfd &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;epoll_create error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *block = (<span class="keyword">struct</span> qseventblock*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qseventblock));</span><br><span class="line">    <span class="keyword">if</span>(block == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;blockinit malloc error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(reactor-&gt;epfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(block, <span class="number">0</span>, <span class="built_in">sizeof</span>(block));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *evs = (<span class="keyword">struct</span> qsevent*)<span class="built_in">malloc</span>(MAX_EPOLLSIZE * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsevent));</span><br><span class="line">    <span class="keyword">if</span>(evs == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;evsnit malloc error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(reactor-&gt;epfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(evs, <span class="number">0</span>, <span class="built_in">sizeof</span>(evs));</span><br><span class="line"></span><br><span class="line">    block-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    block-&gt;eventsarrry = evs;</span><br><span class="line"></span><br><span class="line">    reactor-&gt;blkcnt = <span class="number">1</span>;</span><br><span class="line">    reactor-&gt;evblk = block;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_alloc</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;evblk == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *tailblock = reactor-&gt;evblk;</span><br><span class="line">    <span class="keyword">while</span>(tailblock-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">    tailblock = tailblock-&gt;next;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *newblock = (<span class="keyword">struct</span> qseventblock*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qseventblock));</span><br><span class="line">    <span class="keyword">if</span>(newblock == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;newblock alloc error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(newblock, <span class="number">0</span>, <span class="built_in">sizeof</span>(newblock));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *neweventarray = (<span class="keyword">struct</span> qsevent*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsevent) * MAX_EPOLLSIZE);</span><br><span class="line">    <span class="keyword">if</span>(neweventarray == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;neweventarray malloc error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(neweventarray, <span class="number">0</span>, <span class="built_in">sizeof</span>(neweventarray));</span><br><span class="line"></span><br><span class="line">    newblock-&gt;eventsarrry = neweventarray;</span><br><span class="line">    newblock-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    tailblock-&gt;next = newblock;</span><br><span class="line">    reactor-&gt;blkcnt++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span> *<span class="built_in">qsreactor_idx</span>(<span class="keyword">struct</span> qsreactor *reactor, <span class="type">int</span> sockfd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> index = sockfd / MAX_EPOLLSIZE;</span><br><span class="line">    <span class="keyword">while</span>(index &gt;= reactor-&gt;blkcnt)<span class="built_in">qsreactor_alloc</span>(reactor);</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *idxblock = reactor-&gt;evblk;</span><br><span class="line">    <span class="keyword">while</span>(i++&lt;index &amp;&amp; idxblock != <span class="literal">NULL</span>)</span><br><span class="line">    idxblock = idxblock-&gt;next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;idxblock-&gt;eventsarrry[sockfd%MAX_EPOLLSIZE];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_destory</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">close</span>(reactor-&gt;epfd);</span><br><span class="line">    <span class="built_in">free</span>(reactor-&gt;evblk);</span><br><span class="line">    reactor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_addlistener</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor, <span class="type">int</span> sockfd, NCALLBACK acceptor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;evblk == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *event = <span class="built_in">qsreactor_idx</span>(reactor, sockfd);</span><br><span class="line">    <span class="built_in">qs_event_set</span>(event, sockfd, acceptor, reactor);</span><br><span class="line">    <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLIN, event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">send_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)arg;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span>   *ev = <span class="built_in">qsreactor_idx</span>(reactor, fd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">http_response</span>(ev);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">send</span>(fd, ev-&gt;buffer, ev-&gt;length, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;clent[%d] &quot;</span>, fd);</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;send error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(ret &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(ev-&gt;ret_code == <span class="number">200</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> filefd = <span class="built_in">open</span>(ev-&gt;resource, O_RDONLY);</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">stat</span> stat_buf;</span><br><span class="line">            <span class="built_in">fstat</span>(filefd, &amp;stat_buf);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">sendfile</span>(fd, filefd, <span class="literal">NULL</span>, stat_buf.st_size);</span><br><span class="line">            <span class="built_in">close</span>(filefd);   </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send to client[%d]:%s&quot;</span>, fd, ev-&gt;buffer);</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">qs_event_set</span>(ev, fd, recv_cb, reactor);</span><br><span class="line">        <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLIN, ev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">recv_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)arg;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *ev = <span class="built_in">qsreactor_idx</span>(reactor, fd);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">recv</span>(fd, ev-&gt;buffer, MAX_BUFLEN, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ev-&gt;length = len;</span><br><span class="line">        ev-&gt;buffer[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client[%d]:%s&quot;</span>, fd, ev-&gt;buffer);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">http_request</span>(ev);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">qs_event_set</span>(ev, fd, send_cb, reactor);</span><br><span class="line">        <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLOUT, ev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client[%d] close\n&quot;</span>, fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client[%d]&quot;</span>, fd);</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;reacv error,\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">accept_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)arg;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;</span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> clientfd;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((clientfd = <span class="built_in">accept</span>(fd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(errno != EAGAIN &amp;&amp; errno != EINTR)</span><br><span class="line">        &#123;&#125;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;accept error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>((flag = <span class="built_in">fcntl</span>(clientfd, F_SETFL, O_NONBLOCK)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fcntl noblock error, %d\n&quot;</span>,MAX_BUFLEN);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *event = <span class="built_in">qsreactor_idx</span>(reactor, clientfd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qs_event_set</span>(event, clientfd, recv_cb, reactor);</span><br><span class="line">    <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLIN, event);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;new connect [%s:%d], pos[%d]\n&quot;</span>,</span><br><span class="line">           <span class="built_in">inet_ntoa</span>(client_addr.sin_addr), <span class="built_in">ntohs</span>(client_addr.sin_port), clientfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_run</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;evblk == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;epfd &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> events[MAX_EPOLL_EVENTS + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> nready = <span class="built_in">epoll_wait</span>(reactor-&gt;epfd, events, MAX_EPOLL_EVENTS, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(nready &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;epoll_wait error\n&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;nready; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">qsevent</span> *ev = (<span class="keyword">struct</span> qsevent*)events[i].data.ptr;</span><br><span class="line">            <span class="keyword">if</span>((events[i].events &amp; EPOLLIN) &amp;&amp; (ev-&gt;events &amp; EPOLLIN))</span><br><span class="line">            &#123;</span><br><span class="line">                ev-&gt;<span class="built_in">callback</span>(ev-&gt;fd, events[i].events, ev-&gt;arg);    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>((events[i].events &amp; EPOLLOUT) &amp;&amp; (ev-&gt;events &amp; EPOLLOUT))</span><br><span class="line">            &#123;</span><br><span class="line">                ev-&gt;<span class="built_in">callback</span>(ev-&gt;fd, events[i].events, ev-&gt;arg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> port = <span class="built_in">atoi</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">sock</span>(port);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsreactor));</span><br><span class="line">    <span class="built_in">qsreactor_init</span>(reactor);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qsreactor_addlistener</span>(reactor, sockfd, accept_cb);</span><br><span class="line">    <span class="built_in">qsreactor_run</span>(reactor);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qsreactor_destory</span>(reactor);</span><br><span class="line">    <span class="built_in">close</span>(sockfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5.epoll反应堆模型下实现websocket协议</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/sha.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/pem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/bio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/evp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BUFLEN          4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EPOLLSIZE       1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EPOLL_EVENTS    1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GUID            <span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span></span><br><span class="line">&#123; </span><br><span class="line">    WS_HANDSHAKE = <span class="number">0</span>,</span><br><span class="line">    WS_TANSMISSION = <span class="number">1</span>,</span><br><span class="line">    WS_END = <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_ws_ophdr</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> opcode:<span class="number">4</span>,</span><br><span class="line">    rsv3:<span class="number">1</span>,</span><br><span class="line">    rsv2:<span class="number">1</span>,</span><br><span class="line">    rsv1:<span class="number">1</span>,</span><br><span class="line">    fin:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> pl_len:<span class="number">7</span>,</span><br><span class="line">    mask:<span class="number">1</span>;</span><br><span class="line">&#125;ws_ophdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_ws_head_126</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> payload_lenght;</span><br><span class="line">    <span class="type">char</span> mask_key[<span class="number">4</span>];</span><br><span class="line">&#125;ws_head_126;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_ws_head_127</span>&#123;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> payload_lenght;</span><br><span class="line">    <span class="type">char</span> mask_key[<span class="number">4</span>];</span><br><span class="line">&#125;ws_head_127;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*NCALLBACK)</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>, <span class="type">void</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> events;</span><br><span class="line">    <span class="type">int</span> status;</span><br><span class="line">    <span class="type">void</span> *arg;</span><br><span class="line">    <span class="type">long</span> last_active;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> (*callback)(<span class="type">int</span> fd, <span class="type">int</span> event, <span class="type">void</span> *arg);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buffer[MAX_BUFLEN];</span><br><span class="line">    <span class="type">int</span> length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*websocket param*/</span></span><br><span class="line">    <span class="type">int</span> status_machine;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qseventblock</span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *eventsarrry;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsreactor</span>&#123;</span><br><span class="line">    <span class="type">int</span> epfd;</span><br><span class="line">    <span class="type">int</span> blkcnt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *evblk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">recv_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">send_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span> *<span class="built_in">qsreactor_idx</span>(<span class="keyword">struct</span> qsreactor *reactor, <span class="type">int</span> sockfd);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">readline</span><span class="params">(<span class="type">char</span> *allbuf, <span class="type">int</span> idx, <span class="type">char</span> *linebuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(allbuf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(;idx &lt; len;idx ++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (allbuf[idx] == <span class="string">&#x27;\r&#x27;</span> &amp;&amp; allbuf[idx+<span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> idx+<span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *(linebuf++) = allbuf[idx];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">base64_encode</span><span class="params">(<span class="type">char</span> *in_str, <span class="type">int</span> in_len, <span class="type">char</span> *out_str)</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    BIO *b64, *bio;    </span><br><span class="line">    BUF_MEM *bptr = <span class="literal">NULL</span>;    </span><br><span class="line">    <span class="type">size_t</span> size = <span class="number">0</span>;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (in_str == <span class="literal">NULL</span> || out_str == <span class="literal">NULL</span>)        </span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;    </span><br><span class="line"></span><br><span class="line">    b64 = <span class="built_in">BIO_new</span>(<span class="built_in">BIO_f_base64</span>());    </span><br><span class="line">    bio = <span class="built_in">BIO_new</span>(<span class="built_in">BIO_s_mem</span>());    </span><br><span class="line">    bio = <span class="built_in">BIO_push</span>(b64, bio);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIO_write</span>(bio, in_str, in_len);    </span><br><span class="line">    <span class="built_in">BIO_flush</span>(bio);    </span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIO_get_mem_ptr</span>(bio, &amp;bptr);    </span><br><span class="line">    <span class="built_in">memcpy</span>(out_str, bptr-&gt;data, bptr-&gt;length);    </span><br><span class="line">    out_str[bptr-&gt;length<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>;    </span><br><span class="line">    size = bptr-&gt;length;    </span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIO_free_all</span>(bio);    </span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEBSOCK_KEY_LENGTH  19</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">websocket_handshake</span><span class="params">(<span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> linebuf[<span class="number">128</span>];</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> sec_data[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> sec_accept[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(linebuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(linebuf));</span><br><span class="line">        index = <span class="built_in">readline</span>(ev-&gt;buffer, index, linebuf);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(linebuf, <span class="string">&quot;Sec-WebSocket-Key&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">strcat</span>(linebuf, GUID);</span><br><span class="line">            <span class="built_in">SHA1</span>(linebuf+WEBSOCK_KEY_LENGTH, <span class="built_in">strlen</span>(linebuf+WEBSOCK_KEY_LENGTH), sec_data);</span><br><span class="line">            <span class="built_in">base64_encode</span>(sec_data, <span class="built_in">strlen</span>(sec_data), sec_accept);</span><br><span class="line">            <span class="built_in">memset</span>(ev-&gt;buffer, <span class="number">0</span>, MAX_BUFLEN);</span><br><span class="line"></span><br><span class="line">            ev-&gt;length = <span class="built_in">sprintf</span>(ev-&gt;buffer,</span><br><span class="line">                                 <span class="string">&quot;HTTP/1.1 101 Switching Protocols\r\n&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Upgrade: websocket\r\n&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Connection: Upgrade\r\n&quot;</span></span><br><span class="line">                                 <span class="string">&quot;Sec-websocket-Accept: %s\r\n\r\n&quot;</span>, sec_accept);</span><br><span class="line">            <span class="keyword">break</span>;   </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">while</span>(index != <span class="number">-1</span> &amp;&amp; (ev-&gt;buffer[index] != <span class="string">&#x27;\r&#x27;</span>) || (ev-&gt;buffer[index] != <span class="string">&#x27;\n&#x27;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">websocket_umask</span><span class="params">(<span class="type">char</span> *payload, <span class="type">int</span> length, <span class="type">char</span> *mask_key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( ; i&lt;length; i++)</span><br><span class="line">    payload[i] ^= mask_key[i%<span class="number">4</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">websocket_transmission</span><span class="params">(<span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ws_ophdr *ophdr = (ws_ophdr*)ev-&gt;buffer;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ws_recv_data length=%d\n&quot;</span>, ophdr-&gt;pl_len);</span><br><span class="line">    <span class="keyword">if</span>(ophdr-&gt;pl_len &lt;<span class="number">126</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * payload = ev-&gt;buffer + <span class="built_in">sizeof</span>(ws_ophdr) + <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span>(ophdr-&gt;mask)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">websocket_umask</span>(payload, ophdr-&gt;pl_len, ev-&gt;buffer+<span class="number">2</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;payload:%s\n&quot;</span>, payload);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(ev-&gt;buffer, <span class="number">0</span>, ev-&gt;length);</span><br><span class="line">        <span class="built_in">strcpy</span>(ev-&gt;buffer, <span class="string">&quot;00ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">websocket_request</span><span class="params">(<span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ev-&gt;status_machine == WS_HANDSHAKE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">websocket_handshake</span>(ev);</span><br><span class="line">        ev-&gt;status_machine = WS_TANSMISSION;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ev-&gt;status_machine == WS_TANSMISSION)&#123;</span><br><span class="line">        <span class="built_in">websocket_transmission</span>(ev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">qs_event_set</span><span class="params">(<span class="keyword">struct</span> qsevent *ev, <span class="type">int</span> fd, NCALLBACK callback, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ev-&gt;events = <span class="number">0</span>;</span><br><span class="line">    ev-&gt;fd = fd;</span><br><span class="line">    ev-&gt;arg = arg;</span><br><span class="line">    ev-&gt;callback = callback;</span><br><span class="line">    ev-&gt;last_active = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qs_event_add</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> events, <span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> epv = &#123;<span class="number">0</span>, &#123;<span class="number">0</span>&#125;&#125;;;</span><br><span class="line">    epv.events = ev-&gt;events = events;</span><br><span class="line">    epv.data.ptr = ev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ev-&gt;status == <span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_MOD, ev-&gt;fd, &amp;epv) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;EPOLL_CTL_MOD error\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(ev-&gt;status == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, ev-&gt;fd, &amp;epv) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;EPOLL_CTL_ADD error\n&quot;</span>);    </span><br><span class="line">            <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ev-&gt;status = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qs_event_del</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> epv = &#123;<span class="number">0</span>, &#123;<span class="number">0</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">if</span>(ev-&gt;status != <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    ev-&gt;status = <span class="number">0</span>;</span><br><span class="line">    epv.data.ptr = ev;</span><br><span class="line">    <span class="keyword">if</span>((<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_DEL, ev-&gt;fd, &amp;epv)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;EPOLL_CTL_DEL error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sock</span><span class="params">(<span class="type">short</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">fcntl</span>(fd, F_SETFL, O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> ser_addr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;ser_addr, <span class="number">0</span>, <span class="built_in">sizeof</span>(ser_addr));</span><br><span class="line">    ser_addr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    ser_addr.sin_family = AF_INET;</span><br><span class="line">    ser_addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bind</span>(fd, (<span class="keyword">struct</span> sockaddr*)&amp;ser_addr, <span class="built_in">sizeof</span>(ser_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(fd, <span class="number">20</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;listen error\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;listener[%d] lstening..\n&quot;</span>, fd);</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_init</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(reactor, <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsreactor));</span><br><span class="line">    reactor-&gt;epfd = <span class="built_in">epoll_create</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;epfd &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;epoll_create error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *block = (<span class="keyword">struct</span> qseventblock*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qseventblock));</span><br><span class="line">    <span class="keyword">if</span>(block == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;blockinit malloc error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(reactor-&gt;epfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(block, <span class="number">0</span>, <span class="built_in">sizeof</span>(block));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *evs = (<span class="keyword">struct</span> qsevent*)<span class="built_in">malloc</span>(MAX_EPOLLSIZE * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsevent));</span><br><span class="line">    <span class="keyword">if</span>(evs == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;evsnit malloc error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(reactor-&gt;epfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(evs, <span class="number">0</span>, <span class="built_in">sizeof</span>(evs));</span><br><span class="line"></span><br><span class="line">    block-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    block-&gt;eventsarrry = evs;</span><br><span class="line"></span><br><span class="line">    reactor-&gt;blkcnt = <span class="number">1</span>;</span><br><span class="line">    reactor-&gt;evblk = block;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_alloc</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;evblk == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *tailblock = reactor-&gt;evblk;</span><br><span class="line">    <span class="keyword">while</span>(tailblock-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">    tailblock = tailblock-&gt;next;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *newblock = (<span class="keyword">struct</span> qseventblock*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qseventblock));</span><br><span class="line">    <span class="keyword">if</span>(newblock == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;newblock alloc error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(newblock, <span class="number">0</span>, <span class="built_in">sizeof</span>(newblock));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *neweventarray = (<span class="keyword">struct</span> qsevent*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsevent) * MAX_EPOLLSIZE);</span><br><span class="line">    <span class="keyword">if</span>(neweventarray == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;neweventarray malloc error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(neweventarray, <span class="number">0</span>, <span class="built_in">sizeof</span>(neweventarray));</span><br><span class="line"></span><br><span class="line">    newblock-&gt;eventsarrry = neweventarray;</span><br><span class="line">    newblock-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    tailblock-&gt;next = newblock;</span><br><span class="line">    reactor-&gt;blkcnt++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span> *<span class="built_in">qsreactor_idx</span>(<span class="keyword">struct</span> qsreactor *reactor, <span class="type">int</span> sockfd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> index = sockfd / MAX_EPOLLSIZE;</span><br><span class="line">    <span class="keyword">while</span>(index &gt;= reactor-&gt;blkcnt)<span class="built_in">qsreactor_alloc</span>(reactor);</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *idxblock = reactor-&gt;evblk;</span><br><span class="line">    <span class="keyword">while</span>(i++&lt;index &amp;&amp; idxblock != <span class="literal">NULL</span>)</span><br><span class="line">    idxblock = idxblock-&gt;next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;idxblock-&gt;eventsarrry[sockfd%MAX_EPOLLSIZE];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_destory</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">close</span>(reactor-&gt;epfd);</span><br><span class="line">    <span class="built_in">free</span>(reactor-&gt;evblk);</span><br><span class="line">    reactor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_addlistener</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor, <span class="type">int</span> sockfd, NCALLBACK acceptor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;evblk == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *event = <span class="built_in">qsreactor_idx</span>(reactor, sockfd);</span><br><span class="line">    <span class="built_in">qs_event_set</span>(event, sockfd, acceptor, reactor);</span><br><span class="line">    <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLIN, event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">send_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)arg;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span>   *ev = <span class="built_in">qsreactor_idx</span>(reactor, fd);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">send</span>(fd, ev-&gt;buffer, ev-&gt;length, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;clent[%d] &quot;</span>, fd);</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;send error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(ret &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send to client[%d]:\n%s\n&quot;</span>, fd, ev-&gt;buffer);</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">qs_event_set</span>(ev, fd, recv_cb, reactor);</span><br><span class="line">        <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLIN, ev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">recv_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)arg;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *ev = <span class="built_in">qsreactor_idx</span>(reactor, fd);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">recv</span>(fd, ev-&gt;buffer, MAX_BUFLEN, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ev-&gt;length = len;</span><br><span class="line">        ev-&gt;buffer[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client[%d]:\n%s\n&quot;</span>, fd, ev-&gt;buffer);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">websocket_request</span>(ev);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">qs_event_set</span>(ev, fd, send_cb, reactor);</span><br><span class="line">        <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLOUT, ev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client[%d] close\n&quot;</span>, fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client[%d]&quot;</span>, fd);</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;reacv error,\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">accept_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)arg;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;</span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> clientfd;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((clientfd = <span class="built_in">accept</span>(fd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(errno != EAGAIN &amp;&amp; errno != EINTR)</span><br><span class="line">        &#123;&#125;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;accept error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>((flag = <span class="built_in">fcntl</span>(clientfd, F_SETFL, O_NONBLOCK)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fcntl noblock error, %d\n&quot;</span>,MAX_BUFLEN);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *event = <span class="built_in">qsreactor_idx</span>(reactor, clientfd);</span><br><span class="line"></span><br><span class="line">    event-&gt;status_machine = WS_HANDSHAKE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qs_event_set</span>(event, clientfd, recv_cb, reactor);</span><br><span class="line">    <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLIN, event);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;new connect [%s:%d], pos[%d]\n&quot;</span>,</span><br><span class="line">           <span class="built_in">inet_ntoa</span>(client_addr.sin_addr), <span class="built_in">ntohs</span>(client_addr.sin_port), clientfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_run</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;evblk == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;epfd &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> events[MAX_EPOLL_EVENTS + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> nready = <span class="built_in">epoll_wait</span>(reactor-&gt;epfd, events, MAX_EPOLL_EVENTS, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(nready &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;epoll_wait error\n&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;nready; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">qsevent</span> *ev = (<span class="keyword">struct</span> qsevent*)events[i].data.ptr;</span><br><span class="line">            <span class="keyword">if</span>((events[i].events &amp; EPOLLIN) &amp;&amp; (ev-&gt;events &amp; EPOLLIN))</span><br><span class="line">            &#123;</span><br><span class="line">                ev-&gt;<span class="built_in">callback</span>(ev-&gt;fd, events[i].events, ev-&gt;arg);    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>((events[i].events &amp; EPOLLOUT) &amp;&amp; (ev-&gt;events &amp; EPOLLOUT))</span><br><span class="line">            &#123;</span><br><span class="line">                ev-&gt;<span class="built_in">callback</span>(ev-&gt;fd, events[i].events, ev-&gt;arg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> port = <span class="built_in">atoi</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">sock</span>(port);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsreactor));</span><br><span class="line">    <span class="built_in">qsreactor_init</span>(reactor);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qsreactor_addlistener</span>(reactor, sockfd, accept_cb);</span><br><span class="line">    <span class="built_in">qsreactor_run</span>(reactor);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qsreactor_destory</span>(reactor);</span><br><span class="line">    <span class="built_in">close</span>(sockfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6.C1000K reactor模型，epoll实现，连接并回发一段数据，测试正常</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BUFLEN          4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EPOLLSIZE       1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EPOLL_EVENTS    1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*NCALLBACK)</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>, <span class="type">void</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> events;</span><br><span class="line">    <span class="type">int</span> status;</span><br><span class="line">    <span class="type">void</span> *arg;</span><br><span class="line">    <span class="type">long</span> last_active;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> (*callback)(<span class="type">int</span> fd, <span class="type">int</span> event, <span class="type">void</span> *arg);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buffer[MAX_BUFLEN];</span><br><span class="line">    <span class="type">int</span> length;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qseventblock</span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *eventsarrry;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsreactor</span>&#123;</span><br><span class="line">    <span class="type">int</span> epfd;</span><br><span class="line">    <span class="type">int</span> blkcnt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *evblk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">recv_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">send_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span> *<span class="built_in">qsreactor_idx</span>(<span class="keyword">struct</span> qsreactor *reactor, <span class="type">int</span> sockfd);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">qs_event_set</span><span class="params">(<span class="keyword">struct</span> qsevent *ev, <span class="type">int</span> fd, NCALLBACK callback, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ev-&gt;events = <span class="number">0</span>;</span><br><span class="line">    ev-&gt;fd = fd;</span><br><span class="line">    ev-&gt;arg = arg;</span><br><span class="line">    ev-&gt;callback = callback;</span><br><span class="line">    ev-&gt;last_active = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qs_event_add</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> events, <span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> epv = &#123;<span class="number">0</span>, &#123;<span class="number">0</span>&#125;&#125;;;</span><br><span class="line">    epv.events = ev-&gt;events = events;</span><br><span class="line">    epv.data.ptr = ev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ev-&gt;status == <span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_MOD, ev-&gt;fd, &amp;epv) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;EPOLL_CTL_MOD error\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(ev-&gt;status == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, ev-&gt;fd, &amp;epv) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;EPOLL_CTL_ADD error\n&quot;</span>);    </span><br><span class="line">            <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ev-&gt;status = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qs_event_del</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> qsevent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> epv = &#123;<span class="number">0</span>, &#123;<span class="number">0</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">if</span>(ev-&gt;status != <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    ev-&gt;status = <span class="number">0</span>;</span><br><span class="line">    epv.data.ptr = ev;</span><br><span class="line">    <span class="keyword">if</span>((<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_DEL, ev-&gt;fd, &amp;epv)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;EPOLL_CTL_DEL error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sock</span><span class="params">(<span class="type">short</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">fcntl</span>(fd, F_SETFL, O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> ser_addr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;ser_addr, <span class="number">0</span>, <span class="built_in">sizeof</span>(ser_addr));</span><br><span class="line">    ser_addr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    ser_addr.sin_family = AF_INET;</span><br><span class="line">    ser_addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bind</span>(fd, (<span class="keyword">struct</span> sockaddr*)&amp;ser_addr, <span class="built_in">sizeof</span>(ser_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(fd, <span class="number">20</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen error\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;listener[%d] lstening..\n&quot;</span>, fd);</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_init</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(reactor, <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsreactor));</span><br><span class="line">    reactor-&gt;epfd = <span class="built_in">epoll_create</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;epfd &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;epoll_create error\n&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *block = (<span class="keyword">struct</span> qseventblock*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qseventblock));</span><br><span class="line">    <span class="keyword">if</span>(block == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;blockinit malloc error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(reactor-&gt;epfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(block, <span class="number">0</span>, <span class="built_in">sizeof</span>(block));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *evs = (<span class="keyword">struct</span> qsevent*)<span class="built_in">malloc</span>(MAX_EPOLLSIZE * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsevent));</span><br><span class="line">    <span class="keyword">if</span>(evs == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;evsnit malloc error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(reactor-&gt;epfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(evs, <span class="number">0</span>, <span class="built_in">sizeof</span>(evs));</span><br><span class="line"></span><br><span class="line">    block-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    block-&gt;eventsarrry = evs;</span><br><span class="line"></span><br><span class="line">    reactor-&gt;blkcnt = <span class="number">1</span>;</span><br><span class="line">    reactor-&gt;evblk = block;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_alloc</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;evblk == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *tailblock = reactor-&gt;evblk;</span><br><span class="line">    <span class="keyword">while</span>(tailblock-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">    tailblock = tailblock-&gt;next;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *newblock = (<span class="keyword">struct</span> qseventblock*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qseventblock));</span><br><span class="line">    <span class="keyword">if</span>(newblock == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;newblock alloc error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(newblock, <span class="number">0</span>, <span class="built_in">sizeof</span>(newblock));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *neweventarray = (<span class="keyword">struct</span> qsevent*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsevent) * MAX_EPOLLSIZE);</span><br><span class="line">    <span class="keyword">if</span>(neweventarray == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;neweventarray malloc error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(neweventarray, <span class="number">0</span>, <span class="built_in">sizeof</span>(neweventarray));</span><br><span class="line"></span><br><span class="line">    newblock-&gt;eventsarrry = neweventarray;</span><br><span class="line">    newblock-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    tailblock-&gt;next = newblock;</span><br><span class="line">    reactor-&gt;blkcnt++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">qsevent</span> *<span class="built_in">qsreactor_idx</span>(<span class="keyword">struct</span> qsreactor *reactor, <span class="type">int</span> sockfd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> index = sockfd / MAX_EPOLLSIZE;</span><br><span class="line">    <span class="keyword">while</span>(index &gt;= reactor-&gt;blkcnt)<span class="built_in">qsreactor_alloc</span>(reactor);</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qseventblock</span> *idxblock = reactor-&gt;evblk;</span><br><span class="line">    <span class="keyword">while</span>(i++&lt;index &amp;&amp; idxblock != <span class="literal">NULL</span>)</span><br><span class="line">        idxblock = idxblock-&gt;next;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &amp;idxblock-&gt;eventsarrry[sockfd%MAX_EPOLLSIZE];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_destory</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">close</span>(reactor-&gt;epfd);</span><br><span class="line">    <span class="built_in">free</span>(reactor-&gt;evblk);</span><br><span class="line">    reactor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_addlistener</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor, <span class="type">int</span> sockfd, NCALLBACK acceptor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;evblk == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *event = <span class="built_in">qsreactor_idx</span>(reactor, sockfd);</span><br><span class="line">    <span class="built_in">qs_event_set</span>(event, sockfd, acceptor, reactor);</span><br><span class="line">    <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLIN, event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">send_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)arg;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span>   *ev = <span class="built_in">qsreactor_idx</span>(reactor, fd);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">send</span>(fd, ev-&gt;buffer, ev-&gt;length, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;clent[%d] &quot;</span>, fd);</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;send error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(ret &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send to client[%d]:%s&quot;</span>, fd, ev-&gt;buffer);</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">qs_event_set</span>(ev, fd, recv_cb, reactor);</span><br><span class="line">        <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLIN, ev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">recv_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)arg;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *ev = <span class="built_in">qsreactor_idx</span>(reactor, fd);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">recv</span>(fd, ev-&gt;buffer, MAX_BUFLEN, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ev-&gt;length = len;</span><br><span class="line">        ev-&gt;buffer[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client[%d]:%s&quot;</span>, fd, ev-&gt;buffer);</span><br><span class="line">   </span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">qs_event_set</span>(ev, fd, send_cb, reactor);</span><br><span class="line">        <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLOUT, ev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client[%d] close\n&quot;</span>, fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qs_event_del</span>(reactor-&gt;epfd, ev);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client[%d]&quot;</span>, fd);</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;reacv error,\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">accept_cb</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> events, <span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)arg;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;</span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> clientfd;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((clientfd = <span class="built_in">accept</span>(fd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(errno != EAGAIN &amp;&amp; errno != EINTR)</span><br><span class="line">        &#123;&#125;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;accept error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>((flag = <span class="built_in">fcntl</span>(clientfd, F_SETFL, O_NONBLOCK)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fcntl noblock error, %d\n&quot;</span>,MAX_BUFLEN);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsevent</span> *event = <span class="built_in">qsreactor_idx</span>(reactor, clientfd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qs_event_set</span>(event, clientfd, recv_cb, reactor);</span><br><span class="line">    <span class="built_in">qs_event_add</span>(reactor-&gt;epfd, EPOLLIN, event);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;new connect [%s:%d], pos[%d]\n&quot;</span>,</span><br><span class="line">           <span class="built_in">inet_ntoa</span>(client_addr.sin_addr), <span class="built_in">ntohs</span>(client_addr.sin_port), clientfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsreactor_run</span><span class="params">(<span class="keyword">struct</span> qsreactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(reactor == <span class="literal">NULL</span>)</span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;evblk == <span class="literal">NULL</span>)</span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(reactor-&gt;epfd &lt; <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> events[MAX_EPOLL_EVENTS + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> nready = <span class="built_in">epoll_wait</span>(reactor-&gt;epfd, events, MAX_EPOLL_EVENTS, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(nready &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;epoll_wait error\n&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;nready; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">qsevent</span> *ev = (<span class="keyword">struct</span> qsevent*)events[i].data.ptr;</span><br><span class="line">            <span class="keyword">if</span>((events[i].events &amp; EPOLLIN) &amp;&amp; (ev-&gt;events &amp; EPOLLIN))</span><br><span class="line">            &#123;</span><br><span class="line">                ev-&gt;<span class="built_in">callback</span>(ev-&gt;fd, events[i].events, ev-&gt;arg);    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>((events[i].events &amp; EPOLLOUT) &amp;&amp; (ev-&gt;events &amp; EPOLLOUT))</span><br><span class="line">            &#123;</span><br><span class="line">                ev-&gt;<span class="built_in">callback</span>(ev-&gt;fd, events[i].events, ev-&gt;arg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> port = <span class="built_in">atoi</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">sock</span>(port);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">qsreactor</span> *reactor = (<span class="keyword">struct</span> qsreactor*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> qsreactor));</span><br><span class="line">    <span class="built_in">qsreactor_init</span>(reactor);</span><br><span class="line">       </span><br><span class="line">    <span class="built_in">qsreactor_addlistener</span>(reactor, sockfd, accept_cb);</span><br><span class="line">    <span class="built_in">qsreactor_run</span>(reactor);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qsreactor_destory</span>(reactor);</span><br><span class="line">    <span class="built_in">close</span>(sockfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>疑问：从协议原理和底层代码实现角度详细说明WebSocket怎么实现由服务器主动发送给客户端的？</p>
<p>目前的理解：</p>
<p>在WebSocket协议的底层，实际上是基于TCP协议的。当WebSocket连接建立时，会在客户端和服务器之间建立一个持久的TCP连接。这个TCP连接是全双工的，数据可以在任意方向上流动。因此，服务器可以随时将数据发送到这个TCP连接上，而无需等待客户端的请求。这就是WebSocket如何实现服务器主动向客户端发送数据的原理。</p>
<p>在代码层面，WebSocket服务器通常会有一个事件循环，用于监听TCP连接上的事件。当服务器有数据需要发送到客户端时，它会将数据写入到TCP连接上，然后由操作系统的网络栈将数据发送到客户端。这个过程是非阻塞的，服务器无需等待数据被发送出去，可以立即继续处理其他任务。这就是WebSocket如何在底层代码实现服务器主动向客户端发送数据的。</p>
<p>我认为本质还是WebSocket服务器的实现遵循他设计的概念。</p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/581974844">https://zhuanlan.zhihu.com/p/581974844</a></p>
<p>参考：<a target="_blank" rel="noopener" href="https://xiaolincoding.com/network/2_http/http_websocket.html#websocket%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">既然有 HTTP 协议，为什么还要有 WebSocket？</a></p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>WebSocket协议</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://penge666.github.io/posts/5447b09e.html">https://penge666.github.io/posts/5447b09e.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Penge666</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2024-06-18</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-06-18</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>计算机网络</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂作者</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/posts/3ebec1e4.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_33.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">进程间通信</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/b032cb51.html" title="Linux网络:I&#x2F;O多路复用-[select&#x2F;poll&#x2F;epoll]"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_10.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-04-12</div><div class="title">Linux网络:I&#x2F;O多路复用-[select&#x2F;poll&#x2F;epoll]</div></div></a></div><div><a href="/posts/51aeee82.html" title="TCP协议"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_19.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-04-27</div><div class="title">TCP协议</div></div></a></div><div><a href="/posts/9b06a28b.html" title="HTTP队头阻塞"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_25.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-04-27</div><div class="title">HTTP队头阻塞</div></div></a></div><div><a href="/posts/f5ef6bcf.html" title="HTTP学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_10.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-05-15</div><div class="title">HTTP学习笔记</div></div></a></div><div><a href="/posts/d78d2a72.html" title="HTTP通信过程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_12.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-05-15</div><div class="title">HTTP通信过程</div></div></a></div><div><a href="/posts/db38782f.html" title="模块1:通信协议综述"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_17.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-05-22</div><div class="title">模块1:通信协议综述</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">0.前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-WebSocket%E7%AE%80%E4%BB%8B"><span class="toc-text">1.WebSocket简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-WebSocket%E4%BA%A7%E7%94%9F%E8%83%8C%E6%99%AF"><span class="toc-text">2.WebSocket产生背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-WebSocket%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">3.WebSocket实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-WebSocket%E5%8D%8F%E8%AE%AE%E4%B8%BE%E4%BE%8B"><span class="toc-text">4.WebSocket协议举例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-WebSocket%E4%BD%BF%E7%94%A8"><span class="toc-text">5.WebSocket使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-WebSocket-%E4%BB%8B%E7%BB%8D"><span class="toc-text">5.1 WebSocket 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-WebSocket-API"><span class="toc-text">5.2 WebSocket API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-WebSocket%E4%BA%8B%E4%BB%B6"><span class="toc-text">5.3 WebSocket事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-open"><span class="toc-text">5.3.1 open</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-Message"><span class="toc-text">5.3.2 Message</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-3-Error"><span class="toc-text">5.3.3 Error</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-4-Close"><span class="toc-text">5.3.4 Close</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-WebSocket-%E6%96%B9%E6%B3%95"><span class="toc-text">5.4 WebSocket 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-send"><span class="toc-text">5.4.1 send()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-close"><span class="toc-text">5.4.2 close()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-WebSocket-%E5%B1%9E%E6%80%A7"><span class="toc-text">5.5 WebSocket 属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-1-readyState"><span class="toc-text">5.5.1 readyState</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-2-bufferedAmount"><span class="toc-text">5.5.2 bufferedAmount</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-3-protocol"><span class="toc-text">5.5.3 protocol</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-WebSocket%E8%AF%AD%E8%A8%80%E6%94%AF%E6%8C%81"><span class="toc-text">6.WebSocket语言支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-WebSocket%E9%80%9A%E4%BF%A1"><span class="toc-text">7.WebSocket通信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E8%BF%9E%E6%8E%A5%E6%8F%A1%E6%89%8B"><span class="toc-text">7.1 连接握手</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-1-%E8%AF%B7%E6%B1%82"><span class="toc-text">7.1.1 请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-2-%E5%BA%94%E7%AD%94"><span class="toc-text">7.1.2 应答</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%EF%BC%88%E5%8F%8C%E5%B7%A5%EF%BC%89"><span class="toc-text">7.2 数据传输（双工）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E5%85%B3%E9%97%AD%E8%AF%B7%E6%B1%82"><span class="toc-text">7.3 关闭请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-WebSocket%E5%8D%8F%E8%AE%AE%E8%BF%9B%E4%B8%80%E6%AD%A5%E7%90%86%E8%A7%A3"><span class="toc-text">8.WebSocket协议进一步理解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-WebSocket%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">8.1 WebSocket是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-WebSocket%E5%87%BA%E7%8E%B0%E4%B9%8B%E5%89%8D%E7%9A%84%E5%AE%9E%E6%97%B6%E6%8A%80%E6%9C%AF"><span class="toc-text">8.2 WebSocket出现之前的实时技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-WebSocket%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">8.3 WebSocket应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-WebSocket%E5%8D%8F%E8%AE%AE%E6%A0%88"><span class="toc-text">8.4 WebSocket协议栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-WebSocket%E4%B8%8EHTTP%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">8.5 WebSocket与HTTP的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-WebSocket%E6%8F%A1%E6%89%8B%E8%BF%87%E7%A8%8B"><span class="toc-text">8.6 WebSocket握手过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-7-WebSocket%E5%B8%A7%E6%A0%BC%E5%BC%8F"><span class="toc-text">8.7 WebSocket帧格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-8-WebSocket%E5%88%86%E7%89%87%E4%BC%A0%E8%BE%93"><span class="toc-text">8.8 WebSocket分片传输</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-9-WebSocket%E7%9B%B8%E5%85%B3%E6%89%A9%E5%B1%95"><span class="toc-text">8.9 WebSocket相关扩展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-WebSocket-%E8%83%BD%E8%A7%A3%E5%86%B3%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98"><span class="toc-text">9.WebSocket 能解决什么问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-WebSocket%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">10.WebSocket工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E8%BF%9B%E4%B8%80%E6%AD%A5%E8%A7%A3%E6%9E%90%E4%BB%80%E4%B9%88%E6%98%AFWebSocket%E5%8D%8F%E8%AE%AE"><span class="toc-text">11.进一步解析什么是WebSocket协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1websocket%E7%89%B9%E7%82%B9"><span class="toc-text">11.1websocket特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2websocket%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B"><span class="toc-text">11.2websocket协议通信过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-1-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">11.2.1 客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-2-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-text">11.2.2 服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-3-data-transfer"><span class="toc-text">11.2.3 data transfer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-epoll%E5%8F%8D%E5%BA%94%E5%A0%86%E6%A8%A1%E5%9E%8B%E4%B8%8B%E5%AE%9E%E7%8E%B0http%E5%8D%8F%E8%AE%AE"><span class="toc-text">11.3.epoll反应堆模型下实现http协议</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">格言🧬</p><div class="bg-ad"><div>用勇气改变可以改变的事，用胸怀接受不能接受的事，用智慧分辨两者的不同✨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://github.com/Penge666/">点击开启星辰之旅</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">猜你想看💡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">惊喜网站</a><a href="/box/nav/">网址导航</a></li><li><a href="/social/link/">我的朋友</a><a href="/comments/">留点什么</a></li><li><a href="/personal/about/">关于作者</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">推荐友链⌛</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://www.fomal.cc/" title="Fomalhaut🥝"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2024</b></span><span><b>&nbsp;&nbsp;By Penge666</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="本站采用多线部署，主线路托管于Vercel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="本站数据分析得益于51la技术支持"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="本站已加入萌ICP豪华套餐，萌ICP备20226665号"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/萌ICP备-20226665-fe1384.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="本网站经Service Worker分流至缤纷云对象存储"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-缤纷云-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="本站使用网盾星球提供CDN加速与防护"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-网盾星球-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本网站源码由Github提供存储仓库"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="右键模式" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>美化设置</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/分布式/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍡 Kevinの分布式学习笔记 (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/操作系统/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍉 Kevinの操作系统笔记 (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/Cpp/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍟 KevinのCpp基础笔记 (24)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/数据库/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍨 Kevinの数据库笔记 (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/Redis/数据库/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍨 Kevinの数据库笔记 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://Penge666.github.io/categories/etcd/数据库/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍨 Kevinの数据库笔记 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://Penge666.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/photo1/default_cover_20.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdown语法与外挂标签写法汇总</a><div class="blog-slider__text">🥧本文汇总Markdown格式以及外挂标签在网页端的渲染效果，可作为文档进行查询</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --></body></html>